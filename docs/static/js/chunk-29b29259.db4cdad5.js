(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-29b29259"],{"1ab9":function(t,e,n){var r=n("4f4d"),i=n("2514"),s=Object.hasOwnProperty,o=Object.create(null);for(var a in r)s.call(r,a)&&(o[r[a]]=a);var l=t.exports={to:{},get:{}};function h(t,e,n){return Math.min(Math.max(e,t),n)}function c(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}l.get=function(t){var e,n,r=t.substring(0,3).toLowerCase();switch(r){case"hsl":e=l.get.hsl(t),n="hsl";break;case"hwb":e=l.get.hwb(t),n="hwb";break;default:e=l.get.rgb(t),n="rgb";break}return e?{model:n,value:e}:null},l.get.rgb=function(t){if(!t)return null;var e,n,i,o=/^#([a-f0-9]{3,4})$/i,a=/^#([a-f0-9]{6})([a-f0-9]{2})?$/i,l=/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,c=/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/,u=/^(\w+)$/,f=[0,0,0,1];if(e=t.match(a)){for(i=e[2],e=e[1],n=0;n<3;n++){var d=2*n;f[n]=parseInt(e.slice(d,d+2),16)}i&&(f[3]=parseInt(i,16)/255)}else if(e=t.match(o)){for(e=e[1],i=e[3],n=0;n<3;n++)f[n]=parseInt(e[n]+e[n],16);i&&(f[3]=parseInt(i+i,16)/255)}else if(e=t.match(l)){for(n=0;n<3;n++)f[n]=parseInt(e[n+1],0);e[4]&&(e[5]?f[3]=.01*parseFloat(e[4]):f[3]=parseFloat(e[4]))}else{if(!(e=t.match(c)))return(e=t.match(u))?"transparent"===e[1]?[0,0,0,0]:s.call(r,e[1])?(f=r[e[1]],f[3]=1,f):null:null;for(n=0;n<3;n++)f[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?f[3]=.01*parseFloat(e[4]):f[3]=parseFloat(e[4]))}for(n=0;n<3;n++)f[n]=h(f[n],0,255);return f[3]=h(f[3],0,1),f},l.get.hsl=function(t){if(!t)return null;var e=/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,n=t.match(e);if(n){var r=parseFloat(n[4]),i=(parseFloat(n[1])%360+360)%360,s=h(parseFloat(n[2]),0,100),o=h(parseFloat(n[3]),0,100),a=h(isNaN(r)?1:r,0,1);return[i,s,o,a]}return null},l.get.hwb=function(t){if(!t)return null;var e=/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/,n=t.match(e);if(n){var r=parseFloat(n[4]),i=(parseFloat(n[1])%360+360)%360,s=h(parseFloat(n[2]),0,100),o=h(parseFloat(n[3]),0,100),a=h(isNaN(r)?1:r,0,1);return[i,s,o,a]}return null},l.to.hex=function(){var t=i(arguments);return"#"+c(t[0])+c(t[1])+c(t[2])+(t[3]<1?c(Math.round(255*t[3])):"")},l.to.rgb=function(){var t=i(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},l.to.rgb.percent=function(){var t=i(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},l.to.hsl=function(){var t=i(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},l.to.hwb=function(){var t=i(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},l.to.keyword=function(t){return o[t.slice(0,3)]}},"1deb":function(t,e,n){"use strict";n.d(e,"a",(function(){return r["b"]}));var r=n("e470"),i=n("18b7"),s=n("f139"),o=n("7555"),a=n("6929"),l=n.n(a),h=n("694b"),c=n.n(h),u=n("c3b8"),f=n("85cc"),d=n.n(f),p=n("8cfe"),A=n("25a5"),g=n.n(A),m=Math.pow,y=Math.sqrt,v=Math.sin,x=Math.cos,b=Math.PI,w=1.70158,_=1.525*w,M=w+1,T=2*b/3,S=2*b/4.5;function I(t){var e=7.5625,n=2.75;return t<1/n?e*t*t:t<2/n?e*(t-=1.5/n)*t+.75:t<2.5/n?e*(t-=2.25/n)*t+.9375:e*(t-=2.625/n)*t+.984375}var C=function(t,e){switch(t=t.toLowerCase(),t){case"swing":return O(e);case"easeinquad":return E(e);case"easeoutquad":return P(e);case"easeinoutquad":return k(e);case"easeincubic":return R(e);case"easeoutcubic":return N(e);case"easeinoutcubic":return D(e);case"easeinquart":return F(e);case"easeoutquart":return L(e);case"easeinoutquart":return z(e);case"easeinquint":return B(e);case"easeoutquint":return H(e);case"easeinoutquint":return U(e);case"easeinsine":return j(e);case"easeoutsine":return V(e);case"easeinoutsine":return G(e);case"easeinexpo":return q(e);case"easeoutexpo":return W(e);case"easeinoutexpo":return X(e);case"easeincirc":return Q(e);case"easeoutcirc":return Y(e);case"easeinoutcirc":return Z(e);case"easeinelastic":return K(e);case"easeoutelastic":return J(e);case"easeinoutelastic":return $(e);case"easeinback":return tt(e);case"easeoutback":return et(e);case"easeinoutback":return nt(e);case"easeinbounce":return rt(e);case"easeoutbounce":return it(e);case"easeinoutbounce":return st(e)}throw new Error("Unsupported easing function:"+t)};function O(t){return E(t)}function E(t){return t*t}function P(t){return 1-(1-t)*(1-t)}function k(t){return t<.5?2*t*t:1-m(-2*t+2,2)/2}function R(t){return t*t*t}function N(t){return 1-m(1-t,3)}function D(t){return t<.5?4*t*t*t:1-m(-2*t+2,3)/2}function F(t){return t*t*t*t}function L(t){return 1-m(1-t,4)}function z(t){return t<.5?8*t*t*t*t:1-m(-2*t+2,4)/2}function B(t){return t*t*t*t*t}function H(t){return 1-m(1-t,5)}function U(t){return t<.5?16*t*t*t*t*t:1-m(-2*t+2,5)/2}function j(t){return 1-x(t*b/2)}function V(t){return v(t*b/2)}function G(t){return-(x(b*t)-1)/2}function q(t){return 0===t?0:m(2,10*t-10)}function W(t){return 1===t?1:1-m(2,-10*t)}function X(t){return 0===t?0:1===t?1:t<.5?m(2,20*t-10)/2:(2-m(2,-20*t+10))/2}function Q(t){return 1-y(1-m(t,2))}function Y(t){return y(1-m(t-1,2))}function Z(t){return t<.5?(1-y(1-m(2*t,2)))/2:(y(1-m(-2*t+2,2))+1)/2}function K(t){return 0===t?0:1===t?1:-m(2,10*t-10)*v((10*t-10.75)*T)}function J(t){return 0===t?0:1===t?1:m(2,-10*t)*v((10*t-.75)*T)+1}function $(t){return 0===t?0:1===t?1:t<.5?-m(2,20*t-10)*v((20*t-11.125)*S)/2:m(2,-20*t+10)*v((20*t-11.125)*S)/2+1}function tt(t){return M*t*t*t-w*t*t}function et(t){return 1+M*m(t-1,3)+w*m(t-1,2)}function nt(t){return t<.5?m(2*t,2)*(2*(_+1)*t-_)/2:(m(2*t-2,2)*((_+1)*(2*t-2)+_)+2)/2}function rt(t){return 1-I(1-t)}function it(t){return I(t)}function st(t){return t<.5?(1-I(1-2*t))/2:(1+I(2*t-1))/2}var ot=n("70f3");const at={};function lt(){}const ht=lt.prototype;ht.getType=function(){return Object.getPrototypeOf(this).constructor.type},ht.isVisible=function(){throw new Error("to be implemented.")},ht.prepareRender=function(){throw new Error("to be implemented.")},ht.updateCollision=function(){throw new Error("to be implemented.")},ht.supportRenderMode=function(){throw new Error("to be implemented.")},ht.startFrame=function(){throw new Error("to be implemented.")},ht.endFrame=function(){throw new Error("to be implemented.")},ht.paintTile=function(){throw new Error("to be implemented.")},ht.getShadowMeshes=function(){throw new Error("to be implemented.")},ht.updateSceneConfig=function(){throw new Error("to be implemented.")},ht.updateDataConfig=function(){throw new Error("to be implemented.")},ht.updateSymbol=function(){throw new Error("to be implemented.")},ht.pick=function(){throw new Error("to be implemented.")},ht.resize=function(){throw new Error("to be implemented.")},ht.deleteTile=function(){throw new Error("to be implemented.")},ht.remove=function(){throw new Error("to be implemented.")},ht.needToRedraw=function(){throw new Error("to be implemented.")},ht.needToRetireFrames=function(){throw new Error("to be implemented.")},ht.outline=function(){throw new Error("to be implemented.")},ht.outlineAll=function(){throw new Error("to be implemented.")},ht.needPolygonOffset=function(){throw new Error("to be implemented.")},ht.constructor=lt;const ct=Object.prototype.hasOwnProperty;function ut(t){t.registerPlugin(this)}lt.extend=function(t,e){const n=function(){this.init&&this.init()},r=Object.create(ht);r.constructor=n,n.prototype=r,n.type=t;for(const i in e)ct.call(e,i)&&(n.prototype[i]=e[i]);return n.registerAt=ut.bind(n),at[t]=n,n};var ft=lt;
/*!
 * @maptalks/vt v0.95.0
 * LICENSE : undefined
 * (c) 2016-2024 maptalks.org
 */const dt='function(t){let n;const e={width:100,height:10};function r(){if(!n){const{width:t,height:r}=e;OffscreenCanvas?n=new OffscreenCanvas(t,r):(n=document.createElement("canvas"),n.width=t,n.height=r)}return n}class i{constructor(t,n={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let r=1/0,i=-1/0;for(let n=0,e=t.length;n<e;n++){const e=t[n][0];r=Math.min(e,r),i=Math.max(e,i)}this.min=r,this.max=i,this.valueOffset=this.max-this.min,this.options=Object.assign({},e,n),this.t()}getImageData(){return this.imgData}t(){const t=r(),{width:n,height:e}=this.options;t.width=n,t.height=e;const i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);const s=i.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:a}=this;for(let t=0,n=o.length;t<n;t++){const[n,e]=o[t],r=(n-this.min)/a;s.addColorStop(r,e)}i.fillStyle=s,i.fillRect(0,0,t.width,t.height),this.imgData=i.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const n=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let e=Math.round(n*this.imgData.width);e=Math.min(e,this.imgData.width-1);const r=4*e;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var s;function o(t,n){for(let e=0;e<t.stops.length;e++)if(n===t.stops[e][0])return t.stops[e][1];return t.default}function a(t,n){for(var e=0;e<t.stops.length&&!(n<t.stops[e][0]);e++);return t.stops[Math.max(e-1,0)][1]}function u(t,n){for(var e=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||n<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:function t(n,e,r,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),u=o.apply(void 0,arguments);return t(n,e,r,i,a,u)}:s.length?function(t,n,e,r,i,s){var o=[];for(let a=0;a<i.length;a++)o[a]=f(t,n,e,r,i[a],s[a]);return o}(n,e,r,i,s,o):f(n,e,r,i,s,o)}(n,e,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(s=new Map);const l={width:100,height:1};function h(t,n){const e=t.stops;if(e&&e.length>1){let t;if(s){const n=JSON.stringify(e);if(!s.has(n)){const t=new i(e,l);s.set(n,t)}t=s.get(n)}else t=new i(e,l);const[r,o,a,u]=t.getColor(n);return[r/255,o/255,a/255,u/255]}return e&&1===e.length?e[0][1]:null}function c(t,n){return function(t,n,e){return void 0!==t?t:void 0!==n?n:void 0!==e?e:null}(n,t.default)}function f(t,n,e,r,i,s){var o,a=r-e,u=t-e;return i*(1-(o=1===n?u/a:(Math.pow(n,u)-1)/(Math.pow(n,a)-1)))+s*o}function d(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function p(t){return g(t,"exponential")}function y(t){return g(t,"interval")}function m(t,n){if(!t)return null;var e=!1;if(Array.isArray(t)){var r,i=[];for(let s=0;s<t.length;s++)(r=m(t[s],n))?(i.push(r),e=!0):i.push(t[s]);return e?i:t}var s,o={__fn_types_loaded:!0},a=[];for(s in t)t.hasOwnProperty(s)&&a.push(s);const u=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=p(this["_"+t])),this["__fn_"+t].apply(this,n())},set:function(n){this["_"+t]=n},configurable:!0,enumerable:!0})};for(let n=0,r=a.length;n<r;n++)d(t[s=a[n]])?(e=!0,o["_"+s]=t[s],u(s)):o[s]=t[s];return e?o:t}function g(t,n){if(!d(t))return function(){return t};let e=!0,r=!0;const i=(t=JSON.parse(JSON.stringify(t))).stops;if(i)for(let t=0;t<i.length;t++)if(d(i[t][1])){const s=g(i[t][1],n);e=e&&s.isZoomConstant,r=r&&s.isFeatureConstant,i[t]=[i[t][0],s]}const s=function t(n,e){var r,i,s;if(d(n)){var l,f=n.stops&&"object"==typeof n.stops[0][0],p=f||void 0!==n.property,y=f||!p,m=n.type||e||"exponential";if("exponential"===m)l=u;else if("interval"===m)l=a;else if("categorical"===m)l=o;else if("identity"===m)l=c;else{if("color-interpolate"!==m)throw new Error(\'Unknown function type "\'+m+\'"\');l=h}if(f){var g={},v=[];for(let t=0;t<n.stops.length;t++){var b=n.stops[t];void 0===g[b[0].zoom]&&(g[b[0].zoom]={zoom:b[0].zoom,type:n.type,property:n.property,default:n.default,stops:[]}),g[b[0].zoom].stops.push([b[0].value,b[1]])}for(let n in g)v.push([g[n].zoom,t(g[n])]);r=function(t,e){const r=u({stops:v,base:n.base},t)(t,e);return"function"==typeof r?r(t,e):r},i=!1,s=!1}else y?(r=function(t){const e=l(n,t);return"function"==typeof e?e(t):e},i=!0,s=!1):(r=function(t,e){const r=l(n,e?e[n.property]:null);return"function"==typeof r?r(t,e):r},i=!1,s=!0)}else r=function(){return n},i=!0,s=!0;return r.isZoomConstant=s,r.isFeatureConstant=i,r}(t,n);return s.isZoomConstant=e&&s.isZoomConstant,s.isFeatureConstant=r&&s.isFeatureConstant,s}let v=0;const b="function"==typeof Object.assign;function w(t,...n){if(b)return Object.assign(t,...n),t;for(let e=0;e<n.length;e++){const r=n[e];for(const n in r)t[n]=r[n]}return t}function M(t){return!k(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function x(t){return"number"==typeof t&&!isNaN(t)}function F(t){return!k(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function A(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function k(t){return null==t}function P(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];if(e)for(let n=0,r=e.length;n<r;n++)t.push(e[n])}return t.length}function S(t){return d(t)&&t.property}const _="function"==typeof fetch&&"function"==typeof AbortController,O={jsonp:function(t,n){const e="_maptalks_jsonp_"+v++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[e]=function(t){n(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[e]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,n,e){if(F(n)){const t=e;e=n,n=t}(n=n||{}).method&&(n.method=n.method.toUpperCase());const r="POST"===n.method;if(_){const r=new AbortController,i=n;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const s=new Request(t,i);return n.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then(r=>{const i=this.s(r,n.returnJSON,n.responseType);i.message?(i.url=t,e(i)):i.then(t=>{"arraybuffer"===n.responseType?e(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):e(null,t)}).catch(n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))})}).catch(n=>{n.code&&n.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,n),e(n))}),r}{const i=O.o(e);if(i.open(n.method||"GET",t,!0),n){for(const t in n.headers)i.setRequestHeader(t,n.headers[t]);i.withCredentials="include"===n.credentials,n.responseType&&(i.responseType=n.responseType)}return i.send(r?n.body:null),i}},s:(t,n,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():n?t.json():t.text(),u:function(t,n){return function(){if(4===t.readyState)if(200===t.status)if("arraybuffer"===t.responseType){0===t.response.byteLength?n({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):n(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")})}else n(null,t.responseText);else n({status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`})}},o:function(t){let n;try{n=new XMLHttpRequest}catch(t){try{n=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{n=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return n.onreadystatechange=O.u(n,t),n},getArrayBuffer(t,n,e){if(F(n)){const t=e;e=n,n=t}return n||(n={}),n.responseType="arraybuffer",O.get(t,n,e)}};function E(t,n,e,r,i,s){let o=i-e,a=s-r;if(0!==o||0!==a){const u=((t-e)*o+(n-r)*a)/(o*o+a*a);u>1?(e=i,r=s):u>0&&(e+=o*u,r+=a*u)}return o=t-e,a=n-r,o*o+a*a}function I(t,n,e,r,i,s){const o={id:null==t?null:t,type:n,geometry:e,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};i&&(o.layer=i);return function(t,n){const e=t.geometry,r=t.type;if("Point"===r||"MultiPoint"===r||"LineString"===r)$(t,e,n);else if("Polygon"===r)$(t,e[0],n);else if("MultiLineString"===r)for(const r of e)$(t,r,n);else if("MultiPolygon"===r)for(const r of e)$(t,r[0],n)}(o,s?4:3),o}function $(t,n,e){for(let r=0;r<n.length;r+=e)t.minX=Math.min(t.minX,n[r]),t.minY=Math.min(t.minY,n[r+1]),t.maxX=Math.max(t.maxX,n[r]),t.maxY=Math.max(t.maxY,n[r+1])}function C(t,n,e,r){if(r.layer=n,"FeatureCollection"===e.type)for(let n=0;n<e.features.length;n++)T(t,e.features[n],r,n);else"Feature"===e.type?T(t,e,r):T(t,{geometry:e},r)}function T(t,n,e,r){if(!n.geometry)return;const i=n.geometry.coordinates,s=n.geometry.type,o=Math.pow(e.tolerance/((1<<e.maxZoom)*e.extent),2);let a=[],u=n.id;if(e.promoteId?u=n.properties[e.promoteId]:e.generateId&&(u=r||0),"Point"===s)z(i,a,e);else if("MultiPoint"===s)for(const t of i)z(t,a,e);else if("LineString"===s)D(i,a,o,!1,e);else if("MultiLineString"===s){if(e.lineMetrics){for(const r of i)a=[],D(r,a,o,!1,e),t.push(I(u,"LineString",a,n.properties,e.layer,e.hasAltitude));return}j(i,a,o,!1,e)}else if("Polygon"===s)j(i,a,o,!0,e);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(const i of n.geometry.geometries)T(t,{id:u,geometry:i,properties:n.properties},e,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const t of i){const n=[];j(t,n,o,!0,e),a.push(n)}}t.push(I(u,s,a,n.properties,e.layer,e.hasAltitude))}function z(t,n,e){n.push(U(t[0]),N(t[1],e.projection),0),e.hasAltitude&&(t.length>2?n.push(t[2]):n.push(0))}function D(t,n,e,r,i){let s,o,a=0;for(let e=0;e<t.length;e++){const u=U(t[e][0]),l=N(t[e][1],i.projection);n.push(u,l,0),i.hasAltitude&&(t[e].length>2?n.push(t[e][2]):n.push(0)),e>0&&(a+=r?(s*l-u*o)/2:Math.sqrt(Math.pow(u-s,2)+Math.pow(l-o,2))),s=u,o=l}const u=i.hasAltitude?4:3,l=n.length-u;n[2]=1,function t(n,e,r,i,s=3){let o=i;const a=r-e>>1;let u,l=r-e;const h=n[e],c=n[e+1],f=n[r],d=n[r+1];for(let t=e+s;t<r;t+=s){const e=E(n[t],n[t+1],h,c,f,d);if(e>o)u=t,o=e;else if(e===o){const n=Math.abs(t-a);n<l&&(u=t,l=n)}}o>i&&(u-e>s&&t(n,e,u,i,s),n[u+2]=o,r-u>s&&t(n,u,r,i,s))}(n,0,l,e,u),n[l+2]=1,n.size=Math.abs(a),n.start=0,n.end=n.size}function j(t,n,e,r,i){for(let s=0;s<t.length;s++){const o=[];D(t[s],o,e,r,i),n.push(o)}}function U(t){return t/360+.5}function N(t,n){switch(n){case"EPSG:4326":return(90-t)/360}const e=Math.sin(t*Math.PI/180),r=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return r<0?0:r>1?1:r}function L(t,n,e,r,i,s,o,a){if(r/=n,s>=(e/=n)&&o<r)return t;if(o<e||s>=r)return null;const u=[];for(const n of t){const t=n.geometry;let s=n.type;const o=0===i?n.minX:n.minY,l=0===i?n.maxX:n.maxY;if(o>=e&&l<r){u.push(n);continue}if(l<e||o>=r)continue;let h=[];if("Point"===s||"MultiPoint"===s)V(t,h,e,r,i,a.hasAltitude);else if("LineString"===s)R(t,h,e,r,i,!1,a.lineMetrics,a.hasAltitude);else if("MultiLineString"===s)W(t,h,e,r,i,!1,a.hasAltitude);else if("Polygon"===s)W(t,h,e,r,i,!0,a.hasAltitude);else if("MultiPolygon"===s)for(const n of t){const t=[];W(n,t,e,r,i,!0,a.hasAltitude),t.length&&h.push(t)}if(h.length){if(a.lineMetrics&&"LineString"===s){for(const t of h)u.push(I(n.id,s,t,n.tags,n.layer,a.hasAltitude));continue}"LineString"!==s&&"MultiLineString"!==s||(1===h.length?(s="LineString",h=h[0]):s="MultiLineString"),"Point"!==s&&"MultiPoint"!==s||(s=3===h.length?"Point":"MultiPoint"),u.push(I(n.id,s,h,n.tags,n.layer,a.hasAltitude))}}return u.length?u:null}function V(t,n,e,r,i,s){const o=s?4:3;for(let a=0;a<t.length;a+=o){const o=t[a+i];o>=e&&o<=r&&(q(n,t[a],t[a+1],t[a+2]),s&&n.push(t[a+3]))}}function R(t,n,e,r,i,s,o,a){let u=H(t);const l=0===i?G:B;let h,c,f=t.start;const d=a?4:3,p=s?t.length:t.length-d;for(let y=0;y<p;y+=d){const m=t[y],g=t[y+1],v=t[y+2];let b,w,M,x;s&&y===p-d?(b=t[0],w=t[1]):(b=t[y+d],w=t[y+d+1]),a&&(M=t[y+3],x=s&&y===p-d?t[3]:t[y+d+3]);const F=0===i?m:g,A=0===i?b:w;let k=!1;o&&(h=Math.sqrt(Math.pow(m-b,2)+Math.pow(g-w,2))),F<e?A>e&&(c=l(u,m,g,b,w,e),a&&u.push(J(M,x,c)),o&&(u.start=f+h*c)):F>r?A<r&&(c=l(u,m,g,b,w,r),a&&u.push(J(M,x,c)),o&&(u.start=f+h*c)):(q(u,m,g,v),a&&u.push(M)),A<e&&F>=e&&(c=l(u,m,g,b,w,e),a&&u.push(J(M,x,c)),k=!0),A>r&&F<=r&&(c=l(u,m,g,b,w,r),a&&u.push(J(M,x,c)),k=!0),!s&&k&&(o&&(u.end=f+h*c),n.push(u),u=H(t)),o&&(f+=h)}let y=t.length-d;if(!s){const n=t[y],s=t[y+1],o=t[y+2],l=0===i?n:s;if(l>=e&&l<=r&&q(u,n,s,o),l>=e&&l<=r&&a){const n=t[y+3];u.push(n)}}y=u.length-d,s&&y>=d&&(u[y]!==u[0]||u[y+1]!==u[1])&&(q(u,u[0],u[1],u[2]),a&&u.push(u[3])),u.length&&n.push(u)}function H(t){const n=[];return n.size=t.size,n.start=t.start,n.end=t.end,n}function W(t,n,e,r,i,s,o){for(const a of t)R(a,n,e,r,i,s,!1,o)}function q(t,n,e,r){t.push(n,e,r)}function G(t,n,e,r,i,s){const o=(s-n)/(r-n);return q(t,s,e+(i-e)*o,1),o}function B(t,n,e,r,i,s){const o=(s-e)/(i-e);return q(t,n+(r-n)*o,s,1),o}function J(t,n,e){return t+(n-t)*e}function X(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=t[i],o=s.type;let a;if("Point"===o||"MultiPoint"===o||"LineString"===o)a=Y(s.geometry,n,e);else if("MultiLineString"===o||"Polygon"===o){a=[];for(const t of s.geometry)a.push(Y(t,n,e))}else if("MultiPolygon"===o){a=[];for(const t of s.geometry){const r=[];for(const i of t)r.push(Y(i,n,e));a.push(r)}}r.push(I(s.id,o,a,s.tags,s.layer,e))}return r}function Y(t,n,e){const r=[];r.size=t.size,void 0!==t.start&&(r.start=t.start,r.end=t.end);const i=e?4:3;for(let s=0;s<t.length;s+=i)r.push(t[s]+n,t[s+1],t[s+2]),e&&r.push(t[s+3]);return r}function Z(t,n,e){if(t.transformed)return t;const r=1<<t.z,i=t.x,s=t.y,o=e?3:2;for(const a of t.features){const t=a.geometry,u=a.type;if(a.geometry=[],1===u)for(let u=0;u<t.length;u+=o)a.geometry.push(K(t[u],t[u+1],n,r,i,s)),e&&a.geometry[a.geometry.length-1].push(t[u+2]);else for(let u=0;u<t.length;u++){const l=[];for(let a=0;a<t[u].length;a+=o)l.push(K(t[u][a],t[u][a+1],n,r,i,s)),e&&l[l.length-1].push(t[u][a+2]);a.geometry.push(l)}}return t.transformed=!0,t}function K(t,n,e,r,i,s){return[Math.round(e*(t*r-i)),Math.round(e*(n*r-s))]}function Q(t,n,e,r,i){const s=n===i.maxZoom?0:i.tolerance/((1<<n)*i.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:e,y:r,z:n,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const n of t)tt(o,n,s,i);return o}function tt(t,n,e,r){const i=n.geometry,s=n.type,o=[],a=r.hasAltitude?4:3;if(t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),"Point"===s||"MultiPoint"===s)for(let n=0;n<i.length;n+=a)o.push(i[n],i[n+1]),r.hasAltitude&&o.push(i[n+3]),t.numPoints++,t.numSimplified++;else if("LineString"===s)et(o,i,t,e,!1,!1,r);else if("MultiLineString"===s||"Polygon"===s)for(let n=0;n<i.length;n++)et(o,i[n],t,e,"Polygon"===s,0===n,r);else if("MultiPolygon"===s)for(let n=0;n<i.length;n++){const s=i[n];for(let n=0;n<s.length;n++)et(o,s[n],t,e,!0,0===n,r)}if(o.length){let e=n.tags||null;if("LineString"===s&&r.lineMetrics){e={};for(const t in n.tags)e[t]=n.tags[t];e.mapbox_clip_start=i.start/i.size,e.mapbox_clip_end=i.end/i.size}const a={geometry:o,type:"Polygon"===s||"MultiPolygon"===s?3:"LineString"===s||"MultiLineString"===s?2:1,tags:e};n.layer&&(a.layer=n.layer),null!==n.id&&(a.id=n.id),t.features.push(a)}}function nt(t,n,e){return 0===t[n+2]&&t[n+3]>0&&e}function et(t,n,e,r,i,s,o){const a=r*r,{hasAltitude:u,disableFilter:l}=o,h=u?4:3;if(!l&&r>0&&n.size<(i?a:r))return void(e.numPoints+=n.length/h);const c=[];for(let t=0;t<n.length;t+=h)(0===r||n[t+2]>a||nt(n,t,u))&&(e.numSimplified++,c.push(n[t],n[t+1]),u&&c.push(n[t+3])),e.numPoints++;i&&function(t,n,e){const r=e?3:2;let i=0;for(let n=0,e=t.length,s=e-r;n<e;s=n,n+=r)i+=(t[n]-t[s])*(t[n+1]+t[s+1]);if(i>0===n){const n=r,i=r-1,s=r-2;for(let o=0,a=t.length;o<a/2;o+=r){const r=t[o],u=t[o+1];let l;e&&(l=t[o+2]),t[o]=t[a-n-o],t[o+1]=t[a-i-o],e&&(t[o+2]=t[a-s-o]),t[a-n-o]=r,t[a-i-o]=u,e&&(t[a-s-o]=l)}}}(c,s,u),t.push(c)}O.getJSON=function(t,n,e){if(F(n)){const t=e;e=n,n=t}const r=function(t,n){const r="string"==typeof n?JSON.parse(n):n||null;e(t,r)};return n&&n.jsonp?O.jsonp(t,r):((n=n||{}).returnJSON=!0,O.get(t,n,r))};const rt={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,hasAltitude:!1,disableFilter:!1,debug:0};class it{constructor(t,n){const e=(n=this.options=function(t,n){for(const e in n)t[e]=n[e];return t}(Object.create(rt),n)).debug;if(e&&console.time("preprocess data"),n.maxZoom<0||n.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(n.promoteId&&n.generateId)throw new Error("promoteId and generateId cannot be used together.");let r=function(t,n){const e=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++)C(e,t[r].layer,t[r].data,n);return e}if("FeatureCollection"===t.type)for(let r=0;r<t.features.length;r++)T(e,t.features[r],n,r);else"Feature"===t.type?T(e,t,n):T(e,{geometry:t},n);return e}(t,n);this.tiles={},this.tileCoords=[],e&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",n.indexMaxZoom,n.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(t,n){const e=n.buffer/n.extent;let r=t;const i=L(t,1,-1-e,e,0,-1,2,n),s=L(t,1,1-e,2+e,0,-1,2,n);return(i||s)&&(r=L(t,1,-e,1+e,0,-1,2,n)||[],i&&(r=X(i,1,n.hasAltitude).concat(r)),s&&(r=r.concat(X(s,-1,n.hasAltitude)))),r}(r,n),r.length&&this.splitTile(r,0,0,0),e&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,n,e,r,i,s,o){const a=[t,n,e,r],u=this.options,l=u.debug;for(;a.length;){r=a.pop(),e=a.pop(),n=a.pop(),t=a.pop();const h=1<<n,c=st(n,e,r);let f=this.tiles[c];if(!f&&(l>1&&console.time("creation"),f=this.tiles[c]=Q(t,n,e,r,u),this.tileCoords.push({z:n,x:e,y:r}),l)){l>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",n,e,r,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const t="z"+n;this.stats[t]=(this.stats[t]||0)+1,this.total++}if(f.source=t,null==i){if(n===u.indexMaxZoom||f.numPoints<=u.indexMaxPoints)continue}else{if(n===u.maxZoom||n===i)continue;if(null!=i){const t=i-n;if(e!==s>>t||r!==o>>t)continue}}if(f.source=null,0===t.length)continue;l>1&&console.time("clipping");const d=.5*u.buffer/u.extent,p=.5-d,y=.5+d,m=1+d;let g=null,v=null,b=null,w=null,M=L(t,h,e-d,e+y,0,f.minX,f.maxX,u),x=L(t,h,e+p,e+m,0,f.minX,f.maxX,u);t=null,M&&(g=L(M,h,r-d,r+y,1,f.minY,f.maxY,u),v=L(M,h,r+p,r+m,1,f.minY,f.maxY,u),M=null),x&&(b=L(x,h,r-d,r+y,1,f.minY,f.maxY,u),w=L(x,h,r+p,r+m,1,f.minY,f.maxY,u),x=null),l>1&&console.timeEnd("clipping"),a.push(g||[],n+1,2*e,2*r),a.push(v||[],n+1,2*e,2*r+1),a.push(b||[],n+1,2*e+1,2*r),a.push(w||[],n+1,2*e+1,2*r+1)}}getTile(t,n,e){t=+t,n=+n,e=+e;const r=this.options,{extent:i,debug:s}=r,{hasAltitude:o,wrapX:a}=r;if(t<0||t>24)return null;if(a){const e=1<<t;n=n+e&e-1}const u=st(t,n,e);if(this.tiles[u])return Z(this.tiles[u],i,o);s>1&&console.log("drilling down to z%d-%d-%d",t,n,e);let l,h=t,c=n,f=e;for(;!l&&h>0;)h--,c>>=1,f>>=1,l=this.tiles[st(h,c,f)];return l&&l.source?(s>1&&(console.log("found parent tile z%d-%d-%d",h,c,f),console.time("drilling down")),this.splitTile(l.source,h,c,f,t,n,e),s>1&&console.timeEnd("drilling down"),this.tiles[u]?Z(this.tiles[u],i,o):null):null}}function st(t,n,e){return 32*((1<<t)*e+n)+t}function ot(t,n,e,r,i,s,o){const a=e&&Array.isArray(e[0]);for(let u=0,l=e.length;u<l;u++){t[n]=(a?e[u][0]:e[u].x)*r,t[n+1]=(a?e[u][1]:e[u].y)*r,o!==Float32Array&&(t[n]=Math.round(t[n]),t[n+1]=Math.round(t[n+1]));let h=i||0;Array.isArray(i)&&(h=i[u]),h=h?Math.round(r*h):0,t[n+2]=h,n+=3,s&&0!==u&&u!==l-1&&(t[n]=t[n-3],t[n+1]=t[n-2],t[n+2]=t[n-1],n+=3)}return t.trySetLength&&t.trySetLength(n),n}function at(t,n,e,r){const i=t[3*n],s=t[3*n+1],o=t[3*e],a=t[3*e+1];return i===o&&(i<0||i>r)||s===a&&(s<0||s>r)}var ut="undefined"!=typeof Float32Array?Float32Array:Array;function lt(){var t=new ut(3);return ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ht(t,n,e){var r=new ut(3);return r[0]=t,r[1]=n,r[2]=e,r}function ct(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t}function ft(t,n,e,r){return t[0]=n,t[1]=e,t[2]=r,t}function dt(t,n,e){return t[0]=n[0]+e[0],t[1]=n[1]+e[1],t[2]=n[2]+e[2],t}function pt(t,n){var e=n[0],r=n[1],i=n[2],s=e*e+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=n[0]*s,t[1]=n[1]*s,t[2]=n[2]*s),t}function yt(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function mt(t,n,e){var r=n[0],i=n[1],s=n[2],o=e[0],a=e[1],u=e[2];return t[0]=i*u-s*a,t[1]=s*o-r*u,t[2]=r*a-i*o,t}var gt=function(t,n,e){return t[0]=n[0]-e[0],t[1]=n[1]-e[1],t[2]=n[2]-e[2],t};function vt(t,n){return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t}function bt(t,n,e,r,i){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t}function wt(t,n,e){return t[0]=n[0]/e[0],t[1]=n[1]/e[1],t[2]=n[2]/e[2],t[3]=n[3]/e[3],t}function Mt(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t[3]=n[3]*e,t}function xt(t,n){return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]&&t[3]===n[3]}function Ft(){var t=new ut(4);return ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function At(t,n){var e=n[0]+n[4]+n[8],r=void 0;if(e>0)r=Math.sqrt(e+1),t[3]=.5*r,r=.5/r,t[0]=(n[5]-n[7])*r,t[1]=(n[6]-n[2])*r,t[2]=(n[1]-n[3])*r;else{var i=0;n[4]>n[0]&&(i=1),n[8]>n[3*i+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(n[3*i+i]-n[3*s+s]-n[3*o+o]+1),t[i]=.5*r,r=.5/r,t[3]=(n[3*s+o]-n[3*o+s])*r,t[s]=(n[3*s+i]+n[3*i+s])*r,t[o]=(n[3*o+i]+n[3*i+o])*r}return t}!function(){var t=lt()}(),function(){var t,n=(t=new ut(4),ut!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var kt,Pt=Mt,St=function(t,n){var e=n[0],r=n[1],i=n[2],s=n[3],o=e*e+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),t[0]=e*o,t[1]=r*o,t[2]=i*o,t[3]=s*o),t};function _t(t,n,e){return t[0]=n,t[1]=e,t}function Ot(t,n){var e=n[0]-t[0],r=n[1]-t[1];return Math.sqrt(e*e+r*r)}lt(),ht(1,0,0),ht(0,1,0),Ft(),Ft(),kt=new ut(9),ut!=Float32Array&&(kt[1]=0,kt[2]=0,kt[3]=0,kt[5]=0,kt[6]=0,kt[7]=0),kt[0]=1,kt[4]=1,kt[8]=1;var Et=function(t){var n=t[0],e=t[1];return Math.sqrt(n*n+e*e)};!function(){var t=function(){var t=new ut(2);return ut!=Float32Array&&(t[0]=0,t[1]=0),t}()}();const It=Math.PI/180,$t=6378137*Math.PI/180;function Ct(t,n,e){if("EPSG:3857"===e)return function(t,n){const e=85.0511287798,r=n[0],i=Math.max(Math.min(e,n[1]),-e);let s;s=0===i?0:Math.log(Math.tan((90+i)*It/2))/It;return t[0]=r*$t,t[1]=s*$t,t}(t,n);if("EPSG:4326"===e||"EPSG:4490"===e||"identity"===e)return Tt(t,n);if("baidu"===e)return Tt(t,n);throw new Error("unsupported projection:"+e)}function Tt(t,n){return t[0]=n[0],t[1]=n[1],t}function zt(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){0===t?function(t,n,e,r,i,s,o,a,u,l){const h=1/(100*s[0]),c=1/(100*s[1]),f=l&&l[0]||0,d=l&&l[1]||0,p=[0,0];for(let i=t;i<n;i+=3){const t=i/3*2,n=r[i]-f,s=r[i+1]-d;e[t]=p[0]+n/o*h/a,e[t+1]=p[1]-s/o*c/u}}(n,e,r,i,0,o,a,u,l,p):1===t&&function(t,n,e,r,i,s,o,a,u,l,h){if(!t)return;let c,f,d,p;0===t[4]?(c=t[0],f=t[1],d=t[2],p=t[3]):(c=t[1],f=t[2],d=t[3],p=t[0]);const y=Ot(c,f),m=Ot(f,d),g=[],v=[],b=[];for(let t=n;t<e;t+=3){const n=t/3*2,e=(s.x/u+i[t]/o)*a,d=s.y/u*a+(h?i[t+1]:-i[t+1])/o*a;_t(g,e,d),"EPSG:4326"!==l&&"EPSG:4490"!==l||Ct(g,g,"EPSG:3857"),Dt(v,g,c,f),Dt(b,g,p,c),r[n]=Ot(c,v)/y,r[n+1]=Ot(c,b)/m}}(h,n,e,r,i,s,a,c,f,d,!!p)}function Dt(t,n,e,r){const i=e[0]-r[0],s=e[1]-r[1];let o=(n[0]-e[0])*(e[0]-r[0])+(n[1]-e[1])*(e[1]-r[1]);return o/=i*i+s*s,t[0]=e[0]+o*i,t[1]=e[1]+o*s,t}function jt(t,n,e,r,i){const s=3*n[e-1],o=3*n[e-1]+1,a=t[s],u=t[o];return l=r,h=i,c=a,f=u,Math.sqrt((c-l)*(c-l)+(f-h)*(f-h));var l,h,c,f}"undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self&&self;var Ut=Nt;function Nt(t,n){this.x=t,this.y=n}function Lt(t,n,e){e=e||{},this.w=t||64,this.h=n||64,this.autoResize=!!e.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function Vt(t,n,e){this.x=0,this.y=t,this.w=this.free=n,this.h=e}function Rt(t,n,e,r,i,s,o){this.id=t,this.x=n,this.y=e,this.w=r,this.h=i,this.maxw=s||r,this.maxh=o||i,this.refcount=0}Nt.prototype={clone:function(){return new Nt(this.x,this.y)},add:function(t){return this.clone().m(t)},sub:function(t){return this.clone().M(t)},multByPoint:function(t){return this.clone().F(t)},divByPoint:function(t){return this.clone().A(t)},mult:function(t){return this.clone().k(t)},div:function(t){return this.clone().P(t)},rotate:function(t){return this.clone().S(t)},rotateAround:function(t,n){return this.clone()._(t,n)},matMult:function(t){return this.clone().O(t)},unit:function(){return this.clone().I()},perp:function(){return this.clone().C()},round:function(){return this.clone().T()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var n=t.x-this.x,e=t.y-this.y;return n*n+e*e},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,n){return Math.atan2(this.x*n-this.y*t,this.x*t+this.y*n)},O:function(t){var n=t[0]*this.x+t[1]*this.y,e=t[2]*this.x+t[3]*this.y;return this.x=n,this.y=e,this},m:function(t){return this.x+=t.x,this.y+=t.y,this},M:function(t){return this.x-=t.x,this.y-=t.y,this},k:function(t){return this.x*=t,this.y*=t,this},P:function(t){return this.x/=t,this.y/=t,this},F:function(t){return this.x*=t.x,this.y*=t.y,this},A:function(t){return this.x/=t.x,this.y/=t.y,this},I:function(){return this.P(this.mag()),this},C:function(){var t=this.y;return this.y=this.x,this.x=-t,this},S:function(t){var n=Math.cos(t),e=Math.sin(t),r=n*this.x-e*this.y,i=e*this.x+n*this.y;return this.x=r,this.y=i,this},_:function(t,n){var e=Math.cos(t),r=Math.sin(t),i=n.x+e*(this.x-n.x)-r*(this.y-n.y),s=n.y+r*(this.x-n.x)+e*(this.y-n.y);return this.x=i,this.y=s,this},T:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Nt.convert=function(t){return t instanceof Nt?t:Array.isArray(t)?new Nt(t[0],t[1]):t},Lt.prototype.pack=function(t,n){t=[].concat(t),n=n||{};for(var e,r,i,s,o=[],a=0;a<t.length;a++)if(e=t[a].w||t[a].width,r=t[a].h||t[a].height,i=t[a].id,e&&r){if(!(s=this.packOne(e,r,i)))continue;n.inPlace&&(t[a].x=s.x,t[a].y=s.y,t[a].id=s.id),o.push(s)}return this.shrink(),o},Lt.prototype.packOne=function(t,n,e){var r,i,s,o,a,u,l,h,c={freebin:-1,shelf:-1,waste:1/0},f=0;if("string"==typeof e||"number"==typeof e){if(r=this.getBin(e))return this.ref(r),r;"number"==typeof e&&(this.maxId=Math.max(e,this.maxId))}else e=++this.maxId;for(o=0;o<this.freebins.length;o++){if(n===(r=this.freebins[o]).maxh&&t===r.maxw)return this.allocFreebin(o,t,n,e);n>r.maxh||t>r.maxw||n<=r.maxh&&t<=r.maxw&&(s=r.maxw*r.maxh-t*n)<c.waste&&(c.waste=s,c.freebin=o)}for(o=0;o<this.shelves.length;o++)if(f+=(i=this.shelves[o]).h,!(t>i.free)){if(n===i.h)return this.allocShelf(o,t,n,e);n>i.h||n<i.h&&(s=(i.h-n)*t)<c.waste&&(c.freebin=-1,c.waste=s,c.shelf=o)}return-1!==c.freebin?this.allocFreebin(c.freebin,t,n,e):-1!==c.shelf?this.allocShelf(c.shelf,t,n,e):n<=this.h-f&&t<=this.w?(i=new Vt(f,this.w,n),this.allocShelf(this.shelves.push(i)-1,t,n,e)):this.autoResize?(a=u=this.h,((l=h=this.w)<=a||t>l)&&(h=2*Math.max(t,l)),(a<l||n>a)&&(u=2*Math.max(n,a)),this.resize(h,u),this.packOne(t,n,e)):null},Lt.prototype.allocFreebin=function(t,n,e,r){var i=this.freebins.splice(t,1)[0];return i.id=r,i.w=n,i.h=e,i.refcount=0,this.bins[r]=i,this.ref(i),i},Lt.prototype.allocShelf=function(t,n,e,r){var i=this.shelves[t].alloc(n,e,r);return this.bins[r]=i,this.ref(i),i},Lt.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,n=0,e=0;e<this.shelves.length;e++){var r=this.shelves[e];n+=r.h,t=Math.max(r.w-r.free,t)}this.resize(t,n)}},Lt.prototype.getBin=function(t){return this.bins[t]},Lt.prototype.ref=function(t){if(1==++t.refcount){var n=t.h;this.stats[n]=1+(0|this.stats[n])}return t.refcount},Lt.prototype.unref=function(t){return 0===t.refcount?0:(0==--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},Lt.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},Lt.prototype.resize=function(t,n){this.w=t,this.h=n;for(var e=0;e<this.shelves.length;e++)this.shelves[e].resize(t);return!0},Vt.prototype.alloc=function(t,n,e){if(t>this.free||n>this.h)return null;var r=this.x;return this.x+=t,this.free-=t,new Rt(e,r,this.y,t,n,t,this.h)},Vt.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};var Ht={exports:{}},Wt={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},qt={exports:{}},Gt=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},Bt=Array.prototype.concat,Jt=Array.prototype.slice,Xt=qt.exports=function(t){for(var n=[],e=0,r=t.length;e<r;e++){var i=t[e];Gt(i)?n=Bt.call(n,Jt.call(i)):n.push(i)}return n};Xt.wrap=function(t){return function(){return t(Xt(arguments))}};var Yt=Wt,Zt=qt.exports,Kt=Object.hasOwnProperty,Qt=Object.create(null);for(var tn in Yt)Kt.call(Yt,tn)&&(Qt[Yt[tn]]=tn);var nn=Ht.exports={to:{},get:{}};function en(t,n,e){return Math.min(Math.max(n,t),e)}function rn(t){var n=Math.round(t).toString(16).toUpperCase();return n.length<2?"0"+n:n}nn.get=function(t){var n,e;switch(t.substring(0,3).toLowerCase()){case"hsl":n=nn.get.hsl(t),e="hsl";break;case"hwb":n=nn.get.hwb(t),e="hwb";break;default:n=nn.get.rgb(t),e="rgb"}return n?{model:e,value:n}:null},nn.get.rgb=function(t){if(!t)return null;var n,e,r,i=[0,0,0,1];if(n=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=n[2],n=n[1],e=0;e<3;e++){var s=2*e;i[e]=parseInt(n.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(n=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(n=n[1])[3],e=0;e<3;e++)i[e]=parseInt(n[e]+n[e],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(n=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(e=0;e<3;e++)i[e]=parseInt(n[e+1],0);n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}else{if(!(n=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(n=t.match(/^(\\w+)$/))?"transparent"===n[1]?[0,0,0,0]:Kt.call(Yt,n[1])?((i=Yt[n[1]])[3]=1,i):null:null;for(e=0;e<3;e++)i[e]=Math.round(2.55*parseFloat(n[e+1]));n[4]&&(n[5]?i[3]=.01*parseFloat(n[4]):i[3]=parseFloat(n[4]))}for(e=0;e<3;e++)i[e]=en(i[e],0,255);return i[3]=en(i[3],0,1),i},nn.get.hsl=function(t){if(!t)return null;var n=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,en(parseFloat(n[2]),0,100),en(parseFloat(n[3]),0,100),en(isNaN(e)?1:e,0,1)]}return null},nn.get.hwb=function(t){if(!t)return null;var n=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(n){var e=parseFloat(n[4]);return[(parseFloat(n[1])%360+360)%360,en(parseFloat(n[2]),0,100),en(parseFloat(n[3]),0,100),en(isNaN(e)?1:e,0,1)]}return null},nn.to.hex=function(){var t=Zt(arguments);return"#"+rn(t[0])+rn(t[1])+rn(t[2])+(t[3]<1?rn(Math.round(255*t[3])):"")},nn.to.rgb=function(){var t=Zt(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},nn.to.rgb.percent=function(){var t=Zt(arguments),n=Math.round(t[0]/255*100),e=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+n+"%, "+e+"%, "+r+"%)":"rgba("+n+"%, "+e+"%, "+r+"%, "+t[3]+")"},nn.to.hsl=function(){var t=Zt(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},nn.to.hwb=function(){var t=Zt(arguments),n="";return t.length>=4&&1!==t[3]&&(n=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+n+")"},nn.to.keyword=function(t){return Qt[t.slice(0,3)]};var sn={exports:{}},on=Wt,an={};for(var un in on)on.hasOwnProperty(un)&&(an[on[un]]=un);var ln=sn.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var hn in ln)if(ln.hasOwnProperty(hn)){if(!("channels"in ln[hn]))throw new Error("missing channels property: "+hn);if(!("labels"in ln[hn]))throw new Error("missing channel labels property: "+hn);if(ln[hn].labels.length!==ln[hn].channels)throw new Error("channel and label counts mismatch: "+hn);var cn=ln[hn].channels,fn=ln[hn].labels;delete ln[hn].channels,delete ln[hn].labels,Object.defineProperty(ln[hn],"channels",{value:cn}),Object.defineProperty(ln[hn],"labels",{value:fn})}function dn(t,n){return Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)}ln.rgb.hsl=function(t){var n,e,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),u=a-o;return a===o?n=0:r===a?n=(i-s)/u:i===a?n=2+(s-r)/u:s===a&&(n=4+(r-i)/u),(n=Math.min(60*n,360))<0&&(n+=360),e=(o+a)/2,[n,100*(a===o?0:e<=.5?u/(a+o):u/(2-a-o)),100*e]},ln.rgb.hsv=function(t){var n,e,r,i,s,o=t[0]/255,a=t[1]/255,u=t[2]/255,l=Math.max(o,a,u),h=l-Math.min(o,a,u),c=function(t){return(l-t)/6/h+.5};return 0===h?i=s=0:(s=h/l,n=c(o),e=c(a),r=c(u),o===l?i=r-e:a===l?i=1/3+n-r:u===l&&(i=2/3+e-n),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*l]},ln.rgb.hwb=function(t){var n=t[0],e=t[1],r=t[2];return[ln.rgb.hsl(t)[0],100*(1/255*Math.min(n,Math.min(e,r))),100*(r=1-1/255*Math.max(n,Math.max(e,r)))]},ln.rgb.cmyk=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-e-(n=Math.min(1-e,1-r,1-i)))/(1-n)||0),100*((1-r-n)/(1-n)||0),100*((1-i-n)/(1-n)||0),100*n]},ln.rgb.keyword=function(t){var n=an[t];if(n)return n;var e,r=1/0;for(var i in on)if(on.hasOwnProperty(i)){var s=dn(t,on[i]);s<r&&(r=s,e=i)}return e},ln.keyword.rgb=function(t){return on[t]},ln.rgb.xyz=function(t){var n=t[0]/255,e=t[1]/255,r=t[2]/255;return[100*(.4124*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.3576*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*n+.7152*e+.0722*r),100*(.0193*n+.1192*e+.9505*r)]},ln.rgb.lab=function(t){var n=ln.rgb.xyz(t),e=n[0],r=n[1],i=n[2];return r/=100,i/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(e-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},ln.hsl.rgb=function(t){var n,e,r,i,s,o=t[0]/360,a=t[1]/100,u=t[2]/100;if(0===a)return[s=255*u,s,s];n=2*u-(e=u<.5?u*(1+a):u+a-u*a),i=[0,0,0];for(var l=0;l<3;l++)(r=o+1/3*-(l-1))<0&&r++,r>1&&r--,s=6*r<1?n+6*(e-n)*r:2*r<1?e:3*r<2?n+(e-n)*(2/3-r)*6:n,i[l]=255*s;return i},ln.hsl.hsv=function(t){var n=t[0],e=t[1]/100,r=t[2]/100,i=e,s=Math.max(r,.01);return e*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[n,100*(0===r?2*i/(s+i):2*e/(r+e)),100*((r+e)/2)]},ln.hsv.rgb=function(t){var n=t[0]/60,e=t[1]/100,r=t[2]/100,i=Math.floor(n)%6,s=n-Math.floor(n),o=255*r*(1-e),a=255*r*(1-e*s),u=255*r*(1-e*(1-s));switch(r*=255,i){case 0:return[r,u,o];case 1:return[a,r,o];case 2:return[o,r,u];case 3:return[o,a,r];case 4:return[u,o,r];case 5:return[r,o,a]}},ln.hsv.hsl=function(t){var n,e,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,e=s*a,[i,100*(e=(e/=(n=(2-s)*a)<=1?n:2-n)||0),100*(r/=2)]},ln.hwb.rgb=function(t){var n,e,r,i,s,o,a,u=t[0]/360,l=t[1]/100,h=t[2]/100,c=l+h;switch(c>1&&(l/=c,h/=c),r=6*u-(n=Math.floor(6*u)),0!=(1&n)&&(r=1-r),i=l+r*((e=1-h)-l),n){default:case 6:case 0:s=e,o=i,a=l;break;case 1:s=i,o=e,a=l;break;case 2:s=l,o=e,a=i;break;case 3:s=l,o=i,a=e;break;case 4:s=i,o=l,a=e;break;case 5:s=e,o=l,a=i}return[255*s,255*o,255*a]},ln.cmyk.rgb=function(t){var n=t[0]/100,e=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},ln.xyz.rgb=function(t){var n,e,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return e=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,n=(n=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(n=Math.min(Math.max(0,n),1)),255*(e=Math.min(Math.max(0,e),1)),255*(r=Math.min(Math.max(0,r),1))]},ln.xyz.lab=function(t){var n=t[0],e=t[1],r=t[2];return e/=100,r/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(e=e>.008856?Math.pow(e,1/3):7.787*e+16/116)-16,500*(n-e),200*(e-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},ln.lab.xyz=function(t){var n,e,r,i=t[0];n=t[1]/500+(e=(i+16)/116),r=e-t[2]/200;var s=Math.pow(e,3),o=Math.pow(n,3),a=Math.pow(r,3);return e=s>.008856?s:(e-16/116)/7.787,n=o>.008856?o:(n-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[n*=95.047,e*=100,r*=108.883]},ln.lab.lch=function(t){var n,e=t[0],r=t[1],i=t[2];return(n=360*Math.atan2(i,r)/2/Math.PI)<0&&(n+=360),[e,Math.sqrt(r*r+i*i),n]},ln.lch.lab=function(t){var n,e=t[0],r=t[1];return n=t[2]/360*2*Math.PI,[e,r*Math.cos(n),r*Math.sin(n)]},ln.rgb.ansi16=function(t){var n=t[0],e=t[1],r=t[2],i=1 in arguments?arguments[1]:ln.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(e/255)<<1|Math.round(n/255));return 2===i&&(s+=60),s},ln.hsv.ansi16=function(t){return ln.rgb.ansi16(ln.hsv.rgb(t),t[2])},ln.rgb.ansi256=function(t){var n=t[0],e=t[1],r=t[2];return n===e&&e===r?n<8?16:n>248?231:Math.round((n-8)/247*24)+232:16+36*Math.round(n/255*5)+6*Math.round(e/255*5)+Math.round(r/255*5)},ln.ansi16.rgb=function(t){var n=t%10;if(0===n||7===n)return t>50&&(n+=3.5),[n=n/10.5*255,n,n];var e=.5*(1+~~(t>50));return[(1&n)*e*255,(n>>1&1)*e*255,(n>>2&1)*e*255]},ln.ansi256.rgb=function(t){if(t>=232){var n=10*(t-232)+8;return[n,n,n]}var e;return t-=16,[Math.floor(t/36)/5*255,Math.floor((e=t%36)/6)/5*255,e%6/5*255]},ln.rgb.hex=function(t){var n=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(n.length)+n},ln.hex.rgb=function(t){var n=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!n)return[0,0,0];var e=n[0];3===n[0].length&&(e=e.split("").map((function(t){return t+t})).join(""));var r=parseInt(e,16);return[r>>16&255,r>>8&255,255&r]},ln.rgb.hcg=function(t){var n,e=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(e,r),i),o=Math.min(Math.min(e,r),i),a=s-o;return n=a<=0?0:s===e?(r-i)/a%6:s===r?2+(i-e)/a:4+(e-r)/a+4,n/=6,[360*(n%=1),100*a,100*(a<1?o/(1-a):0)]},ln.hsl.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=1,i=0;return(r=e<.5?2*n*e:2*n*(1-e))<1&&(i=(e-.5*r)/(1-r)),[t[0],100*r,100*i]},ln.hsv.hcg=function(t){var n=t[1]/100,e=t[2]/100,r=n*e,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},ln.hcg.rgb=function(t){var n=t[0]/360,e=t[1]/100,r=t[2]/100;if(0===e)return[255*r,255*r,255*r];var i,s=[0,0,0],o=n%1*6,a=o%1,u=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=u,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=u,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=u}return i=(1-e)*r,[255*(e*s[0]+i),255*(e*s[1]+i),255*(e*s[2]+i)]},ln.hcg.hsv=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n),r=0;return e>0&&(r=n/e),[t[0],100*r,100*e]},ln.hcg.hsl=function(t){var n=t[1]/100,e=t[2]/100*(1-n)+.5*n,r=0;return e>0&&e<.5?r=n/(2*e):e>=.5&&e<1&&(r=n/(2*(1-e))),[t[0],100*r,100*e]},ln.hcg.hwb=function(t){var n=t[1]/100,e=n+t[2]/100*(1-n);return[t[0],100*(e-n),100*(1-e)]},ln.hwb.hcg=function(t){var n=t[1]/100,e=1-t[2]/100,r=e-n,i=0;return r<1&&(i=(e-r)/(1-r)),[t[0],100*r,100*i]},ln.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},ln.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},ln.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},ln.gray.hsl=ln.gray.hsv=function(t){return[0,0,t[0]]},ln.gray.hwb=function(t){return[0,100,t[0]]},ln.gray.cmyk=function(t){return[0,0,0,t[0]]},ln.gray.lab=function(t){return[t[0],0,0]},ln.gray.hex=function(t){var n=255&Math.round(t[0]/100*255),e=((n<<16)+(n<<8)+n).toString(16).toUpperCase();return"000000".substring(e.length)+e},ln.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var pn=sn.exports;function yn(t){var n=function(){for(var t={},n=Object.keys(pn),e=n.length,r=0;r<e;r++)t[n[r]]={distance:-1,parent:null};return t}(),e=[t];for(n[t].distance=0;e.length;)for(var r=e.pop(),i=Object.keys(pn[r]),s=i.length,o=0;o<s;o++){var a=i[o],u=n[a];-1===u.distance&&(u.distance=n[r].distance+1,u.parent=r,e.unshift(a))}return n}function mn(t,n){return function(e){return n(t(e))}}function gn(t,n){for(var e=[n[t].parent,t],r=pn[n[t].parent][t],i=n[t].parent;n[i].parent;)e.unshift(n[i].parent),r=mn(pn[n[i].parent][i],r),i=n[i].parent;return r.conversion=e,r}var vn=sn.exports,bn=function(t){for(var n=yn(t),e={},r=Object.keys(n),i=r.length,s=0;s<i;s++){var o=r[s];null!==n[o].parent&&(e[o]=gn(o,n))}return e},wn={};Object.keys(vn).forEach((function(t){wn[t]={},Object.defineProperty(wn[t],"channels",{value:vn[t].channels}),Object.defineProperty(wn[t],"labels",{value:vn[t].labels});var n=bn(t);Object.keys(n).forEach((function(e){var r=n[e];wn[t][e]=function(t){var n=function(n){if(null==n)return n;arguments.length>1&&(n=Array.prototype.slice.call(arguments));var e=t(n);if("object"==typeof e)for(var r=e.length,i=0;i<r;i++)e[i]=Math.round(e[i]);return e};return"conversion"in t&&(n.conversion=t.conversion),n}(r),wn[t][e].raw=function(t){var n=function(n){return null==n?n:(arguments.length>1&&(n=Array.prototype.slice.call(arguments)),t(n))};return"conversion"in t&&(n.conversion=t.conversion),n}(r)}))}));var Mn=wn,xn=Ht.exports,Fn=Mn,An=[].slice,kn=["keyword","gray","hex"],Pn={};Object.keys(Fn).forEach((function(t){Pn[An.call(Fn[t].labels).sort().join("")]=t}));var Sn={};function _n(t,n){if(!(this instanceof _n))return new _n(t,n);if(n&&n in kn&&(n=null),n&&!(n in Fn))throw new Error("Unknown model: "+n);var e,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof _n)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=xn.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=Fn[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=n||"rgb",r=Fn[this.model].channels;var s=An.call(t,0,r);this.color=$n(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in Pn))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=Pn[a];var u=Fn[this.model].labels,l=[];for(e=0;e<u.length;e++)l.push(t[u[e]]);this.color=$n(l)}if(Sn[this.model])for(r=Fn[this.model].channels,e=0;e<r;e++){var h=Sn[this.model][e];h&&(this.color[e]=h(this.color[e]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function On(t,n,e){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(Sn[t]||(Sn[t]=[]))[n]=e})),t=t[0],function(r){var i;return arguments.length?(e&&(r=e(r)),(i=this[t]()).color[n]=r,i):(i=this[t]().color[n],e&&(i=e(i)),i)}}function En(t){return function(n){return Math.max(0,Math.min(t,n))}}function In(t){return Array.isArray(t)?t:[t]}function $n(t,n){for(var e=0;e<n;e++)"number"!=typeof t[e]&&(t[e]=0);return t}_n.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var n=this.model in xn.to?this:this.rgb(),e=1===(n=n.round("number"==typeof t?t:1)).valpha?n.color:n.color.concat(this.valpha);return xn.to[n.model](e)},percentString:function(t){var n=this.rgb().round("number"==typeof t?t:1),e=1===n.valpha?n.color:n.color.concat(this.valpha);return xn.to.rgb.percent(e)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},n=Fn[this.model].channels,e=Fn[this.model].labels,r=0;r<n;r++)t[e[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new _n(this.color.map(function(t){return function(n){return function(t,n){return Number(t.toFixed(n))}(n,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new _n(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:On("rgb",0,En(255)),green:On("rgb",1,En(255)),blue:On("rgb",2,En(255)),hue:On(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:On("hsl",1,En(100)),lightness:On("hsl",2,En(100)),saturationv:On("hsv",1,En(100)),value:On("hsv",2,En(100)),chroma:On("hcg",1,En(100)),gray:On("hcg",2,En(100)),white:On("hwb",1,En(100)),wblack:On("hwb",2,En(100)),cyan:On("cmyk",0,En(100)),magenta:On("cmyk",1,En(100)),yellow:On("cmyk",2,En(100)),black:On("cmyk",3,En(100)),x:On("xyz",0,En(100)),y:On("xyz",1,En(100)),z:On("xyz",2,En(100)),l:On("lab",0,En(100)),a:On("lab",1),b:On("lab",2),keyword:function(t){return arguments.length?new _n(t):Fn[this.model].keyword(this.color)},hex:function(t){return arguments.length?new _n(t):xn.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,n=[],e=0;e<t.length;e++){var r=t[e]/255;n[e]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*n[0]+.7152*n[1]+.0722*n[2]},contrast:function(t){var n=this.luminosity(),e=t.luminosity();return n>e?(n+.05)/(e+.05):(e+.05)/(n+.05)},level:function(t){var n=this.contrast(t);return n>=7.1?"AAA":n>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),n=0;n<3;n++)t.color[n]=255-t.color[n];return t},lighten:function(t){var n=this.hsl();return n.color[2]+=n.color[2]*t,n},darken:function(t){var n=this.hsl();return n.color[2]-=n.color[2]*t,n},saturate:function(t){var n=this.hsl();return n.color[1]+=n.color[1]*t,n},desaturate:function(t){var n=this.hsl();return n.color[1]-=n.color[1]*t,n},whiten:function(t){var n=this.hwb();return n.color[1]+=n.color[1]*t,n},blacken:function(t){var n=this.hwb();return n.color[2]+=n.color[2]*t,n},grayscale:function(){var t=this.rgb().color,n=.3*t[0]+.59*t[1]+.11*t[2];return _n.rgb(n,n,n)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var n=this.hsl(),e=n.color[0];return e=(e=(e+t)%360)<0?360+e:e,n.color[0]=e,n},mix:function(t,n){if(!t||!t.rgb)throw new Error(\'Argument to "mix" was not a Color instance, but rather an instance of \'+typeof t);var e=t.rgb(),r=this.rgb(),i=void 0===n?.5:n,s=2*i-1,o=e.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,u=1-a;return _n.rgb(a*e.red()+u*r.red(),a*e.green()+u*r.green(),a*e.blue()+u*r.blue(),e.alpha()*i+r.alpha()*(1-i))}},Object.keys(Fn).forEach((function(t){if(-1===kn.indexOf(t)){var n=Fn[t].channels;_n.prototype[t]=function(){if(this.model===t)return new _n(this);if(arguments.length)return new _n(arguments,t);var e="number"==typeof arguments[n]?n:this.valpha;return new _n(In(Fn[this.model][t].raw(this.color)).concat(e),t)},_n[t]=function(e){return"number"==typeof e&&(e=$n(An.call(arguments),n)),new _n(e,t)}}}));var Cn=_n;\n/*!\n        Feature Filter by\n\n        (c) mapbox 2016 and maptalks 2018\n        www.mapbox.com | www.maptalks.org\n        License: MIT, header required.\n    */const Tn=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function zn(t){return new Function("f","var p = (f && f.properties || {}); return "+Dn(t))}function Dn(t){if(!t)return"true";const n=t[0];if(t.length<=1)return"any"===n?"false":"true";return`(${"=="===n?Un(t[1],t[2],"===",!1):"!="===n?Un(t[1],t[2],"!==",!1):"<"===n||">"===n||"<="===n||">="===n?Un(t[1],t[2],n,!0):"any"===n?Ln(t.slice(1),"||"):"all"===n?Ln(t.slice(1),"&&"):"none"===n?Hn(Ln(t.slice(1),"||")):"in"===n?Vn(t[1],t.slice(2)):"!in"===n?Hn(Vn(t[1],t.slice(2))):"has"===n?Rn(t[1]):"!has"===n?Hn(Rn(t[1])):"contains"===n?function(t,n,e){const r=jn(t);return void 0!==e?`(${r} + \'\').indexOf("${n}") === ${e}`:`(${r} + \'\').indexOf("${n}") >= 0`}(t[1],t[2],t[3]):"true"})`}function jn(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function Un(t,n,e,r){if("object"==typeof(i=t)&&i&&t.op)return function(t,n,e,r){const i=t.property,s=t.op;let o=jn(i);return"length"!==s?(console.error(`not support ${s} op`),"false"):(o=`((${o}+=\'\').length)`,Nn(o,i,n,e,r))}(t,n,e,r);var i;return Nn(jn(t),t,n,e,r)}function Nn(t,n,e,r,i){const s="$type"===n?Tn.indexOf(e):JSON.stringify(e);return(i?`typeof ${t}=== typeof ${s}&&`:"")+t+r+s}function Ln(t,n){return t.map(Dn).join(n)}function Vn(t,n){"$type"===t&&(n=n.map(t=>Tn.indexOf(t)));const e=JSON.stringify(n.sort(Wn)),r=jn(t);return n.length<=200?`${e}.indexOf(${r}) !== -1`:`function(v, a, i, j) {\\n        while (i <= j) { var m = (i + j) >> 1;\\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\\n        }\\n    return false; }(${r}, ${e},0,${n.length-1})`}function Rn(t){return"$id"===t?\'"id" in f\':JSON.stringify(t)+" in p"}function Hn(t){return`!(${t})`}function Wn(t,n){return t<n?-1:t>n?1:0}var qn={exports:{}};qn.exports=function(){function t(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function n(t,n){return t<n?-1:t>n?1:0}return function(e,r,i,s,o){!function n(e,r,i,s,o){for(;s>i;){if(s-i>600){var a=s-i+1,u=r-i+1,l=Math.log(a),h=.5*Math.exp(2*l/3),c=.5*Math.sqrt(l*h*(a-h)/a)*(u-a/2<0?-1:1),f=Math.max(i,Math.floor(r-u*h/a+c)),d=Math.min(s,Math.floor(r+(a-u)*h/a+c));n(e,r,f,d,o)}var p=e[r],y=i,m=s;for(t(e,i,r),o(e[s],p)>0&&t(e,i,s);y<m;){for(t(e,y,m),y++,m--;o(e[y],p)<0;)y++;for(;o(e[m],p)>0;)m--}0===o(e[i],p)?t(e,i,m):(m++,t(e,m,s)),m<=r&&(i=m+1),r<=m&&(s=m-1)}}(e,r,i||0,s||e.length-1,o||n)}}();var Gn=qn.exports;class Bn{constructor(t=[],n=Jn){if(this.data=t,this.length=this.data.length,this.compare=n,this.length>0)for(let t=(this.length>>1)-1;t>=0;t--)this.D(t)}push(t){this.data.push(t),this.length++,this.j(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],n=this.data.pop();return this.length--,this.length>0&&(this.data[0]=n,this.D(0)),t}peek(){return this.data[0]}j(t){const{data:n,compare:e}=this,r=n[t];for(;t>0;){const i=t-1>>1,s=n[i];if(e(r,s)>=0)break;n[t]=s,t=i}n[t]=r}D(t){const{data:n,compare:e}=this,r=this.length>>1,i=n[t];for(;t<r;){let r=1+(t<<1),s=n[r];const o=r+1;if(o<this.length&&e(n[o],s)<0&&(r=o,s=n[o]),e(s,i)>=0)break;n[t]=s,t=r}n[t]=i}}function Jn(t,n){return t<n?-1:t>n?1:0}\n/*!\n     * Contains code from google filament\n     * https://github.com/google/filament/\n     * License Apache-2.0\n     */const Xn=[],Yn=[],Zn=[],Kn=[];function Qn(t,n,e){const r=mt(Yn,n,e);t=At(t,function(t,n,e,r,i,s,o,a,u,l){return t[0]=n,t[1]=e,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=u,t[8]=l,t}(Xn,e[0],e[1],e[2],...r,...n));if((t=function(t){return t[3]<0?Pt(t,t,-1):t}(t=St(t,t)))[3]<1/32767){t[3]=1/32767;const n=Math.sqrt(.9999999990686206);t[0]*=n,t[1]*=n,t[2]*=n}const i=e[3]>0?mt(Zn,e,n):mt(Zn,n,e);return yt(mt(Kn,e,n),i)<0&&Pt(t,t,-1),t}const te=[];function ne(t,n,e){const r=e||[];r.setLength&&r.setLength(t.length);const i=te;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const s=void 0===n.length?n:n.length;for(let e=0;e<s/3;e++)void 0===n.length?le(t,3*e,3*e+1,3*e+2,r,i):le(t,n[3*e],n[3*e+1],n[3*e+2],r,i);for(let t=0;t<r.length;t+=3){const n=i[t/3];0!==n?(r[t]/=n,r[t+1]/=n,r[t+2]/=n):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}const ee=[],re=[],ie=[],se=[],oe=[],ae=[],ue=[];function le(t,n,e,r,i,s){ft(se,t[3*n],t[3*n+1],t[3*n+2]),ft(oe,t[3*e],t[3*e+1],t[3*e+2]),ft(ae,t[3*r],t[3*r+1],t[3*r+2]);const o=gt(ee,ae,oe),a=gt(re,se,oe),u=mt(ie,o,a);pt(ue,u),i[3*n]=i[3*n]||0,i[3*e]=i[3*e]||0,i[3*r]=i[3*r]||0,i[3*n+1]=i[3*n+1]||0,i[3*e+1]=i[3*e+1]||0,i[3*r+1]=i[3*r+1]||0,i[3*n+2]=i[3*n+2]||0,i[3*e+2]=i[3*e+2]||0,i[3*r+2]=i[3*r+2]||0,i[3*n]+=ue[0],i[3*e]+=ue[0],i[3*r]+=ue[0],i[3*n+1]+=ue[1],i[3*e+1]+=ue[1],i[3*r+1]+=ue[1],i[3*n+2]+=ue[2],i[3*e+2]+=ue[2],i[3*r+2]+=ue[2],s[n]+=1,s[e]+=1,s[r]+=1}\n/*!\n     * Contains code from THREE.JS\n     * https://github.com/mrdoob/three.js/\n     * License MIT\n     * \n     * Generate tangents per vertex.\n     */function he(t,n,e){return t[0]=n[e],t[1]=n[e+1],t[2]=n[e+2],t}function ce(t,n,e){return t[0]=n[e],t[1]=n[e+1],t}var fe={exports:{}};function de(t,n,e){e=e||2;var r,i,s,o,a,u,l,h=n&&n.length,c=h?n[0]*e:t.length,f=pe(t,0,c,e,!0),d=[];if(!f||f.next===f.prev)return d;if(h&&(f=function(t,n,e,r){var i,s,o,a,u,l=[];for(i=0,s=n.length;i<s;i++)o=n[i]*r,a=i<s-1?n[i+1]*r:t.length,(u=pe(t,o,a,r,!1))===u.next&&(u.steiner=!0),l.push(ke(u));for(l.sort(Me),i=0;i<l.length;i++)e=xe(l[i],e);return e}(t,n,f,e)),t.length>80*e){r=s=t[0],i=o=t[1];for(var p=e;p<c;p+=e)(a=t[p])<r&&(r=a),(u=t[p+1])<i&&(i=u),a>s&&(s=a),u>o&&(o=u);l=0!==(l=Math.max(s-r,o-i))?32767/l:0}return me(f,d,e,r,i,l,0),d}function pe(t,n,e,r,i){var s,o;if(i===Ue(t,n,e,r)>0)for(s=n;s<e;s+=r)o=ze(s,t[s],t[s+1],o);else for(s=e-r;s>=n;s-=r)o=ze(s,t[s],t[s+1],o);return o&&Oe(o,o.next)&&(De(o),o=o.next),o}function ye(t,n){if(!t)return t;n||(n=t);var e,r=t;do{if(e=!1,r.steiner||!Oe(r,r.next)&&0!==_e(r.prev,r,r.next))r=r.next;else{if(De(r),(r=n=r.prev)===r.next)break;e=!0}}while(e||r!==n);return n}function me(t,n,e,r,i,s,o){if(t){!o&&s&&function(t,n,e,r){var i=t;do{0===i.z&&(i.z=Ae(i.x,i.y,n,e,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var n,e,r,i,s,o,a,u,l=1;do{for(e=t,t=null,s=null,o=0;e;){for(o++,r=e,a=0,n=0;n<l&&(a++,r=r.nextZ);n++);for(u=l;a>0||u>0&&r;)0!==a&&(0===u||!r||e.z<=r.z)?(i=e,e=e.nextZ,a--):(i=r,r=r.nextZ,u--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;e=r}s.nextZ=null,l*=2}while(o>1)}(i)}(t,r,i,s);for(var a,u,l=t;t.prev!==t.next;)if(a=t.prev,u=t.next,s?ve(t,r,i,s):ge(t))n.push(a.i/e|0),n.push(t.i/e|0),n.push(u.i/e|0),De(t),t=u.next,l=u.next;else if((t=u)===l){o?1===o?me(t=be(ye(t),n,e),n,e,r,i,s,2):2===o&&we(t,n,e,r,i,s):me(ye(t),n,e,r,i,s,1);break}}}function ge(t){var n=t.prev,e=t,r=t.next;if(_e(n,e,r)>=0)return!1;for(var i=n.x,s=e.x,o=r.x,a=n.y,u=e.y,l=r.y,h=i<s?i<o?i:o:s<o?s:o,c=a<u?a<l?a:l:u<l?u:l,f=i>s?i>o?i:o:s>o?s:o,d=a>u?a>l?a:l:u>l?u:l,p=r.next;p!==n;){if(p.x>=h&&p.x<=f&&p.y>=c&&p.y<=d&&Pe(i,a,s,u,o,l,p.x,p.y)&&_e(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ve(t,n,e,r){var i=t.prev,s=t,o=t.next;if(_e(i,s,o)>=0)return!1;for(var a=i.x,u=s.x,l=o.x,h=i.y,c=s.y,f=o.y,d=a<u?a<l?a:l:u<l?u:l,p=h<c?h<f?h:f:c<f?c:f,y=a>u?a>l?a:l:u>l?u:l,m=h>c?h>f?h:f:c>f?c:f,g=Ae(d,p,n,e,r),v=Ae(y,m,n,e,r),b=t.prevZ,w=t.nextZ;b&&b.z>=g&&w&&w.z<=v;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&Pe(a,h,u,c,l,f,b.x,b.y)&&_e(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&Pe(a,h,u,c,l,f,w.x,w.y)&&_e(w.prev,w,w.next)>=0)return!1;w=w.nextZ}for(;b&&b.z>=g;){if(b.x>=d&&b.x<=y&&b.y>=p&&b.y<=m&&b!==i&&b!==o&&Pe(a,h,u,c,l,f,b.x,b.y)&&_e(b.prev,b,b.next)>=0)return!1;b=b.prevZ}for(;w&&w.z<=v;){if(w.x>=d&&w.x<=y&&w.y>=p&&w.y<=m&&w!==i&&w!==o&&Pe(a,h,u,c,l,f,w.x,w.y)&&_e(w.prev,w,w.next)>=0)return!1;w=w.nextZ}return!0}function be(t,n,e){var r=t;do{var i=r.prev,s=r.next.next;!Oe(i,s)&&Ee(i,r,r.next,s)&&Ce(i,s)&&Ce(s,i)&&(n.push(i.i/e|0),n.push(r.i/e|0),n.push(s.i/e|0),De(r),De(r.next),r=t=s),r=r.next}while(r!==t);return ye(r)}function we(t,n,e,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Se(o,a)){var u=Te(o,a);return o=ye(o,o.next),u=ye(u,u.next),me(o,n,e,r,i,s,0),void me(u,n,e,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function Me(t,n){return t.x-n.x}function xe(t,n){var e=function(t,n){var e,r=n,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,e=r.x<r.next.x?r:r.next,a===i))return e}r=r.next}while(r!==n);if(!e)return null;var u,l=e,h=e.x,c=e.y,f=1/0;r=e;do{i>=r.x&&r.x>=h&&i!==r.x&&Pe(s<c?i:o,s,h,c,s<c?o:i,s,r.x,r.y)&&(u=Math.abs(s-r.y)/(i-r.x),Ce(r,t)&&(u<f||u===f&&(r.x>e.x||r.x===e.x&&Fe(e,r)))&&(e=r,f=u)),r=r.next}while(r!==l);return e}(t,n);if(!e)return n;var r=Te(e,t);return ye(r,r.next),ye(e,e.next)}function Fe(t,n){return _e(t.prev,t,n.prev)<0&&_e(n.next,t,t.next)<0}function Ae(t,n,e,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-e)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-r)*i|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function ke(t){var n=t,e=t;do{(n.x<e.x||n.x===e.x&&n.y<e.y)&&(e=n),n=n.next}while(n!==t);return e}function Pe(t,n,e,r,i,s,o,a){return(i-o)*(n-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(e-o)*(n-a)&&(e-o)*(s-a)>=(i-o)*(r-a)}function Se(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var e=t;do{if(e.i!==t.i&&e.next.i!==t.i&&e.i!==n.i&&e.next.i!==n.i&&Ee(e,e.next,t,n))return!0;e=e.next}while(e!==t);return!1}(t,n)&&(Ce(t,n)&&Ce(n,t)&&function(t,n){var e=t,r=!1,i=(t.x+n.x)/2,s=(t.y+n.y)/2;do{e.y>s!=e.next.y>s&&e.next.y!==e.y&&i<(e.next.x-e.x)*(s-e.y)/(e.next.y-e.y)+e.x&&(r=!r),e=e.next}while(e!==t);return r}(t,n)&&(_e(t.prev,t,n.prev)||_e(t,n.prev,n))||Oe(t,n)&&_e(t.prev,t,t.next)>0&&_e(n.prev,n,n.next)>0)}function _e(t,n,e){return(n.y-t.y)*(e.x-n.x)-(n.x-t.x)*(e.y-n.y)}function Oe(t,n){return t.x===n.x&&t.y===n.y}function Ee(t,n,e,r){var i=$e(_e(t,n,e)),s=$e(_e(t,n,r)),o=$e(_e(e,r,t)),a=$e(_e(e,r,n));return i!==s&&o!==a||(!(0!==i||!Ie(t,e,n))||(!(0!==s||!Ie(t,r,n))||(!(0!==o||!Ie(e,t,r))||!(0!==a||!Ie(e,n,r)))))}function Ie(t,n,e){return n.x<=Math.max(t.x,e.x)&&n.x>=Math.min(t.x,e.x)&&n.y<=Math.max(t.y,e.y)&&n.y>=Math.min(t.y,e.y)}function $e(t){return t>0?1:t<0?-1:0}function Ce(t,n){return _e(t.prev,t,t.next)<0?_e(t,n,t.next)>=0&&_e(t,t.prev,n)>=0:_e(t,n,t.prev)<0||_e(t,t.next,n)<0}function Te(t,n){var e=new je(t.i,t.x,t.y),r=new je(n.i,n.x,n.y),i=t.next,s=n.prev;return t.next=n,n.prev=t,e.next=i,i.prev=e,r.next=e,e.prev=r,s.next=r,r.prev=s,r}function ze(t,n,e,r){var i=new je(t,n,e);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function De(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function je(t,n,e){this.i=t,this.x=n,this.y=e,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Ue(t,n,e,r){for(var i=0,s=n,o=e-r;s<e;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}fe.exports=de,fe.exports.default=de,de.deviation=function(t,n,e,r){var i=n&&n.length,s=i?n[0]*e:t.length,o=Math.abs(Ue(t,0,s,e));if(i)for(var a=0,u=n.length;a<u;a++){var l=n[a]*e,h=a<u-1?n[a+1]*e:t.length;o-=Math.abs(Ue(t,l,h,e))}var c=0;for(a=0;a<r.length;a+=3){var f=r[a]*e,d=r[a+1]*e,p=r[a+2]*e;c+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===c?0:Math.abs((c-o)/o)},de.flatten=function(t){for(var n=t[0][0].length,e={vertices:[],holes:[],dimensions:n},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<n;o++)e.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,e.holes.push(r))}return e};var Ne=fe.exports;\n/*!\n     * @maptalks/vector-packer v0.95.0\n     * LICENSE : UNLICENSED\n     * (c) 2016-2024 maptalks.com\n     */const Le={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function Ve(t,n={}){var e=[];if("FeatureCollection"===t.type)for(var r=0;r<t.features.length;r++)Re(e,t.features[r],n,r);else Re(e,"Feature"===t.type?t:{geometry:t},n);return e}function Re(t,n,e,r){if(n.geometry&&n.geometry.geometry){var i=n.geometry.coordinates,s=n.geometry.type,o=[],a=n.id;if(e.promoteId?a=n.properties[e.promoteId]:e.generateId&&(a=r||0),"Point"===s)He(i,o);else if("MultiPoint"===s)for(var u=0;u<i.length;u++)He(i[u],o);else if("LineString"===s)qe([i],o);else if("MultiLineString"===s){if(e.lineMetrics){for(u=0;u<i.length;u++)We(i[u],o=[]),t.push(Ge(a,"LineString",o,n.properties));return}qe(i,o)}else if("Polygon"===s)qe(i,o);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(u=0;u<n.geometry.geometries.length;u++)Re(t,{id:a,geometry:n.geometry.geometries[u],properties:n.properties},e,r);return}return void console.warn(`Input data type(${s}) is not a valid GeoJSON geometry type.`)}for(u=0;u<i.length;u++){var l=[];qe(i[u],l),o.push(l)}}t.push(Ge(a,s,o,n.properties))}}function He(t,n){const e=new Ut(t[0],t[1]);e.z=100*(t[2]||0),n.push([e])}function We(t,n){for(let e=0;e<t.length;e++){const r=new Ut(t[e][0],t[e][1]);r.z=100*(t[e][2]||0),n.push(r)}}function qe(t,n,e,r){for(var i=0;i<t.length;i++){var s=[];We(t[i],s),n.push(s)}}function Ge(t,n,e,r){return{id:void 0===t?null:t,type:Le[n],geometry:e,properties:r}}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     */function Be(t,{width:n,height:e},r,i){if(i){if(i.length!==n*e*r)throw new RangeError("mismatched image size")}else i=new Uint8Array(n*e*r);return t.width=n,t.height=e,t.data=i,t}function Je(t,{width:n,height:e},r){if(n===t.width&&e===t.height)return;const i=Be({},{width:n,height:e},r);Xe(t,i,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,n),height:Math.min(t.height,e)},r),t.width=n,t.height=e,t.data=i.data}function Xe(t,n,e,r,i,s){if(0===i.width||0===i.height)return n;if(i.width>t.width||i.height>t.height||e.x>t.width-i.width||e.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>n.width||i.height>n.height||r.x>n.width-i.width||r.y>n.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const o=t.data,a=n.data;if(o===a)return n;for(let u=0;u<i.height;u++){const l=((e.y+u)*t.width+e.x)*s,h=((r.y+u)*n.width+r.x)*s;for(let t=0;t<i.width*s;t++)a[h+t]=o[l+t]}return n}class Ye{constructor(t,n){Be(this,t,1,n)}resize(t){Je(this,t,1)}clone(){return new Ye({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){Xe(t,n,e,r,i,1)}}class Ze{constructor(t,n){Be(this,t,4,n)}resize(t){Je(this,t,4)}clone(){return new Ze({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,n,e,r,i){Xe(t,n,e,r,i,4)}}function Ke(t){let n=0;for(let e,r,i=0,s=t.length,o=s-1;i<s;o=i++)if(e=t[i],r=t[o],void 0!==e.x){if(e.z||r.z)return 1;n+=(r.x-e.x)*(e.y+r.y)}else{if(e[2]||r[2])return 1;n+=(r[0]-e[0])*(e[1]+r[1])}return n}function Qe(t,n,e,r,i){const s=t[n*r],o=t[n*r+1],a=t[e*r],u=t[e*r+1];return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function tr(t,n,e){let r=e;return n&&t&&(r=+t[n]),isNaN(r)&&(r=e||0),100*r}function nr(t,n,e,r,i,s,o){n||0===n||(n=1);const a=tr(t.properties,e,r),u=a*n;let l=(s?100*s:0)||a;return i?l=tr(t.properties,i,s):o&&(l=a-tr(t.properties,o,s)),l*=n,{altitude:u,height:l}}function er(t,n){return n<1/0&&(t.x<0||t.x>n||t.y<0||t.y>n)}function rr(t){return null==t}function ir(t,n,e){if(t===e||t===n)return t;const r=e-n;return((t-n)%r+r)%r+n}function sr(t,n){if(!n)return null;const e=new Map;for(let r=0;r<n.length;r++){const i=n[r],s=t[i];let o=e.get(s);o||(o=[],e.set(s,o)),o.push(i)}return e}function or(t){return 0==(t&t-1)&&0!==t}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     */class ar{constructor(t,n,{pixelRatio:e}){this.paddedRect=t,this.pixelRatio=e||1,this.padding=n}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class ur{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n=Object.keys(t).length,e={},r=new Lt(0,0,{autoResize:!0}),i=[],s=n>1?1:0;for(const n in t){const r=t[n],o={x:0,y:0,w:r.data.width+2*s,h:r.data.height+2*s};i.push(o),e[n]=new ar(o,s,r)}if(r.pack(i,{inPlace:!0}),!or(r.w)||!or(r.h)){const t=lr(r.w),n=lr(r.h);r.resize(t,n)}const o=new Ze({width:r.w,height:r.h});for(const n in t){const r=t[n],i=e[n].paddedRect;Ze.copy(r.data,o,{x:0,y:0},{x:i.x+s,y:i.y+s},r.data)}this.image=o,this.positions=e}}function lr(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}\n/*!\n     * Codes from mapbox-gl-js\n     * github.com/mapbox/mapbox-gl-js\n     * MIT License\n     * TODO potpack\n     */class hr{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,n={},e=new Lt(0,0,{autoResize:!0}),r=[];for(const e in t){const i=t[e],s=n[e]={};for(const t in i){const n=i[+t];if(!n||0===n.bitmap.width||0===n.bitmap.height)continue;const e={x:0,y:0,w:n.bitmap.width+2,h:n.bitmap.height+2};r.push(e),s[t]={rect:e,metrics:n.metrics}}}e.pack(r,{inPlace:!0});const i=new Ye({width:e.w,height:e.h});for(const e in t){const r=t[e];for(const t in r){const s=r[+t];if(!s||0===s.bitmap.width||0===s.bitmap.height)continue;const o=n[e][t].rect;Ye.copy(s.bitmap,i,{x:0,y:0},{x:o.x+1,y:o.y+1},s.bitmap)}}this.image=i,this.positions=n}}function cr(t){return t<65536?Uint16Array:Uint32Array}function fr(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function dr(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function pr(t,n){const e=t.length;t=t.U||t;const r=new n(e);for(let n=0;n<e;n++)r[n]=t[n];return r}function yr(t){const n=t.type,e=[];if(1===n||4===n)for(let n=0;n<t.geometry.length;n++)He(t.geometry[n],e);else if(2===n)qe(t.geometry,e);else if(3===n)qe(t.geometry,e);else if(5===n)qe(t.geometry,e);else if(6===n)for(let n=0;n<t.geometry.length;n++){const r=[];qe(t.geometry[n],r),e.push(r)}return t.geometry=e,t}function mr(t){for(let n=1;n<arguments.length;n++){const e=arguments[n];for(const n in e)t[n]=e[n]}return t}function gr(t){return null==t}function vr(t){return"number"==typeof t&&!isNaN(t)}function br(t){return"object"==typeof t&&!!t}function wr(t){return!gr(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function Mr(t){return!gr(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const xr=Object.prototype.hasOwnProperty;function Fr(t,n){return xr.call(t,n)}const Ar=Math.PI/180;function kr(t){return t&&d(t)&&t.property}function Pr(t){const{verticalCentimeterToPoint:n,tileRatio:e}=t;return n*e}function Sr(t){return"centimeter"===t||"cm"===t?1:"millimeter"===t||"mm"===t?.1:100}const _r={};function Or(t,n){if(!Array.isArray(n)){if(n&&void 0!==n.r&&void 0!==n.g&&void 0!==n.b)return t[0]=255*n.r,t[1]=255*n.g,t[2]=255*n.b,t[3]=void 0!==n.a?255*n.a:255,t;n=_r[n]=_r[n]||Cn(n).unitArray()}for(let e=0;e<n.length;e++)t[e]=255*n[e];return 3===n.length&&(t[3]=255),t}const Er={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1},Ir={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var $r=Object.freeze({__proto__:null,now:function(){return Date.now()},extend:mr,isNil:gr,isNumber:vr,isInteger:function(t){return(0|t)===t},isObject:br,isString:wr,isFunction:Mr,hasOwn:Fr,join:function(t,n){return t.join?t.join(n||","):Array.prototype.join.call(t,n||",")},toRadian:function(t){return t*Ar},toDegree:function(t){return t/Ar},evaluate:function(t,n,e){return Mr(t)?t(void 0!==e?e:null,n):t},isFnTypeSymbol:kr,getAltitudeToLocal:Pr,getTubeSizeScale:Sr,normalizeColor:Or,checkIfIdentityZoomDependent:function(t,n,e){if(Array.isArray(e)||(e=Object.values(e)),!e||!e.length)return!1;if(!Er[t])return!1;for(let t=0;t<e.length;t++){const r=e[t]&&(e[t].feature||e[t]);if(!r)continue;const i=r.properties&&r.properties[n];if(i&&d(i)&&!p(i).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(t){return!!Er[t]||!!Ir[t]}});class Cr{constructor(t,n,e,r){this.feature=t,this.symbol=n,this.fnTypes=e,this.options=r}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:n}=this.fnTypes;return this.L(t,n)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:n}=this.fnTypes;return this.L(t,n)}L(t,n){return n&&(t=n(this.options.zoom,this.feature.properties)),t}}function Tr(t,n,e,r){const i=Math.abs(r)>>15,s=i>>1,o=i%2;let a=r%Math.pow(2,15);const u=n+(s<<14)*Math.sign(n),l=e+(o<<14)*Math.sign(e);return t[0]=u,t[1]=l,a=Math.round(a),t[2]=0===a?r<0?-1:0:a,t}const zr=Math.pow(2,14),Dr=Math.pow(2,15);\n/*!\n     * a compact version of mapbox-gl-style-spec\n     * based on mapbox-gl-style-spec@13.28.0\n     * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec\n     * LICENSE : ISC\n     */var jr,Ur,Nr="undefined"!=typeof undefinedThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof undefined?global:"undefined"!=typeof self?self:{},Lr={exports:{}};function Vr(t,...n){for(const e of n)for(const n in e)t[n]=e[n];return t}\n/*! https://mths.be/punycode v1.3.2 by @mathias */jr=Lr,Ur=Lr.exports,function(t){var n=Ur&&!Ur.nodeType&&Ur,e=jr&&!jr.nodeType&&jr,r="object"==typeof Nr&&Nr;r.global!==r&&r.window!==r&&r.self!==r||(t=r);var i,s,o=2147483647,a=/^xn--/,u=/[^\\x20-\\x7E]/,l=/[\\x2E\\u3002\\uFF0E\\uFF61]/g,h={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},c=Math.floor,f=String.fromCharCode;function d(t){throw RangeError(h[t])}function p(t,n){for(var e=t.length,r=[];e--;)r[e]=n(t[e]);return r}function y(t,n){var e=t.split("@"),r="";return e.length>1&&(r=e[0]+"@",t=e[1]),r+p((t=t.replace(l,".")).split("."),n).join(".")}function m(t){for(var n,e,r=[],i=0,s=t.length;i<s;)(n=t.charCodeAt(i++))>=55296&&n<=56319&&i<s?56320==(64512&(e=t.charCodeAt(i++)))?r.push(((1023&n)<<10)+(1023&e)+65536):(r.push(n),i--):r.push(n);return r}function g(t){return p(t,(function(t){var n="";return t>65535&&(n+=f((t-=65536)>>>10&1023|55296),t=56320|1023&t),n+f(t)})).join("")}function v(t,n){return t+22+75*(t<26)-((0!=n)<<5)}function b(t,n,e){var r=0;for(t=e?c(t/700):t>>1,t+=c(t/n);t>455;r+=36)t=c(t/35);return c(r+36*t/(t+38))}function w(t){var n,e,r,i,s,a,u,l,h,f,p,y=[],m=t.length,v=0,w=128,M=72;for((e=t.lastIndexOf("-"))<0&&(e=0),r=0;r<e;++r)t.charCodeAt(r)>=128&&d("not-basic"),y.push(t.charCodeAt(r));for(i=e>0?e+1:0;i<m;){for(s=v,a=1,u=36;i>=m&&d("invalid-input"),((l=(p=t.charCodeAt(i++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:36)>=36||l>c((o-v)/a))&&d("overflow"),v+=l*a,!(l<(h=u<=M?1:u>=M+26?26:u-M));u+=36)a>c(o/(f=36-h))&&d("overflow"),a*=f;M=b(v-s,n=y.length+1,0==s),c(v/n)>o-w&&d("overflow"),w+=c(v/n),v%=n,y.splice(v++,0,w)}return g(y)}function M(t){var n,e,r,i,s,a,u,l,h,p,y,g,w,M,x,F=[];for(g=(t=m(t)).length,n=128,e=0,s=72,a=0;a<g;++a)(y=t[a])<128&&F.push(f(y));for(r=i=F.length,i&&F.push("-");r<g;){for(u=o,a=0;a<g;++a)(y=t[a])>=n&&y<u&&(u=y);for(u-n>c((o-e)/(w=r+1))&&d("overflow"),e+=(u-n)*w,n=u,a=0;a<g;++a)if((y=t[a])<n&&++e>o&&d("overflow"),y==n){for(l=e,h=36;!(l<(p=h<=s?1:h>=s+26?26:h-s));h+=36)F.push(f(v(p+(x=l-p)%(M=36-p),0))),l=c(x/M);F.push(f(v(l,0))),s=b(e,w,r==i),e=0,++r}++e,++n}return F.join("")}if(i={version:"1.3.2",ucs2:{decode:m,encode:g},decode:w,encode:M,toASCII:function(t){return y(t,(function(t){return u.test(t)?"xn--"+M(t):t}))},toUnicode:function(t){return y(t,(function(t){return a.test(t)?w(t.slice(4).toLowerCase()):t}))}},n&&e)if(jr.exports==n)e.exports=i;else for(s in i)i.hasOwnProperty(s)&&(n[s]=i[s]);else t.punycode=i}(Nr);class Rr extends Error{constructor(t,n){super(n),this.message=n,this.key=t}}var Hr=Rr;class Wr{constructor(t,n=[]){this.parent=t,this.bindings={};for(const[t,e]of n)this.bindings[t]=e}concat(t){return new Wr(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(t+" not found in scope.")}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var qr=Wr;const Gr={kind:"null"},Br={kind:"number"},Jr={kind:"string"},Xr={kind:"boolean"},Yr={kind:"color"},Zr={kind:"object"},Kr={kind:"value"},Qr={kind:"collator"},ti={kind:"formatted"},ni={kind:"resolvedImage"};function ei(t,n){return{kind:"array",itemType:t,N:n}}function ri(t){if("array"===t.kind){const n=ri(t.itemType);return"number"==typeof t.N?`array<${n}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${n}>`}return t.kind}const ii=[Gr,Br,Jr,Xr,Yr,ti,Zr,ei(Kr),ni];function si(t,n){if("error"===n.kind)return null;if("array"===t.kind){if("array"===n.kind&&(0===n.N&&"value"===n.itemType.kind||!si(t.itemType,n.itemType))&&("number"!=typeof t.N||t.N===n.N))return null}else{if(t.kind===n.kind)return null;if("value"===t.kind)for(const t of ii)if(!si(t,n))return null}return`Expected ${ri(t)} but found ${ri(n)} instead.`}function oi(t,n){return n.some(n=>n.kind===t.kind)}function ai(t,n){return n.some(n=>"null"===n?null===t:"array"===n?Array.isArray(t):"object"===n?t&&!Array.isArray(t)&&"object"==typeof t:n===typeof t)}var ui,li={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function hi(t){return(t=Math.round(t))<0?0:t>255?255:t}function ci(t){return hi("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function fi(t){return function(t){return t<0?0:t>1?1:t}("%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))}function di(t,n,e){return e<0?e+=1:e>1&&(e-=1),6*e<1?t+(n-t)*e*6:2*e<1?n:3*e<2?t+(n-t)*(2/3-e)*6:t}try{ui={}.parseCSSColor=function(t){var n,e=t.replace(/ /g,"").toLowerCase();if(e in li)return li[e].slice();if("#"===e[0])return 4===e.length?(n=parseInt(e.substr(1),16))>=0&&n<=4095?[(3840&n)>>4|(3840&n)>>8,240&n|(240&n)>>4,15&n|(15&n)<<4,1]:null:7===e.length&&(n=parseInt(e.substr(1),16))>=0&&n<=16777215?[(16711680&n)>>16,(65280&n)>>8,255&n,1]:null;var r=e.indexOf("("),i=e.indexOf(")");if(-1!==r&&i+1===e.length){var s=e.substr(0,r),o=e.substr(r+1,i-(r+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=fi(o.pop());case"rgb":return 3!==o.length?null:[ci(o[0]),ci(o[1]),ci(o[2]),a];case"hsla":if(4!==o.length)return null;a=fi(o.pop());case"hsl":if(3!==o.length)return null;var u=(parseFloat(o[0])%360+360)%360/360,l=fi(o[1]),h=fi(o[2]),c=h<=.5?h*(l+1):h+l-h*l,f=2*h-c;return[hi(255*di(f,c,u+1/3)),hi(255*di(f,c,u)),hi(255*di(f,c,u-1/3)),a];default:return null}}return null}}catch(t){}class pi{constructor(t,n,e,r=1){this.r=t,this.g=n,this.b=e,this.a=r}static parse(t){if(!t)return;if(t instanceof pi)return t;if("string"!=typeof t)return;const n=ui(t);return n?new pi(n[0]/255*n[3],n[1]/255*n[3],n[2]/255*n[3],n[3]):void 0}toString(){const[t,n,e,r]=this.toArray();return`rgba(${Math.round(t)},${Math.round(n)},${Math.round(e)},${r})`}toArray(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[255*t/r,255*n/r,255*e/r,r]}toArray01(){const{r:t,g:n,b:e,a:r}=this;return 0===r?[0,0,0,0]:[t/r,n/r,e/r,r]}toArray01PremultipliedAlpha(){const{r:t,g:n,b:e,a:r}=this;return[t,n,e,r]}}pi.black=new pi(0,0,0,1),pi.white=new pi(1,1,1,1),pi.transparent=new pi(0,0,0,0),pi.red=new pi(1,0,0,1),pi.blue=new pi(0,0,1,1);var yi=pi;class mi{constructor(t,n,e){this.sensitivity=t?n?"variant":"case":n?"accent":"base",this.locale=e,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,n){return this.collator.compare(t,n)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class gi{constructor(t,n,e,r,i){this.text=t.normalize?t.normalize():t,this.image=n,this.scale=e,this.fontStack=r,this.textColor=i}}class vi{constructor(t){this.sections=t}static fromString(t){return new vi([new gi(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(t=>0!==t.text.length||t.image&&0!==t.image.name.length)}static factory(t){return t instanceof vi?t:vi.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const n of this.sections){if(n.image){t.push(["image",n.image.name]);continue}t.push(n.text);const e={};n.fontStack&&(e["text-font"]=["literal",n.fontStack.split(",")]),n.scale&&(e["font-scale"]=n.scale),n.textColor&&(e["text-color"]=["rgba"].concat(n.textColor.toArray())),t.push(e)}return t}}class bi{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new bi({name:t,available:!1}):null}serialize(){return["image",this.name]}}function wi(t,n,e,r){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255&&"number"==typeof e&&e>=0&&e<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[t,n,e,r].join(", ")}]: \'a\' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[t,n,e,r]:[t,n,e]).join(", ")}]: \'r\', \'g\', and \'b\' must be between 0 and 255.`}function Mi(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof yi)return!0;if(t instanceof mi)return!0;if(t instanceof vi)return!0;if(t instanceof bi)return!0;if(Array.isArray(t)){for(const n of t)if(!Mi(n))return!1;return!0}if("object"==typeof t){for(const n in t)if(!Mi(t[n]))return!1;return!0}return!1}function xi(t){if(null===t)return Gr;if("string"==typeof t)return Jr;if("boolean"==typeof t)return Xr;if("number"==typeof t)return Br;if(t instanceof yi)return Yr;if(t instanceof mi)return Qr;if(t instanceof vi)return ti;if(t instanceof bi)return ni;if(Array.isArray(t)){const n=t.length;let e;for(const n of t){const t=xi(n);if(e){if(e===t)continue;e=Kr;break}e=t}return ei(e||Kr,n)}return Zr}function Fi(t){const n=typeof t;return null===t?"":"string"===n||"number"===n||"boolean"===n?String(t):t instanceof yi||t instanceof vi||t instanceof bi?t.toString():JSON.stringify(t)}class Ai{constructor(t,n){this.type=t,this.value=n}static parse(t,n){if(2!==t.length)return n.error(`\'literal\' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Mi(t[1]))return n.error("invalid value");const e=t[1];let r=xi(e);const i=n.expectedType;return"array"!==r.kind||0!==r.N||!i||"array"!==i.kind||"number"==typeof i.N&&0!==i.N||(r=i),new Ai(r,e)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof yi?["rgba"].concat(this.value.toArray()):this.value instanceof vi?this.value.serialize():this.value}}var ki=Ai,Pi=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const Si={string:Jr,number:Br,boolean:Xr,object:Zr};class _i{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");let e,r=1;const i=t[0];if("array"===i){let i,s;if(t.length>2){const e=t[1];if("string"!=typeof e||!(e in Si)||"object"===e)return n.error(\'The item type argument of "array" must be one of string, number, boolean\',1);i=Si[e],r++}else i=Kr;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return n.error(\'The length argument to "array" must be a positive integer literal\',2);s=t[2],r++}e=ei(i,s)}else e=Si[i];const s=[];for(;r<t.length;r++){const e=n.parse(t[r],r,Kr);if(!e)return null;s.push(e)}return new _i(e,s)}evaluate(t){for(let n=0;n<this.args.length;n++){const e=this.args[n].evaluate(t);if(!si(this.type,xi(e)))return e;if(n===this.args.length-1)throw new Pi(`Expected value to be of type ${ri(this.type)}, but found ${ri(xi(e))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,n=[t.kind];if("array"===t.kind){const e=t.itemType;if("string"===e.kind||"number"===e.kind||"boolean"===e.kind){n.push(e.kind);const r=t.N;("number"==typeof r||this.args.length>1)&&n.push(r)}}return n.concat(this.args.map(t=>t.serialize()))}}var Oi=_i;class Ei{constructor(t){this.type=ti,this.sections=t}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[1];if(!Array.isArray(e)&&"object"==typeof e)return n.error("First argument must be an image or text section.");const r=[];let i=!1;for(let e=1;e<=t.length-1;++e){const s=t[e];if(i&&"object"==typeof s&&!Array.isArray(s)){i=!1;let t=null;if(s["font-scale"]&&(t=n.parse(s["font-scale"],1,Br),!t))return null;let e=null;if(s["text-font"]&&(e=n.parse(s["text-font"],1,ei(Jr)),!e))return null;let o=null;if(s["text-color"]&&(o=n.parse(s["text-color"],1,Yr),!o))return null;const a=r[r.length-1];a.scale=t,a.font=e,a.textColor=o}else{const s=n.parse(t[e],1,Kr);if(!s)return null;const o=s.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return n.error("Formatted text type must be \'string\', \'value\', \'image\' or \'null\'.");i=!0,r.push({content:s,scale:null,font:null,textColor:null})}}return new Ei(r)}evaluate(t){return new vi(this.sections.map(n=>{const e=n.content.evaluate(t);return xi(e)===ni?new gi("",e,null,null,null):new gi(Fi(e),null,n.scale?n.scale.evaluate(t):null,n.font?n.font.evaluate(t).join(","):null,n.textColor?n.textColor.evaluate(t):null)}))}eachChild(t){for(const n of this.sections)t(n.content),n.scale&&t(n.scale),n.font&&t(n.font),n.textColor&&t(n.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const n of this.sections){t.push(n.content.serialize());const e={};n.scale&&(e["font-scale"]=n.scale.serialize()),n.font&&(e["text-font"]=n.font.serialize()),n.textColor&&(e["text-color"]=n.textColor.serialize()),t.push(e)}return t}}class Ii{constructor(t){this.type=ni,this.input=t}static parse(t,n){if(2!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,Jr);return e?new Ii(e):n.error("No image name provided.")}evaluate(t){const n=this.input.evaluate(t),e=bi.fromString(n);return e&&t.availableImages&&(e.available=t.availableImages.indexOf(n)>-1),e}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const $i={"to-boolean":Xr,"to-color":Yr,"to-number":Br,"to-string":Jr};class Ci{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expected at least one argument.");const e=t[0];if(("to-boolean"===e||"to-string"===e)&&2!==t.length)return n.error("Expected one argument.");const r=$i[e],i=[];for(let e=1;e<t.length;e++){const r=n.parse(t[e],e,Kr);if(!r)return null;i.push(r)}return new Ci(r,i)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let n,e;for(const r of this.args){if(n=r.evaluate(t),e=null,n instanceof yi)return n;if("string"==typeof n){const e=t.parseColor(n);if(e)return e}else if(Array.isArray(n)&&(e=n.length<3||n.length>4?`Invalid rbga value ${JSON.stringify(n)}: expected an array containing either three or four numeric values.`:wi(n[0],n[1],n[2],n[3]),!e))return new yi(n[0]/255,n[1]/255,n[2]/255,n[3])}throw new Pi(e||`Could not parse color from value \'${"string"==typeof n?n:String(JSON.stringify(n))}\'`)}if("number"===this.type.kind){let n=null;for(const e of this.args){if(n=e.evaluate(t),null===n)return 0;const r=Number(n);if(!isNaN(r))return r}throw new Pi(`Could not convert ${JSON.stringify(n)} to number.`)}return"formatted"===this.type.kind?vi.fromString(Fi(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?bi.fromString(Fi(this.args[0].evaluate(t))):Fi(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if("formatted"===this.type.kind)return new Ei([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new Ii(this.args[0]).serialize();const t=["to-"+this.type.kind];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Ti=Ci;const zi=["Unknown","Point","LineString","Polygon"];var Di=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this.V={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?zi[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,n=this.featureDistanceData.scale,{x:e,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(e*n-t[0])+this.featureDistanceData.bearing[1]*(r*n-t[1])}return 0}parseColor(t){let n=this.V[t];return n||(n=this.V[t]=yi.parse(t)),n}};class ji{constructor(t,n,e,r){this.name=t,this.type=n,this.R=e,this.args=r}evaluate(t){return this.R(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,n){const e=t[0],r=ji.definitions[e];if(!r)return n.error(`Unknown expression "${e}". If you wanted a literal array, use ["literal", [...]].`,0);const i=Array.isArray(r)?r[0]:r.type,s=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,o=s.filter(([n])=>!Array.isArray(n)||n.length===t.length-1);let a=null;for(const[r,s]of o){a=new ls(n.registry,n.path,null,n.scope);const o=[];let u=!1;for(let n=1;n<t.length;n++){const e=t[n],i=Array.isArray(r)?r[n-1]:r.type,s=a.parse(e,1+o.length,i);if(!s){u=!0;break}o.push(s)}if(!u)if(Array.isArray(r)&&r.length!==o.length)a.error(`Expected ${r.length} arguments, but found ${o.length} instead.`);else{for(let t=0;t<o.length;t++){const n=Array.isArray(r)?r[t]:r.type,e=o[t];a.concat(t+1).checkSubtype(n,e.type)}if(0===a.errors.length)return new ji(e,i,s,o)}}if(1===o.length)n.errors.push(...a.errors);else{const e=(o.length?o:s).map(([t])=>{return n=t,Array.isArray(n)?`(${n.map(ri).join(", ")})`:`(${ri(n.type)}...)`;var n}).join(" | "),r=[];for(let e=1;e<t.length;e++){const i=n.parse(t[e],1+r.length);if(!i)return null;r.push(ri(i.type))}n.error(`Expected arguments of type ${e}, but found (${r.join(", ")}) instead.`)}return null}static register(t,n){ji.definitions=n;for(const e in n)t[e]=ji}}var Ui=ji;class Ni{constructor(t,n,e){this.type=Qr,this.locale=e,this.caseSensitive=t,this.diacriticSensitive=n}static parse(t,n){if(2!==t.length)return n.error("Expected one argument.");const e=t[1];if("object"!=typeof e||Array.isArray(e))return n.error("Collator options argument must be an object.");const r=n.parse(void 0!==e["case-sensitive"]&&e["case-sensitive"],1,Xr);if(!r)return null;const i=n.parse(void 0!==e["diacritic-sensitive"]&&e["diacritic-sensitive"],1,Xr);if(!i)return null;let s=null;return e.locale&&(s=n.parse(e.locale,1,Jr),!s)?null:new Ni(r,i,s)}evaluate(t){return new mi(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}function Li(t,n){t[0]=Math.min(t[0],n[0]),t[1]=Math.min(t[1],n[1]),t[2]=Math.max(t[2],n[0]),t[3]=Math.max(t[3],n[1])}function Vi(t,n){return!(t[0]<=n[0]||t[2]>=n[2]||t[1]<=n[1]||t[3]>=n[3])}function Ri(t,n){const e=(180+t[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,i=Math.pow(2,n.z);return[Math.round(e*i*8192),Math.round(r*i*8192)]}function Hi(t,n,e){const r=t[0]-n[0],i=t[1]-n[1],s=t[0]-e[0],o=t[1]-e[1];return r*o-s*i==0&&r*s<=0&&i*o<=0}function Wi(t,n){let e=!1;for(let o=0,a=n.length;o<a;o++){const a=n[o];for(let n=0,o=a.length;n<o-1;n++){if(Hi(t,a[n],a[n+1]))return!1;(i=a[n])[1]>(r=t)[1]!=(s=a[n+1])[1]>r[1]&&r[0]<(s[0]-i[0])*(r[1]-i[1])/(s[1]-i[1])+i[0]&&(e=!e)}}var r,i,s;return e}function qi(t,n){for(let e=0;e<n.length;e++)if(Wi(t,n[e]))return!0;return!1}function Gi(t,n,e,r){const i=r[0]-e[0],s=r[1]-e[1],o=(t[0]-e[0])*s-i*(t[1]-e[1]),a=(n[0]-e[0])*s-i*(n[1]-e[1]);return o>0&&a<0||o<0&&a>0}function Bi(t,n,e){for(const l of e)for(let e=0;e<l.length-1;++e)if(void 0,void 0,0!=(a=[(o=l[e+1])[0]-(s=l[e])[0],o[1]-s[1]])[0]*(u=[(i=n)[0]-(r=t)[0],i[1]-r[1]])[1]-a[1]*u[0]&&Gi(r,i,s,o)&&Gi(s,o,r,i))return!0;var r,i,s,o,a,u;return!1}function Ji(t,n){for(let e=0;e<t.length;++e)if(!Wi(t[e],n))return!1;for(let e=0;e<t.length-1;++e)if(Bi(t[e],t[e+1],n))return!1;return!0}function Xi(t,n){for(let e=0;e<n.length;e++)if(Ji(t,n[e]))return!0;return!1}function Yi(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=[];for(let r=0;r<t[i].length;r++){const o=Ri(t[i][r],e);Li(n,o),s.push(o)}r.push(s)}return r}function Zi(t,n,e){const r=[];for(let i=0;i<t.length;i++){const s=Yi(t[i],n,e);r.push(s)}return r}function Ki(t,n,e,r){if(t[0]<e[0]||t[0]>e[2]){const n=.5*r;let i=t[0]-e[0]>n?-r:e[0]-t[0]>n?r:0;0===i&&(i=t[0]-e[2]>n?-r:e[2]-t[0]>n?r:0),t[0]+=i}Li(n,t)}function Qi(t,n,e,r){const i=8192*Math.pow(2,r.z),s=[8192*r.x,8192*r.y],o=[];if(!t)return o;for(const r of t)for(const t of r){const r=[t.x+s[0],t.y+s[1]];Ki(r,n,e,i),o.push(r)}return o}function ts(t,n,e,r){const i=8192*Math.pow(2,r.z),s=[8192*r.x,8192*r.y],o=[];if(!t)return o;for(const e of t){const t=[];for(const r of e){const e=[r.x+s[0],r.y+s[1]];Li(n,e),t.push(e)}o.push(t)}if(n[2]-n[0]<=i/2){(a=n)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const t of o)for(const r of t)Ki(r,n,e,i)}var a;return o}class ns{constructor(t,n){this.type=Xr,this.geojson=t,this.geometries=n}static parse(t,n){if(2!==t.length)return n.error(`\'within\' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Mi(t[1])){const n=t[1];if("FeatureCollection"===n.type)for(let t=0;t<n.features.length;++t){const e=n.features[t].geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new ns(n,n.features[t].geometry)}else if("Feature"===n.type){const t=n.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new ns(n,n.geometry)}else if("Polygon"===n.type||"MultiPolygon"===n.type)return new ns(n,n)}return n.error("\'within\' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=Yi(n.coordinates,r,i),o=Qi(t.geometry(),e,r,i);if(!Vi(e,r))return!1;for(const t of o)if(!Wi(t,s))return!1}if("MultiPolygon"===n.type){const s=Zi(n.coordinates,r,i),o=Qi(t.geometry(),e,r,i);if(!Vi(e,r))return!1;for(const t of o)if(!qi(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,n){const e=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===n.type){const s=Yi(n.coordinates,r,i),o=ts(t.geometry(),e,r,i);if(!Vi(e,r))return!1;for(const t of o)if(!Ji(t,s))return!1}if("MultiPolygon"===n.type){const s=Zi(n.coordinates,r,i),o=ts(t.geometry(),e,r,i);if(!Vi(e,r))return!1;for(const t of o)if(!Xi(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var es=ns;function rs(t){if(t instanceof Ui){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof es)return!1;let n=!0;return t.eachChild(t=>{n&&!rs(t)&&(n=!1)}),n}function is(t){if(t instanceof Ui&&"feature-state"===t.name)return!1;let n=!0;return t.eachChild(t=>{n&&!is(t)&&(n=!1)}),n}function ss(t,n){if(t instanceof Ui&&n.indexOf(t.name)>=0)return!1;let e=!0;return t.eachChild(t=>{e&&!ss(t,n)&&(e=!1)}),e}class os{constructor(t,n){this.type=n.type,this.name=t,this.boundExpression=n}static parse(t,n){if(2!==t.length||"string"!=typeof t[1])return n.error("\'var\' expression requires exactly one string literal argument.");const e=t[1];return n.scope.has(e)?new os(e,n.scope.get(e)):n.error(`Unknown variable "${e}". Make sure "${e}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var as=os;class us{constructor(t,n=[],e,r=new qr,i=[]){this.registry=t,this.path=n,this.key=n.map(t=>`[${t}]`).join(""),this.scope=r,this.errors=i,this.expectedType=e}parse(t,n,e,r,i={}){return n?this.concat(n,e,r).H(t,i):this.H(t,i)}H(t,n){function e(t,n,e){return"assert"===e?new Oi(n,[t]):"coerce"===e?new Ti(n,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error(\'Expected an array with at least one element. If you wanted a literal array, use ["literal", []].\');const r=t[0];if("string"!=typeof r)return this.error(`Expression name must be a string, but found ${typeof r} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const i=this.registry[r];if(i){let r=i.parse(t,this);if(!r)return null;if(this.expectedType){const t=this.expectedType,i=r.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==i.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==i.kind&&"string"!==i.kind){if(this.checkSubtype(t,i))return null}else r=e(r,t,n.typeAnnotation||"coerce");else r=e(r,t,n.typeAnnotation||"assert")}if(!(r instanceof ki)&&"resolvedImage"!==r.type.kind&&function t(n){if(n instanceof as)return t(n.boundExpression);if(n instanceof Ui&&"error"===n.name)return!1;if(n instanceof Ni)return!1;if(n instanceof es)return!1;const e=n instanceof Ti||n instanceof Oi;let r=!0;return n.eachChild(n=>{r=e?r&&t(n):r&&n instanceof ki}),!!r&&(rs(n)&&ss(n,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"]))}(r)){const n=new Di;try{r=new ki(r.type,r.evaluate(n))}catch(t){return this.error(t.message),null}}return r}return this.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===t?"\'undefined\' value invalid. Use null instead.":"object"==typeof t?\'Bare objects invalid. Use ["literal", {...}] instead.\':`Expected an array, but found ${typeof t} instead.`)}concat(t,n,e){const r="number"==typeof t?this.path.concat(t):this.path,i=e?this.scope.concat(e):this.scope;return new us(this.registry,r,n||null,i,this.errors)}error(t,...n){const e=`${this.key}${n.map(t=>`[${t}]`).join("")}`;this.errors.push(new Hr(e,t))}checkSubtype(t,n){const e=si(t,n);return e&&this.error(e),e}}var ls=us;function hs(t,n){const e=t.length-1;let r,i,s=0,o=e,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),r=t[a],i=t[a+1],r<=n){if(a===e||n<i)return a;s=a+1}else{if(!(r>n))throw new Pi("Input is not a number.");o=a-1}return 0}class cs{constructor(t,n,e){this.type=t,this.input=n,this.labels=[],this.outputs=[];for(const[t,n]of e)this.labels.push(t),this.outputs.push(n)}static parse(t,n){if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");const e=n.parse(t[1],1,Br);if(!e)return null;const r=[];let i=null;n.expectedType&&"value"!==n.expectedType.kind&&(i=n.expectedType);for(let e=1;e<t.length;e+=2){const s=1===e?-1/0:t[e],o=t[e+1],a=e,u=e+1;if("number"!=typeof s)return n.error(\'Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.\',a);if(r.length&&r[r.length-1][0]>=s)return n.error(\'Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.\',a);const l=n.parse(o,u,i);if(!l)return null;i=i||l.type,r.push([s,l])}return new cs(i,e,r)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;return r>=n[i-1]?e[i-1].evaluate(t):e[hs(n,r)].evaluate(t)}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let n=0;n<this.labels.length;n++)n>0&&t.push(this.labels[n]),t.push(this.outputs[n].serialize());return t}}var fs=cs,ds=ps;function ps(t,n,e,r){this.cx=3*t,this.bx=3*(e-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*n,this.by=3*(r-n)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=n,this.p2x=e,this.p2y=r}function ys(t,n,e){return t*(1-e)+n*e}ps.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,n){if(void 0===n&&(n=1e-6),t<0)return 0;if(t>1)return 1;for(var e=t,r=0;r<8;r++){var i=this.sampleCurveX(e)-t;if(Math.abs(i)<n)return e;var s=this.sampleCurveDerivativeX(e);if(Math.abs(s)<1e-6)break;e-=i/s}var o=0,a=1;for(e=t,r=0;r<20&&(i=this.sampleCurveX(e),!(Math.abs(i-t)<n));r++)t>i?o=e:a=e,e=.5*(a-o)+o;return e},solve:function(t,n){return this.sampleCurveY(this.solveCurveX(t,n))}};var ms=Object.freeze({__proto__:null,number:ys,color:function(t,n,e){return new yi(ys(t.r,n.r,e),ys(t.g,n.g,e),ys(t.b,n.b,e),ys(t.a,n.a,e))},array:function(t,n,e){return t.map((t,r)=>ys(t,n[r],e))}});const gs=6/29*3*(6/29),vs=Math.PI/180,bs=180/Math.PI;function ws(t){return t>.008856451679035631?Math.pow(t,1/3):t/gs+4/29}function Ms(t){return t>6/29?t*t*t:gs*(t-4/29)}function xs(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function Fs(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function As(t){const n=Fs(t.r),e=Fs(t.g),r=Fs(t.b),i=ws((.4124564*n+.3575761*e+.1804375*r)/.95047),s=ws((.2126729*n+.7151522*e+.072175*r)/1);return{l:116*s-16,a:500*(i-s),b:200*(s-ws((.0193339*n+.119192*e+.9503041*r)/1.08883)),alpha:t.a}}function ks(t){let n=(t.l+16)/116,e=isNaN(t.a)?n:n+t.a/500,r=isNaN(t.b)?n:n-t.b/200;return n=1*Ms(n),e=.95047*Ms(e),r=1.08883*Ms(r),new yi(xs(3.2404542*e-1.5371385*n-.4985314*r),xs(-.969266*e+1.8760108*n+.041556*r),xs(.0556434*e-.2040259*n+1.0572252*r),t.alpha)}function Ps(t,n,e){const r=n-t;return t+e*(r>180||r<-180?r-360*Math.round(r/360):r)}const Ss={forward:As,reverse:ks,interpolate:function(t,n,e){return{l:ys(t.l,n.l,e),a:ys(t.a,n.a,e),b:ys(t.b,n.b,e),alpha:ys(t.alpha,n.alpha,e)}}},_s={forward:function(t){const{l:n,a:e,b:r}=As(t),i=Math.atan2(r,e)*bs;return{h:i<0?i+360:i,c:Math.sqrt(e*e+r*r),l:n,alpha:t.a}},reverse:function(t){const n=t.h*vs,e=t.c;return ks({l:t.l,a:Math.cos(n)*e,b:Math.sin(n)*e,alpha:t.alpha})},interpolate:function(t,n,e){return{h:Ps(t.h,n.h,e),c:ys(t.c,n.c,e),l:ys(t.l,n.l,e),alpha:ys(t.alpha,n.alpha,e)}}};var Os=Object.freeze({__proto__:null,lab:Ss,hcl:_s});class Es{constructor(t,n,e,r,i){this.type=t,this.operator=n,this.interpolation=e,this.input=r,this.labels=[],this.outputs=[];for(const[t,n]of i)this.labels.push(t),this.outputs.push(n)}static interpolationFactor(t,n,e,r){let i=0;if("exponential"===t.name)i=Is(n,t.base,e,r);else if("linear"===t.name)i=Is(n,1,e,r);else if("cubic-bezier"===t.name){const s=t.controlPoints;i=new ds(s[0],s[1],s[2],s[3]).solve(Is(n,1,e,r))}return i}static parse(t,n){let[e,r,i,...s]=t;if(!Array.isArray(r)||0===r.length)return n.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){const t=r[1];if("number"!=typeof t)return n.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:t}}else{if("cubic-bezier"!==r[0])return n.error("Unknown interpolation type "+String(r[0]),1,0);{const t=r.slice(1);if(4!==t.length||t.some(t=>"number"!=typeof t||t<0||t>1))return n.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return n.error("Expected an even number of arguments.");if(i=n.parse(i,2,Br),!i)return null;const o=[];let a=null;"interpolate-hcl"===e||"interpolate-lab"===e?a=Yr:n.expectedType&&"value"!==n.expectedType.kind&&(a=n.expectedType);for(let t=0;t<s.length;t+=2){const e=s[t],r=s[t+1],i=t+3,u=t+4;if("number"!=typeof e)return n.error(\'Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.\',i);if(o.length&&o[o.length-1][0]>=e)return n.error(\'Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.\',i);const l=n.parse(r,u,a);if(!l)return null;a=a||l.type,o.push([e,l])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new Es(a,e,r,i,o):n.error(`Type ${ri(a)} is not interpolatable.`)}evaluate(t){const n=this.labels,e=this.outputs;if(1===n.length)return e[0].evaluate(t);const r=this.input.evaluate(t);if(r<=n[0])return e[0].evaluate(t);const i=n.length;if(r>=n[i-1])return e[i-1].evaluate(t);const s=hs(n,r),o=Es.interpolationFactor(this.interpolation,r,n[s],n[s+1]),a=e[s].evaluate(t),u=e[s+1].evaluate(t);return"interpolate"===this.operator?ms[this.type.kind.toLowerCase()](a,u,o):"interpolate-hcl"===this.operator?_s.reverse(_s.interpolate(_s.forward(a),_s.forward(u),o)):Ss.reverse(Ss.interpolate(Ss.forward(a),Ss.forward(u),o))}eachChild(t){t(this.input);for(const n of this.outputs)t(n)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const n=[this.operator,t,this.input.serialize()];for(let t=0;t<this.labels.length;t++)n.push(this.labels[t],this.outputs[t].serialize());return n}}function Is(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}var $s=Es;class Cs{constructor(t,n){this.type=t,this.args=n}static parse(t,n){if(t.length<2)return n.error("Expectected at least one argument.");let e=null;const r=n.expectedType;r&&"value"!==r.kind&&(e=r);const i=[];for(const r of t.slice(1)){const t=n.parse(r,1+i.length,e,void 0,{typeAnnotation:"omit"});if(!t)return null;e=e||t.type,i.push(t)}const s=r&&i.some(t=>si(r,t.type));return new Cs(s?Kr:e,i)}evaluate(t){let n,e=null,r=0;for(const i of this.args){if(r++,e=i.evaluate(t),e&&e instanceof bi&&!e.available&&(n||(n=e),e=null,r===this.args.length))return n;if(null!==e)break}return e}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Ts=Cs;class zs{constructor(t,n){this.type=n.type,this.bindings=[].concat(t),this.result=n}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const n of this.bindings)t(n[1]);t(this.result)}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const e=[];for(let r=1;r<t.length-1;r+=2){const i=t[r];if("string"!=typeof i)return n.error(`Expected string, but found ${typeof i} instead.`,r);if(/[^a-zA-Z0-9_]/.test(i))return n.error("Variable names must contain only alphanumeric characters or \'_\'.",r);const s=n.parse(t[r+1],r+1);if(!s)return null;e.push([i,s])}const r=n.parse(t[t.length-1],t.length-1,n.expectedType,e);return r?new zs(e,r):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[n,e]of this.bindings)t.push(n,e.serialize());return t.push(this.result.serialize()),t}}var Ds=zs;class js{constructor(t,n,e){this.type=t,this.index=n,this.input=e}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const e=n.parse(t[1],1,Br),r=n.parse(t[2],2,ei(n.expectedType||Kr));return e&&r?new js(r.type.itemType,e,r):null}evaluate(t){const n=this.index.evaluate(t),e=this.input.evaluate(t);if(n<0)throw new Pi(`Array index out of bounds: ${n} < 0.`);if(n>=e.length)throw new Pi(`Array index out of bounds: ${n} > ${e.length-1}.`);if(n!==Math.floor(n))throw new Pi(`Array index must be an integer, but found ${n} instead.`);return e[n]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var Us=js;class Ns{constructor(t,n){this.type=Xr,this.needle=t,this.haystack=n}static parse(t,n){if(3!==t.length)return n.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const e=n.parse(t[1],1,Kr),r=n.parse(t[2],2,Kr);return e&&r?oi(e.type,[Xr,Jr,Br,Gr,Kr])?new Ns(e,r):n.error(`Expected first argument to be of type boolean, string, number or null, but found ${ri(e.type)} instead`):null}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(null==e)return!1;if(!ai(n,["boolean","string","number","null"]))throw new Pi(`Expected first argument to be of type boolean, string, number or null, but found ${ri(xi(n))} instead.`);if(!ai(e,["string","array"]))throw new Pi(`Expected second argument to be of type array or string, but found ${ri(xi(e))} instead.`);return e.indexOf(n)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var Ls=Ns;class Vs{constructor(t,n,e){this.type=Br,this.needle=t,this.haystack=n,this.fromIndex=e}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const e=n.parse(t[1],1,Kr),r=n.parse(t[2],2,Kr);if(!e||!r)return null;if(!oi(e.type,[Xr,Jr,Br,Gr,Kr]))return n.error(`Expected first argument to be of type boolean, string, number or null, but found ${ri(e.type)} instead`);if(4===t.length){const i=n.parse(t[3],3,Br);return i?new Vs(e,r,i):null}return new Vs(e,r)}evaluate(t){const n=this.needle.evaluate(t),e=this.haystack.evaluate(t);if(!ai(n,["boolean","string","number","null"]))throw new Pi(`Expected first argument to be of type boolean, string, number or null, but found ${ri(xi(n))} instead.`);if(!ai(e,["string","array"]))throw new Pi(`Expected second argument to be of type array or string, but found ${ri(xi(e))} instead.`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return e.indexOf(n,r)}return e.indexOf(n)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var Rs=Vs;class Hs{constructor(t,n,e,r,i,s){this.inputType=t,this.type=n,this.input=e,this.cases=r,this.outputs=i,this.otherwise=s}static parse(t,n){if(t.length<5)return n.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return n.error("Expected an even number of arguments.");let e,r;n.expectedType&&"value"!==n.expectedType.kind&&(r=n.expectedType);const i={},s=[];for(let o=2;o<t.length-1;o+=2){let a=t[o];const u=t[o+1];Array.isArray(a)||(a=[a]);const l=n.concat(o);if(0===a.length)return l.error("Expected at least one branch label.");for(const t of a){if("number"!=typeof t&&"string"!=typeof t)return l.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return l.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return l.error("Numeric branch labels must be integer values.");if(e){if(l.checkSubtype(e,xi(t)))return null}else e=xi(t);if(void 0!==i[String(t)])return l.error("Branch labels must be unique.");i[String(t)]=s.length}const h=n.parse(u,o,r);if(!h)return null;r=r||h.type,s.push(h)}const o=n.parse(t[1],1,Kr);if(!o)return null;const a=n.parse(t[t.length-1],t.length-1,r);return a?"value"!==o.type.kind&&n.concat(1).checkSubtype(e,o.type)?null:new Hs(e,r,o,i,s,a):null}evaluate(t){const n=this.input.evaluate(t);return(xi(n)===this.inputType&&this.outputs[this.cases[n]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],n=Object.keys(this.cases).sort(),e=[],r={};for(const t of n){const n=r[this.cases[t]];void 0===n?(r[this.cases[t]]=e.length,e.push([this.cases[t],[t]])):e[n][1].push(t)}const i=t=>"number"===this.inputType.kind?Number(t):t;for(const[n,r]of e)t.push(1===r.length?i(r[0]):r.map(i)),t.push(this.outputs[n].serialize());return t.push(this.otherwise.serialize()),t}}var Ws=Hs;class qs{constructor(t,n,e){this.type=t,this.branches=n,this.otherwise=e}static parse(t,n){if(t.length<4)return n.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return n.error("Expected an odd number of arguments.");let e;n.expectedType&&"value"!==n.expectedType.kind&&(e=n.expectedType);const r=[];for(let i=1;i<t.length-1;i+=2){const s=n.parse(t[i],i,Xr);if(!s)return null;const o=n.parse(t[i+1],i+1,e);if(!o)return null;r.push([s,o]),e=e||o.type}const i=n.parse(t[t.length-1],t.length-1,e);return i?new qs(e,r,i):null}evaluate(t){for(const[n,e]of this.branches)if(n.evaluate(t))return e.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[n,e]of this.branches)t(n),t(e);t(this.otherwise)}outputDefined(){return this.branches.every(([t,n])=>n.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(n=>{t.push(n.serialize())}),t}}var Gs=qs;class Bs{constructor(t,n,e,r){this.type=t,this.input=n,this.beginIndex=e,this.endIndex=r}static parse(t,n){if(t.length<=2||t.length>=5)return n.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const e=n.parse(t[1],1,Kr),r=n.parse(t[2],2,Br);if(!e||!r)return null;if(!oi(e.type,[ei(Kr),Jr,Kr]))return n.error(`Expected first argument to be of type array or string, but found ${ri(e.type)} instead`);if(4===t.length){const i=n.parse(t[3],3,Br);return i?new Bs(e.type,e,r,i):null}return new Bs(e.type,e,r)}evaluate(t){const n=this.input.evaluate(t),e=this.beginIndex.evaluate(t);if(!ai(n,["string","array"]))throw new Pi(`Expected first argument to be of type array or string, but found ${ri(xi(n))} instead.`);if(this.endIndex){const r=this.endIndex.evaluate(t);return n.slice(e,r)}return n.slice(e)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var Js=Bs;function Xs(t,n){return"=="===t||"!="===t?"boolean"===n.kind||"string"===n.kind||"number"===n.kind||"null"===n.kind||"value"===n.kind:"string"===n.kind||"number"===n.kind||"value"===n.kind}function Ys(t,n,e,r){return 0===r.compare(n,e)}function Zs(t,n,e){const r="=="!==t&&"!="!==t;return class i{constructor(t,n,e){this.type=Xr,this.lhs=t,this.rhs=n,this.collator=e,this.hasUntypedArgument="value"===t.type.kind||"value"===n.type.kind}static parse(t,n){if(3!==t.length&&4!==t.length)return n.error("Expected two or three arguments.");const e=t[0];let s=n.parse(t[1],1,Kr);if(!s)return null;if(!Xs(e,s.type))return n.concat(1).error(`"${e}" comparisons are not supported for type \'${ri(s.type)}\'.`);let o=n.parse(t[2],2,Kr);if(!o)return null;if(!Xs(e,o.type))return n.concat(2).error(`"${e}" comparisons are not supported for type \'${ri(o.type)}\'.`);if(s.type.kind!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error(`Cannot compare types \'${ri(s.type)}\' and \'${ri(o.type)}\'.`);r&&("value"===s.type.kind&&"value"!==o.type.kind?s=new Oi(o.type,[s]):"value"!==s.type.kind&&"value"===o.type.kind&&(o=new Oi(s.type,[o])));let a=null;if(4===t.length){if("string"!==s.type.kind&&"string"!==o.type.kind&&"value"!==s.type.kind&&"value"!==o.type.kind)return n.error("Cannot use collator to compare non-string types.");if(a=n.parse(t[3],3,Qr),!a)return null}return new i(s,o,a)}evaluate(i){const s=this.lhs.evaluate(i),o=this.rhs.evaluate(i);if(r&&this.hasUntypedArgument){const n=xi(s),e=xi(o);if(n.kind!==e.kind||"string"!==n.kind&&"number"!==n.kind)throw new Pi(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${n.kind}, ${e.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const t=xi(s),e=xi(o);if("string"!==t.kind||"string"!==e.kind)return n(i,s,o)}return this.collator?e(i,s,o,this.collator.evaluate(i)):n(i,s,o)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const n=[t];return this.eachChild(t=>{n.push(t.serialize())}),n}}}const Ks=Zs("==",(function(t,n,e){return n===e}),Ys),Qs=Zs("!=",(function(t,n,e){return n!==e}),(function(t,n,e,r){return!Ys(0,n,e,r)})),to=Zs("<",(function(t,n,e){return n<e}),(function(t,n,e,r){return r.compare(n,e)<0})),no=Zs(">",(function(t,n,e){return n>e}),(function(t,n,e,r){return r.compare(n,e)>0})),eo=Zs("<=",(function(t,n,e){return n<=e}),(function(t,n,e,r){return r.compare(n,e)<=0})),ro=Zs(">=",(function(t,n,e){return n>=e}),(function(t,n,e,r){return r.compare(n,e)>=0}));class io{constructor(t,n,e,r,i,s){this.type=Jr,this.number=t,this.locale=n,this.currency=e,this.unit=r,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(t,n){if(3!==t.length)return n.error("Expected two arguments.");const e=n.parse(t[1],1,Br);if(!e)return null;const r=t[2];if("object"!=typeof r||Array.isArray(r))return n.error("NumberFormat options argument must be an object.");let i=null;if(r.locale&&(i=n.parse(r.locale,1,Jr),!i))return null;let s=null;if(r.currency&&(s=n.parse(r.currency,1,Jr),!s))return null;let o=null;if(r.unit&&(o=n.parse(r.unit,1,Jr),!o))return null;let a=null;if(r["min-fraction-digits"]&&(a=n.parse(r["min-fraction-digits"],1,Br),!a))return null;let u=null;return r["max-fraction-digits"]&&(u=n.parse(r["max-fraction-digits"],1,Br),!u)?null:new io(e,i,s,o,a,u)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class so{constructor(t){this.type=Br,this.input=t}static parse(t,n){if(2!==t.length)return n.error(`Expected 1 argument, but found ${t.length-1} instead.`);const e=n.parse(t[1],1);return e?"array"!==e.type.kind&&"string"!==e.type.kind&&"value"!==e.type.kind?n.error(`Expected argument of type string or array, but found ${ri(e.type)} instead.`):new so(e):null}evaluate(t){const n=this.input.evaluate(t);if("string"==typeof n)return n.length;if(Array.isArray(n))return n.length;throw new Pi(`Expected value to be of type string or array, but found ${ri(xi(n))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(n=>{t.push(n.serialize())}),t}}const oo={"==":Ks,"!=":Qs,">":no,"<":to,">=":ro,"<=":eo,array:Oi,at:Us,boolean:Oi,case:Gs,coalesce:Ts,collator:Ni,format:Ei,image:Ii,in:Ls,"index-of":Rs,interpolate:$s,"interpolate-hcl":$s,"interpolate-lab":$s,length:so,let:Ds,literal:ki,match:Ws,number:Oi,"number-format":io,object:Oi,slice:Js,step:fs,string:Oi,"to-boolean":Ti,"to-color":Ti,"to-number":Ti,"to-string":Ti,var:as,within:es};function ao(t,[n,e,r,i]){n=n.evaluate(t),e=e.evaluate(t),r=r.evaluate(t);const s=i?i.evaluate(t):1,o=wi(n,e,r,s);if(o)throw new Pi(o);return new yi(n/255*s,e/255*s,r/255*s,s)}function uo(t,n){return t in n}function lo(t,n){const e=n[t];return void 0===e?null:e}function ho(t){return{type:t}}Ui.register(oo,{error:[{kind:"error"},[Jr],(t,[n])=>{throw new Pi(n.evaluate(t))}],typeof:[Jr,[Kr],(t,[n])=>ri(xi(n.evaluate(t)))],"to-rgba":[ei(Br,4),[Yr],(t,[n])=>n.evaluate(t).toArray()],rgb:[Yr,[Br,Br,Br],ao],rgba:[Yr,[Br,Br,Br,Br],ao],has:{type:Xr,overloads:[[[Jr],(t,[n])=>uo(n.evaluate(t),t.properties())],[[Jr,Zr],(t,[n,e])=>uo(n.evaluate(t),e.evaluate(t))]]},get:{type:Kr,overloads:[[[Jr],(t,[n])=>lo(n.evaluate(t),t.properties())],[[Jr,Zr],(t,[n,e])=>lo(n.evaluate(t),e.evaluate(t))]]},"feature-state":[Kr,[Jr],(t,[n])=>lo(n.evaluate(t),t.featureState||{})],properties:[Zr,[],t=>t.properties()],"geometry-type":[Jr,[],t=>t.geometryType()],id:[Kr,[],t=>t.id()],zoom:[Br,[],t=>t.globals.zoom],pitch:[Br,[],t=>t.globals.pitch||0],"distance-from-center":[Br,[],t=>t.distanceFromCenter()],"heatmap-density":[Br,[],t=>t.globals.heatmapDensity||0],"line-progress":[Br,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[Br,[],t=>t.globals.skyRadialProgress||0],accumulated:[Kr,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[Br,ho(Br),(t,n)=>{let e=0;for(const r of n)e+=r.evaluate(t);return e}],"*":[Br,ho(Br),(t,n)=>{let e=1;for(const r of n)e*=r.evaluate(t);return e}],"-":{type:Br,overloads:[[[Br,Br],(t,[n,e])=>n.evaluate(t)-e.evaluate(t)],[[Br],(t,[n])=>-n.evaluate(t)]]},"/":[Br,[Br,Br],(t,[n,e])=>n.evaluate(t)/e.evaluate(t)],"%":[Br,[Br,Br],(t,[n,e])=>n.evaluate(t)%e.evaluate(t)],ln2:[Br,[],()=>Math.LN2],pi:[Br,[],()=>Math.PI],e:[Br,[],()=>Math.E],"^":[Br,[Br,Br],(t,[n,e])=>Math.pow(n.evaluate(t),e.evaluate(t))],sqrt:[Br,[Br],(t,[n])=>Math.sqrt(n.evaluate(t))],log10:[Br,[Br],(t,[n])=>Math.log(n.evaluate(t))/Math.LN10],ln:[Br,[Br],(t,[n])=>Math.log(n.evaluate(t))],log2:[Br,[Br],(t,[n])=>Math.log(n.evaluate(t))/Math.LN2],sin:[Br,[Br],(t,[n])=>Math.sin(n.evaluate(t))],cos:[Br,[Br],(t,[n])=>Math.cos(n.evaluate(t))],tan:[Br,[Br],(t,[n])=>Math.tan(n.evaluate(t))],asin:[Br,[Br],(t,[n])=>Math.asin(n.evaluate(t))],acos:[Br,[Br],(t,[n])=>Math.acos(n.evaluate(t))],atan:[Br,[Br],(t,[n])=>Math.atan(n.evaluate(t))],min:[Br,ho(Br),(t,n)=>Math.min(...n.map(n=>n.evaluate(t)))],max:[Br,ho(Br),(t,n)=>Math.max(...n.map(n=>n.evaluate(t)))],abs:[Br,[Br],(t,[n])=>Math.abs(n.evaluate(t))],round:[Br,[Br],(t,[n])=>{const e=n.evaluate(t);return e<0?-Math.round(-e):Math.round(e)}],floor:[Br,[Br],(t,[n])=>Math.floor(n.evaluate(t))],ceil:[Br,[Br],(t,[n])=>Math.ceil(n.evaluate(t))],"filter-==":[Xr,[Jr,Kr],(t,[n,e])=>t.properties()[n.value]===e.value],"filter-id-==":[Xr,[Kr],(t,[n])=>t.id()===n.value],"filter-type-==":[Xr,[Jr],(t,[n])=>t.geometryType()===n.value],"filter-<":[Xr,[Jr,Kr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<i}],"filter-id-<":[Xr,[Kr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<r}],"filter->":[Xr,[Jr,Kr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>i}],"filter-id->":[Xr,[Kr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>r}],"filter-<=":[Xr,[Jr,Kr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[Xr,[Kr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e<=r}],"filter->=":[Xr,[Jr,Kr],(t,[n,e])=>{const r=t.properties()[n.value],i=e.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[Xr,[Kr],(t,[n])=>{const e=t.id(),r=n.value;return typeof e==typeof r&&e>=r}],"filter-has":[Xr,[Kr],(t,[n])=>n.value in t.properties()],"filter-has-id":[Xr,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[Xr,[ei(Jr)],(t,[n])=>n.value.indexOf(t.geometryType())>=0],"filter-id-in":[Xr,[ei(Kr)],(t,[n])=>n.value.indexOf(t.id())>=0],"filter-in-small":[Xr,[Jr,ei(Kr)],(t,[n,e])=>e.value.indexOf(t.properties()[n.value])>=0],"filter-in-large":[Xr,[Jr,ei(Kr)],(t,[n,e])=>function(t,n,e,r){for(;e<=r;){const i=e+r>>1;if(n[i]===t)return!0;n[i]>t?r=i-1:e=i+1}return!1}(t.properties()[n.value],e.value,0,e.value.length-1)],all:{type:Xr,overloads:[[[Xr,Xr],(t,[n,e])=>n.evaluate(t)&&e.evaluate(t)],[ho(Xr),(t,n)=>{for(const e of n)if(!e.evaluate(t))return!1;return!0}]]},any:{type:Xr,overloads:[[[Xr,Xr],(t,[n,e])=>n.evaluate(t)||e.evaluate(t)],[ho(Xr),(t,n)=>{for(const e of n)if(e.evaluate(t))return!0;return!1}]]},"!":[Xr,[Xr],(t,[n])=>!n.evaluate(t)],"is-supported-script":[Xr,[Jr],(t,[n])=>{const e=t.globals&&t.globals.isSupportedScript;return!e||e(n.evaluate(t))}],upcase:[Jr,[Jr],(t,[n])=>n.evaluate(t).toUpperCase()],downcase:[Jr,[Jr],(t,[n])=>n.evaluate(t).toLowerCase()],concat:[Jr,ho(Kr),(t,n)=>n.map(n=>Fi(n.evaluate(t))).join("")],"resolved-locale":[Jr,[Qr],(t,[n])=>n.evaluate(t).resolvedLocale()]});var co=oo;function fo(t){return{result:"success",value:t}}function po(t){return{result:"error",value:t}}function yo(t){return!!t.expression&&t.expression.interpolated}function mo(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function go(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function vo(t){return t}function bo(t,n,e){return void 0!==t?t:void 0!==n?n:void 0!==e?e:void 0}function wo(t,n,e,r,i){return bo(typeof e===i?r[e]:void 0,t.default,n.default)}function Mo(t,n,e){if("number"!==mo(e))return bo(t.default,n.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[r-1][0])return t.stops[r-1][1];const i=hs(t.stops.map(t=>t[0]),e);return t.stops[i][1]}function xo(t,n,e){const r=void 0!==t.base?t.base:1;if("number"!==mo(e))return bo(t.default,n.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(e<=t.stops[0][0])return t.stops[0][1];if(e>=t.stops[i-1][0])return t.stops[i-1][1];const s=hs(t.stops.map(t=>t[0]),e),o=function(t,n,e,r){const i=r-e,s=t-e;return 0===i?0:1===n?s/i:(Math.pow(n,s)-1)/(Math.pow(n,i)-1)}(e,r,t.stops[s][0],t.stops[s+1][0]),a=t.stops[s][1],u=t.stops[s+1][1];let l=ms[n.type]||vo;if(t.colorSpace&&"rgb"!==t.colorSpace){const n=Os[t.colorSpace];l=(t,e)=>n.reverse(n.interpolate(n.forward(t),n.forward(e),o))}return"function"==typeof a.evaluate?{evaluate(...t){const n=a.evaluate.apply(void 0,t),e=u.evaluate.apply(void 0,t);if(void 0!==n&&void 0!==e)return l(n,e,o)}}:l(a,u,o)}function Fo(t,n,e){return"color"===n.type?e=yi.parse(e):"formatted"===n.type?e=vi.fromString(e.toString()):"resolvedImage"===n.type?e=bi.fromString(e.toString()):mo(e)===n.type||"enum"===n.type&&n.values[e]||(e=void 0),bo(e,t.default,n.default)}class Ao{constructor(t,n){this.expression=t,this.W={},this.q=new Di,this.G=n?function(t){return"color"===t.type&&(go(t.default)||Array.isArray(t.default))?new yi(0,0,0,0):"color"===t.type?yi.parse(t.default)||null:void 0===t.default?null:t.default}(n):null,this.B=n&&"enum"===n.type?n.values:null}evaluateWithoutErrorHandling(t,n,e,r,i,s,o,a){return this.q.globals=t,this.q.feature=n,this.q.featureState=e,this.q.canonical=r||null,this.q.availableImages=i||null,this.q.formattedSection=s,this.q.featureTileCoord=o||null,this.q.featureDistanceData=a||null,this.expression.evaluate(this.q)}evaluate(t,n,e,r,i,s,o,a){this.q.globals=t,this.q.feature=n||null,this.q.featureState=e||null,this.q.canonical=r||null,this.q.availableImages=i||null,this.q.formattedSection=s||null,this.q.featureTileCoord=o||null,this.q.featureDistanceData=a||null;try{const t=this.expression.evaluate(this.q);if(null==t||"number"==typeof t&&t!=t)return this.G;if(this.B&&!(t in this.B))throw new Pi(`Expected value to be one of ${Object.keys(this.B).map(t=>JSON.stringify(t)).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(t){return this.W[t.message]||(this.W[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this.G}}}function ko(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in co}function Po(t,n){const e=new ls(co,[],n?function(t){const n={color:Yr,string:Jr,number:Br,enum:Jr,boolean:Xr,formatted:ti,resolvedImage:ni};return"array"===t.type?ei(n[t.value]||Kr,t.length):n[t.type]}(n):void 0),r=e.parse(t,void 0,void 0,void 0,n&&"string"===n.type?{typeAnnotation:"coerce"}:void 0);return r?fo(new Ao(r,n)):po(e.errors)}class So{constructor(t,n){this.kind=t,this.J=n,this.isStateDependent="constant"!==t&&!is(n.expression)}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.J.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.J.evaluate(t,n,e,r,i,s)}}class _o{constructor(t,n,e,r){this.kind=t,this.zoomStops=e,this.J=n,this.isStateDependent="camera"!==t&&!is(n.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,n,e,r,i,s){return this.J.evaluateWithoutErrorHandling(t,n,e,r,i,s)}evaluate(t,n,e,r,i,s){return this.J.evaluate(t,n,e,r,i,s)}interpolationFactor(t,n,e){return this.interpolationType?$s.interpolationFactor(this.interpolationType,t,n,e):0}}function Oo(t,n){if("error"===(t=Po(t,n)).result)return t;const e=t.value.expression,r=rs(e);if(!r&&!function(t){return"data-driven"===t["property-type"]}(n))return po([new Hr("","data expressions not supported")]);const i=ss(e,["zoom","pitch","distance-from-center"]);if(!i&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(n))return po([new Hr("","zoom expressions not supported")]);const s=function t(n){let e=null;if(n instanceof Ds)e=t(n.result);else if(n instanceof Ts){for(const r of n.args)if(e=t(r),e)break}else(n instanceof fs||n instanceof $s)&&n.input instanceof Ui&&"zoom"===n.input.name&&(e=n);return e instanceof Hr||n.eachChild(n=>{const r=t(n);r instanceof Hr?e=r:!e&&r?e=new Hr("",\'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.\'):e&&r&&e!==r&&(e=new Hr("",\'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.\'))}),e}(e);if(!s&&!i)return po([new Hr("",\'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.\')]);if(s instanceof Hr)return po([s]);if(s instanceof $s&&!yo(n))return po([new Hr("",\'"interpolate" expressions cannot be used with this property\')]);if(!s)return fo(new So(r?"constant":"source",t.value));const o=s instanceof $s?s.interpolation:void 0;return fo(new _o(r?"camera":"composite",t.value,s.labels,o))}class Eo{constructor(t,n){this.X=t,this.Y=n,Vr(this,function t(n,e){const r="color"===e.type,i=n.stops&&"object"==typeof n.stops[0][0],s=i||!(i||void 0!==n.property),o=n.type||(yo(e)?"exponential":"interval");if(r&&((n=Vr({},n)).stops&&(n.stops=n.stops.map(t=>[t[0],yi.parse(t[1])])),n.default=yi.parse(n.default?n.default:e.default)),n.colorSpace&&"rgb"!==n.colorSpace&&!Os[n.colorSpace])throw new Error("Unknown color space: "+n.colorSpace);let a,u,l;if("exponential"===o)a=xo;else if("interval"===o)a=Mo;else if("categorical"===o){a=wo,u=Object.create(null);for(const t of n.stops)u[t[0]]=t[1];l=typeof n.stops[0][0]}else{if("identity"!==o)throw new Error(`Unknown function type "${o}"`);a=Fo}if(i){const r={},i=[];for(let t=0;t<n.stops.length;t++){const e=n.stops[t],s=e[0].zoom;void 0===r[s]&&(r[s]={zoom:s,type:n.type,property:n.property,default:n.default,stops:[]},i.push(s)),r[s].stops.push([e[0].value,e[1]])}const s=[];for(const n of i)s.push([r[n].zoom,t(r[n],e)]);const o={name:"linear"};return{kind:"composite",interpolationType:o,interpolationFactor:$s.interpolationFactor.bind(void 0,o),zoomStops:s.map(t=>t[0]),evaluate:({zoom:t},r)=>xo({stops:s,base:n.base},e,t).evaluate(t,r)}}if(s){const t="exponential"===o?{name:"exponential",base:void 0!==n.base?n.base:1}:null;return{kind:"camera",interpolationType:t,interpolationFactor:$s.interpolationFactor.bind(void 0,t),zoomStops:n.stops.map(t=>t[0]),evaluate:({zoom:t})=>a(n,e,t,u,l)}}return{kind:"source",evaluate(t,r){const i=r&&r.properties?r.properties[n.property]:void 0;return void 0===i?bo(n.default,e.default):a(n,e,i,u,l)}}}(this.X,this.Y))}static deserialize(t){return new Eo(t.X,t.Y)}static serialize(t){return{X:t.X,Y:t.Y}}}function Io(t){if(Array.isArray(t))return t.map(Io);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const n={};for(const e in t)n[e]=Io(t[e]);return n}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(t)}function $o(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let n=1;n<t.length;n++)if($o(t[n]))return!0;return!1}const Co=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]),To={StyleExpression:Ao,isExpression:ko,isExpressionFilter:function t(n){if(!0===n||!1===n)return!0;if(!Array.isArray(n)||0===n.length)return!1;switch(n[0]){case"has":return n.length>=2&&"$id"!==n[1]&&"$type"!==n[1];case"in":return n.length>=3&&("string"!=typeof n[1]||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==n.length||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!t(e)&&"boolean"!=typeof e)return!1;return!0;default:return!0}},createExpression:Po,createPropertyExpression:Oo,normalizePropertyExpression:function(t,n){if(go(t))return new Eo(t,n);if(ko(t)){const e=Oo(t,n);if("error"===e.result)throw new Error(e.value.map(t=>`${t.key}: ${t.message}`).join(", "));return e.value}{let e=t;return"string"==typeof t&&"color"===n.type&&(e=yi.parse(t)),{kind:"constant",evaluate:()=>e}}},ZoomConstantExpression:So,ZoomDependentExpression:_o,StylePropertyFunction:Eo},{isExpression:zo,createExpression:Do}=To,jo={};function Uo(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const n=t.condition,e=[];for(let t=0;t<n.length;t++)e.push(Uo(n[t]));return(t,n)=>{for(let r=0;r<e.length;r++)if(e[r](t,n))return!0;return!1}}const n=Uo(t.condition);if(gr(t.layer))return n;const e=n=>n.layer===t.layer;return(t,r)=>e(t)&&n(t,r)}if(function t(n){if(!0===n||!1===n)return!0;if(!Array.isArray(n)||0===n.length)return!1;switch(n[0]){case"has":case"!has":return 2===n.length&&("string"==typeof n[1]||n[1].property&&n[1].op);case"in":case"!in":return n.length>=2&&("string"==typeof n[1]||n[1].property&&n[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===n.length&&("string"==typeof n[1]||n[1].property&&n[1].op);case"none":case"any":case"all":for(const e of n.slice(1))if(!t(e)&&"boolean"!=typeof e)return!1;return!0;case"contains":return!0;default:return!1}}(t))return zn(t);{let n=function(t,n="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const e=t;let r=!0;try{r=function(t){if(!$o(t))return t;let n=Io(t);return function t(n){let e=!1;const r=[];if("case"===n[0]){for(let t=1;t<n.length-1;t+=2)e=e||$o(n[t]),r.push(n[t+1]);r.push(n[n.length-1])}else if("match"===n[0]){e=e||$o(n[1]);for(let t=2;t<n.length-1;t+=2)r.push(n[t+1]);r.push(n[n.length-1])}else if("step"===n[0]){e=e||$o(n[1]);for(let t=1;t<n.length-1;t+=2)r.push(n[t+1])}e&&(n.length=0,n.push("any",...r));for(let e=1;e<n.length;e++)t(n[e])}(n),n=function t(n){if(!Array.isArray(n))return n;const e=function(t){if(Co.has(t[0]))for(let n=1;n<t.length;n++)if($o(t[n]))return!0;return t}(n);return!0===e?e:e.map(n=>t(n))}(n),n}(e)}catch(t){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\\nand paste the contents of this message in the report.\\nThank you!\\nFilter Expression:\\n${JSON.stringify(e,null,2)}\\n        `)}const i=Po(r,null);let s=null;if("error"===i.result)throw new Error(i.value.map(t=>`${t.key}: ${t.message}`).join(", "));s=(t,n,e)=>i.value.evaluate(t,n,{},e);let o=null,a=null;if(r!==e){const t=Po(e,null);if("error"===t.result)throw new Error(t.value.map(t=>`${t.key}: ${t.message}`).join(", "));o=(n,e,r,i,s)=>t.value.evaluate(n,e,{},r,void 0,void 0,i,s),a=!rs(t.value.expression)}return s=s,{filter:s,dynamicFilter:o||void 0,needGeometry:function t(n){if(!Array.isArray(n))return!1;if("within"===n[0])return!0;for(let e=1;e<n.length;e++)if(t(n[e]))return!0;return!1}(r),needFeature:!!a}}(t);return n=n&&n.filter,(t,e)=>(jo.zoom=e,n&&n(jo,t))}}const No={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function Lo(t,n){No.type=n||"number";const e=Do(t,No);if("success"!==e.result)throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(t)} (${e.value})`);return e.value}function Vo(t){return zo(t)}const Ro={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function Ho(t){return Ro[t]}const Wo={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},qo={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function Go(t){return Wo[t]?"string":Ho(t)?"number":qo[t]?"array":"color"}var Bo=Object.freeze({__proto__:null,compileStyle:function(t=[]){return function t(n){if(!Array.isArray(n))return t([n]);const e=[];for(let t=0;t<n.length;t++){let r;r=!0===n[t].filter?function(){return!0}:Uo(n[t].filter),e.push(mr({},n[t],{filter:r}))}return e}(t=t.map(t=>{const n=mr({},t);return n.filter&&n.filter.value&&(n.filter=n.filter.value),n}))},compileFilter:Uo,createExpression:Lo,isExpression:Vo,isInterpolated:Ho,getExpressionType:Go});const Jo="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;class Xo extends Array{pushIn(...t){const n=t.length;for(let e=0;e<n;e++)this[this.Z++]=t[e]}fill(t,n,e){super.fill(t,n,e),e>this.Z&&(this.Z=e)}set(t,n){t>=this.Z&&(this.Z=t+1),this[t]=n}getLength(){return this.Z}setLength(t){this.Z=t,super.length<t&&(super.length=t)}trySetLength(t){t>this.Z&&this.setLength(t)}reset(){this.Z=0}}const Yo={get:function(t,n){return"length"===n?t.getLength():t[n]}};class Zo extends Array{setLength(t){super.length=t}trySetLength(t){super.length=t}getLength(){return super.length}}let Ko;class Qo{static createTypedArray(t,n){return pr(t,n)}static getInstance(){return Ko}static getArray(){const t=new Xo,n=new Proxy(t,Yo);return n.push=(...n)=>{t.pushIn(...n)},n.U=t,n}constructor(){this.K=[],this.Z=0}get(){if(!Jo)return new Zo;const t=this.K[this.Z]=this.K[this.Z]||Qo.getArray();return t.reset(),this.Z++,t}reset(){this.Z=0}}Ko=new Qo;const ta=[],na={},ea={},ra={},ia=[],sa=Qo.getInstance(),oa=Math.pow(2,17);class aa{static isAtlasLoaded(t,n={}){const{iconAtlas:e}=n;return!!(!t||e&&e.positions[t])}static genFnTypes(t){const n={};for(const e in t)if(Vo(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim(),s=Go(e);n[r]=Lo(t[e],s),n[i]=(t,e)=>{let i;na.zoom=t,ea.properties=e;try{i=n[r].evaluateWithoutErrorHandling(na,ea,ra,null,ia)}catch(t){return null}return i}}else if(kr(t[e])){const r=(e+"_Fn_0").trim(),i=(e+"Fn").trim();Ho(e)?(n[r]=p(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return kr(i)?p(i)(t,e):i}):(n[r]=y(t[e]),n[i]=(t,e)=>{const i=n[r](t,e);return kr(i)?y(i)(t,e):i})}return n}constructor(t,n,e){this.options=e;const r=[];this.symbolDef=n,this.symbol=m(n,()=>(r[0]=e.zoom,r)),this.styledVectors=[],this.properties={},this.tt=e.fnTypes||aa.genFnTypes(this.symbolDef),kr(this.symbolDef.visible)&&(this.nt=p(this.symbolDef.visible)),e.atlas&&(this.iconAtlas=e.atlas.iconAtlas,this.glyphAtlas=e.atlas.glyphAtlas),this.features=this.et(t)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=oa||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Int16Array,width:3,name:"aPosition"}]}fillPosition(t,n,e,r){n<this.rt&&(this.rt=n),n>this.it&&(this.it=n),e<this.st&&(this.st=e),e>this.ot&&(this.ot=e),this.needAltitudeAttribute()?(t.aPosition.push(n,e),t.aAltitude.push(r)):(Tr(ta,n,e,r),t.aPosition.push(ta[0],ta[1],ta[2]))}et(t){if(!t.length)return t;const n="__fea_idx".trim();let e,r=0,i=t[r];for(;!i.geometry;)r++,i=t[r];if(Array.isArray(i.geometry)&&i.properties){let n=i.geometry[0];for(;Array.isArray(n);)n=n[0];n instanceof Ut&&(e=t)}if(!e)if(e=[],Array.isArray(i.geometry))for(let n=0;n<t.length;n++){const r=mr({},t[n]);e.push(yr(r))}else for(let r=0;r<t.length;r++){const i=t[r],s=Ve(i);for(let t=0;t<s.length;t++){const r=s[t];r[n]=i[n],e.push(r)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let n=0,r=!1;const{textPitchAlignmentFn:i}=this.tt;!i&&t&&"map"===this.symbolDef.textPitchAlignment&&(r=!0);for(let s=0;s<e.length;s++){const o=la(e[s]&&e[s].geometry);if(o>n&&(n=o),t&&!r&&i&&e[s].properties){const t=i(null,e[s].properties);"map"===t&&(r=t)}}this.hasMapPitchAlign=r,this.maxPosZ=n}const s=this.options.order;if(s){const t=[];for(let n=0;n<s.length;n++)s[n]&&t.push(Uo(s[n]));e=e.sort((n,e)=>{const r=t.length;let i=-1,s=-1;for(let o=0;o<r&&(t[o](n)&&(i=o),t[o](e)&&(s=o),!(i>=0&&i<r&&s>=0&&s<r));o++);return i-s})}return e}load(t=1){const n="__fea_idx".trim(),e="_debug_info".trim(),r=this.tt,i=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const o={},a={},u={zoom:this.options.zoom,isVector3D:!!this.options.center},l=[],h=m(this.symbolDef,()=>(l[0]=u.zoom,l));let c=0,f=s.length;const d=this.options.debugIndex;try{for(;c<f;c++){const t=s[c];if(!t||!t.geometry)continue;if(vr(d)&&t[e].index!==d)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const l=this.createStyledVector(t,h,r,u,o,a);l&&l.feature.geometry&&(l.featureIdx=void 0===t[n]?c:t[n],this.count++,i.push(l))}}catch(t){return Promise.reject(t)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(o,a).then(()=>this.pack(t))}loadAtlas(t,n){return new Promise((e,r)=>{this.fetchAtlas(t,n,(t,n)=>{if(t)r(t);else{if(n){const{icons:t,glyphs:e}=n;if(t&&Object.keys(t).length){for(const n in t){const e=t[n],{width:r,height:i,data:s}=e.data;e.data=new Ze({width:r,height:i},s)}this.iconAtlas=new ur(t)}if(e&&Object.keys(e).length){for(const t in e){const n=e[t];for(const t in n){const e=n[t],{width:r,height:i,data:s}=e.bitmap;e.bitmap=new Ye({width:r,height:i},s)}}this.glyphAtlas=new hr(e)}}e({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}})})}fetchAtlas(t,n,e){Object.keys(t).length>0||Object.keys(n).length>0?this.options.requestor(t,n,e):e()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const n=this.createDataPack(this.styledVectors,t);if(!n)return null;n.properties=this.properties,this.empty&&(n.empty=!0);const e=n.buffers;delete n.buffers;const r={data:n,buffers:e};if(this.iconAtlas){const t=r.data.iconAtlas=ua(this.iconAtlas);if(t.glyphMap)for(const n in t.glyphMap)e.push(t.glyphMap[n].data.data.buffer);e.push(r.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(r.data.glyphAtlas=ua(this.glyphAtlas),e.push(r.data.glyphAtlas.image.data.buffer)),r}createStyledVector(t,n,e,r){return new Cr(t,n,e,r)}createDataPack(t,n){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this.rt=this.st=1/0,this.it=this.ot=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const e=this.data={};this.ut=sa,sa.reset();let r=this.elements=sa.get();const i=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let t=0;t<i.length;t++)e[i[t].name]=sa.get();let o=sa.get(),a=0;const u=sa.get();let l=0,h=!1,c=!0;const f=new Set;for(let r=0,i=t.length;r<i;r++){if(!t[r].feature.geometry)continue;const i=Array.isArray(t[r])?t[r][0].feature.id:t[r].feature.id;c&&(void 0!==ea.id?f&&(f.has(ea.id)?c=!1:f.add(ea.id)):c=!1),vr(i)&&(Math.abs(i)>l&&(l=Math.abs(i)),i<0&&(h=!0));const d=this.data.aPosition.length;if(Array.isArray(t[r]))for(let e=0;e<t[r].length;e++)this.lt(t[r][e],n);else this.lt(t[r],n);const p=(e.aPosition.length-d)/s;for(let n=0;n<p;n++)o.push(t[r].featureIdx),vr(i)&&u.push(i);a=Math.max(a,t[r].featureIdx)}if(this.countOutOfAngle>0&&console.warn("text anchor along line is ignored as anchor\'s line angle is bigger than textMaxAngle."),this.hasElements()&&!r.length)return null;const d=this.options.center?Float32Array:dr(a);o=Qo.createTypedArray(o,d),i[0].type=this.options.positionType?this.options.positionType:fr(this.maxPos);const p=this.options.center;if(p&&(p[0]||p[1])){const t=e.aPosition;for(let n=0;n<t.length;n+=s)t[n]-=p[0],t[n+1]-=p[1]}const y=function(t,n){const e={};for(let r=0;r<t.length;r++){const i=t[r],s=i.type,o=i.name;e[o]=s===Array?n[o]:pr(n[o],s)}return e}(i,e);y.aPickingId=o;const m=[];for(const t in y)m.push(y[t].buffer);const g=cr(this.maxIndex);r=Qo.createTypedArray(r,g),m.push(r.buffer);const v={data:y,isIdUnique:c,is2D:0===this.maxPosZ,indices:this.hasElements()?r:null,positionSize:s,positionBounding:[this.rt,this.st,this.it,this.ot],buffers:m,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this.ht&&(v.markerPlacement=this.ht),this.ct&&(v.textPlacement=this.ct),u.length){const t=h?fr(l):dr(l);v.featureIds=Qo.createTypedArray(u,t),m.push(v.featureIds.buffer)}else v.featureIds=[];return v.pickingIdIndiceMap=sr(o,v.indices),v}lt(t,n){this.nt&&!this.nt(this.options.zoom,t.feature.properties)||this.placeVector(t,n,this.formatWidth)}addElements(...t){this.maxIndex=Math.max(this.maxIndex,...t),this.elements.push(...t)}hasElements(){return!0}getAltitude(t){const{altitudeProperty:n,defaultAltitude:e,altitudeScale:r}=this.options;let i=tr(t,n,e);return r&&(i*=r),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(i)),i}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let n=0;for(const e in t)if(Fr(t,e)){const{tl:r,displaySize:i}=t[e],s=Math.max(r[0],r[1],i[0]-1,i[1]-1);s>n&&(n=s)}return n}}function ua(t){let n=t.positions,e=t.image&&t.image.format||"alpha";if(t instanceof ur){n={};for(const e in t.positions){const r=t.positions[e];n[e]={paddedRect:r.paddedRect,pixelRatio:r.pixelRatio,tl:r.tl,br:r.br,displaySize:r.displaySize}}e="rgba"}const r=t.image;return{image:{width:r.width,height:r.height,data:r.data,format:e},glyphMap:t.glyphMap,positions:n}}function la(t){if(!t)return 0;let n=0;if(Array.isArray(t))for(let e=0;e<t.length;e++)if(Array.isArray(t[e])){const r=la(t[e]);r>n&&(n=r)}else{const r=Math.abs(t[e].z||0);r>n&&(n=r)}else{const e=Math.abs(t.z||0);e>n&&(n=e)}return n}function ha(t,n,e,r){const i="__fn_textSize".trim();let s=t.textSize;if(gr(n.textSize))return[16,16];t[i]&&(s=t[i]);const o=[];if(o[0]=Mr(s)?s(r,e):s,d(o[0])){const n=o[0].ft=o[0].ft||JSON.stringify(o[0]);t.dt||(t.dt={}),t.dt[n]||(t.dt[n]=p(o[0])),o[0]=(0,t.dt[n])(r,e)}return o[1]=o[0],o}function ca(t){const n=t.stops;let e=-1/0;for(let t=0;t<n.length;t++){let r=n[t][1];br(n[t][1])&&(r=ca(n[t][1])),r>e&&(e=r)}return e}function fa(t,n,e){return[n||"normal",e||"normal","24px",t||"Open Sans Regular"].join(" ")}const da=/\\{[\\w-]+(?:\\|[\\w-]+)*\\}/g;function pa(t,n){return wr(t)?t.replace(da,(function(t){if(!n)return"";if((t=t.substring(1,t.length-1)).indexOf("|")>0){const e=t.split("|");for(let t=0;t<e.length;t++){const r=n[e[t]];if(!gr(r))return r}return""}const e=n[t];return gr(e)?"":Array.isArray(e)?e.join():e})):t}var ya=Object.freeze({__proto__:null,getSDFFont:fa,resolveText:pa,resolveVarNames:function(t){return t.match(da)},resolveExpVarNames:function t(n,e){if(2!==e.length||"get"!==e[0])for(let r=0;r<e.length;r++)2===e[r].length&&"get"===e[r][0]?n.push(e[r][1]):Array.isArray(e[r])&&t(n,e[r]);else n.push(e[1])}});const ma=t=>t>=11904&&t<=12031,ga=t=>t>=12032&&t<=12255,va=t=>t>=12272&&t<=12287,ba=t=>t>=12288&&t<=12351,wa=t=>t>=12352&&t<=12447,Ma=t=>t>=12448&&t<=12543,xa=t=>t>=12544&&t<=12591,Fa=t=>t>=12704&&t<=12735,Aa=t=>t>=12736&&t<=12783,ka=t=>t>=12784&&t<=12799,Pa=t=>t>=12800&&t<=13055,Sa=t=>t>=13056&&t<=13311,_a=t=>t>=13312&&t<=19903,Oa=t=>t>=19968&&t<=40959,Ea=t=>t>=40960&&t<=42127,Ia=t=>t>=42128&&t<=42191,$a=t=>t>=63744&&t<=64255,Ca=t=>t>=64336&&t<=65023,Ta=t=>t>=65040&&t<=65055,za=t=>t>=65072&&t<=65103,Da=t=>t>=65104&&t<=65135,ja=t=>t>=65136&&t<=65279,Ua=t=>t>=65280&&t<=65519;function Na(t){return!((t=>t>=1536&&t<=1791)(t)||(t=>t>=1872&&t<=1919)(t)||(t=>t>=2208&&t<=2303)(t)||Ca(t)||ja(t))}function La(t){return!!(746===t||747===t||!(t<4352)&&(Fa(t)||xa(t)||za(t)&&!(t>=65097&&t<=65103)||$a(t)||Sa(t)||ma(t)||Aa(t)||!(!ba(t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||_a(t)||Oa(t)||Pa(t)||(t=>t>=12592&&t<=12687)(t)||(t=>t>=43360&&t<=43391)(t)||(t=>t>=55216&&t<=55295)(t)||(t=>t>=4352&&t<=4607)(t)||(t=>t>=44032&&t<=55215)(t)||wa(t)||va(t)||(t=>t>=12688&&t<=12703)(t)||ga(t)||ka(t)||Ma(t)&&12540!==t||!(!Ua(t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!Da(t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||(t=>t>=5120&&t<=5759)(t)||(t=>t>=6320&&t<=6399)(t)||Ta(t)||(t=>t>=19904&&t<=19967)(t)||Ea(t)||Ia(t)))}function Va(t){return!(La(t)||function(t){return!!((t=>t>=128&&t<=255)(t)&&(167===t||169===t||174===t||177===t||188===t||189===t||190===t||215===t||247===t)||(t=>t>=8192&&t<=8303)(t)&&(8214===t||8224===t||8225===t||8240===t||8241===t||8251===t||8252===t||8258===t||8263===t||8264===t||8265===t||8273===t)||(t=>t>=8448&&t<=8527)(t)||(t=>t>=8528&&t<=8591)(t)||(t=>t>=8960&&t<=9215)(t)&&(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215)||(t=>t>=9216&&t<=9279)(t)&&9251!==t||(t=>t>=9280&&t<=9311)(t)||(t=>t>=9312&&t<=9471)(t)||(t=>t>=9632&&t<=9727)(t)||(t=>t>=9728&&t<=9983)(t)&&!(t>=9754&&t<=9759)||(t=>t>=11008&&t<=11263)(t)&&(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243)||ba(t)||Ma(t)||(t=>t>=57344&&t<=63743)(t)||za(t)||Da(t)||Ua(t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t)}(t))}function Ra(t){return t>=1424&&t<=2303||Ca(t)||ja(t)}const Ha=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function Wa(t){for(const n of Ha)if(t>=n[0]&&t<=n[1])return!0;return!1}const qa={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\\\":"","]":"","^":"",pt:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};function Ga(t,n,e,r,i,s,o,a,u,l){let h=t.trim();2===l&&(h=function(t){let n="";const e=Array.from(t);for(let t=0;t<e.length;t++){const r=e[t+1].codePointAt(0)||null,i=e[t-1].codePointAt(0)||null;n+=r&&Va(r)&&!qa[e[t+1]]||i&&Va(i)&&!qa[e[t-1]]||!qa[e[t]]?e[t]:qa[e[t]]}return n}(h));const c=[],f={positionedGlyphs:c,text:h,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:l};let d;return d=function(t,n){const e=[];let r=0;for(let i=0;i<n.length;i++){const s=n[i];e.push(t.substring(r,s)),r=s}return r<t.length&&e.push(t.substring(r,t.length)),e}(h,function(t,n,e,r){if(!e)return[];if(!t)return[];const i=[],s=function(t,n,e,r){let i=0;for(let e=0;e<t.length;e++){const s=r[t.codePointAt(e)];s&&(i+=s.metrics.advance+n)}return i/Math.max(1,Math.ceil(i/e))}(t,n,e,r);let o=0;for(let e=0;e<t.length;e++){const u=t.codePointAt(e),l=r[u];l&&(l&&!Ba[u]&&(o+=l.metrics.advance+n),e<t.length-1&&(Ja[u]||!((a=u)<11904)&&(Fa(a)||xa(a)||za(a)||$a(a)||Sa(a)||ma(a)||Aa(a)||ba(a)||_a(a)||Oa(a)||Pa(a)||Ua(a)||wa(a)||va(a)||ga(a)||ka(a)||Ma(a)||Ta(a)||Ia(a)||Ea(a)))&&i.push(Za(e+1,o,s,i,Ya(u,t.codePointAt(e+1)),!1)))}var a;return function t(n){return n?t(n.priorBreak).concat(n.index):[]}(Za(t.length,o,s,i,0,!0))}(h,o,e,n)),function(t,n,e,r,i,s,o,a,u,l){let h=0,c=0,f=0;const d=t.positionedGlyphs,p="right"===s?1:"left"===s?0:.5;for(let t=0;t<e.length;t++){let i=e[t];if(i=i.trim(),!i.length){c-=r;continue}const s=d.length;for(let t=0;t<i.length;t++){const e=i.codePointAt(t),r=n[e];r&&(La(e)&&1!==o?(32!==e&&d.push({glyph:e,x:h,y:0,vertical:!0}),h+=u+a):(32!==e&&d.push({glyph:e,x:h,y:c,vertical:!1}),h+=r.metrics.advance+a))}d.length!==s&&(f=Math.max(h-a,f),Qa(d,n,s,d.length-1,p)),h=0,c-=r}const{horizontalAlign:y,verticalAlign:m}=Ka(i,void 0);!function(t,n,e,r,i,s,o){const a=(n-e)*i,u=-(-r*o+.5)*s;if(a||u)for(let n=0;n<t.length;n++)t[n].x+=a,t[n].y+=u}(d,p,y,m,f,r,e.length);const g=e.length*r;t.top+=-m*g,t.bottom=t.top+g,t.left+=-y*f,t.right=t.left+f}(f,n,d,r,i,s,l,o,u),!!c.length&&f}const Ba={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Ja={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Xa(t,n,e,r){const i=Math.pow(t-n,2);return r?t<n?i/2:2*i:i+Math.abs(e)*e}function Ya(t,n){let e=0;return 10===t&&(e-=1e4),40!==t&&65288!==t||(e+=50),41!==n&&65289!==n||(e+=50),e}function Za(t,n,e,r,i,s){let o=null,a=Xa(n,e,i,s);for(let t=0;t<r.length;t++){const u=r[t],l=Xa(n-u.x,e,i,s)+u.badness;l<=a&&(o=u,a=l)}return{index:t,x:n,priorBreak:o,badness:a}}function Ka(t,n){let e=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":e=n?1:0;break;case"left":case"top-left":case"bottom-left":e=n?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=n?1:0;break;case"top":case"top-right":case"top-left":r=n?0:1}return{horizontalAlign:e,verticalAlign:r}}function Qa(t,n,e,r,i){if(!i)return;const s=n[t[r].glyph];if(s){const n=(t[r].x+s.metrics.advance)*i;if(!n)return;for(let i=e;i<=r;i++)t[i].x-=n}}function tu(t){if(!function(t){for(const n of t)if(Ra(n.charCodeAt(0)))return!0;return!1}(t))return t;const n=[],e=[],r=[];let i=0,s=0,o=1,a=1;for(const u of t){const t=u.codePointAt(0);Wa(t)?(r.push(u),i++):(o=Ra(t)?-1:1,a!==o?(s=i,e.length&&(a>0&&e.reverse(),n.push(...e)),r.length&&(n.splice(s,0,...r),r.length=0),a=o,e.length=0):r.length&&(e.push(...r),r.length=0),e.push(u),i++)}return r.length&&e.push(...r),e.length&&(a>0&&e.reverse(),n.push(...e)),n.reverse().join("")}const nu=/\\{ *([\\w_]+) *\\}/g;class eu{constructor(t,n,e,r,i){this.feature=t,this.symbolDef=n,this.symbol=e,this.options=i,this.yt=this.gt.bind(this),this.tt=r}gt(t,n){return this.feature.properties[n]||""}getShape(t,n){if(this.vt)return this.vt;const{textHorizontalAlignmentFn:e,textVerticalAlignmentFn:r,markerHorizontalAlignmentFn:i,markerVerticalAlignmentFn:s,textWrapWidthFn:o}=this.tt;let a;const u=this.symbol,l=this.getIconAndGlyph(),h=this.feature.properties;if(l&&l.glyph){const{font:t,text:i}=l.glyph;if(""===i)return null;const s=this.size[0]/24,c=24,f=u.textKeepUpright,d="map"===u.textRotationAlignment&&"line"===u.textPlacement&&!u.isIconText,p=n.glyphMap[t],y=ru(e?e(null,h):u.textHorizontalAlignment,r?r(null,h):u.textVerticalAlignment),m=1.2*c,g=function(t){for(let n=0;n<t.length;n++)if(!Na(t.charAt(n).charCodeAt(0)))return!1;return!0}(i),v=g&&u.textLetterSpacing/s||0,b=[u.textDx/s||0,u.textDy/s||0],w=((o?o(null,h):u.textWrapWidth)||10*c)/s;a={},a.horizontal=Ga(i,p,w,m,y,"center",v,b,c,1),g&&d&&f&&(a.vertical=Ga(i,p,w,m,y,"center",v,b,c,2))}else if(l&&l.icon){if(!t.positions[l.icon.url])return null;const n=ru(i?i(null,h):u.markerHorizontalAlignment,s?s(null,h):u.markerVerticalAlignment);a=function(t,n,e){let{horizontalAlign:r,verticalAlign:i}=Ka(n,e);e?r=1-r:i=1-i;const s=-2048*r,o=-2048*i;return{image:t,top:o,bottom:o+2048,left:s,right:s+2048}}(t.positions[l.icon.url],n,this.options.isVector3D),this.size||(this.size=a.image.displaySize)}return this.vt=a,a}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:n,markerPathFn:e,markerWidthFn:r,markerHeightFn:i,markerFillFn:s,markerFillPatternFileFn:o,markerFillOpacityFn:a,markerTextFitFn:u,markerTextFitPaddingFn:l,markerLineColorFn:h,markerLineWidthFn:c,markerLineOpacityFn:f,markerLineDasharrayFn:y,markerLinePatternFileFn:m,markerPathWidthFn:g,markerPathHeightFn:v,textNameFn:b,textFaceNameFn:w,textStyleFn:M,textWeightFn:x}=this.tt,{zoom:F}=this.options,A={},k=this.symbol,P=this.feature.properties,S=t?t(null,P):k.markerFile,_=n?n(null,P):k.markerType,O=S||_||k.markerPath,E=!gr(this.symbolDef.textName);let I;if(O){I=function(t,n,e,r,i,s){if(gr(n.markerWidth)&&gr(n.markerHeight))return null;const o="__fn_markerWidth".trim(),a="__fn_markerHeight".trim();let u=n.markerWidth||0,l=n.markerHeight||0;return br(u)&&("identity"!==u.type?u=ca(u):(u=t.markerWidth,t[o]&&(u=t[o](r,e)),br(u)&&(u="identity"===u.type?i(r,e):ca(u)))),br(l)&&("identity"!==l.type?l=ca(l):(l=t.markerHeight,t[a]&&(l=t[a](r,e)),br(l)&&(l="identity"===l.type?s(r,e):ca(l)))),[u,l]}(k,this.symbolDef,P,F,r,i)||[0,0];let t=k.markerTextFit;if(u&&(t=u(F,P)),t&&k.text&&"none"!==t){const n=k.text.textSize;let e=k.text.textName;d(e)&&(e=p(e)(F,P));const r=pa(e,P);if(r){const e="__fn_textSize".trim(),i="__fn_textSize_0".trim();d(n)&&!k.text[e]&&(k.text[i]=p(n),k.text[e]=(t,n)=>{const e=k.text[i](t,n);return d(e)?p(e)(t,n):e});const s=ha(k.text,k.text,P,F);if("width"!==t&&"both"!==t||(I[0]=s[0]*r.length),"height"!==t&&"both"!==t||(I[1]=s[1]),s[0]&&s[1]){let t=k.markerTextFitPadding||[0,0,0,0];l&&(t=l(F,P)),I[0]+=t[1]+t[3],I[1]+=t[0]+t[2]}}else I[0]=I[1]=-1}}if(E&&(I=ha(k,this.symbolDef,P,F)),!I)return A;if(I[0]=Math.ceil(I[0]),I[1]=Math.ceil(I[1]),this.size=I,O&&I[0]>=0&&I[1]>=0){let t;if(_){const n={};if(n.markerType=_,"path"===_&&(n.markerPath=e?e(null,P):k.markerPath,n.markerPathWidth=g?g(null,P):k.markerPathWidth,n.markerPathHeight=v?v(null,P):k.markerPathHeight),r){const t=r(null,P);gr(t)||(n.markerWidth=t)}else k.markerWidth>=0&&(n.markerWidth=k.markerWidth);if(i){const t=i(null,P);gr(t)||(n.markerHeight=t)}else k.markerHeight>=0&&(n.markerHeight=k.markerHeight);if(s){const t=s(null,P);gr(t)||(n.markerFill=t)}else k.markerFill&&(n.markerFill=k.markerFill);if(o){const t=o(null,P);gr(t)||(n.markerFillPatternFile=t)}else k.markerFillPatternFile&&(n.markerFillPatternFile=k.markerFillPatternFile);if(a){const t=a(null,P);gr(t)||(n.markerFillOpacity=t)}else k.markerFillOpacity>=0&&(n.markerFillOpacity=k.markerFillOpacity);if(h){const t=h(null,P);gr(t)||(n.markerLineColor=t)}else k.markerLineColor&&(n.markerLineColor=k.markerLineColor);if(c){const t=c(null,P);gr(t)||(n.markerLineWidth=t)}else k.markerLineWidth>=0&&(n.markerLineWidth=k.markerLineWidth);if(f){const t=f(null,P);gr(t)||(n.markerLineOpacity=t)}else k.markerLineOpacity>=0&&(n.markerLineOpacity=k.markerLineOpacity);if(y){const t=y(null,P);gr(t)||(n.markerLineDasharray=t)}else k.markerLineDasharray&&(n.markerLineDasharray=k.markerLineDasharray);if(m){const t=m(null,P);gr(t)||(n.markerLinePatternFile=t)}else k.markerLinePatternFile&&(n.markerLinePatternFile=k.markerLinePatternFile);t="vector://"+JSON.stringify(n)}else t=S?S.replace(nu,this.yt):k.markerPath?function(t,n,e){if(!t.markerPath)return null;let r=1;const i=function(t){const n={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===n.stroke["stroke-width"]&&(n.stroke["stroke-opacity"]=0),n}(t);vr(t.markerOpacity)&&(r=t.markerOpacity),vr(t.opacity)&&(r*=t.opacity);const s={};if(i){for(const t in i.stroke)Fr(i.stroke,t)&&(gr(i.stroke[t])||(s[t]=i.stroke[t]));for(const t in i.fill)Fr(i.fill,t)&&(gr(i.fill[t])||(s[t]=i.fill[t]))}const o=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let a;const u=[];for(let t=0;t<o.length;t++)a=wr(o[t])?{path:o[t]}:o[t],a=mr({},a,s),a.d=a.path,delete a.path,u.push(a);const l=[\'<svg version="1.1"\',\'xmlns="http://www.w3.org/2000/svg"\'];r<1&&l.push(\'opacity="\'+r+\'"\'),t.markerPathWidth&&t.markerPathHeight&&l.push(\'viewBox="0 0 \'+t.markerPathWidth+" "+t.markerPathHeight+\'"\'),l.push(\'preserveAspectRatio="none"\'),n&&l.push(\'width="\'+n+\'"\'),e&&l.push(\'height="\'+e+\'"\'),l.push("><defs></defs>");for(let t=0;t<u.length;t++){let n="<path ";for(const e in u[t])Fr(u[t],e)&&(n+=" "+e+\'="\'+u[t][e]+\'"\');n+="></path>",l.push(n)}return l.push("</svg>"),"data:image/svg+xml;base64,"+btoa(l.join(" "))}(k,I[0],I[1]):null;A.icon={url:t,size:I}}if(E){const t=b?b(this.options.zoom,P):k.textName;if(t||0===t){const n=fa(w?w(null,P):k.textFaceName,M?M(null,P):k.textStyle,x?x(null,P):k.textWeight);let e=pa(t,P);e&&e.length&&(e=tu(e),A.glyph={font:n,text:e})}}return this.iconGlyph=A,A}}function ru(t,n){n&&"middle"!==n||(n="center"),t&&"middle"!==t||(t="center");let e="center"!==n?n:"";return e+="center"!==t?(e.length?"-":"")+t:"",e\n/*!\n     * From mapbox-gl-js\n     * MIT License\n     * https://github.com/mapbox/mapbox-gl-js\n     */}function iu(t,n,e,r,i){const s=[];let o;for(let a=0;a<t.length;a++){const u=t[a];let l,h=!1;for(let t=0;t<u.length-1;t++){let a=u[t],c=u[t+1];a.x<n&&c.x<n||(a.x<n?(o=a,a=new Ut(n,a.y+(n-a.x)/(c.x-a.x)*(c.y-a.y)).T(),a.z=o.z+(n-o.x)/(c.x-o.x)*(c.z-o.z),h=!0):c.x<n&&(o=c,c=new Ut(n,a.y+(n-a.x)/(c.x-a.x)*(c.y-a.y)).T(),c.z=a.z+(n-a.x)/(o.x-a.x)*(o.z-a.z),h=!0),a.y<e&&c.y<e||(a.y<e?(o=a,a=new Ut(a.x+(e-a.y)/(c.y-a.y)*(c.x-a.x),e).T(),a.z=o.z+(e-o.y)/(c.y-o.y)*(c.z-o.z),h=!0):c.y<e&&(o=c,c=new Ut(a.x+(e-a.y)/(c.y-a.y)*(c.x-a.x),e).T(),c.z=a.z+(e-a.y)/(o.y-a.y)*(o.z-a.z),h=!0),a.x>=r&&c.x>=r||(a.x>=r?(o=a,a=new Ut(r,a.y+(r-a.x)/(c.x-a.x)*(c.y-a.y)).T(),a.z=o.z+(r-o.x)/(c.x-o.x)*(c.z-o.z),h=!0):c.x>=r&&(o=c,c=new Ut(r,a.y+(r-a.x)/(c.x-a.x)*(c.y-a.y)).T(),c.z=a.z+(r-a.x)/(o.x-a.x)*(o.z-a.z),h=!0),a.y>=i&&c.y>=i||(a.y>=i?(o=a,a=new Ut(a.x+(i-a.y)/(c.y-a.y)*(c.x-a.x),i).T(),a.z=o.z+(i-o.y)/(c.y-o.y)*(c.z-o.z),h=!0):c.y>=i&&(o=c,c=new Ut(a.x+(i-a.y)/(c.y-a.y)*(c.x-a.x),i).T(),c.z=a.z+(i-a.y)/(o.y-a.y)*(o.z-a.z),h=!0),l&&a.equals(l[l.length-1])||(l=[a],s.push(l)),h&&(l.clipped=!0),l.push(c)))))}}return s}class su extends Ut{constructor(t,n,e,r){super(t,n),this.angle=e,void 0!==r&&(this.segment=r)}clone(){return new su(this.x,this.y,this.angle,this.segment)}}\n/*!\n     * From mapbox-gl-js\n     * MIT License\n     * https://github.com/mapbox/mapbox-gl-js\n     */function ou(t,n,e,r,i){if(void 0===n.segment)return!0;let s=n,o=n.segment+1,a=0;for(;a>-e/2;){if(o--,o<0)return!1;a-=t[o].dist(s),s=t[o]}a+=t[o].dist(t[o+1]),o++;const u=[];let l=0;for(;a<e/2;){const n=t[o],e=t[o+1];if(!e)return!1;let s=t[o-1].angleTo(n)-n.angleTo(e);for(s=Math.abs((s+3*Math.PI)%(2*Math.PI)-Math.PI),u.push({distance:a,angleDelta:s}),l+=s;a-u[0].distance>r;)l-=u.shift().angleDelta;if(l>i)return!1;o++,a+=n.dist(e)}return!0}function au(t,n,e,r,i,s,o,a,u,l,h){const c=function(t,n,e){return t?.6*n*e:0}(r,s,o),f=function(t,n){return Math.max(t?t.right-t.left:0,n?n.right-n.left:0)}(r,i),d=0===t[0].x||t[0].x===u||0===t[0].y||t[0].y===u;return n-f*o<n/4&&(n=f*o+n/4),function t(n,e,r,i,s,o,a,u,l,h,c){let f=0;const d=o/2,p=function(t){let n=0;for(let e=0;e<t.length-1;e++)n+=t[e].dist(t[e+1]);return n}(n);let y=0,m=e-r,g=[];for(let t=0;t<n.length-1;t++){const e=n[t],a=n[t+1],u=e.dist(a),v=a.angleTo(e);for(;m+r<y+u;){m+=r;const b=(m-y)/u,w=uu(e.x,a.x,b),M=uu(e.y,a.y,b),x=uu(e.z||0,a.z||0,b);if(w>=0&&w<l&&M>=0&&M<l&&m-d>=0&&m+d<=p){const r=new su(w,M,v,t);r.z=x,h&&(r.axis=[e.y-M,w-e.x],r.angleR=x===(e.z||0)?0:Math.atan(.9*(x-(e.z||0))*c/e.dist(r))),r.line=n,r.T(),!i||ou(n,r,o,i,s)?g.push(r):i&&f++}}y+=u}return u||g.length||a||(g=t(n,y/2,r,i,s,o,a,!0,l,h,c)),g.countOutOfAngle=f,g}(t,d?n/2*a%n:(f/2+2*s)*o*a%n,n,c,e,f*o,d,!1,u,l,h)}function uu(t,n,e){return t*(1-e)+n*e}function lu(t,n){const e=t.length;if(e<=1)return[t];const r=[];let i,s;for(let n=0;n<e;n++){const e=Ke(t[n]);0!==e&&(t[n].area=Math.abs(e),void 0===s&&(s=e<0),s===e<0?(i&&r.push(i),i=[t[n]]):i.push(t[n]))}if(i&&r.push(i),n>1)for(let t=0;t<r.length;t++)r[t].length<=n||(Gn(r[t],n,1,r[t].length-1,hu),r[t]=r[t].slice(0,n));return r}function hu(t,n){return n.area-t.area}function cu(t,n,e){const r=n.distSqr(e);if(0===r)return t.distSqr(n);const i=((t.x-n.x)*(e.x-n.x)+(t.y-n.y)*(e.y-n.y))/r;return t.distSqr(i<0?n:i>1?e:e.sub(n).k(i).m(n))}function fu(t,n=1,e=!1){let r=1/0,i=1/0,s=-1/0,o=-1/0;const a=t[0];for(let t=0;t<a.length;t++){const n=a[t];(!t||n.x<r)&&(r=n.x),(!t||n.y<i)&&(i=n.y),(!t||n.x>s)&&(s=n.x),(!t||n.y>o)&&(o=n.y)}const u=Math.min(s-r,o-i);let l=u/2;const h=new Bn([],du);if(0===u)return new Ut(r,i);for(let n=r;n<s;n+=u)for(let e=i;e<o;e+=u)h.push(new pu(n+l,e+l,l,t));let c=function(t){let n=0,e=0,r=0;const i=t[0];for(let t=0,s=i.length,o=s-1;t<s;o=t++){const s=i[t],a=i[o],u=s.x*a.y-a.x*s.y;e+=(s.x+a.x)*u,r+=(s.y+a.y)*u,n+=3*u}return new pu(e/n,r/n,0,t)}(t),f=h.length;for(;h.length;){const r=h.pop();(r.d>c.d||!c.d)&&(c=r,e&&console.log("found best %d after %d probes",Math.round(1e4*r.d)/1e4,f)),r.max-c.d<=n||(l=r.h/2,h.push(new pu(r.p.x-l,r.p.y-l,l,t)),h.push(new pu(r.p.x+l,r.p.y-l,l,t)),h.push(new pu(r.p.x-l,r.p.y+l,l,t)),h.push(new pu(r.p.x+l,r.p.y+l,l,t)),f+=4)}return e&&(console.log("num probes: "+f),console.log("best distance: "+c.d)),c.p}function du(t,n){return n.max-t.max}function pu(t,n,e,r){this.p=new Ut(t,n),this.h=e,this.d=function(t,n){let e=!1,r=1/0;for(let i=0;i<n.length;i++){const s=n[i];for(let n=0,i=s.length,o=i-1;n<i;o=n++){const i=s[n],a=s[o];i.y>t.y!=a.y>t.y&&t.x<(a.x-i.x)*(t.y-i.y)/(a.y-i.y)+i.x&&(e=!e),r=Math.min(r,cu(t,i,a))}}return(e?1:-1)*Math.sqrt(r)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}function yu(t,n,e,r,i,s,o,a,u,l){const{feature:h,size:c,symbol:f}=t,d=c?24:0,p=i*(c?c[0]/d:1);if("line"===o){const t=[];t.countOutOfAngle=0;let i=h.geometry;s&&(i=iu(h.geometry,0,0,s,s));for(let o=0;o<i.length;o++){const h=au(i[o],a,e,f.isIconText?null:r&&r.vertical||r&&r.horizontal||r,null,d,f.isIconText?1:p,1,s||1/0,u,l);if(f.textPlacement&&!f.isIconText)for(let t=0;t<h.length;t++)h[t].startIndex=n.length/3;if(t.push.apply(t,h),f.textPlacement&&!f.isIconText)for(let t=0;t<i[o].length;t++)n.push(i[o][t].x,i[o][t].y,i[o][t].z||0);t.countOutOfAngle+=h.countOutOfAngle||0}return t}return mu(h,o,s)}function mu(t,n,e,r,i){const s=[];if(3===t.type){const o=lu(t.geometry,0);for(let t=0;t<o.length;t++){const a=o[t];if("vertex"===n)for(let t=0;t<a.length;t++){const n=a[t];for(let o=0;o<n.length;o++)er(n[o],e)||(s.push(n[o]),r&&(0===o?gu(n[o],n[o],n[t+1],i):gu(n[o],n[o-1],n[o],i)))}else if("vertex-first"===n){const t=a[0];t&&t[0]&&!er(t[0],e)&&(s.push(t[0]),r&&gu(t[0],t[0],t[1],i))}else if("vertex-last"===n||"vertex-firstlast"===n){const t=a[0];if("vertex-firstlast"===n&&t&&t[0]&&!er(t[0],e)&&(s.push(t[0]),r&&gu(t[0],t[0],t[1],i)),t&&t[t.length-1]&&!er(t[t.length-1],e)){const n=t.length-1;s.push(t[n]),r&&gu(t[n],t[n-1],t[n],i)}}else{const t=fu(a,16);er(t,e)||s.push(t)}}}else if(2===t.type)for(let o=0;o<t.geometry.length;o++){const a=t.geometry[o];if("vertex"===n)for(let t=0;t<a.length;t++)er(a[t],e)||(s.push(a[t]),r&&(0===t?gu(a[t],a[t],a[t+1],i):gu(a[t],a[t-1],a[t],i)));else if("vertex-last"===n||"vertex-firstlast"===n){if("vertex-firstlast"!==n||er(a[0],e)||(s.push(a[0]),r&&gu(a[0],a[0],a[1],i)),a&&a[a.length-1]&&!er(a[a.length-1],e)){const t=a.length-1;s.push(a[t]),r&&gu(a[t],a[t-1],a[t],i)}}else er(a[0],e)||(s.push(a[0]),r&&gu(a[0],a[0],a[1],i))}else if(1===t.type)for(let n=0;n<t.geometry.length;n++){const i=t.geometry[n];for(let t=0;t<i.length;t++){const n=i[t];er(n,e)||(r&&(n.xRotation=0,n.yRotation=0,n.zRotation=0),s.push(n))}}return s}function gu(t,n,e,r){if(t.xRotation||t.yRotation||t.zRotation)return t;const i=e.x-n.x,s=n.y-e.y,o=(e.z-n.z)*r,a=Math.atan2(s,i);t.zRotation=a;const u=Math.atan2(o,Math.sqrt(i*i+s*s));return t.xyRotation=u,t}function vu(t,n){const e={},r={},i=[];let s=0;function o(n){i.push(t[n]),s++}function a(t,n,e){const s=r[t];return delete r[t],r[n]=s,i[s].geometry[0].pop(),i[s].geometry[0]=i[s].geometry[0].concat(e[0]),s}function u(t,n,r){const s=e[n];return delete e[n],e[t]=s,i[s].geometry[0].shift(),i[s].geometry[0]=r[0].concat(i[s].geometry[0]),s}function l(t,n,e){const r=e?n[0][n[0].length-1]:n[0][0];return`${t}:${r.x}:${r.y}`}for(let h=0;h<t.length;h++){const c=t[h],f=c.geometry;if(!f)continue;const d=c.properties[n]?c.properties[n].toString():null;if(!d){o(h);continue}const p=l(d,f),y=l(d,f,!0);if(p in r&&y in e&&r[p]!==e[y]){const t=u(p,y,f),n=a(p,y,i[t].geometry);delete e[p],delete r[y],r[l(d,i[n].geometry,!0)]=n,i[t].geometry=null}else p in r?a(p,y,f):y in e?u(p,y,f):(o(h),e[p]=s-1,r[y]=s-1)}return i.filter(t=>t.geometry)}class bu extends aa{static needMerge(t,n,e){if(!t)return!1;let r="line"===t.textPlacement||"line"===t.markerPlacement;return r||(n.textPlacementFn&&(r="line"===n.textPlacementFn(e)),n.markerPlacementFn&&(r="line"===n.markerPlacementFn(e))),t.mergeOnProperty&&r}static mergeLineFeatures(t,n,e,r){const i="__index".trim();let s=n.textPlacement,o=n.markerPlacement;e.textPlacementFn&&(s=e.textPlacementFn(r)),e.markerPlacementFn&&(o=e.markerPlacementFn(r));const a=function(t,n,e,r,i){const s="__index".trim(),o=aa.genFnTypes(n),{mergeOnPropertyFn:a}=o;if(!n.mergeOnProperty||"line"!==r&&"line"!==e)return[];if(!(rr(u=n.mergeOnProperty)||"string"!=typeof u&&(null===u.constructor||u.constructor!==String)||"line"!==r&&"line"!==e))return[{features:t,property:n.mergeOnProperty}];var u;const l=[],h={},c=[];for(let o=0;o<t.length;o++){t[o][s]=o;const u=t[o].properties=t[o].properties||{};u.$layer=t[o].layer,u.$type=t[o].type;let f=e;"line"!==f&&(f=r);const d=a?a(i,u):n.mergeOnProperty;"line"!==f||rr(d)?c.push(t[o]):(void 0===h[d]&&(h[d]=l.length,l.push({features:[],property:d})),l[h[d]].features.push(t[o]))}return c.length&&l.push({features:c}),l}(t,n,o,s,r);if(a.length){const n=[];for(let e=0;e<a.length;e++)n.push(a[e].property?vu(a[e].features,a[e].property):t);if(1===n.length)return n[0];{let t=[];for(let e=0;e<n.length;e++)t=t.concat(n[e]);return t.sort((t,n)=>t[i]-n[i]),t}}}static splitPointSymbol(t,n=0){const e=[];if(Array.isArray(t)){const n=t;for(let t=0;t<n.length;t++)n[t]&&e.push(...bu.splitPointSymbol(n[t],t));return e}let r=null,i=null;for(const n in t)0===n.indexOf("marker")?(r=r||{},r[n]=t[n]):0===n.indexOf("text")&&(i=i||{},i[n]=t[n]);return r&&(r.isIconText=!0,t.mergeOnProperty&&(r.mergeOnProperty=t.mergeOnProperty),e.push(r)),i&&(r&&(i.textPlacement=r.markerPlacement,i.textSpacing=r.markerSpacing,i.isIconText=!0),t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),e.push(i)),void 0!==t.visible&&(r&&(r.visible=t.visible),i&&(i.visible=t.visible)),r&&(r.markerTextFit&&i&&(r.text={},r.text.textName=i.textName,r.text.textSize=i.textSize),r.index={index:n,type:0}),i&&(i.index={index:n,type:1}),e}static isAtlasLoaded(t,n){const{icon:e,glyph:r}=t,{iconAtlas:i,glyphAtlas:s}=n;if(e&&(!i||!i.positions[e.url]))return!1;if(r){if(!s||!s.positions[r.font])return!1;const t=s.positions[r.font],{text:n}=r;for(const e of n)if(!t[e.codePointAt(0)])return!1}return!0}constructor(t,n,e){super(t,n,e),this.bt=n.textPlacement,this.tt.textPlacementFn&&(this.bt=this.tt.textPlacementFn(this.options.zoom))}createStyledVector(t,n,e,r,i,s){const o=new eu(t,this.symbolDef,n,e,r),a=o.getIconAndGlyph();if(a.icon&&!this.options.atlas){const{url:t,size:n}=a.icon;i[t]||(i[t]=a.icon.size),i[t][0]<n[0]&&(i[t][0]=n[0]),i[t][1]<n[1]&&(i[t][1]=n[1])}if(a.glyph&&!this.options.atlas){const{font:t,text:n}=a.glyph,e=s[t]=s[t]||{};for(const t of n)e[t.codePointAt(0)]=1;"line"===this.bt&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||a.icon||a.glyph?o:null}getFormat(t){const n=void 0!==t.textName,e=n?this.getPackSDFFormat(t):this.getPackMarkerFormat();n?e.push(...this.wt()):e.push(...this.Mt());const{markerOpacityFn:r,textOpacityFn:i,markerPitchAlignmentFn:s,textPitchAlignmentFn:o,markerRotationAlignmentFn:a,textRotationAlignmentFn:u,markerRotationFn:l,textRotationFn:h,markerAllowOverlapFn:c,textAllowOverlapFn:f,markerIgnorePlacementFn:d,textIgnorePlacementFn:p}=this.tt;return(r||i)&&e.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(s||o)&&e.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(a||u)&&e.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(l||h)&&e.push({type:Uint16Array,width:1,name:"aRotation"}),(c||f||d||p)&&e.push({type:Uint8Array,width:1,name:"aOverlap"}),e}xt(){return this.hasMapPitchAlign}wt(){const{textFillFn:t,textSizeFn:n,textHaloFillFn:e,textHaloRadiusFn:r,textHaloOpacityFn:i,textDxFn:s,textDyFn:o}=this.tt,a=[];return t&&a.push({type:Uint8Array,width:4,name:"aTextFill"}),n&&a.push({type:Uint8Array,width:1,name:"aTextSize"}),e&&a.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),r&&a.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),i&&a.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),s&&a.push({type:Int8Array,width:1,name:"aTextDx"}),o&&a.push({type:Int8Array,width:1,name:"aTextDy"}),a}Mt(){const{markerWidthFn:t,markerHeightFn:n,markerDxFn:e,markerDyFn:r}=this.tt,i=[];return t&&i.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),n&&i.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),e&&i.push({type:Int8Array,width:1,name:"aMarkerDx"}),r&&i.push({type:Int8Array,width:1,name:"aMarkerDy"}),i}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,n){const e=t.getShape(this.iconAtlas,this.glyphAtlas);if(!(this.options.allowEmptyPack||e&&e.image||e&&(e.horizontal||e.vertical)))return;const r=this.Ft(t,e,n);if(this.countOutOfAngle+=r.countOutOfAngle||0,0===r.length)return;const i=this.data,s=this.needAltitudeAttribute()?2:3;let o=this.data.aPosition.length/s;const a=t.symbol,u=t.feature.properties,l="line"===this.bt&&!a.isIconText,h=void 0!==a.textName,c=h&&l&&function(t){let n=0;for(let e=0;e<t.length;e++)if(La(t.charAt(e).charCodeAt(0)))n=0;else if(n++,n>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:f,textSizeFn:p,textHaloFillFn:y,textHaloRadiusFn:m,textHaloOpacityFn:g,textDxFn:v,textDyFn:b,textPitchAlignmentFn:w,textRotationAlignmentFn:M,textRotationFn:x,textAllowOverlapFn:F,textIgnorePlacementFn:A,textOpacityFn:k,markerWidthFn:P,markerHeightFn:S,markerDxFn:_,markerDyFn:O,markerPitchAlignmentFn:E,markerRotationAlignmentFn:I,markerRotationFn:$,markerAllowOverlapFn:C,markerIgnorePlacementFn:T,markerOpacityFn:z}=this.tt;let D,j,U,N,L,V,R,H,W,q,G,B,J,X,Y,Z,K;if(h){const n=t.getIconAndGlyph().glyph.font;D=function(t,n,e){const r=t.positionedGlyphs,i=[];for(let s=0;s<r.length;s++){const o=r[s],a=e[o.glyph];if(!a)continue;const u=a.rect;if(!u)continue;const l=4,h=a.metrics.advance/2,c=a.metrics.height/2,f=n?[o.x+h,0]:[0,0],d=n?[0,o.y-c]:[o.x+h,o.y-c],p=a.metrics.left-l-h+d[0],y=a.metrics.top-l+d[1],m=p+u.w,g=y+u.h,v=new Ut(p,y),b=new Ut(m,y),w=new Ut(p,g),M=new Ut(m,g);if(n&&o.vertical){const t=new Ut(-h,h),n=-Math.PI/2,e=new Ut(5,0);v._(n,t).m(e),b._(n,t).m(e),w._(n,t).m(e),M._(n,t).m(e)}i.push({tl:v,tr:b,bl:w,br:M,tex:u,writingMode:t.writingMode,glyphOffset:f})}return i}(e.horizontal,l,this.glyphAtlas.positions[n]),f&&(j=f(null,u),d(j)?(this.dynamicAttrs.aTextFill=1,j=[0,0,0,0]):j=Or([],j)),p&&(U=p(this.options.zoom,u),rr(U)&&(U=14)),y&&(N=y(null,u),d(N)?(this.dynamicAttrs.aTextHaloFill=1,N=[0,0,0,0]):N=Or([],N)),m&&(L=m(null,u)),g&&(V=255*g(null,u)),v&&(R=v(null,u)||0),b&&(H=b(null,u)||0),w&&(J=+("map"===w(null,u))),M&&(X=+("map"===M(null,u))),x&&(Y=ir(x(null,u),0,360)*Math.PI/180)}else D=e?function(t){const n=t.image,e=t.top-1/n.pixelRatio,r=t.left-1/n.pixelRatio,i=t.bottom+1/n.pixelRatio,s=t.right+1/n.pixelRatio;let o,a,u,l;return o=new Ut(r,e),a=new Ut(s,e),u=new Ut(s,i),l=new Ut(r,i),[{tl:o,tr:a,bl:l,br:u,tex:{x:n.tl[0],y:n.tl[1],w:n.displaySize[0],h:n.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(e):function(){const t=new Ut(0,0),n=new Ut(0,0),e=new Ut(0,0);return[{tl:t,tr:n,bl:new Ut(0,0),br:e,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),P&&(W=P(null,u)),rr(W)&&(W=D[0].tex.w),S&&(q=S(null,u)),rr(q)&&(q=D[0].tex.h),_&&(G=_(null,u)),O&&(B=O(null,u)),E&&(J=+("map"===E(null,u))),I&&(X=+("map"===I(null,u))),$&&(Y=ir($(null,u),0,360)*Math.PI/180);d(U)&&(this.dynamicAttrs.aTextSize=1),d(L)&&(this.dynamicAttrs.aTextHaloRadius=1),d(V)&&(this.dynamicAttrs.aTextHaloOpacity=1),d(R)&&(this.dynamicAttrs.aTextDx=1),d(H)&&(this.dynamicAttrs.aTextDy=1),d(W)&&(this.dynamicAttrs.aMarkerWidth=1),d(q)&&(this.dynamicAttrs.aMarkerHeight=1),d(G)&&(this.dynamicAttrs.aMarkerDx=1),d(B)&&(this.dynamicAttrs.aMarkerDy=1),d(J)&&(this.dynamicAttrs.aPitchAlign=1),d(X)&&(this.dynamicAttrs.aRotationAlign=1),d(Y)&&(this.dynamicAttrs.aRotation=1);const Q=C||F;Q&&(Z=Q(null,u)||0);const tt=T||A;let nt;tt&&(K=tt(null,u)||0);const et=k||z;et&&(nt=255*et(this.options.zoom,u));const rt=this.options.EXTENT,it=D.length,{altitudeScale:st,altitudeProperty:ot,defaultAltitude:at}=this.options,{altitude:ut}=nr(t.feature,st,ot,at);for(let t=0;t<r.length;t++){const n=r[t],e=n.z||ut||0;if(rt!==1/0&&er(n,rt))continue;const s=n.x,a=n.y,u=D.length;for(let t=0;t<u;t++){const r=D[t],{tl:u,tr:f,bl:d,br:p,tex:y}=r;this.At(i,s,a,e,10*u.x,10*u.y,y.x,y.y+y.h),h&&this.kt(i,l,it,r.glyphOffset,n,c,n.axis,n.angleR),this.Pt(i,j,U,N,L,V,R,H,W,q,G,B,nt,J,X,Y,Z,K),this.At(i,s,a,e,10*f.x,10*f.y,y.x+y.w,y.y+y.h),h&&this.kt(i,l,it,r.glyphOffset,n,c,n.axis,n.angleR),this.Pt(i,j,U,N,L,V,R,H,W,q,G,B,nt,J,X,Y,Z,K),this.At(i,s,a,e,10*d.x,10*d.y,y.x,y.y),h&&this.kt(i,l,it,r.glyphOffset,n,c,n.axis,n.angleR),this.Pt(i,j,U,N,L,V,R,H,W,q,G,B,nt,J,X,Y,Z,K),this.At(i,s,a,e,10*p.x,10*p.y,y.x+y.w,y.y),h&&this.kt(i,l,it,r.glyphOffset,n,c,n.axis,n.angleR),this.Pt(i,j,U,N,L,V,R,H,W,q,G,B,nt,J,X,Y,Z,K),this.addElements(o,o+1,o+2),this.addElements(o+1,o+2,o+3),o+=4;const m=Math.max(Math.abs(s),Math.abs(a),Math.abs(e));m>this.maxPos&&(this.maxPos=m)}}}At(t,n,e,r,i,s,o,a){this.fillPosition(t,n,e,r),t.aShape.push(i,s),t.aTexCoord.push(o,a)}kt(t,n,e,r,i,s,o,a){if(t.aCount.push(e),n){t.aGlyphOffset.push(r[0],r[1]),this.xt()&&t.aPitchRotation.push(o[0],o[1],a);const n=i.startIndex;t.aSegment.push(i.segment+n,n,i.line.length),t.aVertical.push(s)}}Pt(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m,g){const{textFillFn:v,textSizeFn:b,textHaloFillFn:w,textHaloRadiusFn:M,textHaloOpacityFn:x,textDxFn:F,textDyFn:A,textPitchAlignmentFn:k,textRotationAlignmentFn:P,textRotationFn:S,textAllowOverlapFn:_,textIgnorePlacementFn:O,textOpacityFn:E,markerWidthFn:I,markerHeightFn:$,markerDxFn:C,markerDyFn:T,markerPitchAlignmentFn:z,markerRotationAlignmentFn:D,markerRotationFn:j,markerAllowOverlapFn:U,markerIgnorePlacementFn:N,markerOpacityFn:L}=this.tt;v&&t.aTextFill.push(...n),b&&t.aTextSize.push(e),w&&t.aTextHaloFill.push(...r),M&&t.aTextHaloRadius.push(i),x&&t.aTextHaloOpacity.push(s),F&&t.aTextDx.push(o),A&&t.aTextDy.push(a),I&&t.aMarkerWidth.push(u),$&&t.aMarkerHeight.push(l),C&&t.aMarkerDx.push(h),T&&t.aMarkerDy.push(c),(L||E)&&t.aColorOpacity.push(f),(k||z)&&t.aPitchAlign.push(d),(D||P)&&t.aRotationAlign.push(p),(j||S)&&t.aRotation.push(9362*y);const V=U||_,R=N||O;(V||R)&&t.aOverlap.push((V?8:0)+4*m+((R?2:0)+g)),i>0&&(this.properties.hasHalo=1)}Ft(t,n,e){const{feature:r,symbol:i}=t,s=this.St(t,i),o=r.properties,{markerSpacingFn:a,textSpacingFn:u,textMaxAngleFn:l}=this.tt,h=((a?a(null,o):i.markerSpacing)||(u?u(null,o):i.textSpacing)||250)*e;let c=l?l(this.options.zoom,o):i.textMaxAngle;rr(c)&&(c=80),c*=Math.PI/180;const f=this.options.EXTENT,d=this.options.altitudeToTileScale,p=this.xt();return yu(t,this.lineVertex,c,n,e,f,s,h,p,d)}St(t,n){let e;return e=this.tt.markerPlacementFn?this.tt.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement||this.bt,this.ht||!n.markerPlacement&&!n.isIconText||(this.ht=e),!this.bt||n.isIconText||this.ct||(this.ct=e),e}getPackSDFFormat(t){if("line"!==this.bt||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this.xt()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}}class wu{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new wu(this)}I(){return this.P(this.mag()),this}P(t){return this.x/=t,this.y/=t,this.z/=t,this}C(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone().m(t)}sub(t){return this.clone().M(t)}m(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}M(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone().k(t)}k(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var n=t.x-this.x,e=t.y-this.y,r=t.z-this.z;return n*n+e*e+r*r}T(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}}const Mu=Math.cos(Math.PI/180*37.5),xu=Math.pow(2,16)/1,Fu=new Ut,Au=new Ut,ku=new Ut;class Pu extends aa{constructor(t,n,e){super(t,n,e);let r=!1;const{lineDasharrayFn:i,lineDashColorFn:s}=this.tt;this.hasGradient=this.symbol.lineGradientProperty,i&&(r=function(t,n,e){for(let r=0;r<t.length;r++)if(e(n,t[r].properties))return!0;return!1}(t,this.options.zoom,i),r&&(this.dasharrayFn=i)),this.hasDasharray=Ou(this.symbol.lineDasharray)||r,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,n,e,r,i){const s=new Cr(t,n,e,r),o=s.getLineResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:n,lineStrokeColorFn:e,lineColorFn:r,lineOpacityFn:i,lineDxFn:s,lineDyFn:o,linePatternAnimSpeedFn:a,linePatternGapFn:u}=this.tt,l=[...this.getPositionFormat()];if(l.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),l.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&l.push({type:Uint8Array,width:1,name:"aLineWidth"}),n&&l.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),r&&l.push({type:Uint8Array,width:4,name:"aColor"}),e&&l.push({type:Uint8Array,width:4,name:"aStrokeColor"}),i&&l.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&l.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&l.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();l.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||o)&&l.push({type:Int8Array,width:2,name:"aLineDxDy"}),(a||u)&&l.push({type:Int8Array,width:2,name:"aLinePattern"}),l}placeVector(t){const{lineJoinFn:n,lineCapFn:e,lineWidthFn:r,lineHeightFn:i,lineStrokeWidthFn:s,lineStrokeColorFn:o,lineColorFn:a,lineOpacityFn:u,lineDxFn:l,lineDyFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.tt,p=this.symbol,y=t.feature,m=y.properties;let g=p.lineJoin||"miter",v=p.lineCap||"butt";if(n&&(g=n(this.options.zoom,m)||"miter"),e&&(v=e(this.options.zoom,m)||"butt"),r){let t=r(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),gr(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+p.lineWidth;if(i){let t=i(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLineHeight=1),gr(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+p.lineHeight||this.feaLineWidth;if(s){let t=s(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),gr(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=p.lineStrokeWidth||0;if(a&&(this.feaColor=a(this.options.zoom,m)||[255,255,255,255],d(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=Or([],this.feaColor)),o&&(this.feaStrokeColor=o(this.options.zoom,m)||[0,0,0,255],d(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=Or([],this.feaStrokeColor)),u){let t=u(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aOpacity=1,t=1),gr(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,m)||[0,0,0,0];if(d(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const n=t;1===t.length?t=[n[0],n[0],n[0],n[0]]:2===t.length?t=[n[0],n[1],n[0],n[1]]:3===t.length&&(t=[n[0],n[1],n[2],n[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,m):this.symbol.lineDashColor)||[0,0,0,0];d(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=Or([],t),this.feaDashColor=t}if(this.iconAtlas){const n=t.getLineResource(),e=this.iconAtlas.glyphMap[n];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],e){const{tl:t,displaySize:e}=this.iconAtlas.positions[n];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=e[0]-3,this.feaTexInfo[3]=e[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(l){let t=l(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),gr(t)&&(t=0),this.feaLineDx=t}if(h){let t=h(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),gr(t)&&(t=0),this.feaLineDy=t}if(c){let t=c(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),gr(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(f){let t=f(this.options.zoom,m);d(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),gr(t)&&(t=0),this.feaLinePatternGap=t}const b=this.options.EXTENT;let w=y.geometry;if(b!==1/0){w=[];const t=[];for(let n=0;n<y.geometry.length;n++){t[0]=y.geometry[n];const e=iu(t,-1,-1,b+1,b+1);if(3===y.type&&e.length>1){const t=e[0],n=e[e.length-1];Cu(t[0],n[n.length-1])&&(e[0]=n.concat(t.slice(1)),e.length=e.length-1)}w.push(...e)}}const M=this.needAltitudeAttribute()?2:3;for(let t=0;t<w.length;t++)this.offset=this.data.aPosition.length/M,this._t(w[t],y,g,v,2,1.05)}Ot(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}_t(t,n,e,r,i,s){const o=this.Ot()||Ou(this.feaDash)||Ou(this.symbol.lineDasharray),a=this.options.isTube;a&&(t=t.map(t=>new wu(t))),this.overscaling=1;const u=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&n.properties&&vr(n.properties.mapbox_clip_start)&&vr(n.properties.mapbox_clip_end)){this.clipStart=+n.properties.mapbox_clip_start,this.clipEnd=+n.properties.mapbox_clip_end;for(let n=0;n<t.length-1;n++)this.totalDistance+=t[n].dist(t[n+1]);this.updateScaledDistance()}const l=3===n.type&&!t.clipped;let h=t.length;for(;h>=2&&Cu(t[h-1],t[h-2]);)h--;let c=0;for(;c<h-1&&Cu(t[c],t[c+1]);)c++;if(h<(l?3:2))return;"bevel"===e&&(i=1.05);const f=this.overscaling<=16?15*u/(512*this.overscaling):0,d={vertexLength:0,primitiveLength:0,currentNormal:null};let p,y,m,g,v;this.e1=this.e2=-1,l&&(p=t[h-2],v=t[c].sub(p).I().C());for(let n=c;n<h;n++){if(m=n===h-1?l?t[c+1]:void 0:t[n+1],m&&Cu(t[n],m))continue;v&&(g=v),p&&(y=p),p=t[n],m&&p.x===m.x&&p.y===m.y&&(p.x+=1e-4),v=m?m.sub(p).I().C():g,d.dir=y?p.sub(y).I():m.sub(p).I(),g=g||v,d.currentNormal=g;let u=g.add(v);0===u.x&&0===u.y||u.I();const b=g.x*v.x+g.y*v.y,w=u.x*v.x+u.y*v.y,M=0!==w?1/w:1/0,x=2*Math.sqrt(2-2*w),F=w<Mu&&y&&m,A=g.x*v.y-g.y*v.x>0;if(!a&&F&&n>c){const t=p.dist(y);if(t>2*f){const n=p.sub(p.sub(y).k(f/t).T());n.z=p.z,this.updateDistance(y,n),this.addCurrentVertex(n,g,0,0,d),y=n}}const k=y&&m;d.middleVertex=k;let P=k?e:l?"butt":r;if(k&&"round"===P&&(M<s?P="miter":M<=2&&(P="fakeround")),"miter"===P&&M>i&&!a&&(P="bevel"),"bevel"===P&&(M>2&&(P="flipbevel"),M<i&&(P="miter")),y&&this.updateDistance(y,p),"miter"===P)a?(this.addCurrentVertex(p,g,0,0,d),d.dir=m.sub(p).I(),this.addCurrentVertex(p,v,0,0,d)):(u.k(M),this.addCurrentVertex(p,u,0,0,d),o&&(d.currentNormal=v,this.addCurrentVertex(p,u,0,0,d)));else if("flipbevel"===P){if(M>100)u=v.mult(-1);else{const t=M*g.add(v).mag()/g.sub(v).mag();u.C().k(t*(A?-1:1))}this.addCurrentVertex(p,u,0,0,d),this.addCurrentVertex(p,u.mult(-1),0,0,d)}else if("bevel"===P||"fakeround"===P){const t=-Math.sqrt(M*M-1),n=A?t:0,e=A?0:t;if(y&&this.addCurrentVertex(p,g,n,e,d),"fakeround"===P){const t=Math.round(180*x/Math.PI/20);for(let n=1;n<t;n++){let e=n/t;if(.5!==e){const t=e-.5;e+=e*t*(e-1)*((1.0904+b*(b*(3.55645-1.43519*b)-3.2452))*t*t+(.848013+b*(.215638*b-1.06021)))}const r=v.sub(g).k(e).m(g).I().k(A?-1:1);this.addHalfVertex(p,r.x,r.y,!1,A,0,d)}}m&&(d.currentNormal=v,this.addCurrentVertex(p,v,-n,-e,d))}else if("butt"===P)this.addCurrentVertex(p,u,0,0,d);else if("square"===P){const t=y?1:-1;this.addCurrentVertex(p,u,t,t,d)}else"round"===P&&(y&&(this.addCurrentVertex(p,g,0,0,d),this.addCurrentVertex(p,g,1,1,d,!0)),m&&(this.addCurrentVertex(p,v,-1,-1,d,!0),this.addCurrentVertex(p,v,0,0,d)));if(!a&&F&&n<h-1){const t=p.dist(m);if(t>2*f){const n=p.add(m.sub(p).k(f/t).T());n.z=p.z,this.updateDistance(p,n),this.addCurrentVertex(n,v,0,0,d),p=n}}}}addCurrentVertex(t,n,e,r,i,s=!1){const o=n.x+n.y*e,a=n.y-n.x*e,u=n.y*r-n.x,l=-n.y-n.x*r;let h=0,c=0;if(i.middleVertex){Fu.x=o,Fu.y=a,Au.x=u,Au.y=l;const t=i.currentNormal;if(h=$u(t,Fu),0===e&&0===r)c=-h;else{const n=ku;n.x=t.x,n.y=t.y,n.k(-1),c=$u(n,Au)}}this.addHalfVertex(t,o,a,s,!1,e,i,h),this.addHalfVertex(t,u,l,s,!0,-r,i,c),this.prevVertex&&Cu(t,this.prevVertex)||(this.prevVertex=t),this.distance>xu/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,n,e,r,i,s))}addHalfVertex({x:t,y:n,z:e},r,i,s,o,a,u,l){this.fillData(this.data,t,n,e||0,r,i,s,o,1*this.scaledDistance,l);const h=u.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,h),u.primitiveLength++),o?this.e2=h:this.e1=h}fillData(t,n,e,r,i,s,o,a,u,l){const{lineWidthFn:h,lineStrokeWidthFn:c,lineStrokeColorFn:f,lineColorFn:d,lineOpacityFn:p,lineDxFn:y,lineDyFn:m,linePatternAnimSpeedFn:g,linePatternGapFn:v}=this.tt;this.fillPosition(t,n,e,r);let b=63*i;b=(Math.sign(b)||1)*((Math.floor(Math.abs(b))>>1<<1)+ +o);let w=63*s;w=(Math.sign(w)||1)*((Math.floor(Math.abs(w))>>1<<1)+ +a),t.aExtrude.push(b,w),(this.iconAtlas||this.hasDasharray)&&t.aExtrude.push(63*l),t.aLinesofar.push(u),h&&t.aLineWidth.push(Math.round(2*this.feaLineWidth)),c&&t.aLineStrokeWidth.push(Math.round(2*this.feaLineStrokeWidth)),d&&t.aColor.push(...this.feaColor),f&&t.aStrokeColor.push(...this.feaStrokeColor),p&&t.aOpacity.push(this.feaOpacity),this.dasharrayFn&&t.aDasharray.push(...this.feaDash),this.dashColorFn&&t.aDashColor.push(...this.feaDashColor),this.iconAtlas&&t.aTexInfo.push(...this.feaTexInfo),(y||m)&&t.aLineDxDy.push(this.feaLineDx||0,this.feaLineDy||0),(g||v)&&t.aLinePattern.push(127*(this.feaPatternAnimSpeed||0),10*(this.feaLinePatternGap||0)),this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}addElements(t,n,e){super.addElements(this.offset+t,this.offset+n,this.offset+e)}Et(t){const n=this.options.EXTENT,e=this.elements;for(let r=0;r<e.length;r+=3)n!==1/0&&(_u(this.data.aPosition,e[r],e[r+1],3,n)||_u(this.data.aPosition,e[r+1],e[r+2],3,n))||t.push(e[r],e[r+1],e[r+2])}It(t){if(t.length<=1)return t;const n=[],e=this.options.EXTENT;let r,i=!0;for(r=0;r<t.length-1;r++){const s=Su(t[r],t[r+1],e);s&&i||(n.push(t[r]),i=s)}return i||n.push(t[r]),n}updateDistance(t,n){if(this.options.isTube){const e=t.dist(n),r=Pr(this.options)*(n.z-t.z);this.distance+=Math.sqrt(e*e+r*r)}else this.distance+=t.dist(n);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(xu-1):this.distance}}function Su(t,n,e){return e!==1/0&&(t.x<0&&n.x<0||t.x>e&&n.x>e||t.y<0&&n.y<0||t.y>e&&n.y>e)}function _u(t,n,e,r,i){if(i===1/0)return!1;const s=Math.floor(.5*t[n*r]),o=Math.floor(.5*t[n*r+1]),a=Math.floor(.5*t[e*r]),u=Math.floor(.5*t[e*r+1]);return s===a&&(s<0||s>i)&&o!==u||o===u&&(o<0||o>i)&&s!==a}function Ou(t){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(t[n])return!0;return!1}const Eu=new Ut(0,0),Iu=new Ut(0,0);function $u(t,n){const e=t.mag(),r=n.mag();Eu.x=n.x,Eu.y=n.y;const i=t.angleTo(Iu),s=n.angleTo(Iu);return Math.sign(s-i)*Math.sqrt(r*r-e*e)}function Cu(t,n){return t.equals(n)&&t.z===n.z}class Tu extends Pu{constructor(t,n,e){super(t,n,e),this.$t=e.altitudeProperty}getFormat(){const{lineColorFn:t,lineWidthFn:n}=this.tt,e=[{type:this.maxPosZ>=Math.pow(2,15)?Float32Array:Int16Array,width:3,name:"aPosition"},{type:Uint16Array,width:1,name:"aLinesofar"},{type:Uint8Array,width:1,name:"aUp"},{type:Int16Array,width:3,name:"aExtrudedPosition"},{type:Int8Array,width:2,name:"aExtrude"}];return t&&e.push({type:Uint8Array,width:4,name:"aColor"}),n&&e.push({type:Uint8Array,width:1,name:"aLineWidth"}),this.$t&&e.push({type:Array,width:1,name:"aLineHeight"}),e}placeVector(t){const n=t.feature;if(this.$t){const{altitudeScale:t,altitudeProperty:e,defaultAltitude:r,heightProperty:i,defaultHeight:s,minHeightProperty:o}=this.options,{altitude:a,height:u}=nr(n,t,e,r,i,s,o);this.feaAltitude=a,this.feaMinHeight=(a-u)/a*32767,a>this.maxAltitude&&(this.maxAltitude=a)}return super.placeVector(t)}needAltitudeAttribute(){return!1}_t(t,n,e,r,i,s){const o=this.data.aPosition.length/3;super._t(t,n,e,r,i,s);const a=this.data.aPosition.length/3,u=this.data.aPosition.length/3-this.offset;if(3!==n.type&&u>0&&!1!==this.options.side){const t=!1!==this.options.top?1:0,n=t+4;let e=this.data.aPosition.length/3;for(const t in this.data){const n=this.data[t],r=n.length/e;for(let t=0;t<r;t++)n.push(n[o*r+3*r+t])}e=this.data.aPosition.length/3;for(const t in this.data){const r=this.data[t],i=r.length/e;for(let t=0;t<i;t++)r.push(r[o*i+i*n+t])}e=this.data.aPosition.length/3;for(const t in this.data){const r=this.data[t],i=r.length/e;for(let t=0;t<i;t++)r.push(r[o*i+i*(n+3)+t])}super.addElements(t+1,u+1,u),super.addElements(u,u+1,u+2);const r=this.data.aPosition.length/3-this.offset;e=this.data.aPosition.length/3;for(const t in this.data){const n=this.data[t],r=n.length/e;for(let t=0;t<r;t++)n.push(n[a*r-r+t])}e=this.data.aPosition.length/3;for(const t in this.data){const r=this.data[t],i=r.length/e;for(let t=0;t<i;t++)r.push(r[a*i-n*i-i+t])}e=this.data.aPosition.length/3;for(const t in this.data){const r=this.data[t],i=r.length/e;for(let t=0;t<i;t++)r.push(r[a*i-n*i-3*i+t])}super.addElements(r,u-3,r+1),super.addElements(u-3,r+2,r+1)}}fillData(t,n,e,r,i,s,o,a,u){const l=!1!==this.options.top,h=!1!==this.options.side,c=this.feaLineWidth||this.symbol.lineWidth/2*(this.options.EXTENT/this.options.tileSize),f=63*i,d=63*s,p=c*i+n,y=c*s+e;this.Ct(t,n,e,i,s,o,a,u,p,y,f,d),h&&(l&&this.Ct(t,n,e,i,s,o,a,u,p,y,f,d),this.Ct(t,n,e,i,s,o,a,u,p,y,f,d),this.Tt(t,n,e,i,s,o,a,u,p,y,f,d),this.Tt(t,n,e,i,s,o,a,u,p,y,f,d)),this.maxPos=Math.max(this.maxPos,Math.abs(n),Math.abs(e))}Ct(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.tt;t.aPosition.push(n,e,32767),t.aLinesofar.push(a),t.aUp.push(+o),t.aExtrudedPosition.push(u,l,1),t.aExtrude.push(h,c),f&&t.aColor.push(...this.feaColor),d&&t.aLineWidth.push(Math.round(2*this.feaLineWidth)),this.$t&&t.aLineHeight.push(this.feaAltitude)}Tt(t,n,e,r,i,s,o,a,u,l,h,c){const{lineColorFn:f,lineWidthFn:d}=this.tt;t.aPosition.push(n,e,this.feaMinHeight||0),t.aLinesofar.push(a),t.aUp.push(+o),t.aExtrudedPosition.push(u,l,1),t.aExtrude.push(h,c),f&&t.aColor.push(...this.feaColor),d&&t.aLineWidth.push(Math.round(2*this.feaLineWidth)),this.$t&&t.aLineHeight.push(this.feaAltitude)}addElements(t,n,e){const r=!1!==this.options.top,i=!1!==this.options.side,s=(r?1:0)+(i?4:0);if(t*=s,n*=s,this.data.aUp[this.offset+(e*=s)+4]){if(r&&super.addElements(n,t,e),i){const t=r?1:0;super.addElements(n+t,e+t,e+t+2),super.addElements(n+t+1,e+t+1+2,n+t+1+2)}}else if(r&&super.addElements(t,e,n),i){const n=r?1:0;super.addElements(t+n,t+n+2,e+n),super.addElements(t+n+1+2,e+n+1+2,e+n+1)}}createDataPack(t,n){this.maxAltitude=0;const e=super.createDataPack(t,n);if(!e)return e;const{data:r,indices:i}=e;this.getFormat().reduce((t,n)=>(t[n.name]={size:n.width},t),{}).aPickingId={size:1};const{aExtrudedPosition:s,aPosition:o,aLinesofar:a,aUp:u,aExtrude:l,aColor:h,aLineHeight:c,aLineWidth:f}=r,d={},p=ne(s,i);let y,m=!0;for(let t=0;t<p.length;t++)p[t]=-p[t],p[t]%1!=0&&(m=!1);if(!1!==this.options.top&&this.symbol.material&&function(t){for(const n in t)if(n.indexOf("Texture")>=0&&t[n])return!0;return!1}(this.symbol.material)&&(y=function(t,n,e){const r=[];for(let i=0;i<t.length;i+=3){const t=n[i/3];r.push(t/256,e[i/3]?1:0)}return r}(s,a,u)),d.aPosition=o,y&&(d.aTexCoord0=new Float32Array(y)),d.aNormal=m?new Int8Array(p):new Float32Array(p),d.aPickingId=r.aPickingId,d.aExtrude=l,h&&(d.aColor=h),f&&(d.aLineWidth=f),c){const t=fr(this.maxAltitude);d.aLineHeight=new t(c)}const g=[];for(const t in d)g.push(d[t].buffer);return e.data=d,e.buffers=g,e}}const zu=Math.pow(2,16)/1;class Du extends aa{getFormat(){return[...this.getPositionFormat()]}placeVector(t){const n=t.feature,e=3===n.type,r=n.geometry,i=this.elements;e&&(this.elements=[]);const s=this.needAltitudeAttribute()?2:3;for(let t=0;t<r.length;t++)this.offset=this.data.aPosition.length/s,this._t(r[t],n),e&&(this.Et(i),this.elements=[]);e&&(this.elements=i)}_t(t,n){const e=3===n.type;let r=t.length;for(;r>=2&&t[r-1].equals(t[r-2]);)r--;let i,s,o,a=0;for(;a<r-1&&t[a].equals(t[a+1]);)a++;if(!(r<(e?3:2))){this.distance=0,this.vertexLength=0,this.primitiveLength=0,this.e1=this.e2=this.e3=-1,e&&(i=t[r-2]);for(let n=a;n<r;n++)o=e&&n===r-1?t[a+1]:t[n+1],o&&t[n].equals(o)||(i&&(s=i),i=t[n],s&&(this.distance+=i.dist(s)),this.addCurrentVertex(i,this.distance))}}addCurrentVertex(t,n){const e=this.vertexLength++;this.addLineVertex(this.data,t,n),e>=1&&this.addElements(e-1,e),n>zu&&(this.distance=0,this.addCurrentVertex(t,this.distance))}addLineVertex(t,n){this.fillPosition(t,n.x,n.y,n.z||0),this.maxPos=Math.max(this.maxPos,Math.abs(n.x),Math.abs(n.y))}addElements(t,n){super.addElements(this.offset+t,this.offset+n)}Et(t){const n=this.options.EXTENT,e=this.elements;for(let r=0;r<e.length;r+=2)Qe(this.data.aPosition,e[r],e[r+1],3,n)||t.push(e[r],e[r+1])}}const ju=45*Math.PI/100;class Uu extends aa{getFormat(){const{markerFillFn:t}=this.tt;let n;return n="line"===this.symbol.markerRotationAlignment?[...this.getPositionFormat(),{type:Float32Array,width:1,name:"aXYRotation"},{type:Float32Array,width:1,name:"aZRotation"}]:[...this.getPositionFormat()],t&&n.push({type:Uint8Array,width:4,name:"aColor"}),n}placeVector(t){const n=t.feature.properties,{markerFillFn:e}=this.tt;let r;e&&(r=e(this.options.zoom,n)||[255,255,255,255],d(r)?(this.dynamicAttrs.aColor=1,r=[0,0,0,0]):r=Or([],r));const i="line"===this.symbol.markerRotationAlignment,s=this.Ft(t,this.symbol.markerSpacing||250,this.symbol.markerPlacement||"point",i);for(let t=0;t<s.length;t++){const n=s[t];this.fillPosition(this.data,n.x,n.y,n.z),i&&(this.data.aXYRotation.push(n.xyRotation||0),this.data.aZRotation.push(n.zRotation||0)),r&&this.data.aColor.push(...r);const e=Math.max(Math.abs(n.x),Math.abs(n.y));e>this.maxPos&&(this.maxPos=e)}}Ft(t,n,e,r){const i=t.feature,s=this.options.EXTENT;if("line"===e){const t=[];let e=i.geometry;s&&(e=iu(i.geometry,0,0,s,s));for(let r=0;r<e.length;r++){const i=au(e[r],n,ju,null,null,24,1,1,s||1/0);t.push.apply(t,i)}return t}return mu(i,e,s,r,this.options.altitudeToTileScale)}hasElements(){return!1}}\n/*!\n     * from @turf/bboxClip\n     * https://github.com/Turfjs/turf\n     * MIT LICENSE\n     */const Nu=[],Lu=[];function Vu(t,n){var e,r,i,s,o,a,u;for(r=1;r<=8;r*=2){for(e=[],s=!(Hu(i=t[t.length-1],n)&r),o=0;o<t.length;o++){if((u=!(Hu(a=t[o],n)&r))!==s){const t=Ru(i,a,r,n);e.push(void 0!==a.x?new Ut(t[0],t[1]):t)}u&&e.push(a),i=a,s=u}if(!(t=e).length)break}return e}function Ru(t,n,e,r){return Nu[0]=void 0===t.x?t[0]:t.x,Nu[1]=void 0===t.y?t[1]:t.y,t=Nu,Lu[0]=void 0===n.x?n[0]:n.x,Lu[1]=void 0===n.y?n[1]:n.y,n=Lu,8&e?[t[0]+(n[0]-t[0])*(r[3]-t[1])/(n[1]-t[1]),r[3]]:4&e?[t[0]+(n[0]-t[0])*(r[1]-t[1])/(n[1]-t[1]),r[1]]:2&e?[r[2],t[1]+(n[1]-t[1])*(r[2]-t[0])/(n[0]-t[0])]:1&e?[r[0],t[1]+(n[1]-t[1])*(r[0]-t[0])/(n[0]-t[0])]:null}function Hu(t,n){Nu[0]=void 0===t.x?t[0]:t.x,Nu[1]=void 0===t.y?t[1]:t.y;var e=0;return(t=Nu)[0]<n[0]?e|=1:t[0]>n[2]&&(e|=2),t[1]<n[1]?e|=4:t[1]>n[3]&&(e|=8),e}const Wu=[0,0,0,0];class qu extends aa{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,n,e,r,i){const s=new Cr(t,n,e,r),o=s.getPolygonResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:n,polygonOpacityFn:e,uvScaleFn:r,uvOffsetFn:i,polygonPatternUVFn:s}=this.tt;if(this.iconAtlas){const n=this.getIconAtlasMaxValue();t.push({type:n>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return n&&t.push({type:Uint8Array,width:4,name:"aColor"}),e&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),i&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,n){const e=t.feature;this.zt(e.geometry,e,n)}zt(t,n){let e,r,i,s;const{polygonFillFn:o,polygonOpacityFn:a,uvScaleFn:u,uvOffsetFn:l,uvOffsetInMeterFn:h,polygonPatternUVFn:c}=this.tt,f=n.properties;o&&(e=o(this.options.zoom,f)||bt([],255,255,255,255),d(e)?(this.dynamicAttrs.aColor=1,e=Wu):e=Or([],e)),a&&(r=a(this.options.zoom,f),d(r)?(this.dynamicAttrs.aOpacity=1,r=255):(gr(r)&&(r=1),r*=255)),u&&(i=u(this.options.zoom,f),d(i)?(i=[255,255],this.dynamicAttrs.aUVScale=1):(gr(i)&&(i=[1,1]),i=[255*i[0],255*i[1]])),l&&(h&&h(null,f)?s=[0,0]:(s=l(this.options.zoom,f),d(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(gr(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const p=!!this.iconAtlas,y=lu(t,500),m=[0,0],g=[0,0];if(p){const{polygonPatternFileFn:t}=this.tt,n=t?t(null,f):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[n]){const t=this.iconAtlas.positions[n],e=!or(t.displaySize[0])||!or(t.displaySize[1]);m[0]=t.tl[0]+(e?1:0),m[1]=t.tl[1]+(e?1:0),g[0]=t.displaySize[0]-1-(e?2:0),g[1]=t.displaySize[1]-1-(e?2:0)}}let v,b=0;c&&(v=c(this.options.zoom,f));const w=this.needAltitudeAttribute()?2:3,M=[-1,-1,n.extent+1,n.extent+1],x=this.Dt=this.Dt||this.ut.get(),F=this.jt=this.jt||this.ut.get();for(let t=0;t<y.length;t++){const n=y[t],o=this.data.aPosition.length/w;x.setLength(0),F.setLength(0);for(let t=0;t<n.length;t++){let o=n[t];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&(o=Vu(o,M)),0!==o.length){0!==t&&F.push(x.length/3);for(let t=0;t<o.length;t++){const n=o[t].x,a=o[t].y,u=o[t].z||0;if(this.fillPosition(this.data,n,a,u),p&&this.data.aTexInfo.push(m[0],m[1],g[0],g[1]),void 0!==e&&this.data.aColor.push(e[0],e[1],e[2],e[3]),void 0!==r&&this.data.aOpacity.push(r),void 0!==i&&this.data.aUVScale.push(i[0],i[1]),void 0!==s&&this.data.aUVOffset.push(s[0],s[1]),c){if(v){const t=gr(v[2*b])?v[0]:v[2*b],n=gr(v[2*b]+1)?v[1]:v[2*b+1];this.data.aTexCoord.push(t,n)}else this.data.aTexCoord.push(-9999999,-9999999);b++}const l=Math.abs(n),h=Math.abs(a);l>this.maxPos&&(this.maxPos=l),h>this.maxPos&&(this.maxPos=h),x.push(n,a,u)}}}let a=Ne(x,F,3);if(x.length&&!a.length){const t=[];for(let n=0;n<x.length;n+=3)t[n]=x[n],t[n+1]=x[n+2],t[n+2]=x[n+1];if(a=Ne(t,F,3),!a.length){for(let n=0;n<x.length;n+=3)t[n]=x[n+1],t[n+1]=x[n+2],t[n+2]=x[n];a=Ne(t,F,3)}}for(let t=0;t<a.length;t+=3)this.addElements(o+a[t],o+a[t+1],o+a[t+2])}}}const Gu=[{type:Int16Array,width:3,name:"aPosition"}];class Bu extends aa{getFormat(){return Gu}placeVector(t,n){const e=this.Ft(t,n);if(0===e.length)return;const r=this.data,i=this.getAltitude(t.feature.properties);let s=r.aPosition.length/Gu[0].width;for(let t=0;t<e.length;t++){const n=e[t];r.aPosition.push(2*n.x+0,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+0,i),r.aPosition.push(2*n.x+1,2*n.y+1,i),r.aPosition.push(2*n.x+0,2*n.y+1,i),this.addElements(s,s+1,s+2),this.addElements(s,s+2,s+3),s+=4;const o=Math.max(Math.abs(2*n.x+1),Math.abs(2*n.y+1));o>this.maxPos&&(this.maxPos=o)}}Ft(t,n){const{feature:e,symbol:r}=t,i=this.St(t,r),s=e.properties,{markerSpacingFn:o}=this.tt,a=((o?o(null,s):r.markerSpacing)||250)*n;return yu(t,null,null,n,this.options.EXTENT,i,a)}St(t,n){return this.tt.markerPlacementFn?this.tt.markerPlacementFn(this.options.zoom,t.feature.properties):n.markerPlacement}}class Ju extends Pu{constructor(t,n,e){(n=mr({},n)).lineJoin="miter",n.lineCap="butt",super(t,n,e),this.options.radialSegments%2==1&&this.options.radialSegments--}getFormat(){const{lineWidthFn:t,lineColorFn:n,lineOpacityFn:e,linePatternAnimSpeedFn:r,linePatternGapFn:i}=this.tt,s=[...this.getPositionFormat(),{type:Int8Array,size:4,name:"aTubeNormal"},{type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}];if(this.iconAtlas){s.push({type:Int8Array,width:1,name:"aNormalDistance"});const t=this.getIconAtlasMaxValue();s.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return t&&s.push({type:Uint16Array,width:1,name:"aLineWidth"}),n&&s.push({type:Uint8Array,width:4,name:"aColor"}),e&&s.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&s.push({type:Int8Array,width:1,name:"aLinePatternAnimSpeed"}),i&&s.push({type:Int8Array,width:1,name:"aLinePatternGap"}),s}addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,f=this.options.radialSegments/2,{x:d,y:p,z:y}=o.dir,m=function(t,n,e,r,i,s,o,a){ft(Xu,e,r,i),ft(Yu,s,o,0),mt(Zu,Xu,Yu),pt(Yu,Yu),pt(Zu,Zu),Ku[n]||(Ku[n]=[]);const u=Ku[n];for(var l=0;l<n;l++){const t=Math.PI*l/n,e=1-Math.abs(t-0)/(Math.PI/2);u[l]=u[l]||[],Qu(Yu,Zu,u[l],1,t,e*(a?-1:1))}return u}(0,f,d,p,y,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,m,i,c,a)}fillTubeElements(t){const n=this.options.radialSegments/2,e=this.needAltitudeAttribute()?2:3,r=this.data.aPosition.length/e;for(let e=0;e<n;e++){const i=e+r-2*n;let s,o;e===n-1&&t?(s=e+r-2*n+1,o=e+r-2*n-2*n+1):(s=e+r+1,o=e+r+1-2*n),super.addElements(e+r-this.offset,s-this.offset,i-this.offset),super.addElements(i-this.offset,s-this.offset,o-this.offset)}}fillData(t,n,e,r,i,s,o,a){const{lineWidthFn:u,lineColorFn:l,lineOpacityFn:h,linePatternAnimSpeedFn:c,linePatternGapFn:f}=this.tt,d=i.length;for(let s=0;s<d;s++){if(this.fillPosition(t,n,e,r),Mt(i[s],i[s],63),t.aTubeNormal.push(...i[s]),t.aLinesofar.push(o),this.iconAtlas&&(t.aNormalDistance.push(63*a),t.aTexInfo.push(...this.feaTexInfo)),u){const n=Sr(this.options.metric);let e=this.feaLineWidth*n;isNaN(e)&&(e=0),t.aLineWidth.push(Math.round(e))}l&&t.aColor.push(...this.feaColor),h&&t.aOpacity.push(this.feaOpacity),c&&t.aLinePatternAnimSpeed.push(127*(this.feaPatternAnimSpeed||0)),f&&t.aLinePatternGap.push(10*(this.feaLinePatternGap||0))}this.maxPos=Math.max(this.maxPos,Math.abs(n)+1,Math.abs(e)+1)}createDataPack(t,n){const e=super.createDataPack(t,n);return e&&(e.is2D=!1),e}}const Xu=[],Yu=[],Zu=[],Ku={};function Qu(t,n,e,r,i,s){return bt(e,r*(Math.cos(i)*t[0]+Math.sin(i)*n[0]),r*(Math.cos(i)*t[1]+Math.sin(i)*n[1]),r*(Math.cos(i)*t[2]+Math.sin(i)*n[2]),s),e}class tl extends Ju{addHalfVertex(t,n,e,r,i,s,o,a){const{x:u,y:l,z:h}=t,c=1*this.scaledDistance,{x:f,y:d,z:p}=o.dir,y=function(t,n,e,r,i,s,o,a){ft(el,e,r,i),ft(rl,s,o,0),mt(il,el,rl),pt(rl,rl),pt(il,il),_t(nl,t,n);const u=Et(nl)/t,l=Math.atan(n/t);let h=Math.PI/2+(Math.PI/2-l);return sl[0]||(sl[0]=[]),Qu(rl,il,sl[0],u,h,a?1:-1),h+=2*l,sl[1]||(sl[1]=[]),Qu(rl,il,sl[1],u,h,a?1:-1),sl}(this.feaLineWidth,this.feaLineHeight,f,d,p,n,e,i);this.prevVertex&&this.fillTubeElements(i),this.fillData(this.data,u,l,h||0,y,i,c,a)}}const nl=[],el=[],rl=[],il=[],sl=[];class ol{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,n){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=n,this.order.push(t)):(this.data[t]=n,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const n=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),n}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}\n/*!\n     * based on @mapbox/tiny-sdf\n     * https://github.com/mapbox/tiny-sdf\n     * @License BSD 2-Clause\n     */var al=1e20;function ul(t,n,e,r,i,s,o){this.fontSize=t||24,this.buffer=void 0===n?3:n,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=s||"normal",this.fontStyle=o||"normal",this.radius=e||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function ll(t,n,e,r,i,s){for(var o=0;o<n;o++)hl(t,o,n,e,r,i,s);for(var a=0;a<e;a++)hl(t,a*n,1,n,r,i,s)}function hl(t,n,e,r,i,s,o){var a,u,l,h;for(s[0]=0,o[0]=-al,o[1]=al,a=0;a<r;a++)i[a]=t[n+a*e];for(a=1,u=0,l=0;a<r;a++){do{l=(i[a]-i[h=s[u]]+a*a-h*h)/(a-h)/2}while(l<=o[u]&&--u>-1);s[++u]=a,o[u]=l,o[u+1]=al}for(a=0,u=0;a<r;a++){for(;o[u+1]<a;)u++;t[n+a*e]=i[h=s[u]]+(a-h)*(a-h)}}ul.prototype.draw=function(t,n,e){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var r=this.ctx.getImageData(0,0,n,e),i=new Uint8ClampedArray(n*e),s=0;s<n*e;s++){var o=r.data[4*s+3]/255;this.gridOuter[s]=1===o?0:0===o?al:Math.pow(Math.max(0,.5-o),2),this.gridInner[s]=1===o?al:0===o?0:Math.pow(Math.max(0,o-.5),2)}for(ll(this.gridOuter,n,e,this.f,this.v,this.z),ll(this.gridInner,n,e,this.f,this.v,this.z),s=0;s<n*e;s++){var a=Math.sqrt(this.gridOuter[s])-Math.sqrt(this.gridInner[s]);i[s]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let cl=0;class fl{constructor(t,n=15,e){this.entries={},this.Ut={},this.Nt=new ol(2048,(function(){})),this.Lt=t,this.Vt=n,this.Rt=e}getGlyphs(t,n){if(!t||!Object.keys(t).length)return void n(null,{glyphs:null});const e=this.entries,r=t.options;let i=!0;r&&(i=!1!==r.isCharsCompact),i=i||this.Rt;const s=(r,s,a)=>{let u=0,l=0;for(const n in t)if("options"!==n){e[n]=e[n]||{},s[n]=s[n]||{};for(const h in t[n]){if(l++,l<=r)continue;const t=n.split(" "),c=i&&"normal"===t[0]&&!La(+h),f=n+":"+h+":"+c;let d;if(this.Nt.has(f)?d=this.Nt.get(f):(d=this.Ht(e[n],t,h,c),this.Nt.add(f,d),u++),d=dl(d),s[n][h]=d,a.push(d.bitmap.data.buffer),this.Lt&&u>this.Vt)return void this.Lt(o(l,s,a))}}n(null,{glyphs:s,buffers:a})};function o(t,n,e){return()=>{s(t,n,e)}}s(0,{},[])}Ht(t,n,e,r){const i=n[0],s=n[1],o=n.slice(3).join(" ");let a=t.tinySDF,u="normal"!==i?5:2;const l=r?-1:2;if(!a){let n="400";/bolder/i.test(s)?n="1000":/bold/i.test(s)?n="900":/medium/i.test(s)?n="500":/light/i.test(s)&&(n="200"),a=t.tinySDF=new ul(24,u,8,.25,o,n,i)}const h=String.fromCodePoint(e),c=a.ctx.measureText(h),f=Math.round(c.width),d=a.draw(h,f+2*u,24+2*u);if(cl<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+cl++);t&&(t.width=f+2*u,t.height=a.canvas.height,t.getContext("2d").drawImage(a.canvas,0,0))}return{charCode:e,bitmap:{width:f+2*u,height:24+2*u,data:d},metrics:{width:f,height:24,left:1,top:-u,advance:f+u+l}}}}function dl(t){const n={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:n,metrics:mr({},t.metrics)}}var pl=Object.freeze({__proto__:null,clipPolygon:Vu,calculateSignedArea:Ke,getFeaAltitudeAndHeight:nr,generatePickingIndiceIndex:sr,convertRTLText:tu,packPosition:Tr,unpackPosition:function(t,n,e,r){const i=(Math.sign(n)||1)*(Math.abs(n)%zr),s=(Math.sign(e)||1)*(Math.abs(e)%zr),o=Math.floor(Math.abs(n)/zr),a=Math.floor(Math.abs(e)/zr);return t[0]=i,t[1]=s,t[2]=Math.sign(r+1e-5)*(2*o+a)*Dr+r,t},convertGeometry:yr,getPosArrayType:fr,getUnsignedArrayType:dr,getIndexArrayType:cr});const yl={},ml={},gl=[];Object.freeze({__proto__:null,loadSymbolFnTypes:function t(n,e){if(!n)return null;var r=!1;if(Array.isArray(n)){var i,s=[];for(let o=0;o<n.length;o++)(i=t(n[o],e))?(s.push(i),r=!0):s.push(n[o]);return r?s:n}var o={__fn_types_loaded:!0};const a=[];for(const t in n)Fr(n,t)&&a.push(t);const u=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=p(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(n){this["_"+t]=n},configurable:!0,enumerable:!0})},l={},h=function(t,n){Object.defineProperty(o,t,{get:function(){this["__fn_"+t]||(this["__fn_"+t]=Lo(this["_"+t],n));const r=e()[0];l.zoom=r;try{return this["__fn_"+t].evaluateWithoutErrorHandling(l,yl,ml,null,gl)}catch(t){return null}},set:function(n){this["_"+t]=n},configurable:!0,enumerable:!0})};for(let t=0,e=a.length;t<e;t++){const e=a[t];if(d(n[e]))r=!0,o["_"+e]=n[e],u(e);else if(Vo(n[e])){r=!0;const t=Go(e);o["_"+e]=n[e],h(e,t)}else o[e]=n[e]}return r?o:n}});const vl={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textStyle:1,textFaceName:1,textWeight:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1};Object.assign({visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},vl),Object.assign({lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1},vl);new Float32Array([-1e12])[0];const bl="maptalks_ombb";function wl(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p,y,m){const g=n.length,v=i/3;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-o;i+=g;for(let e=2,r=g;e<r;e+=3)t[i+e-2]=n[e-2],t[i+e-1]=n[e-1],t[i+e-0]=n[e]-a;i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,t.trySetLength(i+g),t.copyWithin(i,i-2*g,i-g),i+=g,(e=e||[]).push(g/3);for(let n=0;n<e.length;n++){Ml(v+(e[n-1]||0),v+e[n],t,g/3,u,r,l,h,c,f,s,d,p,y,m)}return i}function Ml(t,n,e,r,i,s,o,a,u,l,h,c,f,d,p){const y=s.length;let m,g;for(let o=t,a=n;o<a-1;o++)m=o,g=o+1,i!==1/0&&at(e,m,g,i)||((o-t)%2==1&&(m+=2*r,g+=2*r),p?(s.push(m+r,g,m),s.push(g+r,g,m+r)):(s.push(m+r,m,g),s.push(g,g+r,m+r)));o&&function(t,n,e,r,i,s,o,a,u,l,h){let c,f=0,d=0,p=0,y=0;const m=h?[1,3,4]:[2,3,4];for(let h=s.length-1;h>=0;h--){const g=s[h],v=3*g+1,b=3*g+2,w=i[3*g],M=i[v],x=i[b];f||d||(f=Math.max(i[b],i[3*s[h-3]+2]),d=Math.min(i[b],i[3*s[h-3]+2]),c=f-d);let F=p;const A=h%6;0===t?(5===A&&(y=jt(i,s,h,w,M)),F=A===m[0]||A===m[1]||A===m[2]?p:p+y):1===t&&(A===m[0]||A===m[1]||A===m[2]?F=0:5===A?(y=jt(i,s,h,w,M),F=y):F=y);const k=F/u*(1/(100*l))/o;let P;P=1===n?x===f?1:0:"bottom"===e?x===f?c/100/a:0:x===f?0:-c/100/a,r[2*g]=k,r[2*g+1]=P,0===A&&(p+=y)}}(a,u,l,h,e,s.slice(y,s.length),c[0],c[1],f,d,p)}function xl(t){const n=[t[0]];let e=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===e[0]&&t[r][1]===e[1]&&t[r][2]===e[2]||n.push(t[r]):t[r].x===e.x&&t[r].y===e.y&&t[r].z===e.z||n.push(t[r]),e=t[r];return n}const Fl=Qo.getInstance();function Al(t,n,e,r,i,s,o,a,u,l,h,c,f,m,g,v){void 0===n.top&&(n.top=!0),void 0===n.side&&(n.side=!0),Fl.reset();const{altitudeScale:b,altitudeProperty:w,defaultAltitude:M,heightProperty:F,minHeightProperty:A,defaultHeight:k,tangent:_,uv:O,topUVMode:E,sideUVMode:I,sideVerticalUVMode:$,top:C,side:T,textureYOrigin:z,topThickness:D}=n,j=!!v,U=function(t,n,{altitudeScale:e,altitudeProperty:r,defaultAltitude:i,heightProperty:s,minHeightProperty:o,defaultHeight:a},{center:u,side:l,top:h,topThickness:c,uvOrigin:f,uv:d,uvSize:p,topUVMode:y,sideUVMode:m,sideVerticalUVMode:g,textureYOrigin:v,tileRatio:b,centimeterToPoint:w,verticalCentimeterToPoint:M,positionType:F,res:A,glScale:k,projectionCode:S},_,O){let E=n/t[0].extent;n===1/0&&(E=1);const I=n===1/0,$=O.get(),C=O.get(),T=O.get(),z=O.get(),D=O.get(),j=O.get(),U=O.get(),N=!!d,L=!!h,V=!!l,R=N?O.get():null;function H(t,e,r,i,s,o){let a=e;if(L){const i=Ne(z,r,3);if(0===i.length)return e;if(P(D,z),e+=z.length,o)for(let n=2,e=i.length;n<e;n+=3)i[n]+=t/3,i[n-1]+=t/3,i[n-2]+=t/3;else{let n;for(let e=2,r=i.length;e<r;e+=3)n=i[e-1],i[e-1]=i[e]+t/3,i[e]=n+t/3,i[e-2]+=t/3}P(j,i),N&&zt(y||0,t,e,R,D,f,w,b,p[0],p[1],s,A,k,S,u),c>0&&!V&&(e=wl(D,z,r,j,e,R,0,c,n,N,m||0,g||0,v,p,b,M,o)),U.setLength(e/3),U.fill(1,a/3,e/3)}if(V){L&&(c=0),a=e,e=wl(D,z,r,j,e,R,c,i,n,N,m||0,g||0,v,p,b,M,o),U.setLength(e/3);const t=z.length/3;U.fill(1,a/3,a/3+t),U.fill(0,a/3+t,a/3+2*t),U.fill(1,a/3+2*t,a/3+3*t),U.fill(0,a/3+3*t,e/3)}return e}let W=0,q=0;const G=[-1,-1,n+1,n+1];let B=0,J=t.length;x(_)&&(B=_,J=_+1);let X=0,Y=!1;const Z=O.get();for(;B<J;B++){const u=t[B],l=u.id;x(l)&&(Math.abs(l)>X&&(X=Math.abs(l)),l<0&&(Y=!0));const h=u.geometry,c=u.properties[bl];let f=Array.isArray(c&&c[0]&&c[0][0])?c[0]:c;const{altitude:d,height:p}=pl.getFeaAltitudeAndHeight(u,e,r,i,s,a,o);W=Math.max(Math.abs(d),W);const y=D.length;let m=0,g=q;Z.setLength(0),z.setLength(0);const v=pl.calculateSignedArea(h[0])<0;for(let t=0,e=h.length;t<e;t++){let r=h[t];v&&(r=r.reverse()),r=xl(r);const i=pl.calculateSignedArea(r)<0;if(!i&&t>0&&(m++,f=c&&c[m],q=H(g,q,Z,p*E,f,I),z.setLength(0),Z.setLength(0),g=q),n!==1/0&&(r=pl.clipPolygon(r,G)),!r.length){t===e-1&&(q=H(g,q,Z,p*E,f,I));continue}const s=r.length;Array.isArray(r[0])?r[0][0]===r[s-1][0]&&r[0][1]===r[s-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[s-1].x&&r[0].y===r[s-1].y||r.push(r[0]),i&&Z.push(z.length/3),ot(z,z.length,r,E,d,!1,F),t===e-1&&(q=H(g,q,Z,p*E,f,I))}const b=D.length-y,w="__fea_idx".trim();for(let t=0;t<b/3;t++)C.push(void 0===u[w]?B:u[w]),$.push(B),x(l)&&T.push(l)}const K=pl.getUnsignedArrayType(C.length?C[C.length-1]:0),Q={maxAltitude:W,vertices:D,verticeTypes:U,indices:j,pickingIds:Qo.createTypedArray(C,K),featureIndexes:$};if(T.length){const t=Y?pl.getPosArrayType(X):pl.getUnsignedArrayType(X);Q.featureIds=Qo.createTypedArray(T,t)}else Q.featureIds=[];return R&&(R.setLength(D.length/3*2),Q.uvs=R),Q}(t,e,{altitudeScale:b,altitudeProperty:w,defaultAltitude:M||0,heightProperty:F,minHeightProperty:A,defaultHeight:k||0},{center:v,top:C,side:T,topThickness:10*D||0,uv:O||_,uvSize:[i,i],uvOrigin:r,topUVMode:E,sideUVMode:I,sideVerticalUVMode:$,textureYOrigin:z,tileRatio:a,centimeterToPoint:u,verticalCentimeterToPoint:l,positionType:g,res:s,glScale:o,projectionCode:f},m,Fl),N=[],L=U.vertices.length/3,V=pl.getIndexArrayType(L),R=Qo.createTypedArray(U.indices,V);delete U.indices,N.push(R.buffer,U.pickingIds.buffer);const H=_?Fl.get():new Float32Array(3*L);H.setLength&&H.setLength(3*L);const W=ne(U.vertices,R,H);let q=!0;for(let t=0;t<W.length;t++){j||(W[t]=-W[t]);const n=W[t]%1;1-Math.abs(n)>1e-6?q=!1:0!==n&&(W[t]=Math.round(W[t]))}if(U.normals=W,_){let t=Fl.get();t.setLength(4*L),t=function(t,n,e,r,i){const s=t.length/3,o=i||new Array(4*s),a=[],u=[];for(let t=0;t<s;t++)a[t]=[0,0,0],u[t]=[0,0,0];const l=[0,0,0],h=[0,0,0],c=[0,0,0],f=[0,0],d=[0,0],p=[0,0],y=[0,0,0],m=[0,0,0];function g(n,r,i){he(l,t,3*n),he(h,t,3*r),he(c,t,3*i),ce(f,e,2*n),ce(d,e,2*r),ce(p,e,2*i);const s=h[0]-l[0],o=c[0]-l[0],g=h[1]-l[1],v=c[1]-l[1],b=h[2]-l[2],w=c[2]-l[2],M=d[0]-f[0],x=p[0]-f[0],F=d[1]-f[1],A=p[1]-f[1],k=1/(M*A-x*F);ft(y,(A*s-F*o)*k,(A*g-F*v)*k,(A*b-F*w)*k),ft(m,(M*o-x*s)*k,(M*v-x*g)*k,(M*w-x*b)*k),dt(a[n],a[n],y),dt(a[r],a[r],y),dt(a[i],a[i],y),dt(u[n],u[n],m),dt(u[r],u[r],m),dt(u[i],u[i],m)}for(let t=0,n=r.length;t<n;t+=3)g(r[t+0],r[t+1],r[t+2]);const v=[],b=[],w=[],M=[];let x,F,A;function k(t){he(w,n,3*t),ct(M,w),F=a[t],ct(v,F),gt(v,v,function(t,n,e){return t[0]=n[0]*e,t[1]=n[1]*e,t[2]=n[2]*e,t}(w,w,yt(w,F))),pt(v,v),mt(b,M,F),A=yt(b,u[t]),x=A<0?-1:1,o[4*t]=v[0],o[4*t+1]=v[1],o[4*t+2]=v[2],o[4*t+3]=x}for(let t=0,n=r.length;t<n;t+=3)k(r[t+0]),k(r[t+1]),k(r[t+2]);return o}(U.vertices,U.normals,U.uvs,R,t),t=function(t,n){const e=new Float32Array(n.length),r=[],i=[],s=[];for(let o=0;o<n.length;o+=4){const a=o/4*3;ft(i,t[a]||0,t[a+1]||0,t[a+2]||0),bt(r,n[o]||0,n[o+1]||0,n[o+2]||0,n[o+3]||0),Qn(s,i,r),vt(e.subarray(o,o+4),s)}return e}(U.normals,t),U.tangents=t,N.push(t.buffer),delete U.normals}if(U.normals&&(q&&(U.normals=Qo.createTypedArray(U.normals,Int8Array)),N.push(U.normals.buffer)),U.uvs){const t=U.uvs;U.uvs=Qo.createTypedArray(t,Float32Array),N.push(U.uvs.buffer)}if(v){const t=U.vertices;for(let n=0;n<t.length;n+=3)t[n]-=v[0],t[n+1]-=v[1]}const G=g||pl.getPosArrayType(Math.max(512,U.maxAltitude)),B=function(t,n,e,r){const i={},s={};if(S(n.polygonFill)){let o=y(n.polygonFill);const a=new Uint8Array(4*r.length);a.fill(255);for(let n=0;n<r.length;n++){const s=t[r[n]],u=s.properties||{};u.$layer=s.layer,u.$type=s.type;let l=o(e,u);d(l)&&(i.aColor=1,o=y(l),l=o(e,u)),delete u.$layer,delete u.$type,$r.normalizeColor(kl,l),a[4*n]=kl[0],a[4*n+1]=kl[1],a[4*n+2]=kl[2],a[4*n+3]=kl[3]}s.aColor=a}if(S(n.polygonOpacity)){let o=p(n.polygonOpacity);const a=new Uint8Array(r.length);a.fill(255);for(let n=0;n<r.length;n++){const s=t[r[n]],u=s.properties||{};u.$layer=s.layer,u.$type=s.type;let l=o(e,u);d(l)&&(i.aOpacity=1,o=y(l),l=o(e,u)),delete u.$layer,delete u.$type,a[n]=255*l}s.aOpacity=a}return s.dynamicAttributes=i,s}(t,h,c,U.featureIndexes),J=function(t,n,e,r,i){const s=[[],[]],o=S(r.topPolygonFill),a=S(r.bottomPolygonFill),u=[255,255,255,255];if(o||a){let l=o&&y(r.topPolygonFill),h=a&&y(r.bottomPolygonFill),c=null,f=null,p=null,m=null;for(let r=0;r<n.length;r++){if(1===t[r]&&!o||0===t[r]&&!a)continue;const g=1===t[r];if(g&&n[r]===c){t[r]=p;continue}if(!g&&n[r]===f){t[r]=m;continue}const v=e[n[r]],b=v.properties||{};b.$layer=v.layer,b.$type=v.type;let w=g?l:h,M=w(i,b);d(M)&&(w=y(M),M=w(i,b)),delete b.$layer,delete b.$type,$r.normalizeColor(kl,M),wt(kl,kl,u);let x=Pl(s,kl);x<0&&(x=s.length,s.push(vt([],kl))),t[r]=x,g?(c=n[r],p=x):(f=n[r],m=x)}}return s.slice(2)}(U.verticeTypes,U.featureIndexes,t,h,c),X={data:{data:{aVertexColorType:J.length<=252?Qo.createTypedArray(U.verticeTypes,Uint8Array):Qo.createTypedArray(U.verticeTypes,Uint16Array),aPosition:Qo.createTypedArray(U.vertices,G),aNormal:U.normals,aTexCoord0:U.uvs,aTangent:U.tangents,aPickingId:U.pickingIds},indices:R,properties:{maxAltitude:U.maxAltitude},dynamicAttributes:B.dynamicAttributes,vertexColors:J},buffers:N};return U.featureIds.length?(X.data.featureIds=U.featureIds,N.push(X.data.featureIds.buffer)):X.data.featureIds=[],B.aColor&&(X.data.data.aColor=B.aColor,X.buffers.push(B.aColor.buffer)),B.aOpacity&&(X.data.data.aOpacity=B.aOpacity,X.buffers.push(B.aOpacity.buffer)),X.buffers.push(X.data.data.aPosition.buffer),X.data.pickingIdIndiceMap=pl.generatePickingIndiceIndex(X.data.data.aPickingId,X.data.indices),X}const kl=[];function Pl(t,n){for(let e=0;e<t.length;e++)if(xt(n,t[e]))return e;return-1}function Sl(t,n,e,r,{altitudeScale:i,altitudeProperty:s,defaultAltitude:o,heightProperty:a,minHeightProperty:u,defaultHeight:l,bottom:h}){const c=h,f=n/t[0].extent,p=2*function(t,n){let e=0;for(let r=0,i=t.length;r<i;r++){const i=t[r];if(x(i.geometry[0][0])){const t=3*i.geometry.length;e+=n?2*t-6:t}else for(let t=0,r=i.geometry.length;t<r;t++){let r=3*i.geometry[t].length;3===i.type&&(r-=3),e+=n?2*r-6:r}}return e}(t)+3*t.length*2,y=[],m=new Int16Array(p),g=new Uint8Array(m.length/3*4);d(e)&&(e=Bo.compileFilter(e));const v=[];function b(t,e,r){const i=e-t,s=m.subarray(t,e),o=m.subarray(e,e+i);o.set(s);for(let t=2,n=o.length;t<n;t+=3)o[t]=s[t]-r;const a=t/3,u=i/3;let l,h;for(let t=a,e=u+a;t<e;t++)t<e-1?(l=t,h=t+1):(l=t,h=a),at(m,l,h,n)||(v.push(l,h),c&&v.push(l+u,h+u),_l(m,l,n)||v.push(l,l+u));return e+i}let w=0,M=0;const F="__fea_idx".trim(),A=[];for(let n=0,h=t.length;n<h;n++){const h=t[n],c=h.geometry;if(e){let t;t="function"==typeof e?e(h&&h.properties):e,$r.normalizeColor(A,t)}else ft(A,255,255,255);const d=w/3*4,{altitude:p,height:x}=pl.getFeaAltitudeAndHeight(h,i,s,o,a,l,u);M=Math.max(Math.abs(p),M);let k=w;for(let t=0,n=c.length;t<n;t++){let n=c[t];const e=n.length;n[0][0]===n[e-1][0]&&n[0][1]===n[e-1][1]&&(n=n.slice(0,e-1)),w=ot(m,k,n,f,p),w=b(k,w,x*f),k=w}const P=k/3*4;for(let t=d;t<P;t+=4)g[t]=A[0],g[t+1]=A[1],g[t+2]=A[2],g[t+3]=255*(r||1);const S=v.length-y.length;for(let t=0;t<S;t++)y.push(h[F])}const k=v.reduce((t,n)=>Math.max(t,n),0),P=new(pl.getIndexArrayType(k))(v),S=pl.getUnsignedArrayType(t.length);return{aPosition:new(pl.getPosArrayType(Math.max(512,M)))(m),indices:P,aPickingId:new S(y),aColor:g}}function _l(t,n,e){const r=t[3*n],i=t[3*n+1];return r<0||r>e||i<0||i>e}function Ol(t,n,e,r){const i=Sl(t,n,e.lineColor,e.lineOpacity,r),s=[i.aPosition.buffer,i.indices.buffer,i.aPickingId.buffer],o=i.indices;return delete i.indices,{data:{data:i,indices:o},buffers:s}}let El=!1;try{const t=new OffscreenCanvas(1,1);t.getContext("2d").fillText("hello",0,0),El=!0}catch(t){El=!1}var Il=El;const $l="__original_properties",Cl="__fn-type_properties";class Tl{constructor(t,n,e,r,i){this.id=t,this.options=n,this.upload=e,this.Wt(n.style),this.requests={},this.Nt=r,this.qt=0,this.loadings=i}updateStyle(t,n){this.options.style=t,this.qt=t.styleCounter,this.Wt(t),n()}updateOptions(t,n){this.options=w(this.options,t),n()}loadTile(t,n){const e=this.loadings,r=t.tileInfo.url,i=this.options.debugTile;if(i){const{x:e,y:r,z:s}=t.tileInfo;let o=!1;for(let t=0;t<i.length;t++)if(e===i[t].x&&r===i[t].y&&s===i[t].z){o=!0;break}if(!o)return void n()}if(e[r])return void e[r].push({context:t,callback:n,ref:this});e[r]=[{context:t,callback:n,ref:this}];const s=this.options.featureIdProperty;this.requests[r]=this.getTileFeatures(t,(n,i,o,a)=>{const u=e[r];if(delete e[r],this.checkIfCanceled(r))return delete this.requests[r],void this.Gt(u,null,{canceled:!0});if(delete this.requests[r],(this.options.debug||s)&&i)for(let n=0;n<i.length;n++)if(this.options.debug&&(i[n]._debug_info={index:n,id:i[n].id,tileId:t.tileInfo.id}),s){const t=A(s)?s[i[n].layer]:s,e=i[n].properties;i[n].id=e&&e[t]||null}if(n)this.Gt(u,n);else if(i&&i.length){if(u)for(let t=0;t<u.length;t++)this.Bt.call(u[t].ref,u[t].context,u[t].callback,r,o,i,a)}else this.Gt(u)})}Bt(t,n,e,r,i,s){this.Jt(r,i,t).then(e=>{e.canceled?n(null,{canceled:!0}):(e.data.style=t.styleCounter,s&&w(e.data,s),n(null,e.data,e.buffers))}).catch(t=>{n(t)})}abortTile(t,n){delete this.requests[t],this.Xt(t),n()}Xt(t){const n=this.loadings[t];if(n)for(let t=0;t<n.length;t++)n[t].callback(null,{canceled:!0});delete this.loadings[t]}Gt(t,n,e){if(t)for(let r=0;r<t.length;r++)t[r].callback(n,e)}checkIfCanceled(t){return!this.requests[t]}onRemove(){this.loadings={},delete this.Nt,this.requests={}}fetchIconGlyphs(t,n,e){if(this.options.workerGlyph&&Il){const r=[];if(t&&Object.keys(t).length){const n=new Promise(n=>{this.upload("fetchIconGlyphs",{icons:t},null,(t,e)=>{n({err:t,iconData:e})})});r.push(n)}if(n&&Object.keys(n).length){const t=new Promise(t=>{this.Yt||(this.Yt=new fl),this.Yt.getGlyphs(n,(n,e)=>{t({err:n,glyphData:e})})});r.push(t)}Promise.all(r).then(t=>{const n={icons:null,glyphs:null};for(let r=0;r<t.length;r++){if(t[r].err)return void e(t[r].err);t[r].iconData?n.icons=t[r].iconData.icons:t[r].glyphData&&(n.glyphs=t[r].glyphData.glyphs)}return n}).then(t=>{e(null,t)})}else this.upload("fetchIconGlyphs",{icons:t,glyphs:n},null,e)}Jt(t,n,e){if(!n.length)return Promise.resolve({data:null,buffers:[]});const{glScale:r,tileInfo:i}=e,s=!this.options.style.style.length&&!this.options.style.featureStyle.length;let o=this.pluginConfig.slice(0);s&&(o=this.Zt(t)),this.featurePlugins&&P(o,this.featurePlugins);const a={};for(let t=0;t<o.length;t++)Vl(n,e.tileInfo.z,o[t],a);const u=[],l=[];for(let t=0;t<n.length;t++){const e=n[t],r=a[t];if(r){l.fill(null);let t=0;for(const n in r){let i=0;const s=r[n].values();for(const t of s){let r=l[i];r||(r=ql(e),l[i]=r),r.properties[n]=t,i++}i>t&&(t=i)}for(let n=0;n<t;n++)u.push(l[n])}else u.push(e)}const h=(n=u)[0].extent,c=i.z,f={x:i.extent2d.xmin*r,y:i.extent2d.ymax*r},d=[],p=[],y=[],m=this.options,g=[],v={},b=[Promise.resolve(e.styleCounter)];let M=0,x=-1;const F=[];let A=!1;for(let t=0;t<o.length;t++){x++;const r=o[t];r.type!==M&&(x=0,M=r.type);const a=0===r.type?d:p;if(r.symbol&&!1===r.symbol.visible){a[x]=null;continue}Jl(r.symbol,F,t),A=A||F[t]&&F[t].size>0;const{tileFeatures:u,tileFeaIndexes:l}=this.Kt(c,r.type,r.filter,n,v,t);if(!u.length){a[x]=null;continue}const m=l[l.length-1],k=pl.getIndexArrayType(m);a[x]={styledFeatures:new k(l)},y.push({idx:t,typeIdx:x}),g.push(a[x].styledFeatures.buffer);const P=w({},e,{extent:h,zoom:c,tilePoint:f});if(this.options.debugTile){const t=this.options.debugTile;for(let n=0;n<t.length;n++){const{x:e,y:r,z:s}=t[n];if(i.x===e&&i.y===r&&i.z===s){P.debugIndex=t[n].index;break}}}let S=this.Qt(u,r,P);s&&(S=S.then(t=>{if(!t)return null;if(t.data)t.data.layer=u[0].layer;else if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&t[n].data&&(t[n].data.layer=u[0].layer);return t})),b.push(S)}return Promise.all(b).then(([e,...r])=>{function i(t,n){if(void 0===t.data.ref&&(t.data.type=o[y[n].idx].renderPlugin.dataConfig.type,t.data.filter=o[y[n].idx].filter.def,t.buffers&&t.buffers.length))for(let n=0;n<t.buffers.length;n++)g.push(t.buffers[n])}if(e!==this.qt)return{canceled:!0};for(let t=0;t<r.length;t++){if(!r[t])continue;const n=r[t],e=0===o[y[t].idx].type?d:p;if(Array.isArray(n)){const r=[];for(let e=0;e<n.length;e++)n[e]&&(i(n[e],t),(void 0===n[e].data.ref||n[n[e].data.ref])&&r.push(n[e].data));r.length&&(e[y[t].typeIdx].data=r)}else i(n,t),e[y[t].typeIdx].data=n.data}const s={},a=t;if(m.features||m.schema||A){let t,e=!1;for(let r=0,i=n.length;r<i;r++)if(t=n[r],a[t.layer].properties||(a[t.layer].properties=jl(t.properties)),t&&(m.features||A&&v[r]))if("id"===m.features)s[r]=t.id;else{m.pickingGeometry||delete t.geometry,delete t.extent,delete t.properties.$layer,delete t.properties.$type,delete t.__index;const n=t.originalFeature;if(n){const n=t.properties,e=w({},t.originalFeature);delete n[$l],e.customProps=w({},n),t=e}const i=w({},t);if(A&&v[r]&&(!m.features||"transient"===m.features)){const i=v[r];for(let r=0;r<i.length;r++){const i=F[r];i&&i.forEach(r=>{const i=n?n.properties:t.properties;i[Cl]||(i[Cl]=new Set),i[Cl].add(r),e=!0})}}s[r]=i}if(e)for(const t in s){const n=s[t],e=n.properties[Cl];if(e){delete n.properties[Cl],"transient"===m.features&&(n.fnTypeProps=w({},n.properties));for(const t in n.properties)e.has(t)||("transient"===m.features?delete n.fnTypeProps[t]:delete n.properties[t])}}}return{data:{schema:a,data:d,featureData:p,extent:h,features:s},buffers:g}}).catch(t=>{console.error(t)})}Qt(t,n,e){let r=t;const i=n.renderPlugin.dataConfig,s=n.symbol,o=this.options.tileSize,{extent:a,glScale:u,zScale:l,zoom:h,tilePoint:c,centimeterToPoint:f,verticalCentimeterToPoint:d}=e,p=a/o,y=i.type,m=e.debugIndex;let g=w({},i,{EXTENT:a,zoom:h,debugIndex:m,features:this.options.features});if("3d-extrusion"===y){const t=Ul(s);t&&(i.uv=1,2===t&&(i.tangent=1));const n=this.options.projectionCode,o=s.material&&s.material.textureWidth||23.25;return Promise.all([Promise.resolve(Al(r,i,a,c,o,e.tileInfo.res,u,a/this.options.tileSize,f,d,s,h,n,m))])}if("3d-wireframe"===y)return Promise.all([Promise.resolve(Ol(r,a,s,i))]);if("point"===y){g=w(g,{requestor:this.fetchIconGlyphs.bind(this),altitudeToTileScale:l*a/this.options.tileSize/u});const t=bu.splitPointSymbol(s),n=aa.genFnTypes(t[0]);return bu.needMerge(t[0],n,h)&&(r=bu.mergeLineFeatures(r,t[0],n,h)),Promise.all(t.map((t,e)=>(0===e?g.fnTypes=n:delete g.fnTypes,new bu(r,t,g).load(p))))}if("native-point"===y){const t=l*a/this.options.tileSize/u;return g.altitudeToTileScale=t,Nl(r,s,g,Uu,a/o)}if("line"===y)return g=w(g,{requestor:this.fetchIconGlyphs.bind(this),tileRatio:p}),Nl(r,s,g,Pu);if("native-line"===y)return Nl(r,s,g,Du);if("fill"===y)return g=w(g,{requestor:this.fetchIconGlyphs.bind(this)}),Nl(r,s,g,qu);if("line-extrusion"===y){delete s.lineGradientProperty,s.lineJoin="miter",s.lineCap="butt";const t=Ul(s);if(t&&(i.uv=1,2===t&&(i.tangent=1)),g=w(g,{tileSize:o,zScale:l,glScale:u}),t){const t=[];if(!1!==i.top){const n=w({},g);n.side=!1,t.push(new Tu(r,s,n))}return!1!==i.side&&(g.side=!0,g.top=!1,t.push(new Tu(r,s,g))),Promise.all(t.map(t=>t.load()))}return Promise.all([new Tu(r,s,g).load()])}if("circle"===y)return Nl(r,s,g,Bu);if("round-tube"===y||"square-tube"===y){const t="round-tube"===y?Ju:tl;return g=w(g,{requestor:this.fetchIconGlyphs.bind(this),radialSegments:"round-tube"===y?i.radialSegments||8:4,centimeterToPoint:f,verticalCentimeterToPoint:d,tileRatio:p,isTube:!0}),Nl(r,s,g,t)}return Promise.resolve([])}Kt(t,n,e,r,i,s){const o="__fea_idx".trim(),a=[],u=[],l=r.length;for(let h=0;h<l;h++)if((1===n||void 0===r[h].id||!this.styledFeatures[r[h].id])&&((!e.def||"default"===e.def)&&!i[h]||!0===e.def||e.def&&(void 0!==e.def.condition||Array.isArray(e.def))&&e(r[h],t))){const t=r[h];if(void 0===t[o]&&(t[o]=h),i[h]||(i[h]=[]),i[h].push(s),u.push(t),a.push(h),1===n)break}return{tileFeatures:u,tileFeaIndexes:a}}Wt(t){const{style:n,featureStyle:e}=t,r={};e.forEach(t=>{Array.isArray(t.id)?(t.id.forEach(t=>{r[t]=1}),t.filter=["in","$id",...t.id]):(r[t.id]=1,t.filter=["==","$id",t.id])});const i=Bo.compileStyle(n);for(let t=0;t<n.length;t++)i[t].filter&&(i[t].filter.def=n[t].filter?n[t].filter.value||n[t].filter:void 0),i[t].type=0;const s=[],o=Bo.compileStyle(e);for(let t=0;t<e.length;t++)o[t].type=1,o[t].filter.def=e[t].filter?e[t].filter.value||e[t].filter:void 0,o[t].renderPlugin&&s.push(o[t]);this.pluginConfig=i,this.featurePlugins=s,this.styledFeatures=r}Zt(t){let n=this.tn;this.tn||(n=this.tn={});const e=["","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"],r=[];for(const i in t){const s=i;if(!n[i]){const r=[];for(let n=0;n<t[i].types.length;n++){const o=t[i].types[n],a=["all",["==","$layer",s],["==","$type",e[o]]],u={filter:zn(a),renderPlugin:zl(o),symbol:Dl(o)};u.filter.def=a,u.type=0,r.push(u)}n[s]=r}r.push(...n[s])}return r}}function zl(t){switch(t){case 1:return{type:"native-point",dataConfig:{type:"native-point",only2D:!0}};case 2:return{type:"native-line",dataConfig:{type:"native-line",only2D:!0}};case 3:return{type:"fill",dataConfig:{type:"fill",only2D:!0}}}return null}function Dl(t){switch(t){case 1:return{markerFill:"#f00",markerSize:10};case 2:return{lineColor:"#fff"};case 3:return{polygonFill:"#00f",polygonOpacity:.4}}return null}function jl(t){if(Array.isArray(t)||!A(t))return{};const n={};for(const e in t){const r=t[e];M(r)?n[e]="string":x(r)?n[e]="number":!0===r||!1===r?n[e]="boolean":Array.isArray(r)?n[e]="array":n[e]="object"}return n}function Ul(t){if(!t)return 0;let n=0;for(const e in t){if(("normalTexture"===e||"bumpTexture"===e)&&t[e])return 2;if(e.indexOf("Texture")>0&&t[e])n=1;else if(A(t[e])){const r=Ul(t[e]);if(2===r)return r;1===r&&(n=1)}}return n}function Nl(t,n,e,r,i){const s={},o=Array.isArray(n)?n:[n];let a=-1;for(let t=0;t<o.length;t++)s[t]=Ll(o[t]),!s[t]&&o[t]&&-1===a&&(a=t);const u=[];for(let n=0;n<o.length;n++)o[n]&&(o[n].index={index:n},s[n]||n===a?u.push(new r(t,o[n],e).load(i)):u.push({data:{ref:a,symbolIndex:{index:n}}}));return Promise.all(u)}function Ll(t){if(!t)return 0;for(const n in t)if(S(t[n]))return 1;return 0}function Vl(t,n,e,r){const i=e.customProperties;if(!i)return t;if(i)for(let t=0;t<i.length;t++)i[t].fn=Bo.compileFilter(i[t].filter);for(let e=0;e<i.length;e++)for(let s=0,o=t.length;s<o;s++)if(i[e].fn(t[s],n))for(const t in i[e].properties){const n=i[e].properties[t];k(n)||(r[s]||(r[s]={}),r[s][t]||(r[s][t]=new Set),r[s][t].add(n))}}const Rl={get:(t,n)=>n in t?t[n]:t.originalFeature[n],has:(t,n)=>n in t||n in t.originalFeature},Hl={get:function(t,n){return n in t?t[n]:t[$l][n]},has:(t,n)=>n in t||n in t[$l]},Wl={};function ql(t){const n={};n.originalFeature=t;const e=new Proxy(n,Rl);return e.properties=new Proxy({},Hl),e.properties[$l]=t.properties||Wl,e}function Gl(t,n,e){t[n]||(t[n]=new Set),t[n].add(e)}const Bl=[];function Jl(t,n,e){if(!t)return Bl;for(const r in t){if(!t[r]||!$r.checkIfZoomFnTypeSymbol(r))continue;if(S(t[r]))Gl(n,e,t[r].property);else{if("lineGradientProperty"===r){Gl(n,e,t[r]);continue}if("textName"===r)if(M(t[r])){const i=ya.resolveVarNames(t[r]);if(i)for(let t=0;t<i.length;t++)Gl(n,e,i[t])}else if(Bo.isExpression(t[r])){const i=[];ya.resolveExpVarNames(i,t[r]);for(let t=0;t<i.length;t++)Gl(n,e,i[t])}}const i=t[r].stops;if(i&&i.length)for(let t=0;t<i.length;t++)S(i[t][1])&&Gl(n,t,i[t][1].property)}return n[e]}function Xl(t,n){Yl(t.geometry,n)}function Yl(t,n){if(t)switch(t.type){case"Point":Zl(t.coordinates,n);break;case"MultiPoint":case"LineString":Kl(t.coordinates,n);break;case"MultiLineString":!function(t,n){for(let e=0,r=t.length;e<r;e++)Kl(t[e],n)}(t.coordinates,n);break;case"Polygon":Ql(t.coordinates,n);break;case"MultiPolygon":!function(t,n){for(let e=0,r=t.length;e<r;e++)Ql(t[e],n)}(t.coordinates,n);break;case"GeometryCollection":const e=t.geometries.length;for(let r=0;r<e;r++)Yl(t.geometries[r],n)}}function Zl(t,n){n[0]=Math.min(n[0],t[0]),n[1]=Math.min(n[1],t[1]),n[2]=Math.max(n[2],t[0]),n[3]=Math.max(n[3],t[1])}function Kl(t,n){for(let e=0,r=t.length;e<r;e++)Zl(t[e],n)}function Ql(t,n){t.length&&Kl(t[0],n)}function th(t,n,e,r,i){!function t(n,e,r,i,s){for(;i>r;){if(i-r>600){var o=i-r+1,a=e-r+1,u=Math.log(o),l=.5*Math.exp(2*u/3),h=.5*Math.sqrt(u*l*(o-l)/o)*(a-o/2<0?-1:1),c=Math.max(r,Math.floor(e-a*l/o+h)),f=Math.min(i,Math.floor(e+(o-a)*l/o+h));t(n,e,c,f,s)}var d=n[e],p=r,y=i;for(nh(n,r,e),s(n[i],d)>0&&nh(n,r,i);p<y;){for(nh(n,p,y),p++,y--;s(n[p],d)<0;)p++;for(;s(n[y],d)>0;)y--}0===s(n[r],d)?nh(n,r,y):(y++,nh(n,y,i)),y<=e&&(r=y+1),e<=y&&(i=y-1)}}(t,n,e||0,r||t.length-1,i||eh)}function nh(t,n,e){var r=t[n];t[n]=t[e],t[e]=r}function eh(t,n){return t<n?-1:t>n?1:0}class rh{constructor(t=9){this.nn=Math.max(4,t),this.en=Math.max(2,Math.ceil(.4*this.nn)),this.clear()}all(){return this.rn(this.data,[])}search(t){let n=this.data;const e=[];if(!yh(t,n))return e;const r=this.toBBox,i=[];for(;n;){for(let s=0;s<n.children.length;s++){const o=n.children[s],a=n.leaf?r(o):o;yh(t,a)&&(n.leaf?e.push(o):ph(t,a)?this.rn(o,e):i.push(o))}n=i.pop()}return e}collides(t){let n=this.data;if(!yh(t,n))return!1;const e=[];for(;n;){for(let r=0;r<n.children.length;r++){const i=n.children[r],s=n.leaf?this.toBBox(i):i;if(yh(t,s)){if(n.leaf||ph(t,s))return!0;e.push(i)}}n=e.pop()}return!1}load(t){if(!t||!t.length)return this;if(t.length<this.en){for(let n=0;n<t.length;n++)this.insert(t[n]);return this}let n=this.sn(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this.an(this.data,n);else{if(this.data.height<n.height){const t=this.data;this.data=n,n=t}this.un(n,this.data.height-n.height-1,!0)}else this.data=n;return this}insert(t){return t&&this.un(t,this.data.height-1),this}clear(){return this.data=mh([]),this}remove(t,n){if(!t)return this;let e=this.data;const r=this.toBBox(t),i=[],s=[];let o,a,u;for(;e||i.length;){if(e||(e=i.pop(),a=i[i.length-1],o=s.pop(),u=!0),e.leaf){const r=ih(t,e.children,n);if(-1!==r)return e.children.splice(r,1),i.push(e),this.hn(i),this}u||e.leaf||!ph(e,r)?a?(o++,e=a.children[o],u=!1):e=null:(i.push(e),s.push(o),o=0,a=e,e=e.children[0])}return this}toBBox(t){return t}compareMinX(t,n){return t.minX-n.minX}compareMinY(t,n){return t.minY-n.minY}toJSON(){return this.data}fromJSON(t){return this.data=t,this}rn(t,n){const e=[];for(;t;)t.leaf?n.push(...t.children):e.push(...t.children),t=e.pop();return n}sn(t,n,e,r){const i=e-n+1;let s,o=this.nn;if(i<=o)return s=mh(t.slice(n,e+1)),sh(s,this.toBBox),s;r||(r=Math.ceil(Math.log(i)/Math.log(o)),o=Math.ceil(i/Math.pow(o,r-1))),s=mh([]),s.leaf=!1,s.height=r;const a=Math.ceil(i/o),u=a*Math.ceil(Math.sqrt(o));gh(t,n,e,u,this.compareMinX);for(let i=n;i<=e;i+=u){const n=Math.min(i+u-1,e);gh(t,i,n,a,this.compareMinY);for(let e=i;e<=n;e+=a){const i=Math.min(e+a-1,n);s.children.push(this.sn(t,e,i,r-1))}}return sh(s,this.toBBox),s}cn(t,n,e,r){for(;r.push(n),!n.leaf&&r.length-1!==e;){let e,r=1/0,i=1/0;for(let s=0;s<n.children.length;s++){const o=n.children[s],a=hh(o),u=fh(t,o)-a;u<i?(i=u,r=a<r?a:r,e=o):u===i&&a<r&&(r=a,e=o)}n=e||n.children[0]}return n}un(t,n,e){const r=e?t:this.toBBox(t),i=[],s=this.cn(r,this.data,n,i);for(s.children.push(t),ah(s,r);n>=0&&i[n].children.length>this.nn;)this.dn(i,n),n--;this.pn(r,i,n)}dn(t,n){const e=t[n],r=e.children.length,i=this.en;this.yn(e,i,r);const s=this.mn(e,i,r),o=mh(e.children.splice(s,e.children.length-s));o.height=e.height,o.leaf=e.leaf,sh(e,this.toBBox),sh(o,this.toBBox),n?t[n-1].children.push(o):this.an(e,o)}an(t,n){this.data=mh([t,n]),this.data.height=t.height+1,this.data.leaf=!1,sh(this.data,this.toBBox)}mn(t,n,e){let r,i=1/0,s=1/0;for(let o=n;o<=e-n;o++){const n=oh(t,0,o,this.toBBox),a=oh(t,o,e,this.toBBox),u=dh(n,a),l=hh(n)+hh(a);u<i?(i=u,r=o,s=l<s?l:s):u===i&&l<s&&(s=l,r=o)}return r||e-n}yn(t,n,e){const r=t.leaf?this.compareMinX:uh,i=t.leaf?this.compareMinY:lh;this.gn(t,n,e,r)<this.gn(t,n,e,i)&&t.children.sort(r)}gn(t,n,e,r){t.children.sort(r);const i=this.toBBox,s=oh(t,0,n,i),o=oh(t,e-n,e,i);let a=ch(s)+ch(o);for(let r=n;r<e-n;r++){const n=t.children[r];ah(s,t.leaf?i(n):n),a+=ch(s)}for(let r=e-n-1;r>=n;r--){const n=t.children[r];ah(o,t.leaf?i(n):n),a+=ch(o)}return a}pn(t,n,e){for(let r=e;r>=0;r--)ah(n[r],t)}hn(t){for(let n,e=t.length-1;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children,n.splice(n.indexOf(t[e]),1)):this.clear():sh(t[e],this.toBBox)}}function ih(t,n,e){if(!e)return n.indexOf(t);for(let r=0;r<n.length;r++)if(e(t,n[r]))return r;return-1}function sh(t,n){oh(t,0,t.children.length,n,t)}function oh(t,n,e,r,i){i||(i=mh(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(let s=n;s<e;s++){const n=t.children[s];ah(i,t.leaf?r(n):n)}return i}function ah(t,n){return t.minX=Math.min(t.minX,n.minX),t.minY=Math.min(t.minY,n.minY),t.maxX=Math.max(t.maxX,n.maxX),t.maxY=Math.max(t.maxY,n.maxY),t}function uh(t,n){return t.minX-n.minX}function lh(t,n){return t.minY-n.minY}function hh(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function ch(t){return t.maxX-t.minX+(t.maxY-t.minY)}function fh(t,n){return(Math.max(n.maxX,t.maxX)-Math.min(n.minX,t.minX))*(Math.max(n.maxY,t.maxY)-Math.min(n.minY,t.minY))}function dh(t,n){const e=Math.max(t.minX,n.minX),r=Math.max(t.minY,n.minY),i=Math.min(t.maxX,n.maxX),s=Math.min(t.maxY,n.maxY);return Math.max(0,i-e)*Math.max(0,s-r)}function ph(t,n){return t.minX<=n.minX&&t.minY<=n.minY&&n.maxX<=t.maxX&&n.maxY<=t.maxY}function yh(t,n){return n.minX<=t.maxX&&n.minY<=t.maxY&&n.maxX>=t.minX&&n.maxY>=t.minY}function mh(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function gh(t,n,e,r,i){const s=[n,e];for(;s.length;){if((e=s.pop())-(n=s.pop())<=r)continue;const o=n+Math.ceil((e-n)/r/2)*r;th(t,o,n,e,i),s.push(n,o,o,e)}}var vh={exports:{}},bh=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=(r-e)/2,u=0,l=a-1;u<a;l=u++){var h=n[e+2*u+0],c=n[e+2*u+1],f=n[e+2*l+0],d=n[e+2*l+1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o},wh=function(t,n,e,r){var i=t[0],s=t[1],o=!1;void 0===e&&(e=0),void 0===r&&(r=n.length);for(var a=r-e,u=0,l=a-1;u<a;l=u++){var h=n[u+e][0],c=n[u+e][1],f=n[l+e][0],d=n[l+e][1];c>s!=d>s&&i<(f-h)*(s-c)/(d-c)+h&&(o=!o)}return o};vh.exports=function(t,n,e,r){return n.length>0&&Array.isArray(n[0])?wh(t,n,e,r):bh(t,n,e,r)};var Mh=vh.exports.nested=wh;vh.exports.flat=bh;function xh(t,n,e,r,i){let s,o,a,u,l=n[0],h=r[0],c=0,f=0;h>l==h>-l?(s=l,l=n[++c]):(s=h,h=r[++f]);let d=0;if(c<t&&f<e)for(h>l==h>-l?(o=l+s,a=s-(o-l),l=n[++c]):(o=h+s,a=s-(o-h),h=r[++f]),s=o,0!==a&&(i[d++]=a);c<t&&f<e;)h>l==h>-l?(o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c]):(o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f]),s=o,0!==a&&(i[d++]=a);for(;c<t;)o=s+l,u=o-s,a=s-(o-u)+(l-u),l=n[++c],s=o,0!==a&&(i[d++]=a);for(;f<e;)o=s+h,u=o-s,a=s-(o-u)+(h-u),h=r[++f],s=o,0!==a&&(i[d++]=a);return 0===s&&0!==d||(i[d++]=s),d}function Fh(t){return new Float64Array(t)}const Ah=Fh(4),kh=Fh(8),Ph=Fh(12),Sh=Fh(16),_h=Fh(4);function Oh(t,n,e,r,i,s){const o=(n-s)*(e-i),a=(t-i)*(r-s),u=o-a;if(0===o||0===a||o>0!=a>0)return u;const l=Math.abs(o+a);return Math.abs(u)>=33306690738754716e-32*l?u:-function(t,n,e,r,i,s,o){let a,u,l,h,c,f,d,p,y,m,g,v,b,w,M,x,F,A;const k=t-i,P=e-i,S=n-s,_=r-s;w=k*_,f=134217729*k,d=f-(f-k),p=k-d,f=134217729*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=S*P,f=134217729*S,d=f-(f-S),p=S-d,f=134217729*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,Ah[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,Ah[1]=b-(g+c)+(c-x),A=v+g,c=A-v,Ah[2]=v-(A-c)+(g-c),Ah[3]=A;let O=function(t,n){let e=n[0];for(let r=1;r<t;r++)e+=n[r];return e}(4,Ah),E=22204460492503146e-32*o;if(O>=E||-O>=E)return O;if(c=t-k,a=t-(k+c)+(c-i),c=e-P,l=e-(P+c)+(c-i),c=n-S,u=n-(S+c)+(c-s),c=r-_,h=r-(_+c)+(c-s),0===a&&0===u&&0===l&&0===h)return O;if(E=11093356479670487e-47*o+33306690738754706e-32*Math.abs(O),O+=k*h+_*a-(S*l+P*u),O>=E||-O>=E)return O;w=a*_,f=134217729*a,d=f-(f-a),p=a-d,f=134217729*_,y=f-(f-_),m=_-y,M=p*m-(w-d*y-p*y-d*m),x=u*P,f=134217729*u,d=f-(f-u),p=u-d,f=134217729*P,y=f-(f-P),m=P-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,_h[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,_h[1]=b-(g+c)+(c-x),A=v+g,c=A-v,_h[2]=v-(A-c)+(g-c),_h[3]=A;const I=xh(4,Ah,4,_h,kh);w=k*h,f=134217729*k,d=f-(f-k),p=k-d,f=134217729*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=S*l,f=134217729*S,d=f-(f-S),p=S-d,f=134217729*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,_h[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,_h[1]=b-(g+c)+(c-x),A=v+g,c=A-v,_h[2]=v-(A-c)+(g-c),_h[3]=A;const $=xh(I,kh,4,_h,Ph);w=a*h,f=134217729*a,d=f-(f-a),p=a-d,f=134217729*h,y=f-(f-h),m=h-y,M=p*m-(w-d*y-p*y-d*m),x=u*l,f=134217729*u,d=f-(f-u),p=u-d,f=134217729*l,y=f-(f-l),m=l-y,F=p*m-(x-d*y-p*y-d*m),g=M-F,c=M-g,_h[0]=M-(g+c)+(c-F),v=w+g,c=v-w,b=w-(v-c)+(g-c),g=b-x,c=b-g,_h[1]=b-(g+c)+(c-x),A=v+g,c=A-v,_h[2]=v-(A-c)+(g-c),_h[3]=A;const C=xh($,Ph,4,_h,Sh);return Sh[C-1]}(t,n,e,r,i,s,l)}function Eh(t,n,e){n=Math.max(0,void 0===n?2:n),e=e||0;var r=function(t){for(var n=t[0],e=t[0],r=t[0],i=t[0],s=0;s<t.length;s++){var o=t[s];o[0]<n[0]&&(n=o),o[0]>r[0]&&(r=o),o[1]<e[1]&&(e=o),o[1]>i[1]&&(i=o)}var a=[n,e,r,i],u=a.slice();for(s=0;s<t.length;s++)Mh(t[s],a)||u.push(t[s]);return function(t){t.sort(Rh);for(var n=[],e=0;e<t.length;e++){for(;n.length>=2&&Dh(n[n.length-2],n[n.length-1],t[e])<=0;)n.pop();n.push(t[e])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&Dh(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),n.pop(),n.concat(r)}(u)}(t),i=new rh(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,n){return t[0]-n[0]},i.compareMinY=function(t,n){return t[1]-n[1]},i.load(t);for(var s,o=[],a=0;a<r.length;a++){var u=r[a];i.remove(u),s=Uh(u,s),o.push(s)}var l=new rh(16);for(a=0;a<o.length;a++)l.insert(jh(o[a]));for(var h=n*n,c=e*e;o.length;){var f=o.shift(),d=f.p,p=f.next.p,y=Nh(d,p);if(!(y<c)){var m=y/h;(u=Ih(i,f.prev.p,d,p,f.next.next.p,m,l))&&Math.min(Nh(u,d),Nh(u,p))<=m&&(o.push(f),o.push(Uh(u,f)),i.remove(u),l.remove(f),l.insert(jh(f)),l.insert(jh(f.next)))}}f=s;var g=[];do{g.push(f.p),f=f.next}while(f!==s);return g.push(f.p),g}function Ih(t,n,e,r,i,s,o){for(var a=new Bn([],$h),u=t.data;u;){for(var l=0;l<u.children.length;l++){var h=u.children[l],c=u.leaf?Lh(h,e,r):Ch(e,r,h);c>s||a.push({node:h,dist:c})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=Lh(d,n,e),y=Lh(d,r,i);if(f.dist<p&&f.dist<y&&zh(e,d,o)&&zh(r,d,o))return d}(u=a.pop())&&(u=u.node)}return null}function $h(t,n){return t.dist-n.dist}function Ch(t,n,e){if(Th(t,e)||Th(n,e))return 0;var r=Vh(t[0],t[1],n[0],n[1],e.minX,e.minY,e.maxX,e.minY);if(0===r)return 0;var i=Vh(t[0],t[1],n[0],n[1],e.minX,e.minY,e.minX,e.maxY);if(0===i)return 0;var s=Vh(t[0],t[1],n[0],n[1],e.maxX,e.minY,e.maxX,e.maxY);if(0===s)return 0;var o=Vh(t[0],t[1],n[0],n[1],e.minX,e.maxY,e.maxX,e.maxY);return 0===o?0:Math.min(r,i,s,o)}function Th(t,n){return t[0]>=n.minX&&t[0]<=n.maxX&&t[1]>=n.minY&&t[1]<=n.maxY}function zh(t,n,e){for(var r,i,s,o,a=Math.min(t[0],n[0]),u=Math.min(t[1],n[1]),l=Math.max(t[0],n[0]),h=Math.max(t[1],n[1]),c=e.search({minX:a,minY:u,maxX:l,maxY:h}),f=0;f<c.length;f++)if(r=c[f].p,i=c[f].next.p,s=t,r!==(o=n)&&i!==s&&Dh(r,i,s)>0!=Dh(r,i,o)>0&&Dh(s,o,r)>0!=Dh(s,o,i)>0)return!1;return!0}function Dh(t,n,e){return Oh(t[0],t[1],n[0],n[1],e[0],e[1])}function jh(t){var n=t.p,e=t.next.p;return t.minX=Math.min(n[0],e[0]),t.minY=Math.min(n[1],e[1]),t.maxX=Math.max(n[0],e[0]),t.maxY=Math.max(n[1],e[1]),t}function Uh(t,n){var e={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return n?(e.next=n.next,e.prev=n,n.next.prev=e,n.next=e):(e.prev=e,e.next=e),e}function Nh(t,n){var e=t[0]-n[0],r=t[1]-n[1];return e*e+r*r}function Lh(t,n,e){var r=n[0],i=n[1],s=e[0]-r,o=e[1]-i;if(0!==s||0!==o){var a=((t[0]-r)*s+(t[1]-i)*o)/(s*s+o*o);a>1?(r=e[0],i=e[1]):a>0&&(r+=s*a,i+=o*a)}return(s=t[0]-r)*s+(o=t[1]-i)*o}function Vh(t,n,e,r,i,s,o,a){var u,l,h,c,f=e-t,d=r-n,p=o-i,y=a-s,m=t-i,g=n-s,v=f*f+d*d,b=f*p+d*y,w=p*p+y*y,M=f*m+d*g,x=p*m+y*g,F=v*w-b*b,A=F,k=F;0===F?(l=0,A=1,c=x,k=w):(c=v*x-b*M,(l=b*x-w*M)<0?(l=0,c=x,k=w):l>A&&(l=A,c=x+b,k=w)),c<0?(c=0,-M<0?l=0:-M>v?l=A:(l=-M,A=v)):c>k&&(c=k,-M+b<0?l=0:-M+b>v?l=A:(l=-M+b,A=v));var P=(1-(h=0===c?0:c/k))*i+h*o-((1-(u=0===l?0:l/A))*t+u*e),S=(1-h)*s+h*a-((1-u)*n+u*r);return P*P+S*S}function Rh(t,n){return t[0]===n[0]?t[1]-n[1]:t[0]-n[0]}class Hh{constructor(t,n){this.x=t,this.y=n}clone(){return new Hh(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new Hh(this.x-t.x,this.y-t.y)}distance(t){const n=this.x-t.x,e=this.y-t.y;return Math.sqrt(n*n+e*e)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new Hh(this.y,-this.x)}}function Wh(t,n,e,r){const i=n.x*r.y-n.y*r.x,s=e.x-t.x,o=e.y-t.y,a=(s*r.y-o*r.x)/i;return new Hh(t.x+a*n.x,t.y+a*n.y)}const qh=[],Gh=[];function Bh(t){if(x(t[0]&&t[0].x)){const n=[];let e=0;for(let r=0;r<t.length;r++)Gh[e]?(Gh[e][0]=t[r].x,Gh[e][1]=t[r].y):Gh[e]=[t[r].x,t[r].y],n.push(Gh[e]),e++;t=n}try{const n=Eh(t,1/0);let e=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<n.length;t++)n[t][0]<e[0]&&(e[0]=n[t][0]),n[t][0]>r[0]&&(r[0]=n[t][0]),n[t][1]<e[1]&&(e[1]=n[t][1]),n[t][1]>r[1]&&(r[1]=n[t][1]);const i=[];let s=[],o=0;for(let t=0;t<n.length;t++)t===n.length-1&&n[t][0]===n[0][0]&&n[t][1]===n[0][1]||(Ct(i,n[t],"EPSG:3857"),qh[o]?(qh[o].x=i[0],qh[o].y=i[1]):qh[o]=new Hh(i[0],i[1]),s.push(qh[o]),o++);pl.calculateSignedArea(s)<0&&(s=s.reverse());const a=function(t){let n,e=Number.MAX_VALUE;const r=function(t,r,i,s,o,a,u,l){var h=Wh(t,r,o,a),c=Wh(i,s,o,a),f=Wh(u,l,t,r),d=Wh(u,l,i,s),p=h.distance(c)*h.distance(f);0!==p&&p<e&&(n=[h,f,d,c],e=p)};var i=[];for(let n=0;n<t.length;n++)i.push(t[(n+1)%t.length].diff(t[n])),i[n].normalize();var s,o,a,u,l=new Hh(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),h=new Hh(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let n=0;n<t.length;n++){var c=t[n];c.x<l.x&&(l.x=c.x,s=n),c.x>h.x&&(h.x=c.x,o=n),c.y<l.y&&(l.y=c.y,u=n),c.y>h.y&&(h.y=c.y,a=n)}var f=new Hh(0,-1),d=new Hh(0,1),p=new Hh(-1,0),y=new Hh(1,0);for(let n=0;n<t.length;n++){var m=[Math.acos(f.dot(i[s])),Math.acos(d.dot(i[o])),Math.acos(p.dot(i[a])),Math.acos(y.dot(i[u]))];switch(m.indexOf(Math.min.apply(Math,m))){case 0:(d=(f=i[s].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 1:(f=(d=i[o].clone()).clone()).negate(),(y=(p=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 2:(y=(p=i[a].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(p=(y=i[u].clone()).clone()).negate(),(d=(f=y.orthogonal()).clone()).negate(),u=(u+1)%t.length}r(t[s],f,t[o],d,t[a],p,t[u],y)}return n}(s);if(!a||4!==a.length)return null;const u=a[0].distance(a[1]),l=a[1].distance(a[2]),h=a.map(t=>[t.x,t.y]);return h.push(+(l>u)),h}catch(t){return null}}const Jh=[];function Xh(t,n){const e=Array.isArray(t&&t[0]&&t[0][0]);for(let r=0;r<t.length;r++)e?t[r]=Xh(t[r]):(Ct(Jh,t[r],n),t[r][0]=Jh[0],t[r][1]=Jh[1]);return t}class Yh extends Tl{constructor(t,n,e,r,i,s){super(t,n,e,r,i),(n=n||{}).extent||(n.extent=8192),this.setData(n.data,s)}setData(t,n){if(delete this.index,!t)return void n();const e={maxZoom:24,tolerance:this.options.simplifyTolerance,extent:this.options.extent,buffer:x(this.options.tileBuffer)?this.options.tileBuffer:64,hasAltitude:!!this.options.hasAltitude,debug:0,lineMetrics:!0,indexMaxZoom:5,indexMaxPoints:1e5,disableFilter:!0};if(this.options.projection&&(e.projection=this.options.projection,"EPSG:4490"===e.projection&&(e.projection="EPSG:4326")),M(t)&&"{"!=t.substring(0,1)||t.url){const r=t.url?t.url:t;O.getJSON(r,t.url?t:{},(t,i)=>{if(t&&(console.error("Failed to fetch geojson:"+r),n(t)),!i)return void n(null,{extent:null,idMap:{}});let s=i;if(this.options.convertFn){s=new Function("data",this.options.convertFn+"\\nreturn convert(data)")(s)}const o=Array.isArray(s)?s:s.features;this.vn(o);const{sample1000:a,idMap:u}=this.bn(o);this.wn(a,u,s,e,n)})}else{"string"==typeof t&&(t=JSON.parse(t));const r=Array.isArray(t)?t:t.features,i=r&&r.length;this.vn(r);let s=r;if(r&&i>1e3){s=[];for(let t=0;t<i;t++)Zh(r[t],s,t,i)}this.wn(s,null,t,e,n)}}vn(t){if(this.options.generateOMBB&&t)for(let n=0;n<t.length;n++){const e=t[n];if(e&&e.geometry&&e.geometry.coordinates)if("Polygon"===e.geometry.type){const t=e.geometry.coordinates[0];if(!t)continue;const n=Bh(t,t.length);e.properties=e.properties||{},e.properties[bl]=n}else if("MultiPolygon"===e.geometry.type){const t=e.geometry.coordinates;for(let n=0;n<t.length;n++){if(!t[n])continue;const r=t[n][0];if(!r)continue;const i=Bh(r,r.length);e.properties=e.properties||{},e.properties[bl]=e.properties[bl]||[],e.properties[bl][n]=i}}}}wn(t,n,e,r,i){try{const s=t&&t.length?function(t){let n=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];switch(t.type){case"FeatureCollection":const e=t.features.length;for(let r=0;r<e;r++)Xl(t.features[r],n);break;case"Feature":Xl(t,n);break;default:Yl(t,n)}return n}({type:"FeatureCollection",features:t}):null;this.index=function(t,n){return new it(t,n)}(e,this.options.geojsonvt||r),i(null,{extent:s,idMap:n})}catch(t){console.warn(t),i({error:t.message})}}bn(t){const n=[],e={};let r=0;const i=this.options.featureIdProperty;if(t){const s=t.length;t.forEach((t,o)=>{!function(t,s,o){if(t&&("Feature"!==t.type||t.geometry)){if(x(t.id)||(t.id=r++),i){let n=i;A(i)&&(n=i[t.layer||"0"]),t.id=t.properties[n]}e[t.id]=w({},t),t.geometry?(e[t.id].geometry=w({},t.geometry),e[t.id].geometry.coordinates=null):t.coordinates&&(e[t.id].coordinates=null),Zh(t,n,s,o)}}(t,o,s)})}return{sample1000:n,idMap:e}}getTileFeatures(t,n){const e=t.tileInfo,r=[];if(!this.index)return setTimeout((function(){n({loading:!0})}),1),1;const i=this.index.getTile(e.z,e.x,e.y);if(!i||0===i.features.length)return setTimeout((function(){n(null,r,[])}),1),1;const s=[];for(let t=0,n=i.features.length;t<n;t++){const n=i.features[t];let e=n.layer;void 0===e&&(e="0"),s[e]={types:{}};s[e].types[n.type]=1,n.tags=n.tags||{},n.geometry.converted||(pl.convertGeometry(n),n.geometry.converted=1),r.push({type:n.type,layer:e,id:n.id,geometry:n.geometry,properties:n.tags,extent:this.options.extent})}for(const t in s)s[t].types=Object.keys(s[t].types).map(t=>+t);return setTimeout((function(){n(null,r,s)}),1),1}onRemove(){super.onRemove(),delete this.index}}function Zh(t,n,e,r){const i=Math.floor(r/998);(0===e||e===r-1||(0===i||e%i==0)&&n.length<999)&&n.push(t)}var Kh={\n/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */\nread:function(t,n,e,r,i){var s,o,a=8*i-r-1,u=(1<<a)-1,l=u>>1,h=-7,c=e?i-1:0,f=e?-1:1,d=t[n+c];for(c+=f,s=d&(1<<-h)-1,d>>=-h,h+=a;h>0;s=256*s+t[n+c],c+=f,h-=8);for(o=s&(1<<-h)-1,s>>=-h,h+=r;h>0;o=256*o+t[n+c],c+=f,h-=8);if(0===s)s=1-l;else{if(s===u)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},write:function(t,n,e,r,i,s){var o,a,u,l=8*s-i-1,h=(1<<l)-1,c=h>>1,f=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,p=r?1:-1,y=n<0||0===n&&1/n<0?1:0;for(n=Math.abs(n),isNaN(n)||n===1/0?(a=isNaN(n)?1:0,o=h):(o=Math.floor(Math.log(n)/Math.LN2),n*(u=Math.pow(2,-o))<1&&(o--,u*=2),(n+=o+c>=1?f/u:f*Math.pow(2,1-c))*u>=2&&(o++,u/=2),o+c>=h?(a=0,o=h):o+c>=1?(a=(n*u-1)*Math.pow(2,i),o+=c):(a=n*Math.pow(2,c-1)*Math.pow(2,i),o=0));i>=8;t[e+d]=255&a,d+=p,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;t[e+d]=255&o,d+=p,o/=256,l-=8);t[e+d-p]|=128*y}},Qh=nc,tc=Kh;function nc(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}nc.Varint=0,nc.Fixed64=1,nc.Bytes=2,nc.Fixed32=5;var ec="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function rc(t){return t.type===nc.Bytes?t.readVarint()+t.pos:t.pos+1}function ic(t,n,e){return e?4294967296*n+(t>>>0):4294967296*(n>>>0)+(t>>>0)}function sc(t,n,e){var r=n<=16383?1:n<=2097151?2:n<=268435455?3:Math.floor(Math.log(n)/(7*Math.LN2));e.realloc(r);for(var i=e.pos-1;i>=t;i--)e.buf[i+r]=e.buf[i]}function oc(t,n){for(var e=0;e<t.length;e++)n.writeVarint(t[e])}function ac(t,n){for(var e=0;e<t.length;e++)n.writeSVarint(t[e])}function uc(t,n){for(var e=0;e<t.length;e++)n.writeFloat(t[e])}function lc(t,n){for(var e=0;e<t.length;e++)n.writeDouble(t[e])}function hc(t,n){for(var e=0;e<t.length;e++)n.writeBoolean(t[e])}function cc(t,n){for(var e=0;e<t.length;e++)n.writeFixed32(t[e])}function fc(t,n){for(var e=0;e<t.length;e++)n.writeSFixed32(t[e])}function dc(t,n){for(var e=0;e<t.length;e++)n.writeFixed64(t[e])}function pc(t,n){for(var e=0;e<t.length;e++)n.writeSFixed64(t[e])}function yc(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+16777216*t[n+3]}function mc(t,n,e){t[e]=n,t[e+1]=n>>>8,t[e+2]=n>>>16,t[e+3]=n>>>24}function gc(t,n){return(t[n]|t[n+1]<<8|t[n+2]<<16)+(t[n+3]<<24)}nc.prototype={destroy:function(){this.buf=null},readFields:function(t,n,e){for(e=e||this.length;this.pos<e;){var r=this.readVarint(),i=r>>3,s=this.pos;this.type=7&r,t(i,n,this),this.pos===s&&this.skip(r)}return n},readMessage:function(t,n){return this.readFields(t,n,this.readVarint()+this.pos)},readFixed32:function(){var t=yc(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=gc(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=yc(this.buf,this.pos)+4294967296*yc(this.buf,this.pos+4);return this.pos+=8,t},readSFixed64:function(){var t=yc(this.buf,this.pos)+4294967296*gc(this.buf,this.pos+4);return this.pos+=8,t},readFloat:function(){var t=tc.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=tc.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var n,e,r=this.buf;return n=127&(e=r[this.pos++]),e<128?n:(n|=(127&(e=r[this.pos++]))<<7,e<128?n:(n|=(127&(e=r[this.pos++]))<<14,e<128?n:(n|=(127&(e=r[this.pos++]))<<21,e<128?n:function(t,n,e){var r,i,s=e.buf;if(i=s[e.pos++],r=(112&i)>>4,i<128)return ic(t,r,n);if(i=s[e.pos++],r|=(127&i)<<3,i<128)return ic(t,r,n);if(i=s[e.pos++],r|=(127&i)<<10,i<128)return ic(t,r,n);if(i=s[e.pos++],r|=(127&i)<<17,i<128)return ic(t,r,n);if(i=s[e.pos++],r|=(127&i)<<24,i<128)return ic(t,r,n);if(i=s[e.pos++],r|=(1&i)<<31,i<128)return ic(t,r,n);throw new Error("Expected varint not more than 10 bytes")}(n|=(15&(e=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,n=this.pos;return this.pos=t,t-n>=12&&ec?function(t,n,e){return ec.decode(t.subarray(n,e))}(this.buf,n,t):function(t,n,e){var r="",i=n;for(;i<e;){var s,o,a,u=t[i],l=null,h=u>239?4:u>223?3:u>191?2:1;if(i+h>e)break;1===h?u<128&&(l=u):2===h?128==(192&(s=t[i+1]))&&(l=(31&u)<<6|63&s)<=127&&(l=null):3===h?(s=t[i+1],o=t[i+2],128==(192&s)&&128==(192&o)&&((l=(15&u)<<12|(63&s)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===h&&(s=t[i+1],o=t[i+2],a=t[i+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&((l=(15&u)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,h=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),i+=h}return r}(this.buf,n,t)},readBytes:function(){var t=this.readVarint()+this.pos,n=this.buf.subarray(this.pos,t);return this.pos=t,n},readPackedVarint:function(t,n){if(this.type!==nc.Bytes)return t.push(this.readVarint(n));var e=rc(this);for(t=t||[];this.pos<e;)t.push(this.readVarint(n));return t},readPackedSVarint:function(t){if(this.type!==nc.Bytes)return t.push(this.readSVarint());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==nc.Bytes)return t.push(this.readBoolean());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==nc.Bytes)return t.push(this.readFloat());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==nc.Bytes)return t.push(this.readDouble());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==nc.Bytes)return t.push(this.readFixed32());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==nc.Bytes)return t.push(this.readSFixed32());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==nc.Bytes)return t.push(this.readFixed64());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==nc.Bytes)return t.push(this.readSFixed64());var n=rc(this);for(t=t||[];this.pos<n;)t.push(this.readSFixed64());return t},skip:function(t){var n=7&t;if(n===nc.Varint)for(;this.buf[this.pos++]>127;);else if(n===nc.Bytes)this.pos=this.readVarint()+this.pos;else if(n===nc.Fixed32)this.pos+=4;else{if(n!==nc.Fixed64)throw new Error("Unimplemented type: "+n);this.pos+=8}},writeTag:function(t,n){this.writeVarint(t<<3|n)},realloc:function(t){for(var n=this.length||16;n<this.pos+t;)n*=2;if(n!==this.length){var e=new Uint8Array(n);e.set(this.buf),this.buf=e,this.length=n}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),mc(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),mc(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),mc(this.buf,-1&t,this.pos),mc(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),mc(this.buf,-1&t,this.pos),mc(this.buf,Math.floor(t*(1/4294967296)),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,n){var e,r;t>=0?(e=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(e=~(-t%4294967296))?e=e+1|0:(e=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn\'t fit into 10 bytes");n.realloc(10),function(t,n,e){e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos++]=127&t|128,t>>>=7,e.buf[e.pos]=127&t}(e,0,n),function(t,n){var e=(7&t)<<4;if(n.buf[n.pos++]|=e|((t>>>=3)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(n.buf[n.pos++]=127&t|((t>>>=7)?128:0),!t)return;n.buf[n.pos++]=127&t}(r,n)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var n=this.pos;this.pos=function(t,n,e){for(var r,i,s=0;s<n.length;s++){if((r=n.charCodeAt(s))>55295&&r<57344){if(!i){r>56319||s+1===n.length?(t[e++]=239,t[e++]=191,t[e++]=189):i=r;continue}if(r<56320){t[e++]=239,t[e++]=191,t[e++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(t[e++]=239,t[e++]=191,t[e++]=189,i=null);r<128?t[e++]=r:(r<2048?t[e++]=r>>6|192:(r<65536?t[e++]=r>>12|224:(t[e++]=r>>18|240,t[e++]=r>>12&63|128),t[e++]=r>>6&63|128),t[e++]=63&r|128)}return e}(this.buf,t,this.pos);var e=this.pos-n;e>=128&&sc(n,e,this),this.pos=n-1,this.writeVarint(e),this.pos+=e},writeFloat:function(t){this.realloc(4),tc.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),tc.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var n=t.length;this.writeVarint(n),this.realloc(n);for(var e=0;e<n;e++)this.buf[this.pos++]=t[e]},writeRawMessage:function(t,n){this.pos++;var e=this.pos;t(n,this);var r=this.pos-e;r>=128&&sc(e,r,this),this.pos=e-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,n,e){this.writeTag(t,nc.Bytes),this.writeRawMessage(n,e)},writePackedVarint:function(t,n){n.length&&this.writeMessage(t,oc,n)},writePackedSVarint:function(t,n){n.length&&this.writeMessage(t,ac,n)},writePackedBoolean:function(t,n){n.length&&this.writeMessage(t,hc,n)},writePackedFloat:function(t,n){n.length&&this.writeMessage(t,uc,n)},writePackedDouble:function(t,n){n.length&&this.writeMessage(t,lc,n)},writePackedFixed32:function(t,n){n.length&&this.writeMessage(t,cc,n)},writePackedSFixed32:function(t,n){n.length&&this.writeMessage(t,fc,n)},writePackedFixed64:function(t,n){n.length&&this.writeMessage(t,dc,n)},writePackedSFixed64:function(t,n){n.length&&this.writeMessage(t,pc,n)},writeBytesField:function(t,n){this.writeTag(t,nc.Bytes),this.writeBytes(n)},writeFixed32Field:function(t,n){this.writeTag(t,nc.Fixed32),this.writeFixed32(n)},writeSFixed32Field:function(t,n){this.writeTag(t,nc.Fixed32),this.writeSFixed32(n)},writeFixed64Field:function(t,n){this.writeTag(t,nc.Fixed64),this.writeFixed64(n)},writeSFixed64Field:function(t,n){this.writeTag(t,nc.Fixed64),this.writeSFixed64(n)},writeVarintField:function(t,n){this.writeTag(t,nc.Varint),this.writeVarint(n)},writeSVarintField:function(t,n){this.writeTag(t,nc.Varint),this.writeSVarint(n)},writeStringField:function(t,n){this.writeTag(t,nc.Bytes),this.writeString(n)},writeFloatField:function(t,n){this.writeTag(t,nc.Fixed32),this.writeFloat(n)},writeDoubleField:function(t,n){this.writeTag(t,nc.Fixed64),this.writeDouble(n)},writeBooleanField:function(t,n){this.writeVarintField(t,Boolean(n))}};var vc=Ut,bc=wc;function wc(t,n,e,r,i){this.properties={},this.extent=e,this.type=0,this.Mn=t,this.xn=-1,this.Fn=r,this.An=i,t.readFields(Mc,this,n)}function Mc(t,n,e){1==t?n.id=e.readVarint():2==t?function(t,n){var e=t.readVarint()+t.pos;for(;t.pos<e;){var r=n.Fn[t.readVarint()],i=n.An[t.readVarint()];n.properties[r]=i}}(e,n):3==t?n.type=e.readVarint():4==t&&(n.xn=e.pos)}function xc(t){for(var n,e,r=0,i=0,s=t.length,o=s-1;i<s;o=i++)n=t[i],r+=((e=t[o]).x-n.x)*(n.y+e.y);return r}wc.types=["Unknown","Point","LineString","Polygon"],wc.prototype.loadGeometry=function(){var t=this.Mn;t.pos=this.xn;for(var n,e=t.readVarint()+t.pos,r=1,i=0,s=0,o=0,a=[];t.pos<e;){if(i<=0){var u=t.readVarint();r=7&u,i=u>>3}if(i--,1===r||2===r)s+=t.readSVarint(),o+=t.readSVarint(),1===r&&(n&&a.push(n),n=[]),n.push(new vc(s,o));else{if(7!==r)throw new Error("unknown command "+r);n&&n.push(n[0].clone())}}return n&&a.push(n),a},wc.prototype.bbox=function(){var t=this.Mn;t.pos=this.xn;for(var n=t.readVarint()+t.pos,e=1,r=0,i=0,s=0,o=1/0,a=-1/0,u=1/0,l=-1/0;t.pos<n;){if(r<=0){var h=t.readVarint();e=7&h,r=h>>3}if(r--,1===e||2===e)(i+=t.readSVarint())<o&&(o=i),i>a&&(a=i),(s+=t.readSVarint())<u&&(u=s),s>l&&(l=s);else if(7!==e)throw new Error("unknown command "+e)}return[o,u,a,l]},wc.prototype.toGeoJSON=function(t,n,e){var r,i,s=this.extent*Math.pow(2,e),o=this.extent*t,a=this.extent*n,u=this.loadGeometry(),l=wc.types[this.type];function h(t){for(var n=0;n<t.length;n++){var e=t[n],r=180-360*(e.y+a)/s;t[n]=[360*(e.x+o)/s-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var c=[];for(r=0;r<u.length;r++)c[r]=u[r][0];h(u=c);break;case 2:for(r=0;r<u.length;r++)h(u[r]);break;case 3:for(u=function(t){var n=t.length;if(n<=1)return[t];for(var e,r,i=[],s=0;s<n;s++){var o=xc(t[s]);0!==o&&(void 0===r&&(r=o<0),r===o<0?(e&&i.push(e),e=[t[s]]):e.push(t[s]))}e&&i.push(e);return i}(u),r=0;r<u.length;r++)for(i=0;i<u[r].length;i++)h(u[r][i])}1===u.length?u=u[0]:l="Multi"+l;var f={type:"Feature",geometry:{type:l,coordinates:u},properties:this.properties};return"id"in this&&(f.id=this.id),f};var Fc=bc,Ac=kc;function kc(t,n){this.version=1,this.name=null,this.extent=4096,this.length=0,this.Mn=t,this.Fn=[],this.An=[],this.kn=[],t.readFields(Pc,this,n),this.length=this.kn.length}function Pc(t,n,e){15===t?n.version=e.readVarint():1===t?n.name=e.readString():5===t?n.extent=e.readVarint():2===t?n.kn.push(e.pos):3===t?n.Fn.push(e.readString()):4===t&&n.An.push(function(t){var n=null,e=t.readVarint()+t.pos;for(;t.pos<e;){var r=t.readVarint()>>3;n=1===r?t.readString():2===r?t.readFloat():3===r?t.readDouble():4===r?t.readVarint64():5===r?t.readVarint():6===r?t.readSVarint():7===r?t.readBoolean():null}return n}(e))}kc.prototype.feature=function(t){if(t<0||t>=this.kn.length)throw new Error("feature index out of bounds");this.Mn.pos=this.kn[t];var n=this.Mn.readVarint()+this.Mn.pos;return new Fc(this.Mn,n,this.extent,this.Fn,this.An)};var Sc=Ac;function _c(t,n,e){if(3===t){var r=new Sc(e,e.readVarint()+e.pos);r.length&&(n[r.name]=r)}}var Oc=function(t,n){this.layers=t.readFields(_c,{},n)};class Ec extends Tl{constructor(t,n,e,r,i,s){super(t,n,e,r,i),n=n||{},s()}getTileFeatures(t,n){const e=t.tileInfo.url,r=t.fetchOptions||{};if(this.Nt.has(e)){const{err:t,data:r}=this.Nt.get(e);return setTimeout(()=>{this.Pn(e,t,r,n)},1)}return r.referrer=t.referrer,O.getArrayBuffer(e,r,(t,r)=>{this.Nt&&(t?t.loading||this.Nt.add(e,{err:t,data:r&&r.data}):r&&r.data&&this.Nt.add(e,{err:null,data:r.data}),this.Pn(e,t,r&&r.data,n))})}Pn(t,n,e,r){if(n)return void r(n);let i;try{i=new Oc(new Qh(e))}catch(n){return void r(n.message,[],[])}const s=[];if(!i.layers)return void r(null,s,[]);const o={};let a;for(const t in i.layers)if(u=i.layers,l=t,Object.prototype.hasOwnProperty.call(u,l)){o[t]={types:{}};const e=o[t].types;for(let r=0,o=i.layers[t].length;r<o;r++)try{a=i.layers[t].feature(r),e[a.type]=1;const n={type:a.type,layer:t,geometry:a.loadGeometry(),properties:a.properties,extent:a.extent};void 0!==a.id&&(n.id=a.id);let o=n.properties[bl];o&&(M(o)&&(o=JSON.parse(o)),n.properties[bl]=Xh(o,"EPSG:3857")),s.push(n)}catch(n){console.warn("error when load vt geometry:",n)}}var u,l;for(const t in o)o[t].types=Object.keys(o[t].types).map(t=>+t);r(null,s,o,{byteLength:e.byteLength})}abortTile(t,n){const e=this.requests[t];delete this.requests[t],e&&e.abort&&e.abort(),this.Xt(t),n()}onRemove(){super.onRemove();for(const t in this.requests){const n=this.requests[t];n&&n.abort&&n.abort()}this.requests={}}}let Ic=0;const $c=new ol(128);class Cc{constructor(t){this.Sn={},this._n={},this.workerId=t}addLayer({actorId:t,mapId:n,layerId:e,params:r},i){if(this.On(n,e))return;const s=this.En(n,e),o=r.type,a=r.options,u=this.send.bind(this,t);this.Sn[s]="GeoJSONVectorTileLayer"===o?new Yh(e,a,u,$c,{},i):new Ec(e,a,u,$c,{},i)}removeLayer({mapId:t,layerId:n},e){const r=this.On(t,n),i=this.En(t,n);delete this.Sn[i],r&&r.onRemove(e)}loadTile({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.loadTile(e,r)}abortTile({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.abortTile&&i.abortTile(e.url,r)}removeTile({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.removeTile(e,r)}updateStyle({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.updateStyle(e,r)}updateOptions({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.updateOptions(e,r)}setData({mapId:t,layerId:n,params:e},r){const i=this.On(t,n);i&&i.setData(e.data,r)}receive(t){const n=t.callback,e=this._n[n];delete this._n[n],e&&t.error?e(new Error(t.error)):e&&e(null,t.data)}send(t,n,e,r,i){const s=i?`${t}-${Ic++}`:null;i&&(this._n[s]=i),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:n,params:e,callback:String(s)},r||[])}En(t,n){return`${t}-${n}`}On(t,n){const e=this.En(t,n);return this.Sn[e]}In(){$c.reset()}}t.initialize=function(){},t.onmessage=function(t,n){const e=t.data;if(this.dispatcher||(this.dispatcher=new Cc(t.workerId)),"<response>"===t.type)this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t);else{const r=e.command;this.dispatcher[r]({actorId:t.actorId,mapId:e.mapId,layerId:e.layerId,params:e.params},(t,e,i)=>{t&&404!==t.status&&204!==t.status&&console.error(r,t),n(t,e,i)})}},Object.defineProperty(t,"$n",{value:!0})}';let pt=0;function At(){return pt++}const gt="function"==typeof Object.assign;function mt(t,...e){if(gt)return Object.assign(t,...e),t;for(let n=0;n<e.length;n++){const r=e[n];for(const e in r)t[e]=r[e]}return t}function yt(t){return!wt(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function vt(t){return"number"==typeof t&&!isNaN(t)}function xt(t){return!wt(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function bt(t){return!Array.isArray(t)&&"object"==typeof t&&!!t}function wt(t){return null==t}function _t(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}function Mt(t){return Object(s["c"])(t)&&t.property}function Tt(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function St(t,e){let n;if(e.altitudeToPoint){n=e.altitudeToPoint(100,t);const r=e.options.heightFactor;r&&1!==r&&(n/=r)}else n=e.distanceToPointAtRes(100,0,t).x;return n/100/100}const It=["GeoJSONVectorTileLayer"];class Ct extends i["R"].Actor{constructor(t,e){super(t);const n=e.getMap().id;this.t=e,this.i=n,this.s="vt_"+At();const r=e.getJSONType();this.o=It.indexOf(r)>=0,this.l={},this.h=new o["g"]({iconErrorUrl:e.options.iconErrorUrl,maxSize:e.options.maxIconSize,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}});const i=!e.getRenderer().isEnableWorkAround("win-intel-gpu-crash");this.u=new o["e"](t=>{e.getMap().getRenderer().callInNextFrame(t)},e.options.glyphSdfLimitPerFrame,i)}initialize(t){t(null)}addLayer(t){const e=this.t,n=e.getWorkerOptions()||{},r=this.s,i=e.getJSONType(),s={mapId:this.i,layerId:r,command:"addLayer",params:{type:i,options:n}};this.o?(void 0===this.l[r]&&(this.l[r]=this.getDedicatedWorker()),this.send(s,null,t,this.l[r])):this.broadcast(s,null,t)}abortTile(t,e){const n=this.s,r={mapId:this.i,layerId:n,command:"abortTile",params:{url:t}};this.o?(void 0===this.l[n]&&(this.l[n]=this.getDedicatedWorker()),this.send(r,null,e,this.l[n])):this.broadcast(r,null,e)}removeLayer(t){const e=this.s,n={mapId:this.i,layerId:e,command:"removeLayer"};this.o?(void 0!==this.l[e]&&this.send(n,null,t,this.l[e]),delete this.l[e]):this.broadcast(n,null,t)}updateStyle(t,e){const n=this.s,r={mapId:this.i,layerId:n,command:"updateStyle",params:t};this.o?void 0!==this.l[n]&&this.send(r,null,e,this.l[n]):this.broadcast(r,null,e)}updateOptions(t,e){const n=this.s,r={mapId:this.i,layerId:n,command:"updateOptions",params:t};this.o?void 0!==this.l[n]&&this.send(r,null,e,this.l[n]):this.broadcast(r,null,e)}loadTile(t,e){const n=mt({},t);n.tileInfo=function(t){const e={};for(const n in t)void 0!==t[n]&&null!==t[n]&&(t[n].toJSON?e[n]=t[n].toJSON():e[n]=t[n]);return e}(t.tileInfo);const r=this.s,i={mapId:this.i,layerId:r,command:"loadTile",params:n},{x:s,y:o}=t.tileInfo,a=(s+o)%this.workers.length;this.send(i,null,e,void 0===this.l[r]?this.workers[a].id:this.l[r])}remove(){super.remove(),this.l={}}fetchIconGlyphs({icons:t,glyphs:e},n){this.u.getGlyphs(e,(e,r)=>{if(e)throw e;const i=r.buffers||[];this.h.getIcons(t,(t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&i.push(...e.buffers),n(null,{icons:e.icons,glyphs:r.glyphs},i)})})}setData(t,e){const n=this.s,r={mapId:this.i,layerId:n,command:"setData",params:{data:t}};this.send(r,null,e,this.l[n])}m(t){return t.id}}const Ot={},Et={collision:!0,fading:!1,fadingDuration:224,fadeInDelay:600,fadeOutDelay:100,uniquePlacement:!1,depthFunc:"always"};class Pt{constructor(t,e,n){this.v=t,this.A=e,this._=n||[0,1,0]}draw(t,e,n,r,i){if(this.S||this.M(),!this.P){this.P=this.v.buffer(kt(r));const t=r/n;this.T=this.v.buffer(Rt(r,t))}if(r!==this.k){const t=r/n;this.P(kt(r)),this.T(Rt(r,t))}this.k=r;let s=this.O;if(!s){const t=this.A.getDevicePixelRatio()>1?2:1;s=this.O=document.createElement("canvas"),s.width=512*t,s.height=64*t;const e=s.getContext("2d");e.font="36px monospace",e.scale(t,t),this.I=this.v.texture({width:s.width,height:s.height,data:s})}const o=s.getContext("2d");o.clearRect(0,0,s.width,s.height),o.fillStyle=`rgba(${this._.map(t=>255*t).join()})`,o.fillText(t,20,36),this.I({width:s.width,height:s.height,data:s}),this.S({transform:e,data:this.P,texData:this.F,debugLine:1,primitive:"lines",framebuffer:i||null,image:this.I,count:8}),this.S({transform:e,data:this.T,texData:this.F,debugLine:0,primitive:"triangle strip",framebuffer:i||null,image:this.I,count:4})}delete(){this.I&&(this.I.destroy(),delete this.I),this.F&&(this.F.destroy(),delete this.F),this.P&&(this.P.destroy(),this.T.destroy(),delete this.P,delete this.T),this.S&&(this.S.destroy(),delete this.S)}M(){this.F=this.v.buffer(new Uint8Array([0,0,0,1,1,0,1,1,0,0,0,1,1,0,1,1])),this.S=this.v({vert:"\n                attribute vec2 aPosition;\n                attribute vec2 aTexCoord;\n                uniform mat4 transform;\n\n                varying vec2 vTexCoord;\n                void main()\n                {\n                    gl_Position = transform * vec4(aPosition, 0.0, 1.0);\n                    vTexCoord = aTexCoord;\n                }\n            ",frag:"\n                precision mediump float;\n                uniform sampler2D uImage;\n                uniform vec3 uColor;\n                uniform float uOpacity;\n                uniform float uDebugLine;\n\n                varying vec2 vTexCoord;\n\n                void main()\n                {\n                    if (uDebugLine == 1.) {\n                        gl_FragColor = vec4(uColor, 1.0) * uOpacity;\n                    } else {\n                        gl_FragColor = texture2D(uImage, vTexCoord) * uOpacity;\n                    }\n                    gl_FragColor *= gl_FragColor.a;\n                }\n            ",attributes:{aPosition:this.v.prop("data"),aTexCoord:this.v.prop("texData")},uniforms:{transform:this.v.prop("transform"),uColor:this._,uOpacity:1,uDebugLine:this.v.prop("debugLine"),uImage:this.v.prop("image")},count:this.v.prop("count"),primitive:this.v.prop("primitive"),depth:{enable:!1,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},stencil:{enable:!1},viewport:{x:0,y:0,width:()=>this.A.getRenderer().canvas.width,height:()=>this.A.getRenderer().canvas.height},framebuffer:this.v.prop("framebuffer")})}}function kt(t){return new Uint16Array([0,0,0,t,0,t,t,t,t,t,t,0,t,0,0,0])}function Rt(t,e){return new Uint16Array([0,t-64*e,0,t,512*e,t-64*e,512*e,t])}const Nt=new Uint8Array([0,0,0,1,1,0,1,0,0,1,1,1]),Dt=[];class Ft{constructor(t,e,n){this.v=t,(this.C=new r["m"].Geometry({aPosition:Nt},null,Nt.length/2,{positionSize:2})).generateBuffers(t),this.D=new r["m"].Scene,this.N=[],this.L=0,this.R=e,this.A=n,this.M(t)}start(){this.L=0,this.D.clear()}add(t,e,n){const i=this.H(n);i.setUniform("ref",t),r["p"].set(Dt,e,e,1);const s=i.localTransform;r["k"].fromScaling(s,Dt),r["k"].mul(s,n,s),i.setLocalTransform(s),this.D.addMesh(i)}render(t){this.V.render(this.U,{projViewMatrix:this.A.projViewMatrix},this.D,t)}H(){const t=this.L++;return this.N[t]||(this.N[t]=new r["m"].Mesh(this.C)),this.N[t]}M(t){const e=this.R,n={viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},stencil:{enable:!0,mask:255,func:{cmp:"always",ref:(t,e)=>e.ref,mask:255},op:{fail:"replace",zfail:"replace",zpass:"replace"}},depth:{enable:!0,func:"always",mask:!1},colorMask:[!1,!1,!1,!1]};this.U=new r["m"].MeshShader({vert:"\n#define SHADER_NAME TILE_STENCIL_VERT\nattribute vec2 aPosition;\nuniform mat4 projViewModelMatrix;\n\nvoid main()\n{\n    gl_Position = projViewModelMatrix * vec4(aPosition, 0.0, 1.0);\n}\n",frag:"\n#define SHADER_NAME TILE_STENCIL_FRAG\nvoid main()\n{\n    gl_FragColor = vec4(1.0, 0.0, 0.0, 0.1);\n}\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:n}),this.V=new r["m"].Renderer(t)}remove(){this.C.dispose();for(let t=0;t<this.N.length;t++)this.N[t].dispose();this.N.length=0,this.U.dispose()}}const Lt=new Float32Array([-1e12])[0],zt="__fea_idx".trim();function Bt(t,e,n,r,s,o){const a={};if(function(t){if(!t)return!1;for(const e in t)if(void 0!==t[e]&&null!==t[e])return!0;return!1}(t))for(let l=0,h=(e||t).length;l<h;l++){let h=e?t[e[l]]:t[l];"id"===s.options.features&&s.getFeature&&(h=s.getFeature(h),h.layer=n),s instanceof i["H"]&&(h=Gt(h,o)),a[e?e[l]:h[zt]]={feature:h,symbol:r}}return a}const Ht="__original_properties",Ut="__external_properties",jt={get:function(t,e){return e in t?t[e]:t[Ht][e]||t[Ut]&&t[Ut][e]},has:function(t,e){return e in t||e in t[Ht]||t[Ut]&&e in t[Ut]}},Vt={};function Gt(t,e){const n=t.properties;if(n&&n[Ht])return t;e&&(t=mt({},t)),t.customProps=t.customProps||{};const r=t.customProps;return r.$layer=t.layer,r.$type=t.type,r[Ht]=n||Vt,t.properties=new Proxy(r,jt),t}function qt(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function Wt(t,e,n){return Math.min(n,Math.max(e,t))}function Xt(t,e,n){if(t===n||t===e)return t;const r=n-e;return((t-e)%r+r)%r+e}function Qt(t){return null==t}function Yt(t){return JSON.parse(JSON.stringify(t))}function Zt(t,e,n,r,i,o){e in t||Object.defineProperty(t,e,{enumerable:!0,get:function(){const t=Qt(n[r])||Object(s["c"])(n[r])?i:n[r];return o?o(t):t}})}const Kt=[];function Jt(t){for(let e=0;e<t.length;e++)Kt[e]=t[e],Kt[e]*=255;return 3===t.length&&(Kt[3]=255),Kt}function $t(t,e=4){return te.bind(this,t,e)}function te(t,e,n){if(Array.isArray(n))return 3===n.length&&4===e&&n.push(1),n;if(t&&t[n])return t[n];if(void 0!==n.r&&void 0!==n.g&&void 0!==n.b&&void 0!==n.a)return[n.r,n.g,n.b,n.a];const r=l()(n).unitArray();return 3===r.length&&4===e&&r.push(1),t&&(t[n]=r),r}function ee(t,e,n,r){if(t.fill)t.fill(e,n,r);else for(let i=n;i<r;i++)t[i]=e}function ne(t){return"number"==typeof t&&!isNaN(t)}function re(t){return t&&(t.markerFile||t.markerType)&&void 0!==t.textName}function ie(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function se(t,e){if(e){let e=t[t.length-1];const n=[e];for(let r=t.length-2;r>=0;r--)t[r]!==e&&(n.push(t[r]),e=t[r]);return n}{let e=t[t[0]];const n=[e];for(let r=1;r<t.length;r++)t[r]!==e&&(n.push(t[r]),e=t[r]);return n}}const oe=new i["f"](0,0);function ae(t,e,n,r,i){const s=t.distanceToPointAtRes(e,e,r,n,oe);return i?s.y:s.x}const le=[],he=[0,0,0,0],ce=new i["A"](0,0),ue={color:he,depth:1,stencil:0},fe=t=>t.isTerrainSkin(),de=t=>t.isTerrainVector();class pe extends i["P"].TileLayerCanvasRenderer{supportRenderMode(){return!0}constructor(t){super(t),this.ready=!1,this.j=0,this.B={},this.G={},this.W={}}getTileLevelValue(t,e){if(this.isBackTile(t.id)){const n=t.z,r=5;return n-e>=0?e+r-n:r+(e-n)}return 0}getWorkerConnection(){return this.X}getStyleCounter(){return this.j}setStyle(t){if(this.Y&&this.Y.update(),this.X){this.j++,this.$();const e=this.layer.q();e.styleCounter=this.j,this.X.updateStyle(e,e=>{if(e)throw new Error(e);t||(this.J=!0,this.Z(),this.setToRedraw()),this.layer.fire("refreshstyle")})}else this.Z()}$(){if(this.K)for(const e in this.K){const t=this.K[e];t&&this.deleteTile(t)}this.K=this.tilesInView;const t=this.tileCache;for(const e in this.K){const n=this.K[e];n&&n.info&&t.getAndRemove(n.info.id)}t.reset(),this.tilesInView={},this.tilesLoading={},this.B={},this._parentTiles=[],this._childTiles=[]}updateOptions(t){this.X&&this.X.updateOptions(this.layer.getWorkerOptions(),e=>{if(e)throw new Error(e);t&&(t.features||t.pickingGeometry||t.altitudeProperty)&&(this.clear(),this.tt(),this.Z()),this.setToRedraw()})}updateSceneConfig(t,e,n){const r=0===t?this.et():this.nt();if(!r||!r[e])return;this.J=!0;const i=this.layer.q(),s=this.layer.it(t,i);r[e].config=s[e].renderPlugin,r[e].updateSceneConfig({sceneConfig:n}),this.setToRedraw()}updateDataConfig(t,e,n,r){const i=0===t?this.et():this.nt();i&&i[e]&&(this.J=!0,i[e].updateDataConfig(n,r)?this.setStyle():this.setToRedraw())}updateSymbol(t,e,n){const r=0===t?this.et():this.nt();if(!r||!r[e])return!1;const i=this.layer.q(),a=this.layer.it(t,i),l=r[e];l.style=a[e];const h=l.updateSymbol(n,a[e].symbol);return!h&&function t(e){if(Array.isArray(e)){const n=e;for(let e=0;e<n.length;e++)if(t(n[e]))return!0}for(const n in e)if(Object(s["c"])(e[n])||o["c"].isExpression(e[n]))return!0;return!1}(n)&&this.setStyle(!0),this.setToRedraw(),h}needToRedraw(){const t=super.needToRedraw();if(!t){const t=this.rt();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRedraw())return!0}return t}needRetireFrames(){if(this.J)return!0;const t=this.rt();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRetireFrames())return!0;return!1}isAnimating(){const t=this.rt();for(let e=0;e<t.length;e++)if(t[e]&&t[e].isAnimating())return!0;return!1}needToRefreshTerrainTileOnZooming(){const t=this.rt();for(let e=0;e<t.length;e++)if(t[e]&&t[e].needToRefreshTerrainTileOnZooming())return!0;return!1}st(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const{gl:t,regl:e,attributes:n}=this.ot(this.canvas);this.gl=t,this.regl=e,this.glOptions=n}if(t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.lt=new Pt(this.regl,this.getMap()),this.ht(),this.Y=new r["a"](this.regl,this.layer),!this.consumeTile){const t=this.getMap().VERSION;throw new Error(`Incompatible version of maptalks: ${t}, upgrade maptalks >= v1.0.0-rc.14`)}}ot(t){const e=this.layer,n=e.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};n.preserveDrawingBuffer=!0,n.stencil=!0;const i=this.ut(t,n);return{gl:i,attributes:n,regl:Object(r["h"])({gl:i,attributes:n,extensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],optionalExtensions:e.options.glExtensions||["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_draw_buffers","EXT_shader_texture_lod","EXT_frag_depth"]})}}ht(){this.X||(this.X=new Ct("@maptalks/vt",this.layer)),this.X.addLayer((t,e)=>{this.layer&&(this.ready=!0,this.layer.onWorkerReady(t,e),this.layer.fire("workerready"),this.setToRedraw())})}clearCanvas(){super.clearCanvas(),this.regl&&(this.glOptions.depth?this.regl.clear({color:he,depth:1,stencil:0}):this.regl.clear({color:he,stencil:0}))}isDrawable(){return!0}checkResources(){return le}_drawTiles(t,e,n,r,i){if(super._drawTiles(t,e,n,r,i),this.K)if(Object.keys(this.K).length)for(const s in this.K){const t=this.K[s];this.tileCache.has(t.id)||this._drawTile(t.info,t.image,i)}else this.ct(),delete this.K}ct(){const t=this.j,e=[],n=[];for(const r in this.G)+r!==t&&(e.push(r),this.et(r).forEach(t=>{t.remove()}));for(const r in this.W)+r!==t&&(n.push(r),this.nt(r).forEach(t=>{t.remove()}));for(let r=0;r<e.length;r++)delete this.G[e[r]];for(let r=0;r<n.length;r++)delete this.W[n[r]]}draw(t,e){this.ft!==t&&(this.J=!1,this.dt());const n=this.layer;if(this.prepareCanvas(),!this.ready||!n.ready)return void this.completeRender();let r=this.G[this.j];r||(this.Z(),this.dt(),r=this.et());const i=this.nt();n.isDefaultRender()||r.length||i.length?(n.options.collision&&n.clearCollisionIndex(),this.pt=t,this.yt=this.gt(this.getMap().getGLRes()),this.vt=e||{},this.xt(t),super.draw(t),this.ft!==t&&this.bt(t),this.At(t),this.completeRender(),this.ft=t):this.completeRender()}dt(){this.rt().forEach((t,e)=>{t&&(t.renderIndex=e)})}bt(){const t=this.rt();this.wt=this.wt||[];let e=0;for(let n=t.length-1;n>=0;n--){const r=t[n];r.isVisible()&&r.hasMesh()&&(this.wt[n]=e,r.needPolygonOffset()&&e++)}this.Y.isEnable()&&e++,this._t=e}getFrameTimestamp(){return this.pt}drawOnInteracting(t,e,n){this.draw(e,n)}drawOutline(t){(this.St||this.Mt)&&(this.Mt?this.paintOutlineAll(t):this.St.forEach(e=>{this[e[0]](t,...e[1])}))}getAnalysisMeshes(){return this.getShadowMeshes()}getShadowMeshes(){const t=[];return this.Pt().forEach(e=>{if(!e)return;if(!this.Tt(e))return;const n=e.getShadowMeshes();if(Array.isArray(n))for(let r=0;r<n.length;r++)t.push(n[r])}),t}isForeground(t){return!(!this.kt||!this.kt[t.properties.tile.id])}Ot(t){const e=this.layer;let n=e._getTileZoom(this.getMap().getZoom());const r=e.getMinZoom(),s=e.getMaxZoom();return n=i["I"].clamp(n,r,s),n-t.properties.tile.z}isTileNearCamera(t){return this.Ot(t)<=1}isBackTile(t){return!(!this.It||!this.It[t])}loadTile(t){const{url:e}=t,n=this.B[e];if(n)n.keys[t.id]||(n.tiles.push(t),n.keys[t.id]=1);else{const n=this.getMap(),r=ce.set(t.extent2d.xmin,t.extent2d.ymax),s=n.pointAtResToCoord(new i["A"](r),t.res),o=[ae(n,1,s,t.res)/100,ae(n,1,s,t.res,1)/100],a=this.getCentimeterToPoint(t.z),l=this.getTileGLScale(t.z);this.B[e]={keys:{},tiles:[t]},this.B[e].keys[t.id]=1;const h=this.layer.options.fetchOptions,c=window&&window.location.href;this.X.loadTile({tileInfo:{res:t.res,x:t.x,y:t.y,z:t.z,url:t.url,id:t.id,extent2d:t.extent2d},glScale:l,zScale:this.yt,centimeterToPoint:o,verticalCentimeterToPoint:a,fetchOptions:h,styleCounter:this.j,referrer:c},this.Ft.bind(this,e))}return{}}getTileGLScale(t){const e=this.getMap();return this.layer.getSpatialReference().getResolution(t)/e.getGLRes()}getCentimeterToPoint(t){const e=this.getMap();return St(this.layer.getSpatialReference().getResolution(t),e)}getRenderedFeatures(){const t=[],e=this.tileCache.keys();for(let n=0;n<e.length;n++){const r=this.tileCache.get(e[n]);if(!r||!r.info||!r.image)continue;const{info:i,image:s}=r,o=ve(s);t.push({tile:{id:i.id,x:i.x,y:i.y,z:i.z,url:i.url},current:!!this.tilesInView[i.id],features:o})}return t}Ft(t,e,n){if(this.setToRedraw(),!this.B[t])return;if(n&&n.canceled)return;const r=this.layer,i=r.isDefaultRender(),{tiles:s}=this.B[t];if(delete this.B[t],e){if(e.status&&(404===e.status||204===e.status))for(let t=0;t<s.length;t++){const e=s[t];this.onTileError(Ot,e)}return}if(!n){for(let t=0;t<s.length;t++){const e=s[t];this.consumeTile({Ct:!0},e)}return}if(n.style!==this.j)return;let o=!1;const a=n.features,l=[];for(let u=0;u<n.data.length;u++){const t=n.data[u];if(!t||!t.data||!t.styledFeatures.length)continue;const{isUpdated:e,layer:r}=this.Et(0,u,t,a,l);l.push(r),e&&(o=e)}for(let u=0;u<n.featureData.length;u++){const t=n.featureData[u];t&&t.data&&t.styledFeatures.length&&this.Et(1,u,t,a)}o&&r.Dt();const h=s[0].z,c=this.layer.getDataSchema(h);if(this.Nt(c,n.schema),delete n.features,i&&n.data.length!==l.length){const t=n.data;n.data=[];for(let e=0;e<t.length;e++)t[e]&&t[e].features&&n.data.push(t[e])}n.layers=l;for(let u=0;u<s.length;u++){const t=s[u];if(0===u&&r.options.debugTileData){const{x:e,y:n,z:i}=t;console.log("tile",{layerId:r.getId(),x:e,y:n,z:i,layers:me(Object.values(a))})}const e=0===u?n:Ae(n);for(let n=0;n<e.data.length;n++){if(!e.data[n])continue;const r=e.data[n].features;for(const e in r)r[e].tile=t}t.extent=e&&e.extent,e.features=Object.values(a),this.onTileLoad(e,t)}this.layer.fire("datareceived",{url:t})}Et(t,e,n,r){const{style:i,isUpdated:s}=this.Lt(t,e,n.data),o=this.layer,a=o.isDefaultRender(),l=i.symbol,h=Bt(r,n.styledFeatures,e,l,o,!(!o.getData||!o.getData()));delete n.styledFeatures,n.features=h;let c=n.data;return Array.isArray(c)&&(c=c[0]),{isUpdated:s,layer:a?{layer:c.layer,type:c.type}:null}}Nt(t,e){for(const n in e){t[n]||(t[n]={types:e[n].types,properties:{}});const r=e[n].properties,i=t[n].properties;for(const t in r)(!i[t]||i[t]&&"object"!==r[t]&&"object"===i[t])&&(i[t]=r[t])}}Lt(t,e,n){Array.isArray(n)&&(n=n[0]);const r=this.layer;let i,s=!1;if(r.isDefaultRender()&&0===t){let t=this.Rt;t||(t=this.Rt={});const e=n.layer,r=n.type;t[e]||(t[e]=[]);const o=("plugin_"+r).trim();t[e][o]?i=t[e][o]:(i=this.Ht(r),i.filter=n.filter,t[e].push(i),t[e][o]=i,s=!0)}else{const o=r.q(),a=r.it(t,o),l=this.et();if(i=a[e],!i.renderPlugin){s=!0;const{plugin:t,symbol:r,renderPlugin:o}=this.Ht(n.type);l[e]=t,i.symbol=r,i.renderPlugin=o}}return{style:i,isUpdated:s}}rt(t){const e=t&&t.style;let n=this.et(e)||[];this.layer.isDefaultRender()&&this.Rt&&(n=[],t?t.layers&&t.layers.forEach(t=>{if(!t)return;const e=("plugin_"+t.type).trim();n.push(this.Rt[t.layer][e].plugin)}):Object.keys(this.Rt).forEach(t=>{for(let e=0;e<this.Rt[t].length;e++)n.push(this.Rt[t][e].plugin)}));const r=this.nt(e);return r&&r.length&&(n=n.slice(),_t(n,r)),n}Pt(){if(this.layer.isDefaultRender()&&this.Rt){const t=[];return Object.keys(this.Rt).forEach(e=>{for(let n=0;n<this.Rt[e].length;n++)t.push(this.Rt[e][n].plugin)}),t}const t=[];for(const e in this.G)t.push(...this.G[e]);for(const e in this.W)t.push(...this.W[e]);return t}et(t){return wt(t)&&(t=this.j),this.G[t]||le}nt(t){return wt(t)&&(t=this.j),this.W[t]||le}xt(t,e){const n=!!this.zt,r=this.layer.isDefaultRender()&&this.Rt,i=this.vt;this.Pt().forEach((s,o)=>{if(!s||e&&!e(s))return;if(!this.Tt(o))return;const a=this.regl,l=this.gl,h=r?s.defaultSymbol:s.style&&s.style.symbol,c={regl:a,layer:this.layer,symbol:h,gl:l,isRenderingTerrain:n,sceneConfig:s.config?s.config.sceneConfig:null,dataConfig:s.config?s.config.dataConfig:null,pluginIndex:o,timestamp:t};i&&mt(c,i),s.startFrame(c)})}At(t){const e=this.vt,n=e.renderMode,r=e&&e.renderTarget&&e.renderTarget.fbo,i=this.getMap().cameraPosition,s=this.Pt(),o=!!this.zt,a=!e.timestamp||e.isFinalRender;this.layer.options.collision&&!e.isPostProcess?s.forEach(e=>{if(!this.Tt(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(o&&!de(e))return;const r=this.Vt(e,0,i,t);e.prepareRender(r),e.updateCollision(r)}):s.forEach(e=>{if(!this.Tt(e)||!e.hasMesh())return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(o&&!de(e))return;const r=this.Vt(e,0,i,t);e.prepareRender(r)});const l=this.ft!==e.timestamp;let h=!1;if(l&&!o){const e=this.layer.getPolygonOffset()+this.layer.getPolygonOffsetCount(),n=this.Vt(null,e,i,t);n.offsetFactor=e,n.offsetUnits=e,this.Y.paint(n)}s.forEach((e,s)=>{if(!this.Ut(e))return;if(n&&"default"!==n&&!e.supportRenderMode(n))return;if(o&&!de(e))return;this.regl.clear({stencil:255,framebuffer:r}),this.isEnableTileStencil()&&e.painter&&!e.painter.needClearStencil()&&this.jt(r);const a=this.wt[s]||0,l=this.Vt(e,a,i,t),c=e.endFrame(l);c&&c.redraw&&this.setToRedraw(),h=!0}),h&&this.layer.fire("canvasisdirty"),a&&this.Bt()}getPolygonOffsetCount(){return this._t||0}Bt(){if(this.layer.options.debug){const t=this.vt,e=[],n=this.getMap().projViewMatrix;for(const i in this.tilesInView){const s=this.tilesInView[i].info,o=s.transform,a=this.tilesInView[i].image.extent,l=t&&t.renderTarget;if(o&&a){const t=this.getDebugInfo(s.id),i=r["k"].multiply(e,n,o),h=this.layer.getTileSize().width;this.lt.draw(t,i,h,a,l&&l.fbo)}}}}Ut(t){if(!t)return!0;const e=this.vt,n=this.Tt(t),r=e&&e.states&&e.states.includesChanged,i=this.Gt(t.painter.scene.getMeshes());return n&&(r||i)?i?2:1:0}Vt(t,e,n,r){const i=!!this.zt,s=i&&t&&fe(t),o=this.regl,a=this.gl,l={regl:o,layer:this.layer,gl:a,isRenderingTerrain:i,isRenderingTerrainSkin:s,sceneConfig:t&&t.config.sceneConfig,pluginIndex:t&&t.renderIndex,polygonOffsetIndex:e,cameraPosition:n,timestamp:r},h=this.vt;return h&&mt(l,h),l}Gt(t){if(!t)return!1;const e=this.vt&&this.vt.sceneFilter;return e?t.filter(t=>e(t)||t.properties.hlBloomMesh&&e(t.properties.hlBloomMesh)).length>0:t.length>0}jt(t){const e=this.isEnableTileStencil(),n=this.getCurrentTileZoom();let r=this.Wt;r||(r=this.Wt=new Ft(this.regl,this.canvas,this.getMap())),r.start();const{tiles:i}=this.Xt;let{parentTiles:s,childTiles:o}=this.Xt,a=1;o=o.sort(ge);for(let h=0;h<o.length;h++)this.Yt(o[h].info,e?a:this.getTileLevelValue(o[h].info.z,n)),a++;s=s.sort(ge);for(let h=0;h<s.length;h++)this.Yt(s[h].info,e?a:this.getTileLevelValue(s[h].info.z,n)),a++;const l=i.sort(ge);for(let h=l.length-1;h>=0;h--)this.Yt(l[h].info,e?a:this.getTileLevelValue(l[h].info.z,n)),a++;r.render(t)}Yt(t,e){const n=ce.set(t.extent2d.xmin,t.extent2d.ymax),r=t.transform=t.transform||this.calculateTileMatrix(n,t.z,t.extent);t.stencilRef=e,this.Wt.add(e,t.extent,r)}onDrawTileStart(t){super.onDrawTileStart(t);const{tiles:e,childTiles:n,parentTiles:r}=t;this.kt={},this.It={};for(let i=0;i<e.length;i++)this.kt[e[i].info.id]=1;for(let i=0;i<n.length;i++)this.It[n[i].info.id]=1;for(let i=0;i<r.length;i++)this.It[r[i].info.id]=1;this.Xt=t}isEnableTileStencil(){if(this.layer.options.altitude)return!1;const t=this.rt();for(let e=0;e<t.length;e++)if(t[e]&&t[e].painter&&!t[e].painter.isOnly2D())return!1;return!0}setTerrainHelper(t){this.zt=t}getTerrainHelper(){return this.zt}drawTileOnTerrain(...t){pe.prototype.drawTile.call(this,...t)}createTerrainTexture(t){const e=this.layer.getTileSize().width,n=2*e,r=2*e,i=t.texture({min:"linear",mag:"linear",type:"uint8",width:n,height:r});this.$t||(this.$t=t.renderbuffer({width:n,height:r,format:"depth24 stencil8"}));const s={width:n,height:r,colors:[i],colorFormat:"rgba",ignoreStatusCheck:!0};s.depthStencil=this.$t;const o=t.framebuffer(s);return o.colorTex=i,o}deleteTerrainTexture(t){t.destroy(),t.colorTex&&(t.colorTex.destroy(),delete t.colorTex)}renderTerrainSkin(t,e,n){const r=this.ft,i=this.vt,s=this.layer.getTileSize().width;this.xt(r);for(let o=0;o<n.length;o++){const e=n[o].texture;this.vt={renderTarget:{fbo:e}},ue.framebuffer=e,t.clear(ue),this.vt.viewport=ye(s),this.qt(n[o].tile,e)}this.Jt(n),this.vt=i}qt(t){const{info:e,image:n}=t;this.drawTile(e,n,fe)}Jt(t){const e=this.Pt(),n=this.getMap().cameraPosition,r=this.ft||0;this.layer.options.collision?e.forEach(t=>{if(!this.Tt(t)||!t.hasMesh())return;if(!fe(t)||!this.layer.options.awareOfTerrain)return;const e=this.Vt(t,0,n,r);e.isRenderingTerrainSkin=!0,t.prepareRender(e),t.updateCollision(e)}):e.forEach(t=>{if(!this.Tt(t)||!t.hasMesh())return;if(!fe(t)||!this.layer.options.awareOfTerrain)return;const e=this.Vt(t,0,n,r);e.isRenderingTerrainSkin=!0,t.prepareRender(e)}),e.forEach((e,n)=>{if(!this.Ut(e)||!fe(e))return;for(let s=0;s<t.length;s++){const e=t[s].texture;this.regl.clear({stencil:255,framebuffer:e})}const r=this.wt[n]||0,i=this.Vt(e,r,[0,0,0],this.ft);i.isRenderingTerrainSkin=!0,e.endFrame(i)})}drawTile(t,e,n){if(!e.cache)return;const r=!!this.zt,i=e.cache,s=ce.set(t.extent2d.xmin,t.extent2d.ymax),o=t.transform=t.transform||this.calculateTileMatrix(s,t.z,t.extent),a=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(s,t.z),l=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(s,t.z,t.extent),h=this.vt,c=[];_t(c,e.data),_t(c,e.featureData),this.rt(e).forEach((s,u)=>{if(!s||n&&!n(s))return;if(!c[u])return;if(!i[u])return;const f=r&&fe(s),d=this.regl,p=this.gl,A={regl:d,layer:this.layer,gl:p,sceneConfig:s.config.sceneConfig,pluginIndex:u,tileCache:i[u],tileData:c[u],tileTransform:f?l:o,tileVectorTransform:o,tileTranslationMatrix:a,tileExtent:e.extent,timestamp:this.pt,tileInfo:t,tileZoom:this._tileZoom,bloom:this.vt&&this.vt.bloom,isRenderingTerrain:r,isRenderingTerrainSkin:f};f&&h&&h.renderTarget&&(A.renderTarget=h.renderTarget);const g=s.paintTile(A);!this.J&&(g.retire||g.redraw)&&s.supportRenderMode("taa")&&(this.J=!0),g.redraw&&this.setToRedraw()}),e&&e.style===this.j&&this.Zt(t),this.setCanvasUpdated()}Kt(t,e){if(!e.loadTime||e.Ct)return;let n=e.cache;n||(n=e.cache={});const r=!!this.zt,i=ce.set(t.extent2d.xmin,t.extent2d.ymax),s=t.transform=t.transform||this.calculateTileMatrix(i,t.z,e.extent),o=t.tileTranslationMatrix=t.tileTranslationMatrix||this.calculateTileTranslationMatrix(i,t.z),a=t.terrainTransform=t.terrainTransform||this.calculateTerrainTileMatrix(i,t.z,t.extent),l=[];_t(l,e.data),_t(l,e.featureData),this.rt(e).forEach((i,h)=>{if(!i)return;if(!l[h])return;const c=r&&fe(i),u=this.regl,f=this.gl;n[h]||(n[h]={});const d={regl:u,layer:this.layer,gl:f,sceneConfig:i.config.sceneConfig,pluginIndex:h,tileCache:n[h],tileData:l[h],tileTransform:c?a:s,tileVectorTransform:s,isRenderingTerrain:r,isRenderingTerrainSkin:c,tileTranslationMatrix:o,tileExtent:e.extent,timestamp:this.pt,tileInfo:t,tileZoom:this._tileZoom},p=i.createTile(d);n[h].geometry&&(e.data[h]=1),!this.J&&p.retire&&i.supportRenderMode("taa")&&(this.J=!0)})}checkTileInQueue(t){return t.style===this.j}pick(t,e,n){const r=[];return this.layer.isVisible()?(this.rt().forEach(i=>{if(!i)return;if(!this.Tt(i))return;const s=i.pick(t,e,n.tolerance);s&&(s.type=i.getType(),r.push(s))}),r):r}deleteTile(t){if(t){if(t.image&&!t.image.Ct){const e=t.image&&t.image.style,n=this.et(e);n&&n.forEach((e,n)=>{e&&e.deleteTile({pluginIndex:n,regl:this.regl,layer:this.layer,gl:this.gl,tileCache:t.image.cache?t.image.cache[n]:{},tileInfo:t.info,tileData:t.image})}),t.image.cache={}}t.info&&(delete t.info.completeTerrainQuery,delete t.info.terrainQueryStatus),super.deleteTile(t)}}abortTileLoading(t,e){e&&e.url&&(this.X&&this.X.abortTile(e.url),delete this.B[e.url]),super.abortTileLoading(t,e)}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||(this.pickingFBO.resize(e.width,e.height),this.rt().forEach(t=>{t&&t.resize(e.width,e.height)})))}onRemove(){this.Wt&&this.Wt.remove(),this.X&&(this.X.removeLayer(t=>{if(t)throw t}),this.X.remove(),delete this.X),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.lt&&(this.lt.delete(),delete this.lt),this.$t&&(this.$t.destroy(),delete this.$t),this.Y&&(this.Y.dispose(),delete this.Y),super.onRemove&&super.onRemove(),this.tt()}tt(){this.Pt().forEach(t=>{t.remove()}),this.plugins={}}hitDetect(t){if(!this.gl||!this.layer.options.hitDetect)return!1;const e=this.gl,n=new Uint8Array(4),r=this.canvas.height;return e.readPixels(t.x,r-t.y,1,1,e.RGBA,e.UNSIGNED_BYTE,n),n[3]>0}Z(){const{style:t,featureStyle:e}=this.layer.q(),n=t.map((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for style at "+e);const r=this.Qt(n);return r.styleCounter=this.j,r.style=t,r}),r=[];e.forEach((t,e)=>{const n=t.renderPlugin;if(!n)return null;if(!n.type)throw new Error("invalid plugin type for features at "+e);const i=this.Qt(n);return i.style=t,i.styleCounter=this.j,r.push(i),i});const i=this.j;return this.G[i]=n,this.W[i]=r,this.layer.fire("pluginsinited"),(this.te&&this.te.size||this.layer.te)&&(this.layer.te&&this.layer.ee(),this.getMap().getRenderer().callInNextFrame(()=>{this.rt().forEach(t=>{t.highlight(this.te)})})),n}Qt(t){const e=this.layer.constructor.getPlugins()[t.type];if(!e)throw new Error(`Plugin for (${t.type}) is not loaded.`);const n=new e;return n.config=t,n.config.sceneConfig||(n.config.sceneConfig={}),n}ut(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}gt(t){return St(t,this.getMap())}debugFBO(t,e){const n=document.getElementById(t),r=e.width,i=e.height;n.width=r,n.height=i;const s=n.getContext("2d"),o=this.regl.read({framebuffer:e}),a=i/2|0,l=4*r;for(let u=0;u<o.length;u++)o[u]*=255;const h=new Uint8Array(4*r);for(let u=0;u<a;++u){const t=u*l,e=(i-u-1)*l;h.set(o.subarray(t,t+l)),o.copyWithin(t,e,e+l),o.set(h,e)}const c=new ImageData(r,i);c.data.set(o),s.putImageData(c,0,0)}Ht(t){let e;switch(t){case"native-line":e={type:"native-line",dataConfig:{type:"native-line",only2D:!0}};break;case"native-point":e={type:"native-point",dataConfig:{type:"native-point",only2D:!0}};break;case"fill":e={type:"fill",dataConfig:{type:"fill",only2D:!0},sceneConfig:{antialias:!0}};break;default:e=null}const n=function(t){switch(t){case"native-point":return{markerFill:"#f00",markerSize:6,markerOpacity:.5};case"native-line":return{lineColor:"#bbb",lineOpacity:.5};case"fill":return{polygonFill:"#76a6f0",polygonOpacity:.8}}return null}(t),r=this.Qt(e);return r.defaultSymbol=n,{plugin:r,symbol:n,renderPlugin:e}}Tt(){return!0}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&function(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),r="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&r)return!0}return!1}(this.gl)}getZScale(){return this.yt}outline(t,e){e&&(Array.isArray(e)||(e=[e]),this.St||(this.St=[]),this.St.push(["paintOutline",[t,e]]),this.setToRedraw())}outlineFeatures(t){t&&(Array.isArray(t)||(t=[t]),this.St||(this.St=[]),this.St.push(["paintOutline",[null,t]]),this.setToRedraw())}outlineBatch(t){this.St||(this.St=[]),this.St.push(["paintBatchOutline",[t]]),this.setToRedraw()}outlineAll(){this.Mt=!0,this.setToRedraw()}paintOutlineAll(t){const e=this.rt();for(let n=0;n<e.length;n++)e[n].outlineAll(t)}paintOutline(t,e,n){if(!wt(e)){const r=e,i=this.rt();if(!i[r]||i[r].painter&&!i[r].painter.isVisible())return;return void i[r].outline(t,n)}const r=this.rt();for(let i=0;i<n.length;i++){const e=n[i];for(let n=0;n<r.length;n++)r[n].style&&r[n].style.id===e&&r[n].outline(t,[e])}}paintBatchOutline(t,e){const n=this.rt();!n[e]||n[e].painter&&!n[e].painter.isVisible()||n[e].outlineAll(t)}cancelOutline(){delete this.St,delete this.Mt,this.setToRedraw()}setZIndex(){return this.setToRedraw(),this.J=!0,super.setZIndex.apply(this,arguments)}consumeTile(t,e){if(this.Zt(e),super.consumeTile(t,e),"transient"===this.layer.options.features&&t.data){for(let e=0;e<t.data.length;e++){if(!t.data[e])continue;const n=t.data[e].features;if(n)for(const t in n){const e=n[t]&&n[t].feature;e&&(e.fnTypeProps?e.customProps[Ht]=e.fnTypeProps:n[t]=null)}}this.layer.fire("_transientfeature",{tileImage:t})}t&&t.features&&(t.features=[]),this.Kt(e,t)}onTileError(t,e){this.Zt(e),super.onTileError(t,e)}Zt(t){const{id:e}=t;if(this.K&&this.K[e]){const t=this.K[e];this.deleteTile(t),delete this.K[e]}}highlight(t){if(this.te||(this.te=new Map),Array.isArray(t))for(let e=0;e<t.length;e++)wt(t[e].name)&&!wt(t[e].id)&&(t[e]=mt({},t[e]),t[e].name=t[e].id),this.te.set(t[e].name,t[e]);else wt(t.name)&&!wt(t.id)&&((t=mt({},t)).name=t.id),this.te.set(t.name,t);this.rt().forEach(t=>{t.highlight(this.te)})}cancelHighlight(t){if(this.te){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.te.delete(t[e]);else this.te.delete(t);this.rt().forEach(t=>{t.highlight(this.te)})}}cancelAllHighlight(){delete this.te,this.rt().forEach(t=>{t.cancelAllHighlight()})}ne(){const t=this.layer.options.opacity;return this.st()?wt(t)?1:t:1}}function Ae(t){let e;Array.isArray(t.data)?(e=[],_t(e,t.data)):(e={},mt(e,t.data));const n=mt({},t);return n.data=e,n}function ge(t,e){return e.info.z-t.info.z}function me(t){const e={};for(let n=0;n<t.length;n++){const r=t[n].layer||"default";e[r]||(e[r]=[]),e[r].push(t[n])}return e}function ye(t){return{x:0,y:0,width:2*t,height:2*t}}function ve(t){if(!t.cache)return[];for(const e in t.cache){const n=t.cache[e];if(n.geometry)for(let t=0;t<n.geometry.length;t++){const e=n.geometry[t]&&n.geometry[t].geometry;if(e&&e.properties&&e.properties.features){const t=e.properties.features.empty;delete e.properties.features.empty;const n=Object.values(e.properties.features);return void 0!==t&&(e.properties.features.empty=t),n}}}return[]}function xe(t,e,n){for(let r=0;r<t.length;r++){const i=t[r],s=mt({},i),{renderPlugin:o}=i,a=mt({},o);a.sceneConfig&&!Object.keys(a.sceneConfig).length&&delete a.sceneConfig;let l=-1;for(let t=n.length-1;t>=0;t--)if(c()(a,n[t])){l=t;break}l<0&&(l=n.length,n.push(a)),s.renderPlugin=l,e.push(s)}}pe.include({calculateTileMatrix:function(){const t=new Array(3),e=new Array(3),n=new Array(3);return function(i,s,o){const a=this.getTileGLScale(s),l=i,h=this.layer.getTileSize().width,c=r["k"].identity([]);return r["k"].scale(c,c,r["p"].set(t,a,a,this.yt)),r["k"].translate(c,c,r["p"].set(e,l.x,l.y,0)),r["k"].scale(c,c,r["p"].set(n,h/o,-h/o,1)),c}}(),calculateTerrainTileMatrix:function(){const t=new Array(3);return function(e,n,i){const s=r["k"].identity([]),o=i/2;return r["k"].scale(s,s,r["p"].set(t,1/o,-1/o,0)),r["k"].translate(s,s,r["p"].set(t,-o,-o,0)),s}}(),calculateTileTranslationMatrix:function(){const t=new Array(3);return function(e,n){const i=this.getTileGLScale(n),s=e,o=r["k"].identity([]);return r["k"].translate(o,o,r["p"].set(t,s.x*i,s.y*i,0)),o}}()});const be="function"==typeof fetch&&"function"==typeof AbortController,we={jsonp:function(t,e){const n="_maptalks_jsonp_"+At();t.match(/\?/)?t+="&callback="+n:t+="?callback="+n;let r=document.createElement("script");return r.type="text/javascript",r.src=t,window[n]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[n]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,n){if(xt(e)){const t=n;n=e,e=t}(e=e||{}).method&&(e.method=e.method.toUpperCase());const r="POST"===e.method;if(be){const r=new AbortController,i=e;i.signal=r.signal,i.referrerPolicy=i.referrerPolicy||"origin",i.method=i.method||"GET";const s=new Request(t,i);return e.returnJSON&&s.headers.set("Accept","application/json"),fetch(s).then(r=>{const i=this.ie(r,e.returnJSON,e.responseType);i.message?(i.url=t,n(i)):i.then(t=>{"arraybuffer"===e.responseType?n(null,{data:t,cacheControl:r.headers.get("Cache-Control"),expires:r.headers.get("Expires"),contentType:r.headers.get("Content-Type")}):n(null,t)}).catch(e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))})}).catch(e=>{e.code&&e.code===DOMException.ABORT_ERR||(console.error("Fetch error:",t,e),n(e))}),r}{const i=we.re(n);if(i.open(e.method||"GET",t,!0),e){for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);i.withCredentials="include"===e.credentials,e.responseType&&(i.responseType=e.responseType)}return i.send(r?e.body:null),i}},ie:(t,e,n)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===n?t.arrayBuffer():e?t.json():t.text(),se:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e({status:200,statusText:t.statusText,message:"http status 200 returned without content."}):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e({status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}))}},re:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=we.se(e,t),e},getArrayBuffer(t,e,n){if(xt(e)){const t=n;n=e,e=t}return e||(e={}),e.responseType="arraybuffer",we.get(t,e,n)},getJSON:function(t,e,n){if(xt(e)){const t=n;n=e,e=t}const r=function(t,e){const r="string"==typeof e?JSON.parse(e):e||null;n(t,r)};return e&&e.jsonp?we.jsonp(t,r):((e=e||{}).returnJSON=!0,we.get(t,e,r))}},_e=new i["A"](0,0),Me=new i["f"](0,0),Te=[null,0],Se=[];class Ie extends i["H"]{static loadFrom(t,e){return fetch(t,e||{}).then(t=>t.json()).then(t=>Ie.fromJSON(t))}constructor(t,e){super(t,e),this.VERSION=Ie.VERSION;const n=e&&e.style;this.setStyle(n)}setURLModifier(t){this.oe=t;const e=this.getRenderer();return e&&e.updateOptions(),this}getURLModifier(){return this.oe}onAdd(){const t=this.getMap();this.ae();const e=this.getSpatialReference().toJSON().projection,n=t.getSpatialReference().toJSON().projection;if((e&&e.toLowerCase())!==(n&&n.toLowerCase()))throw new Error(`VectorTileLayer's projection(${e}) must be the same with map(${n}).`)}setFeatureState(t,e){if(wt(t.id))throw new Error("missing id in first parameter of setFeatureState.");this.le||(this.le={});const n=t.layer||"0";let r=this.le[n];return this.le[n]||(r=this.le[n]=new Map),r.set(t.id,e),this.he(),this}removeFeatureState(t,e){if(wt(t.id))throw new Error("missing id in first parameter of removeFeatureState.");if(!this.le)return this;const n=t.layer||"0",r=this.le[n];if(!r)return this;if(e){const n=r.get(t.id);if(bt(e))for(const t in e)delete n[t];else delete n[e];r.set(t.id,n)}else r.delete(t.id);return this.he(),this}getFeatureState(t){if(wt(t.id))throw new Error("missing id in first parameter of getFeatureState.");if(!this.le)return null;const e=t.layer||"0";return this.le[e].get(t.id)}he(){const t=this.getRenderer();if(!t)return;const e=t.getFrameTimestamp();this.ue=e}ce(){return this.ue}fe(t){return this.ue&&this.ue!==t}ae(){const t=this.getMap().getProjection(),e="EPSG:4326"===t.code||"EPSG:4490"===t.code,n="EPSG:3857"===t.code;this.options.spatialReference||512===this.getTileSize().width&&(n?this.options.spatialReference="preset-vt-3857":e&&(this.options.spatialReference="preset-vt-4326")),this.options.tileSystem||(this.options.tms?n?this.options.tileSystem=[1,1,-6378137*Math.PI,-6378137*Math.PI]:e&&(this.options.tileSystem=[1,1,-180,-90]):e&&(this.options.tileSystem=[1,-1,-180,90]))}onWorkerReady(){}onConfig(t){const e=this.getRenderer();e&&e.updateOptions(t)}getWorkerOptions(){return{debug:this.options.debug,debugTile:this.options.debugTile,altitudeProperty:this.options.altitudeProperty,tileSize:this.getTileSize().width,style:this.isDefaultRender()?{style:[],featureStyle:[]}:this.q(),features:this.options.debugTileData||this.options.features,schema:this.options.schema,pickingGeometry:this.options.pickingGeometry,projectionCode:this.getSpatialReference().getProjection().code,workerGlyph:this.options.workerGlyph&&!this.getURLModifier(),featureIdProperty:this.options.featureIdProperty}}setStyle(t){if(t&&(yt(t)||t.url)){const e=t,n=e.lastIndexOf("/"),r=n<0?".":e.substring(0,n);return this.ready=!1,we.getJSON(t.url?t.url:t,t.url?t:{},(t,n)=>{if(t)throw this.setStyle([]),t;let i;n.style?(i=n,i.$root||(i.$root=r)):i={$root:r,style:n},this.options.style=e,this.de(i)}),this}return this.options.style=t,this.de(t),this}pe(t,e,n,r){const i=r/this.getTileSize().width;return t.set(n.x+e.x/i,n.y-e.y/i)}queryTilePointTerrain(t,e,n,r,i){const s=this.getRenderer(),o=s&&s.getTerrainHelper();if(!s||!o)return Te[0]=null,Te[1]=0,Te;const a=this.pe(_e,t,n,r);return e&&o.queryTileTerrainByPointAtRes?o.queryTileTerrainByPointAtRes(a,i,e.id,e,Se):(Te[0]=null,Te[1]=0,Te)}queryTerrainTiles(t){const e=this.getRenderer(),n=e&&e.getTerrainHelper();return e&&n?n.getTerrainTiles(t):null}de(t){if(this.me=null,t&&t.$root){let e=t.$root;e&&"/"===e[e.length-1]&&(e=e.substring(0,e.length-1)),this.me=e,this.ye=function(t){return"{$root}"===t?e:null}}this.ready=!0,t=t||[],Array.isArray(t)?t={style:t}:t.renderPlugin&&(t={style:[t]}),t=function(t){if(!t.plugins)return t;const{plugins:e,styles:n}=t;let{style:r,featureStyle:i}=n;r=r||[],i=i||[];const s=new Array(r.length);for(let l=0;l<r.length;l++)s[l]=mt({},r[l]),s[l].renderPlugin=e[r[l].renderPlugin];const o=new Array(i.length);for(let l=0;l<i.length;l++)o[l]=mt({},i[l]),o[l].renderPlugin=e[i[l].renderPlugin];const a={style:s,featureStyle:o};return t.$root&&(a.$root=t.$root),a}(t=JSON.parse(JSON.stringify(t))),this.ge=t.featureStyle||[],this.ve=function(t){if(!t||!Array.isArray(t))return[];const e=[];for(let n=0;n<t.length;n++){const r=t[n].style;if(r&&Array.isArray(r)&&r.length)for(let i=0;i<r.length;i++){const s=mt({},t[n],r[i]);r[i].xe=e.length,delete s.style,e.push(s)}else e.push(mt({},t[n]))}return e}(t.featureStyle),this.be=t.style||[];const e=t.background||{};this.Ae={enable:e.enable||!1,color:Oe(e.color)||[0,0,0,0],opacity:Ee(e.opacity,1),patternFile:e.patternFile,depthRange:e.depthRange},this.validateStyle(),this.ye&&this.we(),this.Dt();const n=this.getRenderer();n&&n.setStyle(),this.fire("setstyle",{style:this.getStyle(),computedStyle:this.getComputedStyle()})}getPolygonOffsetCount(){const t=this.getRenderer();return t?t.getPolygonOffsetCount():0}getPolygonOffset(){return this._e||0}setPolygonOffset(t,e){return this._e=t,this.Se=e,this}getTotalPolygonOffset(){return this.Se}getRenderedFeatures(){const t=this.getRenderer();return t?t.getRenderedFeatures():[]}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t,e){const n=this.getRenderer();return n?(n.outline(t,e),this):this}outlineBatch(t){const e=this.getRenderer();return e?(e.outlineBatch(t),this):this}outlineFeatures(t){const e=this.getRenderer();return e?(e.outlineFeatures(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}highlight(t){this.Me(t);const e=this.getRenderer();return e?(e.highlight(t),this):(this.te||(this.te=[]),this.te.push(t),this)}Me(t){if(Array.isArray(t))for(let e=0;e<t.length;e++)this.Me(t[e]);else{if(t.filter){if(!this.options.features)throw new Error("options.features must be turned on to support filter in highlight");if(!t.name)throw new Error("A name is required for highlight with filter")}if(wt(t.filter)&&wt(t.id))throw new Error("id or filter must be provided for highlight")}}ee(){if(this.te){for(let t=0;t<this.te.length;t++)this.highlight(this.te[t]);delete this.te}}cancelHighlight(t){const e=this.getRenderer();return e?(e.cancelHighlight(t),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}we(){i["I"].convertStylePath(this.be,this.ye),i["I"].convertStylePath(this.ve,this.ye)}updateSceneConfig(t,e){return yt(t)&&(t=this.Pe(t)),this.Te(0,t,e)}updateFeatureSceneConfig(t,e,n){return this.Te(1,t,n,e)}Te(t,e,n,r){const i=this.it(t);if(!i)return this;let s,o=e;if(i[e].renderPlugin.sceneConfig||(i[e].renderPlugin.sceneConfig={}),mt(i[e].renderPlugin.sceneConfig,n),void 0!==r){Pe(this.ge,e,r),o=this.ge[e].style[r].xe;const t=i[o].renderPlugin;t.sceneConfig||(t.sceneConfig={}),s=t.sceneConfig}else ke(i,e),s=i[e].renderPlugin.sceneConfig;if(mt(s,n),Array.isArray(this.options.style)){const t=this.options.style[e].renderPlugin;t.sceneConfig||(t.sceneConfig={}),mt(t.sceneConfig,n)}else{const i=this.it(t,this.options.style);let s;void 0!==r?(Pe(i,e,r),s=i[e].style[r].renderPlugin):(ke(i,e),s=i[e].renderPlugin),s.sceneConfig||(s.sceneConfig={}),mt(s.sceneConfig,n)}const a=this.getRenderer();return a&&a.updateSceneConfig(t,o,n),0===t?this.fire("updatesceneconfig",{index:e,sceneConfig:n}):1===t&&this.fire("updatefeaturesceneconfig",{index:e,styleIdx:r,sceneConfig:n}),this}updateDataConfig(t,e){return yt(t)&&(t=this.Pe(t)),this.ke(0,t,e)}updateFeatureDataConfig(t,e,n){return this.ke(1,t,n,e)}ke(t,e,n,r){const i=this.it(t);if(!i)return this;let s,o=e;void 0!==r?(Pe(this.ge,e,r),o=this.ge[e].style[r].xe,s=i[o].renderPlugin.dataConfig):(ke(i,e),s=i[e].renderPlugin.dataConfig);const a=mt({},s);if(mt(s,n),Array.isArray(this.options.style))mt(this.options.style[e].renderPlugin.dataConfig,n);else{const i=this.it(t,this.options.style);let s;void 0!==r?(Pe(i,e,r),s=i[e].style[r].renderPlugin):(ke(i,e),s=i[e].renderPlugin),s.dataConfig||(s.dataConfig={}),mt(s.dataConfig,n)}const l=this.getRenderer();return l&&l.updateDataConfig(t,o,n,a),0===t?this.fire("updatedataconfig",{index:e,dataConfig:n}):1===t&&this.fire("updatefeaturedataconfig",{index:e,styleIdx:r,dataConfig:n}),this}updateSymbol(t,e){return yt(t)&&(t=this.Pe(t)),this.Oe(0,t,e)}updateFeatureSymbol(t,e,n){return this.Oe(1,t,n,e)}Oe(t,e,n,r){const o=this.it(t);if(!o)return this;let a=e;void 0!==r&&(Pe(this.ge,e,r),a=this.ge[e].style[r].xe);const l=o[a];if(!l)throw new Error("No style defined at "+e);const h=this,c=this.ye;function u(n,o,a){if(!n)return!1;c&&(n=JSON.parse(JSON.stringify(n)),i["I"].parseSymbolPath(n,c));const l=Object.keys(n);let u=!1;for(let t=0;t<l.length;t++){const e=l[t];if(Ce(o[e])||Ce(n[e])){u=!0;break}}for(const t in n)Tt(n,t)&&(!i["I"].isObject(n[t])||Array.isArray(n[t])||Object(s["c"])(n[t])?o[t]=n[t]:(o[t]||(o[t]={}),mt(o[t],n[t])));let f=h.options.style;if(yt(f))return u;Array.isArray(f)||(f=h.it(t,h.options.style));const d=JSON.parse(JSON.stringify(o));return void 0!==r?(Pe(f,e,r),void 0===a?f[e].style[r].symbol=d:f[e].style[r].symbol[a]=d):(ke(f,e),void 0===a?f[e].symbol=d:f[e].symbol[a]=d),u}const f=this.getRenderer();if(!f)return u(),this.Dt(),this;let d=!1;const p=l.symbol;if(Array.isArray(n))for(let i=0;i<n.length;i++){const t=u(n[i],p[i],i);t&&(d=t)}else u(n,p);return this.Dt(),d?f.setStyle():(d=f.updateSymbol(t,a,n),d&&f.setStyle()),0===t?this.fire("updatesymbol",{index:e,symbol:n}):1===t&&this.fire("updatefeaturesymbol",{index:e,featureStyleIndex:r,symbol:n}),this}it(t,e){return e?0===t?e.style:e.featureStyle:0===t?this.be:this.ve}isDefaultRender(){return!!this.Ie&&this.options.defaultRendering}validateStyle(){this.Ie=!1;let t=this.be;this.options.style||(this.Ie=!0,t=this.be=[]),Array.isArray(t)||(t=this.be=[t]);for(let e=0;e<t.length;e++){let n=t[e].filter;if(n&&n.value&&(n=n.value),n||console.warn(`render plugin at ${e} doesn't define filter, its filter will be set to 'default' by default.`),void 0!==n&&"default"!==n&&!0!==n&&!Array.isArray(n)&&void 0===n.condition)throw new Error(`Invalid filter at ${e} : ${JSON.stringify(n)}`)}}getStyle(){return this.options.style?JSON.parse(JSON.stringify(this.options.style)):null}Pe(t){const e=this.be;if(!e)return-1;for(let n=0;n<e.length;n++)if(e[n].name===t)return n;throw new Error("No style defined with name: "+t)}getGroundConfig(){this.Fe||(this.Fe={enable:!0,renderPlugin:{type:"fill",sceneConfig:{}},symbol:{polygonFill:[0,0,0,0],polygonOpacity:1}});const t=this.q().background||{};return this.Fe.enable=t.enable,this.Fe.symbol.polygonFill=t.color,this.Fe.symbol.polygonOpacity=t.opacity,this.Fe.symbol.polygonPatternFile=t.patternFile,this.Fe.renderPlugin.sceneConfig.depthRange=t.depthRange,this.Fe}getComputedStyle(){return JSON.parse(JSON.stringify(this.q()))}q(){return{background:this.Ae,style:this.be||[],featureStyle:this.ve||[]}}identify(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const s=n.coordToContainerPoint(new i["f"](t));return this.identifyAtPoint(s,e)}identifyAtPoint(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const i=n.getDevicePixelRatio(),s=r.pick(t.x*i,t.y*i,e);return this.options.features&&"id"!==this.options.features?this.Ce(s):s}Ce(t){if(!this.getRenderer())return t;const e=this._getTileConfig(),n=this.getSpatialReference();for(let r=0;r<t.length;r++){let i=t[r];if(!i||!i.data)continue;const{tile:s}=i.data,{x:o,y:a,z:l,extent:h}=s,c=n.getResolution(l),u=e.getTilePointNW(o,a,c),f=i.data.feature&&i.data.feature.geometry;if(f){i.data=mt({},i.data),i.data.feature=mt({},i.data.feature);const t=i.data.feature.type;i.data.feature.type="Feature",i.data.feature.geometry=this.Ee(t,f,u,h,c)}}return t}Ee(t,e,n,r,i){let s,a;if(1===t)e.length<=1?(s="Point",a=this.De(e,n,r,i)[0]||[]):(s="MultiPoint",a=this.De(e,n,r,i));else if(2===t)e.length<=1?(s="LineString",a=this.De(e,n,r,i)[0]||[]):(s="MultiLineString",a=this.De(e,n,r,i));else if(3===t){let t;a=[];let l=0;for(let s=0;s<e.length;s++)o["i"].calculateSignedArea(e[s])>0&&(l++,t&&t.length&&a.push(t),t=[]),t.push(this.De(e[s],n,r,i));t.length&&a.push(t),l<=1?(s="Polygon",a=a[0]):s="MultiPolygon"}return{type:s,coordinates:a}}De(t,e,n,r){const i=n/this.getTileSize().width,s=this.getMap(),o=[];for(let a=0;a<t.length;a++)Array.isArray(t[a])?o.push(this.De(t[a],e,n,r)):(_e.x=e.x+t[a].x/i,_e.y=e.y-t[a].y/i,s.pointAtResToCoord(_e,r,Me),o.push(Me.toArray()));return o}getDataSchema(t){return this.Ne||(this.Ne={}),wt(t)||this.Ne[t]||(this.Ne[t]={}),wt(t)?this.Ne:this.Ne[t]}onRemove(){super.onRemove()}static fromJSON(t){return t&&"VectorTileLayer"===t.type?new Ie(t.id,t.options):null}Dt(){}static registerPlugin(t){Ie.plugins||(Ie.plugins={}),Ie.plugins[t.type]=t}static getPlugins(){return Ie.plugins||{}}static compressStyleJSON(t){return Array.isArray(t)&&t.length?function(t){Array.isArray(t)&&(t={style:t,featureStyle:[]});const e=[],n=[],r=[];xe(t.style,e,r),xe(t.featureStyle,n,r);const i={plugins:r,styles:{style:e,featureStyle:n}};return t.$root&&(i.$root=t.$root),i}(t):t}}function Ce(t){return!(!t||!t.properties)}function Oe(t){return t?(Array.isArray(t)||(t=l()(t).unitArray()),3===t.length&&t.push(1),t):null}function Ee(t,e){return null==t?e:t}function Pe(t,e,n){if(!t[e]||!t[e].style||!t[e].style[n])throw new Error(`No plugin defined at feature style of ${e} - ${n}`)}function ke(t,e){if(!t[e])throw new Error("No plugin defined at style of "+e)}Ie.prototype._getTileZoom=function(t){return t=Math.floor(t),i["H"].prototype._getTileZoom.call(this,t)},Ie.registerJSONType("VectorTileLayer"),Ie.mergeOptions({renderer:"gl",altitudeProperty:"altitude",forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,tileSize:512,features:!1,schema:!1,cascadeTiles:!0,collision:!0,collisionBuffserSize:0,picking:!0,pickingPoint:!0,pickingGeometry:!1,glyphSdfLimitPerFrame:15,tileLimitPerFrame:1,loadingLimitOnInteracting:5,loadingLimit:0,antialias:!1,iconErrorUrl:null,collisionFrameLimit:1.5,defaultRendering:!0,textGamma:1,maxIconSize:254,workarounds:{"win-intel-gpu-crash":!1},pyramidMode:1,styleScale:1,enableAltitude:!0,fadeAnimation:!1,debugTileData:!1,fetchOptions:null,awareOfTerrain:!0,altitudeQueryTimeLimitPerFrame:3,workerGlyph:!0,featureIdProperty:null,currentTilesFirst:!1}),Ie.registerRenderer("gl",pe),Ie.registerRenderer("canvas",null);const Re={projection:"EPSG:4326",fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const t=[];for(let e=0;e<22;e++)t[e]=45/(128*Math.pow(2,e));return t}()};i["G"].registerPreset("preset-vt-4326",Re),i["G"].registerPreset("preset-4326-512",Re);class Ne extends Ie{getTileUrl(t,e,n){const r=this.getMap().getResolution(n);return super.getTileUrl(t,e,function(t){return 19-Math.log(t/De)/Math.LN2}(r))}static fromJSON(t){return t&&"MapboxVectorTileLayer"===t.type?new Ne(t.id,t.options):null}}Ne.registerJSONType("MapboxVectorTileLayer");const De=12756274*Math.PI/(256*Math.pow(2,20));class Fe extends Ie{constructor(t,e={}){e.spatialReference=null,super(t,e),this.setData(e.data)}onAdd(){this.ae()}ae(){const t=this.getMap(),e=t.getMaxNativeZoom(),n=t.getProjection(),r="EPSG:4326"===n.code||"EPSG:4490"===n.code;var i;r&&(this.options.tileSystem=[1,-1,-180,90]),this.options.spatialReference=r?function(t,e){return{projection:e,fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){const e=[];for(let n=0;n<=t+1;n++)e[n]=90/(128*Math.pow(2,n));return e}()}}(e,n.code):(i=e,{projection:"EPSG:3857",resolutions:function(){const t=[],e=6378137*Math.PI;for(let n=0;n<=i+1;n++)t[n]=e/(256*Math.pow(2,n));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}})}getWorkerOptions(){const t=super.getWorkerOptions();let e=this.options.data;return yt(e)||e&&e.url?(e.url&&(e=JSON.parse(JSON.stringify(e))),e=ze(e,this.getURLModifier())):e=this.features,t.data=e,t.tileBuffer=this.options.tileBuffer,t.extent=this.options.extent,t.hasAltitude=this.options.enableAltitude,t.simplifyTolerance=this.options.simplifyTolerance,t.projection=this.getSpatialReference().getProjection().code,t.generateOMBB=this.options.generateOMBB,t.convertFn=this.options.convertFn?this.options.convertFn+"":null,t}setData(t){return this.options.data=t,t&&(yt(t)||t.url)?(!!this.getRenderer()&&this.Le(),this):(this.Re(t),this.Le(),this)}Re(t){return this.options.convertFn&&(t=new Function("data",this.options.convertFn+"\nreturn convert(data)")(t)),this.features=t,this.He(),this}Le(){const t=this.getRenderer();if(t){const e=t.getWorkerConnection();if(e){let n=this.options.data;yt(n)||n&&n.url?(n.url&&(n=JSON.parse(JSON.stringify(n))),n=ze(n,this.getURLModifier())):n=this.features,e.setData(n,(e,n)=>{t.clear(),this.onWorkerReady(null,n),t.setToRedraw(),setTimeout(()=>{t.setToRedraw()},500)})}}}getExtent(){return this.ze}onWorkerReady(t,e){t?this.fire("dataerror",{error:t}):(e&&(e.extent&&this.Ve(e.extent),e.idMap&&(this.Ue=e.idMap)),this.fire("dataload",{extent:e&&e.extent}))}Ve(t){this.ze=new i["k"](...t)}je(t,e){yt(t)?we.getJSON(t,e):we.getJSON(t.url,t,e)}getData(){return this.features||null}getTileUrl(t,e,n){return this.getId()+","+t+","+e+","+n}getFeature(t){return this.Ue[t]}static fromJSON(t){return t&&"GeoJSONVectorTileLayer"===t.type?new Fe(t.id,t.options):null}He(){if(!this.features)return;if(this.features=JSON.parse(JSON.stringify(this.features)),!this.features)return;let t=0;this.Ue={};const e=this.options.featureIdProperty,n=this.features;Array.isArray(n)?n.forEach(n=>{if(n){if(vt(n.id)||(n.id=t++),e){let t=e;bt(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this.Ue[n.id]=n}}):n.features&&n.features.forEach(n=>{if(n){if(vt(n.id)||(n.id=t++),e){let t=e;bt(e)&&(t=e[n.layer||"0"]),n.id=n.properties[t]}this.Ue[n.id]=n}})}}function Le(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}function ze(t,e){return t.url?t.url=e?e(t.url):Le(t.url):t=e?e(t):Le(t),t}Fe.registerJSONType("GeoJSONVectorTileLayer"),Fe.mergeOptions({features:"id",tileBuffer:64,extent:8192,pyramidMode:1,simplifyTolerance:3,tileStackDepth:0,generateOMBB:!0});const Be=new i["F"](1,1);class He extends i["y"]{static registerPainter(t,e){He.painters||(He.painters={}),He.painters[t]=e}static get3DPainterClass(t){return He.painters[t]}setURLModifier(t){return this.oe=t,this}getURLModifier(){return this.oe}getEvents(){let t;return t=super.getEvents?super.getEvents():{},t.spatialreferencechange=this.Be,t}onConfig(t){if(super.onConfig(t),void 0!==t.enableBloom){const e=this.getRenderer();e&&e.updateBloom(t.enableBloom)}}updateSymbol(t,e){if(!this.options.style)throw new Error("can't call update symbol when style is not set");const n=Array.isArray(this.options.style)?this.options.style:this.options.style.style;if(!n[t])throw new Error("invalid style at "+t);return mt(n[t].symbol,e),this.setStyle(this.options.style),this}getPolygonOffsetCount(){return this.isEmpty()||this.options.altitude?0:1}getPolygonOffset(){return this.options.altitude?0:this._e||0}setPolygonOffset(t,e){return this._e=t,this.Se=e,this}getTotalPolygonOffset(){return this.Se}identify(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const s=n.coordToContainerPoint(new i["f"](t));return this.identifyAtPoint(s,e)}identifyAtPoint(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const i=this.getMap().getDevicePixelRatio();return r.pick(t.x*i,t.y*i,e)}getComputedStyle(){return{style:this.getStyle()||[]}}outlineAll(){const t=this.getRenderer();return t?(t.outlineAll(),this):this}outline(t){if(!Array.isArray(t)||!t.length)return this;const e=this.getRenderer();return e?(e.outline(t),this):this}cancelOutline(){const t=this.getRenderer();return t?(t.cancelOutline(),this):this}toJSON(){const t={type:this.getJSONType(),id:this.getId(),options:this.config(),geometries:[]},e=this.getGeometries();for(let n=0,r=e.length;n<r;n++){const r=e[n].toJSON();t.geometries.push(r)}return t}getTileSize(){return Be}Be(){const t=this.getRenderer();t&&t.Be()}}He.mergeOptions({picking:!0,pickingPoint:!0,renderer:"gl",collision:!1,collisionBufferSize:0,textGamma:1,geometryEvents:!0,styleScale:1,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,meshRenderOrder:0,enableBloom:!1,enableAltitude:!0,workarounds:{"win-intel-gpu-crash":!0}});const Ue={markerFile:{type:"identity",default:null,property:"_symbol_markerFile"},markerWidth:{type:"identity",default:null,property:"_symbol_markerWidth"},markerHeight:{type:"identity",default:null,property:"_symbol_markerHeight"},markerPathWidth:{type:"identity",default:20,property:"_symbol_markerPathWidth"},markerPathHeight:{type:"identity",default:20,property:"_symbol_markerPathHeight"},markerDx:{type:"identity",default:null,property:"_symbol_markerDx"},markerDy:{type:"identity",default:null,property:"_symbol_markerDy"},markerType:{type:"identity",default:null,property:"_symbol_markerType"},markerPath:{type:"identity",default:null,property:"_symbol_markerPath"},markerFill:{type:"identity",default:null,property:"_symbol_markerFill"},markerFillPatternFile:{type:"identity",default:null,property:"_symbol_markerFillPatternFile"},markerFillOpacity:{type:"identity",default:null,property:"_symbol_markerFillOpacity"},markerLineColor:{type:"identity",default:null,property:"_symbol_markerLineColor"},markerLineWidth:{type:"identity",default:null,property:"_symbol_markerLineWidth"},markerLineOpacity:{type:"identity",default:null,property:"_symbol_markerLineOpacity"},markerLineDasharray:{type:"identity",default:null,property:"_symbol_markerLineDasharray"},markerLinePatternFile:{type:"identity",default:null,property:"_symbol_markerLinePatternFile"},markerVerticalAlignment:{type:"identity",default:"top",property:"_symbol_markerVerticalAlignment"},markerHorizontalAlignment:{type:"identity",default:"middle",property:"_symbol_markerHorizontalAlignment"},markerOpacity:{type:"identity",default:1,property:"_symbol_markerOpacity"},markerPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_markerPitchAlignment"},markerRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_markerRotationAlignment"},markerRotation:{type:"identity",default:0,property:"_symbol_markerRotation"},markerAllowOverlap:{type:"identity",default:0,property:"_symbol_markerAllowOverlap"},markerIgnorePlacement:{type:"identity",default:0,property:"_symbol_markerIgnorePlacement"},markerTextFit:{type:"identity",default:null,property:"_symbol_markerTextFit"},markerSpacing:{type:"identity",default:250,property:"_symbol_markerSpacing"},markerTextFitPadding:{type:"identity",default:null,property:"_symbol_markerTextFitPadding"},markerPlacement:{type:"identity",default:"point",property:"_symbol_markerPlacement"}},je={textName:{type:"identity",default:null,property:"_symbol_textName"},textFaceName:{type:"identity",default:null,property:"_symbol_textFaceName"},textWeight:{type:"identity",default:null,property:"_symbol_textWeight"},textStyle:{type:"identity",default:null,property:"_symbol_textStyle"},textWrapWidth:{type:"identity",default:null,property:"_symbol_textWrapWidth"},textHorizontalAlignment:{type:"identity",default:null,property:"_symbol_textHorizontalAlignment"},textVerticalAlignment:{type:"identity",default:null,property:"_symbol_textVerticalAlignment"},textFill:{type:"identity",default:null,property:"_symbol_textFill"},textSize:{type:"identity",default:null,property:"_symbol_textSize"},textHaloRadius:{type:"identity",default:null,property:"_symbol_textHaloRadius"},textHaloFill:{type:"identity",default:null,property:"_symbol_textHaloFill"},textHaloOpacity:{type:"identity",default:1,property:"_symbol_textHaloOpacity"},textDx:{type:"identity",default:0,property:"_symbol_textDx"},textDy:{type:"identity",default:0,property:"_symbol_textDy"},textOpacity:{type:"identity",default:1,property:"_symbol_textOpacity"},textPitchAlignment:{type:"identity",default:"viewport",property:"_symbol_textPitchAlignment"},textRotationAlignment:{type:"identity",default:"viewport",property:"_symbol_textRotationAlignment"},textRotation:{type:"identity",default:0,property:"_symbol_textRotation"},textAllowOverlap:{type:"identity",default:0,property:"_symbol_textAllowOverlap"},textIgnorePlacement:{type:"identity",default:0,property:"_symbol_textIgnorePlacement"},textSpacing:{type:"identity",default:250,property:"_symbol_textSpacing"},textPlacement:{type:"identity",default:"point",property:"_symbol_textPlacement"}},Ve={lineWidth:{type:"identity",default:2,property:"_symbol_lineWidth"},lineStrokeWidth:{type:"identity",default:0,property:"_symbol_lineStrokeWidth"},lineColor:{type:"identity",default:[1,1,1,1],property:"_symbol_lineColor"},lineStrokeColor:{type:"identity",default:[0,0,0,0],property:"_symbol_lineStrokeColor"},lineDx:{type:"identity",default:0,property:"_symbol_lineDx"},lineDy:{type:"identity",default:0,property:"_symbol_lineDy"},linePatternFile:{type:"identity",default:null,property:"_symbol_linePatternFile"},linePatternAnimSpeed:{type:"identity",default:0,property:"_symbol_linePatternAnimSpeed"},linePatternGap:{type:"identity",default:0,property:"_symbol_linePatternGap"},lineOpacity:{type:"identity",default:1,property:"_symbol_lineOpacity"},lineJoin:{type:"identity",default:null,property:"_symbol_lineJoin"},lineCap:{type:"identity",default:null,property:"_symbol_lineCap"},lineDasharray:{type:"identity",default:null,property:"_symbol_lineDasharray"},lineDashColor:{type:"identity",default:null,property:"_symbol_lineDashColor"}},Ge=new i["A"](0,0),qe="_vector3dlayer_id",We="_line_gradient_property".trim();function Xe(t,e,n){const r="__fea_idx".trim(),s=t.getMap(),a=s.getGLRes();let l=t.getCoordinates();const h=[],c=[];let u=1;if(t instanceof i["u"]||t instanceof i["w"]){t instanceof i["u"]&&(l=[l]);for(let t=0;t<l.length;t++)s.coordToPointAtRes(l[t],a,Ge),h.push([Ge.x,Ge.y,l[t].z||0]),c.push([l[t].x,l[t].y])}else if(t instanceof i["s"]||t instanceof i["v"]){u=2,t instanceof i["s"]&&(l=[l]);for(let t=0;t<l.length;t++){h[t]=[],c[t]=[];for(let e=0;e<l[t].length;e++)s.coordToPointAtRes(l[t][e],a,Ge),h[t].push([Ge.x,Ge.y,l[t][e].z||0]),c[t].push([l[t][e].x,l[t][e].y])}}else if(t instanceof i["C"]||t instanceof i["x"]){u=3,t instanceof i["d"]||t instanceof i["D"]||t instanceof i["i"]||t instanceof i["E"]?l=[[t.getShell()]]:t instanceof i["C"]&&(l=[l]);let e=0;for(let t=0;t<l.length;t++){let n=!1;for(let r=0;r<l[t].length;r++){if(h[e]=[],c[e]=[],n)for(let n=l[t][r].length-1;n>=0;n--)s.coordToPointAtRes(l[t][r][n],a,Ge),h[e].push([Ge.x,Ge.y,l[t][r][n].z||0]),c[e].push([l[t][r][n].x,l[t][r][n].y]);else for(let n=0;n<l[t][r].length;n++)s.coordToPointAtRes(l[t][r][n],a,Ge),h[e].push([Ge.x,Ge.y,l[t][r][n].z||0]),c[e].push([l[t][r][n].x,l[t][r][n].y]);0===r&&(n=o["i"].calculateSignedArea(h[e])<0,n&&(h[e]=h[e].reverse(),c[e]=c[e].reverse())),e++}}}const f=t.getProperties()?Object.assign({},t.getProperties()):{},d=t._getInternalSymbol()||function(t){return t instanceof i["u"]||t instanceof i["w"]?{markerType:"ellipse",markerWidth:8,markerHeight:0,markerFill:"#000"}:t instanceof i["s"]||t instanceof i["v"]?{lineColor:"#000",lineWidth:1}:t instanceof i["C"]||t instanceof i["x"]?{polygonFill:"#fff",lineColor:"#000",lineWidth:1}:void 0}(t),p=n?Array.isArray(n)?n[0].id:n.id:e.id++;if(Array.isArray(d)&&d.length){const i=[],s=d.length;for(let o=0;o<s;o++){const a=o===s-1?f:mt({},f),l=Qe(d[o],a);for(const t in d[o])Tt(d[o],t)&&(a[("_symbol_"+t).trim()]=d[o][t]);l&&(d[o].lineGradientProperty=l);const A=n&&n[o]?n[o][r]:e.pickingId++,g={type:u,id:p,properties:a,visible:t.isVisible(),geometry:h,coordinates:c,extent:1/0};g[r]=A,i.push(g)}return i}if(d){const t=Qe(d,f);for(const e in d)Tt(d,e)&&(f[("_symbol_"+e).trim()]=d[e]);t&&(d.lineGradientProperty=t)}const A=n?n.id:e.pickingId++,g={type:u,id:p,properties:f,visible:t.isVisible(),geometry:h,coordinates:c,extent:1/0};return g[r]=A,g}function Qe(t,e){const n=t.lineGradientProperty;return n&&(e[We]=e[n],e.mapbox_clip_start=0,e.mapbox_clip_end=1,delete e[n]),n}let Ye=1;const Ze="_symbol_".trim(),Ke="__fea_idx".trim();let Je=new Float32Array(1);const $e=[];class tn extends i["P"].CanvasRenderer{constructor(...t){super(...t),this.features={},this.Ge={},this.L=0,this.We={},this.Xe={},this.Ye={},this.$e={},this.qe={},this.Je=!0,this.Ze={id:0,pickingId:0},this.Ke={}}setURLModifier(t){this.oe=t}getURLModifier(){return this.oe}hasNoAARendering(){return!0}needToRedraw(){const t=super.needToRedraw();return t||this.painter&&this.painter.needToRedraw()||this.Qe&&this.Qe.needToRedraw()||this.tn&&this.tn.needToRedraw()}getAnalysisMeshes(){return this.painter&&this.painter.getAnalysisMeshes()||$e}getRayCastData(){return null}draw(t,e){this.pt=t;const n=this.layer;this.prepareCanvas(),this.yt=this.gt(this.getMap().getGLRes()),this.vt=e||{};const r=this.vt.renderMode,i=this.en();if(this.xt(i,r),this.Je)this.buildMesh(),this.nn(),this.in(),this.Ke={},this.rn=!1,this.Je=!1,this.sn=!1;else if(this.rn){const t=this.atlas,e=this.an,n=this.ln;delete this.atlas,delete this.an,delete this.ln,this.buildMesh(t),this.nn(e),this.in(n),this.rn=!1,this.sn=!1}else if(this.sn){const t=this.ln;delete this.ln,this.in(t),this.sn=!1}if(!this.meshes&&!this.hn&&!this.un)return void this.completeRender();this.cn&&(this.dn(),this.cn=!1),this.pn();const s=!r||"default"===r;let o=0;0===this.layer.options.meshRenderOrder&&this.mn(i,o,r);let a=0;if(this.un&&(s||this.tn.supportRenderMode(r))){this.tn.startFrame(i),this.tn.addMesh(this.un,null,{bloom:this.vt.bloom}),this.tn.prepareRender(i);const t=i.polygonOffsetIndex||0;o=this.meshes&&this.meshes.length?o-1:o,i.polygonOffsetIndex=(i.polygonOffsetIndex||0)+o,a=this.tn.render(i).drawCount,i.polygonOffsetIndex=t}if(1===this.layer.options.meshRenderOrder&&this.mn(i,a?o-1:o,r),this.hn&&(s||this.Qe.supportRenderMode(r))){const e=!this.vt.timestamp||this.vt.isFinalRender,r=!this.yn||this.yn!==t;n.options.collision&&r&&n.clearCollisionIndex();const s=this.layer.options.sceneConfig;this.Qe.sceneConfig.collision=!s||!!wt(s.collision)||s.collision,this.Qe.startFrame(i),this.Qe.addMesh(this.hn,null,{bloom:this.vt.bloom}),this.Qe.prepareRender(i),n.options.collision&&r&&(this.Qe.updateCollision(i),e&&(this.yn=t)),this.Qe.render(i)}(s||e&&e.isFinalRender)&&(this.completeRender(),this.layer.fire("canvasisdirty"))}xt(t,e){const n=!e||"default"===e;this.painter&&(n||this.painter.supportRenderMode(e))&&this.painter.startFrame(t)}mn(t,e,n){const r=!n||"default"===n;return this.painter&&this.meshes&&(r||this.painter.supportRenderMode(n))?(this.painter.addMesh(this.meshes,null,{bloom:t&&t.bloom}),this.painter.prepareRender(t),t.polygonOffsetIndex=(t.polygonOffsetIndex||0)+e,this.painter.render(t)):{redraw:!1,drawCount:0}}supportRenderMode(){return!0}isForeground(){return!0}en(){const t={regl:this.regl,layer:this.layer,symbol:this.gn,gl:this.gl,sceneConfig:this.layer.options.sceneConfig,pluginIndex:0,cameraPosition:this.getMap().cameraPosition,timestamp:this.getFrameTimestamp()};return this.vt&&mt(t,this.vt),t}drawOnInteracting(t,e,n){this.draw(e,n)}getFrameTimestamp(){return this.pt}vn(t,e){(t=t||e)===e&&(e=null);const n=[],r=[0,0,0,0];this.layer._sortGeometries();const i=this.layer.getGeometries();for(let s=0;s<i.length;s++){const o=i[s][qe];if(!this.features[o])continue;const a=this.features[o];if(Array.isArray(a))for(let i=0;i<a.length;i++){const s=a[i],o=s[Ke];(!t||t[o]||e&&(!e||e[o]))&&(s.visible||(this.cn=!0),this.xn(s.geometry,r,s.coordinates),n.push(s))}else{a.visible||(this.cn=!0);const i=a[Ke];if(t&&!t[i]&&(!e||e&&!e[i]))continue;this.xn(a.geometry,r,a.coordinates),n.push(a)}}if(n.length||(this.meshes&&this.painter&&(this.painter.deleteMesh(this.meshes),delete this.meshes),this.hn&&(this.Qe.deleteMesh(this.hn),delete this.hn),this.un&&(this.tn.deleteMesh(this.un),delete this.un)),r[3]&&(r[0]/=r[3],r[1]/=r[3]),isNaN(r[0])||isNaN(r[1]))throw new Error("invalid geometry coordinates for "+this.layer.getJSONType());return{features:n,center:r}}buildMesh(){}createVectorPacks(t,e,n,r,i,s){return t&&r&&r.length?new e(r,n,{zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.requestor,atlas:i,center:s,positionType:Float32Array}).load():Promise.resolve(null)}createMesh(t,e,n,r,i,s){return this.createVectorPacks(t,e,n,r,i,s).then(o=>this.bn(o,t,e,n,r,i,s))}bn(t,e,n,i,s,o,a){if(!t)return null;const l=e.createGeometries([t.data],Bt(s,null,0,i,this.layer));for(let r=0;r<l.length;r++)l[r]&&this.An(l[r].geometry);const h=r["k"].identity([]);r["k"].translate(h,h,r["p"].set([],a[0],a[1],0)),r["k"].scale(h,h,r["p"].set([],1,1,this.yt));const c=e.createMeshes(l,h,{tilePoint:[a[0],a[1]]});for(let r=0;r<c.length;r++){const t=c[r];t.properties.level=0,t.properties.tileTransform=h;const e=t.defines;e.ENABLE_TILE_STENCIL=1,t.setDefines(e),t.properties.meshKey=this.layer.getId()}return{meshes:c,atlas:{iconAtlas:t.data.iconAtlas}}}xn(t,e,n){for(let r=0;r<t.length;r++)if(Array.isArray(t[r][0]))for(let i=0;i<t[r].length;i++)if(Array.isArray(t[r][i][0]))for(let s=0;s<t[r][i].length;s++)isNaN(+t[r][i][s][0])||isNaN(+t[r][i][s][1])||this.wn(e,t[r][i][s][0],t[r][i][s][1],t[r][i][s][2],1,n[r][i][s]);else isNaN(+t[r][i][0])||isNaN(+t[r][i][1])||this.wn(e,t[r][i][0],t[r][i][1],t[r][i][2],1,n[r][i]);else isNaN(+t[r][0])||isNaN(+t[r][1])||this.wn(e,t[r][0],t[r][1],t[r][2],1,n[r])}wn(t,e,n,r,i,s){let o=!1;(s[0]>180||s[0]<-180)&&(o=!0,console.warn(`Layer(${this.layer.getId()}) has invalid longitude value: ${s[0]}`)),(s[1]>90||s[1]<-90)&&(o=!0,console.warn(`Layer(${this.layer.getId()}) has invalid latitude value: ${s[1]}`)),o||(t[0]+=e,t[1]+=n,t[2]+=r||0,t[3]+=i)}An(t){const e=this.getMap(),n=t.properties;Object.defineProperty(n,"tileResolution",{enumerable:!0,get:function(){return e.getGLRes()}}),n.tileRatio=1,n.z=1,n.tileExtent=1,n.elements=t.elements,n.aPickingId=t.data.aPickingId}_n(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&nn(this.gl)}prepareRequestors(){if(this.h)return;const t=this.layer;this.h=new o["g"]({iconErrorUrl:t.options.iconErrorUrl,urlModifier:e=>{const n=t.getURLModifier();return n&&n(e)||e}});const e=!this._n("win-intel-gpu-crash");this.u=new o["e"](e=>{t.getMap().getRenderer().callInNextFrame(e)},t.options.glyphSdfLimitPerFrame,e),this.requestor=this.Sn.bind(this),this.Mn=this.Pn.bind(this)}Sn(t,e,n){const r=[];this.h.getIcons(t,(t,e)=>{if(t)throw t;e.buffers&&r.push(...e.buffers),n(null,{icons:e.icons},r)})}Pn(t,e,n){this.u.getGlyphs(e,(e,r)=>{if(e)throw e;const i=r.buffers||[];this.h.getIcons(t,(t,e)=>{if(t)throw t;e.buffers&&e.buffers.length&&i.push(...e.buffers),n(null,{icons:e.icons,glyphs:r.glyphs},i)})})}nn(t){const e=Object.keys(this.Ye),n=Object.keys(this.$e);if(!e.length&&!n.length)return void(this.hn&&(this.Qe.deleteMesh(this.hn),delete this.hn));const{features:i,center:s}=this.vn(this.Ye,this.$e),o=[],a=[];for(let r=0;r<i.length;r++){const t=i[r][Ke];this.Ye[t]&&o.push(i[r]),this.$e[t]&&a.push(i[r])}if(!o.length&&!a.length)return void(this.hn&&(this.Qe.deleteMesh(this.hn),delete this.hn));const l=this.cn;this.Tn=s;const h=this.kn(o,a,t,s);this.an={};const c=[],u=[];this.On=!0,Promise.all(h).then(t=>{if(this.hn&&(this.Qe.deleteMesh(this.hn),delete this.hn),!t||!t.length)return void this.setToRedraw();const e=this.Qe.createGeometries(t.map(t=>(t&&t.data&&(t.data.isIdUnique=!0),t&&t.data)),this.We);for(let r=0;r<e.length;r++)this.An(e[r].geometry,t[r]&&t[r].data);const n=t[0]&&t[0].data.iconAtlas,i=t[0]&&t[0].data.glyphAtlas||t[1]&&t[1].data.glyphAtlas;n&&(this.an.iconAtlas=n),i&&(this.an.glyphAtlas=i);const o=r["k"].identity([]);r["k"].translate(o,o,r["p"].set(u,s[0],s[1],0)),r["k"].scale(o,o,r["p"].set(c,1,1,this.yt));const a=this.Qe.createMeshes(e,o);for(let r=0;r<a.length;r++)a[r].geometry.properties.originElements=a[r].geometry.properties.elements.slice(),a[r].properties.level=0,a[r].material.set("flipY",1),a[r].properties.meshKey=Ye++;this.hn=a,l&&(this.cn=!0),this.On=!1,this.setToRedraw(),this.layer.fire("buildmarkermesh")})}dn(){if(this.hn&&(this.In(this.hn[0],this.Ye),this.In(this.hn[1],this.$e),this.hn[0]&&this.Qe.prepareCollideIndex(this.hn[0].geometry),this.hn[1]&&this.Qe.prepareCollideIndex(this.hn[1].geometry)),this.un)for(let t=0;t<this.un.length;t++)this.In(this.un[t],this.qe);if(this.meshes)for(let t=0;t<this.meshes.length;t++)this.In(this.meshes[t],this.We)}In(t,e){if(!t)return;const{aPickingId:n,originElements:r}=t.geometry.properties,i=[];for(let o=0;o<r.length;o++){const t=n[r[o]];e[t]&&e[t].feature.visible&&i.push(r[o])}const s=t.geometry.properties.elements=new r.constructor(i);t.geometry.setElements(s)}kn(t,e,n,r){const i={zoom:this.getMap().getZoom(),EXTENT:1/0,requestor:this.Mn,atlas:n,center:r,positionType:Float32Array,defaultAltitude:0,forceAltitudeAttribute:!0,markerWidthType:Uint16Array,markerHeightType:Uint16Array},s=mt({},i);return i.allowEmptyPack=1,o["j"].splitPointSymbol(this.Fn).map((n,r)=>new o["j"](0===r?t:e,n,0===r?i:s).load())}updateMesh(){}Cn(t){const e=t._getInternalSymbol(),n={zoom:this.getMap().getZoom(),isVector3D:!0},r=this.En(t);if(!this.hn)return!1;let i=this.features[r];Array.isArray(i)||(i=[i]);const a=[],l=[],h=[],c=this.getMap().getZoom();let u,f;u=Array.isArray(e)?e.map(t=>t?Object(s["d"])(t,()=>(a[0]=c,a)):t):Object(s["d"])(e,()=>(a[0]=c,a)),f=Array.isArray(e)?e.map(t=>t?o["r"].genFnTypes(t):t):o["r"].genFnTypes(e);for(let s=0;s<i.length;s++){if(!i[s])continue;const t=Array.isArray(e)?e[s]:e,r=Array.isArray(u)?u[s]:u,a=Array.isArray(f)?f[s]:f,l=new o["o"](i,t,r,a,n).getIconAndGlyph();if(!this.an||!o["j"].isAtlasLoaded(l,this.an))return this.Dn(),this.setToRedraw(),!1}for(let s=0;s<i.length;s++){const t=i[s][Ke];this.Ye[t]&&l.push(i[s]),this.$e[t]&&h.push(i[s])}const d=i[0].id,p=this.kn(l,h,this.an,this.Tn),A=this.hn;return Promise.all(p).then(t=>{for(let e=0;e<t.length;e++){if(!t[e])continue;t[e].data&&(t[e].data.isIdUnique=!0);const n=A[e],r=n.geometry.properties.aFeaIds.indexOf(d);if(r<0)continue;const i=t[e].data.featureIds.length,s=t[e].data.dynamicAttributes;for(const o in t[e].data.data){if("aPickingId"===o)continue;if(s[o])continue;const a=t[e].data.data[o];a&&n.geometry.updateSubData(o,a,r*a.length/i)}}this.setToRedraw()}),!0}Nn(t){return this.Ln(t,this.un,this.ln,this.Rn,this.tn,o["h"],Ve,this.Hn)}Ln(t,e,n,r,i,s,a,l){if(!e)return!1;if(!n)return this.Dn(),this.setToRedraw(),!1;const h=t._getInternalSymbol(),c={zoom:this.getMap().getZoom()},u=t[qe];let f=this.features[u];Array.isArray(f)||(f=[f]);const d=[];for(let y=0;y<f.length;y++){const t=f[y];if(!t)continue;const e=Array.isArray(h)?h[y]:h,r=o["r"].genFnTypes(e),i=new o["p"](f,e,r,c),a=s===o["h"]?i.getLineResource():i.getPolygonResource();if(!o["r"].isAtlasLoaded(a,n[y]))return this.Dn(),this.setToRedraw(),!1;d.push(t)}const p=f[0].id,A=l.call(this,d);for(let o=0;o<A.length;o++)if(A[o].length){const t=e.filter(t=>t.feaGroupIndex===o);if(!t.length)return this.Dn(),this.setToRedraw(),!1;if(t[0].geometry.properties.aFeaIds.indexOf(p)<0)return this.Dn(),this.setToRedraw(),!1}const g=mt({},a),m=A.map(t=>this.createVectorPacks(i,s,g,t,n[0],r));return Promise.all(m).then(t=>{for(let n=0;n<t.length;n++){let r;if(Array.isArray(e)){for(let t=0;t<e.length;t++)if(e[t].feaGroupIndex===n){r=e[t];break}}else r=e;r&&this.zn(r,p,t[n])}}),!0}zn(t,e,n){const r=t.geometry.properties.aFeaIds,i=r.indexOf(e);if(!(i<0)){if(n){const e=n.data.dynamicAttributes,r=n.data.featureIds.length,s=n.data.data;for(const n in s)if(!e[n]&&Tt(s,n)&&s[n]){const e=s[n];t.geometry.updateSubData(n,e,i*e.length/r)}}else{let n=i+1;for(;r[n]===e;)n++;const s=n-i,o=t.geometry.desc.positionSize;Je.length!==3*s&&(Je=new Float32Array(s*o),Je.fill(-1/0,0)),t.geometry.updateSubData(t.geometry.desc.positionAttribute,Je,i*o)}this.layer.fire("updatemesh"),this.setToRedraw()}}in(t){if(!Object.keys(this.qe).length)return void(this.un&&(this.tn.deleteMesh(this.un),delete this.un));const{features:e,center:n}=this.vn(this.qe);if(!e.length)return;const r=this.cn;this.Rn=n;const i=this.Hn(e),s=mt({},Ve),a=i.map((e,r)=>this.createMesh(this.tn,o["h"],s,e,t&&t[r],n));this.Vn=!0,Promise.all(a).then(t=>{this.un&&this.tn.deleteMesh(this.un);const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r]&&t[r].meshes;if(i){for(let t=0;t<i.length;t++){const n=i[t];n.feaGroupIndex=r,e.push(n),n.geometry.properties.originElements=n.geometry.properties.elements.slice()}n[r]=t[r].atlas}}this.un=e,this.ln=n,r&&(this.cn=r),this.Vn=!1,this.setToRedraw(),this.layer.fire("buildlinemesh")})}Hn(t){const e=(Ze+"lineDasharray").trim(),n=(Ze+"linePatternFile").trim(),r=[],i=[],s=[];for(let o=0;o<t.length;o++){const a=t[o],l=a.properties&&a.properties[e];l&&hn(l)?s.push(a):a.properties&&a.properties[n]?i.push(a):r.push(a)}return[r,i,s]}Un(){this.rn=!0,this.setToRedraw()}Dn(){this.Je=!0,this.setToRedraw()}jn(t){const e=this.layer.getId();for(let n=0;n<t.length;n++){const r=t[n];let i=!1;for(let t=0;t<this.GeometryTypes.length;t++)if(r instanceof this.GeometryTypes[t]){i=!0;break}if(!i)throw new Error(`${r.getJSONType()} can't be added to ${this.layer.getJSONType()}(id:${e}).`);this.En(r)}}En(t){void 0===t[qe]&&(t[qe]=this.L++);const e=t[qe];this.features[e]&&this.Bn(e),this.features[e]=Xe(t,this.Ze,this.features[e]);const n=this.features[e];return this.Gn(n,e),this.Ge[e]=t,e}Gn(t,e){if(!t)return;const n=Array.isArray(t)?t[0].id:t.id;if(this.Xe[n]=t,Array.isArray(t))for(let r=0;r<t.length;r++){const n=t[r][Ke];if(t[r][qe]=e,this.We[n]={feature:t[r]},this.We[n][qe]=e,!this.needCheckPointLineSymbols())continue;const i={feature:t[r]};(rn(t[r])||sn(t[r]))&&(this.Ye[n]=i),sn(t[r])&&(this.$e[n]=i),ln(t[r])&&(this.qe[n]=i)}else{t[qe]=e;const n={feature:t},r=t[Ke];if(this.We[r]=n,!this.needCheckPointLineSymbols())return;(rn(t)||sn(t))&&(this.Ye[r]=n),sn(t)&&(this.$e[r]=n),ln(t)&&(this.qe[r]=n)}}needCheckPointLineSymbols(){return!0}Bn(t){const e=this.features[t];if(e)if(Array.isArray(e))for(let n=0;n<e.length;n++){const t=e[n][Ke],r=e[n].id;delete this.Xe[r],delete this.We[t],delete this.Ye[t],delete this.$e[t],delete this.qe[t]}else{const t=e[Ke],n=e.id;delete this.Xe[n],delete this.We[t],delete this.Ye[t],delete this.$e[t],delete this.qe[t]}}pick(t,e,n){const r=[];return this.layer.isVisible()?([this.painter,this.Qe,this.tn].forEach(i=>{if(!i)return;const s=i.pick(t,e,n.tolerance);if(s&&s.data&&s.data.feature){const t=s.data.feature,e=this.Ge[t[qe]];n&&n.includeInternals?r.push(e):(s.geometry=e,delete s.plugin,delete s.data,delete s.point,r.push(s))}}),r):r}Wn(t){const e=t[qe],n=this.features[e];return Array.isArray(n)?n[0][Ke]:n[Ke]}pn(){let t=!1;for(const e in this.Ke){const n=this.Ke[e],r=this.Wn(n);if(!this.On&&(this.Ye[r]||this.$e[r])){const e=this.Cn(n);t=t||e}if(!this.Vn&&this.qe[r]){const e=this.Nn(n);t=t||e}if(!this.Xn){const e=this.updateMesh(n);t=t||e}}this.Ke={},t&&(en(this),this.layer.fire("partialupdate"))}Yn(t){this.En(t),this.Dn(),en(this)}onGeometryAdd(t){this.setToRedraw(),this.canvas&&t&&t.length&&(this.jn(t),this.Dn(),en(this))}onGeometryRemove(t){if(t&&t.length){for(let e=0;e<t.length;e++){const n=t[e][qe];void 0!==n&&(delete this.Ge[n],this.Bn(n),delete this.features[n])}this.Dn(),en(this)}}onGeometrySymbolChange(t){const e=t.target._getParent()||t.target,n=e[qe];if(void 0===n)return;let r=t.properties;if(Array.isArray(r)){const t={};for(let e=0;e<r.length;e++)r[e]&&mt(t,r[e]);r=t}else if(r&&void 0!==r[0]){const t={};for(const e in r)r[e]&&mt(t,r[e]);r=t}for(const a in r)if(Tt(r,a)&&o["l"][a])return void this.Yn(e);const i=e._getInternalSymbol(),s=this.features[n];if(this.En(e),s)if(function(t,e){return Array.isArray(t)?!!Array.isArray(e)&&t.length===e.length:!Array.isArray(e)}(i,s)){if(Array.isArray(i)){for(let t=0;t<i.length;t++)if(!cn(i[t],s[t]))return void this.Yn(e)}else if(!cn(i,s))return void this.Yn(e);this.onGeometryPositionChange(t)}else this.Yn(e);else this.Yn(e)}onGeometryShapeChange(t){const e=t.target._getParent()||t.target;void 0!==e[qe]&&(this.jn([e]),this.Un(),en(this))}onGeometryPositionChange(t){const e=t.target._getParent()||t.target,n=e[qe];void 0!==n&&(this.jn([e]),this.Ke[n]=e,en(this))}onGeometryZIndexChange(t){void 0!==(t.target._getParent()||t.target)[qe]&&this.Dn()}onGeometryShow(t){void 0!==(t.target._getParent()||t.target)[qe]&&this.$n(t)}onGeometryHide(t){void 0!==(t.target._getParent()||t.target)[qe]&&this.$n(t)}$n(t){const e=t.target,n=e[qe],r=this.features[n];if(r){const t=e.isVisible();if(Array.isArray(r)){if(t===r[0].visible)return;for(let e=0;e<r.length;e++)r[e].visible=t}else{if(t===r.visible)return;r.visible=t}this.qn(),en(this)}}qn(){this.cn=!0}onGeometryPropertiesChange(t){const e=t.target._getParent()||t.target,n=e[qe];void 0!==n&&(this.features[n]=Xe(e,this.Ze),this.Gn(this.features[n],n),this.Dn(),en(this))}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;t?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.ot(),t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.prepareRequestors(),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=this.createPainter();const e=He.get3DPainterClass("icon");let n=e.getBloomSymbol();const r=mt({},Ue,je);r.markerPerspectiveRatio=this.layer.options.markerPerspectiveRatio||0,this.Jn(r,n),this.Fn=r;const i=mt({},Et,this.layer.options.sceneConfig||{});this.Qe=new e(this.regl,this.layer,r,i,0),this.Qe.setTextShaderDefines({REVERSE_MAP_ROTATION_ON_PITCH:1});const s=He.get3DPainterClass("line"),o=mt({},Ve);n=s.getBloomSymbol(),this.Jn(o,n),this.Zn=o;const a=mt({},this.layer.options.sceneConfig||{});void 0===a.depthMask&&(a.depthMask=!0),this.tn=new s(this.regl,this.layer,o,a,0),this.layer.getGeometries()&&this.onGeometryAdd(this.layer.getGeometries())}st(){return!!(this.canvas&&this.canvas.gl&&this.canvas.gl.wrap)}Jn(t,e){for(let n=0;n<e.length;n++)t[e[n]]=this.layer.options.enableBloom}updateBloom(t){this.Qe&&this.Kn(this.Qe,this.Fn,t),this.tn&&this.Kn(this.tn,this.Zn,t),this.painter&&this.Kn(this.painter,this.painterSymbol,t)}Kn(t,e,n){const r=t.constructor.getBloomSymbol().reduce((t,r)=>(t[r]=n,e[r]=n,t),{});t.updateSymbol(r,e)}createPainter(){}ot(){const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0,antialias:!1};t.preserveDrawingBuffer=!0,t.stencil=!0,this.glOptions=t,this.gl=this.gl||this.ut(this.canvas,t),this.regl=Object(r["h"])({gl:this.gl,attributes:t,extensions:r["m"].Constants.WEBGL_EXTENSIONS,optionalExtensions:r["m"].Constants.WEBGL_OPTIONAL_EXTENSIONS})}ut(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}clearCanvas(){super.clearCanvas(),this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:255})}resizeCanvas(t){super.resizeCanvas(t);const e=this.canvas;e&&(!this.pickingFBO||this.pickingFBO.width===e.width&&this.pickingFBO.height===e.height||this.pickingFBO.resize(e.width,e.height),this.painter&&this.painter.resize(e.width,e.height))}onRemove(){super.onRemove(),this.painter&&(this.painter.delete(),delete this.painter),this.Qe&&(this.Qe.delete(),delete this.Qe),this.tn&&(this.tn.delete(),delete this.tn)}drawOutline(t){if(this.Mt&&(this.painter&&this.painter.outlineAll(t),this.Qe.outlineAll(t),this.tn.outlineAll(t)),this.Qn)for(let e=0;e<this.Qn.length;e++)this.painter&&this.painter.outline(t,this.Qn[e]),this.Qe.outline(t,this.Qn[e]),this.tn.outline(t,this.Qn[e])}outlineAll(){this.Mt=!0,this.setToRedraw()}outline(t){this.Qn||(this.Qn=[]);const e=[];for(let n=0;n<t.length;n++){const r=this.layer.getGeometryById(t[n]);if(r){const t=this.features[r[qe]];if(Array.isArray(t))for(let n=0;n<t.length;n++)e.push(t[n].id);else e.push(t.id)}}this.Qn.push(e),this.setToRedraw()}cancelOutline(){delete this.Mt,delete this.Qn,this.setToRedraw()}isEnableWorkAround(t){return"win-intel-gpu-crash"===t&&this.layer.options.workarounds["win-intel-gpu-crash"]&&nn(this.gl)}gt(t){return St(t,this.getMap())}Be(){const t=this.layer.getGeometries();t&&this.jn(t),this.Dn()}ne(){const t=this.layer.options.opacity;return this.st()?wt(t)?1:t:1}}function en(t){t.setToRedraw()}function nn(t){const e=t.getExtension("WEBGL_debug_renderer_info");if(e&&"undefined"!=typeof navigator){const n=t.getParameter(e.UNMASKED_RENDERER_WEBGL),r="Win32"===navigator.platform||"Win64"===navigator.platform;if(n&&n.toLowerCase().indexOf("intel")>=0&&r)return!0}return!1}function rn({properties:t}){const e=(Ze+"markerFile").trim(),n=(Ze+"markerType").trim();return t[e]||t[n]}function sn({properties:t}){return t[(Ze+"textName").trim()]}const on=(Ze+"lineWidth").trim(),an="_line_gradient_property".trim();function ln(t){return 2===t.type&&!t.properties[an]||3===t.type&&void 0!==t.properties[on]}function hn(t){if(!Array.isArray(t))return 0;let e=0;for(let n=0;n<t.length;n++)e+=t[n];return e}function cn(t,e){if(Object.keys(t).sort().join()!==Object.keys(e.properties||{}).filter(t=>0===t.indexOf(Ze)).map(t=>t.substring(Ze.length)).sort().join())return!1;for(const n in t)if(Tt(t,n)){const r=(Ze+n).trim();if(Object(s["c"])(t[n])!==Object(s["c"])(e.properties[r]))return!1}return!0}function un(t,e,n){if(!t||t.type!==e)return null;const r=new n(t.id,t.options),s=t.geometries,o=[];for(let a=0;a<s.length;a++){const t=i["m"].fromJSON(s[a]);t&&o.push(t)}return r.addGeometry(o),r}class fn extends He{static fromJSON(t){return un(t,"PointLayer",fn)}constructor(...t){super(...t),this.options.sceneConfig||(this.options.sceneConfig=mt({},Et))}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}}fn.mergeOptions({glyphSdfLimitPerFrame:15,iconErrorUrl:null,workarounds:{"win-intel-gpu-crash":!0},collision:!1,collisionFrameLimit:1}),fn.registerJSONType("PointLayer"),fn.registerRenderer("canvas",null),fn.registerRenderer("gl",class extends tn{constructor(...t){super(...t),this.GeometryTypes=[i["u"],i["w"]]}onGeometryAdd(t){t&&(Array.isArray(t)?t.forEach(t=>{t.options.maxMarkerWidth=t.options.maxMarkerHeight=255}):t.options.maxMarkerWidth=t.options.maxMarkerHeight=255,super.onGeometryAdd(t))}});class dn extends He{static fromJSON(t){return un(t,"LineStringLayer",dn)}}dn.mergeOptions({meshRenderOrder:1}),dn.registerJSONType("LineStringLayer");const pn="_line_gradient_property".trim();dn.registerRenderer("gl",class extends tn{constructor(...t){super(...t),this.GeometryTypes=[i["s"],i["v"]]}createPainter(){const t=He.get3DPainterClass("line-gradient");this.painterSymbol=mt({},{lineGradientProperty:pn},Ve),this.Jn(this.painterSymbol,t.getBloomSymbol());const e=mt({},this.layer.options.sceneConfig||{});return void 0===e.depthMask&&(e.depthMask=!0),new t(this.regl,this.layer,this.painterSymbol,e,0)}buildMesh(){let{features:t,center:e}=this.vn();if(t=t.filter(t=>!!t.properties[pn]),!t.length)return;const n=this.cn;this.ti=e;const r=mt({},this.painterSymbol),i=this.createMesh(this.painter,o["h"],r,t,null,e);this.Xn=!0,i.then(t=>{this.meshes&&this.painter.deleteMesh(this.meshes);const e=[],r=t&&t.meshes;if(r){e.push(...r);for(let t=0;t<r.length;t++)r[t].feaGroupIndex=0,r[t].geometry.properties.originElements=r[t].geometry.properties.elements.slice()}this.meshes=e,n&&(this.cn=n),this.Xn=!1,this.setToRedraw()})}}),dn.registerRenderer("canvas",null);class An extends He{static fromJSON(t){return un(t,"PolygonLayer",An)}}An.registerJSONType("PolygonLayer");const gn={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonPatternFile:{type:"identity",default:void 0,property:"_symbol_polygonPatternFile"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},uvScale:{type:"identity",default:[1,1],property:"_symbol_uvScale"},uvOffset:{type:"identity",default:[0,0],property:"_symbol_uvOffset"},uvOffsetInMeter:{type:"identity",default:!1,property:"_symbol_uvOffsetInMeter"},polygonPatternFileWidth:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileWidth"},polygonPatternFileHeight:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileHeight"},polygonPatternFileOrigin:{type:"identity",default:void 0,property:"_symbol_polygonPatternFileOrigin"},polygonPatternUV:{type:"identity",default:void 0,property:"_symbol_polygonPatternUV"}};class mn extends tn{constructor(...t){super(...t),this.GeometryTypes=[i["C"],i["x"]]}getPolygonOffsetCount(){return this.options.altitude>0?0:2}buildMesh(t){const{features:e,center:n}=this.vn();if(!e.length)return;const r=this.cn;this.ti=n;const i=this.ei(e),s=mt({},gn),a=i.map((e,r)=>this.createMesh(this.painter,o["k"],s,e,t&&t[r],n));this.Xn=!0,Promise.all(a).then(t=>{this.meshes&&this.painter.deleteMesh(this.meshes),t=function(t){const e=[];for(let n=0;n<t.length;n++)Array.isArray(t[n])?e.push(...t[n]):e.push(t[n]);return e}(t);const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r]&&t[r].meshes;if(i){e.push(...i);for(let t=0;t<i.length;t++)i[t].feaGroupIndex=r,i[t].geometry.properties.originElements=i[t].geometry.properties.elements.slice(),1===r&&(i[t].transparent=!0);n[r]=t[r].atlas}}this.meshes=e,this.atlas=n,r&&(this.cn=r),this.Xn=!1,this.setToRedraw(),this.layer.fire("buildmesh")})}getRayCastData(t,e){const n=this.painter.getRayCastData(t,e);if(!n||!n.feature)return null;const r=n.feature[qe];return this.Ge[r]}ei(t){const e=[],n=[];for(let r=0;r<t.length;r++){const i=t[r];i.properties&&i.properties._symbol_polygonOpacity<1?n.push(i):e.push(i)}return[e,n]}createPainter(){const t=He.get3DPainterClass("fill"),e=this.painterSymbol=mt({},gn);return this.Jn(e,t.getBloomSymbol()),new t(this.regl,this.layer,e,this.layer.options.sceneConfig,0)}updateMesh(t){return this.Ln(t,this.meshes,this.atlas,this.ti,this.painter,o["k"],gn,this.ei)}}function yn(t,e,n,r,i,s,o){const a=n&&Array.isArray(n[0]);for(let l=0,h=n.length;l<h;l++){t[e]=(a?n[l][0]:n[l].x)*r,t[e+1]=(a?n[l][1]:n[l].y)*r,o!==Float32Array&&(t[e]=Math.round(t[e]),t[e+1]=Math.round(t[e+1]));let c=i||0;Array.isArray(i)&&(c=i[l]),c=c?Math.round(r*c):0,t[e+2]=c,e+=3,s&&0!==l&&l!==h-1&&(t[e]=t[e-3],t[e+1]=t[e-2],t[e+2]=t[e-1],e+=3)}return t.trySetLength&&t.trySetLength(e),e}function vn(t,e,n,r){const i=t[3*e],s=t[3*e+1],o=t[3*n],a=t[3*n+1];return i===o&&(i<0||i>r)||s===a&&(s<0||s>r)}An.registerRenderer("gl",mn),An.registerRenderer("canvas",null);const xn=Math.PI/180,bn=6378137*Math.PI/180;function wn(t,e,n){if("EPSG:3857"===n)return function(t,e){const n=85.0511287798,r=e[0],i=Math.max(Math.min(n,e[1]),-n);let s;return s=0===i?0:Math.log(Math.tan((90+i)*xn/2))/xn,t[0]=r*bn,t[1]=s*bn,t}(t,e);if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return _n(t,e);if("baidu"===n)return _n(t,e);throw new Error("unsupported projection:"+n)}function _n(t,e){return t[0]=e[0],t[1]=e[1],t}function Mn(t,e,n,r,i,s,o,a,l,h,c,f,d,p,A){0===t?function(t,e,n,r,i,s,o,a,l,h){const c=1/(100*s[0]),u=1/(100*s[1]),f=h&&h[0]||0,d=h&&h[1]||0,p=[0,0];for(let A=t;A<e;A+=3){const t=A/3*2,e=r[A]-f,i=r[A+1]-d;n[t]=p[0]+e/o*c/a,n[t+1]=p[1]-i/o*u/l}}(e,n,r,i,0,o,a,l,h,A):1===t&&function(t,e,n,r,i,s,o,a,l,h,c){if(!t)return;let f,d,p,A;0===t[4]?(f=t[0],d=t[1],p=t[2],A=t[3]):(f=t[1],d=t[2],p=t[3],A=t[0]);const g=u["e"].distance(f,d),m=u["e"].distance(d,p),y=[],v=[],x=[];for(let b=e;b<n;b+=3){const t=b/3*2,e=(s.x/l+i[b]/o)*a,n=s.y/l*a+(c?i[b+1]:-i[b+1])/o*a;u["e"].set(y,e,n),"EPSG:4326"!==h&&"EPSG:4490"!==h||wn(y,y,"EPSG:3857"),Tn(v,y,f,d),Tn(x,y,A,f),r[t]=u["e"].distance(f,v)/g,r[t+1]=u["e"].distance(f,x)/m}}(c,e,n,r,i,s,a,f,d,p,!!A)}function Tn(t,e,n,r){const i=n[0]-r[0],s=n[1]-r[1];let o=(e[0]-n[0])*(n[0]-r[0])+(e[1]-n[1])*(n[1]-r[1]);return o/=i*i+s*s,t[0]=n[0]+o*i,t[1]=n[1]+o*s,t}function Sn(t,e,n,r,i){const s=3*e[n-1],o=3*e[n-1]+1,a=t[s],l=t[o];return h=r,c=i,u=a,f=l,Math.sqrt((u-h)*(u-h)+(f-c)*(f-c));var h,c,u,f}function In(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A,g){const m=e.length,y=i/3;for(let v=2,x=m;v<x;v+=3)t[i+v-2]=e[v-2],t[i+v-1]=e[v-1],t[i+v-0]=e[v]-o;i+=m;for(let v=2,x=m;v<x;v+=3)t[i+v-2]=e[v-2],t[i+v-1]=e[v-1],t[i+v-0]=e[v]-a;i+=m,t.trySetLength(i+m),t.copyWithin(i,i-2*m,i-m),i+=m,t.trySetLength(i+m),t.copyWithin(i,i-2*m,i-m),i+=m,(n=n||[]).push(m/3);for(let v=0;v<n.length;v++)Cn(y+(n[v-1]||0),y+n[v],t,m/3,l,r,h,c,u,f,s,d,p,A,g);return i}function Cn(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p){const A=s.length;let g,m;for(let y=t,v=e;y<v-1;y++)g=y,m=y+1,i!==1/0&&vn(n,g,m,i)||((y-t)%2==1&&(g+=2*r,m+=2*r),p?(s.push(g+r,m,g),s.push(m+r,m,g+r)):(s.push(g+r,g,m),s.push(m,m+r,g+r)));o&&function(t,e,n,r,i,s,o,a,l,h,c){let u,f=0,d=0,p=0,A=0;const g=c?[1,3,4]:[2,3,4];for(let m=s.length-1;m>=0;m--){const c=s[m],y=3*c+1,v=3*c+2,x=i[3*c],b=i[y],w=i[v];f||d||(f=Math.max(i[v],i[3*s[m-3]+2]),d=Math.min(i[v],i[3*s[m-3]+2]),u=f-d);let _=p;const M=m%6;0===t?(5===M&&(A=Sn(i,s,m,x,b)),_=M===g[0]||M===g[1]||M===g[2]?p:p+A):1===t&&(M===g[0]||M===g[1]||M===g[2]?_=0:5===M?(A=Sn(i,s,m,x,b),_=A):_=A);const T=_/l*(1/(100*h))/o;let S;S=1===e?w===f?1:0:"bottom"===n?w===f?u/100/a:0:w===f?0:-u/100/a,r[2*c]=T,r[2*c+1]=S,0===M&&(p+=A)}}(a,l,h,c,n,s.slice(A,s.length),u[0],u[1],f,d,p)}function On(t){const e=[t[0]];let n=t[0];for(let r=1;r<t.length;r++)Array.isArray(t[r])?t[r][0]===n[0]&&t[r][1]===n[1]&&t[r][2]===n[2]||e.push(t[r]):t[r].x===n.x&&t[r].y===n.y&&t[r].z===n.z||e.push(t[r]),n=t[r];return e}const En=o["a"].getInstance();function Pn(t,e,n,r,i,a,l,h,c,f,A,g,m,y,v,x){void 0===e.top&&(e.top=!0),void 0===e.side&&(e.side=!0),En.reset();const{altitudeScale:b,altitudeProperty:w,defaultAltitude:_,heightProperty:M,minHeightProperty:T,defaultHeight:S,tangent:I,uv:C,topUVMode:O,sideUVMode:E,sideVerticalUVMode:P,top:k,side:R,textureYOrigin:N,topThickness:D}=e,F=!!x,L=function(t,e,{altitudeScale:n,altitudeProperty:r,defaultAltitude:i,heightProperty:s,minHeightProperty:a,defaultHeight:l},{center:h,side:c,top:u,topThickness:f,uvOrigin:p,uv:A,uvSize:g,topUVMode:m,sideUVMode:y,sideVerticalUVMode:v,textureYOrigin:x,tileRatio:b,centimeterToPoint:w,verticalCentimeterToPoint:_,positionType:M,res:T,glScale:S,projectionCode:I},C,O){let E=e/t[0].extent;e===1/0&&(E=1);const P=e===1/0,k=O.get(),R=O.get(),N=O.get(),D=O.get(),F=O.get(),L=O.get(),z=O.get(),B=!!A,H=!!u,U=!!c,j=B?O.get():null;function V(t,n,r,i,s,o){let a=n;if(H){const i=d()(D,r,3);if(0===i.length)return n;if(_t(F,D),n+=D.length,o)for(let e=2,n=i.length;e<n;e+=3)i[e]+=t/3,i[e-1]+=t/3,i[e-2]+=t/3;else{let e;for(let n=2,r=i.length;n<r;n+=3)e=i[n-1],i[n-1]=i[n]+t/3,i[n]=e+t/3,i[n-2]+=t/3}_t(L,i),B&&Mn(m||0,t,n,j,F,p,w,b,g[0],g[1],s,T,S,I,h),f>0&&!U&&(n=In(F,D,r,L,n,j,0,f,e,B,y||0,v||0,x,g,b,_,o)),z.setLength(n/3),z.fill(1,a/3,n/3)}if(U){H&&(f=0),a=n,n=In(F,D,r,L,n,j,f,i,e,B,y||0,v||0,x,g,b,_,o),z.setLength(n/3);const t=D.length/3;z.fill(1,a/3,a/3+t),z.fill(0,a/3+t,a/3+2*t),z.fill(1,a/3+2*t,a/3+3*t),z.fill(0,a/3+3*t,n/3)}return n}let G=0,q=0;const W=[-1,-1,e+1,e+1];let X=0,Q=t.length;vt(C)&&(X=C,Q=C+1);let Y=0,Z=!1;const K=O.get();for(;X<Q;X++){const h=t[X],c=h.id;vt(c)&&(Math.abs(c)>Y&&(Y=Math.abs(c)),c<0&&(Z=!0));const u=h.geometry,f=h.properties.maptalks_ombb;let d=Array.isArray(f&&f[0]&&f[0][0])?f[0]:f;const{altitude:p,height:A}=o["i"].getFeaAltitudeAndHeight(h,n,r,i,s,l,a);G=Math.max(Math.abs(p),G);const g=F.length;let m=0,y=q;K.setLength(0),D.setLength(0);const v=o["i"].calculateSignedArea(u[0])<0;for(let t=0,n=u.length;t<n;t++){let r=u[t];v&&(r=r.reverse()),r=On(r);const i=o["i"].calculateSignedArea(r)<0;if(!i&&t>0&&(m++,d=f&&f[m],q=V(y,q,K,A*E,d,P),D.setLength(0),K.setLength(0),y=q),e!==1/0&&(r=o["i"].clipPolygon(r,W)),!r.length){t===n-1&&(q=V(y,q,K,A*E,d,P));continue}const s=r.length;Array.isArray(r[0])?r[0][0]===r[s-1][0]&&r[0][1]===r[s-1][1]||r.push([r[0][0],r[0][1]]):r[0].x===r[s-1].x&&r[0].y===r[s-1].y||r.push(r[0]),i&&K.push(D.length/3),yn(D,D.length,r,E,p,!1,M),t===n-1&&(q=V(y,q,K,A*E,d,P))}const x=F.length-g,b="__fea_idx".trim();for(let t=0;t<x/3;t++)R.push(void 0===h[b]?X:h[b]),k.push(X),vt(c)&&N.push(c)}const J=o["i"].getUnsignedArrayType(R.length?R[R.length-1]:0),$={maxAltitude:G,vertices:F,verticeTypes:z,indices:L,pickingIds:o["a"].createTypedArray(R,J),featureIndexes:k};if(N.length){const t=Z?o["i"].getPosArrayType(Y):o["i"].getUnsignedArrayType(Y);$.featureIds=o["a"].createTypedArray(N,t)}else $.featureIds=[];return j&&(j.setLength(F.length/3*2),$.uvs=j),$}(t,n,{altitudeScale:b,altitudeProperty:w,defaultAltitude:_||0,heightProperty:M,minHeightProperty:T,defaultHeight:S||0},{center:x,top:k,side:R,topThickness:10*D||0,uv:C||I,uvSize:[i,i],uvOrigin:r,topUVMode:O,sideUVMode:E,sideVerticalUVMode:P,textureYOrigin:N,tileRatio:h,centimeterToPoint:c,verticalCentimeterToPoint:f,positionType:v,res:a,glScale:l,projectionCode:m},y,En),z=[],B=L.vertices.length/3,H=o["i"].getIndexArrayType(B),U=o["a"].createTypedArray(L.indices,H);delete L.indices,z.push(U.buffer,L.pickingIds.buffer);const j=I?En.get():new Float32Array(3*B);j.setLength&&j.setLength(3*B);const V=Object(p["a"])(L.vertices,U,j);let G=!0;for(let s=0;s<V.length;s++){F||(V[s]=-V[s]);const t=V[s]%1;1-Math.abs(t)>1e-6?G=!1:0!==t&&(V[s]=Math.round(V[s]))}if(L.normals=V,I){let t=En.get();t.setLength(4*B),t=Object(p["b"])(L.vertices,L.normals,L.uvs,U,t),t=function(t,e){const n=new Float32Array(e.length),r=[],i=[],s=[];for(let o=0;o<e.length;o+=4){const a=o/4*3;u["f"].set(i,t[a]||0,t[a+1]||0,t[a+2]||0),u["g"].set(r,e[o]||0,e[o+1]||0,e[o+2]||0,e[o+3]||0),Object(p["c"])(s,i,r),u["g"].copy(n.subarray(o,o+4),s)}return n}(L.normals,t),L.tangents=t,z.push(t.buffer),delete L.normals}if(L.normals&&(G&&(L.normals=o["a"].createTypedArray(L.normals,Int8Array)),z.push(L.normals.buffer)),L.uvs){const t=L.uvs;L.uvs=o["a"].createTypedArray(t,Float32Array),z.push(L.uvs.buffer)}if(x){const t=L.vertices;for(let e=0;e<t.length;e+=3)t[e]-=x[0],t[e+1]-=x[1]}const q=v||o["i"].getPosArrayType(Math.max(512,L.maxAltitude)),W=function(t,e,n,r){const i={},a={};if(Mt(e.polygonFill)){let l=Object(s["e"])(e.polygonFill);const h=new Uint8Array(4*r.length);h.fill(255);for(let e=0;e<r.length;e++){const a=t[r[e]],c=a.properties||{};c.$layer=a.layer,c.$type=a.type;let u=l(n,c);Object(s["c"])(u)&&(i.aColor=1,l=Object(s["e"])(u),u=l(n,c)),delete c.$layer,delete c.$type,o["n"].normalizeColor(kn,u),h[4*e]=kn[0],h[4*e+1]=kn[1],h[4*e+2]=kn[2],h[4*e+3]=kn[3]}a.aColor=h}if(Mt(e.polygonOpacity)){let o=Object(s["b"])(e.polygonOpacity);const l=new Uint8Array(r.length);l.fill(255);for(let e=0;e<r.length;e++){const a=t[r[e]],h=a.properties||{};h.$layer=a.layer,h.$type=a.type;let c=o(n,h);Object(s["c"])(c)&&(i.aOpacity=1,o=Object(s["e"])(c),c=o(n,h)),delete h.$layer,delete h.$type,l[e]=255*c}a.aOpacity=l}return a.dynamicAttributes=i,a}(t,A,g,L.featureIndexes),X=function(t,e,n,r,i){const a=[[],[]],l=Mt(r.topPolygonFill),h=Mt(r.bottomPolygonFill),c=[255,255,255,255];if(l||h){let f=l&&Object(s["e"])(r.topPolygonFill),d=h&&Object(s["e"])(r.bottomPolygonFill),p=null,A=null,g=null,m=null;for(let r=0;r<e.length;r++){if(1===t[r]&&!l||0===t[r]&&!h)continue;const y=1===t[r];if(y&&e[r]===p){t[r]=g;continue}if(!y&&e[r]===A){t[r]=m;continue}const v=n[e[r]],x=v.properties||{};x.$layer=v.layer,x.$type=v.type;let b=y?f:d,w=b(i,x);Object(s["c"])(w)&&(b=Object(s["e"])(w),w=b(i,x)),delete x.$layer,delete x.$type,o["n"].normalizeColor(kn,w),u["g"].divide(kn,kn,c);let _=Rn(a,kn);_<0&&(_=a.length,a.push(u["g"].copy([],kn))),t[r]=_,y?(p=e[r],g=_):(A=e[r],m=_)}}return a.slice(2)}(L.verticeTypes,L.featureIndexes,t,A,g),Q={data:{data:{aVertexColorType:X.length<=252?o["a"].createTypedArray(L.verticeTypes,Uint8Array):o["a"].createTypedArray(L.verticeTypes,Uint16Array),aPosition:o["a"].createTypedArray(L.vertices,q),aNormal:L.normals,aTexCoord0:L.uvs,aTangent:L.tangents,aPickingId:L.pickingIds},indices:U,properties:{maxAltitude:L.maxAltitude},dynamicAttributes:W.dynamicAttributes,vertexColors:X},buffers:z};return L.featureIds.length?(Q.data.featureIds=L.featureIds,z.push(Q.data.featureIds.buffer)):Q.data.featureIds=[],W.aColor&&(Q.data.data.aColor=W.aColor,Q.buffers.push(W.aColor.buffer)),W.aOpacity&&(Q.data.data.aOpacity=W.aOpacity,Q.buffers.push(W.aOpacity.buffer)),Q.buffers.push(Q.data.data.aPosition.buffer),Q.data.pickingIdIndiceMap=o["i"].generatePickingIndiceIndex(Q.data.data.aPickingId,Q.data.indices),Q}const kn=[];function Rn(t,e){for(let n=0;n<t.length;n++)if(u["g"].exactEquals(e,t[n]))return n;return-1}class Nn{constructor(t=[],e=Dn){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this.ni(n)}push(t){this.data.push(t),this.length++,this.ii(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this.ni(0)),t}peek(){return this.data[0]}ii(t){const{data:e,compare:n}=this,r=e[t];for(;t>0;){const i=t-1>>1,s=e[i];if(n(r,s)>=0)break;e[t]=s,t=i}e[t]=r}ni(t){const{data:e,compare:n}=this,r=this.length>>1,i=e[t];for(;t<r;){let r=1+(t<<1),s=e[r];const o=r+1;if(o<this.length&&n(e[o],s)<0&&(r=o,s=e[o]),n(s,i)>=0)break;e[t]=s,t=r}e[t]=i}}function Dn(t,e){return t<e?-1:t>e?1:0}var Fn={exports:{}},Ln=function(t,e,n,r){var i=t[0],s=t[1],o=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=(r-n)/2,l=0,h=a-1;l<a;h=l++){var c=e[n+2*l+0],u=e[n+2*l+1],f=e[n+2*h+0],d=e[n+2*h+1];u>s!=d>s&&i<(f-c)*(s-u)/(d-u)+c&&(o=!o)}return o},zn=function(t,e,n,r){var i=t[0],s=t[1],o=!1;void 0===n&&(n=0),void 0===r&&(r=e.length);for(var a=r-n,l=0,h=a-1;l<a;h=l++){var c=e[l+n][0],u=e[l+n][1],f=e[h+n][0],d=e[h+n][1];u>s!=d>s&&i<(f-c)*(s-u)/(d-u)+c&&(o=!o)}return o};Fn.exports=function(t,e,n,r){return e.length>0&&Array.isArray(e[0])?zn(t,e,n,r):Ln(t,e,n,r)};var Bn=Fn.exports.nested=zn;function Hn(t,e,n,r,i){let s,o,a,l,h=e[0],c=r[0],u=0,f=0;c>h==c>-h?(s=h,h=e[++u]):(s=c,c=r[++f]);let d=0;if(u<t&&f<n)for(c>h==c>-h?(o=h+s,a=s-(o-h),h=e[++u]):(o=c+s,a=s-(o-c),c=r[++f]),s=o,0!==a&&(i[d++]=a);u<t&&f<n;)c>h==c>-h?(o=s+h,l=o-s,a=s-(o-l)+(h-l),h=e[++u]):(o=s+c,l=o-s,a=s-(o-l)+(c-l),c=r[++f]),s=o,0!==a&&(i[d++]=a);for(;u<t;)o=s+h,l=o-s,a=s-(o-l)+(h-l),h=e[++u],s=o,0!==a&&(i[d++]=a);for(;f<n;)o=s+c,l=o-s,a=s-(o-l)+(c-l),c=r[++f],s=o,0!==a&&(i[d++]=a);return 0===s&&0!==d||(i[d++]=s),d}function Un(t){return new Float64Array(t)}Fn.exports.flat=Ln;const jn=Un(4),Vn=Un(8),Gn=Un(12),qn=Un(16),Wn=Un(4);function Xn(t,e,n,r,i,s){const o=(e-s)*(n-i),a=(t-i)*(r-s),l=o-a;if(0===o||0===a||o>0!=a>0)return l;const h=Math.abs(o+a);return Math.abs(l)>=33306690738754716e-32*h?l:-function(t,e,n,r,i,s,o){let a,l,h,c,u,f,d,p,A,g,m,y,v,x,b,w,_,M;const T=t-i,S=n-i,I=e-s,C=r-s;x=T*C,f=134217729*T,d=f-(f-T),p=T-d,f=134217729*C,A=f-(f-C),g=C-A,b=p*g-(x-d*A-p*A-d*g),w=I*S,f=134217729*I,d=f-(f-I),p=I-d,f=134217729*S,A=f-(f-S),g=S-A,_=p*g-(w-d*A-p*A-d*g),m=b-_,u=b-m,jn[0]=b-(m+u)+(u-_),y=x+m,u=y-x,v=x-(y-u)+(m-u),m=v-w,u=v-m,jn[1]=v-(m+u)+(u-w),M=y+m,u=M-y,jn[2]=y-(M-u)+(m-u),jn[3]=M;let O=function(t,e){let n=e[0];for(let r=1;r<t;r++)n+=e[r];return n}(4,jn),E=22204460492503146e-32*o;if(O>=E||-O>=E)return O;if(u=t-T,a=t-(T+u)+(u-i),u=n-S,h=n-(S+u)+(u-i),u=e-I,l=e-(I+u)+(u-s),u=r-C,c=r-(C+u)+(u-s),0===a&&0===l&&0===h&&0===c)return O;if(E=11093356479670487e-47*o+33306690738754706e-32*Math.abs(O),O+=T*c+C*a-(I*h+S*l),O>=E||-O>=E)return O;x=a*C,f=134217729*a,d=f-(f-a),p=a-d,f=134217729*C,A=f-(f-C),g=C-A,b=p*g-(x-d*A-p*A-d*g),w=l*S,f=134217729*l,d=f-(f-l),p=l-d,f=134217729*S,A=f-(f-S),g=S-A,_=p*g-(w-d*A-p*A-d*g),m=b-_,u=b-m,Wn[0]=b-(m+u)+(u-_),y=x+m,u=y-x,v=x-(y-u)+(m-u),m=v-w,u=v-m,Wn[1]=v-(m+u)+(u-w),M=y+m,u=M-y,Wn[2]=y-(M-u)+(m-u),Wn[3]=M;const P=Hn(4,jn,4,Wn,Vn);x=T*c,f=134217729*T,d=f-(f-T),p=T-d,f=134217729*c,A=f-(f-c),g=c-A,b=p*g-(x-d*A-p*A-d*g),w=I*h,f=134217729*I,d=f-(f-I),p=I-d,f=134217729*h,A=f-(f-h),g=h-A,_=p*g-(w-d*A-p*A-d*g),m=b-_,u=b-m,Wn[0]=b-(m+u)+(u-_),y=x+m,u=y-x,v=x-(y-u)+(m-u),m=v-w,u=v-m,Wn[1]=v-(m+u)+(u-w),M=y+m,u=M-y,Wn[2]=y-(M-u)+(m-u),Wn[3]=M;const k=Hn(P,Vn,4,Wn,Gn);x=a*c,f=134217729*a,d=f-(f-a),p=a-d,f=134217729*c,A=f-(f-c),g=c-A,b=p*g-(x-d*A-p*A-d*g),w=l*h,f=134217729*l,d=f-(f-l),p=l-d,f=134217729*h,A=f-(f-h),g=h-A,_=p*g-(w-d*A-p*A-d*g),m=b-_,u=b-m,Wn[0]=b-(m+u)+(u-_),y=x+m,u=y-x,v=x-(y-u)+(m-u),m=v-w,u=v-m,Wn[1]=v-(m+u)+(u-w),M=y+m,u=M-y,Wn[2]=y-(M-u)+(m-u),Wn[3]=M;const R=Hn(k,Gn,4,Wn,qn);return qn[R-1]}(t,e,n,r,i,s,h)}function Qn(t,e,n){e=Math.max(0,void 0===e?2:e),n=n||0;var r=function(t){for(var e=t[0],n=t[0],r=t[0],i=t[0],s=0;s<t.length;s++){var o=t[s];o[0]<e[0]&&(e=o),o[0]>r[0]&&(r=o),o[1]<n[1]&&(n=o),o[1]>i[1]&&(i=o)}var a=[e,n,r,i],l=a.slice();for(s=0;s<t.length;s++)Bn(t[s],a)||l.push(t[s]);return function(t){t.sort(or);for(var e=[],n=0;n<t.length;n++){for(;e.length>=2&&tr(e[e.length-2],e[e.length-1],t[n])<=0;)e.pop();e.push(t[n])}for(var r=[],i=t.length-1;i>=0;i--){for(;r.length>=2&&tr(r[r.length-2],r[r.length-1],t[i])<=0;)r.pop();r.push(t[i])}return r.pop(),e.pop(),e.concat(r)}(l)}(t),i=new g.a(16);i.toBBox=function(t){return{minX:t[0],minY:t[1],maxX:t[0],maxY:t[1]}},i.compareMinX=function(t,e){return t[0]-e[0]},i.compareMinY=function(t,e){return t[1]-e[1]},i.load(t);for(var s,o=[],a=0;a<r.length;a++){var l=r[a];i.remove(l),s=nr(l,s),o.push(s)}var h=new g.a(16);for(a=0;a<o.length;a++)h.insert(er(o[a]));for(var c=e*e,u=n*n;o.length;){var f=o.shift(),d=f.p,p=f.next.p,A=rr(d,p);if(!(A<u)){var m=A/c;(l=Yn(i,f.prev.p,d,p,f.next.next.p,m,h))&&Math.min(rr(l,d),rr(l,p))<=m&&(o.push(f),o.push(nr(l,f)),i.remove(l),h.remove(f),h.insert(er(f)),h.insert(er(f.next)))}}f=s;var y=[];do{y.push(f.p),f=f.next}while(f!==s);return y.push(f.p),y}function Yn(t,e,n,r,i,s,o){for(var a=new Nn([],Zn),l=t.data;l;){for(var h=0;h<l.children.length;h++){var c=l.children[h],u=l.leaf?ir(c,n,r):Kn(n,r,c);u>s||a.push({node:c,dist:u})}for(;a.length&&!a.peek().node.children;){var f=a.pop(),d=f.node,p=ir(d,e,n),A=ir(d,r,i);if(f.dist<p&&f.dist<A&&$n(n,d,o)&&$n(r,d,o))return d}(l=a.pop())&&(l=l.node)}return null}function Zn(t,e){return t.dist-e.dist}function Kn(t,e,n){if(Jn(t,n)||Jn(e,n))return 0;var r=sr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.maxX,n.minY);if(0===r)return 0;var i=sr(t[0],t[1],e[0],e[1],n.minX,n.minY,n.minX,n.maxY);if(0===i)return 0;var s=sr(t[0],t[1],e[0],e[1],n.maxX,n.minY,n.maxX,n.maxY);if(0===s)return 0;var o=sr(t[0],t[1],e[0],e[1],n.minX,n.maxY,n.maxX,n.maxY);return 0===o?0:Math.min(r,i,s,o)}function Jn(t,e){return t[0]>=e.minX&&t[0]<=e.maxX&&t[1]>=e.minY&&t[1]<=e.maxY}function $n(t,e,n){for(var r,i,s,o,a=Math.min(t[0],e[0]),l=Math.min(t[1],e[1]),h=Math.max(t[0],e[0]),c=Math.max(t[1],e[1]),u=n.search({minX:a,minY:l,maxX:h,maxY:c}),f=0;f<u.length;f++)if(r=u[f].p,i=u[f].next.p,s=t,r!==(o=e)&&i!==s&&tr(r,i,s)>0!=tr(r,i,o)>0&&tr(s,o,r)>0!=tr(s,o,i)>0)return!1;return!0}function tr(t,e,n){return Xn(t[0],t[1],e[0],e[1],n[0],n[1])}function er(t){var e=t.p,n=t.next.p;return t.minX=Math.min(e[0],n[0]),t.minY=Math.min(e[1],n[1]),t.maxX=Math.max(e[0],n[0]),t.maxY=Math.max(e[1],n[1]),t}function nr(t,e){var n={p:t,prev:null,next:null,minX:0,minY:0,maxX:0,maxY:0};return e?(n.next=e.next,n.prev=e,e.next.prev=n,e.next=n):(n.prev=n,n.next=n),n}function rr(t,e){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function ir(t,e,n){var r=e[0],i=e[1],s=n[0]-r,o=n[1]-i;if(0!==s||0!==o){var a=((t[0]-r)*s+(t[1]-i)*o)/(s*s+o*o);a>1?(r=n[0],i=n[1]):a>0&&(r+=s*a,i+=o*a)}return(s=t[0]-r)*s+(o=t[1]-i)*o}function sr(t,e,n,r,i,s,o,a){var l,h,c,u,f=n-t,d=r-e,p=o-i,A=a-s,g=t-i,m=e-s,y=f*f+d*d,v=f*p+d*A,x=p*p+A*A,b=f*g+d*m,w=p*g+A*m,_=y*x-v*v,M=_,T=_;0===_?(h=0,M=1,u=w,T=x):(u=y*w-v*b,(h=v*w-x*b)<0?(h=0,u=w,T=x):h>M&&(h=M,u=w+v,T=x)),u<0?(u=0,-b<0?h=0:-b>y?h=M:(h=-b,M=y)):u>T&&(u=T,-b+v<0?h=0:-b+v>y?h=M:(h=-b+v,M=y));var S=(1-(c=0===u?0:u/T))*i+c*o-((1-(l=0===h?0:h/M))*t+l*n),I=(1-c)*s+c*a-((1-l)*e+l*r);return S*S+I*I}function or(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}class ar{constructor(t,e){this.x=t,this.y=e}clone(){return new ar(this.x,this.y)}normalize(){const t=this.length();this.x/=t,this.y/=t}negate(){this.x=-this.x,this.y=-this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}diff(t){return new ar(this.x-t.x,this.y-t.y)}distance(t){const e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)}dot(t){return this.x*t.x+this.y*t.y}equals(t){return this.x===t.x&&this.y===t.y}orthogonal(){return new ar(this.y,-this.x)}}function lr(t,e,n,r){const i=e.x*r.y-e.y*r.x,s=n.x-t.x,o=n.y-t.y,a=(s*r.y-o*r.x)/i;return new ar(t.x+a*e.x,t.y+a*e.y)}const hr=[],cr=[];function ur(t){if(vt(t[0]&&t[0].x)){const e=[];let n=0;for(let r=0;r<t.length;r++)cr[n]?(cr[n][0]=t[r].x,cr[n][1]=t[r].y):cr[n]=[t[r].x,t[r].y],e.push(cr[n]),n++;t=e}try{const e=Qn(t,1/0);let n=[1/0,1/0],r=[-1/0,-1/0];for(let t=0;t<e.length;t++)e[t][0]<n[0]&&(n[0]=e[t][0]),e[t][0]>r[0]&&(r[0]=e[t][0]),e[t][1]<n[1]&&(n[1]=e[t][1]),e[t][1]>r[1]&&(r[1]=e[t][1]);const i=[];let s=[],a=0;for(let t=0;t<e.length;t++)t===e.length-1&&e[t][0]===e[0][0]&&e[t][1]===e[0][1]||(wn(i,e[t],"EPSG:3857"),hr[a]?(hr[a].x=i[0],hr[a].y=i[1]):hr[a]=new ar(i[0],i[1]),s.push(hr[a]),a++);o["i"].calculateSignedArea(s)<0&&(s=s.reverse());const l=function(t){let e,n=Number.MAX_VALUE;const r=function(t,r,i,s,o,a,l,h){var c=lr(t,r,o,a),u=lr(i,s,o,a),f=lr(l,h,t,r),d=lr(l,h,i,s),p=c.distance(u)*c.distance(f);0!==p&&p<n&&(e=[c,f,d,u],n=p)};var i=[];for(let m=0;m<t.length;m++)i.push(t[(m+1)%t.length].diff(t[m])),i[m].normalize();var s,o,a,l,h=new ar(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),c=new ar(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let m=0;m<t.length;m++){var u=t[m];u.x<h.x&&(h.x=u.x,s=m),u.x>c.x&&(c.x=u.x,o=m),u.y<h.y&&(h.y=u.y,l=m),u.y>c.y&&(c.y=u.y,a=m)}var f=new ar(0,-1),d=new ar(0,1),p=new ar(-1,0),A=new ar(1,0);for(let m=0;m<t.length;m++){var g=[Math.acos(f.dot(i[s])),Math.acos(d.dot(i[o])),Math.acos(p.dot(i[a])),Math.acos(A.dot(i[l]))];switch(g.indexOf(Math.min.apply(Math,g))){case 0:(d=(f=i[s].clone()).clone()).negate(),(A=(p=f.orthogonal()).clone()).negate(),s=(s+1)%t.length;break;case 1:(f=(d=i[o].clone()).clone()).negate(),(A=(p=f.orthogonal()).clone()).negate(),o=(o+1)%t.length;break;case 2:(A=(p=i[a].clone()).clone()).negate(),(d=(f=A.orthogonal()).clone()).negate(),a=(a+1)%t.length;break;case 3:(p=(A=i[l].clone()).clone()).negate(),(d=(f=A.orthogonal()).clone()).negate(),l=(l+1)%t.length}r(t[s],f,t[o],d,t[a],p,t[l],A)}return e}(s);if(!l||4!==l.length)return null;const h=l[0].distance(l[1]),c=l[1].distance(l[2]),u=l.map(t=>[t.x,t.y]);return u.push(+(c>h)),u}catch(t){return null}}class fr extends He{static fromJSON(t){return un(t,"ExtrudePolygonLayer",fr)}getPolygonOffsetCount(){return 0}getPolygonOffset(){return 0}onConfig(t){const e=this.getRenderer();return e&&e.onConfig(t),super.onConfig(t)}updateMaterial(t){this.options.material||(this.options.material={}),t?mt(this.options.material,t):this.options.material=null;const e=this.getRenderer();return e&&e.updateMaterial(t),this}updateSideMaterial(t){let e=!1;this.options.sideMaterial||(this.options.sideMaterial={},e=!0),t?mt(this.options.sideMaterial,t):this.options.sideMaterial=null;const n=this.getRenderer();return n&&(e&&n.ri(),n.updateSideMaterial(t)),this}updateDataConfig(t){if(!t)return this;this.options.dataConfig||(this.options.dataConfig={});const e=JSON.parse(JSON.stringify(this.options.dataConfig));mt(this.options.dataConfig,t);const n=this.getRenderer();return n&&n.updateDataConfig(t,e),this}}fr.registerJSONType("ExtrudePolygonLayer"),fr.mergeOptions({cullFace:!1,castShadow:!0});const dr={polygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_polygonFill"},polygonOpacity:{type:"identity",default:1,property:"_symbol_polygonOpacity"},topPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_topPolygonFill"},bottomPolygonFill:{type:"identity",default:[1,1,1,1],property:"_symbol_bottomPolygonFill"}},pr={defaultAltitude:20},Ar=t=>1===t.properties.top;fr.registerRenderer("gl",class extends mn{constructor(...t){super(...t),this.GeometryTypes=[i["C"],i["x"]]}ei(t){return[t]}onConfig(t){this.painter&&(wt(t.cullFace)||this.painter.updateSceneConfig({cullFace:t.cullFace}))}updateMaterial(t){this.painter&&(this.painter.si(t),this.layer.options.sideMaterial||this.sidePainter.si(t),this.setToRedraw())}ri(){this.sidePainter&&this.sidePainter.deleteMaterial()}updateSideMaterial(t){this.sidePainter&&(t?this.sidePainter.si(t):(this.sidePainter.deleteMaterial(),this.sidePainter.si(this.layer.options.material)),this.setToRedraw())}updateDataConfig(t,e){this.painter&&(this.painter.updateDataConfig(t,e),this.Dn())}updateBloom(t){super.updateBloom(t),this.sidePainter&&this.Kn(this.sidePainter,this.sidePainterSymbol,t)}needCheckPointLineSymbols(){return!1}draw(t,e){return super.draw(t,e)}createPainter(){const t=He.get3DPainterClass("lit");this.painterSymbol=mt({},dr),this.sidePainterSymbol=mt({},dr),this.Jn(this.painterSymbol,t.getBloomSymbol());const e=mt({},pr,this.layer.options.dataConfig||{});this.layer.options.material&&(this.painterSymbol.material=this.layer.options.material),this.layer.options.sideMaterial?this.sidePainterSymbol.material=this.layer.options.sideMaterial:this.sidePainterSymbol.material=this.layer.options.material;const n={cullFace:this.layer.options.cullFace};Object.defineProperty(n,"castShadow",{enumerable:!0,get:()=>this.layer.options.castShadow});const r=mt({},e);r.upsideUpTexture=!0;const i=new t(this.regl,this.layer,this.painterSymbol,n,0,r);return this.sidePainter=new t(this.regl,this.layer,this.sidePainterSymbol,n,0,e),i}xt(...t){super.xt(...t);const e=this.painter;this.painter=this.sidePainter,super.xt(...t),this.painter=e}mn(...t){const e=t[0],n=e.sceneFilter;e.sceneFilter=t=>(!n||n(t))&&Ar(t);const r=super.mn(...t);e.sceneFilter=t=>(!n||n(t))&&Ar(t);const i=this.painter;this.painter=this.sidePainter;const s=e.sceneFilter=t=>(!n||n(t))&&(t=>1===t.properties.side)(t);return super.mn(...t),this.painter=i,e.sceneFilter=n,{redraw:r.redraw||s.redraw,drawCount:(r.drawCount||0)+(s.drawCount||0)}}createMesh(t,e,n,r,i,s){const o=[];this.oi=s;const a=this.ai(r,n,!0,!1),l=this.ai(r,n,!1,!0);if(a){const i=this.bn(a,t,e,n,r,null,s);i.meshes[0].properties.top=1,o.push(i)}if(l){const i=this.bn(l,t,e,n,r,null,s);i.meshes[0].properties.side=1,o.push(i)}return o}ai(t,e,n,r){const s=this.getMap();e=dr;const a=this.oi,l=s.getZoom(),h=new i["A"](0,0),c=new i["f"](0,0),u=mt({},pr,this.layer.options.dataConfig);if(u.tangent=1,u.top&&(u.top=n),u.side&&(u.side=r),!1===u.top&&!1===u.side)return null;if(!t.length)return null;const f=s.getGLRes(),d=s.getProjection().code,p=n?this.painterSymbol&&this.painterSymbol.material:this.sidePainterSymbol&&this.sidePainterSymbol.material,A=p&&p.textureWidth||o["b"],g=[ae(s,1,c,f)/100,ae(s,1,c,f,1)/100];return Pn(t,u,1/0,h,A,s.getGLRes(),1,1,g,this.yt,e,l,d,void 0,Float32Array,a)}updateMesh(t){const e=t[qe];let n=this.features[e];if(!n)return;const r=this.ai([n],this.painterSymbol,!0,!1);let i=0;r&&r.data&&this.zn(this.meshes[i++],n.id,r);const s=this.ai([n],this.painterSymbol,!1,!0);s&&s.data&&this.zn(this.meshes[i++],n.id,s)}En(t){if(t.getProperties()||t.setProperties({}),!t.getProperties().maptalks_ombb){const e=t.getCoordinates();if(t instanceof i["x"]){const n=[];for(let t=0;t<e.length;t++){const r=e[t]&&e[t][0];n[t]=ur(r)}t.getProperties().maptalks_ombb=n}else{const n=ur(e[0]);t.getProperties().maptalks_ombb=n}}return super.En(t)}resizeCanvas(t){super.resizeCanvas(t),this.sidePainter&&this.sidePainter.resize(this.canvas.width,this.canvas.height)}onRemove(){super.onRemove(),this.sidePainter&&(this.sidePainter.delete(),delete this.sidePainter)}drawOutline(t){if(super.drawOutline(t),this.Mt&&this.sidePainter&&this.sidePainter.outlineAll(t),this.Qn)for(let e=0;e<this.Qn.length;e++)this.sidePainter&&this.sidePainter.outline(t,this.Qn[e])}getShadowMeshes(){return this.painter?this.painter.getShadowMeshes():[]}}),fr.registerRenderer("canvas",null);const gr={redraw:!1,retire:!1},mr=[];let yr=1;function vr(t,e){return ft.extend(t,{init:function(){this.li={}},isVisible(){return this.painter&&this.painter.isVisible()},supportRenderMode:function(t){return this.painter.supportRenderMode(t)},hasMesh(){return this.painter&&this.painter.hasMesh()},startFrame:function(t){const n=t.layer,r=t.regl,i=t.sceneConfig,s=t.dataConfig,o=t.symbol;let a=this.painter;if(!a){const l=t.pluginIndex;a=this.painter=new e(r,n,o,i,l,s)}this.li||(this.li={});const l=i.excludes;this.hi?l!==this.hi&&(this.ui=l?Object(ot["b"])(l):null,this.hi=l):l&&(this.hi=l),a.startFrame(t),this.ci={}},updateCollision:function(t){const e=this.painter;return e&&e.isVisible()?e.updateCollision(t):null},prepareRender:function(t){const e=this.painter;return e&&e.isVisible()?e.prepareRender(t):null},endFrame:function(t){const e=this.painter;return e&&e.isVisible()?e.render(t):null},getShadowMeshes(){const t=this.painter;return t&&t.getShadowMeshes&&t.getShadowMeshes()||mr},createTile:function(t){const{tileCache:e,tileData:n}=t;let r=!1;const i=this.painter;if(!i)return{retire:r};const s=this.fi(t);let o=e.geometry;if(!o){const s=n.features,a=n.data;if(!a||!a.length)return{retire:r};const l=a;if(this.painter.colorSymbol&&!function(t){if(!t)return!0;for(const e in t)return!1;return!0}(s))for(let t=0;t<a.length;t++){const e=this.di(s,a[t].data.aPickingId,a[t].indices,a[t].data.aPosition,a[t].positionSize);a[t].data.aColor=e}o=e.geometry=i.createGeometries(l,s);for(let e=0;e<o.length;e++)o[e]&&o[e].geometry&&(r=!0,o[e].geometry.properties.features=s,this.An(o[e].geometry,t))}let a=this.H(s);if(!a){const{meshes:e,retire:n}=this.pi(o,t);r||(r=n),a=e}return{retire:r}},pi(t,e){const{layer:n,tileInfo:r,tileExtent:i,tileTransform:s,tileTranslationMatrix:o,tileVectorTransform:a,tileZoom:l,sceneConfig:h}=e;let c=!1;const u=this.painter,f=[r.extent2d.xmin,r.extent2d.ymax],d=u.createMeshes(t,s,{tileExtent:i,tilePoint:f,tileZoom:l,tileTranslationMatrix:o,tileVectorTransform:a},e);if(d.length){const t=n.getRenderer().isEnableTileStencil();for(let n=0;n<d.length;n++)d[n]&&(c=!0,this.mi(d[n],s,e.timestamp,yr++,t));h.animation&&(d.yi=e.timestamp);const r=this.fi(e);this.li[r]=d}return{meshes:d,retire:c}},paintTile:function(t){const{tileCache:e,tileInfo:n,tileZoom:r,sceneConfig:i}=t,s=this.painter;if(!s)return gr;let o=e.geometry;if(!o)return gr;let a=!1;const l=this.fi(t);let h=this.H(l);if(!h){const{meshes:e,retire:n}=this.pi(o,t);a||(a=n),h=e}if(!h.length)return gr;const c=s.getTileLevelValue(n,r);h.forEach(t=>{t.properties.tile=n,t.properties.level=c});let u=!1;if(!this.ci[l]){let e=null,n=i.animation;if(n){const r=t.sceneConfig.animationDuration||800,i=(t.timestamp-h.yi)/r,s=h[0].properties.createTime;h.yi-s<r&&i<1&&(!0!==n&&1!==n||(n="linear"),e="linear"===n?i:C(n,i),u=!0)}s.addMesh(h,e,t),this.ci[l]=1}return{redraw:u,retire:a}},mi:function(t,e,n,r,i){if(t.properties.tileTransform=e,t.properties.createTime=n,t.properties.meshKey=r,t.needUpdateShadow=!0,i){const e=t.defines||{};e.ENABLE_TILE_STENCIL=1,t.setDefines(e),"stencilRef"in t.uniforms||Object.defineProperty(t.uniforms,"stencilRef",{enumerable:!0,get:function(){return t.properties.tile&&void 0!==t.properties.tile.stencilRef?t.properties.tile.stencilRef:t.properties.level}})}},An:function(t,e){const{layer:n,tileInfo:r}=e,i=n.getMap(),s=(n.getSpatialReference?n.getSpatialReference():i.getSpatialReference()).getResolution(r.z),o=e.tileExtent/n.getTileSize().width;t.properties.tileResolution=s,t.properties.tileRatio=o,t.properties.z=r.z,t.properties.tileExtent=e.tileExtent},updateSceneConfig:function(t){const e=this.painter;e&&e.updateSceneConfig(t.sceneConfig)},updateDataConfig:function(t,e){const n=this.painter;return!n||n.updateDataConfig(t,e)},updateSymbol:function(t,e){const n=this.painter;if(!n)return!1;if(n.shouldDeleteMeshOnUpdateSymbol(t)){if(this.li)for(const t in this.li)n.deleteMesh(this.li[t],!0);delete this.li,delete this.ci}return n.updateSymbol(t,e)},pick:function(t,e,n){return this.painter&&this.painter.pick?this.painter.pick(t,e,n):null},deleteTile:function(t){if(!this.li)return;const e=this.fi(t),n=this.li[e];n&&this.painter&&this.painter.deleteMesh(n),delete this.li[e],this.ci&&delete this.ci[e]},remove:function(){const t=this.painter;if(t&&this.li){for(const e in this.li)t.deleteMesh(this.li[e]);t.delete(),delete this.painter}delete this.li,delete this.ci},resize:function(t,e){const n=this.painter;n&&n.resize(t,e)},needToRedraw:function(){return!!this.painter&&this.painter.needToRedraw()},needToRetireFrames:function(){return!!this.painter&&this.painter.needToRetireFrames()},isAnimating(){return!!this.painter&&this.painter.isAnimating()},needToRefreshTerrainTileOnZooming:function(){return!!this.painter&&this.painter.needToRefreshTerrainTileOnZooming()},isTerrainSkin:function(){return!!this.painter&&this.painter.isTerrainSkin()},isTerrainVector:function(){return!!this.painter&&this.painter.isTerrainVector()},di:function(t,e,n,r,i=3){if(!r||!t||!e.length)return null;const s=new Uint8Array(r.length/i*4);let o,a;const h=this.painter.colorSymbol,c={};let u;for(let f=0,d=e.length;f<d;f++){const n=e[f];if(o=t[n].symbol,a=c[n],!a)if(h){let e;e="function"==typeof h?h(t[n].feature&&t[n].feature.properties):h,e=l()(e),a=c[n]=e.array()}else a=c[n]=[255,255,255];u=4*f,s[u]=a[0],s[u+1]=a[1],s[u+2]=a[2],s[u+3]=255*(o[this.painter.opacitySymbol]||1)}return s},fi:function(t){const e=t.tileInfo;return e.meshKey||(e.meshKey=yr++),e.meshKey},H:function(t){return this.li[t]},gi(t,e){if(Array.isArray(t))t.forEach((t,n)=>{const{features:r}=t.properties;this.vi(t,e[n],r)});else{const{features:n}=t.properties;this.vi(t,Array.isArray(e)?e[0]:e,n)}},vi(t,e,n){const r=e.featureIndexes||e.data.featureIndexes;if(r)if(this.ui){const i=e.indices;let s=null,o=!1;const a=[];for(let t=0;t<i.length;t++){const e=n[r[i[t]]];null!==s&&s===i[t]||(o=this.ui(e.feature),s=i[t]),o||a.push(i[t])}t.setElements(new e.indices.constructor(a))}else t.setElements(e.indices)},outline(t,e){const n=this.painter;n&&n.outline(t,e)},outlineAll(t){const e=this.painter;e&&e.outlineAll(t)},needPolygonOffset(){const t=this.painter;return t&&t.needPolygonOffset()},highlight(t){const e=this.painter,n=this.style.name,r=this.renderIndex;if(t){const e=[];if(t.forEach((t,i)=>{void 0!==t.plugin&&null!==t.plugin&&(Array.isArray(t.plugin)?t.plugin.length&&t.plugin.indexOf(n)<0&&t.plugin.indexOf(r)<0&&e.push(i):t.plugin!==n&&t.plugin!==r&&e.push(i))}),e.length){const n=new Map(t);for(let t=0;t<e.length;t++)n.delete(e[t]);t=n}}return e&&e.highlight(t)},cancelAllHighlight(){const t=this.painter;return t&&t.cancelAllHighlight()}})}class xr{constructor(){this.xi=1}write(t,e){const n=t.gl,r=this.xi++;return t.stencilFunc(n.ALWAYS,r,255),t.draw(e),r}start(t){const e=t.gl;e.clearStencil(255),e.clear(e.STENCIL_BUFFER_BIT),this.xi=1,t.start()}end(t){t.end()}}function br(t){return!t||(void 0!==t.empty||(t.empty=function(t){for(const e in t)return!1;return!0}(t)),t.empty)}const wr="_fn_type_";function _r(t,e,n){if(!br(t.properties.features))for(let r=0;r<n.length;r++){const{symbolName:i}=n[r];(t.bi=t.bi||{})[i]=e[i],Mr(t,e,n[r])}}function Mr(t,e,n){const r=function(t){const e=t.properties;let n=e.aPickingId;return n||(n=e.aPickingId=new t.data.aPickingId.constructor(t.data.aPickingId)),n}(t),{attrName:i,symbolName:s,related:o}=n;let a=t.data[i];return a?Nr(e[s])||function(t,e){if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(Nr(e[t[n]]))return!0;return!1}(o,e)?(Nr(e[s])&&Tr(t,e,n),a):(t.deleteData(i),Sr(t,i),null):Nr(e[s])?(a=t.data[i]=new n.type(n.width*r.length),function(t,e,n,r){const{attrName:i}=r,s=(wr+i+"Index").trim();Tr(e,n,r);const o=e.properties[s];Pr(e,o,r)}(0,t,e,n),a):null}function Tr(t,e,n){const{attrName:r,symbolName:i}=n,a=t.properties,l=(wr+r+"Index").trim(),h=(wr+r).trim();if(a[l]&&a[h])return;const c=function(t){if(!t)return Er;const e=[];for(let n=0;n<t.length;n++)Object(s["c"])(t[n][1])&&!Object(s["b"])(t[n][1]).isZoomConstant&&e.push(t[n][0]);return e}(e[i].stops),u="identity"===e[i].type&&o["n"].checkIfIdentityZoomDependent(i,e[i].property,a.features);if(!u&&!c.length)return void Sr(t,r);const{features:f,aPickingId:d}=a,p=function(t,e,n,r,i){const s=[];let o=0,a=e[0];for(let l=1,h=e.length;l<h;l++)e[l]===a&&l!==h-1||((i||Or(t[a].feature,n,r))&&s.push(o,l===h-1?h:l),a=e[l],o=l);return s}(f,d,e[i].property,c,u);if(!p.length)return void Sr(t,r);const A=t.data[r];a[l]=p,a[h]=A.BYTES_PER_ELEMENT?new A.constructor(A):new n.type(A.length)}function Sr(t,e){const n=t.properties,r=(wr+e+"Index").trim(),i=(wr+e).trim();delete n[r],delete n[i]}function Ir(t,e,n,r,i){if(!r)return;const s=r.geometry;if(!s)return;if(br(s.properties.features))return;const o=r.geometry.properties.layer;for(let a=0;a<n.length;a++){const l=n[a],h=l.attrName;if(!(Cr(s,e,l)||o.fe&&o.fe(r.geometry.Ai))){const{aPickingId:t}=s.properties;if(!t||s.wi===i)continue;const e=(wr+h+"Index").trim(),n=s.properties[e];if(!n)continue;Pr(s,n,l);continue}const c=Mr(s,e,l),u=l.define;if(c){const e=(wr+h+"Index").trim();if(Pr(s,s.properties[e],l),o.ce&&(s.Ai=o.ce()),u){const t=r.defines;t[u]=1,r.setDefines(t)}s.generateBuffers(t)}else if(u){const t=r.defines;t[u]&&(delete t[u],r.setDefines(t))}}s.wi=i}function Cr(t,e,n){const r=e[n.symbolName],i=t.bi;return!c()(r,i[n.symbolName])&&(i[n.symbolName]=r,!0)}function Or(t,e,n){for(let r=0;r<n.length;r++)if("$"===e[0]&&t[e.substring(1)]===n[r]||t.properties[e]===n[r])return!0;return!1}const Er=[];function Pr(t,e,n){const{attrName:r,evaluate:i}=n,{aPickingId:s,features:o}=t.properties;let a;if(e){const n=(wr+r).trim();a=t.properties[n];const l=a.length/s.length,h=e.length;for(let r=0;r<h;r+=2){const n=e[r],h=e[r+1];let c=o[s[n]];c&&c.feature&&Rr(a,c,i,n,h,l,t)}}else{if(a=t.data[r],function(t){return Array.isArray(t)||t.constructor===Float32Array||t.constructor===Float64Array||t.constructor===Uint8Array||t.constructor===Int8Array||t.constructor===Uint16Array||t.constructor===Int16Array||t.constructor===Uint32Array||t.constructor===Int32Array||t.constructor===Uint8ClampedArray}(a))a.dirty=!0;else{const e=(wr+r).trim();a=t.properties[e],a||(a=t.properties[e]=new n.type(n.width*s.length),a.dirty=!0)}const e=a.length/s.length,l=s.length;let h=0;for(let n=0;n<l;n++){if(s[n]===s[h]&&n<l-1)continue;let r=o[s[h]];r&&r.feature&&(Rr(a,r,i,h,n===l-1?l:n,e,t),h=n)}}a.dirty&&(t.updateData(r,a),a.dirty=!1)}const kr={};function Rr(t,e,n,r,i,s,o){const a=(e=e.feature).properties||{};void 0===a.$layer&&(e.properties||(e.properties=a),a.$layer=e.layer,a.$type=e.type);const l=o.properties.layer;if(l.getFeatureState&&(kr.layer=e.layer,kr.id=e.id,e[Ut]&&(e[Ut]=null),!Qt(e.id))){const t=l.getFeatureState(kr);e.properties[Ut]=t}const h=n(a,o,t,r*s);if(Array.isArray(h)){let e=!1;for(let n=0;n<s;n++)if(t[r*s+n]!==h[n]){e=!0;break}if(e){for(let e=r*s;e<i*s;e+=s)t.set(h,e);t.dirty=!0}}else t[r]!==h&&(ee(t,h,r,i),t.dirty=!0)}function Nr(t){return o["n"].isFnTypeSymbol(t)}var Dr=Fr;function Fr(t,e){this.x=t,this.y=e}Fr.prototype={clone:function(){return new Fr(this.x,this.y)},add:function(t){return this.clone()._i(t)},sub:function(t){return this.clone().Si(t)},multByPoint:function(t){return this.clone().Mi(t)},divByPoint:function(t){return this.clone().Pi(t)},mult:function(t){return this.clone().Ti(t)},div:function(t){return this.clone().ki(t)},rotate:function(t){return this.clone().Oi(t)},rotateAround:function(t,e){return this.clone().Ii(t,e)},matMult:function(t){return this.clone().Fi(t)},unit:function(){return this.clone().Ci()},perp:function(){return this.clone().Ei()},round:function(){return this.clone().Di()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},Fi:function(t){var e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},_i:function(t){return this.x+=t.x,this.y+=t.y,this},Si:function(t){return this.x-=t.x,this.y-=t.y,this},Ti:function(t){return this.x*=t,this.y*=t,this},ki:function(t){return this.x/=t,this.y/=t,this},Mi:function(t){return this.x*=t.x,this.y*=t.y,this},Pi:function(t){return this.x/=t.x,this.y/=t.y,this},Ci:function(){return this.ki(this.mag()),this},Ei:function(){var t=this.y;return this.y=this.x,this.x=-t,this},Oi:function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},Ii:function(t,e){var n=Math.cos(t),r=Math.sin(t),i=e.x+n*(this.x-e.x)-r*(this.y-e.y),s=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=i,this.y=s,this},Di:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},Fr.convert=function(t){return t instanceof Fr?t:Array.isArray(t)?new Fr(t[0],t[1]):t};const Lr=[];function zr(t,e,n,i,s){return r["q"].set(Lr,e[0],e[1],e[2],1),r["q"].transformMat4(Lr,Lr,n),t[2]=Lr[3],r["q"].scale(Lr,Lr,1/Lr[3]),t[0]=(Lr[0]+1)*i/2,t[1]=(1-Lr[1])*s/2,t}const Br=[],Hr=[],Ur=[],jr=[-99999,-99999],Vr=new i["A"](0,0),Gr=[];function qr(t,e,n,i,s,o,a,l){const{res:h,extent:c,extent2d:u}=n.properties.tile,{xmin:f,ymax:d}=u,p=f+i.x*s,A=d-i.y*s;let g=null;if(l)for(let r=0;r<l.length;r++)if(Wr(l[r],p,A,h)){g=l[r];break}if(!g)return jr;const m=Vr.set(f,d),y=o.queryTilePointTerrain(i,g,m,c,h),v=null===y[0]?Lt:y[0];if(v){let n=r["p"].set(Gr,i.x,i.y,0);return n[2]+=100*v,n=zr(t,n,a,e.width,e.height),n}return t[0]=i.x,t[1]=i.y,t}function Wr(t,e,n,r){const i=Vr.set(e,n)._multi(r/t.res);return t.extent2d.contains(i)}const{loginIBLResOnCanvas:Xr,logoutIBLResOnCanvas:Qr,getIBLResOnCanvas:Yr}=r["m"].pbr.PBRUtils,Zr=[],Kr=[],Jr=new i["A"](0,0),$r=new i["A"](0,0),ti=new Float32Array(1),ei=[],ni=t=>0===t.properties.level,ri=t=>t.properties.level>0;class ii{static getBloomSymbol(){return["bloom"]}constructor(t,e,n,i,s,o){this.Ni=!0,this.regl=t,this.layer=e,this.canvas=t._gl.canvas,this.sceneConfig=i||{},this.dataConfig=o||{},this.pluginIndex=s,this.scene=new r["m"].Scene,this.pickingFBO=e.getRenderer().pickingFBO,this.Li=new xr,this.level0Filter=ni,this.levelNFilter=ri,this.loginTextureCache(),this.symbolDef=Array.isArray(n)?n.map(t=>Yt(t)):[Yt(n)],this.Ri(),this.pickingViewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.sortByCommandKey=si.bind(this),this.colorCache={},this.Hi=this.symbolDef.map(t=>!(!t||!1!==t.visible))}hasMesh(){const t=this.scene&&this.scene.getMeshes();return this.isVisible()&&t&&!!t.length}getMap(){return this.layer?this.layer.getMap():null}getTileLevelValue(t,e){const n=this.layer.getRenderer();return n.getTileLevelValue&&n.getTileLevelValue(t,e)||0}getAnalysisMeshes(){return this.getShadowMeshes?this.getShadowMeshes():ei}isVisible(){const{minZoom:t,maxZoom:e}=this.sceneConfig,n=this.getMap().getZoom();if(!Qt(t)&&n<t)return!1;if(!Qt(e)&&n>e)return!1;const r=this.zi;if(r.length)for(let s=0;s<r.length;s++)if(r[s]&&!r[s].isFeatureConstant)return!0;const i=this.getSymbols();for(let s=0;s<i.length;s++){const t=i[s].visible;if(!1!==t&&0!==t)return!0}return!1}isMeshVisible(t){const e=t&&t.properties&&t.properties.symbolIndex;if(!e)return!1;const n=this.zi,r=e.index;let i;if(n[r]){if(!n[r].isFeatureConstant)return!0;i=n[r](this.getMap().getZoom())}else i=this.getSymbol(e).visible;return!1!==i&&0!==i}isAnimating(){return!1}needToRedraw(){return this.isAnimating()||this.Vi}needToRetireFrames(){return this.J}needToRefreshTerrainTileOnZooming(){return!0}isTerrainSkin(){return this.layer.options.awareOfTerrain}isTerrainVector(){return!1}isShadowIncludeChanged(t){const e=t&&t.isRenderingTerrain&&this.isTerrainSkin();return t&&t.states&&t.states.includesChanged.shadow||e&&this.Ui}fillIncludes(t,e,n){if(delete this.Ui,n&&n.isRenderingTerrain&&this.isTerrainSkin())return;const r=n&&n.includes;if(r){let i="";for(const s in r)r[s]&&(i+=s,n[s].uniformDeclares&&e.push(...n[s].uniformDeclares),n[s].defines&&qt(t,n[s].defines));this.Ui=i}}setIncludeUniformValues(t,e){if(e&&e.isRenderingTerrain&&this.isTerrainSkin())return;const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&qt(t,e[r].renderUniforms)}createGeometries(t,e){if(!t.length)return ei;const n=[];for(let r=0;r<t.length;r++)if(t[r])if(void 0!==t[r].ref)n[t[r].ref]?n.push({geometry:n[t[r].ref].geometry,symbolIndex:t[r].symbolIndex,ref:t[r].ref}):n.push(null);else{t[r]&&!t[r].is2D&&(this.Ni=!1);const i=this.createGeometry(t[r],e,r);if(i&&i.geometry){const s=i.geometry.properties,{pickingIdMap:o,idPickingMap:a,hasFeaIds:l}=this.ji(t[r]);l&&(s.feaIdPickingMap=o,s.feaPickingIdMap=a),s.symbolIndex=i.symbolIndex,s.features=e,s.is2D=t[r].is2D,s.layer=this.layer,s.positionBounding=t[r].positionBounding,this.postCreateGeometry(i,n)}n.push(i)}return n}isOnly2D(){return this.Ni}postCreateGeometry(){}ji(t){if(!t)return{};if(Array.isArray(t)&&!(t=t[0]))return{};const e=t.featureIds,n={},r={},i=e&&e.length;if(i)for(let s=0;s<e.length;s++){const i=t.data.aPickingId[s];void 0===n[i]&&(n[i]=e[s],r[e[s]]||(r[e[s]]=[]),r[e[s]].push(t.data.aPickingId[s]))}return{hasFeaIds:i,idPickingMap:n,pickingIdMap:r}}createGeometry(){throw new Error("not implemented")}createMeshes(t,e,n,r){const i=this.layer.options.awareOfTerrain,s=[];for(let o=0;o<t.length;o++){if(!t[o])continue;if(i&&r&&r.isRenderingTerrain&&this.isTerrainVector()){const e=t[o],n=e&&e.geometry;this.Bi(n,n.data,n.properties,n.positionSize||n.desc.positionSize,r)}let a=this.createMesh(t[o],e,n,r||{});Array.isArray(a)?(a=a.filter(t=>!!t),s.push(...a)):a&&s.push(a)}return s}createMesh(){throw new Error("not implemented")}getAltitudeOffsetMatrix(){const t=100*(this.dataConfig.altitudeOffset||0),e=r["k"].identity([]);return r["p"].set(Kr,0,0,t),r["k"].translate(e,e,Kr),e}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).bloom}forbiddenTerrainUpscale(){return!0}addMesh(t,e,n){if(n.isRenderingTerrain&&this.isTerrainSkin()&&this.forbiddenTerrainUpscale()){const t=this.getMap().getResolution();if(n.tileInfo.res/t>3)return}const r=n.isRenderingTerrain&&this.isTerrainVector(),i=this.getRenderFBO(n);t=t.filter(t=>this.isMeshVisible(t)),r&&(t=t.filter(t=>t.geometry&&t.geometry.data.aTerrainAltitude));const s=void 0===this.sceneConfig.castShadow||!!this.sceneConfig.castShadow,o=!(!n||!n.bloom);t.forEach(t=>{const e=this.isBloom(t)&&o;t.bloom=e,t.castShadow=s;let a=!1;const l=t.defines||{};if(!!l.HAS_BLOOM!==e&&(a=!0,e?l.HAS_BLOOM=1:delete l.HAS_BLOOM),r){if(t.geometry.data.aTerrainAltitude){const e=t.geometry;this.Bi(e,e.data,e.properties,e.desc.positionSize,n)}t.geometry.data.aTerrainAltitude&&!l.HAS_TERRAIN_ALTITUDE&&(l.HAS_TERRAIN_ALTITUDE=1,a=!0)}else l.HAS_TERRAIN_ALTITUDE&&(delete l.HAS_TERRAIN_ALTITUDE,a=!0);a&&t.setDefines(l),i?t.setUniform("targetFramebuffer",i):t.uniforms.targetFramebuffer&&(t.uniforms.targetFramebuffer=null),this.Gi(t)}),this.scene.addMesh(t)}updateCollision(){}render(t){return this.pluginIndex=t.pluginIndex,this.polygonOffsetIndex=t.polygonOffsetIndex,this.paint(t),{redraw:this.Vi,drawCount:this.Wi}}prepareRender(t){if(this.ft===t.timestamp)return;if(!this.createFnTypeConfig)return;const e=this.scene.getMeshes();if(!e||!e.length)return;const n=t&&t.sceneFilter,r=this.getMap().getZoom();for(let i=0;i<e.length;i++){if(!e[i]||!e[i].geometry)continue;if(n&&!n(e[i]))continue;const{symbolIndex:s}=e[i].properties,o=this.getSymbolDef(s);if(!o)continue;this.ft=t.timestamp;const a=this.getFnTypeConfig(s);Ir(this.regl,o,a,e[i],r)}}paint(t){const e=this.layer.getMap();if(!e)return{redraw:!1};this.Xi=t;const n=this.getUniformValues(e,t);return this.callShader(n,t),{redraw:this.Vi}}setToRedraw(t){t&&(this.J=t),this.Vi=!0}callShader(t,e){this.callCurrentTileShader(t,e),this.callBackgroundTileShader(t,e)}callCurrentTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.level0Filter,e.sceneFilter]:this.level0Filter),this.callRenderer(this.shader,t,e)}callBackgroundTileShader(t,e){this.shader&&(this.shader.filter=e&&e.sceneFilter?[this.levelNFilter,e.sceneFilter]:this.levelNFilter),this.scene.getMeshes().sort(oi),this.callRenderer(this.shader,t,e)}callRenderer(t,e,n){const r=this.scene.getMeshes(),i=[];r.forEach(t=>{t.properties.hlBloomMesh&&n&&n.bloom&&i.push(t.properties.hlBloomMesh),i.push(t)}),this.Yi(e),this.scene.setMeshes(i),this.Wi+=this.renderer.render(t,e,this.scene,this.getRenderFBO(n)),this.scene.setMeshes(r)}Yi(t){const e=this.layer.options.altitude||0,n=this.layer.getRenderer();t.layerOpacity=n.ne(),t.minAltitude=e}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}needPolygonOffset(){return!1}getPolygonOffset(){const t=this.layer;return{factor:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0),units:()=>t.getPolygonOffset()+(this.polygonOffsetIndex||0)}}getBlendFunc(){return{src:()=>this.sceneConfig.blendSrc||"one",dst:()=>this.sceneConfig.blendDst||"one minus src alpha"}}pick(t,e,n=3){if(!this.layer.options.picking||!1===this.sceneConfig.picking)return null;if(!this.pickingFBO||!this.picking)return null;const r=this.getMap(),i=this.getUniformValues(r);this.Yi(i);for(let s=0;s<this.picking.length;s++){const o=this.picking[s];o.render(this.scene.getMeshes(),i,!0);let a={};o.getRenderedMeshes().length&&(a=o.pick(t,e,n,i,{viewMatrix:r.viewMatrix,projMatrix:r.projMatrix,returnPoint:this.layer.options.pickingPoint&&!1!==this.sceneConfig.pickingPoint,logDepthBufFC:2/(Math.log(r.cameraFar+1)/Math.LN2)}));const{meshId:l,pickingId:h,point:c}=a,u=(0===l||l)&&o.getMeshAt(l);if(!u||!u.geometry)continue;let f=u.geometry.properties;return f.features||(f=u.properties),c&&c.length&&(c[0]=Math.round(1e5*c[0])/1e5,c[1]=Math.round(1e5*c[1])/1e5,c[2]=Math.round(1e5*c[2])/1e5),{data:this.$i(f&&f.features&&f.features[h]),point:c,coordinate:a.coordinate,plugin:this.pluginIndex}}return null}$i(t){const e=t&&t.feature;if(!e||!e.customProps)return t;const n=qt({},t);return n.feature=qt({},t.feature),delete n.feature.customProps,n.feature.properties=qt({},e.properties,e.properties[Ht],e.properties[Ut]),delete n.feature.properties[Ut],delete n.feature.properties[Ht],delete n.feature.properties.$layer,delete n.feature.properties.$type,n}updateSceneConfig(){}updateDataConfig(t){return qt(this.dataConfig,t),!0}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++){if(!t[n].isValid())continue;const i=t[n].geometry;!e&&i&&i.dispose(),t[n].material&&t[n].material.dispose(),t[n].dispose(),r["d"].deleteHighlightBloomMesh(t[n])}else{if(!t.isValid())return;!e&&t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose(),r["d"].deleteHighlightBloomMesh(t)}}startFrame(t){this.qi||(this.init(t),this.qi=!0),this.ft!==t.timestamp&&(this.Vi=!1,this.J=!1,this.Wi=0),this.scene.clear()}resize(){}delete(){if(this.scene.clear(),this.shader&&this.shader.dispose(),this.picking){for(let t=0;t<this.picking.length;t++)this.picking[t].dispose();delete this.picking}if(this.Ji){for(let t=0;t<this.Ji.length;t++)this.Ji[t].dispose();delete this.Ji}delete this.Zi,this.logoutTextureCache()}updateSymbol(t,e){Array.isArray(t)||(t=[t],e=[e]);let n=!1;for(let r=0;r<t.length;r++)if(t[r]){const i=this.Ki(r,t[r],e[r]);i&&(n=i)}return delete this.Qi,this.setToRedraw(!1),n}tr(t,e){for(const n in e)if(ie(e,n)){if(o["n"].isFnTypeSymbol(e[n])&&!this.layer.options.features&&(!t[n]||t[n].property!==e[n].property))return!0;if(o["m"][n]&&!c()(e[n],t[n]))return!0}return!1}Ki(t,e,n){if(!this.er)return!1;const r=this.tr(this.symbolDef[t]||{},n);if(this.Hi[t]&&!1!==n.visible)return this.Hi[t]=!1,!0;this.symbolDef[t]=Yt(n);const i=this.er[t];for(const s in i)delete i[s];const a=this.getMap(),l=[],h=o["d"].loadSymbolFnTypes(this.symbolDef[t],()=>(l[0]=a.getZoom(),l));for(const s in h){const t=Object.getOwnPropertyDescriptor(h,s);t.get?Object.defineProperty(i,s,{get:t.get,set:t.set,configurable:!0,enumerable:!0}):i[s]=h[s]}return Object(s["c"])(n.visible)&&(this.zi[t]=Object(s["b"])(n.visible)),r}getSymbolDef(t){return this.symbolDef[t.index]}getSymbols(){return this.er}getSymbol(t){const e=t.index;return this.er[e]}Ri(){const t=this.getMap(),e=[],n=()=>(e[0]=t.getZoom(),e);this.er=[],this.zi=[];for(let r=0;r<this.symbolDef.length;r++)this.er[r]=o["d"].loadSymbolFnTypes(qt({},this.symbolDef[r]),n),this.symbolDef[r]&&Object(s["c"])(this.symbolDef[r].visible)&&(this.zi[r]=Object(s["b"])(this.symbolDef[r].visible))}getFnTypeConfig(t){this.Qi||(this.Qi=[]);const e=t.index;if(!this.Qi[e]){const n=this.getSymbolDef(t),r=this.getMap();this.Qi[e]=this.createFnTypeConfig(r,n)}return this.Qi[e]}nr(){delete this.Qi}loginTextureCache(){const t="__gl_textures".trim(),e=this.getMap();e[t]||(e[t]={count:0}),e[t].count++}logoutTextureCache(){const t="__gl_textures".trim(),e=this.getMap(),n=this.ir;if(n)for(const r in n)ie(n,r)&&e[t][r]&&(e[t][r].count--,e[t][r].count<=0&&delete e[t][r]);e[t].count--,e[t].count<=0&&(e[t]={})}getCachedTexture(t){const e="__gl_textures".trim(),n=this.getMap()[e][t];return n?n.data:null}addCachedTexture(t,e){const n="__gl_textures".trim(),r=this.getMap();let i=r[n][t];i?i.data=e:i=r[n][t]={data:e,count:0},this.ir||(this.ir={}),i.data.then||this.ir[t]||(i.count++,this.ir[t]=1)}disposeCachedTexture(t){let e;if(e="string"==typeof t?t:t.url,!this.ir||!this.ir[e])return;const n="__gl_textures".trim();delete this.ir[e];const r=this.getMap();r[n][e]&&(r[n][e].count--,r[n][e].count<=0&&delete r[n][e])}shouldDeleteMeshOnUpdateSymbol(){return!1}needClearStencil(){return!1}supportRenderMode(t){return"taa"===t||"fxaa"===t}rr(t){const e=this.scene.getMeshes();if(!e.length)return;const n=e.map(t=>({transform:t.localTransform,level:t.properties.level,mesh:t})).sort(this.sr),i=this.getMap().projViewMatrix;this.Li.start(t);const s={};for(let o=0;o<n.length;o++){const e=n[o].mesh;let a=s[e.properties.tile.id];void 0===a&&(r["k"].multiply(Zr,i,n[o].transform),a=this.Li.write(t,Zr),s[e.properties.tile.id]=a),e.setUniform("ref",a)}this.Li.end(t),this.regl.or()}sr(t,e){return e.level-t.level}outline(t,e){const n={};for(let r=0;r<e.length;r++)Qt(e[r])||n[e[r]]||(this.ar(t,e[r]),n[e[r]]=1)}ar(t,e){if(!this.picking)return;if(this.lr||(this.lr=new r["m"].Scene),!this.Ji&&(this.hr(),!this.Ji))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const n=this.getUniformValues(this.getMap(),this.Xi);this.Yi(n);const i=this.ur(e);if(i.length)for(let r=0;r<i.length;r++){const s=i[r].geometry.properties.feaIdPickingMap;if(s){const o=s[e];if(o){const e={};this.lr.setMeshes(i[r]);for(let r=0;r<o.length;r++){const i=o[r];if(!e[i]){e[i]=1,n.highlightPickingId=i;for(let e=0;e<this.Ji.length;e++)this.renderer.render(this.Ji[e],n,this.lr,t)}}}}}}ur(t){const e=[],n=this.scene.getMeshes();for(let r=0;r<n.length;r++){const i=n[r],s=i.geometry.properties.feaIdPickingMap;s&&void 0!==s[t]&&e.push(i)}return e}outlineAll(t){if(!this.picking)return;if(!this.Ji&&(this.hr(),!this.Ji))return void console.warn(`Plugin at ${this.pluginIndex} doesn't support outline.`);const e=this.getUniformValues(this.getMap(),this.Xi);this.Yi(e),e.highlightPickingId=-1;for(let n=0;n<this.Ji.length;n++)this.renderer.render(this.Ji[n],e,this.scene,t)}hr(){if(!this.picking)return;const t=this.layer.getRenderer().canvas;this.Ji=[];for(let e=0;e<this.picking.length;e++){const n=this.picking[e].getPickingVert(),i={ENABLE_PICKING:1,HAS_PICKING_ID:1},s=this.picking[e].getUniformDeclares().slice(0);void 0!==s.uPickingId&&(i.HAS_PICKING_ID=2),this.Ji[e]=new r["m"].MeshShader({vert:n,frag:"precision highp float;\nuniform float highlightPickingId;\nvarying float vPickingId;\nvoid main() {\n  if(highlightPickingId < .0 || floor(highlightPickingId + .5) == floor(vPickingId + .5)) {\n    gl_FragColor = vec4(1.);\n  } else {\n    discard;\n  }\n}",uniforms:s,defines:i,extraCommandProps:{viewport:{x:0,y:0,width:()=>t.width,height:()=>t.height},depth:{enable:!0,mask:!1,func:"always"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.Ji[e].filter=this.picking[e].filter}}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}getIBLRes(){const t=this.layer.getRenderer().canvas;return Yr(t)}createIBLTextures(){const t=this.layer.getRenderer().canvas;Xr(t,this.regl,this.getMap()),this.setToRedraw(!0),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.layer.getRenderer().canvas;Qr(t,this.getMap())}evaluateInFnTypeConfig(t,e,n,r,i){let o=this.cr;o||(o=this.cr={});const a=function(t){let e=0;const n=t&&t.length||0;if(!n)return e;let r;for(let i=0;i<n;i++)r=t.codePointAt(i),e=(e<<5)-e+r,e&=e;return e}(JSON.stringify(t));let l=o[a];return l||(l=o[a]=i?Object(s["e"])(t):Object(s["b"])(t)),l(n.getZoom(),r)}highlight(t){this.te=t,this.dr=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}cancelAllHighlight(){this.te=null,this.dr=this.layer.getRenderer().getFrameTimestamp(),this.setToRedraw(!0)}pr(t,e){const{featureIds:n,pickingIdIndiceMap:r}=e;t.properties.aFeaIds=n,t.properties.pickingIdIndiceMap=r}Gi(t){if(t&&t.properties.isHalo)return;const{pickingIdIndiceMap:e}=t.geometry.properties,n=this.te?function(t,e,n){const{aPickingId:r,feaIdPickingMap:i,features:s}=t.geometry.properties,o=new Map,a=n.keys();for(const l of a){const t=n.get(l);if(t)if(Qt(t.id)){if(t.filter&&r){let n=null;for(let i=0;i<r.length;i++){r[i]!==n&&(n=r[i]);const a=s[n];t.filter(a&&a.feature,e)&&o.set(n,t)}}}else{const e=i[t.id];if(!e||!e.length)continue;for(let n=0;n<e.length;n++)o.set(e[n],t)}}return o}(t,this.layer,this.te):null;r["d"].highlightMesh(this.regl,t,n,this.dr,e)}Bi(t,e,n,r,i){let s=n.aAnchor;if(!s){const{aPosition:t}=e;s=n.aAnchor=t.slice(0)}let o=n.aTerrainAltitude;o||(o=n.aTerrainAltitude=new Float32Array(s.length/r),o.fill(Lt)),this.mr(o,s,i.tileInfo,0,o.length-1),e.aTerrainAltitude?o.dirty&&this.yr(t,o):e.aTerrainAltitude=o,o.dirty=!1}yr(t,e){t&&t.updateData&&t.updateData("aTerrainAltitude",e)}mr(t,e,n,r,s){const{res:o,extent:a,extent2d:l,id:h}=n,c=this.pluginIndex,u=h+"-"+c;if(n.completeTerrainQuery||(n.completeTerrainQuery=[]),n.completeTerrainQuery[c])return;if(!n.completeTerrainQuery[c]&&this.Zi&&this.Zi.has(u)){const e=this.Zi.getAndRemove(u);return this.Zi.add(u,e),t.set(e.altitudeData),n.terrainTileInfos=e.terrainTileInfos,t.dirty=!0,void(n.completeTerrainQuery[c]=!0)}const f=this.layer,d=f.getMap(),p=f.getRenderer(),A=p&&p.getTerrainHelper();let g=n.terrainTileInfos;g||(g=n.terrainTileInfos=this.layer.queryTerrainTiles(n)),n.terrainQueryStatus||(n.terrainQueryStatus=[]);let m=!1,y=[];for(let i=0;i<n.terrainTileInfos.length;i++)if(y[i]=+A.isTerrainTileLoaded(n.terrainTileInfos[i].id),y[i]&&n.terrainQueryStatus[c]&&!n.terrainQueryStatus[c][i]){m=!0;break}if(!m&&n.terrainQueryStatus[c])return;const v=f.constructor;if(d.isInteracting()){const t=p.getFrameTimestamp();v.altitudeQueryFrameTimestamp!==t&&(v.altitudeQueryFrameTimestamp=t,v.altitudeQueryFrameTime=0);const e=f.options.altitudeQueryTimeLimitPerFrame;if(v.altitudeQueryFrameTime>e)return}const x=performance.now();n.terrainQueryStatus[c]=y;const{xmin:b,ymax:w}=l,_=Jr.set(b,w),M=this.layer.getTileSize().width/n.extent,T=e.length/t.length;let S=t.queryResult;S||(S=t.queryResult=new Map);let I=!0;for(let i=r;i<=s;i++){let n=e[i*T];n<0?n=0:n>a&&(n=a);let r=e[i*T+1];r<0?r=0:r>a&&(r=a);const s=n+r*a;let l,h,c=S.get(s);if(c||0===c)t[i]!==c&&(t[i]=c,t.dirty=!0);else{for(let t=0;t<g.length;t++)if(Wr(g[t],b+M*n,w-M*r,o)){l=g[t];break}l&&(A.getRenderer().isTileCached(l.id)||t[i]===Lt)&&($r.set(n,r),h=this.layer.queryTilePointTerrain($r,l,_,a,o)),c=t[i],h&&(c=null===h[0]?Lt:h[0],ti[0]=c,c=ti[0]),t[i]!==c&&(t[i]=c,t.dirty=!0),h&&h[1]?S.set(s,c):I=!1}}v.altitudeQueryFrameTime=(v.altitudeQueryFrameTime||0)+(performance.now()-x),n.completeTerrainQuery[c]=I,I&&(this.Zi||(this.Zi=new i["p"](4*this.layer.options.maxCacheSize)),this.Zi.add(u,{altitudeData:t,terrainTileInfos:g}))}}function si(t,e){const n=t&&t.getCommandKey(this.regl)||"",r=e&&e.getCommandKey(this.regl)||"";return n.localeCompare(r)}function oi(t,e){return t.properties.level-e.properties.level}class ai extends ii{createGeometry(t,e){if(!t.data)return{geometry:null,symbolIndex:t.symbolIndex};t.iconAtlas&&t.iconAtlas.image&&(t.iconAtlas.image.dataType=t.type,t.iconAtlas.image.type="icon"),t.glyphAtlas&&t.glyphAtlas.image&&(t.glyphAtlas.image.type="glyph");const n=qt({},t.data),i={primitive:this.getPrimitive(),positionSize:t.positionSize};n.aAltitude&&(i.altitudeAttribute="aAltitude");const s=new r["m"].Geometry(n,t.indices,0,i);return s.properties={features:e},t.iconAtlas&&(s.properties.iconAtlas=t.iconAtlas.image,s.properties.iconPositions=t.iconAtlas.positions),t.glyphAtlas&&(s.properties.glyphAtlas=t.glyphAtlas.image),br(e)||(s.properties.aFeaIds=t.featureIds,this.pr(s,t)),t.markerPlacement&&(s.properties.markerPlacement=t.markerPlacement),t.textPlacement&&(s.properties.textPlacement=t.textPlacement),qt(s.properties,t.properties),{geometry:s,symbolIndex:t.symbolIndex}}getRayCastData(t,e){const{features:n,aFeaIds:r}=t.geometry.properties;return n&&r?n[r[e]]:null}getPrimitive(){return"triangles"}getRenderFBO(t){return t&&t.renderTarget&&t.renderTarget.fbo}supportRenderMode(t){return"noAa"===t}drawDebugAtlas(t){if(document.getElementById("MAPTALKS_ICON_DEBUG")){const e=document.getElementById("MAPTALKS_ICON_DEBUG");let n;if(e.width=t.width,e.height=t.height,e.style.width=t.width+"px",e.style.height=t.height+"px","alpha"===t.format){n=new Uint8ClampedArray(4*t.data.length);for(let e=0;e<t.data.length;e++)n[4*e+3]=t.data[e]}else n=new Uint8ClampedArray(t.data);const r=e.getContext("2d");r.imageSmoothingEnabled=!1,r.putImageData(new ImageData(n,t.width,t.height),0,0)}}}var li="#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\n#include <fbo_picking_vert>\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * vec4(c, 1.);\n  fbo_picking_setData(gl_Position.w, true);\n}";function hi(t,e,n,i){if(i){const t=r["m"].Util.resizeToPowerOfTwo(e.data,e.width,e.height);e.data=t}const s=e,o={width:s.width,height:s.height,data:s.data,format:s.format,mag:"linear",min:i?"linear mipmap linear":"linear",flipY:n,premultiplyAlpha:!0};if("icon"===e.type){const t="point"!==e.dataType?"repeat":"clamp";o.wrapS=t,o.wrapT=t}return t.texture(o)}const ci=[0,0],ui=[];function fi(t){if(!t.properties.iconPositions)return ci;let e,n=0;for(const o in t.properties.iconPositions)if(e=o,n++,n>1)return ci;if(!e)return ci;const r=t.properties.iconPositions[e],i=r.displaySize[0],s=r.displaySize[1];return ui[0]=i,ui[1]=s,ui}const di=r["k"].identity([]),pi={polygonFill:[1,1,1,1],polygonOpacity:1,uvScale:[1,1],uvOffset:[0,0],patternWidth:[0,0],patternOffset:[0,0]},Ai=[],gi=new i["f"](0,0),mi=new i["f"](0,0),yi=new i["f"](0,0),vi=[];class xi extends ai{static getBloomSymbol(){return["polygonBloom"]}prepareSymbol(t){const e=t.polygonFill;Array.isArray(e)&&(3===e.length&&e.push(1),t.polygonFill=e.map(t=>255*t))}supportRenderMode(t){return this.sceneConfig.antialias||void 0===this.sceneConfig.antialias?"fxaa"===t||"fxaaBeforeTaa"===t:super.supportRenderMode(t)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[xi.getBloomSymbol()[0]]}forbiddenTerrainUpscale(){return!0}needPolygonOffset(){return!0}getAnalysisMeshes(){return this.isVisible()?this.scene.getMeshes().filter(t=>0===t.properties.level):Ai}createMesh(t,e,n){const a=this.getMap(),{tilePoint:l}=n,{geometry:h,symbolIndex:c,ref:u}=t,f=this.layer instanceof i["H"],d=this.layer.getTileSize().width,p=h.properties.tileExtent/d,A=h.properties.tileResolution,g=a.pointAtResToCoord(gi.set(l[0],l[1]),A),m={tileExtent:h.properties.tileExtent,tileRatio:p},y=this.getSymbol(c),v=this.getSymbolDef(c);if(Object(s["c"])(v.polygonPatternFileOrigin)&&this.gr(v,t,f?[0,0]:l,A),(Object(s["c"])(v.polygonPatternFileWidth)||Object(s["c"])(v.polygonPatternFileWidth))&&this.vr(v,t,f?p:1,g,A),v.uvOffsetInMeter&&Object(s["c"])(v.uvOffset)&&this.xr(v,t,g,A),Zt(m,"polygonFill",y,"polygonFill",pi.polygonFill,$t(this.colorCache)),Zt(m,"polygonOpacity",y,"polygonOpacity",pi.polygonOpacity),Zt(m,"uvScale",y,"uvScale",pi.uvScale),void 0===u){const t=this.getFnTypeConfig(c);_r(h,v,t),h.generateBuffers(this.regl)}const x=h.properties.iconAtlas;if(x&&h.data.aTexInfo){const t=[];Object.defineProperty(m,"uvOrigin",{enumerable:!0,get:()=>{const e=m.tileScale;if(h.data.aPatternOrigin)return t[0]=l[0]*e%2048,t[1]=l[1]*e%2048,t;const n=y.polygonPatternFileOrigin;return n?(gi.set(n[0],n[1]),a.coordToPointAtRes(gi,A,mi),r["o"].set(t,l[0]-mi.x,l[1]-mi.y)):(t[0]=l[0]*e%2048,t[1]=l[1]*e%2048,t)}});const e=[];Object.defineProperty(m,"patternWidth",{enumerable:!0,get:()=>{if(h.data.aPatternWidth)return pi.patternWidth;const t=v.polygonPatternFileWidth,n=v.polygonPatternFileHeight;if(!t&&!n)return pi.patternWidth;const[i,s]=this.br(vi,t,n,f?p:1,g,A);return r["o"].set(e,i,s)}}),Object.defineProperty(m,"uvOffset",{enumerable:!0,get:()=>h.data.aPatternOffset||v.uvOffsetInMeter?pi.uvOffset:y.uvOffset||pi.uvOffset});const n=[];Object.defineProperty(m,"patternOffset",{enumerable:!0,get:()=>{if(h.data.aPatternOffset)return pi.uvOffset;if(!v.uvOffsetInMeter)return pi.uvOffset;const t=v.uvOffset;if(!t)return pi.uvOffset;const e=ae(a,t[0],g,A),i=ae(a,t[1],g,A);return r["o"].set(n,e,i)}}),Object.defineProperty(m,"tileScale",{enumerable:!0,get:function(){const t=v.polygonPatternFileWidth,e=v.polygonPatternFileHeight;return t||e?1:h.properties.tileResolution/a.getResolution()}}),m.polygonPatternFile=hi(this.regl,x,!1,!1),m.atlasSize=[x.width,x.height],this.drawDebugAtlas(x)}const b=new r["m"].Material(m,pi),w=new r["m"].Mesh(h,b,{castShadow:!1,picking:!0}),_={};return x&&h.data.aTexInfo&&(_.HAS_PATTERN=1),x&&h.data.aTexCoord&&(_.HAS_TEX_COORD=1,_.INVALID_TEX_COORD=o["f"]+".0"),h.data.aAltitude&&(_.HAS_ALTITUDE=1),h.data.aColor&&(_.HAS_COLOR=1),h.data.aOpacity&&(_.HAS_OPACITY=1),h.data.aUVScale&&(_.HAS_UV_SCALE=1),h.data.aUVOffset&&(_.HAS_UV_OFFSET=1),h.data.aPatternOrigin&&(_.HAS_PATTERN_ORIGIN=1),h.data.aPatternWidth&&(_.HAS_PATTERN_WIDTH=1),h.data.aPatternOffset&&(_.HAS_PATTERN_OFFSET=1),f&&(_.IS_VT=1),w.setDefines(_),w.setLocalTransform(e),w.properties.symbolIndex=c,w}vr(t,e,n,r,i){if(!(e=e&&e.geometry))return;const o=e.properties.features;if(br(o))return;const a=t.polygonPatternFileWidth,l=t.polygonPatternFileHeight,h=Object(s["b"])(t.polygonPatternFileOrigin);let c,u;Object(s["c"])(a)&&(c=Object(s["b"])(a)),Object(s["c"])(l)&&(u=Object(s["b"])(l));const{aPickingId:f,aPatternOrigin:d}=e.data,p=f.length,A=new Float32Array(2*p);let g,m,y;for(let s=0,v=f.length;s<v;s++){let t,e;if(f[s]===g){A[2*s]=m,A[2*s+1]=y;continue}const p=o[f[s]];if(t=c?c(null,p.feature.properties):a,e=u?u(null,p.feature.properties):l,g=f[s],t||e){let o=r;if(d){const t=h(null,p.feature.properties);t&&(o=yi.set(t[0],t[1]))}const[a,l]=this.br(vi,t,e,n,o,i);m=A[2*s]=a,y=A[2*s+1]=l}else m=A[2*s]=0,y=A[2*s+1]=0}e.data.aPatternWidth=A}xr(t,e,n,r){if(!(e=e&&e.geometry))return;const i=e.properties.features;if(br(i))return;const o=this.getMap();let a=Object(s["c"])(t.uvOffsetInMeter)&&Object(s["e"])(t.uvOffsetInMeter);const l=Object(s["b"])(t.uvOffset),h=Object(s["b"])(t.polygonPatternFileOrigin),{aPickingId:c,aPatternOrigin:u}=e.data,f=c.length,d=new Float32Array(2*f);let p,A,g;for(let s=0,m=c.length;s<m;s++){if(c[s]===p){d[2*s]=A,d[2*s+1]=g;continue}const t=i[c[s]],e=l(null,t.feature.properties);let f=!0;if(a&&(f=a(null,t.feature.properties)),p=c[s],e&&f){let i=n;if(u){const e=h(null,t.feature.properties);e&&(i=yi.set(e[0],e[1]))}const a=ae(o,e[0],i,r),l=ae(o,e[0],i,r);A=d[2*s]=a,g=d[2*s+1]=l}else A=d[2*s]=0,g=d[2*s+1]=0}e.data.aPatternOffset=d}gr(t,e,n,r){if(!(e=e&&e.geometry))return;const i=e.properties.features;if(br(i))return;const o=this.getMap(),a=Object(s["b"])(t.polygonPatternFileOrigin),l=e.data.aPickingId,h=l.length,c=new Float32Array(2*h);let u,f,d;for(let s=0,p=l.length;s<p;s++){if(l[s]===u){c[2*s]=f,c[2*s+1]=d;continue}u=l[s];const t=a(null,i[u].feature.properties);t?(gi.set(t[0],t[1]),o.coordToPointAtRes(gi,r,mi),f=c[2*s]=mi.x,d=c[2*s+1]=mi.y):(f=c[2*s]=n[0],d=c[2*s+1]=n[1])}e.data.aPatternOrigin=c}createFnTypeConfig(t,e){const n=Object(s["e"])(e.polygonFill),r=Object(s["b"])(e.polygonOpacity),i=Object(s["b"])(e.uvScale),o=Object(s["b"])(e.uvOffset),a=new Uint8Array(1),h=new Uint16Array(2),c=new Uint8Array(2);return[{attrName:"aColor",symbolName:"polygonFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||l()(i).unitArray()),i=Jt(i),i}},{attrName:"aOpacity",symbolName:"polygonOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=r(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),a[0]=255*i,a[0]}},{attrName:"aUVScale",symbolName:"uvScale",type:Uint16Array,width:2,define:"HAS_UV_SCALE",evaluate:e=>{const n=i(t.getZoom(),e);return h[0]=255*n[0],h[1]=255*n[1],h}},{attrName:"aUVOffset",symbolName:"uvOffset",type:Uint8Array,width:2,define:"HAS_UV_OFFSET",evaluate:e=>{const n=o(t.getZoom(),e);return c[0]=255*n[0],c[1]=255*n[1],c}}]}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.Ar(t)),super.paint(t)}isEnableStencil(t){const e=this.layer.getRenderer();return!(t&&t.isRenderingTerrain&&this.isTerrainSkin()||!e.isEnableTileStencil||!e.isEnableTileStencil())&&"VectorTileLayer"===this.layer.getJSONType()}init(t){const e=this.regl,n=this.canvas,i={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:n?n.width:1,height:(t,e)=>e.viewport?e.viewport.height:n?n.height:1};this.renderer=new r["m"].Renderer(e);const s=this.layer.getRenderer(),o={viewport:i,stencil:{enable:()=>this.isEnableStencil(t),func:{cmp:()=>s.isEnableTileStencil&&s.isEnableTileStencil()?"=":"<=",ref:(t,e)=>s.isEnableTileStencil&&s.isEnableTileStencil()?e.stencilRef:e.level},op:{fail:"keep",zfail:"keep",zpass:()=>s.isEnableTileStencil&&s.isEnableTileStencil()?"zero":"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:(t,e)=>{if(!Qt(this.sceneConfig.depthMask))return!!this.sceneConfig.depthMask;if(e.hasSSRGround)return!0;if(e.meshConfig.transparent)return!1;const n=e.polygonOpacity;return!(ne(n)&&n<1)},func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};if(this.Ar(t,o),this.pickingFBO){const t=[];this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:li,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return r["k"].multiply(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:o},this.pickingFBO,this.getMap())]}}Ar(t,e){const n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],s={};this.fillIncludes(s,i,t),this.shader=new r["m"].MeshShader({vert:"#define SHADER_NAME FILL\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\nuniform mat4 projViewModelMatrix;\n#ifndef IS_VT\nuniform mat4 modelMatrix;\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_TEX_COORD\nattribute vec2 aTexCoord;\n#endif\nattribute vec4 aTexInfo;\nuniform vec2 patternWidth;\nuniform vec2 patternOffset;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\n#ifdef IS_VT\nuniform float tileRatio;\nuniform float tileScale;\n#else\nuniform float glScale;\n#endif\n#ifdef HAS_UV_SCALE\nattribute vec2 aUVScale;\nvarying vec2 vUVScale;\n#endif\n#ifdef HAS_UV_OFFSET\nattribute vec2 aUVOffset;\nvarying vec2 vUVOffset;\n#endif\n#ifdef HAS_PATTERN_WIDTH\nattribute vec2 aPatternWidth;\n#endif\n#ifdef HAS_PATTERN_ORIGIN\nattribute vec2 aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nattribute vec2 aPatternOffset;\n#endif\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d, vec2 e) {\n  \n#ifdef IS_VT\nfloat f = d.x / e.x;\n  float h = d.y / e.y;\n  return vec2(f, h);\n#else\nfloat i = glScale;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  i = mix(glScale, 1., j);\n#endif\nvec2 k = uvOrigin;\n#ifdef HAS_PATTERN_ORIGIN\nk = aPatternOrigin;\n#endif\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nk += l;\n  float f = (d.x - k.x) * i / e.x;\n  float h = (d.y - k.y) * i / e.y;\n  return vec2(f, -h);\n#endif\n}\nvec2 m(vec4 n, vec2 o) {\n  \n#ifdef IS_VT\n#ifdef HAS_PATTERN_OFFSET\nvec2 l = aPatternOffset;\n#else\nvec2 l = patternOffset;\n#endif\nvec2 k = uvOrigin + l;\n#ifdef HAS_PATTERN_ORIGIN\nk = k - aPatternOrigin * tileScale;\n#endif\nfloat j = sign(length(patternWidth));\n  vec2 A = mix(o, patternWidth, j);\n#ifdef HAS_PATTERN_WIDTH\nA = aPatternWidth;\n#endif\nvec2 B = k * vec2(1., -1.) / A;\n  return mod(B, 1.) + c(n.xy * tileScale / tileRatio, A);\n#else\nvec2 A = o;\n#ifdef HAS_PATTERN_WIDTH\nfloat j = sign(length(aPatternWidth));\n  A = mix(o, aPatternWidth, j);\n#endif\nvec4 C = modelMatrix * n;\n  return c(C.xy, A);\n#endif\n}\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <vt_position_vert>\n#include <highlight_vert>\nvoid main() {\n  vec3 D = unpackVTPosition();\n  vec4 n = vec4(D, 1.);\n  gl_Position = projViewModelMatrix * n;\n#ifdef HAS_PATTERN\nvec2 o = aTexInfo.zw + 1.;\n  vTexInfo = vec4(aTexInfo.xy, o);\n#ifdef HAS_TEX_COORD\nif(aTexCoord.x == INVALID_TEX_COORD) {\n    vTexCoord = m(n, o);\n  } else {\n    vTexCoord = aTexCoord;\n  }\n#else\nvTexCoord = m(n, o);\n#endif\n#ifdef HAS_UV_SCALE\nvUVScale = aUVScale / 255.;\n#endif\n#ifdef HAS_UV_OFFSET\nvUVOffset = aUVOffset / 255.;\n#endif\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\nhighlight_setVarying();\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(n);\n#endif\n}",frag:"#define SHADER_NAME FILL\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n#ifdef HAS_UV_SCALE\nvarying vec2 vUVScale;\n#else\nuniform highp vec2 uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvarying vec2 vUVOffset;\n#else\nuniform vec2 uvOffset;\n#endif\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D polygonPatternFile;\nuniform vec2 atlasSize;\nvarying vec2 vTexCoord;\nvarying vec4 vTexInfo;\nvec2 c() {\n  \n#ifdef HAS_UV_SCALE\nvec2 d = vUVScale;\n#else\nvec2 d = uvScale;\n#endif\n#ifdef HAS_UV_OFFSET\nvec2 e = vUVOffset;\n#else\nvec2 e = uvOffset;\n#endif\nvec2 f = mod(vTexCoord * d + e, 1.);\n  vec2 h = vTexInfo.xy;\n  vec2 i = vTexInfo.zw;\n  return (h + f * i) / atlasSize;\n}\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#include <highlight_frag>\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float polygonOpacity;\n#endif\nuniform float layerOpacity;\nuniform float tileExtent;\nvoid main() {\n  \n#ifdef HAS_COLOR\nvec4 j = vColor;\n#else\nvec4 j = polygonFill;\n#endif\n#ifdef HAS_PATTERN\nif(vTexInfo.z * vTexInfo.w > 1.) {\n    vec2 f = c();\n    j = texture2D(polygonPatternFile, f);\n  }\n#endif\n#ifdef HAS_OPACITY\ngl_FragColor = j * vOpacity;\n#else\ngl_FragColor = j * polygonOpacity;\n#endif\ngl_FragColor *= layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat k = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, k);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:i,defines:s,extraCommandProps:e})}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,r={projViewMatrix:n?di:t.projViewMatrix,glScale:e&&e.isRenderingTerrainSkin?1:1/t.getGLScale(),viewport:n&&e&&e.viewport,hasSSRGround:e&&e.hasSSRGround};return this.setIncludeUniformValues(r,e),r}br(t,e,n,r,i,s){let o,a;const l=this.getMap();return e&&(o=ae(l,e,i,s)),n&&(a=ae(l,n,i,s,1)),o=o||a,a=a||o,t[0]=o,t[1]=a,t}}var bi="#define SHADER_NAME LINE\n#define AA_CLIP_LIMIT 2.0\n#define AA_LINE_WIDTH 16.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define ANTIALIASING 1.0 / DEVICE_PIXEL_RATIO / 2.0\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\n#ifdef PICKING_MODE\n#include <gl2_vert>\n#endif\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY)\nattribute vec3 aExtrude;\n#else\nattribute vec2 aExtrude;\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nattribute float aLinesofar;\nvarying highp float vLinesofar;\n#endif\nuniform float cameraToCenterDistance;\n#if defined(HAS_STROKE_WIDTH)\nattribute float aLineStrokeWidth;\n#else\nuniform float lineStrokeWidth;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\nuniform float tileResolution;\nuniform float resolution;\nuniform float tileRatio;\nuniform float isRenderingTerrain;\n#if defined(HAS_LINE_DX) || defined(HAS_LINE_DY)\nattribute vec2 aLineDxDy;\n#endif\n#ifndef HAS_LINE_DX\nuniform float lineDx;\n#endif\n#ifndef HAS_LINE_DY\nuniform float lineDy;\n#endif\nuniform vec2 canvasSize;\nuniform float layerScale;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef USE_LINE_OFFSET\nattribute vec2 aExtrudeOffset;\n#endif\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#ifndef PICKING_MODE\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_PATTERN\n#if defined(HAS_PATTERN_ANIM) || defined(HAS_PATTERN_GAP)\nattribute vec2 aLinePattern;\n#endif\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#endif\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nattribute vec4 aDasharray;\nvarying vec4 vDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nattribute vec4 aDashColor;\nvarying vec4 vDashColor;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nattribute vec4 aStrokeColor;\nvarying vec4 vStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\nvarying float vOpacity;\n#endif\n#ifdef HAS_GRADIENT\nattribute float aGradIndex;\nvarying float vGradIndex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvarying vec3 vVertex;\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  float d = mod(abs(aExtrude.x), 2.);\n  float e = mod(abs(aExtrude.y), 2.);\n  vNormal = vec2(d, e * 2. - 1.);\n  vec4 f = vec4(c, 1.);\n  vec4 h = projViewModelMatrix * positionMatrix * f;\n  if(isRenderingTerrain == 1.) {\n    vVertex = (positionMatrix * f).xyz;\n  } else {\n    vVertex = (modelMatrix * positionMatrix * f).xyz;\n  }\n#ifdef HAS_STROKE_WIDTH\nfloat i = aLineStrokeWidth / 2. * layerScale;\n#else\nfloat i = lineStrokeWidth;\n#endif\n#ifdef HAS_LINE_WIDTH\nfloat j = aLineWidth / 2. * layerScale;\n#else\nfloat j = lineWidth * layerScale;\n#endif\nfloat k = j / 2. + i;\n  float l = sign(i) * j / 2.;\n  float m = l + sign(l) * ANTIALIASING;\n  float n = k + sign(k) * ANTIALIASING;\n#ifdef USE_LINE_OFFSET\nvec2 o = lineOffset * (vNormal.y * (aExtrude.xy - aExtrudeOffset) + aExtrudeOffset);\n  vec2 u = (n * aExtrude.xy + o) / EXTRUDE_SCALE;\n#else\nvec2 v = aExtrude.xy / EXTRUDE_SCALE;\n  vec2 u = n * v;\n#endif\nfloat A = tileResolution / resolution;\n  vec4 B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n  gl_Position = projViewModelMatrix * positionMatrix * B;\n  if(isRenderingTerrain == .0) {\n    float C = min(AA_CLIP_LIMIT / canvasSize.x, AA_CLIP_LIMIT / canvasSize.y);\n    float D = distance(gl_Position.xy / gl_Position.w, h.xy / h.w) - C;\n    if(D * j < .0) {\n      float E = -D / C;\n      float F = E * E * E * E * AA_LINE_WIDTH;\n      u += F * v;\n      n += F / 6.;\n      B = vec4(c + vec3(u, .0) * tileRatio / A, 1.);\n      gl_Position = projViewModelMatrix * positionMatrix * B;\n    }\n  }\n#ifdef HAS_LINE_DX\nfloat G = aLineDxDy[0];\n#else\nfloat G = lineDx;\n#endif\n#ifdef HAS_LINE_DY\nfloat H = aLineDxDy[1];\n#else\nfloat H = lineDy;\n#endif\nfloat I = gl_Position.w;\n  gl_Position.xy += vec2(G, H) * 2. / canvasSize * I;\n#ifndef PICKING_MODE\nvWidth = vec2(n, m);\n  if(isRenderingTerrain == 1.) {\n    vGammaScale = 1.;\n  } else {\n    vGammaScale = I / cameraToCenterDistance;\n  }\n#ifndef ENABLE_TILE_STENCIL\nvPosition = c.xy;\n#ifdef USE_LINE_OFFSET\nvPosition += tileRatio * o / EXTRUDE_SCALE;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT)\n#ifdef HAS_GRADIENT\nvLinesofar = aLinesofar / MAX_LINE_DISTANCE;\n  vGradIndex = aGradIndex;\n#else\nfloat J = aLinesofar - k * aExtrude.z / EXTRUDE_SCALE / A * tileRatio;\n  vLinesofar = J / tileRatio * A;\n#endif\n#endif\n#ifndef HAS_GRADIENT\n#ifdef HAS_COLOR\nvColor = aColor;\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvDasharray = aDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvDashColor = aDashColor / 255.;\n#endif\n#endif\n#ifdef HAS_PATTERN\nvTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n#ifdef HAS_PATTERN_ANIM\nvLinePatternAnimSpeed = aLinePattern[0] / 127.;\n#endif\n#ifdef HAS_PATTERN_GAP\nvLinePatternGap = aLinePattern[1] / 10.0;\n#endif\n#endif\n#endif\n#ifdef HAS_STROKE_COLOR\nvStrokeColor = aStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(B);\n#endif\nhighlight_setVarying();\n#else\nfbo_picking_setData(I, true);\n#endif\n}";const wi=r["k"].identity([]),_i=[];class Mi extends ai{static getBloomSymbol(){return["lineBloom"]}prepareSymbol(t){const e=t.lineColor;Array.isArray(e)&&(3===e.length&&e.push(1),t.lineColor=e.map(t=>255*t));const n=t.lineStrokeColor;Array.isArray(n)&&(3===n.length&&n.push(1),t.lineStrokeColor=n.map(t=>255*t));const r=t.lineDashColor;Array.isArray(r)&&(3===r.length&&r.push(1),t.lineDashColor=r.map(t=>255*t))}isAnimating(){if(this.wr)return!0;const t=this.getSymbols(),e=this.sceneConfig.trailAnimation;if(e&&e.enable)return!0;for(let n=0;n<t.length;n++)if(t[n].linePatternFile&&t[n].linePatternAnimSpeed)return!0;return!1}needToRedraw(){return!!super.needToRedraw()||!!this.isAnimating()}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Mi.getBloomSymbol()[0]]}needPolygonOffset(){return!0}createMesh(t,e){if(!t.geometry)return null;const{geometry:n,symbolIndex:s,ref:o}=t,a=this.getSymbolDef(s);void 0===o&&_r(n,a,this.getFnTypeConfig(s));const l=this.getSymbol(s),h={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent};this.setLineUniforms(l,h),Zt(h,"lineColor",l,"lineColor","#fff",$t(this.colorCache)),Zt(h,"linePatterGapColor",l,"linePatterGapColor",[0,0,0,0],$t(this.colorCache)),Zt(h,"lineStrokeColor",l,"lineStrokeColor",[0,0,0,0],$t(this.colorCache)),Zt(h,"lineDasharray",l,"lineDasharray",[0,0,0,0],t=>{let e;if(t&&t.length){const n=t;1===t.length?e=[n[0],n[0],n[0],n[0]]:2===t.length?e=[n[0],n[1],n[0],n[1]]:3===t.length?e=[n[0],n[1],n[2],n[2]]:4===t.length?e=t:t.length>4&&(e=t.slice(0,4))}return e||[0,0,0,0]}),Zt(h,"lineDashColor",l,"lineDashColor",[0,0,0,0],$t(this.colorCache));const c=n.properties.iconAtlas,u=this.layer instanceof i["H"];c&&(h.linePatternFile=hi(this.regl,c,!1,!1),h.atlasSize=c?[c.width,c.height]:[0,0],h.flipY=u?-1:1,this.drawDebugAtlas(c)),void 0===o&&n.generateBuffers(this.regl);const f=new r["m"].Material(h),d=new r["m"].Mesh(n,f,{castShadow:!1,picking:!0});d.setLocalTransform(e),d.positionMatrix=this.getAltitudeOffsetMatrix();const p={};return c&&(p.HAS_PATTERN=1),d.properties.symbolIndex=s,this._r(d,p),n.data.aColor&&(p.HAS_COLOR=1),n.data.aStrokeColor&&(p.HAS_STROKE_COLOR=1),this.setMeshDefines(p,n,a),n.data.aAltitude&&(p.HAS_ALTITUDE=1),d.setDefines(p),d}addMesh(...t){delete this.wr;const e=t[0];Array.isArray(e)&&e.forEach(t=>{this.Sr(t)}),super.addMesh(...t)}Sr(t){if(!t.geometry.aLineWidth&&t.material.get("lineWidth")<=0||!t.geometry.aOpacity&&t.material.get("lineOpacity")<=0)return;const e=t.defines;this._r(t,e),t.setDefines(e),t.geometry.properties.hasPatternAnim&&(this.wr=1)}_r(t,e){const n=t.geometry,r=this.getSymbol(t.properties.symbolIndex);n.data.aDasharray||Array.isArray(r.lineDasharray)&&r.lineDasharray.reduce((t,e)=>t+e,0)>0?(e.HAS_DASHARRAY=1,n.data.aDasharray&&(e.HAS_DASHARRAY_ATTR=1),n.data.aDashColor&&(e.HAS_DASHARRAY_COLOR=1)):e.HAS_DASHARRAY&&delete e.HAS_DASHARRAY}setLineUniforms(t,e){Zt(e,"lineWidth",t,"lineWidth",2),Zt(e,"lineOpacity",t,"lineOpacity",1),Zt(e,"lineStrokeWidth",t,"lineStrokeWidth",0),Zt(e,"lineBlur",t,"lineBlur",.7),Zt(e,"lineOffset",t,"lineOffset",0),Zt(e,"lineDx",t,"lineDx",0),Zt(e,"lineDy",t,"lineDy",0),Zt(e,"linePatternAnimSpeed",t,"linePatternAnimSpeed",0),Zt(e,"linePatternGap",t,"linePatternGap",0)}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),e.data.aLineStrokeWidth&&(t.HAS_STROKE_WIDTH=1),Nr(n.lineDx)&&(t.HAS_LINE_DX=1),Nr(n.lineDy)&&(t.HAS_LINE_DY=1),Nr(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),Nr(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){this.isShadowIncludeChanged(t)&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}createFnTypeConfig(t,e){const n=Object(s["e"])(e.lineColor),r=Object(s["e"])(e.aLinePatternAnimSpeed),i=Object(s["e"])(e.aLinePatternGap),o=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||l()(i).unitArray()),i=Jt(i),i}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,s)=>{let o=r(t.getZoom(),e);return Qt(o)&&(o=0),0!==o&&(n.properties.hasPatternAnim=1),a[0]=o/127,a[1]=i[s+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,r,s)=>{let o=i(t.getZoom(),e);return Qt(o)&&(o=0),a[1]=10*o,a[0]=r[s],a}}].concat(o)}createShapeFnTypeConfigs(t,e){const n=Object(s["b"])(e.lineWidth),r=Object(s["b"])(e.lineOpacity),i=Object(s["b"])(e.lineStrokeWidth),o=Object(s["b"])(e.lineDx),a=Object(s["b"])(e.lineDy),l=new Uint16Array(1),h=new Int8Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e)),l[0]=Math.round(2*i),l[0]}},{attrName:"aLineStrokeWidth",symbolName:"lineStrokeWidth",type:Uint8Array,width:1,define:"HAS_STROKE_WIDTH",evaluate:e=>{const n=i(t.getZoom(),e);return l[0]=Math.round(2*n),l[0]}},{attrName:"aLineDxDy",symbolName:"lineDx",type:Int8Array,width:2,define:"HAS_LINE_DX",evaluate:e=>{const n=o(t.getZoom(),e);return h[0]=n,h[0]}},{attrName:"aLineDxDy",symbolName:"lineDy",type:Int8Array,width:2,define:"HAS_LINE_DY",evaluate:e=>{const n=a(t.getZoom(),e);return h[0]=n,h[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let i=r(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),l[0]=255*i,l[0]}}]}updateSceneConfig(t){t.trailAnimation&&this.createShader(this.Mr)}init(t){const e=this.regl;this.renderer=new r["m"].Renderer(e),this.createShader(t),this.pickingFBO&&(this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+bi,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())])}createShader(t){this.Mr=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply(i,e.projViewMatrix,e.modelMatrix),i}}),this.shader=new r["m"].MeshShader({vert:bi,frag:"#define SHADER_NAME LINE\n#define DEVICE_PIXEL_RATIO 1.0\nprecision highp float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform lowp float blendSrcIsOne;\nuniform lowp float lineBlur;\nuniform float isRenderingTerrain;\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform lowp vec4 lineColor;\n#endif\n#include <highlight_frag>\n#ifdef HAS_STROKE_COLOR\nvarying vec4 vStrokeColor;\n#else\nuniform lowp vec4 lineStrokeColor;\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatterGapColor;\nvarying vec4 vTexInfo;\nvec2 c(vec2 d) {\n  vec2 e = mod(d, 1.);\n  vec2 f = vTexInfo.xy;\n  vec2 h = vTexInfo.zw;\n  return (f + e * h) / atlasSize;\n}\n#endif\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\nuniform float tileExtent;\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvarying vec4 vDasharray;\n#else\nuniform vec4 lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvarying vec4 vDashColor;\n#else\nuniform vec4 lineDashColor;\n#endif\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nvarying highp float vLinesofar;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\n#endif\n#if defined(HAS_TRAIL) || defined(HAS_PATTERN)\nuniform float currentTime;\n#endif\nfloat i(float j, float k) {\n  float l = k / 2.;\n  float m = abs(j - l);\n  float n = (.1 + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  return clamp(min(m + n, l - m) / n, .0, 1.);\n}\nvarying vec3 vVertex;\nuniform vec3 cameraPosition;\nuniform float cameraToCenterDistance;\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat o = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(o == .0) {\n    discard;\n  }\n#endif\n#if defined(HAS_PATTERN) || defined(HAS_DASHARRAY) || defined(HAS_GRADIENT) || defined(HAS_TRAIL)\nfloat u = vLinesofar;\n#endif\nfloat v = length(vNormal) * vWidth.s;\n#ifdef HAS_PATTERN\nvec2 h = vTexInfo.zw;\n  float A = sign(h.x * h.y);\n  float B = mix(lineBlur, .0, A);\n#else\nfloat B = lineBlur;\n#endif\nfloat n = (B + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float C = clamp(min(v - (vWidth.t - n), vWidth.s - v) / n, .0, 1.);\n#ifdef HAS_COLOR\nvec4 D = vColor / 255.;\n#else\nvec4 D = lineColor;\n#endif\n#ifdef HAS_PATTERN\nif(A == 1.) {\n    \n#ifdef HAS_PATTERN_GAP\nfloat E = vLinePatternGap;\n#else\nfloat E = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat F = vLinePatternAnimSpeed;\n#else\nfloat F = linePatternAnimSpeed;\n#endif\nfloat G = h.x * vWidth.s * 2. / h.y;\n    float H = G * (1. + E);\n    u += mod(currentTime * -F * .2, H);\n    float I = mod(u / H, 1.);\n    float J = mod((flipY * vNormal.y + 1.) / 2., 1.);\n    vec4 K = texture2D(linePatternFile, c(vec2(I * (1. + E), J)));\n    float L = clamp(sign(1. / (1. + E) - I) + .000001, .0, 1.);\n    K = mix(linePatterGapColor, K, L);\n    D *= K;\n  }\n#endif\n#ifdef HAS_DASHARRAY\n#ifdef HAS_DASHARRAY_ATTR\nvec4 M = vDasharray;\n#else\nvec4 M = lineDasharray;\n#endif\n#ifdef HAS_DASHARRAY_COLOR\nvec4 N = vDashColor;\n#else\nvec4 N = lineDashColor;\n#endif\nfloat k = M[0] + M[1] + M[2] + M[3];\n  float j = mod(u, k);\n  float O = max(sign(M[0] - j), .0);\n  float P = j - M[0] - M[1];\n  float Q = max(sign(P), .0) * max(sign(M[2] - P), .0);\n  float R = O + Q;\n  float S = i(j, M[0]);\n  float T = i(P, M[2]);\n  float U = S * O + T * Q;\n  D = D * (1. - U) + N * U;\n#endif\n#ifdef HAS_STROKE_COLOR\nvec4 V = vStrokeColor / 255.;\n#else\nvec4 V = lineStrokeColor;\n#endif\nV = mix(D, V, sign(vWidth.t));\n  D = V * C + max(sign(vWidth.t - v), .0) * D * (1. - C);\n#ifdef HAS_TRAIL\nfloat W = mod(u - currentTime * trailSpeed * .1, trailCircle);\n  float X = W < trailLength ? mix(.0, 1., W / trailLength) : .0;\n  D *= X;\n#endif\n#ifdef HAS_OPACITY\nfloat Y = vOpacity;\n#else\nfloat Y = lineOpacity;\n#endif\ngl_FragColor = D * Y * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat Z = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, Z);\n#endif\nfloat ba;\n  if(isRenderingTerrain == 1.) {\n    ba = 1.;\n  } else {\n    ba = clamp(cameraToCenterDistance * 1.5 / distance(vVertex, cameraPosition), .0, 1.);\n  }\n  gl_FragColor *= ba;\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.layer.getRenderer().isEnableTileStencil&&this.layer.getRenderer().isEnableTileStencil(),e=this.canvas;return{viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},stencil:{enable:!1,func:{cmp:()=>t?"=":"<=",ref:(e,n)=>t?n.stencilRef:n.level},op:{fail:"keep",zfail:"keep",zpass:()=>t?"zero":"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],mask:this.sceneConfig.depthMask||!1,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,s=n?wi:t.projViewMatrix,o=t.viewMatrix,a=t.cameraToCenterDistance,l=t.getResolution(),h=r["o"].set(_i,t.width,t.height);n&&r["o"].set(h,i,i);const c=this.getBlendFunc().src(),u=this.sceneConfig.trailAnimation||{},f={layerScale:this.layer.options.styleScale||1,projViewMatrix:s,viewMatrix:o,cameraToCenterDistance:a,resolution:l,canvasSize:h,trailSpeed:u.speed||1,trailLength:u.trailLength||500,trailCircle:u.trailCircle||1e3,currentTime:this.layer.getRenderer().getFrameTimestamp()||0,blendSrcIsOne:+!(1!==c&&"one"!==c),cameraPosition:t.cameraPosition,viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n};return this.setIncludeUniformValues(f,e),f}}class Ti extends Mi{postCreateGeometry(t){const{symbolIndex:e,geometry:n}=t,{features:r}=n.properties,i=this.getSymbol(e).lineGradientProperty,s=n.data.aPickingId,o=new Uint8Array(s.length),a=[];let l=s[0];const h=r[l].feature.properties;a.push(h&&h[i]||0);for(let c=1;c<s.length;c++)s[c]!==l&&(l=s[c],a.push(h&&h[i]||0)),o[c]=a.length-1;n.data.aGradIndex=o,n.properties.gradients=a}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:s}=t,o=this.getSymbolDef(i);void 0===s&&_r(n,o,this.getFnTypeConfig(i));const a={tileResolution:n.properties.tileResolution,tileRatio:n.properties.tileRatio,tileExtent:n.properties.tileExtent},l=this.getSymbol(i);this.setLineUniforms(l,a);const h=n.properties.gradients;let c=2*h.length;Ii(c)||(c=Ci(c));const u=this.regl.texture({width:256,height:c,data:Si(h),format:"rgba",mag:"linear",min:"linear",flipY:!1});a.lineGradientTexture=u,a.lineGradientTextureHeight=u.height,void 0===s&&n.generateBuffers(this.regl);const f=new r["m"].Material(a),d=new r["m"].Mesh(n,f,{castShadow:!1,picking:!0});d.setLocalTransform(e);const p={HAS_GRADIENT:1};return n.data.aAltitude&&(p.HAS_ALTITUDE=1),this.setMeshDefines(p,n,o),d.setDefines(p),d.properties.symbolIndex=i,d}createFnTypeConfig(t,e){return this.createShapeFnTypeConfigs(t,e)}createShader(t){this.Mr=t;const e=[],n={};this.fillIncludes(n,e,t),this.sceneConfig.trailAnimation&&this.sceneConfig.trailAnimation.enable&&(n.HAS_TRAIL=1);const i=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply(i,e.projViewMatrix,e.modelMatrix),i}}),this.shader=new r["m"].MeshShader({vert:bi,frag:"#define SHADER_NAME LINE_GRADIENT\n#define DEVICE_PIXEL_RATIO 1.0\n#define MAX_LINE_COUNT 128.0\nprecision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#ifdef HAS_OPACITY\nvarying float vOpacity;\n#else\nuniform lowp float lineOpacity;\n#endif\nuniform float layerOpacity;\nuniform lowp float lineBlur;\nuniform float lineGradientTextureHeight;\nuniform float tileExtent;\nuniform sampler2D lineGradientTexture;\nvarying vec2 vNormal;\nvarying vec2 vWidth;\nvarying float vGammaScale;\nvarying highp float vLinesofar;\nvarying float vGradIndex;\n#ifndef ENABLE_TILE_STENCIL\nvarying vec2 vPosition;\n#endif\n#ifdef HAS_TRAIL\nuniform float trailSpeed;\nuniform float trailLength;\nuniform float trailCircle;\nuniform float currentTime;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifndef ENABLE_TILE_STENCIL\nfloat c = sign(tileExtent - min(tileExtent, abs(vPosition.x))) * sign(1. + sign(vPosition.x)) * sign(tileExtent - min(tileExtent, abs(vPosition.y))) * sign(1. + sign(vPosition.y));\n  if(c == .0) {\n    discard;\n  }\n#endif\nfloat d = length(vNormal) * vWidth.s;\n  float e = (lineBlur + 1. / DEVICE_PIXEL_RATIO) * vGammaScale;\n  float f = clamp(min(d - (vWidth.t - e), vWidth.s - d) / e, .0, 1.);\n  float h = vLinesofar;\n  vec4 i = texture2D(lineGradientTexture, vec2(h, (vGradIndex * 2. + .5) / lineGradientTextureHeight)) * f;\n  i *= max(sign(MAX_LINE_COUNT - vGradIndex), .0);\n#ifdef HAS_TRAIL\nfloat j = mod(h - currentTime * trailSpeed * .1, trailCircle);\n  float k = j < trailLength ? mix(.0, 1., j / trailLength) : .0;\n  i *= k;\n#endif\n#ifdef HAS_OPACITY\nfloat l = vOpacity;\n#else\nfloat l = lineOpacity;\n#endif\ngl_FragColor = i * l * layerOpacity;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat m = shadow_computeShadow();\n  gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, m);\n#endif\ngl_FragColor = highlight_blendColor(gl_FragColor);\n}",uniforms:e,defines:n,extraCommandProps:this.getExtraCommandProps()})}}function Si(t){t.length>128&&(console.warn("Line count in a tile exceeds maximum limit (128) for line-gradient render plugin."),t=t.slice(0,128));const e=document.createElement("canvas"),n=e.getContext("2d");e.width=256,e.height=2*t.length,Ii(e.height)||(e.height=Ci(2*t.length));for(let r=0;r<t.length;r++){const e=t[r],i=n.createLinearGradient(0,0,256,0);for(let t=0;t<e.length;t+=2)i.addColorStop(+e[t],e[t+1]);n.fillStyle=i;const s=r%256;n.fillRect(0,2*s,256,2*s+2)}return n.canvas}function Ii(t){return 0==(t&t-1)&&0!==t}function Ci(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}class Oi{constructor(t){this.N=t||[],this.properties={}}set meshes(t){this.N=t}get meshes(){return this.N}}const Ei=224,Pi=600,ki=100,Ri=new Uint8Array(1),Ni=[],Di={collides:0,boxes:[]},Fi=[],Li=[];class zi extends ai{createGeometry(...t){const e=super.createGeometry(...t);if(!e||!e.geometry)return e;const{geometry:n}=e,r=t[0];n.properties.collideIds=r.featureIds&&r.featureIds.length&&r.isIdUnique?r.featureIds:r.data.aPickingId;const s=this.layer instanceof i["H"];return n.properties.uniqueCollideIds=se(n.properties.collideIds,!s),e}supportRenderMode(t){const e=this.sceneConfig.renderToPointRenderTarget;return e||void 0===e?"point"===t:"fxaa"===t||"fxaaAfterTaa"===t}addMesh(t,e,n){if(t&&!this.isEnableCollision()){let e=t;Array.isArray(e)||(Fi[0]=t,e=Fi);for(let t=0;t<e.length;t++){const n=e[t].defines;delete n.ENABLE_COLLISION,e[t].setDefines(n);const{elements:r,visElemts:i}=e[t].geometry.properties;i&&void 0!==i.count&&i.count!==r.length&&(e[t].geometry.setElements(r),i.count=r.length)}}return super.addMesh(t,e,n)}startMeshCollision(t){const{meshKey:e}=t.properties,{renderer:n}=this.Pr,r=n.isForeground(t instanceof Oi?t.meshes[0]:t);if(t.properties.isForeground=r,t instanceof Oi&&t.meshes.length)for(let i=0;i<t.meshes.length;i++)t.meshes[i].properties.isForeground=r;this.Tr=performance.now(),this.kr=this.Or(),this.Ir=this.Fr(e)}endMeshCollision(t){const e=this.Cr.tags[t];if(this.kr&&e&&this.Ir){const t=this.getMap();this.Er||(this.Er=new i["f"](0,0),this.Dr=new i["f"](0,0)),e.anchor0=t.containerPointToCoord(this.Nr,this.Er),e.anchor1=t.containerPointToCoord(this.Lr,this.Dr),e.anchor0.z=t.getZoom(),e.anchor0.width=t.width,e.anchor0.height=t.height,e.anchor0.pitch=t.getPitch()}this.getMap().collisionFrameTime+=performance.now()-this.Tr}Fr(t){const e=this.getMap(),n=e.getZoom(),r=e.getPitch(),[i,s]=this.Rr(t);return!i||!s||i.z!==n||i.width!==e.width||i.height!==e.height||i.pitch!==r||i.distanceTo(this.Nr)>3||s.distanceTo(this.Lr)>3}Hr(){const t=this.getMap();this.zr={},this.Nr=new i["A"](t.width/3,t.height/2),this.Lr=new i["A"](2*t.width/3,t.height/2),delete this.kr,this.Cr||(this.Cr={tags:{}}),this.Pr={layer:this.layer,renderer:this.layer.getRenderer(),frameTimestamp:this.layer.getRenderer().getFrameTimestamp(),map:this.getMap(),zoom:t.getZoom(),collisionTags:this.Cr.tags,isEnableUniquePlacement:this.isEnableUniquePlacement()}}Vr(){}Ur(t,e){const n=this.Cr;return n.tags[t]&&n.tags[t][e]}jr(t,e,n){const r=this.Cr;r.tags[t]=r.tags[t]||[],r.tags[t][e]=n}Or(){const t=this.getMap();if(!t.isInteracting())return!0;const e=this.layer.options.collisionFrameLimit;return t.collisionFrameTime<=e}Rr(t){const e="__meshAnchorKey".trim(),n=this.Cr.tags[t];if(n&&n.anchor0){const{anchor0:t,anchor1:r}=n,i=t[e]=t[e]||t.x+","+t.y,s=r[e]=r[e]||r.x+","+r.y;let o=this.zr[i],a=this.zr[s];if(!o||!a){const e=this.getMap();o=this.zr[i]=e.coordToContainerPoint(t),a=this.zr[s]=e.coordToContainerPoint(r)}return o.z=t.z,Ni[0]=o,Ni[1]=a,o.width=t.width,o.height=t.height,Ni}return Ni[0]=Ni[1]=null,Ni}updateBoxCollisionFading(t,e,n,r,i){const{layer:s,renderer:o,zoom:a,collisionTags:l,isEnableUniquePlacement:h}=this.Pr,{meshKey:c,isForeground:u}=e.properties;if(h&&this.Br(c,i))return!1;const f=n.length;let d=l[c]&&l[c][i];const p=d,A=this.Gr&&d;if((!A||0===d.collides)&&t){const t=A&&0===d.collides;if(this.kr||t)if((this.Ir||d&&d.z!==a)&&(d=null),d){if(d.boxes&&d.boxes.length){const{boxes:t,isAllowOverlap:e}=d;let n=0;if(!e){let e=0;for(let r=0;r<t.length;r++)if(!n){const i=this.isCollides(t[r]);if(-1===i)e++;else if(1===i){n=1;break}}e===t.length&&(n=-1)}d.collides=n}}else{d=p||{collides:0,boxes:[]},d.boxes.length=0,d.z=a;let t=0;for(let e=0;e<f;e++){const{mesh:s,allElements:o,boxCount:a,start:l,end:h}=n[e],c=this.Wr(s,o,a,l,h,r,i);c.isAllowOverlap&&(d.isAllowOverlap=1),0===t&&(t=c.collides),c.boxes&&d.boxes.push(...c.boxes)}d.collides=t,this.jr(c,i,d)}}let g=t&&d&&0===d.collides,m=1,y=!1;if(this.sceneConfig.fading){const t=this.Xr(e);if(this.Yr)t[i]=g?1:-1;else if(u&&delete e.$r,m=this.qr(u,g,t,i),u?(m>0&&(g=!0),y=this.isBoxFading(e,i),y&&this.setToRedraw()):g||(this.Jr(t,i),m=0),g){const n=e.$r;if(n&&1===m&&t[i]>0){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;Qt(e)&&(e=Ei),Qt(t)&&(t=ki);const r=Wt(1-(o.getFrameTimestamp()-n-t)/e,0,1);m*=r,r>0&&this.setToRedraw()}}}if(d&&s.options.debugCollision&&this.addCollisionDebugBox(d.boxes,d.collides?0:1),g||y){const{mesh:t,start:e}=n[0],r=this.getSymbol(t.properties.symbolIndex);!this.Zr(r,t,e)&&d&&d.boxes&&this.Kr(d.boxes,t)}if(g){const t=Ri[0]=255*m;for(let e=0;e<f;e++){const{mesh:r,allElements:i,start:s,end:o,boxIndex:a}=n[e];this.setCollisionOpacity(r,i,t,s,o,a)}}return g&&m>0}isMeshIterable(){return!0}setCollisionOpacity(t,e,n,r,i){const s=e[r],o=e[i-1];this.Qr(t,n,s,o)}Qr(t,e,n,r){const{aOpacity:i}=t.geometry.properties;if(!i)return;const s=n;if(i[s]!==e){const t=r;for(let n=s;n<=t;n++)i[n]=e;i.dirty=!0}}isBoxFading(t,e){const{frameTimestamp:n}=this.Pr;let r=this.sceneConfig.fadingDuration;return Qt(r)&&(r=Ei),n-Math.abs(this.Xr(t)[e])<r}Wr(t,e,n,r,i,s,o){const a=this.getSymbol(t.properties.symbolIndex),l=this.Zr(a,t,e[r]),h=this.ts(a,t,e[r]);if(!this.isEnableCollision()||l&&h)return Di;const c=this.isBoxCollides(t,e,n,r,i,s,o);return h&&(c.collides=0,c.isAllowOverlap=1),c}Zr(t,e,n){if(!this.isEnableCollision())return!0;const r=e.geometry.properties.aOverlap;if(!r)return 1==+t[this.propIgnorePlacement];const i=r[n],s=i%8;return i<2?1==+t[this.propIgnorePlacement]:s%2}ts(t,e,n){if(!this.isEnableCollision())return!0;const r=e.geometry.properties.aOverlap;if(!r)return 1==+t[this.propAllowOverlap];const i=r[n],s=i>>2;return i<2?1==+t[this.propAllowOverlap]:s%2}Kr(t){if(Array.isArray(t[0]))for(let e=0;e<t.length;e++)this.insertCollisionBox(t[e]);else this.insertCollisionBox(t)}qr(t,e,n,r){let{fadingDuration:i,fadeInDelay:s,fadeOutDelay:o}=this.sceneConfig;Qt(i)&&(i=Ei),Qt(s)&&(s=Pi),Qt(o)&&(o=ki);const{frameTimestamp:a}=this.Pr;let l=n[r],h=e?1:0;if(!l)return e&&t&&(n[r]=a+s),0;if(a<Math.abs(l)&&(!e&&l>0||e&&l<0)){const t=a-i;n[r]=l=e?t:-t}return a-Math.abs(l)<i?h=l>0?(a-l)/i:1-(a+l)/i:e?(l<0&&(n[r]=l=a+s),h=(a-l)/i):(l>0&&(n[r]=l=-(a+o)),h=1-(a+l)/i),(h<0||h>1)&&(h=Wt(h,0,1)),h}Xr(t){this.es||(this.es={});const{meshKey:e}=t.properties;if(!this.es[e]){const{frameTimestamp:t}=this.Pr;this.es[e]={timestamp:t}}return this.es[e]}ns(t){if(!this.rs)return void(this.rs=t);const e=this.scene.getMeshes();if(e&&e.length){for(let n=0;n<e.length;n++){const r=this.Xr(e[n]);r.timestamp<this.rs?delete e[n]._fading_timestamps:r.timestamp=t}this.rs=t}}Jr(t,e){if(!t)return;const{frameTimestamp:n}=this.Pr;let{fadingDuration:r}=this.sceneConfig;Qt(r)&&(r=Ei),t[e]=-(n-r-1)}deleteMesh(t,e){if(t){if(Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].properties.meshKey;this.Cr&&delete this.Cr.tags[n],this.es&&delete this.es[n]}else{const e=t.properties.meshKey;this.Cr&&delete this.Cr.tags[e],this.es&&delete this.es[e]}super.deleteMesh(t,e)}}delete(t){this.ss&&(this.ss.geometry.dispose(),this.os.dispose(),this.ss.dispose(),delete this.ss,delete this.os,delete this.as),delete this.Cr,super.delete(t)}isCollides(t){const e=this.layer,n=e.getMap(),i=n.getDevicePixelRatio();if(r["q"].scale(Li,t,1/i),n.isOffscreen(Li))return-1;const s=e.getCollisionIndex(),o=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;return o&&(t=Ui(Li,t,o)),+s.collides(t)}insertCollisionBox(t){const e=this.layer,n=e.getCollisionIndex(),r=this.sceneConfig.collisionBufferSize||e.options.collisionBufferSize||0;let i=t;r&&(i=t.ls=t.ls||[],t=Ui(i,t,r)),n.insertBox(i)}addCollisionDebugBox(t,e){if(t&&t.length)if(Array.isArray(t[0]))for(let n=0;n<t.length;n++){const r=t[n];this.hs(r,e)}else this.hs(t,e)}hs(t,e){if(!t)return;const n=this.us=this.us||{aPosition:[],aVisible:[],indices:[]},i=this.sceneConfig.collisionBufferSize||this.layer.options.collisionBufferSize||0;i&&(t=Ui(Li,t,i));const s=this.getMap(),o=s.getDevicePixelRatio();if(r["q"].scale(Li,t,1/o),s.isOffscreen(Li))return;const a=n.aPosition.length/2;n.aPosition.push(t[0],t[1],t[2],t[1],t[2],t[3],t[0],t[3]),n.aVisible.push(e,e,e,e),n.indices.push(a,a+1,a+1,a+2,a+2,a+3,a+3,a)}updateCollision(t){super.updateCollision(t),this.Hr(),this.cs(),this.fs&&this.fs.length&&(this.ds(),this.fs&&(this.setToRedraw(),this.scene.addMesh(this.fs))),(this.getMap().isZooming()||this.fs&&this.fs.length)&&(this.ps(),this.ms(this.scene.getMeshes()))}paint(t){const e=super.paint(t);return this.ys(t),!1===this.kr&&this.setToRedraw(),e}shouldIgnoreBackground(){return!this.getMap().isZooming()&&!this.fs}cs(){const t=this.getMap(),e=t.isZooming();if(!e&&this.Gr){const t=this.layer.getRenderer();this.fs=this.scene.getMeshes().filter(e=>!t.isForeground(e)&&!e.properties.isLinePlacement)}else e&&!this.Gr&&(this.gs=t.getResolution());if(e)this.vs&&(clearTimeout(this.vs),delete this.Yr,delete this.vs),this.Yr=this.gs&&t.getResolution()>this.gs;else if(this.Gr&&!this.vs){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;Qt(t)&&(t=ki),Qt(e)&&(e=Ei),this.vs=setTimeout(()=>{delete this.Yr,delete this.vs},t+e+1)}this.Gr=e}ys(t){if(!this.us||!this.layer.options.debugCollision)return;this.as||this.xs();const{aPosition:e,aVisible:n,indices:i}=this.us;if(!this.ss){const t=new r["m"].Geometry({aPosition:[],aVisible:[]},[],0,{positionSize:2,primitive:"lines"});this.ss=new r["m"].Mesh(t),this.bs=new r["m"].Scene,this.bs.addMesh(this.ss)}const s=this.ss.geometry;s.updateData("aPosition",new Float32Array(e)),s.updateData("aVisible",new Uint8Array(n)),s.setElements(i),this.as.render(this.os,{size:[this.canvas.width,this.canvas.height]},this.bs,this.getRenderFBO(t)),delete this.us}xs(){const t=this.regl;this.as=new r["m"].Renderer(t);const e=this.canvas,n={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1};this.os=new r["m"].MeshShader({vert:"attribute vec2 aPosition;\nattribute float aVisible;\nuniform vec2 size;\nvarying vec4 vColor;\nvoid main() {\n  vec2 c = (aPosition / size - .5) * 2. * vec2(1., -1.);\n  gl_Position = vec4(c, .0, 1.);\n  vColor = mix(vec4(1., .0, .0, 1.5) * .5, vec4(.0, 1., .0, 1.) * .4, aVisible);\n}",frag:"precision mediump float;\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor.rgb, .5);\n}",uniforms:["size"],extraCommandProps:{viewport:n,depth:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}})}ds(){let{fadeOutDelay:t,fadingDuration:e}=this.sceneConfig;Qt(t)&&(t=ki),Qt(e)&&(e=Ei);const n=this.layer.getRenderer(),r=n.getCurrentTileZoom(),i=n.getFrameTimestamp(),s=[];for(let o=0;o<this.fs.length;o++){const a=this.fs[o],l=a.properties.tile;!a.$r&&n.isBackTile(l.id)&&(a.$r=i);const h=l.z-r>0?2*(l.z-r)-1:2*(r-l.z);a.properties.level=h,n.isForeground(a)||a.$r&&i-a.$r>t+e?delete a.$r:s.push(a)}delete this.fs,s.length&&(this.fs=s)}isEnableCollision(){return this.layer.options.collision&&!!this.sceneConfig.collision}isEnableUniquePlacement(){return this.isEnableCollision()&&this.sceneConfig.uniquePlacement}isMeshUniquePlaced(t){return this.isMeshIterable(t)}ps(){if(!this.isEnableUniquePlacement())return;const t=this.scene.getMeshes(),e=(t,e,n,r)=>{const{start:i,end:s}=e[0],o=t.geometry.properties,a=o.elements;let l=o.uniquePlacements;if(l||(l=o.uniquePlacements=[]),void 0===l[r]){const e=this.getUniqueEntryKey(t,a[i],r);l[r]=e?{key:e,index:r,start:a[i],end:a[s-1]}:null}};for(let n=0;n<t.length;n++){const r=t[n];this.isMeshUniquePlaced(r)&&this.forEachBox(r,e)}}ms(t){if(!this.isEnableUniquePlacement())return;const e=this.getMap().getZoom();let n=!this.As||this.ws!==e;if(!n)for(let s=0;s<t.length;s++)if(!this.As[t[s].properties.meshKey]){n=!0;break}if(!n)return;this.ws=e,this._s={},this.As={},t=t.sort(Hi);const r=this.getMap().getGLScale(),i={};for(let s=0;s<t.length;s++){const e=t[s];if(!e.geometry)continue;const{meshKey:n}=e.properties;this.As[n]=1;const{uniquePlacements:o}=e.geometry.properties;if(o)for(let t=0;t<o.length;t++){if(!o[t])continue;const{key:n,index:s}=o[t],a=this.Xr(e),l=Bi(n,r),h=i[l];if(h){const t=h.length,n=h[t-3].properties.meshKey,r=h[t-2],i=h[t-1];this._s[n]=this._s[n]||{},this._s[n][i]=1,this.Ss(a,s,r,i),h.push(e,a,s)}else i[l]=[e,a,s]}}for(const s in i){const t=i[s];if(t.length<=6)continue;const e=t.length,n=t[e-2][t[e-1]];if(t[1][t[2]]!==n)for(let r=0;r<e-6;r+=3)t[r+1][t[r+2]]=n}}Ss(t,e,n,r){if(void 0!==n[r])if(void 0===t[e])t[e]=n[r];else{let i=t[e];Math.abs(n[r])>Math.abs(i)?t[e]=n[r]:n[r]=t[e]}else void 0!==t[e]&&(n[r]=t[e])}Br(t,e){return this._s&&this._s[t]&&this._s[t][e]}Ms(t,e){const{symbolIndex:n}=t.properties,r=n.type||0;let i=t.properties._collidesBoxes;i||(i=t.properties._collidesBoxes=[]);let s=i[n.index];s||(s=t.properties._collidesBoxes=[]),s[r]||(s[r]=[]),s=s[r];const o=e/6;if(!s[o]){const t=[];s[o]={boxes:t,collision:{boxes:t}}}return s[o]}Ps(t){let e=this.Ts;if(e||(e=this.Ts=[]),!e[t]){e[t]=[];for(let n=0;n<t;n++)e[t][n]={}}return e[t]}ks(t){return!t||!t.geometry||!(!t.geometry.properties.glyphAtlas||!t.material.get("isHalo")||t.geometry.data.aTextHaloRadius&&t.geometry.properties.hasHalo)&&(!(!t.geometry.data.aTextHaloRadius||t.geometry.properties.hasHalo)||!this.getSymbol(t.geometry.properties.symbolIndex).textHaloRadius)}}function Bi(t,e){return Math.round(t[0]/e/10)*Math.round(t[1]/e/10)*(t[2]?Math.round(t[2]/10):1)+"-"+t[3]}function Hi(t,e){const n=e.properties.level-t.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}function Ui(t,e,n){return t[0]=e[0]-n,t[1]=e[1]-n,t[2]=e[2]+n,t[3]=e[3]+n,t}var ji="#include <gl2_vert>\n#define SHADER_NAME MARKER\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aShape;\nattribute vec2 aTexCoord;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_MARKER_WIDTH\nattribute float aMarkerWidth;\n#else\nuniform float markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nattribute float aMarkerHeight;\n#else\nuniform float markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nattribute float aMarkerDx;\n#else\nuniform float markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nattribute float aMarkerDy;\n#else\nuniform float markerDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float rotateWithMap;\n#endif\nuniform float flipY;\n#ifdef HAS_ROTATION\nattribute float aRotation;\n#else\nuniform float markerRotation;\n#endif\n#ifdef HAS_PAD_OFFSET\nattribute float aPadOffsetX;\nattribute float aPadOffsetY;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerPerspectiveRatio;\nuniform vec2 iconSize;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#include <vt_position_vert>\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vOpacity;\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_MARKER_WIDTH\nfloat d = aMarkerWidth;\n#else\nfloat d = markerWidth;\n#endif\n#ifdef HAS_MARKER_HEIGHT\nfloat e = aMarkerHeight;\n#else\nfloat e = markerHeight;\n#endif\n#ifdef HAS_MARKER_DX\nfloat f = aMarkerDx;\n#else\nfloat f = markerDx;\n#endif\n#ifdef HAS_MARKER_DY\nfloat h = aMarkerDy;\n#else\nfloat h = markerDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat i = aPitchAlign;\n#else\nfloat i = pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat j = aRotationAlign;\n#else\nfloat j = rotateWithMap;\n#endif\ngl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float k = gl_Position.w;\n  float l;\n  if(isRenderingTerrain == 1. && i == 1.) {\n    l = 1.;\n  } else {\n    float m = (1. - cameraToCenterDistance / k) * markerPerspectiveRatio;\n    l = clamp(.5 + .5 * (1. - m), .0, 4.);\n  }\n#ifdef HAS_ROTATION\nfloat n = -aRotation / 9362. - mapRotation * j;\n#else\nfloat n = -markerRotation - mapRotation * j;\n#endif\nif(i == 1.) {\n    n += mapRotation;\n  }\n  float o = sin(n);\n  float u = cos(n);\n  mat2 v = mat2(u, -1. * o, o, u);\n  vec2 A = (aShape / 10.0);\n  if(i == 1. && flipY == .0) {\n    A *= vec2(1., -1.);\n  }\n#ifdef HAS_PAD_OFFSET\nA = (A / iconSize * vec2(d, e) + vec2(aPadOffsetX - 1., aPadOffsetY)) * layerScale;\n#else\nA = A / iconSize * vec2(d, e) * layerScale;\n#endif\nA = v * A;\n  if(i == .0) {\n    vec2 B = A * 2. / canvasSize;\n    gl_Position.xy += B * l * k;\n  } else {\n    float C;\n    if(isRenderingTerrain == 1.) {\n      C = 1.;\n    } else {\n      C = k / cameraToCenterDistance;\n    }\n    vec2 B = A;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(B, .0) * tileRatio / zoomScale * C * l, 1.);\n  }\n  gl_Position.xy += vec2(f, -h) * 2. / canvasSize * k;\n#ifndef PICKING_MODE\nvTexCoord = aTexCoord / texSize;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool D = aOpacity == 255.;\n#else\nbool D = true;\n#endif\nfbo_picking_setData(gl_Position.w, D);\n#endif\n}";const Vi=[],Gi=[],qi=[],Wi=[],Xi=[],Qi=[];function Yi(t,e,n,i,s,o,a,l,h,c,u,f,d,p){const{tileRatio:A,tileResolution:g}=h,m=A/(g/c.getResolution())*(u/c.cameraToCenterDistance)*f;r["o"].scale(n,n,m),r["o"].scale(i,i,m),r["o"].scale(s,s,m),r["o"].scale(o,o,m),r["p"].set(Vi,n[0],n[1],d?n[2]/p:0),r["p"].set(Gi,i[0],i[1],d?i[2]/p:0),r["p"].set(qi,s[0],s[1],d?s[2]/p:0),r["p"].set(Wi,o[0],o[1],d?o[2]/p:0),r["p"].add(Vi,Vi,e),r["p"].add(Gi,Gi,e),r["p"].add(qi,qi,e),r["p"].add(Wi,Wi,e),zr(n,Vi,a,c.width,c.height),zr(i,Gi,a,c.width,c.height),zr(s,qi,a,c.width,c.height),zr(o,Wi,a,c.width,c.height),r["o"].set(Xi,Math.min(n[0],i[0],s[0],o[0]),Math.min(n[1],i[1],s[1],o[1])),r["o"].set(Qi,Math.max(n[0],i[0],s[0],o[0]),Math.max(n[1],i[1],s[1],o[1])),r["q"].set(t,Xi[0]+l[0],Xi[1]+l[1],Qi[0]+l[0],Qi[1]+l[1])}function Zi(t,e,n,i,s,o,a,l){1!==l&&(r["o"].scale(n,n,l),r["o"].scale(i,i,l),r["o"].scale(s,s,l),r["o"].scale(o,o,l)),r["o"].set(Xi,Math.min(n[0],i[0],s[0],o[0]),Math.min(n[1],i[1],s[1],o[1])),r["o"].set(Qi,Math.max(n[0],i[0],s[0],o[0]),Math.max(n[1],i[1],s[1],o[1])),r["q"].set(t,e[0]+Xi[0]+a[0],e[1]+Xi[1]-a[1],e[0]+Qi[0]+a[0],e[1]+Qi[1]-a[1])}function Ki(t,e,n,i,s){e-=n*i,1===s&&(e+=n);const o=Math.sin(e),a=Math.cos(e);return r["i"].set(t,a,-o,o,a)}const Ji=[],$i=[],ts=[],es=[],ns=[],rs=[],is=[],ss=[],os=[1,-1],as=[1,1];function ls(t,e,n,i,s){const o=e.material.uniforms,a=s.cameraToCenterDistance,l=e.geometry.properties,h=this.getSymbol(l.symbolIndex),c=e.geometry.desc.positionSize,u=l.aAnchor,f=r["p"].set(Ji,u[n*c],u[n*c+1],2===c?0:u[n*c+2]),{aTerrainAltitude:d}=l;if(d){const t=100*d[2*n];t&&(f[2]+=t)}let p=zr($i,f,i,s.width,s.height);const A=p[2];let g=1;o.markerPerspectiveRatio&&(g=Wt(.5+.5*(1-(1-a/A)*o.markerPerspectiveRatio),0,4));const{aShape:m,aMarkerDx:y,aMarkerDy:v,aMarkerWidth:x,aMarkerHeight:b,aPitchAlign:w,aRotationAlign:_,aRotation:M}=l,T=y?y[n]:h.markerDx,S=v?v[n]:h.markerDy,I=w?w[n]:o.pitchWithMap,C=_?_[n]:o.rotateWithMap,O=r["o"].set(ss,T||0,-(S||0));let E=r["o"].set(es,m[2*n]/10,m[2*n+1]/10),P=r["o"].set(ns,m[2*n+2]/10,m[2*n+3]/10),k=r["o"].set(rs,m[2*n+4]/10,m[2*n+5]/10),R=r["o"].set(is,m[2*n+6]/10,m[2*n+7]/10);0===o.flipY&&1===I&&(r["o"].multiply(E,E,os),r["o"].multiply(P,P,os),r["o"].multiply(k,k,os),r["o"].multiply(R,R,os));const[N,D]=fi(e.geometry);let F=x?x[n]:h.markerWidth;Qt(F)&&(F=N||15);let L=b?b[n]:h.markerHeight;Qt(L)&&(L=D||15);const z=r["o"].set(as,F/2048,L/2048);r["o"].mul(E,E,z),r["o"].mul(P,P,z),r["o"].mul(k,k,z),r["o"].mul(R,R,z);const B=-(M?M[n]/9362:-(h.markerRotation||0)*Math.PI/180),H=s.getBearing()*Math.PI/180;if(H*C||B){const t=Ki(ts,B,H,C,I);E=r["o"].transformMat2(E,E,t),P=r["o"].transformMat2(P,P,t),k=r["o"].transformMat2(k,k,t),R=r["o"].transformMat2(R,R,t)}1===I?Yi(t,f,E,P,k,R,i,O,o,s,A,g):(r["o"].multiply(E,E,os),r["o"].multiply(P,P,os),r["o"].multiply(k,k,os),r["o"].multiply(R,R,os),Zi(t,p,E,P,k,R,O,g));const U=this.getMap().getDevicePixelRatio();return 1!==U&&(t[0]*=U,t[1]*=U,t[2]*=U,t[3]*=U),t}const hs=[],cs=[],us=[],fs=[],ds=[],ps=[],As=[1,-1];function gs(t,e,n,i,s,o,a,l,h){const c=i.material.uniforms,u=h.cameraToCenterDistance,f=i.geometry.properties,d=this.getSymbol(f.symbolIndex),p="line"===d.textPlacement&&!re(d),A=n[2];let g=1;c.textPerspectiveRatio&&(g=Wt(.5+.5*(1-(1-u/A)*c.textPerspectiveRatio),0,4));const{aTextDx:m,aTextDy:y,aPitchAlign:v,aRotationAlign:x,aRotation:b}=i.geometry.properties,w=m?m[a]:d.textDx,_=y?y[a]:d.textDy,M=v?v[a]:c.pitchWithMap,T=x?x[a]:c.rotateWithMap,S=r["o"].set(ps,w||0,-(_||0));if(p){const{aOffset:i,aShape:s}=f,o=i.length!==s.length;let u,d,p,m;if(o?(u=r["p"].set(cs,i[3*a]/10,i[3*a+1]/10,i[3*a+2]/10),d=r["p"].set(us,i[3*a+3]/10,i[3*a+4]/10,i[3*a+5]/10),p=r["p"].set(fs,i[3*a+6]/10,i[3*a+7]/10,i[3*a+8]/10),m=r["p"].set(ds,i[3*a+9]/10,i[3*a+10]/10,i[3*a+11]/10)):(u=r["o"].set(cs,i[2*a]/10,i[2*a+1]/10),d=r["o"].set(us,i[2*a+2]/10,i[2*a+3]/10),p=r["o"].set(fs,i[2*a+4]/10,i[2*a+5]/10),m=r["o"].set(ds,i[2*a+6]/10,i[2*a+7]/10)),1===M){const n=St(h.getResolution(),h);Yi(t,e,u,d,p,m,l,S,c,h,A,g,o,n)}else r["o"].multiply(u,u,As),r["o"].multiply(d,d,As),r["o"].multiply(p,p,As),r["o"].multiply(m,m,As),Zi(t,n,u,d,p,m,S,g)}else{const{aShape:i}=f;let o=r["o"].set(cs,i[2*a]/10,-i[2*a+1]/10),u=r["o"].set(us,i[2*a+2]/10,-i[2*a+3]/10),m=r["o"].set(fs,i[2*a+4]/10,-i[2*a+5]/10),y=r["o"].set(ds,i[2*a+6]/10,-i[2*a+7]/10);0===c.flipY&&1===M&&(r["o"].multiply(o,o,As),r["o"].multiply(u,u,As),r["o"].multiply(m,m,As),r["o"].multiply(y,y,As));const v=b?b[a]/9362:(d.textRotation||0)*Math.PI/180,x=p?0:h.getBearing()*Math.PI/180;if(v||x){const t=Ki(hs,v,x,T,M);o=r["o"].transformMat2(o,o,t),u=r["o"].transformMat2(u,u,t),m=r["o"].transformMat2(m,m,t),y=r["o"].transformMat2(y,y,t)}const w=s/24;r["o"].scale(o,o,w),r["o"].scale(u,u,w),r["o"].scale(m,m,w),r["o"].scale(y,y,w),1===M?Yi(t,e,o,u,m,y,l,S,c,h,A,g):Zi(t,n,o,u,m,y,S,g)}o=o||0,t[0]-=o+1,t[1]-=o+1,t[2]+=o+1,t[3]+=o+1;const I=this.getMap().getDevicePixelRatio();return 1!==I&&(t[0]*=I,t[1]*=I,t[2]*=I,t[3]*=I),t}function ms(t,e,n){const i=e.geometry.desc.positionSize,{aAnchor:s,aAltitude:a,aTerrainAltitude:l}=e.geometry.properties,h=n*i;if(a?r["p"].set(t,s[h],s[h+1],a[n]):3===i?o["i"].unpackPosition(t,s[h],s[h+1],s[h+2]):r["p"].set(t,s[h],s[h+1],0),l){const e=100*l[2*n];e&&(t[2]+=e)}return t}const ys={textFill:[0,0,0,1],textOpacity:1,textPitchAlignment:0,textRotationAlignment:0,textHaloRadius:0,textHaloFill:[1,1,1,1],textHaloBlur:0,textHaloOpacity:1,textPerspectiveRatio:0,textSize:14,textDx:0,textDy:0,textRotation:0};function vs(t,e,n,i,s,o,a,l,h){const c=[];if(e.isDisposed()||0===e.data.aPosition.length)return c;const u=e.properties.glyphAtlas;if(!u)return c;if(0===i.textSize||0===i.textOpacity)return c;if(_r(e,i,o),!e.properties.aCount){xs.call(this,e,a||h,l);const{aTextSize:t,aTextDx:n,aTextDy:r,aPitchAlign:i,aRotationAlign:s,aRotation:o,aOverlap:c,aAltitude:u}=e.data;if(t){const n=(wr+"aTextSize").trim();e.properties.aTextSize=e.properties[n]||new t.constructor(t)}if(n){const t=(wr+"aTextDx").trim();e.properties.aTextDx=e.properties[t]||new n.constructor(n)}if(r){const t=(wr+"aTextDy").trim();e.properties.aTextDy=e.properties[t]||new r.constructor(r)}if(i){const t=(wr+"aPitchAlign").trim();e.properties.aPitchAlign=e.properties[t]||new i.constructor(i)}if(s){const t=(wr+"aRotationAlign").trim();e.properties.aRotationAlign=e.properties[t]||new s.constructor(s)}if(o){const t=(wr+"aRotation").trim();e.properties.aRotation=e.properties[t]||new o.constructor(o)}if(c){const t=(wr+"aOverlap").trim();e.properties.aOverlap=e.properties[t]||new c.constructor(c)}if(u){const t=(wr+"aAltitude").trim();e.properties.aAltitude=e.properties[t]||new u.constructor(u)}}const f=hi(t,u,!1),d={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio,texture:f,texSize:[u.width,u.height]};bs(e,d,s);let p=!1;s.textOpacity<1&&(p=!0),e.properties.memorySize=e.getMemorySize(),e.generateBuffers(t,{excludeElementsInVAO:!0});const A=new r["m"].Material(d,ys),g=new r["m"].Mesh(e,A,{disableVAO:!0,transparent:p,castShadow:!1,picking:!0});if(g.setLocalTransform(n),g.setUniform("alphaTest",.01),d.isHalo&&(g.properties.isHalo=!0),a&&g.setDefines({ENABLE_COLLISION:1}),c.push(g),d.isHalo){const t={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio,texture:f,texSize:[u.width,u.height],isHalo:0};bs(e,t,s);const i=new r["m"].Material(t,ys),o=new r["m"].Mesh(e,i,{disableVAO:!0,transparent:p,castShadow:!1,picking:!0});o.setUniform("alphaTest",.01),o.properties.haloMesh=g,Object.defineProperty(o.properties,"textSize",{enumerable:!0,get:function(){return t.textSize}}),a&&o.setDefines({ENABLE_COLLISION:1}),o.setLocalTransform(n),c.push(o)}return c.forEach(t=>{const n=t.defines||{};e.data.aTextFill&&(n.HAS_TEXT_FILL=1),e.data.aTextSize&&(n.HAS_TEXT_SIZE=1),e.data.aColorOpacity&&(n.HAS_OPACITY=1),e.data.aTextHaloFill&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_FILL=1),e.data.aTextHaloRadius&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_RADIUS=1),e.data.aTextHaloOpacity&&t.material.uniforms.isHalo&&(n.HAS_TEXT_HALO_OPACITY=1),e.data.aTextDx&&(n.HAS_TEXT_DX=1),e.data.aTextDy&&(n.HAS_TEXT_DY=1),e.data.aPitchAlign&&(n.HAS_PITCH_ALIGN=1),e.data.aRotationAlign&&(n.HAS_ROTATION_ALIGN=1),e.data.aRotation&&(n.HAS_ROTATION=1),e.data.aAltitude&&(n.HAS_ALTITUDE=1),e.properties.aOffset&&e.properties.aShape&&e.properties.aOffset.length!==e.properties.aShape.length&&(n.HAS_OFFSET_Z=1),t.setDefines(n),t.properties.symbolIndex=e.properties.symbolIndex}),c}function xs(t,e,n){const r=this.getSymbol(t.properties.symbolIndex),i="line"===t.properties.textPlacement&&!re(r),{aPosition:s,aShape:o}=t.data,a=s.length/t.desc.positionSize;if(t.properties.aPickingId=t.data.aPickingId,t.properties.aCount=t.data.aCount,delete t.data.aCount,(e||i)&&(t.properties.aAnchor=s,t.properties.aShape=o),t.properties.visElemts||(t.properties.elements=t.elements,t.properties.visElemts=new t.elements.constructor(t.elements.length)),i){const{aVertical:e,aSegment:n,aGlyphOffset:r,aPitchRotation:i}=t.data,s=!!i;t.properties.aGlyphOffset=r,t.properties.aPitchRotation=i,t.properties.aSegment=n,t.properties.aVertical=e,delete t.data.aSegment,delete t.data.aVertical,delete t.data.aGlyphOffset,delete t.data.aPitchRotation;const a=o.length/2*(s?3:2);t.data.aOffset={usage:"dynamic",data:new Int16Array(a)},t.properties.aOffset=new Int16Array(a)}if(e){t.data.aOpacity={usage:"dynamic",data:new Uint8Array(a)},t.properties.aOpacity=new Uint8Array(a),n&&(t.properties.aOpacity.fill(255,0),t.data.aOpacity.data.fill(255,0));const{aTextHaloRadius:e}=t.data;if(e&&!t.properties.aTextHaloRadius){const n=(wr+"aTextHaloRadius").trim();t.properties.aTextHaloRadius=t.properties[n]||new e.constructor(e)}}}function bs(t,e,n){void 0===e.isHalo&&(e.isHalo=1),Zt(e,"textOpacity",n,"textOpacity",ys.textOpacity),Zt(e,"textFill",n,"textFill",ys.textFill,$t()),Zt(e,"textHaloFill",n,"textHaloFill",ys.textHaloFill,$t()),Zt(e,"textHaloBlur",n,"textHaloBlur",ys.textHaloBlur),Zt(e,"textHaloRadius",n,"textHaloRadius",ys.textHaloRadius),Zt(e,"textHaloOpacity",n,"textHaloOpacity",ys.textHaloOpacity),Zt(e,"textPerspectiveRatio",n,"textPerspectiveRatio",ys.textPerspectiveRatio,e=>"line"===t.properties.textPlacement?1:e),Zt(e,"rotateWithMap",n,"textRotationAlignment",ys.textRotationAlignment,t=>+("map"===t)),Zt(e,"pitchWithMap",n,"textPitchAlignment",ys.textPitchAlignment,t=>+("map"===t)),Zt(e,"textSize",n,"textSize",ys.textSize),Zt(e,"textDx",n,"textDx",ys.textDx),Zt(e,"textDy",n,"textDy",ys.textDy),Zt(e,"textRotation",n,"textRotation",ys.textRotation,t=>t*Math.PI/180)}function ws(t,e){const n=[];return{uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!1,mask:255,func:{cmp:"<",ref:(t,e)=>2*e.level+(e.isHalo||0)+1,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,range:e.depthRange||[0,1],func:e.depthFunc||"always",mask:!1},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}function _s(t,e){const n=Object(s["b"])(e.textFill),r=Object(s["b"])(e.textSize),i=Object(s["b"])(e.textHaloFill),o=Object(s["b"])(e.textHaloRadius),a=Object(s["b"])(e.textHaloOpacity),h=Object(s["b"])(e.textDx),c=Object(s["b"])(e.textDy),u=Object(s["b"])(e.textOpacity),f=Object(s["e"])(e.textPitchAlignment),d=Object(s["e"])(e.textRotationAlignment),p=Object(s["b"])(e.textRotation),A=Object(s["e"])(e.textAllowOverlapFn),g=Object(s["e"])(e.textIgnorePlacement),m={},y=new Int16Array(1),v=new Uint16Array(1);return[{attrName:"aTextFill",symbolName:"textFill",define:"HAS_TEXT_FILL",type:Uint8Array,width:4,evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=m[i]=m[i]||l()(i).unitArray()),i=Jt(i),i}},{attrName:"aTextSize",symbolName:"textSize",define:"HAS_TEXT_SIZE",type:Uint8Array,width:1,evaluate:(e,n)=>{let i=r(t.getZoom(),e)||ys.textSize;return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e)),y[0]=i,y[0]}},{attrName:"aTextHaloFill",symbolName:"textHaloFill",define:"HAS_TEXT_HALO_FILL",type:Uint8Array,width:4,evaluate:e=>{let n=i(t.getZoom(),e);return Array.isArray(n)||(n=m[n]=m[n]||l()(n).unitArray()),n=Jt(n),n}},{attrName:"aTextHaloRadius",symbolName:"textHaloRadius",define:"HAS_TEXT_HALO_RADIUS",type:Uint8Array,width:1,evaluate:e=>{const n=o(t.getZoom(),e);return y[0]=n,y[0]}},{attrName:"aTextHaloOpacity",symbolName:"textHaloOpacity",define:"HAS_TEXT_HALO_OPACITY",type:Uint8Array,width:1,evaluate:e=>{const n=a(t.getZoom(),e);return y[0]=n,y[0]}},{attrName:"aTextDx",symbolName:"textDx",define:"HAS_TEXT_DX",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=h(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),y[0]=r,y[0]}},{attrName:"aTextDy",symbolName:"textDy",define:"HAS_TEXT_DY",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=c(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),y[0]=r,y[0]}},{attrName:"aColorOpacity",symbolName:"textOpacity",define:"HAS_OPACITY",type:Uint8Array,width:1,evaluate:(e,n)=>{let r=u(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),y[0]=255*r,y[0]}},{attrName:"aPitchAlign",symbolName:"textPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===f(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"textRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:e=>+("map"===d(t.getZoom(),e))},{attrName:"aRotation",symbolName:"textRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:e=>{const n=Xt(p(t.getZoom(),e),0,360)*Math.PI/180;return v[0]=9362*n,v[0]}},{attrName:"aOverlap",symbolName:"textAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let r=A(t.getZoom(),n)||0,i=(g?g(t.getZoom(),n):e.textIgnorePlacement)||0;return r=1<<3+4*r,i=(g?2:0)+i,r+i}},{attrName:"aOverlap",symbolName:"textIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let r=(A?A(t.getZoom(),n):e.textAllowOverlap)||0,i=g(t.getZoom(),n)||0;return r=(A?8:0)+4*r,i=1<<1+i,r+i}}]}const Ms=[],Ts=[],Ss=[],Is=[];function Cs(t,e,n,r,i,s,o){t=1===t?1:0;const a=this.getMap(),l=e.geometry.properties,h=this.getSymbol(l.symbolIndex),c="line"===l.textPlacement&&!re(h),{aTextSize:u,aTextHaloRadius:f,aShape:d}=l;let p=u?u[n[i]]:e.properties.textSize;null==p&&(p=ys.textSize);const A=f?f[n[i]]:e.properties.textHaloRadius,g=ms(Ss,e,n[i]),{aProjectedAnchor:m}=e.geometry.properties;let y=Is;const v=3*n[i];m&&-999999!==m[v]?(Is[0]=m[v],Is[1]=m[v+1],Is[2]=m[v+2]):y=zr(Is,g,o,a.width,a.height);const x=r,{boxes:b,collision:w}=this.Ms(e,i);let _=0;if(c||1===e.material.uniforms.rotateWithMap||h.textRotation){let r=0;for(let s=i;s<i+6*x;s+=6){const i=b[_]=b[_]||[];_++;const l=gs.call(this,i,g,y,e,p,A,n[s],o,a);if(!t){const e=this.isCollides(l);1===e?t=1:-1===e&&r++}}r===x&&(t=-1)}else{let r=n[i],l=d[2*r+1];for(let h=i;h<s;h+=6){const i=d[2*n[h]+1];if(l!==i||h===s-6){const c=n[h===s-6?h:h-6],u=gs.call(this,Ms,g,y,e,p,A,r,o,a),f=gs.call(this,Ts,g,y,e,p,A,c,o,a),d=b[_]=b[_]||[];_++,d[0]=Math.min(u[0],f[0]),d[1]=Math.min(u[1],f[1]),d[2]=Math.max(u[2],f[2]),d[3]=Math.max(u[3],f[3]),r=n[h],l=i,!t&&this.isCollides(d)&&(t=1)}}}return w.collides=t,w}function Os(t,e){const n=function(t,e){const{aPickingId:n,features:r}=t.geometry.properties,i=n[e],s=r&&r[i]&&r[i].feature;return s&&s.label}(t,e);return n?function(t,e,n){if(!n)return null;const i=t.localTransform,s=ms(Es,t,e);r["q"].set(Ps,s[0],s[1],s[2],1);const o=r["q"].transformMat4(Ps,Ps,i);let a=0;for(const r of n)a+=r.codePointAt(0);return[Math.floor(o[0]),Math.floor(o[1]),Math.floor(o[2]),a]}(t,e,n):null}const Es=[],Ps=[];var ks="#define SHADER_NAME TEXT_VERT\n#define RAD 0.0174532925\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aShape;\nattribute vec2 aTexCoord;\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nattribute float aRotationAlign;\n#else\nuniform float rotateWithMap;\n#endif\nuniform float flipY;\n#if defined(HAS_ROTATION)\nattribute float aRotation;\n#else\nuniform float textRotation;\n#endif\nuniform float cameraToCenterDistance;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float glyphSize;\nuniform float mapPitch;\nuniform float mapRotation;\nuniform float zoomScale;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nattribute float aTextHaloRadius;\nvarying float vTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nattribute float aTextHaloOpacity;\nvarying float vTextHaloOpacity;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_SIZE\nfloat d = aTextSize * layerScale;\n#else\nfloat d = textSize * layerScale;\n#endif\n#ifdef HAS_TEXT_DX\nfloat e = aTextDx;\n#else\nfloat e = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat f = aTextDy;\n#else\nfloat f = textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nfloat h = aPitchAlign;\n#else\nfloat h = pitchWithMap;\n#endif\n#if defined(HAS_ROTATION_ALIGN)\nfloat i = aRotationAlign;\n#else\nfloat i = rotateWithMap;\n#endif\nvec2 j = aShape / 10.0;\n  if(h == 1. && flipY == .0) {\n    j = j * vec2(1., -1.);\n  }\n  vec2 k = aTexCoord;\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  float l = gl_Position.w;\n  float m;\n  if(isRenderingTerrain == 1. && h == 1.) {\n    m = 1.;\n  } else {\n    float n = (1. - cameraToCenterDistance / l) * textPerspectiveRatio;\n    m = clamp(.5 + .5 * (1. - n), .0, 4.);\n  }\n#ifdef HAS_ROTATION\nfloat o = -aRotation / 9362. - mapRotation * i;\n#else\nfloat o = -textRotation - mapRotation * i;\n#endif\nif(h == 1.) {\n    \n#ifdef REVERSE_MAP_ROTATION_ON_PITCH\no += mapRotation;\n#else\no -= mapRotation;\n#endif\n  }\n  float u = sin(o);\n  float v = cos(o);\n  mat2 A = mat2(v, -1. * u, u, v);\n  j = A * (j / glyphSize * d);\n  float B;\n  if(isRenderingTerrain == 1.) {\n    B = 1.;\n  } else {\n    B = l / cameraToCenterDistance;\n  }\n  if(h == .0) {\n    vec2 C = j * 2. / canvasSize;\n    gl_Position.xy += C * m * l;\n  } else {\n    float D;\n    if(isRenderingTerrain == 1.) {\n      D = tileRatio / zoomScale;\n    } else {\n      D = tileRatio / zoomScale * B * m;\n    }\n    vec2 C = j;\n    gl_Position = projViewModelMatrix * positionMatrix * vec4(c + vec3(C, .0) * D, 1.);\n  }\n  gl_Position.xy += vec2(e, -f) * 2. / canvasSize * l;\n#ifndef PICKING_MODE\nif(h == .0) {\n    vGammaScale = mix(1., B, textPerspectiveRatio);\n  } else {\n    vGammaScale = B + mapPitch / 4.;\n  }\n  vTexCoord = k / texSize;\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vSize = d;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvTextHaloRadius = aTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nvTextHaloOpacity = aTextHaloOpacity;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool E = aOpacity == 255.;\n#else\nbool E = true;\n#endif\nfbo_picking_setData(gl_Position.w, E);\n#endif\n}",Rs="#define SHADER_NAME TEXT_FRAG\n#define HAS_HIGHLIGHT_COLOR_POINT 1\n#define SDF_PX 8.0\n#define DEVICE_PIXEL_RATIO 1.0\n#define EDGE_GAMMA 0.105 / DEVICE_PIXEL_RATIO\nprecision mediump float;\nuniform sampler2D texture;\nuniform float textOpacity;\nuniform highp float gammaScale;\nuniform int isHalo;\nuniform highp float textHaloBlur;\nuniform float alphaTest;\n#ifdef HAS_TEXT_HALO_OPACITY\nvarying float vTextHaloOpacity;\n#else\nuniform float textHaloOpacity;\n#endif\nuniform float layerOpacity;\nvarying vec2 vTexCoord;\nvarying float vSize;\nvarying float vGammaScale;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nvarying vec4 vTextFill;\n#else\nuniform vec4 textFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvarying vec4 vTextHaloFill;\n#else\nuniform vec4 textHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvarying float vTextHaloRadius;\n#else\nuniform highp float textHaloRadius;\n#endif\n#include <highlight_frag>\nvoid main() {\n  \n#ifdef HAS_TEXT_FILL\nvec4 c = vTextFill;\n#else\nvec4 c = textFill;\n#endif\nfloat d = vSize / 24.;\n  lowp vec4 e = c;\n  highp float f = EDGE_GAMMA / (d * gammaScale);\n  lowp float h = 185. / 256.;\n  if(isHalo == 1) {\n    \n#ifdef HAS_TEXT_HALO_FILL\nvec4 i = vTextHaloFill;\n#else\nvec4 i = textHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nfloat j = vTextHaloRadius;\n#else\nfloat j = textHaloRadius;\n#endif\ne = i;\n    f = (textHaloBlur * 1.19 / SDF_PX + EDGE_GAMMA) / (d * gammaScale);\n    h = (6. - j / d) / SDF_PX;\n#ifdef HAS_TEXT_HALO_OPACITY\nfloat k = vTextHaloOpacity / 255.;\n#else\nfloat k = textHaloOpacity;\n#endif\ne *= k * 1.25;\n  }\n  float l = texture2D(texture, vTexCoord).a;\n  highp float m = f * vGammaScale * .7;\n  float n = clamp(smoothstep(h - m, h + m, l), .0, 1.);\n  gl_FragColor = e * (n * textOpacity * vOpacity * layerOpacity);\n  if(gl_FragColor.a < alphaTest) {\n    discard;\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor);\n}";const Ns=new Uint16Array(1),Ds=new Int8Array(1);function Fs(t,e,n){_r(t,e,n),function(t){const{aMarkerWidth:e,aMarkerHeight:n,aMarkerDx:r,aMarkerDy:i,aPitchAlign:s,aRotationAlign:o,aRotation:a,aOverlap:l}=t.data;if(e){const n=(wr+"aMarkerWidth").trim();t.properties.aMarkerWidth=t.properties[n]||new e.constructor(e)}if(n){const e=(wr+"aMarkerHeight").trim();t.properties.aMarkerHeight=t.properties[e]||new n.constructor(n)}if(r){const e=(wr+"aMarkerDx").trim();t.properties.aMarkerDx=t.properties[e]||new r.constructor(r)}if(i){const e=(wr+"aMarkerDy").trim();t.properties.aMarkerDy=t.properties[e]||new i.constructor(i)}if(s){const e=(wr+"aPitchAlign").trim();t.properties.aPitchAlign=t.properties[e]||new s.constructor(s)}if(o){const e=(wr+"aRotationAlign").trim();t.properties.aRotationAlign=t.properties[e]||new o.constructor(o)}if(a){const e=(wr+"aRotation").trim();t.properties.aRotation=t.properties[e]||new a.constructor(a)}if(l){const e=(wr+"aOverlap").trim();t.properties.aOverlap=t.properties[e]||new l.constructor(l)}}(t)}function Ls(t,e){const n=Object(s["b"])(e.markerWidth),r=Object(s["b"])(e.markerHeight),i=Object(s["b"])(e.markerDx),o=Object(s["b"])(e.markerDy),a=Object(s["b"])(e.markerOpacity),l=Object(s["b"])(e.markerTextFit),h=Object(s["e"])(e.markerPitchAlignment),c=Object(s["e"])(e.markerRotationAlignment),u=Object(s["b"])(e.markerRotation),f=Object(s["e"])(e.markerAllowOverlapFn),d=Object(s["e"])(e.markerIgnorePlacement),p=new Int16Array(1),A=new Uint16Array(1);return[{attrName:"aMarkerWidth",symbolName:"markerWidth",type:Uint16Array,width:1,define:"HAS_MARKER_WIDTH",evaluate:(r,i,o,a)=>{const h=o[a],c=e.markerTextFit,u=l?l(t.getZoom(),r):c;if("both"===u||"width"===u)return h;let f=n(t.getZoom(),r);return Object(s["c"])(f)&&(f=this.evaluateInFnTypeConfig(f,i,t,r)),p[0]=f,p[0]}},{attrName:"aMarkerHeight",symbolName:"markerHeight",type:Uint16Array,width:1,define:"HAS_MARKER_HEIGHT",evaluate:(n,i,o,a)=>{const h=o[a],c=e.markerTextFit,u=l?l(t.getZoom(),n):c;if("both"===u||"height"===u)return h;let f=r(t.getZoom(),n);return Object(s["c"])(f)&&(f=this.evaluateInFnTypeConfig(f,i,t,n)),p[0]=f,p[0]}},{attrName:"aMarkerDx",symbolName:"markerDx",type:Uint8Array,width:1,define:"HAS_MARKER_DX",evaluate:(e,n)=>{let r=i(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),p[0]=r,p[0]}},{attrName:"aMarkerDy",symbolName:"markerDy",type:Uint8Array,width:1,define:"HAS_MARKER_DY",evaluate:(e,n)=>{let r=o(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),p[0]=r,p[0]}},{attrName:"aColorOpacity",symbolName:"markerOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let r=a(t.getZoom(),e);return Object(s["c"])(r)&&(r=this.evaluateInFnTypeConfig(r,n,t,e)),p[0]=255*r,p[0]}},{attrName:"aPitchAlign",symbolName:"markerPitchAlignment",type:Uint8Array,width:1,define:"HAS_PITCH_ALIGN",evaluate:e=>+("map"===h(t.getZoom(),e))},{attrName:"aRotationAlign",symbolName:"markerRotationAlignment",type:Uint8Array,width:1,define:"HAS_ROTATION_ALIGN",evaluate:e=>+("map"===c(t.getZoom(),e))},{attrName:"aRotation",symbolName:"markerRotation",type:Uint16Array,width:1,define:"HAS_ROTATION",evaluate:e=>{const n=Xt(u(t.getZoom(),e),0,360)*Math.PI/180;return A[0]=9362*n,A[0]}},{attrName:"aOverlap",symbolName:"markerAllowOverlap",type:Uint8Array,width:1,evaluate:n=>{let r=f(t.getZoom(),n)||0,i=(d?d(t.getZoom(),n):e.markerIgnorePlacement)||0;return r=1<<3+4*r,i=(d?2:0)+i,r+i}},{attrName:"aOverlap",symbolName:"markerIgnorePlacement",type:Uint8Array,width:1,evaluate:n=>{let r=(f?f(t.getZoom(),n):e.markerAllowOverlap)||0,i=d(t.getZoom(),n)||0;return r=(f?8:0)+4*r,i=2+i,r+i}}]}function zs(t,e,n,r){if(!n||!r||"none"===r)return;const i=function(t,e,n){let r=t.properties.textFitFn;Object(s["c"])(n)&&(r=t.properties.textFitFn=Object(s["e"])(n));const i="none"!==n,o=[],a=t.getElements(),l=t.data.aPickingId;let h,c,u;e&&(h=e.getElements(),c=e.data.aPickingId,u=e.data.aCount);const f=t.properties.features;let d;if(e){let t=h[0];d={pickingId:c[t],start:0,end:6*u[t]}}let p=!1,A=!1,g=0;const m=new Set;for(let s=0;s<a.length;s+=6){const t=a[s],e=l[t];if(!p&&d)for(;d.pickingId<e&&d.end<h.length;){const t=d.end,e=h[t];d.start=t,d.end=t+6*u[e],d.pickingId=c[e]}if(!p&&d&&d.pickingId<e&&(p=!0,!i)){if(!A)return[];for(let t=s;t<a.length;t+=6)o[g++]=[-1,-1];return o}const y=f[e]&&f[e].feature,v=y&&y.properties||{},x=r?r(null,v):n;if(d&&e===d.pickingId){o[g++]=[d.start,d.end];const t=d.end,e=h[t];d.start=t,d.end=t+6*u[e],d.pickingId=c[e],A=!0}else if(x&&"none"!==x)for(let n=s;n<s+6;n++)m.add(n);else o[g++]=[-1,-1]}if(m.size)if(m.size===a.length)t.setElements([]);else{const e=[];for(let t=0;t<a.length;t++)m.has(t)||e.push(a[t]);t.setElements(new a.constructor(e))}return A?o:[]}(e,n,r);if(e.getElements().length&&i.length&&(e.properties.labelIndex=i,i.length&&r&&"none"!==r&&n)){const r=function(t,e){const n=[],r=t.properties.labelIndex,{aShape:i}=e.data;let s=!1;for(let o=0;o<r.length;o++){const[t,a]=r[o];if(-1===t)n.push(0,0,0,0);else{s=!0;let r=1/0,o=1/0,l=-1/0,h=-1/0;const c=e.elements;for(let e=t;e<a;e++){const t=c[e],n=i[2*t],s=i[2*t+1];n<r&&(r=n),n>l&&(l=n),s<o&&(o=s),s>h&&(h=s)}n.push(r,o,l,h)}}return s?n:[]}(e,n);r.length&&(e.properties.labelShape=r,Bs.call(this,t,e,n))}}function Bs(t,e){const n=this.getSymbolDef(e.properties.symbolIndex),r=n.markerTextFit,i=e.properties;let o="both"===r||"width"===r,a="both"===r||"height"===r;if(Object(s["c"])(n.markerTextFit)){let t=e.properties.textFitFn;t||(t=e.properties.textFitFn=Object(s["b"])(n.markerTextFit));const{features:r}=e.properties,l=e.properties.elements||e.elements,{aPickingId:h}=e.data,c=[],u=[];let f=!0;for(let e=0;e<l.length;e+=6){const n=r[h[l[e]]],i=(n&&n.feature||{}).properties||{};let o=t(null,i);Object(s["c"])(o)&&(o=(i.textFitFn=i.textFitFn||Object(s["b"])(o))(null,i)),"both"===o?(c.push(e/6),u.push(e/6)):"width"===o?(f=!1,c.push(e/6)):"height"===o&&(f=!1,u.push(e/6))}f?(i.fitIcons=c,o=!0,a=!0):(c.length&&(i.fitWidthIcons=c,o=!0),u.length&&(i.fitHeightIcons=u,a=!0))}i.aPickingId||(i.aPickingId=new e.data.aPickingId.constructor(e.data.aPickingId));const{aMarkerWidth:l,aMarkerHeight:h,aPickingId:c}=i,u=c.length;if(o)if(l){const t=e.data.aMarkerWidth;e.data.aMarkerWidth=new Uint16Array(t),i.aMarkerWidth=new Uint16Array(t);const n=(wr+"aMarkerWidth").trim();i[n]&&(i[n]=i.aMarkerWidth)}else{const t=this.getSymbol(e.properties.symbolIndex).markerWidth||0;i.aMarkerWidth=new Uint16Array(u),i.aMarkerWidth.fill(t),t&&(i.aMarkerWidth.dirty=!0),e.data.aMarkerWidth=new Uint16Array(u)}if(a)if(h){const t=e.data.aMarkerHeight;e.data.aMarkerHeight=new Uint16Array(t),i.aMarkerHeight=new Uint16Array(t);const n=(wr+"aMarkerHeight").trim();i[n]&&(i[n]=i.aMarkerHeight)}else{const t=this.getSymbol(e.properties.symbolIndex).markerHeight||0;i.aMarkerHeight=new Uint16Array(u),i.aMarkerHeight.fill(t),t&&(i.aMarkerHeight.dirty=!0),e.data.aMarkerHeight=new Uint16Array(u)}const f=this.getSymbolDef(e.properties.textGeo.properties.symbolIndex),d=Object(s["b"])(f.textSize);Us.call(this,t,e),(!Object(s["c"])(f.textSize)||d.isZoomConstant&&d.isFeatureConstant)&&(i.isFitConstant=!0)}const Hs=[0,0,0,0];function Us(t,e){const n=e.properties.textGeo;if(!n)return;const r=n.properties,i=e.properties;if(i.isFitConstant||!i.labelShape||!i.labelShape.length)return;const o=this.getSymbolDef(e.properties.symbolIndex),a=this.getSymbolDef(n.properties.symbolIndex).textSize;let l;Object(s["c"])(a)&&(l=r.Os?r.Os:r.Os=Object(s["b"])(a));const h=o.markerTextFitPadding||Hs;let c;Object(s["c"])(h)&&(c=i.Is?i.Is:i.Is=Object(s["e"])(h));const u=t.getZoom(),{fitIcons:f,fitWidthIcons:d,fitHeightIcons:p}=i,{aMarkerWidth:A,aMarkerHeight:g,labelShape:m}=i,y=i.elements||e.elements,{features:v,aPickingId:x}=i,b=(t,e,n,r)=>{const o=m[4*e],f=m[4*e+1],d=m[4*e+2],p=m[4*e+3];if(!(o||f||d||p))return;const y=x[t],b=v[y]&&v[y].feature,w=b&&b.properties||{};let _=l?l(u,w):a;Object(s["c"])(_)&&(_=(w.textSizeFn=w.textSizeFn||Object(s["b"])(_))(u,w)),_/=24;let M,T,S=c&&c(u,w)||h;if(Object(s["c"])(S)&&(S=(w.fitPaddingFn=w.fitPaddingFn||Object(s["e"])(S))(u,w)),S=S||Hs,S[0]===S[2]&&S[1]===S[3]||(M=i.aPadOffsetX,T=i.aPadOffsetY,M||(M=i.aPadOffsetX=new Int8Array(A.length),T=i.aPadOffsetY=new Int8Array(A.length))),A&&n){const e=Math.abs((d-o)/10*_)+(S[1]+S[3]||0);if(Ns[0]=e,A[t]!==Ns[0]&&(ee(A,Ns[0],t,t+4),A.dirty=!0),M){const e=(S[1]+S[3])/2-S[3];Ds[0]=e,M[t]!==Ds[0]&&(ee(M,e,t,t+4),M.dirty=!0)}}if(g&&r){const e=Math.abs((p-f)/10*_)+(S[0]+S[2]||0);if(Ns[0]=e,g[t]!==Ns[0]&&(ee(g,Ns[0],t,t+4),g.dirty=!0),T){const e=S[0]-(S[0]+S[2])/2;Ds[0]=e,T[t]!==Ds[0]&&(ee(T,e,t,t+4),T.dirty=!0)}}};if(f||d||p){if(f)for(let s=0;s<f.length;s++){const t=f[s];b(y[6*t],t,!0,!0)}else if(d||p){if(d)for(let t=0;t<d.length;t++){const e=d[t];b(y[6*e],e,!0,!1)}if(p)for(let t=0;t<p.length;t++){const e=p[t];b(y[6*e],e,!1,!0)}}}else for(let s=0;s<y.length;s+=6){const t=s/6;b(y[s],t,!0,!0)}const{aPadOffsetX:w,aPadOffsetY:_}=i;w&&(e.data.aPadOffsetX=w,e.data.aPadOffsetY=_)}const js=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&e.isForeground(t)&&!!t.geometry.properties.iconAtlas&&!t.geometry.properties.isEmpty},Vs=function(t){const e=this.layer.getRenderer();return!(this.ks(t)||e.isForeground(t)||!t.geometry.properties.iconAtlas||t.geometry.properties.isEmpty)},Gs=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&e.isForeground(t)&&!!t.geometry.properties.glyphAtlas},qs=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&!e.isForeground(t)&&!!t.geometry.properties.glyphAtlas},Ws=[],Xs={collides:-1},Qs=[2048,2048],Ys=r["k"].identity([]),Zs=[];class Ks extends zi{static getBloomSymbol(){return["markerBloom","textBloom"]}constructor(t,e,n,r,i,s){super(t,e,n,r,i,s),this.propAllowOverlap="markerAllowOverlap",this.propIgnorePlacement="markerIgnorePlacement",this.Qi={},this.isLabelCollides=Cs.bind(this),this.Fs=js.bind(this),this.Cs=Vs.bind(this),this.Es=Gs.bind(this),this.Ds=qs.bind(this),this.Ns=[]}needToRefreshTerrainTileOnZooming(){for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].markerPitchAlignment;if("map"===e||Object(s["c"])(e)||o["c"].isExpression(e))return!0}return!1}isTerrainVector(){return this.layer.options.awareOfTerrain&&!this.needToRefreshTerrainTileOnZooming()}isTerrainSkin(){return super.isTerrainSkin()&&this.needToRefreshTerrainTileOnZooming()}setTextShaderDefines(t){this.Ls=t}createFnTypeConfig(t,e){return{icon:Ls.call(this,t,e),text:_s.call(this,t,e)}}startFrame(...t){return this.Ns.length=0,super.startFrame(...t)}createGeometry(t,e){return t&&t.empty&&(t.data={aPosition:new Uint8Array(t.data.aPosition),aPickingId:t.data.aPickingId}),super.createGeometry(t,e)}postCreateGeometry(t,e){const{geometry:n,symbolIndex:r}=t,i=this.getSymbolDef(r),s=this.getFnTypeConfig(r);if(this.Rs(n))n.properties.iconAtlas?this.drawDebugAtlas(n.properties.iconAtlas):n.properties.isEmpty=!0,Fs(n,i,s.icon);else if(this.Hs(n)&&re(i)){const t=e[e.length-1];if(t){const{geometry:e,symbolIndex:s}=t;if(e&&s.index===r.index){const t=this.getMap(),r=i.markerTextFit;e.properties.textGeo=n,zs.call(this,t,e,n,r)}}}}prepareCollideIndex(t){const{collideIds:e,elements:n,aCount:r}=t.properties;if(!e)return;const i=e,s={};if(!n)return void(t.properties.collideBoxIndex=s);let o=0,a=n[0],l=0,h=i[a],c=1;r&&(c=r[n[l]]);for(let u=0;u<=n.length;u+=6)a=n[u],i[a]===h&&u!==n.length||(s[h]=[l,u,(u-l)/(6*c),o++],h=i[a],l=u,r&&(c=r[n[l]]));t.properties.collideBoxIndex=s}createMesh(t,e,n,i){const s=this.isEnableCollision(),o=this.layer,{geometry:a,symbolIndex:l}=t;a.properties.symbolIndex=l;const h=this.getSymbolDef(l),c=this.getSymbol(l),u=this.getFnTypeConfig(l),f=[];if(this.Rs(a)){const t=function(t,e,n,i,s,o,a,l){if(e.isDisposed()||0===e.data.aPosition.length)return null;const h=e.properties.iconAtlas;if(!h&&!e.properties.isEmpty)return null;const c={flipY:0,tileResolution:e.properties.tileResolution,tileRatio:e.properties.tileRatio};
//!geometry.properties.aShape collision
if(!e.properties.aShape){const{aPosition:t,aShape:n}=e.data,r=e.data.aPosition.length/e.desc.positionSize,i=new Uint8Array(r);l&&i.fill(255,0),e.data.aOpacity={usage:"dynamic",data:i},e.properties.aOpacity=new Uint8Array(r),l&&e.properties.aOpacity.fill(255,0),e.properties.aAnchor=t,e.properties.aShape=n}e.properties.visElemts||(e.properties.elements=e.elements,e.properties.visElemts=new e.elements.constructor(e.elements.length));const[u,f]=fi(e);Zt(c,"markerOpacity",s,"markerOpacity",1),Zt(c,"markerPerspectiveRatio",s,"markerPerspectiveRatio",s.markerTextFit?0:1),Zt(c,"markerWidth",s,"markerWidth",u||15),Zt(c,"markerHeight",s,"markerHeight",f||15),Zt(c,"markerDx",s,"markerDx",0),Zt(c,"markerDy",s,"markerDy",0),Zt(c,"markerRotation",s,"markerRotation",0,t=>t*Math.PI/180),Zt(c,"pitchWithMap",s,"markerPitchAlignment",0,t=>"map"===t?1:0),Zt(c,"rotateWithMap",s,"markerRotationAlignment",0,t=>"map"===t?1:0),c.iconTex=h?hi(t,h,!1):null,c.texSize=h?[h.width,h.height]:[0,0],e.generateBuffers(t,{excludeElementsInVAO:!0});const d=new r["m"].Material(c),p=new r["m"].Mesh(e,d,{disableVAO:!0,transparent:!0,castShadow:!1,picking:!0}),A={};return a&&(A.ENABLE_COLLISION=1),e.data.aMarkerWidth&&(A.HAS_MARKER_WIDTH=1),e.data.aMarkerHeight&&(A.HAS_MARKER_HEIGHT=1),e.data.aColorOpacity&&(A.HAS_OPACITY=1),e.data.aMarkerDx&&(A.HAS_MARKER_DX=1),e.data.aMarkerDy&&(A.HAS_MARKER_DY=1),e.data.aPitchAlign&&(A.HAS_PITCH_ALIGN=1),e.data.aRotationAlign&&(A.HAS_ROTATION_ALIGN=1),e.data.aRotation&&(A.HAS_ROTATION=1),e.data.aPadOffsetX&&(A.HAS_PAD_OFFSET=1),e.data.aAltitude&&(A.HAS_ALTITUDE=1),p.setDefines(A),p.setUniform("alphaTest",.01),p.setLocalTransform(n),p.properties.symbolIndex=e.properties.symbolIndex,p}(this.regl,a,e,0,c,u.icon,o.options.collision,!s,this.isEnableUniquePlacement());t&&(t.positionMatrix=this.getAltitudeOffsetMatrix(),delete t.geometry.properties.glyphAtlas,f.push(t))}else if(this.Hs(a)){const t=vs.call(this,this.regl,a,e,h,c,u.text,o.options.collision,!s,this.isEnableUniquePlacement());t.length&&(t.forEach(t=>{t.positionMatrix=this.getAltitudeOffsetMatrix(),delete t.geometry.properties.iconAtlas}),f.push(...t))}return"line"===a.properties.markerPlacement&&this.zs(a,i),"line"===a.properties.markerPlacement&&f.forEach(t=>t.properties.isLinePlacement=!0),this.prepareCollideIndex(a),f}zs(t,e){const n=this.layer instanceof i["H"],{collideIds:r}=t.properties,s=new Uint16Array(r.length);if(this.Rs(t)){let i=0;for(let t=0;t<r.length;t+=4)s.fill(i++,t,t+4);t.properties.collideIds=s,t.properties.uniqueCollideIds=se(s,!n),e.markerCollideMap={old:r,new:s}}else if(this.Hs(t)){const{collideIds:r,aCount:i}=t.properties;if(!i)return;if(e.markerCollideMap){const{markerCollideMap:s}=e;let o=s.new[s.new.length-1],a=0,l=r[0],h=e.markerCollideMap.old.indexOf(l),c=i[0];for(let t=0;t<r.length;){const n=r[t];l!==n&&(l=n,h=e.markerCollideMap.old.indexOf(l),a=0);const s=-1===h?++o:e.markerCollideMap.new[h+4*a],u=t+4*c;r.fill(s,t,u),t+=4*c,a++,u<r.length&&(c=i[u])}t.properties.uniqueCollideIds=se(r,!n)}else{let e=0,s=i[0];for(let t=0;t<r.length;){const n=t+4*s;r.fill(e++,t,n),t+=4*s,n<r.length&&(s=i[n])}t.properties.uniqueCollideIds=se(r,!n)}}}addMesh(t){if(this.isEnableCollision()&&t.length>0){const e=new Oi(t);e.properties.uniqueCollideIds=t[0].geometry.properties.uniqueCollideIds,e.properties.meshKey=t[0].properties.meshKey,e.properties.level=t[0].properties.level,this.Ns.push(e)}for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const e=t[n].geometry,{symbolIndex:r}=e.properties;re(this.getSymbolDef(r))&&Us.call(this,this.getMap(),e)}const e=this.getMap().getZoom();for(let n=0;n<t.length;n++){if(!this.isMeshIterable(t[n]))continue;const r=t[n].geometry,{symbolIndex:i}=r.properties,s=this.getSymbolDef(i),o=this.getFnTypeConfig(i);Ir(this.regl,s,0===i.type?o.icon:o.text,t[n],e);const{aMarkerWidth:a,aMarkerHeight:l,aPadOffsetX:h,aPadOffsetY:c}=r.properties;a&&a.dirty&&(r.updateData("aMarkerWidth",a),a.dirty=!1),l&&l.dirty&&(r.updateData("aMarkerHeight",l),l.dirty=!1),h&&h.dirty&&(r.updateData("aPadOffsetX",h),h.dirty=!1),c&&c.dirty&&(r.updateData("aPadOffsetY",c),c.dirty=!1)}super.addMesh(...arguments)}updateCollision(t){if(!this.isEnableCollision())return;super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.Vs(t.timestamp),this.Ns=[],this.Vr()):this.Vr()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Fs,e.sceneFilter]:this.Fs,this.callRenderer(this.shader,t,e),this.Us.filter=e.sceneFilter?[this.Es,e.sceneFilter]:this.Es,this.callRenderer(this.Us,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Cs,e.sceneFilter]:this.Cs,this.callRenderer(this.shader,t,e),this.Us.filter=e.sceneFilter?[this.Ds,e.sceneFilter]:this.Ds,this.callRenderer(this.Us,t,e)}isMeshIterable(t){return t&&t.geometry&&!t.geometry.properties.isEmpty&&t.material&&!t.material.get("isHalo")&&this.isMeshVisible(t)&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}Vs(){if(!this.isEnableCollision())return;let t=this.Ns;t&&t.length&&this.js(t)}Bs(t,e,n,r){return this.updateBoxCollisionFading(!0,t,e,n,r)}isEnableUniquePlacement(){return this.isEnableCollision()&&!0===this.sceneConfig.uniquePlacement}js(t){const e=this.layer.getRenderer();t=t.sort(Js);for(let n=0;n<t.length;n++){const r=t[n];if(!r||!r.meshes.length)continue;let i=!1;if(1===r.meshes.length)i=this.isMeshIterable(r.meshes[0]);else for(let t=0;t<r.meshes.length;t++)if(this.isMeshIterable(r.meshes[t])){i=!0;break}if(!i)continue;const s=e.isForeground(r.meshes[0]);if(this.shouldIgnoreBackground()&&!s)continue;const o=r.properties.meshKey;this.startMeshCollision(r),this.Gs(r),this.forEachBox(r,this.Bs),this.Ws(r),this.endMeshCollision(o);for(let t=0;t<r.meshes.length;t++)this.Xs(r.meshes[t])}}Xs(t){const e=t&&t.geometry&&t.geometry.properties.aOpacity;e&&e.dirty&&(t.geometry.updateData("aOpacity",e),e.dirty=!1)}forEachBox(t,e){const n=t.properties.uniqueCollideIds;if(!n)return;const r={boxIndex:0},i=n.length;for(let s=0;s<i;s++)this.Ys(t,n[s],e,r)}Ys(t,e,n,i){const s=this.getMap(),{collideBoxIndex:o}=t.meshes[0].geometry.properties;if(!o||!o[e])return!1;const a=r["k"].multiply(Ws,s.projViewMatrix,t.meshes[0].localTransform);let l,h=!1;const c=t.meshes;let u=0;for(let r=0;r<c.length;r++){if(!this.isMeshIterable(c[r]))continue;const{collideBoxIndex:t}=c[r].geometry.properties;t[e]&&u++}if(!u)return!1;l=this.Ps(u);let f=0;for(let r=0;r<c.length;r++){const t=c[r];if(!this.isMeshIterable(t))continue;h=!0;const n=c[r].geometry.properties,{elements:i,aCount:s,collideBoxIndex:o}=n,a=o[e];if(!a)continue;const[u,d,p]=a;let A=1;s&&(A=s[i[u]]);const g=u+0*A*6;l[f].mesh=c[r],l[f].start=g,l[f].end=d,l[f].boxCount=n.glyphAtlas?A:p,l[f].allElements=i,f++}return!!h&&(n.call(this,t,l,a,i.boxIndex++)&&this.$s(t,e),!0)}Gs(t){const e=t.meshes;for(let n=0;n<e.length;n++){const t=e[n],r=t&&t.geometry;r&&(r.properties.visElemts.count=0)}}$s(t,e){const n=t.meshes;for(let r=0;r<n.length;r++){const t=n[r];if(t.properties.isHalo)continue;const i=t&&t.geometry;if(!i||i.properties.isEmpty)continue;const{collideBoxIndex:s,elements:o,visElemts:a}=i.properties,l=s[e];if(!l)continue;const[h,c]=l;let u=a.count;for(let e=h;e<c;e++)a[u++]=o[e];a.count=u}}Ws(t){const e=t.meshes;for(let n=0;n<e.length;n++){const t=e[n],r=t&&t.geometry;if(!r)continue;const{visElemts:i}=r.properties;r.setElements(i,i.count)}}isBoxCollides(t,e,n,r,i,s){if(this.Hs(t.geometry))return Cs.call(this,0,t,e,n,r,i,s);if(t.geometry.properties.isEmpty)return Xs;const{aTerrainAltitude:o}=t.geometry.properties;if(o&&o[2*e[r]]===Lt)return Xs;const a=this.getMap(),{boxes:l,collision:h}=this.Ms(t,r);let c=0,u=0,f=0;for(let d=r;d<i;d+=6){const n=l[f]=l[f]||[];f++;const r=ls.call(this,n,t,e[d],s,a);if(!c){const t=this.isCollides(r);1===t?c=1:-1===t&&u++}}return u===n&&(c=-1),h.collides=c,h}deleteMesh(t,e){t&&(t instanceof Oi&&(t=t.meshes),e&&(Array.isArray(t)?t.forEach(t=>{t&&t.material&&delete t.material.uniforms.iconTex}):t.material&&delete t.material.uniforms.iconTex),super.deleteMesh(t,e))}isBloom(t){const e=t&&t.material&&!Qt(t.material.get("markerOpacity")),n=this.getSymbol(t.properties.symbolIndex);return!!(e?n.markerBloom:n.textBloom)}init(){const t=this.regl,e=this.canvas;this.renderer=new r["m"].Renderer(t);const n={viewport:{x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,n)=>n.viewport?n.viewport.width:e?e.width:1,height:(t,n)=>n.viewport?n.viewport.height:e?e.height:1},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},depth:{enable:!0,range:()=>this.sceneConfig.depthRange||[0,1],func:()=>this.sceneConfig.depthFunc||"always",mask:!!Qt(this.sceneConfig.depthMask)||this.sceneConfig.depthMask},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}};this.shader=new r["m"].MeshShader({vert:ji,frag:"#define SHADER_NAME MARKER\n#define HAS_HIGHLIGHT_COLOR_POINT 1\nprecision mediump float;\n#include <gl2_frag>\nuniform float alphaTest;\nuniform sampler2D iconTex;\nuniform lowp float markerOpacity;\nuniform lowp float blendSrcIsOne;\nuniform float layerOpacity;\n#include <highlight_frag>\nvarying vec2 vTexCoord;\nvarying float vOpacity;\nvoid main() {\n  vec4 c = texture2D(iconTex, vTexCoord) * markerOpacity * vOpacity * layerOpacity;\n  if(c.a < .05) {\n    discard;\n  }\n  glFragColor = c;\n  glFragColor = highlight_blendColor(glFragColor);\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n  glFragColor = highlight_blendColor(glFragColor);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:n}),this.shader.version=300;const{uniforms:i,extraCommandProps:s}=ws.call(this,e,this.sceneConfig),o=this.Ls||{};if(this.Us=new r["m"].MeshShader({vert:ks,frag:Rs,uniforms:i,extraCommandProps:s,defines:o}),this.pickingFBO){const t=new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+ji,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}},{name:"zoomScale",type:"function",fn:function(t,e){return e.tileResolution/e.resolution}}],extraCommandProps:n},this.pickingFBO,this.getMap());t.filter=t=>!!t.geometry.properties.iconAtlas;const e=new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+ks,uniforms:i,extraCommandProps:s},this.pickingFBO,this.getMap());e.filter=t=>!!t.geometry.properties.glyphAtlas,this.picking=[t,e]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,s=this.layer.getTileSize().width,o=n?Ys:t.projViewMatrix,a=t.cameraToCenterDistance,l=r["o"].set(Zs,t.width,t.height);n&&r["o"].set(l,s,s);const h=this.getBlendFunc(),c=i["I"].isFunction(h.src)?h.src():h.src;return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:o,cameraToCenterDistance:a,canvasSize:l,iconSize:Qs,resolution:t.getResolution(),glyphSize:24,gammaScale:1,blendSrcIsOne:+!("one"!==c&&1!==c),viewport:n&&e&&e.viewport,isRenderingTerrain:+!!n}}getUniqueEntryKey(t,e){if(!this.Hs(t.geometry))return null;const{elements:n}=t.geometry.properties;return Os(t,n[e])}Rs(t){const{symbolIndex:e}=t.properties;return 0===e.type}Hs(t){const{symbolIndex:e}=t.properties;return 1===e.type}}function Js(t,e){return t.properties.level-e.properties.level||t.properties.meshKey-e.properties.meshKey}const $s=[],to=[],eo=[];function no(t,e,n,i,s,o,a,l,h,c,u,f,d){const{aGlyphOffset:p,aSegment:A,aTextDx:g,aTextDy:m,symbolIndex:y}=e.geometry.properties,v=this.getSymbol(y),x=g?g[s]:v.textDx,b=m?m[s]:v.textDy,w=r["o"].set(eo,x||0,b||0),_=r["o"].set($s,p[2*s],p[2*s+1]),M=r["p"].set(to,A[3*s],A[3*s+1],A[3*s+2]);return function(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A,g,m){p||(p=r);const y=e.geometry.properties.line,v=s[0]*u,x=f?v-o:v+o;let b=x>0?1:-1,w=0;f&&(b*=-1,w=Math.PI),b<0&&(w+=Math.PI);const _=h+c,M=Math.abs(x);let T=b>0?l:l+1,S=Dr.convert(r),I=Dr.convert(r),C=Dr.convert(i),O=Dr.convert(i),E=0,P=0;for(;E+P<=M;){if(T+=b,T<h||T>=_)return null;I.x=S.x,I.y=S.y,O.x=C.x,O.y=C.y,S.x=n[3*T],S.y=n[3*T+1],C.x=y[3*T],C.y=y[3*T+1],E+=P,P=I.dist(S)/d}const k=(M-E)/P,R=A&&A.getRenderer(),N=R&&R.getTerrainHelper(),D=e.properties.tile.terrainTileInfos;if(!m&&N){const{extent:n}=e.properties.tile,r=A.getTileSize().width/n,i=A.getMap();let s=C.sub(O).mult(k)._i(O);S=qr(Br,i,e,C,r,A,g,D),I=qr(Hr,i,e,O,r,A,g,D),s=qr(Ur,i,e,s,r,A,g,D);const o=w+Math.atan2(S[1]-I[1],S[0]-I[0]);return t[0]=(s[0]-p[0])/d,t[1]=(s[1]-p[1])/d,t[2]=o,t}const F=S.sub(I),L=F.mult(k)._i(I);L._i(F.Ci().Ei().Ti(a*b));const z=w+Math.atan2(S.y-I.y,S.x-I.x);return t[0]=(L.x-r[0])/d,t[1]=(L.y-r[1])/d,t[2]=z,t}(t,e,i,o,a,_,w[0],w[1],M[0],M[1],M[2],n/24,h,l,c,u,f,d)}const ro=[],io=[];function so(t,e,n,i,s,o,a,l,h,c,u,f){const{aVertical:d}=n.geometry.properties,p=d[o];let A,g,m=no.call(this,ro,n,i,s,o,l,h,c,!1);if(!m)return null;if(r["p"].copy(t,m),m=no.call(this,io,n,i,s,a,l,h,c,!1),!m)return null;if(r["p"].copy(e,m),f&&(r["o"].transformMat2(ro,ro,f),r["o"].transformMat2(io,io,f)),p){const t=Math.abs(io[1]-ro[1]),e=Math.abs(io[0]-ro[0])*u;g=ro[0]>io[0]?1:0,t>e?(A=1,g=ro[1]<io[1]?0:1):A=0}else A=0,g=ro[0]>io[0]?1:0;return 2*g+A}var oo="#define SHADER_NAME TEXT_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec2 aTexCoord;\n#ifdef HAS_OFFSET_Z\nattribute vec3 aOffset;\nuniform float altitudeScale;\n#else\nattribute vec2 aOffset;\n#endif\n#ifdef ENABLE_COLLISION\nattribute float aOpacity;\n#endif\n#ifdef HAS_OPACITY\nattribute float aColorOpacity;\n#endif\n#ifdef HAS_TEXT_SIZE\nattribute float aTextSize;\n#else\nuniform float textSize;\n#endif\n#ifdef HAS_TEXT_DX\nattribute float aTextDx;\n#else\nuniform float textDx;\n#endif\n#ifdef HAS_TEXT_DY\nattribute float aTextDy;\n#else\nuniform float textDy;\n#endif\n#if defined(HAS_PITCH_ALIGN)\nattribute float aPitchAlign;\n#else\nuniform float pitchWithMap;\n#endif\nuniform float zoomScale;\nuniform float cameraToCenterDistance;\nuniform mat4 projViewModelMatrix;\nuniform float textPerspectiveRatio;\nuniform float mapPitch;\nuniform vec2 texSize;\nuniform vec2 canvasSize;\nuniform float tileRatio;\nuniform float layerScale;\nuniform float isRenderingTerrain;\nuniform float textPitchFilter;\n#ifndef PICKING_MODE\nvarying vec2 vTexCoord;\nvarying float vGammaScale;\nvarying float vSize;\nvarying float vOpacity;\n#ifdef HAS_TEXT_FILL\nattribute vec4 aTextFill;\nvarying vec4 vTextFill;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nattribute vec4 aTextHaloFill;\nvarying vec4 vTextHaloFill;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nattribute float aTextHaloRadius;\nvarying float vTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nattribute float aTextHaloOpacity;\nvarying float vTextHaloOpacity;\n#endif\n#include <highlight_vert>\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n#ifdef HAS_TEXT_DX\nfloat d = aTextDx;\n#else\nfloat d = textDx;\n#endif\n#ifdef HAS_TEXT_DY\nfloat e = aTextDy;\n#else\nfloat e = textDy;\n#endif\n#ifdef HAS_TEXT_SIZE\nfloat f = aTextSize * layerScale;\n#else\nfloat f = textSize * layerScale;\n#endif\n#ifdef HAS_PITCH_ALIGN\nfloat h = aPitchAlign;\n#else\nfloat h = pitchWithMap;\n#endif\ngl_Position = projViewModelMatrix * vec4(c, 1.);\n  float i = gl_Position.w;\n  float j = i / cameraToCenterDistance;\n  float k;\n  if(isRenderingTerrain == 1.) {\n    k = 1.;\n  } else {\n    float l = (1. - cameraToCenterDistance / i) * textPerspectiveRatio;\n    k = clamp(.5 + .5 * (1. - l), .0, 4.);\n  }\n#ifdef HAS_OFFSET_Z\nvec3 m = aOffset / 10.0;\n  m[2] /= altitudeScale;\n#else\nvec3 m = vec3(aOffset / 10.0, .0);\n#endif\nvec2 n = aTexCoord;\n  if(h == 1.) {\n    float o;\n    if(isRenderingTerrain == 1.) {\n      o = tileRatio;\n    } else {\n      o = tileRatio / zoomScale * j * k;\n    }\n    m.xy *= o;\n    gl_Position = projViewModelMatrix * vec4(c + m, 1.);\n  } else {\n    gl_Position.xy += m.xy * 2. / canvasSize * k * i;\n  }\n  gl_Position.xy += vec2(d, -e) * 2. / canvasSize * i;\n  if(textPitchFilter > .0) {\n    if(textPitchFilter == 1. && h == .0 || textPitchFilter == 2. && h == 1.) {\n      gl_Position = vec4(-9999., -9999., .0, 1.);\n    }\n  }\n#ifndef PICKING_MODE\nif(h == 1.) {\n    vGammaScale = j + mapPitch / 4.;\n  } else {\n    vGammaScale = mix(1., j, textPerspectiveRatio);\n  }\n  vGammaScale = clamp(vGammaScale, .0, 1.);\n  vTexCoord = n / texSize;\n  vSize = f;\n#ifdef ENABLE_COLLISION\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity *= aColorOpacity / 255.;\n#endif\n#ifdef HAS_TEXT_FILL\nvTextFill = aTextFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_FILL\nvTextHaloFill = aTextHaloFill / 255.;\n#endif\n#ifdef HAS_TEXT_HALO_RADIUS\nvTextHaloRadius = aTextHaloRadius;\n#endif\n#ifdef HAS_TEXT_HALO_OPACITY\nvTextHaloOpacity = aTextHaloOpacity;\n#endif\nhighlight_setVarying();\n#else\n#ifdef ENABLE_COLLISION\nbool u = aOpacity == 255.;\n#else\nbool u = true;\n#endif\nfbo_picking_setData(gl_Position.w, u);\n#endif\n}";const ao=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&e.isTileNearCamera(t)&&"line"!==t.geometry.properties.textPlacement},lo=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&!e.isForeground(t)&&"line"!==t.geometry.properties.textPlacement},ho=function(t){const e=this.layer.getRenderer();return!this.ks(t)&&e.isTileNearCamera(t)&&"line"===t.geometry.properties.textPlacement},co=function(t){const e=this.layer.getRenderer(),n=t.properties.tile.z,r=e.getCurrentTileZoom();return!this.ks(t)&&!e.isForeground(t)&&"line"===t.geometry.properties.textPlacement&&n<r},uo=[0,0,3],fo=[],po=[],Ao=[],go=[],mo=[],yo=[],vo=[],xo=[],bo=[1,-1],wo=new Int16Array(3),_o=[],Mo=[],To=[],So=[],Io=[],Co=[],Oo=[],Eo={},Po={},ko={},Ro=[],No=[],Do=r["k"].identity([]),Fo=[];class Lo extends zi{static getBloomSymbol(){return["textBloom"]}constructor(t,e,n,r,i,s){super(t,e,n,r,i,s),this.propAllowOverlap="textAllowOverlap",this.propIgnorePlacement="textIgnorePlacement",this.colorCache={},this.qs=ao.bind(this),this.Js=lo.bind(this),this.Zs=ho.bind(this),this.Ks=co.bind(this),this.isLabelCollides=Cs.bind(this),this.Qs()}prepareRender(...t){super.prepareRender(...t);const e=this.scene.getMeshes();if(e&&e.length)for(let n=0;n<e.length;n++){if(e[n].properties.isHalo)continue;const{haloMesh:t}=e[n].properties;t.dirtyDefines&&e[n].setDefines(t.defines)}}updateSymbol(...t){this.to=void 0,this.eo=void 0;const e=super.updateSymbol(...t);return this.Qs(),e}isTerrainVector(){if(!super.isTerrainSkin())return!1;if(void 0!==this.to)return this.to;for(let t=0;t<this.symbolDef.length;t++)if("map"!==this.symbolDef[t].textPitchAlignment)return this.to=!0,!0;return this.to=!1,!1}isTerrainSkin(){if(!super.isTerrainSkin())return!1;if(void 0!==this.eo)return this.eo;for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t].textPitchAlignment;if("map"===e||Object(s["c"])(e)||o["c"].isExpression(e))return this.eo=!0,!0}return this.eo=!1,!1}Qs(){this.no=[];for(let t=0;t<this.symbolDef.length;t++){const e=this.symbolDef[t];if(o["c"].isExpression(e.textName)){const n=o["c"].createExpression(e.textName,"string");this.no[t]=(t,e)=>{let r;Eo.zoom=t,Po.properties=e;try{r=n.evaluateWithoutErrorHandling(Eo,Po,ko,null,Ro)}catch(t){r=null}return r}}else Object(s["c"])(e.textName)&&(this.no[t]=Object(s["b"])(e.textName))}}shouldDeleteMeshOnUpdateSymbol(t){if(!Array.isArray(t))return(0===t.textHaloRadius||0===this.symbolDef[0].textHaloRadius)&&t.textHaloRadius!==this.symbolDef[0].textHaloRadius;for(let e=0;e<t.length;e++)if(t[e]&&(0===t[e].textHaloRadius||0===this.symbolDef[e].textHaloRadius)&&t[e].textHaloRadius!==this.symbolDef[e].textHaloRadius)return!0;return!1}createFnTypeConfig(t,e){return _s(t,e)}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex)[Lo.getBloomSymbol()[0]]}createGeometry(t,e,n){const r=t;if(!r.glyphAtlas)return null;const i=super.createGeometry(r,e);if(!i||!i.geometry)return null;const{geometry:s}=i;return s.properties.glyphAtlas&&this.drawDebugAtlas(s.properties.glyphAtlas),s&&r.lineVertex&&(s.properties.line=r.lineVertex,s.properties.line.id=n),i}createMesh(t,e,{tileVectorTransform:n}){const r=this.isEnableCollision(),i=this.isEnableUniquePlacement(),{geometry:s,symbolIndex:o}=t;s.properties.symbolIndex=o;const a=this.getSymbol(o),l=this.getSymbolDef(o),h=this.getFnTypeConfig(o),c=vs.call(this,this.regl,s,e,l,a,h,this.layer.options.collision,!r,i);return c.length&&("line"===s.properties.textPlacement?this.io=!0:this.ro=!0),c.forEach(t=>{t.positionMatrix=this.getAltitudeOffsetMatrix(),t.properties.tileVectorTransform=n}),c}updateCollision(t){super.updateCollision(t);const e=this.scene.getMeshes();e&&e.length?(this.so={},this.oo(t.timestamp),this.Vr()):this.Vr()}callCurrentTileShader(t,e){this.shader.filter=e.sceneFilter?[this.qs,e.sceneFilter]:this.qs,this.callRenderer(this.shader,t,e),this.ao.filter=e.sceneFilter?[this.Zs,e.sceneFilter]:this.Zs,this.callRenderer(this.ao,t,e)}callBackgroundTileShader(t,e){this.shader.filter=e.sceneFilter?[this.Js,e.sceneFilter]:this.Js,this.callRenderer(this.shader,t,e),this.ao.filter=e.sceneFilter?[this.Ks,e.sceneFilter]:this.Ks,this.callRenderer(this.ao,t,e)}callRenderer(t,e,n){n&&n.isRenderingTerrain&&Object(s["c"])(this.symbolDef.textPitchAlignment)&&(n.isRenderingTerrainSkin?e.textPitchFilter=1:e.textPitchFilter=2),super.callRenderer(t,e,n)}oo(){let t=this.scene.getMeshes();if(!t||!t.length)return;const e=-this.getMap().getBearing()*Math.PI/180,n=r["i"].fromRotation(Ao,e),i=(t,e,n,r)=>{const{start:i,end:s,mesh:o,allElements:a}=e[0];if(this.updateBoxCollisionFading(!0,o,e,n,r)){let e=t.count;for(let n=i;n<s;n++)t[e++]=a[n];t.count=e}},s=this.isEnableCollision(),o=this.layer.getRenderer();t=t.sort(Bo);for(let r=0;r<t.length;r++){const e=t[r];if(!this.isMeshIterable(e))continue;if(!o.isTileNearCamera(e)){const{visElemts:t}=e.geometry.properties;t&&(t.count=0),e.geometry.setElements(t,0);continue}const a=e.geometry,l=this.getSymbol(e.properties.symbolIndex);e.properties.textHaloRadius=Qt(l.textHaloRadius)?ys.textHaloRadius:l.textHaloRadius;const h=e.properties.meshKey;if("line"===a.properties.textPlacement){if(!a.properties.line)continue;s&&this.startMeshCollision(e),this.lo(e,n);const{aOffset:t,aOpacity:r}=a.properties;t.dirty&&(a.updateData("aOffset",t),t.dirty=!1),r&&r.dirty&&(a.updateData("aOpacity",r),r.dirty=!1),s&&this.endMeshCollision(h)}else if(s){this.startMeshCollision(e);const{elements:t,aOpacity:n,visElemts:r}=a.properties;r.count=0,this.forEachBox(e,(t,e,n,s,o)=>{i(r,e,n,s)}),n&&n.dirty&&a.updateData("aOpacity",n);const s=r.count===t.length&&a.count===t.length,o=!r.count&&!a.count;s||o||a.setElements(r,r.count),this.endMeshCollision(h)}}}isMeshIterable(t){return t.isValid()&&t.material&&!t.material.get("isHalo")&&!(this.shouldIgnoreBackground()&&!this.layer.getRenderer().isForeground(t))}isMeshUniquePlaced(t){return!!this.isMeshIterable(t)&&"line"!==this.getSymbol(t.properties.symbolIndex).textPlacement}getUniqueEntryKey(t,e){return Os(t,e)}lo(t,e){const n=this.getMap(),i=t.geometry,s=i.properties;let o=s.line;if(!o)return;const a=n.getPitch(),l=n.getBearing(),{lineTextPitch:h,lineTextBearing:c}=t.properties,u=1===t.material.uniforms.pitchWithMap,f=s.elements;if(!u){const e=r["k"].multiply(fo,n.projViewMatrix,t.localTransform),i=o.id+"-"+e.join();let a;this.so[i]?o=this.so[i]:(a=s.projectedLine=s.projectedLine||new Array(o.length),o=this.ho(a,o,e,n.width,n.height),this.so[i]=a)}const d=this.isEnableCollision(),p=i.properties.visElemts=i.properties.visElemts||new f.constructor(f.length),A=i.properties.visCache=i.properties.visCache||[];d&&(p.count=0);const g=void 0===h||!n.isInteracting()||Math.abs(a-h)>2||Math.abs(l-c)>2;g&&(this.Ir=!0),this.forEachBox(t,(t,n,r,i)=>{const{start:s,end:a}=n[0];let l=A[i];if((void 0===l||g)&&(l=this.uo(t,f,s,a,o,r,u?e:null,i)),A[i]=l,d&&(l=this.updateBoxCollisionFading(l,t,n,r,i),l)){let t=p.count;for(let e=s;e<a;e++)p[t++]=f[e];p.count=t}}),g&&(t.properties.lineTextPitch=a,t.properties.lineTextBearing=l);const m=t.geometry.properties.aAltitude;m&&m.dirty&&(i.updateData("aAltitude",m),m.dirty=!1),!d||p.count===f.length&&i.count===p.count||i.setElements(p,p.count)}ho(t,e,n,i,s){return function(t,e,n,i,s){for(let o=0;o<e.length;o+=3)r["q"].set(Lr,e[o],e[o+1],e[o+2],1),zr(Lr,Lr,n,i,s),t[o]=Lr[0],t[o+1]=Lr[1],t[o+2]=e[o+2];return t}(t,e,n,i,s)}forEachBox(t,e){const n=this.getMap(),i=r["k"].multiply(fo,n.projViewMatrix,t.properties.tileVectorTransform),{collideIds:s,aCount:a,features:l,elements:h}=t.geometry.properties,c=s;if(!c)return;const u=this.isEnableUniquePlacement(),f=this.Ps(1);f[0].allElements=h,f[0].mesh=t;let d=0,p=h[0],A=0,g=c[p];for(let r=0;r<=h.length;r+=6)if(p=h[r],c[p]!==g||r===h.length){const n=l[g]&&l[g].feature;if(u&&this.isMeshUniquePlaced(t)&&n&&!n.label){const e=n.properties||{},{symbolIndex:r}=t.properties,i=r&&this.no[r.index]?this.no[r.index](t.properties.z,e):this.getSymbol(t.properties.symbolIndex).textName,s=o["q"].resolveText(i,e);n.label=s}const s=r,m=a[h[A]];for(let r=A;r<s;r+=6*m)f[0].start=r,f[0].end=r+6*m,f[0].boxCount=m,e.call(this,t,f,i,d++);g=c[p],A=r}}uo(t,e,n,i,s,a,l){const h=this.layer.getRenderer(),c=t.material.uniforms,u=1===c.pitchWithMap,f=!u&&h.getTerrainHelper&&h.getTerrainHelper(),d=this.isEnableCollision(),p=this.getMap(),A=t.geometry,g=A.desc.positionSize,{aShape:m,aOffset:y,aAnchor:v,aAltitude:x,aPitchRotation:b}=A.properties;let{aProjectedAnchor:w}=A.properties;w||(w=A.properties.aProjectedAnchor=new Array(v.length/g*3));const _=A.properties.aTextSize,M=!l,T=e[n],S=T*g;let I;I=A.data.aAltitude?r["p"].set(go,v[S],v[S+1],x[T]):o["i"].unpackPosition(go,v[S],v[S+1],v[S+2]);const C=zr(mo,I,a,p.width,p.height),O=A.properties.aTerrainAltitude;let E;if(O){const t=O[T];if(t===Lt)return w[3*T]=-999999,w[3*T+1]=-999999,w[3*T+2]=-999999,!1;t?(E=r["p"].set(No,...I),E[2]=100*t,E=zr(E,E,a,p.width,p.height)):E=C}else E=C;const P=p.getDevicePixelRatio();if(r["q"].scale(Fo,E,1/P),p.isOffscreen(Fo))return d||zo(y,e,n,i),w[3*T]=-999999,w[3*T+1]=-999999,w[3*T+2]=-999999,!1;M&&(I=C),w[3*T]=E[0],w[3*T+1]=E[1],w[3*T+2]=E[2];const k=M?1:A.properties.tileExtent/this.layer.getTileSize().width;let R=!0;const N=e[n],D=e[i-1],F=_?_[N]:t.properties.textSize,L=this.co(t,F,s,N,D,I,go,k,l);if(null===L)return zo(y,e,n,i),!1;const z=D-N<=3,B=Math.floor(L/2),H=L%2;for(let o=n;o<i;o+=6){const l=e[o];let h;if(h=B||o!==n||z||f?B||o!==i-6||z||f?no.call(this,po,t,F,s,l,I,go,k,B,E,this.layer,a,u):Oo:Co,!h){R=!1,d||zo(y,e,n,i);break}let p=h[2];H&&(p-=Math.PI/2);const A=Ki(yo,p,0,c.rotateWithMap,c.pitchWithMap),g=y.length>m.length;let v;if(g){r["p"].set(So,b[3*l],b[3*l+1],0);const t=r["p"].normalize(So,So),e=-b[3*l+2];if(e){const n=r["l"].setAxisAngle(_o,t,e);r["k"].fromTranslation(Mo,uo),r["k"].fromQuat(To,n),v=r["k"].multiply(To,To,Mo)}}for(let t=0;t<4;t++){const e=2*(l+t);r["o"].set(vo,m[e]/10,m[e+1]/10),r["o"].scale(vo,vo,F/24),r["o"].transformMat2(vo,vo,A),u?(r["o"].multiply(vo,vo,bo),r["o"].add(xo,vo,h),g&&(xo[2]=0,v&&r["p"].transformMat4(xo,xo,v))):(r["o"].multiply(xo,h,bo),r["o"].add(xo,vo,xo)),wo[0]=10*xo[0],wo[1]=10*xo[1],g&&(wo[2]=10*xo[2]);const n=(g?3:2)*(l+t);(y[n]!==wo[0]||y[n+1]!==wo[1]||g&&y[n+2]!==wo[2])&&(y.dirty=!0,y[n]=wo[0],y[n+1]=wo[1],g&&(y[n+2]=wo[2]))}}return R}co(t,e,n,r,i,s,o,a,l){const h=i-r<=3,c=this.getMap();return h?0:so.call(this,Co,Oo,t,e,n,r,i,s,o,a,c.width/c.height,l)}isBoxCollides(t,e,n,r,i,s){return this.isLabelCollides(0,t,e,n,r,i,s)}deleteMesh(t,e){t&&(e&&(Array.isArray(t)?t.forEach(t=>{t&&t.material&&delete t.material.uniforms.texture}):t.material&&delete t.material.uniforms.texture),super.deleteMesh(t,e))}delete(){super.delete(),this.ao.dispose(),delete this.so,this.fo&&this.fo.dispose()}needClearStencil(){return!0}init(){const t=this.regl;this.renderer=new r["m"].Renderer(t);const{uniforms:e,extraCommandProps:n}=ws.call(this,this.canvas,this.sceneConfig),i=this.canvas,s={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:i?i.width:1,height:(t,e)=>e.viewport?e.viewport.height:i?i.height:1};n.viewport=s,this.shader=new r["m"].MeshShader({vert:ks,frag:Rs,uniforms:e,extraCommandProps:n});let o=n;if(this.layer.getRenderer().isEnableWorkAround("win-intel-gpu-crash")&&(o=qt({},n),o.stencil=qt({},n.stencil),o.stencil.enable=!0),this.ao=new r["m"].MeshShader({vert:oo,frag:Rs,uniforms:e,extraCommandProps:o}),this.pickingFBO){const t=new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+ks,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());t.filter=t=>{const e=t.properties.symbolIndex;return"line"!==this.getSymbol(e).textPlacement};const n=new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+oo,uniforms:e,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap());n.filter=t=>"line"===t.geometry.properties.textPlacement,this.picking=[t,n]}}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin,i=this.layer.getTileSize().width,s=n?Do:t.projViewMatrix,o=t.cameraToCenterDistance,a=r["o"].set(Io,t.width,t.height);n&&r["o"].set(a,i,i);const l=St(t.getResolution(),t);return{layerScale:this.layer.options.styleScale||1,mapPitch:t.getPitch()*Math.PI/180,mapRotation:t.getBearing()*Math.PI/180,projViewMatrix:s,viewMatrix:t.viewMatrix,cameraToCenterDistance:o,canvasSize:a,glyphSize:24,gammaScale:1*(this.layer.options.textGamma||1),resolution:t.getResolution(),altitudeScale:l,viewport:n&&e&&e.viewport,textPitchFilter:0,isRenderingTerrain:+!!n}}}function zo(t,e,n,r){for(let i=n;i<r;i+=6){const n=e[i];for(let e=0;e<4;e++){const r=3*(n+e);(t[r]||t[r+1]||t[r+2])&&(t.dirty=!0,t[r]=0,t[r+1]=0,t[r+2]=0)}}}function Bo(t,e){const n=t.properties.level-e.properties.level;return 0===n?t.properties.meshKey-e.properties.meshKey:n}var Ho="#define SHADER_NAME NATIVE_POINT\n#include <gl2_vert>\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float markerSize;\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * positionMatrix * vec4(c, 1.);\n  gl_PointSize = markerSize;\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const Uo={markerFill:[0,0,0],markerOpacity:1,markerSize:10};class jo extends ai{getPrimitive(){return"points"}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:s}=t,o=this.getSymbol(i);void 0===s&&(_r(n,this.getSymbolDef(i),this.getFnTypeConfig(i)),n.generateBuffers(this.regl));const a={};Zt(a,"markerOpacity",o,"markerOpacity",1),Zt(a,"markerSize",o,"markerSize",10),Zt(a,"markerFill",o,"markerFill","#000",$t(this.colorCache,3));const l=new r["m"].Material(a,Uo);l.createDefines=()=>"square"!==o.markerType?{USE_CIRCLE:1}:null,l.appendDefines=t=>("square"!==o.markerType&&(t.USE_CIRCLE=1),t);const h=new r["m"].Mesh(n,l,{castShadow:!1,picking:!0}),c={};return h.geometry.data.aAltitude&&(c.HAS_ALTITUDE=1),n.data.aColor&&(c.HAS_COLOR=1),h.setDefines(c),h.positionMatrix=this.getAltitudeOffsetMatrix(),h.setLocalTransform(e),h.properties.symbolIndex=i,h}createFnTypeConfig(t,e){const n=Object(s["e"])(e.markerFill);return[{attrName:"aColor",symbolName:"markerFill",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||l()(i).unitArray()),i=Jt(i),i}}]}init(){const t=this.regl;this.renderer=new r["m"].Renderer(t);const e=[],n={vert:Ho,frag:"#define SHADER_NAME NATIVE_POINT\nprecision mediump float;\n#include <gl2_frag>\n#ifdef USE_CIRCLE\n#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#define STANDARD_DERIVATIVES_ENABLED 1\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define STANDARD_DERIVATIVES_ENABLED 1\n#endif\n#endif\n#ifdef HAS_COLOR\nvarying vec4 vColor;\n#else\nuniform vec3 markerFill;\n#endif\nuniform float markerOpacity;\nuniform float layerOpacity;\nvoid main() {\n  float c = 1.;\n#ifdef USE_CIRCLE\nfloat r = .0, d = .0;\n  vec2 e = 2. * gl_PointCoord - 1.;\n  r = dot(e, e);\n  if(r > 1.) {\n    discard;\n  }\n#ifdef STANDARD_DERIVATIVES_ENABLED\nd = fwidth(r);\n  c = 1. - smoothstep(1. - d, 1. + d, r);\n#endif\n#endif\n#ifdef HAS_COLOR\nvec4 f = vColor;\n#else\nvec4 f = vec4(markerFill, 1.);\n#endif\nglFragColor = f * markerOpacity * c * layerOpacity;\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,n){return r["k"].multiply(e,n.projViewMatrix,n.modelMatrix),e}}],defines:null,extraCommandProps:{viewport:{x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},depth:{enable:!0,mask:!1,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"always"},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"}}};if(this.shader=new r["m"].MeshShader(n),this.shader.version=300,this.pickingFBO){const t=[];this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+Ho,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(e,n){return r["k"].multiply(t,n.projViewMatrix,n.modelMatrix),t}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]}}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}}var Vo="#define SHADER_NAME NATIVE_LINE\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nuniform mat4 projViewModelMatrix;\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#else\n#include <fbo_picking_vert>\n#endif\n#include <vt_position_vert>\nvoid main() {\n  vec3 c = unpackVTPosition();\n  gl_Position = projViewModelMatrix * vec4(c, 1.);\n#ifndef PICKING_MODE\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#else\nfbo_picking_setData(gl_Position.w, true);\n#endif\n}";const Go=r["k"].identity([]);class qo extends ai{constructor(t,e,n,r,i,o){if(super(t,e,n,r,i,o),this.primitive="lines",Object(s["c"])(this.symbolDef.lineColor)){const t=e.getMap(),n=Object(s["e"])(this.symbolDef.lineColor);this.colorSymbol=e=>n(t.getZoom(),e)}}needPolygonOffset(){return!0}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:s}=t,o=this.getSymbol(i),a=this.getMeshUniforms(n,o);void 0===s&&n.generateBuffers(this.regl);const l=new r["m"].Material(a),h=new r["m"].Mesh(n,l,{castShadow:!1,picking:!0});h.setLocalTransform(e),h.properties.symbolIndex=i;const c={};return h.geometry.data.aAltitude&&(c.HAS_ALTITUDE=1),h.setDefines(c),h}getMeshUniforms(t,e){const n={};return Zt(n,"lineColor",e,"lineColor","#000",$t(this.colorCache)),Zt(n,"lineOpacity",e,"lineOpacity",1),n}init(t){const e=this.layer.getRenderer().isEnableTileStencil()&&(!t||!t.isRenderingTerrain||!this.isTerrainSkin()),n=this.regl;this.renderer=new r["m"].Renderer(n);const i=this.canvas,s={x:(t,e)=>e.viewport?e.viewport.x:0,y:(t,e)=>e.viewport?e.viewport.y:0,width:(t,e)=>e.viewport?e.viewport.width:i?i.width:1,height:(t,e)=>e.viewport?e.viewport.height:i?i.height:1},o=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],a=this.sceneConfig.depthRange,l={vert:Vo,frag:"#define SHADER_NAME NATIVE_LINE\nprecision mediump float;\nuniform float lineOpacity;\nuniform vec4 lineColor;\nuniform float layerOpacity;\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#endif\nvoid main() {\n  gl_FragColor = lineColor * lineOpacity;\n#if defined(HAS_COLOR)\ngl_FragColor *= vColor;\n#endif\ngl_FragColor *= layerOpacity;\n}",uniforms:o,defines:null,extraCommandProps:{viewport:s,stencil:{enable:!0,mask:255,func:{cmp:()=>e?"=":"<=",ref:(t,n)=>e?n.stencilRef:n.level,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:a||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}};this.shader=new r["m"].MeshShader(l),this.pickingFBO&&(this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+Vo,uniforms:o,extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())])}getUniformValues(t,e){const n=e&&e.isRenderingTerrainSkin;return{projViewMatrix:n?Go:t.projViewMatrix,viewport:n&&e&&e.viewport}}getPrimitive(){return"lines"}}const Wo=[1,1,1],Xo=[1,1,1,1],Qo=[0,0],Yo=[1,1],Zo=[],Ko=new i["f"](0,0),Jo=new i["f"](0,0),$o=[],ta=[];class ea extends ii{supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isTerrainSkin(){return!1}isTerrainVector(){return this.layer.options.awareOfTerrain}isAnimating(){return!1}createMesh(t,e,{tilePoint:n}){if(!this.material)return this.setToRedraw(),null;const{geometry:s,symbolIndex:o}=t,a=this.layer instanceof i["H"],l=new r["m"].Mesh(s,this.material);if(this.sceneConfig.animation){Wo[2]=.01;const t=[];r["k"].fromScaling(t,Wo),r["k"].multiply(t,e,t),e=t}const h=this.getSymbolDef(o),c=this.getFnTypeConfig(o);_r(s,h,c);const u=this.getShader(),f=u.getGeometryDefines?u.getGeometryDefines(s):{},d=this.getSymbol(o),p=$t(this.colorCache);if(s.data.aExtrude){f.IS_LINE_EXTRUSION=1;const{tileResolution:t,tileRatio:e}=s.properties,n=this.getMap();Object.defineProperty(l.uniforms,"linePixelScale",{enumerable:!0,get:function(){return e*n.getResolution()/t}}),Zt(l.uniforms,"lineWidth",d,"lineWidth",4),Zt(l.uniforms,"lineOpacity",d,"lineOpacity",1),Zt(l.uniforms,"lineColor",d,"lineColor","#fff",p),Object.defineProperty(l.uniforms,"lineHeight",{enumerable:!0,get:()=>{const t=this.dataConfig.defaultAltitude*(this.dataConfig.altitudeScale||1);return ne(t)?t:0}})}else{Zt(l.uniforms,"polygonFill",d,"polygonFill",Xo,p),Zt(l.uniforms,"polygonOpacity",d,"polygonOpacity",1);const t=[];Object.defineProperty(l.uniforms,"vertexColorsOfType",{enumerable:!0,get:()=>{const e=p(d.bottomPolygonFill||Xo),n=p(d.topPolygonFill||Xo);t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=n[0],t[5]=n[1],t[6]=n[2],t[7]=n[3];const r=l.geometry.properties.vertexColors;if(r){let e=8;t.length=8+r.length;for(let n=0;n<r.length;n++)t[e++]=r[n][0],t[e++]=r[n][1],t[e++]=r[n][2],t[e++]=r[n][3]}return t}})}if(s.data.aColor&&(f.HAS_COLOR=1),s.data.aOpacity&&(f.HAS_OPACITY=1),s.data.aLineWidth&&(f.HAS_LINE_WIDTH=1),s.data.aLineHeight&&(f.HAS_LINE_HEIGHT=1),s.data.aTerrainAltitude&&(f.HAS_TERRAIN_ALTITUDE=1),s.data.aVertexColorType){const t=l.geometry.properties.vertexColors;let e=2;t&&(e+=t.length),f.VERTEX_TYPES_COUNT=e}if(s.data.aOpacity){const t=s.data.aOpacity;for(let e=0;e<t.length;e++)if(t[e]<255){s.properties.hasAlpha=!0;break}}f.HAS_MIN_ALTITUDE=1,f.HAS_LAYER_OPACITY=1,s.generateBuffers(this.regl),l.setDefines(f),l.setPositionMatrix(this.getAltitudeOffsetMatrix()),l.setLocalTransform(e),(s.properties.maxAltitude<=0||l.properties.level>=3)&&(l.castShadow=!1),l.setUniform("maxAltitude",l.geometry.properties.maxAltitude),Object.defineProperty(l.uniforms,"minAltitude",{enumerable:!0,get:()=>this.layer.options.altitude||0});const{tileResolution:A}=s.properties,g=this.getMap(),m=this.layer.getRenderer(),y=g.pointAtResToCoord(new i["A"](n),A),v=function(t,e,n,r,i){return t.pointAtResToDistance(i?0:e,i?e:0,r,n)}(g,1,y,A),x=[];Object.defineProperty(l.uniforms,"uvOrigin",{enumerable:!0,get:()=>this.do(x,o,n,A,v,a)}),l.setUniform("uvOffset",[0,0]),Object.defineProperty(l.uniforms,"hasAlpha",{enumerable:!0,get:()=>{const t=this.getSymbol(o);return s.properties.hasAlpha||t.polygonOpacity<1||t.lineOpacity<1||l.material&&(l.material.uniforms.baseColorTexture||l.material.uniforms.emissiveTexture)}});const b=this.layer.getMap().getMaxNativeZoom();return Object.defineProperty(l.uniforms,"stencilRef",{enumerable:!0,get:()=>m.isForeground(l)?0:b-l.properties.tile.z}),l.properties.symbolIndex=o,l}do(t,e,n,i,s,a){if(1===this.dataConfig.topUVMode)return t[0]=0,t[1]=0,t;const l=this.getMap(),h=this.getSymbol(e).material;let c=n;!this.dataConfig.side&&h&&h.textureOrigin&&(Ko.set(h.textureOrigin[0],h.textureOrigin[1]),l.coordToPointAtRes(Ko,i,Jo),c=r["o"].set($o,n[0]-Jo.x,n[1]-Jo.y));const u=!!h&&h.uvOffsetInMeter;let f=h&&h.uvOffset||Qo;const d=this.getUVOffsetAnim();d&&(f=this.getUVOffset(d));const p=h&&h.uvScale||Yo;let A=this.dataConfig.side?0:c[0],g=this.dataConfig.side?0:c[1];const m=h&&h.textureWidth||o["b"],y=m*p[1]/p[0];u&&(A+=f[0]/s,g+=f[1]/s);const v=u?0:f[0],x=u?0:f[1],b=r["o"].set(t,A*s*p[0]/m+v,g*s*p[1]/y+x);return a||(b[1]*=-1),b}callShader(t,e){const n=this.sceneConfig.cullFace;this.sceneConfig.cullFace="front",this.callBackgroundTileShader(t,e),void 0===n?delete this.sceneConfig.cullFace:this.sceneConfig.cullFace=n,super.callShader(t,e)}getShadowMeshes(){if(!this.isVisible())return Zo;this.shadowCount=this.scene.getMeshes().length;const t=this.scene.getMeshes().filter(t=>0===t.properties.level);for(let e=0;e<t.length;e++){const n=t[e];n.material!==this.material&&n.setMaterial(this.material)}return t}getUVOffsetAnim(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}getUVOffset(t){const e=this.getSymbols()[0],n=e.material&&e.material.uvOffset||Qo,i=!!e.material&&e.material.uvOffsetInMeter,s=performance.now()/1e3,o=r["o"].set(ta,n[0],n[1]);return o[0]=s*t[0],o[1]=s*t[0],i||(o[0]%=1,o[1]%=1),o}needPolygonOffset(){return this.po}startFrame(...t){return delete this.po,super.startFrame(...t)}addMesh(t,e){t.forEach(t=>{this.Sr(t,e)}),super.addMesh(...arguments)}Sr(t,e){if(null!==e){const n=t.localTransform;0===e&&(e=.01),Wo[2]=e,r["k"].fromScaling(n,Wo),r["k"].multiply(n,t.properties.tileTransform,n),t.setLocalTransform(n)}else t.setLocalTransform(t.properties.tileTransform);t.material!==this.material&&t.setMaterial(this.material),t.geometry.properties.maxAltitude<=0&&(this.po=!0),this.getSymbol(t.properties.symbolIndex).ssr?t.ssr=1:t.ssr=0}deleteMaterial(){this.material&&(this.material.dispose(),delete this.material)}deleteMesh(t,e){if(t)if(this.scene.removeMesh(t),Array.isArray(t))for(let n=0;n<t.length;n++)e||(t[n].geometry.dispose(),delete t[n].geometry.properties.layer),t[n].dispose();else e||(t.geometry.dispose(),delete t.geometry.properties.layer),t.dispose()}updateDataConfig(t,e){return!("line-extrusion"===this.dataConfig.type&&!t.altitudeProperty&&!e.altitudeProperty)}createFnTypeConfig(t,e){const n=Object(s["e"])(e.polygonFill||e.lineColor),r=Object(s["b"])(e.polygonOpacity||e.lineOpacity),i=Object(s["b"])(e.lineWidth),o=new Uint8Array(1),a=new Uint16Array(1),h=e.polygonFill?"polygonFill":e.lineColor?"lineColor":"polygonFill",c=e.polygonOpacity?"polygonOpacity":e.lineOpacity?"lineOpacity":"polygonOpacity";return[{attrName:"aColor",type:Uint8Array,width:4,symbolName:h,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||l()(i).unitArray()),i=Jt(i),i}},{attrName:"aOpacity",type:Uint8Array,width:1,symbolName:c,evaluate:(e,n)=>{let i=r(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,n,t,e,!1)),o[0]=255*i,o[0]<255&&(n.properties.hasAlpha=!0),o[0]}},{attrName:"aLineWidth",type:Uint8Array,width:1,symbolName:"lineWidth",define:"HAS_LINE_WIDTH",evaluate:e=>{const n=i(t.getZoom(),e);return a[0]=Math.round(2*n),a[0]}}]}updateSymbol(t,e){let n=!1;t&&t.material&&(n=function(t,e){for(const n in e)if(ra[n]&&e[n]!==t[n]&&(!t[n]||!e[n]))return!0;return!1}(this.symbolDef[0].material||{},t.material));const r=super.updateSymbol(t,e);return t&&t.material&&this.si(t.material),n||r}tr(t,e){return na(t)!==na(e)}}function na(t){if(!t||!t.material)return!1;for(const e in t.material)if(e.indexOf("Texture")>0&&t.material[e])return!0;return!1}const ra={normalTexture:1,bumpTexture:1};class ia extends ea{createGeometry(t){const e=t.data,n=this.getSymbols()[0];if(n.material&&n.material.extrusionOpacity){const t=new Uint8Array(e.aPosition.length/3);for(let n=0;n<e.aPosition.length;n+=3)e.aPosition[n+2]>0?t[n/3]=0:t[n/3]=1;e.aExtrusionOpacity=t}const i=new r["m"].Geometry(e,t.indices);return qt(i.properties,t.properties),this.pr(i,t),{geometry:i,symbolIndex:{index:0}}}updateSceneConfig(t){let e;if(this.sceneConfig.cullFace!==t.cullFace&&(e=!0),qt(this.sceneConfig,t),e){const t=this.getShaderConfig();this.shader.dispose(),this.shader=new r["m"].PhongShader(t)}this.setToRedraw()}getShader(){return this.shader}delete(t){this.getMap().off("updatelights",this.mo,this),super.delete(t),this.material.dispose()}init(){this.getMap().on("updatelights",this.mo,this);const t=this.regl;this.renderer=new r["m"].Renderer(t);const e=this.getShaderConfig();this.shader=new r["m"].PhongShader(e),this.si();const n={vert:this.getPickingVert(),uniforms:["projViewMatrix","modelMatrix","positionMatrix",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this.pickingViewport}};this.picking=[new r["m"].FBORayPicking(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}mo(){this.setToRedraw()}getShaderConfig(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1};return{extraCommandProps:{cull:{enable:()=>void 0===this.sceneConfig.cullFace||!!this.sceneConfig.cullFace,face:()=>{let t=this.sceneConfig.cullFace;return!0===t&&(t="back"),t||"back"}},stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e,polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}}si(){this.material&&this.material.dispose();const t=this.layer instanceof i["H"],e=this.getSymbols()[0].material,n={};for(const r in e)ie(e,r)&&(n[r]=e[r],"uvRotation"===r&&(n[r]=n[r]*Math.PI/180,t||(n[r]*=-1)));this.material=new r["m"].PhongMaterial(n)}getUniformValues(t,e){const n=t.viewMatrix,r=t.projMatrix,i=t.cameraPosition,s=this.yo(),o=qt({viewMatrix:n,projMatrix:r,cameraPosition:i,projViewMatrix:t.projViewMatrix},s);e&&e.jitter?o.halton=e.jitter:o.halton=[0,0];const a=this.layer.getRenderer().canvas;return o.outSize=[a.width,a.height],o}getPickingVert(){return"\n            attribute vec3 aPosition;\n            uniform mat4 projViewModelMatrix;\n            uniform mat4 modelMatrix;\n            uniform mat4 positionMatrix;\n            //fbo pickingvert\n            #include <fbo_picking_vert>\n            #include <get_output>\n            void main()\n            {\n                mat4 localPositionMatrix = getPositionMatrix();\n                vec4 localPosition = getPosition(aPosition);\n\n                gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n                //gl_Positiondepth\n                fbo_picking_setData(gl_Position.w, true);\n            }\n        "}yo(){const t=this.getMap().getLightManager(),e=t&&t.getAmbientLight()||{},n=t&&t.getDirectionalLight()||{};return{ambientColor:e.color||[.2,.2,.2],light0_diffuse:[...n.color||[.1,.1,.1],1],lightSpecular:n.specular||[.8,.8,.8],light0_viewDirection:n.direction||[1,1,-1]}}}const sa=[1,1,1];class oa extends ii{createGeometry(t){const{data:e,indices:n}=t,i=new r["m"].Geometry(e,n,0,{primitive:"lines"});return i.generateBuffers(this.regl),{geometry:i,symbolIndex:{index:0}}}createMesh(t,e){const{geometry:n}=t,i=new r["m"].Mesh(n);if(i.castShadow=!1,this.sceneConfig.animation){sa[2]=.01;const t=[];r["k"].fromScaling(t,sa),r["k"].multiply(t,e,t),e=t}return i.setLocalTransform(e),i.properties.symbolIndex={index:0},i}addMesh(t,e){if(!t.length)return this;let n;null!==e?(0===e&&(e=.01),n=t[0].localTransform,sa[2]=e,r["k"].fromScaling(n,sa),r["k"].multiply(n,t[0].properties.tileTransform,n)):n=t[0].properties.tileTransform;for(let r=0;r<t.length;r++)t[r].setLocalTransform(n);return this.scene.addMesh(t),this}init(){const t=this.regl;this.scene=new r["m"].Scene,this.renderer=new r["m"].Renderer(t);const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={vert:"\n    attribute vec3 aPosition;\n    attribute vec4 aColor;\n\n    uniform mat4 projViewModelMatrix;\n    uniform vec2 outSize;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n        vColor = aColor / 255.0;\n    }\n",frag:"\n    #ifdef GL_ES\n        precision lowp float;\n    #endif\n\n    uniform float opacity;\n\n    varying vec4 vColor;\n\n    void main()\n    {\n        gl_FragColor = vColor * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{stencil:{enable:!0,func:{cmp:"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},viewport:e}};this.shader=new r["m"].MeshShader(n)}getUniformValues(t){const e=this.sceneConfig.opacity||.3,n=this.layer.getRenderer().canvas;return{projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],opacity:e}}}const{getPBRUniforms:aa}=r["m"].pbr.PBRUtils;class la extends ea{constructor(...t){super(...t),this.vo=new r["m"].ResourceLoader(null,this.layer.getURLModifier()),this.scene.sortFunction=this.sortByCommandKey}supportRenderMode(t){return this.getSymbols()[0].ssr?"fxaa"===t||"fxaaAfterTaa"===t:super.supportRenderMode(t)}isAnimating(){const t=this.xo();if(t&&(t[0]||t[1]))return!0}needToRedraw(){const t=this.xo();return!(!t||!t[0]&&!t[1])||super.needToRedraw()}xo(){const t=this.getSymbols()[0];return t.material&&t.material.uvOffsetAnim}createGeometry(t){if(!t.data||!t.data.aPosition||!t.data.aPosition.length)return null;const e={uv0Attribute:"aTexCoord0"};t.aAltitude&&(e.altitudeAttribute="aAltitude");const n=new r["m"].Geometry(t.data,t.indices,0,e);return qt(n.properties,t.properties),t.vertexColors&&(n.properties.vertexColors=t.vertexColors),this.material.uniforms.normalTexture&&!n.data[n.desc.tangentAttribute]&&n.data[n.desc.uv0Attribute]&&(n.data[n.desc.normalAttribute]||n.createNormal(),n.createTangent()),this.pr(n,t),{geometry:n,symbolIndex:{index:0}}}paint(t){const e=!!t.shadow;t.states&&t.states.includesChanged&&(this.shader.dispose(),delete this.shader,this.bo.dispose(),delete this.bo,this.Ar(t));let n=!!t.ssr&&this.getSymbols()[0].ssr;const r=this.shader,i=r.shaderDefines;if(n){const e=qt({},i,t.ssr.defines);r.shaderDefines=e}if(t.onlyUpdateDepthInTaa&&(this.shader=this.bo,!n&&this.Ao&&(this.shader=r,this.setToRedraw(!0))),this.updateIBLDefines(r),super.paint(t),void 0!==this.shadowCount&&e){const t=this.scene.getMeshes().length;this.shadowCount!==t&&this.setToRedraw()}this.shader=r,n&&(r.shaderDefines=i),delete this.shadowCount,this.Ao=n}updateSceneConfig(t){qt(this.sceneConfig,t),this.setToRedraw()}delete(){super.delete(),this.disposeIBLTextures(),this.material.dispose(),this.bo&&(this.bo.dispose(),delete this.bo)}init(t){this.getMap().on("updatelights",this.wo,this),this.createIBLTextures(),this.Mr=this.Mr||t;const e=this.regl;this.renderer=new r["m"].Renderer(e),this._o=this.So.bind(this),this.Mo=this.disposeCachedTexture.bind(this),this.Po=this.To.bind(this),this.si(),this.Ar(t);const n={vert:"\n                #include <gl2_vert>\n                attribute vec3 aPosition;\n                uniform mat4 projViewModelMatrix;\n                uniform mat4 positionMatrix;\n                //fbo pickingvert\n                #include <line_extrusion_vert>\n                #include <get_output>\n                #include <fbo_picking_vert>\n                void main() {\n                    mat4 localPositionMatrix = getPositionMatrix();\n                    #ifdef IS_LINE_EXTRUSION\n                        vec3 linePosition = getLineExtrudePosition(aPosition);\n                        vec4 localVertex = getPosition(linePosition);\n                    #else\n                        vec4 localVertex = getPosition(aPosition);\n                    #endif\n\n                    gl_Position = projViewModelMatrix * localPositionMatrix * localVertex;\n                    fbo_picking_setData(gl_Position.w, true);\n                }\n            ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:this.pickingViewport,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<=",mask:!!Qt(this.sceneConfig.depthMask)||this.sceneConfig.depthMask}}};this.picking=[new r["m"].FBORayPicking(this.renderer,n,this.layer.getRenderer().pickingFBO,this.getMap())]}Ar(t){const e={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},n={},i=[];i.push(...r["m"].SsrPass.getUniformDeclares()),this.fillIncludes(n,i,t);const s={cull:{enable:()=>void 0===this.sceneConfig.cullFace||!!this.sceneConfig.cullFace,face:()=>this.sceneConfig.cullFace||"back"},stencil:{enable:(t,e)=>void 0===e.hasAlpha||!!e.hasAlpha,func:{cmp:"<=",ref:(t,e)=>e.stencilRef},op:{fail:"keep",zfail:"keep",zpass:"replace"}},viewport:e,depth:{enable:!0,range:this.sceneConfig.depthRange||[0,1],func:this.sceneConfig.depthFunc||"<="},blend:{enable:(t,e)=>void 0===e.hasAlpha||!!e.hasAlpha,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}},o={uniforms:i,defines:this.ko(n),extraCommandProps:s};this.shader=new r["m"].pbr.StandardShader(o),o.frag="\n            precision mediump float;\n            #include <gl2_frag>\n            void main() {\n                glFragColor = vec4(0.0);\n                #if __VERSION__ == 100\n                    gl_FragColor = glFragColor;\n                #endif\n            }\n        ",this.bo=new r["m"].pbr.StandardShader(o)}So({resources:t}){for(let e=0;e<t.length;e++)this.addCachedTexture(t[e].url,t[e].data);this.setToRedraw(!0)}To(){this.setToRedraw(!0)}si(t){if(t){const e=this.getSymbols()[0].material;e&&qt(e,t)}const e=this.layer instanceof i["H"],n=this.dataConfig,s=t||this.getSymbols()[0].material,o={};let a=!1;for(const i in s)if(ie(s,i))if(i.indexOf("Texture")>0){let t=s[i];if(!t){o[i]=void 0;continue}const e="string"==typeof t?t:t.url,l=this.getCachedTexture(e);l?l.then?e===t?t={promise:l,wrap:"repeat"}:t.promise=l:e===t?t={data:l,wrap:"repeat"}:t.data=l:e===t&&(t={url:e,wrap:"repeat"}),t.flipY=!n.upsideUpTexture,t.min="linear mipmap linear",t.mag="linear",o[i]=new r["m"].Texture2D(t,this.vo),o[i].once("complete",this._o),o[i].once("disposed",this.Mo),o[i].promise&&this.addCachedTexture(e,o[i].promise),a=!0}else o[i]=s[i],"uvRotation"===i&&(o[i]=Math.PI*o[i]/180,e||(o[i]*=-1));if(void 0===o.alphaTest&&this.getMaterialClazz&&(o.alphaTest=.05),this.material){for(let t in o)this.material.set(t,o[t]);this.setToRedraw(!0)}else this.material=new r["m"].pbr.StandardMaterial(o),this.material.once("complete",this.Po);a||this.To()}getShader(){return this.shader}getUniformValues(t,e){const{iblTexes:n,dfgLUT:r}=this.getIBLRes(),i=aa(t,n,r,e&&e.ssr,e&&e.jitter);return this.setIncludeUniformValues(i,e),i}ko(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}wo(){if(!this.shader)return;const t=this.shader.shaderDefines;this.ko(t),this.shader.shaderDefines=t}}var ha="#include <gl2_vert>\n#define EXTRUDE_SCALE 63.0\n#define EXTRUDE_MOD 64.0\n#define MAX_LINE_DISTANCE 65535.0\nuniform mat4 projViewModelMatrix;\nuniform vec2 centiMeterToLocal;\n#ifdef HAS_ALTITUDE\nattribute vec2 aPosition;\nattribute float aAltitude;\n#else\nattribute vec3 aPosition;\n#endif\nattribute vec4 aTubeNormal;\n#ifdef HAS_LINE_WIDTH\nattribute float aLineWidth;\n#else\nuniform float lineWidth;\n#endif\n#include <vt_position_vert>\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#else\nuniform mat4 modelViewMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelMatrix;\n#if defined(HAS_PATTERN)\nuniform float resolution;\nuniform float tileResolution;\nuniform float tileRatio;\nattribute float aLinesofar;\nvarying highp float vLinesofar;\nattribute vec4 aTexInfo;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvarying float vPatternHeight;\nattribute float aNormalDistance;\n#if defined(HAS_PATTERN_ANIM)\nattribute float aLinePatternAnimSpeed;\nvarying float vLinePatternAnimSpeed;\n#endif\n#if defined(HAS_PATTERN_GAP)\nattribute float aLinePatternGap;\nvarying float vLinePatternGap;\n#endif\n#endif\n#ifdef HAS_COLOR\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\nvarying vec3 vModelVertex;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <highlight_vert>\nvoid main() {\n  \n#ifdef HAS_LINE_WIDTH\nfloat c = aLineWidth;\n#else\nfloat c = lineWidth;\n#endif\nfloat d = c / 2.;\n  vec3 e = aTubeNormal.xyz / EXTRUDE_SCALE;\n  vec3 f = unpackVTPosition();\n  vec4 h = vec4(f, 1.);\n  h.xy += e.xy * d * centiMeterToLocal;\n  h.z += e.z * d;\n  gl_Position = projViewModelMatrix * h;\n#ifdef PICKING_MODE\nfbo_picking_setData(gl_Position.w, true);\n#else\nvViewVertex = modelViewMatrix * h;\n  vec3 i = normalize(e);\n  vModelNormal = modelNormalMatrix * i;\n  vModelVertex = (modelMatrix * h).xyz;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(h);\n#endif\n#ifdef HAS_COLOR\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\n#ifdef HAS_PATTERN\nfloat j = tileResolution / resolution;\n  float k = aLinesofar - d * centiMeterToLocal.y * aNormalDistance / EXTRUDE_SCALE;\n  vLinesofar = k / tileRatio * j;\n  vTexInfo = vec4(aTexInfo.xy, aTexInfo.zw + 1.);\n  vPatternHeight = c * centiMeterToLocal.x / tileRatio * j;\n  vNormalY = aTubeNormal.w / EXTRUDE_SCALE;\n#if defined(HAS_PATTERN_ANIM)\nvLinePatternAnimSpeed = aLinePatternAnimSpeed / 127.;\n#endif\n#if defined(HAS_PATTERN_GAP)\nvLinePatternGap = aLinePatternGap / 10.0;\n#endif\n#endif\nhighlight_setVarying();\n#endif\n}";const{getPBRUniforms:ca}=r["m"].pbr.PBRUtils;class ua extends ai{needToRedraw(){return super.needToRedraw()||this.isAnimating()}isTerrainSkin(){return!1}isTerrainVector(){return!0}supportRenderMode(t){return this.isAnimating()?"fxaa"===t||"fxaaAfterTaa"===t:"taa"===t||"fxaa"===t}isAnimating(){if(this.wr)return!0;const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e].linePatternFile&&t[e].linePatternAnimSpeed)return!0;return!1}isBloom(t){return!!this.getSymbol(t.properties.symbolIndex).lineBloom}createMesh(t,e){if(!t.geometry)return null;const n=this.getMap(),{geometry:s,symbolIndex:a,ref:l}=t,h=this.getSymbolDef(a);void 0===l&&_r(s,h,this.getFnTypeConfig(a));const c=this.getSymbol(a),{tileResolution:u,tileRatio:f}=s.properties,d={tileResolution:u,tileRatio:f};Zt(d,"lineColor",c,"lineColor","#fff",$t(this.colorCache)),Zt(d,"linePatternGapColor",c,"linePatternGapColor",[1,1,1,1],$t(this.colorCache)),Zt(d,"lineWidth",c,"lineWidth",2,t=>o["n"].getTubeSizeScale(this.dataConfig.metric)*t),Zt(d,"lineOpacity",c,"lineOpacity",1),Zt(d,"linePatternAnimSpeed",c,"linePatternAnimSpeed",0),Zt(d,"linePatternGap",c,"linePatternGap",0),Zt(d,"metallicFactor",c,"metallicFactor",0),Zt(d,"roughnessFactor",c,"roughnessFactor",.4),Zt(d,"emissiveFactor",c,"emissiveFactor",[0,0,0]),Zt(d,"uvScale",c,"uvScale",[1,1]);const p=s.properties.iconAtlas,A=this.layer instanceof i["H"];p&&(d.linePatternFile=hi(this.regl,p,!1),d.atlasSize=p?[p.width,p.height]:[0,0],d.flipY=A?-1:1,this.drawDebugAtlas(p)),void 0===l&&s.generateBuffers(this.regl),d.alphaTest=-1;const g=new r["m"].pbr.StandardMaterial(d),m=new r["m"].Mesh(s,g,{castShadow:!1,picking:!0}),y=n.distanceToPointAtRes(100,100,s.properties.tileResolution)._multi(f/1e4).toArray();m.setUniform("centiMeterToLocal",y);const v=n.getResolution(n.getMaxNativeZoom());m.setUniform("animSpeedScale",u/v),m.setLocalTransform(e);const x={IS_LINE_EXTRUSION:1,HAS_LAYER_OPACITY:1};return"square-tube"===this.dataConfig.type&&(x.IS_SQUARE_TUBE=1),p&&(x.HAS_PATTERN=1),m.properties.symbolIndex=a,s.data.aColor&&(x.HAS_COLOR=1),this.setMeshDefines(x,s,h),s.data.aAltitude&&(x.HAS_ALTITUDE=1),m.setDefines(x),m}setMeshDefines(t,e,n){e.data.aOpacity&&(t.HAS_OPACITY=1),e.data.aLineWidth&&(t.HAS_LINE_WIDTH=1),Nr(n.linePatternAnimSpeed)&&(t.HAS_PATTERN_ANIM=1),Nr(n.linePatternGap)&&(t.HAS_PATTERN_GAP=1)}paint(t){t.states&&t.states.includesChanged.shadow&&(this.shader.dispose(),this.createShader(t)),super.paint(t)}init(t){this.getMap().on("updatelights",this.wo,this),this.createIBLTextures();const e=this.regl;if(this.renderer=new r["m"].Renderer(e),this.createShader(t),this.pickingFBO){const t=[];this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:"#define PICKING_MODE 1\n"+ha,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelNormalMatrix",type:"function",fn:(e,n)=>r["j"].fromMat4(t,n.modelMatrix)}],extraCommandProps:this.getExtraCommandProps()},this.pickingFBO,this.getMap())]}}createShader(t){this.Mr=t;const e=[],n={};this.fillIncludes(n,e,t),e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}),this.shader=new r["m"].pbr.StandardShader({vert:ha,uniforms:e,defines:this.ko(n),extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.canvas,e={x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},n=this.sceneConfig.depthRange;return{viewport:e,stencil:{enable:!0,func:{cmp:()=>"<=",ref:(t,e)=>e.level},op:{fail:"keep",zfail:"keep",zpass:"replace"}},cull:{enable:()=>!!this.sceneConfig.cullFace,face:this.sceneConfig.cullFace||"back"},depth:{enable:!0,range:n||[0,1],mask:this.sceneConfig.depthMask||!0,func:this.sceneConfig.depthFunc||"<="},blend:{enable:!0,func:this.getBlendFunc(),equation:"add"},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}}getUniformValues(t,e){const{iblTexes:n,dfgLUT:r}=this.getIBLRes(),i=ca(t,n,r,null,e&&e.jitter),s=t.projViewMatrix,o=t.viewMatrix;return i.projViewMatrix=s,i.viewMatrix=o,i.resolution=t.getResolution(),i.currentTime=this.layer.getRenderer().getFrameTimestamp()||0,this.setIncludeUniformValues(i,e),i}createFnTypeConfig(t,e){const n=Object(s["e"])(e.lineColor),r=Object(s["e"])(e.aLinePatternAnimSpeed),i=Object(s["e"])(e.aLinePatternGap),o=this.createShapeFnTypeConfigs(t,e),a=new Int8Array(2);return[{attrName:"aColor",symbolName:"lineColor",type:Uint8Array,width:4,define:"HAS_COLOR",evaluate:(e,r)=>{let i=n(t.getZoom(),e);return Object(s["c"])(i)&&(i=this.evaluateInFnTypeConfig(i,r,t,e,!0)),Array.isArray(i)||(i=this.colorCache[i]=this.colorCache[i]||l()(i).unitArray()),i=Jt(i),i}},{attrName:"aLinePattern",symbolName:"linePatternAnimSpeed",type:Int8Array,width:2,related:["linePatternGap"],define:"HAS_LINE_PATTERN",evaluate:(e,n,i,s)=>{let o=r(t.getZoom(),e);return Qt(o)&&(o=0),0!==o&&(n.properties.hasPatternAnim=1),a[0]=o/127,a[1]=i[s+1],a}},{attrName:"aLinePattern",symbolName:"linePatternGap",type:Int8Array,width:2,related:["linePatternAnimSpeed"],define:"HAS_LINE_PATTERN",evaluate:(e,n,r,s)=>{let o=i(t.getZoom(),e);return Qt(o)&&(o=0),a[1]=10*o,a[0]=r[s],a}}].concat(o)}createShapeFnTypeConfigs(t,e){const n=Object(s["b"])(e.lineWidth),r=Object(s["b"])(e.lineOpacity),i=new Uint16Array(1);return[{attrName:"aLineWidth",symbolName:"lineWidth",type:Uint8Array,width:1,define:"HAS_LINE_WIDTH",evaluate:(e,r)=>{let o=n(t.getZoom(),e);return Object(s["c"])(o)&&(o=this.evaluateInFnTypeConfig(o,r,t,e)),i[0]=Math.round(2*o),i[0]}},{attrName:"aOpacity",symbolName:"lineOpacity",type:Uint8Array,width:1,define:"HAS_OPACITY",evaluate:(e,n)=>{let o=r(t.getZoom(),e);return Object(s["c"])(o)&&(o=this.evaluateInFnTypeConfig(o,n,t,e)),i[0]=255*o,i[0]}}]}ko(t){return this.hasIBL()?t.HAS_IBL_LIGHTING=1:delete t.HAS_IBL_LIGHTING,t}wo(){if(!this.shader)return;const t=this.shader.shaderDefines;this.ko(t),this.shader.shaderDefines=t}delete(){super.delete(),this.disposeIBLTextures(),this.shader&&(this.shader.dispose(),delete this.shader)}}const fa=[],da=[],pa=[],Aa=[],ga=[],ma=[0,0,0],ya=[0,0,0],va=[1,1,1],xa=[],ba=[1,1,1,1],wa=[],_a=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],Ma=t=>class extends t{constructor(t,e,n,i,s,o){super(t,e,n,i,s,o),this.Oo=!1,this.scene.sortFunction=this.sortByCommandKey;const a=i.fetchOptions||{};a.referrer=window&&window.location.href,this.Io=new r["m"].GLTFManager(t,{fetchOptions:a,urlModifier:t=>{const n=e.getURLModifier();return n&&n(t)||t}}),this.Fo(),this.Co()}isAnimating(){const t=this.getSymbols();for(let e=0;e<t.length;e++)if(t[e]&&this.Eo[e]&&this.Do(e))return!0;return!1}createGeometry(t,e){const{data:n,positionSize:r}=t;return{geometry:{properties:qt({},t.properties),data:n,positionSize:r,features:e},symbolIndex:t.symbolIndex}}getFnTypeConfig(){return xa}createMesh(t,e,{tileTranslationMatrix:n,tileExtent:i},{timestamp:s}){if(!this.Oo)return null;const o=this.getMap(),{geometry:a}=t,{positionSize:l,features:h}=a,{aPosition:c,aPickingId:u,aXYRotation:f,aZRotation:d,aAltitude:p}=a.data,A=c.length/l;if(0===A)return null;const g={instance_vectorA:new Float32Array(4*A),instance_vectorB:new Float32Array(4*A),instance_vectorC:new Float32Array(4*A),aPickingId:[]},m=this.No(g,n,i,a.properties.z,c,p,f,d,l,u,h);a.data.aTerrainAltitude&&(g.aTerrainAltitude=a.data.aTerrainAltitude);const y={};for(const r in g)y[r]={buffer:this.regl.buffer({dimension:g[r].length/A,data:g[r]}),divisor:1};const v=this.Lo(),x=this.Ro(),b=r["k"].identity([]);r["k"].scale(b,b,[x,x,x]);const w=[],_=this.getSymbols();for(let M=0;M<_.length;M++){const t=_[M],e=this.Ho[M];if(!e)continue;const i=this.Eo[M][0],{fixSizeOnZoom:l}=t;let h=r["k"].identity([]);v||(h=this.zo(h));let c=0;e.forEach(e=>{const{geometry:n,nodeMatrix:i}=e;r["k"].multiply(wa,_a,i),r["k"].multiply(wa,h,wa);const s=r["k"].multiply(wa,b,wa),o=n.boundingBox.copy();o.transform(s);const a=this.Vo(o,t);Math.abs(a)>Math.abs(c)&&(c=a)});const u=[0,0,c],f=e.map((e,f)=>{const{geometry:d,materialInfo:p,morphWeights:v,extraInfo:x,nodeIndex:w}=e;t.alphaTest&&(p.alphaTest=t.alphaTest);const _=new(this.getMaterialClazz(p))(p),T={},S=new r["m"].InstancedMesh(y,A,d,_,{transparent:!1,picking:!0});if(i.hasSkinAnimation()){const t=this.Uo(S,M,0)[w];S.setUniform("jointTexture",t.jointTexture),S.setUniform("jointTextureSize",t.jointTextureSize),S.setUniform("numJoints",t.numJoints),S.setUniform("skinAnimation",+this.Do(M)),S.properties.startTime=s,T.HAS_SKIN=1}v&&(S.setUniform("morphWeights",v),T.HAS_MORPH=1),S.setUniform("hasAlpha",x.alphaMode&&"BLEND"===x.alphaMode.toUpperCase()),Zt(S.uniforms,"polygonFill",t,"markerFill",ba,$t(this.colorCache)),Zt(S.uniforms,"polygonOpacity",t,"markerOpacity",1);const I=[];S.setPositionMatrix(()=>{const t=this.jo(M,f,w);r["k"].multiply(I,_a,t),this.zo(h),r["k"].multiply(I,h,I),r["k"].multiply(I,b,I);const e=r["k"].identity(wa);if(0!==c&&(r["k"].fromTranslation(e,u),r["k"].multiply(I,e,I)),ne(l)){const t=o.getGLScale()/o.getGLScale(l);return r["p"].set(fa,t,t,t),r["k"].fromScaling(e,fa),r["k"].multiply(e,e,I)}return I});const C=this.layer.getRenderer().getZScale(),O=[],E=[];return S.setLocalTransform(()=>{const t=this.layer.options.altitude||0;return r["p"].copy(E,m),E[2]+=100*t*C,r["k"].translate(O,n,E),O}),d.generateBuffers(this.regl,{excludeElementsInVAO:!0}),g.instance_color&&(T.HAS_INSTANCE_COLOR=1),g.aTerrainAltitude&&(T.HAS_INSTANCE_TERRAIN_ALTITUDE=1,S.setUniform("terrainAltitudeScale",100*this.layer.getRenderer().getZScale())),T.HAS_LAYER_OPACITY=1,qt(S.properties,a.properties),S.setDefines(T),S.properties.symbolIndex={index:M},S});w.push(...f)}return w.insContext={instanceData:g,tileTranslationMatrix:n,tileExtent:i,aPosition:c,positionSize:l},w}jo(t,e,n){const r=t,i=this.Ho[r][e];return this.Do(t)&&this.Bo&&this.Bo[n]||i.nodeMatrix}Uo(t,e,n){if(!this.Eo)return;const r=this.Eo[e][0];this.Go||(this.Go={}),this.Bo={},this.Go[t.uuid]||(this.Go[t.uuid]={});const i=this.getSymbols()[e],s=this.Wo[e],{loop:o,speed:a,animationName:l}=i,h=l||s.animations[0].name;return r.updateAnimation(n,o||!1,a||1,h,t.properties.startTime||0,this.Bo,this.Go[t.uuid]),this.Go[t.uuid]}Vo(t,e){const n=e.anchorZ||"center";let r=0;const i=t.max[2]-t.min[2];return"bottom"===n?r=i/2:"top"===n&&(r=-i/2),r}addMesh(t,e,n){if(!t)return null;if(t[0].properties.level>2)return null;const r=n.timestamp;for(let i=0;i<t.length;i++){if(!t[i]||!t[i].geometry)continue;t[i].instancedData.aTerrainAltitude&&this.Bi(t[i],t[i].instancedData,t[i].properties,3,n);const e=t[i].properties.symbolIndex.index,s=this.Do(e);s&&this.Uo(t[i],e,r),t[i].setUniform("skinAnimation",+s)}return this.scene.addMesh(t),this}yr(t,e){t&&t.updateInstancedData&&t.updateInstancedData("aTerrainAltitude",e)}prepareRender(t){const e=this.getSymbols();let n=!1;for(let r=0;r<e.length;r++)if(e[r]&&this.Eo[r]&&this.Do(r)&&this.Eo[r]&&!n){n=!0;break}n&&this.setToRedraw(!0),super.prepareRender(t)}getShadowMeshes(){return this.isVisible()?(this.shadowCount=this.scene.getMeshes().length,this.scene.getMeshes().filter(t=>0===t.properties.level)):xa}Do(t){const e=this.getSymbols()[t];return!!(e&&e.animation&&this.Eo[t]&&this.Eo[t][0]&&this.Eo[t][0].hasSkinAnimation())}No(t,e,n,i,s,a,l,h,c,u,f){function d(e,n,r,i){t[e][4*n]=r[i],t[e][4*n+1]=r[i+4],t[e][4*n+2]=r[i+8],t[e][4*n+3]=r[i+12]}const p=s.length/c,A=this.layer.getTileSize().width/n*this.layer.getRenderer().getTileGLScale(i),g=this.layer.getRenderer().getZScale(),m=100*(this.dataConfig.altitudeOffset||0);let y=1/0,v=1/0,x=1/0,b=-1/0,w=-1/0,_=-1/0;const M=[],T=[];for(let k=0;k<p;k++){a?r["p"].set(T,s[k*c],s[k*c+1],a[k]):o["i"].unpackPosition(T,s[k*c],s[k*c+1],s[k*c+2]);const t=r["p"].set(M,T[0]*A,-T[1]*A,(T[2]+m)*g);t[0]<y&&(y=t[0]),t[0]>b&&(b=t[0]),t[1]<v&&(v=t[1]),t[1]>w&&(w=t[1]),t[2]<x&&(x=t[2]),t[2]>_&&(_=t[2])}const S=(y+b)/2,I=(v+w)/2,C=(x+_)/2,O=[],E=this.Lo(),P=[0,0,1];for(let k=0;k<p;k++){a?r["p"].set(T,s[k*c],s[k*c+1],a[k]):o["i"].unpackPosition(T,s[k*c],s[k*c+1],s[k*c+2]);const e=T[0],n=T[1],i=r["p"].set(M,e*A-S,-n*A-I,(T[2]+m)*g-C),p=l&&l[k]||0,y=h&&h[k]||0;if(p||y){r["k"].fromRotation(O,y,P);const t=r["p"].set(fa,e,n,0),s=r["p"].normalize(t,r["p"].cross(t,t,P));r["k"].rotate(O,O,p,s);const o=r["k"].fromTranslation(wa,i);r["k"].multiply(O,o,O)}else r["k"].fromTranslation(O,i);if(E){const t=this.zo(wa,f,u,k);r["k"].multiply(O,O,t)}d("instance_vectorA",k,O,0),d("instance_vectorB",k,O,1),d("instance_vectorC",k,O,2),t.aPickingId[k]=k}return r["p"].set(M,S,I,C),M}Ro(){if(!this.Xo){const t=this.getMap();this.Xo=100*St(t.getGLRes(),t)}return this.Xo}zo(t,e,n,i){const s=this.getMap(),o=this.symbolDef[0],a=this.Ro();let l=o.translationX||0,h=o.translationY||0,c=o.translationZ||0,u=o.rotationX||0,f=o.rotationY||0,d=o.rotationZ||0,p=o.scaleX||1,A=o.scaleY||1,g=o.scaleZ||1;const m=n&&n[i],y=e&&e[m],v=s.getZoom(),x=y&&y.feature&&y.feature.properties,b=this.Yo(v,x);this.$o&&(l=this.$o(v,x)),this.qo&&(h=this.qo(v,x)),this.Jo&&(c=this.Jo(v,x));const w=r["p"].set(da,l*a,h*a,c*a);this.Zo&&(u=this.Zo(v,x)),this.Ko&&(f=this.Ko(v,x)),this.Qo&&(d=this.Qo(v,x));const _=r["p"].set(pa,u,f,d);this.ta&&(p=this.ta(v,x)),this.ea&&(A=this.ea(v,x)),this.na&&(g=this.na(v,x));const M=r["p"].set(Aa,p*b,A*b,g*b);return this.ia(t,w,_,M)}Yo(t,e){const n=this.symbolDef[0];let r=this.ra?this.ra(t,e):n.modelHeight;if(wt(r))return 1;const i=this.sa[0];return r/Math.abs(i.max[1]-i.min[1])}getShaderConfig(){const t=super.getShaderConfig();return t.positionAttribute="POSITION",t.normalAttribute="NORMAL",t}init(t){super.init(t),this.Co()}Fo(){const t=this.symbolDef[0];Object(s["c"])(t.modelHeight)&&(this.ra=Object(s["b"])(t.modelHeight)),Object(s["c"])(t.translationX)&&(this.$o=Object(s["b"])(t.translationX)),Object(s["c"])(t.translationY)&&(this.qo=Object(s["b"])(t.translationY)),Object(s["c"])(t.translationZ)&&(this.Jo=Object(s["b"])(t.translationZ)),Object(s["c"])(t.rotationX)&&(this.Zo=Object(s["b"])(t.rotationX)),Object(s["c"])(t.rotationY)&&(this.Ko=Object(s["b"])(t.rotationY)),Object(s["c"])(t.rotationZ)&&(this.Qo=Object(s["b"])(t.rotationZ)),Object(s["c"])(t.scaleX)&&(this.ta=Object(s["b"])(t.scaleX)),Object(s["c"])(t.scaleY)&&(this.ea=Object(s["b"])(t.scaleY)),Object(s["c"])(t.scaleZ)&&(this.na=Object(s["b"])(t.scaleZ))}Lo(){return!!(this.ra&&!this.ra.isFeatureConstant||this.$o&&!this.$o.isFeatureConstant||this.qo&&!this.qo.isFeatureConstant||this.Jo&&!this.Jo.isFeatureConstant||this.Zo&&!this.Zo.isFeatureConstant||this.Ko&&!this.Ko.isFeatureConstant||this.Qo&&!this.Qo.isFeatureConstant||this.ta&&!this.ta.isFeatureConstant||this.ea&&!this.ea.isFeatureConstant||this.na&&!this.na.isFeatureConstant)}Co(){if(this.Eo)return;this.Eo=[],this.Wo=[],this.sa=[],this.Ho=[];const t=this.getSymbols();this.oa=0;for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.Io.loginGLTF(n);const r=this.Io.getGLTF(n);if(r.then)r.then(n=>{if(!n.gltfPack)return this.oa++,void(this.oa>=t.length&&(this.Oo=!0,this.setToRedraw(!0)));const{gltfPack:r,json:i,bbox:s}=n;this.Eo[e]=[r],this.Ho[e]=r.getMeshesInfo(),this.Wo[e]=i,this.sa[e]=s,this.oa++,this.oa>=t.length&&(this.Oo=!0),this.setToRedraw(!0)});else{const{gltfPack:t,json:n,bbox:i}=r;t&&(this.Eo[e]=[t],this.Ho[e]=t.getMeshesInfo(),this.Wo[e]=n,this.sa[e]=i,this.oa++)}}this.oa>=t.length&&(this.Oo=!0)}getPickingVert(){return"\n    attribute vec3 aPosition;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 modelMatrix;\n    uniform mat4 positionMatrix;\n    //fbo pickingvert\n    #include <fbo_picking_vert>\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        //gl_Positiondepth\n        fbo_picking_setData(gl_Position.w, true);\n    }"}deleteMesh(t){if(t){this.scene.removeMesh(t);for(let e=0;e<t.length;e++){const n=this.Go&&this.Go[t[e].uuid];if(n){for(const t in n)n[t].jointTexture&&n[t].jointTexture.destroy();delete this.Go[t[e].uuid]}t[e].disposeInstanceData(),t[e].dispose()}}}delete(){super.delete();const t=this.getSymbols();for(let e=0;e<t.length;e++){const n=t[e].url||"pyramid";this.Io.logoutGLTF(n)}if(this.Go){for(const t in this.Go){const e=this.Go[t];for(const t in e)e[t].jointTexture&&e[t].jointTexture.destroy()}delete this.Go}delete this.Bo}ia(t,e,n,i){const s=r["p"].set(fa,...e||ma),o=n||ya,a=i||va,l=r["l"].fromEuler(ga,o[0],o[1],o[2]);return r["k"].fromRotationTranslationScale(t,l,s,a)}};class Ta extends(Ma(ia)){getMaterialClazz(t){return t.diffuseFactor?r["m"].PhongSpecularGlossinessMaterial:r["m"].PhongMaterial}}class Sa extends(Ma(la)){getMaterialClazz(t){return t.specularGlossinessTexture||t.diffuseTexture?r["m"].pbr.StandardSpecularGlossinessMaterial:r["m"].pbr.StandardMaterial}}const{getPBRUniforms:Ia}=r["m"].pbr.PBRUtils,Ca={color:[2.0303,2.028,2.028],direction:[0,-.2717,-1]},Oa={index:0},Ea=[0,0,0],Pa=[2,2];class ka extends ai{supportRenderMode(t){return"fxaa"===t||"fxaaBeforeTaa"===t}needPolygonOffset(){return!0}isTerrainSkin(){return!1}isTerrainVector(){return!0}needToRedraw(){return!!super.needToRedraw()||this.getSymbol(Oa).animation}createMesh(t,e){const{geometry:n}=t;n.generateBuffers(this.regl);const i=new r["m"].Mesh(n,null,{castShadow:!1,picking:!0});return i.properties.symbolIndex=Oa,i.setLocalTransform(e),i}callShader(t,e){super.callShader(t,e),this.transformWater();const n=this.aa(this.getMap(),e);this.Wi+=this.renderer.render(this.la,n,this.ha,this.getRenderFBO(e))}addMesh(t,e){this.Sr(t,e),super.addMesh(...arguments)}Sr(t){const e=this.getSymbol(Oa).ssr;for(let n=0;n<t.length;n++)t[n].ssr=e?1:0}paint(t){t.states&&t.states.includesChanged&&(this.shader.dispose(),this.la.dispose(),this.Ar(t));const e=!!t.ssr&&this.getSymbol(Oa).ssr,n=this.la,r=n.shaderDefines;if(e){const e=qt({},r,t.ssr.defines);n.shaderDefines=e}this.updateIBLDefines(n),this.ua.ssr=e?1:0,super.paint(t),e&&(n.shaderDefines=r)}init(t){this.createIBLTextures();const e=this.regl;this.renderer=new r["m"].Renderer(e),this.createGround(),this.Ar(t),this.pickingFBO&&(this.picking=[new r["m"].FBORayPicking(this.renderer,{vert:li,uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:this.pickingViewport}},this.pickingFBO,this.getMap())]),this.ca()}ca(){const t=this.regl;this.fa||(this.fa=t.texture(2));const e=this.layer.getURLModifier(),n=this.getSymbol({index:0}),r=n.texWaveNormal,i=this.getCachedTexture(r),s=this;if(i)this.da||(i.isLoading?setTimeout(()=>{this.shader&&this.ca()},20):this.da=this.pa(t,i));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,s.da=s.pa(t,this),s.setToRedraw()},n.onerror=()=>{console.error("invalid water wave normal texture:"+r)},this.addCachedTexture(r,n),n.src=e&&e(r)||r}const o=n.texWavePerturbation,a=this.getCachedTexture(o);if(a)this.ma||(a.isLoading?setTimeout(()=>{this.ca(),this.shader},20):this.ma=this.pa(t,a));else{const n=new Image;n.isLoading=!0,n.onload=function(){delete this.isLoading,s.ma=s.pa(t,this),s.setToRedraw()},n.onerror=()=>{console.error("invalid water wave perturbation texture:"+o)},this.addCachedTexture(o,n),n.src=e&&e(o)||o}}pa(t,e){return this.fa?t.texture({width:e.width,height:e.height,mag:"linear",min:"linear mipmap linear",wrapS:"repeat",wrapT:"repeat",flipY:!0,data:e}):null}Ar(t){const e=this.canvas,n=[],i=[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=r["k"].multiply([],e.viewMatrix,e.modelMatrix),i=r["k"].invert(n,n),s=r["k"].transpose(i,i);return r["j"].fromMat4([],s)}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>r["k"].multiply([],e.viewMatrix,e.modelMatrix)},{name:"uEnvironmentTransform",type:"function",fn:(t,e)=>{const i=e.environmentOrientation||0;return r["j"].fromRotation(n,Math.PI*i/180)}}],s={TIME_NOISE_TEXTURE_REPEAT:.3737};this.fillIncludes(s,i,t);const o={x:0,y:0,width:()=>e?e.width:1,height:()=>e?e.height:1},a=this.sceneConfig.depthRange;this.shader=new r["m"].MeshShader({vert:"\n                attribute vec3 aPosition;\n\n                uniform mat4 projViewModelMatrix;\n\n                void main() {\n                    gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n                }\n            ",frag:"\n    #define SHADER_NAME WATER_STENCIL\n    precision mediump float;\n    void main() {\n        gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].multiply(n,e.projViewMatrix,e.modelMatrix),n}}],extraCommandProps:{viewport:o,colorMask:[!1,!1,!1,!1],stencil:{enable:!0,mask:255,func:{cmp:"<=",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:a||[0,1],func:this.sceneConfig.depthFunc||"<="},polygonOffset:{enable:!0,offset:this.getPolygonOffset()}}});const l={viewport:o,stencil:{enable:!0,mask:255,func:{cmp:"==",ref:254,mask:255},op:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!1}};i.push(...r["m"].SsrPass.getUniformDeclares()),this.la=new r["m"].MeshShader({vert:"#define SHADER_NAME WATER\nuniform mat4 modelMatrix;\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform vec2 uvOffset;\nuniform vec2 noiseUvOffset;\nuniform vec2 uvScale;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\n#ifdef HAS_SSR\nuniform mat4 modelViewMatrix;\nvarying vec4 vViewVertex;\n#endif\n#include <highlight_vert>\nmat3 c(in vec3 d) {\n  vec3 t = normalize(cross(d, vec3(.0, 1., .0)));\n  vec3 e = normalize(cross(d, t));\n  return mat3(t, e, d);\n}\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_vert>\n#endif\nconst vec3 f = vec3(0., 0., 1.);\nvoid main(void) {\n  vec4 h = vec4(aPosition, 1.);\n  vec4 i = modelMatrix * h;\n  vPos = i.xyz;\n  vTbnMatrix = c(f);\n  gl_Position = projViewModelMatrix * h;\n  vUv = aTexCoord * uvScale + uvOffset;\n  vNoiseUv = aTexCoord * uvScale * TIME_NOISE_TEXTURE_REPEAT + noiseUvOffset;\n#ifdef HAS_SSR\nvec4 j = modelViewMatrix * h;\n  vViewVertex = j;\n#endif\n#if defined(HAS_SHADOWING)\nshadow_computeShadowPars(h);\n#endif\nhighlight_setVarying();\n}",frag:"#define SHADER_NAME WATER\nprecision highp float;\nprecision highp sampler2D;\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nuniform float layerOpacity;\n#if defined(HAS_SHADOWING)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform sampler2D brdfLUT;\nuniform float rgbmRange;\nuniform mat3 uEnvironmentTransform;\nuniform vec3 diffuseSPH[9];\nvec3 c(const in vec3 d) {\n  vec3 e = uEnvironmentTransform * d;\n  float x = e.x;\n  float y = e.y;\n  float z = e.z;\n  vec3 f = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    f = hsv_apply(f, hdrHSV);\n  }\n  return max(f, vec3(.0));\n}\nvec3 h(const in vec3 i, const in float j, const in float k, const in float l) {\n  vec4 rgba = texture2D(brdfLUT, vec2(k, j));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float m = 1. / 65535.;\n  return (i * a + b * l) * m;\n}\n#else\nuniform vec3 ambientColor;\n#endif\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nvec3 o(const in vec4 u, const in float v) {\n  if(v <= .0)\n    return u.rgb;\n  return v * u.rgb * u.a;\n}\n#ifdef HAS_SSR\nvarying vec4 vViewVertex;\nuniform mat3 modelViewNormalMatrix;\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nuniform vec2 cameraNearFar;\nfloat A(const in vec4 B) {\n  return B.r + B.g / 255.;\n}\nfloat C(const in vec2 D, const in float E) {\n  vec3 F = vec3(.06711056, .00583715, 52.9829189);\n  return fract(F.z * fract(dot(D.xy + E * vec2(47., 17.) * .695, F.xy))) * .5;\n}\nvec3 G(const in float H, const in float I, const in vec2 J) {\n  float K = min(I - .01, H);\n  float L = floor(K);\n  float M = min(I, L + 1.);\n  float N = pow(2., M);\n  vec2 O = 2. * N / J;\n  if(K - L > .5)\n    N *= 2.;\n  return vec3(O, N);\n}\nvec2 P(const in vec2 Q, const in vec3 R) {\n  vec2 S = max(R.xy, min(1. - R.xy, Q));\n  return vec2(2. * S.x, R.z - 1. - S.y) / R.z;\n}\nvec3 T(const in mat4 U, const in vec3 V) {\n  vec4 W = U * vec4(V, 1.);\n  return vec3(.5 + .5 * W.xy / W.w, W.w);\n}\nvec3 X(const in float Y, const in vec2 S) {\n  return texture2D(TextureReflected, S).rgb;\n}\nfloat Z(float ba) {\n  highp mat4 U = projMatrix;\n  highp float z = ba * 2. - 1.;\n  return -U[3].z / (z + U[2].z);\n}\nfloat bb(const vec2 S) {\n  float ba = A(texture2D(TextureDepth, S));\n  return ba;\n}\nvec3 bc(const in float E, const in vec3 bd, const in vec3 be, const in vec3 bf, const in vec3 bg, const in float bh) {\n  vec2 bi;\n  bi.x = C(gl_FragCoord.yx, E);\n  bi.y = fract(bi.x * 52.9829189);\n  bi.y = mix(bi.y, 1., .7);\n  float bj = 2. * 3.14159 * bi.x;\n  float bk = pow(max(bi.y, .000001), bh / (2. - bh));\n  float bl = sqrt(1. - bk * bk);\n  vec3 bm = vec3(bl * cos(bj), bl * sin(bj), bk);\n  bm = bm.x * bd + bm.y * be + bm.z * bf;\n  return normalize((2. * dot(bg, bm)) * bm - bg);\n}\nfloat bn(const in float E) {\n  return (C(gl_FragCoord.xy, E) - .5);\n}\nvec3 bo(const in vec3 bp, const in float bq, const in vec3 br) {\n  vec3 bs = T(projMatrix, vViewVertex.xyz + br * bq);\n  bs.z = 1. / bs.z;\n  bs -= bp;\n  float bt = min(1., .99 * (1. - bp.x) / max(1e-5, bs.x));\n  float bu = min(1., .99 * (1. - bp.y) / max(1e-5, bs.y));\n  float bv = min(1., .99 * bp.x / max(1e-5, -bs.x));\n  float bw = min(1., .99 * bp.y / max(1e-5, -bs.y));\n  return bs * min(bt, bu) * min(bv, bw);\n}\nfloat bx(const in vec3 bp, const in vec3 bs, inout float by, inout float bz) {\n  float bA = (bz + by) * .5;\n  vec3 bB = bp + bs * bA;\n  float z = bb(bB.xy);\n  float ba = Z(z);\n  float bC = -1. / bB.z;\n  by = ba > bC ? by : bA;\n  bz = ba > bC ? bA : bz;\n  return bA;\n}\nvec4 bD(const in vec3 bp, const in float bq, in float bE, const in vec3 br, const in float j, const in float E) {\n  const int bF = 20;\n  float bG = 1. / float(bF);\n  bE *= bG;\n  vec3 bs = bo(bp, bq, br);\n  float bH = bG;\n  vec3 bI = vec3(.0, bH, 1.);\n  vec3 bB;\n  float z, ba, bC, bJ, bK, bL;\n  bool bM;\n  float bN = 1.;\n  float bA;\n  for(int bO = 0; bO < bF; bO++) {\n    bB = bp + bs * bI.y;\n    z = bb(bB.xy);\n    ba = Z(z);\n    bC = -1. / bB.z;\n    bJ = bC - ba;\n    bJ *= clamp(sign(abs(bJ) - bq * bG * bG), .0, 1.);\n    bM = abs(bJ + bE) < bE;\n    bK = clamp(bI.x / (bI.x - bJ), .0, 1.);\n    bL = bM ? bI.y + bK * bG - bG : 1.;\n    bI.z = min(bI.z, bL);\n    bI.x = bJ;\n    if(bM) {\n      float by = bI.y - bG;\n      float bz = bI.y;\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bA = bx(bp, bs, by, bz);\n      bN = bA;\n      break;\n    }\n    bI.y += bG;\n  }\n  return vec4(bp + bs * bN, 1. - bN);\n}\nvec3 bP(in vec4 bQ, const in float bR, const in vec3 bS, const in vec3 bT, const in float j) {\n  vec4 bU = mix(outputFovInfo[0], outputFovInfo[1], bQ.x);\n  bQ.xyz = vec3(mix(bU.xy, bU.zw, bQ.y), 1.) * -1. / bQ.z;\n  bQ.xyz = (reprojViewProjMatrix * vec4(bQ.xyz, 1.)).xyw;\n  bQ.xy /= bQ.z;\n  float bV = clamp(6. - 6. * max(abs(bQ.x), abs(bQ.y)), .0, 1.);\n  bQ.xy = .5 + .5 * bQ.xy;\n  return vec3(bQ.xy, 1.);\n}\nvec3 ssr(const in vec3 bS, const in vec3 bT, const in float j, const in vec3 d, const in vec3 bg) {\n  float bW = .0;\n  vec4 f = vec4(.0);\n  float bh = j * j;\n  bh = bh * bh;\n  vec3 bX = abs(d.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 bd = normalize(cross(bX, d));\n  vec3 be = cross(d, bd);\n  float bR = ssrFactor * clamp(-4. * dot(bg, d) + 3.8, .0, 1.);\n  bR *= clamp(4.7 - j * 5., .0, 1.);\n  vec3 bp = T(projMatrix, vViewVertex.xyz);\n  bp.z = 1. / bp.z;\n  vec3 br = bc(bW, bd, be, d, bg, bh);\n  float bq = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, br.z * .5 + .5);\n  float bE = .5 * bq;\n  vec4 bQ;\n  if(dot(br, d) > .001 && bR > .0) {\n    bQ = bD(bp, bq, bE, br, j, bW);\n    if(bQ.w > .0)\n      return bP(bQ, bR, bS, bT, j);\n    \n  }\n  return vec3(.0);\n}\n#endif\nconst vec3 bY = vec3(0., 0., 1.);\nuniform mat4 viewMatrix;\nuniform sampler2D normalTexture;\nuniform sampler2D heightTexture;\nuniform vec4 waveParams;\nuniform vec2 waterDir;\nuniform vec4 waterBaseColor;\nuniform vec3 lightDirection;\nuniform vec3 lightColor;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vUv;\nvarying vec2 vNoiseUv;\nvarying vec3 vPos;\nvarying mat3 vTbnMatrix;\nfloat bZ(vec3 e, float ca) {\n  float cb = max(.015, ca);\n  return max((e.x + e.y) * .3303545 / cb + .3303545, .0);\n}\nconst vec2 cc = vec2(6. / 25., 5. / 24.);\nvec2 cd(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rg - 1.;\n}\nfloat cf(vec2 S) {\n  return texture2D(heightTexture, S).b;\n}\nvec3 cg(sampler2D ce, vec2 S) {\n  return 2. * texture2D(ce, S).rgb - 1.;\n}\nfloat ch(vec2 S, float ci) {\n  return fract(ci);\n}\nfloat cj(vec2 S, float ci) {\n  float ck = ch(S, ci);\n  return 1. - abs(1. - 2. * ck);\n}\nvec3 cl(sampler2D cm, vec2 S, float ci, float cn) {\n  float co = waveParams[2];\n  float cp = waveParams[3];\n  vec2 cq = cd(cm, S) * co;\n  float ck = ch(S, ci + cn);\n  float cr = cj(S, ci + cn);\n  vec2 f = S;\n  f -= cq * (ck + cp);\n  f += cn;\n  f += (ci - ck) * cc;\n  return vec3(f, cr);\n}\nconst float cs = 7.77;\nvec3 ct(sampler2D cu, sampler2D cv, vec2 cw, vec2 cx, float ci) {\n  float ca = waveParams[0];\n  vec2 cy = ci * -cx;\n  float cz = cf(vNoiseUv) * cs;\n  vec3 cA = cl(cv, cw + cy, ci + cz, .0);\n  vec3 cB = cl(cv, cw + cy, ci + cz, .5);\n  vec3 cC = cg(cu, cA.xy) * cA.z;\n  vec3 cD = cg(cu, cB.xy) * cB.z;\n  vec3 cE = normalize(cC + cD);\n  cE.xy *= ca;\n  cE.z = sqrt(1. - dot(cE.xy, cE.xy));\n  return cE;\n}\nvec4 cF(vec2 cw, float cG) {\n  float cH = waveParams[1];\n  vec3 d = ct(normalTexture, heightTexture, cw * cH, waterDir, cG);\n  float cI = bZ(d, waveParams[0]);\n  return vec4(d, cI);\n}\nconst float cJ = 3.141592653589793;\nconst float cK = 1. / cJ;\nconst float cL = .3183098861837907;\nconst float cM = 1.570796326794897;\nconst float cN = .4;\nfloat cO = 2.2;\nvec3 cP(float cQ, vec3 cR, float l) {\n  return cR + (l - cR) * pow(1. - cQ, 5.);\n}\nfloat cS(float cT, float j) {\n  float cU = j * j;\n  float cV = cT * cT;\n  float cW = pow((cV * (cU - 1.) + 1.), cO) * cJ;\n  return cU / cW;\n}\nfloat cX(float cY) {\n  return .25 / (cY * cY);\n}\nvec3 cZ(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float da = 2.2;\nconst float db = .4545454545;\nvec4 dc(vec4 u) {\n  return vec4(pow(u.rgb, vec3(db)), u.w);\n}\nvec3 dd(vec3 u) {\n  return pow(u, vec3(da));\n}\nconst vec3 de = vec3(.02, 1., 5.);\nconst vec2 df = vec2(.02, .1);\nconst float j = .06;\nconst float dg = 1.7;\nconst vec3 dh = vec3(0, .6, .9);\nconst vec3 di = vec3(.72, .92, 1.);\nconst float dj = .65;\nconst float dk = 300000.0;\nconst float dl = 500000.0;\nconst float dm = .775;\nconst float dn = .8;\nPBRShadingWater dp;\nvec3 dq(in PBRShadingWater dr, float j, vec3 ds, float dt) {\n  vec3 du = cP(dr.VdotH, ds, dt);\n  float dv = cS(dr.NdotH, j);\n  float dw = cX(dr.LdotH);\n  float dx = mix(j + .045, j + .385, 1. - dr.VdotH);\n  float dy = 1.2;\n  float dz = cS(dr.NdotH, dx) * dy;\n  return ((dv + dz) * dw) * du;\n}\nvec3 dA(float dg, float dB, vec3 dh, float dC) {\n  return dg * (.075 * dh * pow(dB, 4.) + 50. * pow(dB, 23.)) * dC;\n}\nvec3 dD(in float bk, in vec3 dE, in vec3 dF) {\n  float dG = pow((1. - bk), de[2]);\n  return mix(dF, dE, dG);\n}\nvec3 dH(in vec3 e, in vec3 dI, in float dJ, in float j) {\n  \n#ifdef HAS_IBL_LIGHTING\nvec3 dK = reflect(-dI, e);\n  vec4 dL = textureCube(prefilterMap, uEnvironmentTransform * dK);\n  float dM = clamp(1. + dot(dK, e), .0, 1.);\n  dL *= dM * dM;\n  vec3 i = o(dL, rgbmRange);\n  vec3 dN = c(e);\n  float l = clamp(50.0 * waterBaseColor.g, .0, 1.);\n  vec3 dO = h(waterBaseColor.rgb, j, dot(e, dI), l);\n  return i * dO + dN;\n#else\nvec3 dP = dd(di);\n  vec3 dQ = dd(dh);\n  vec3 di = dD(dJ, dP, dQ);\n  return di;\n#endif\n}\nvec3 dR(in vec3 e, in vec3 dI, in vec3 dS, vec3 u, in vec3 dT, in vec3 dU, in float dV, float dW, vec3 dX) {\n  float dY = 0.;\n  vec3 dZ = dd(u);\n  vec3 bm = normalize(dS + dI);\n  dp.NdotL = clamp(dot(e, dS), .0, 1.);\n  dp.NdotV = clamp(dot(e, dI), .001, 1.);\n  dp.VdotN = clamp(dot(dI, e), .001, 1.);\n  dp.NdotH = clamp(dot(e, bm), .0, 1.);\n  dp.VdotH = clamp(dot(dI, bm), .0, 1.);\n  dp.LdotH = clamp(dot(dS, bm), .0, 1.);\n  float dJ = max(dot(dU, dI), .0);\n  vec3 di = dH(e, dI, dJ, j);\n  float ea = max(dot(dU, dS), .0);\n  float eb = .1 + ea * .9;\n  di *= eb;\n  float ec = clamp(dV, .8, 1.);\n  vec3 ed = cP(dp.VdotN, vec3(de[0]), de[1]);\n  vec3 ee = ed * di * ec;\n  vec3 ef = dZ * mix(di, ea * dT * cK, 2. / 3.) * ec;\n  vec3 i = vec3(.0);\n  if(dJ > .0 && ea > .0) {\n    vec3 eg = dq(dp, j, vec3(df[0]), df[1]);\n    vec3 eh = dT * cK * dV;\n    i = dp.NdotL * eh * eg;\n  }\n  vec3 cI = vec3(.0);\n  if(dJ > .0) {\n    cI = dA(dg, dW, dh, eb);\n  }\n  vec3 ei = vec3(.0);\n#ifdef HAS_SSR\nfloat ej = smoothstep(dl, dk, -dX.z);\n  mat4 ek = viewMatrix;\n  vec4 el = vec4(dX.xyz, 1.);\n  vec3 em = normalize(el.xyz);\n  vec4 en = ek * vec4(e, .0);\n  vec3 eo = normalize(en.xyz);\n  vec4 ep = ek * vec4(dU, .0);\n  float eq = pow(max(dot(-em, ep.xyz), .0), cN);\n  vec3 er = mix(ep.xyz, eo, eq);\n  vec3 es = ssr(vec3(.0), vec3(1.), j, normalize(er), -normalize(vViewVertex.xyz));\n  if(es.z > .0) {\n    vec2 et = smoothstep(.3, .6, abs(vec2(.5) - es.xy));\n    dY = dm * clamp(1. - 1.3 * et.y, .0, 1.) * ej;\n    vec3 eu = X(.0, es.xy);\n    ei = dd(eu) * dY * ed.y * dj;\n  }\n#endif\nfloat ev = mix(dn, dn * .5, dY);\n  return cZ((1. - dY) * ee + ei + ef * ev + i + cI);\n}\nvoid main() {\n  vec3 dU = bY;\n  vec4 ew = cF(vUv, timeElapsed);\n  vec3 e = normalize(vTbnMatrix * ew.xyz);\n  vec3 dI = -normalize(vPos - camPos);\n  vec3 dS = normalize(-lightDirection);\n#if defined(HAS_SHADOWING)\nfloat dV = shadow_computeShadow();\n#else\nfloat dV = 1.;\n#endif\nvec4 ex = viewMatrix * vec4(vPos, 1.);\n  vec4 ey = vec4(dR(e, dI, dS, waterBaseColor.rgb, lightColor, dU, dV, ew.w, ex.xyz), waterBaseColor.a);\n  gl_FragColor = dc(ey);\n  if(contrast != 1.) {\n    gl_FragColor = contrastMatrix(contrast) * gl_FragColor;\n  }\n  if(length(hsv) > .0) {\n    gl_FragColor = hsv_apply(gl_FragColor, hsv);\n  }\n  gl_FragColor = highlight_blendColor(gl_FragColor) * layerOpacity;\n}",defines:s,uniforms:i,extraCommandProps:l})}needClearStencil(){return!0}getUniformValues(t){return{projViewMatrix:t.projViewMatrix}}aa(t,e){const{iblTexes:n,dfgLUT:i}=this.getIBLRes(),s=Ia(t,n,i,e&&e.ssr,e&&e.jitter),o=t.getLightManager();let a=o&&o.getDirectionalLight()||{};const l=o&&o.getAmbientLight()||{},h=this.getSymbol(Oa),c=this.ya=this.ya||[],u=this.ga=this.ga||[];r["q"].set(u,.09,h.uvScale||3,.03,-.5),qt(s,{ambientColor:l.color||[.2,.2,.2],viewMatrix:t.viewMatrix,lightDirection:a.direction||Ca.direction,lightColor:a.color||Ca.color,camPos:t.cameraPosition,timeElapsed:h.animation?(this.layer.getRenderer().getFrameTimestamp()||0)/(1/(h.waterSpeed||1)*1e4):0,normalTexture:this.da||this.fa,heightTexture:this.ma||this.fa,waveParams:u,waterDir:Ra(c,h.waterDirection||0),waterBaseColor:h.waterBaseColor||[.1451,.2588,.4863,1],contrast:h.contrast||1,hsv:h.hsv||Ea});const f=this.layer.getRenderer();return s.layerOpacity=f.ne(),this.setIncludeUniformValues(s,e),e&&e.ssr&&e.ssr.renderUniforms&&qt(s,e.ssr.renderUniforms),s}delete(){super.delete(),this.fa&&(this.fa.destroy(),delete this.fa),this.da&&this.da.destroy(),this.ma&&this.ma.destroy(),this.shader&&(this.shader.dispose(),delete this.shader),this.la&&this.la.dispose(),this.ua&&(this.ua.geometry.dispose(),this.ua.material&&this.ua.material.dispose(),this.ua.dispose(),delete this.ua),this.disposeIBLTextures()}createGround(){const t=new r["m"].Plane;t.data.aTexCoord=new Uint8Array([0,1,1,1,0,0,1,0]),t.generateBuffers(this.renderer.regl),this.ua=new r["m"].Mesh(t,null,{castShadow:!1}),this.ha=new r["m"].Scene([this.ua])}transformWater(){const t=this.getMap(),e=r["a"].getGroundTransform(this.ua.localTransform,t);this.ua.setLocalTransform(e);const n=t._get2DExtentAtRes(t.getGLRes()),i=n.getWidth(),s=n.getHeight(),o=t.cameraLookAt,a=o[0]-i,l=o[1]+s,h=a/Pa[0],c=l/Pa[1],u=h%1,f=c%1,d=.3737*h%1,p=.3737*c%1,A=i/Pa[0]*2,g=s/Pa[1]*2;this.ua.setUniform("uvOffset",[u,f]),this.ua.setUniform("noiseUvOffset",[d,p]),this.ua.setUniform("uvScale",[A,-g])}}function Ra(t,e){var n;return n=e,e=Math.PI*n/180,t[0]=Math.sin(e),t[1]=Math.cos(e),t}const Na=vr("fill",xi);Na.registerAt(Ie);const Da=vr("line",Mi);Da.registerAt(Ie);const Fa=vr("line-gradient",Ti);Fa.registerAt(Ie);const La=vr("icon",Ks);La.registerAt(Ie);const za=vr("text",Lo);za.registerAt(Ie);const Ba=vr("native-line",qo);Ba.registerAt(Ie),vr("native-point",jo).registerAt(Ie);const Ha=vr("phong",ia);Ha.registerAt(Ie);const Ua=vr("wireframe",oa);Ua.registerAt(Ie);const ja=vr("lit",la);ja.registerAt(Ie);const Va=vr("tube",ua);Va.registerAt(Ie);const Ga=vr("gltf-phong",Ta);Ga.registerAt(Ie);const qa=vr("gltf-lit",Sa);qa.registerAt(Ie);const Wa=vr("heatmap",class extends ai{createFnTypeConfig(t,e){const n=Object(s["b"])(e.heatmapWeight),r=new Int16Array(1);return[{attrName:"aWeight",symbolName:"heatmapWeight",type:Int16Array,width:1,define:"HAS_HEAT_WEIGHT",evaluate:e=>{const i=n(t.getZoom(),e);return r[0]=255*i,r[0]}}]}createMesh(t,e){const{geometry:n,symbolIndex:i,ref:s}=t;void 0===s&&_r(n,this.getSymbolDef(i),this.getFnTypeConfig(i));const o=this.getSymbol(i),a={tileRatio:n.properties.tileRatio,dataResolution:n.properties.tileResolution};Zt(a,"heatmapIntensity",o,"heatmapIntensity",1),Zt(a,"heatmapRadius",o,"heatmapRadius",6),Zt(a,"heatmapWeight",o,"heatmapWeight",1),Zt(a,"heatmapOpacity",o,"heatmapOpacity",1),n.generateBuffers(this.regl);const l=new r["m"].Material(a),h=new r["m"].Mesh(n,l,{transparent:!0,castShadow:!1,picking:!0}),c={};return n.data.aWeight&&(c.HAS_HEAT_WEIGHT=1),h.setDefines(c),h.setLocalTransform(e),h.properties.symbolIndex=i,h}callRenderer(t,e,n){const r=this.getRenderFBO(n);this.Wi+=this.va.render(this.scene,e,r)}getUniformValues(t){const e=this.getSymbol({index:0}),{projViewMatrix:n}=t;return{glScale:1/t.getGLScale(),resolution:t.getResolution(),projViewMatrix:n,heatmapOpacity:e.heatmapOpacity}}getHeatmapMeshes(){return this.scene.getMeshes()}delete(){super.delete(...arguments),this.va.dispose(),delete this.va}init(){const t=this.regl;this.renderer=new r["m"].Renderer(t);const e=this.getPolygonOffset(),n=this.getSymbols()[0];this.va=new r["c"](this.regl,this.sceneConfig,this.layer,n.heatmapColor,null,e)}});Wa.registerAt(Ie);const Xa=vr("water",ka);if(Xa.registerAt(Ie),He.registerPainter("lit",la),He.registerPainter("icon",Ks),He.registerPainter("fill",xi),He.registerPainter("line",Mi),He.registerPainter("line-gradient",Ti),He.registerPainter("water",ka),He.registerPainter("tube",ua),r["m"].ShaderLib.register("vt_position_vert","#ifdef HAS_TERRAIN_ALTITUDE\n    attribute float aTerrainAltitude;\n#endif\nuniform float minAltitude;\n#ifdef HAS_ALTITUDE\n    vec3 unpackVTPosition() {\n        float altitude = aAltitude;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            altitude += aTerrainAltitude * 100.0;\n        #endif\n        altitude += minAltitude * 100.0;\n        return vec3(aPosition, altitude);\n    }\n#else\n    float position_modValue = 16384.0;\n    float position_delta = 0.00001;\n    vec3 unpackVTPosition() {\n        float z = aPosition.z;\n        vec2 pos = sign(aPosition.xy + position_delta) * mod(abs(aPosition.xy), position_modValue);\n        vec2 highs = floor(abs(aPosition.xy) / position_modValue);\n        float altitude = sign(z + position_delta) * (highs.x * 2.0 + highs.y) * pow(2.0, 15.0) + z;\n        #ifdef HAS_TERRAIN_ALTITUDE\n            altitude += aTerrainAltitude * 100.0;\n        #endif\n        altitude += minAltitude * 100.0;\n        return vec3(pos, altitude);\n    }\n#endif"),Ie.VERSION="0.95.0",He.VERSION="0.95.0",r["k"].create(),r["n"]){const t=i["t"].VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){const t=r["n"].inject(dt);i["O"]("@maptalks/vt",t)}else i["O"]("@maptalks/vt",(function(){return r["n"].inject(dt)}))}else i["O"]("@maptalks/vt",dt);"undefined"!=typeof console&&console.log("@maptalks/vt v0.95.0");n("8282"),n("ea86");var Qa=n("31d3");
/*!
 * @maptalks/transform-control v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */
const Ya={yuanhuan:{accessors:[{name:"_1_0_positions",componentType:5126,count:104,min:[-5.407599925994873,-5.404099941253662,0],max:[5.405200004577637,5.406300067901611,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:104,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:288,min:[0],max:[103],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"-",byteLength:3072,uri:"data:application/octet-stream;base64,KVyjQLbzPT4AAAAAZvesQLbzPT4AAAAAhsmqQC7/YT8AAAAAZ0ShQDC7Vz8AAAAA+u2lwGKhxr8AAAAArK2cwLpJvL8AAAAAEFihwB04V78AAAAAXdyqwE7RYb8AAAAAat6lQEaUxj8AAAAAApqcQG+BvD8AAAAAB18EQFOWlcAAAAAA+u0LQLBynsAAAAAARPoxQNSalMAAAAAAJzEoQIxKjMAAAAAAQBNVQFyPiMAAAAAAIEFJQMDsgMAAAAAA0950QK36dMAAAAAAejZnQFRSZ8AAAAAAXdyAQBBYScAAAAAA+n6IQI0oVcAAAAAAcoqUQAMJMsAAAAAAKjqMQIlBKMAAAAAAXdyAQFdbSUAAAAAA+n6IQDsBVUAAAAAA0950QBTQdEAAAAAAejZnQA5PZ0AAAAAA+n6IwI0oVcAAAAAAwOyAwBBYScAAAAAAXkuMwIlBKMAAAAAA0ZGUwAMJMsAAAAAA5j+8P9ejnMAAAAAAkDFXP65HocAAAAAA1JrGPz7opcAAAAAA/7I7PvhTo8AAAAAA/7I7PmPurMAAAAAAM8RhP/vLqsAAAAAADwutwLbzPT4AAAAA0m+jwLbzPT4AAAAAEFihwDC7Vz8AAAAAXdyqwC7/YT8AAAAArK2cwG+BvD8AAAAA+u2lwEaUxj8AAAAADXGewN/gC0AAAAAAa5qVwIV8BEAAAAAAXkuMwAFNKEAAAAAA0ZGUwD7oMUAAAAAAlIeVQIV8BEAAAAAAlWWeQN/gC0AAAAAAcoqUQD7oMUAAAAAAKjqMQAFNKEAAAAAAQBNVQBB6iEAAAAAAIEFJQKfogEAAAAAAW9N0wK36dMAAAAAAsVBnwFRSZ8AAAAAAlWWeQM/3C8AAAAAAlIeVQNxoBMAAAAAA+n6IwDsBVUAAAAAAwOyAwFdbSUAAAAAAsVBnwA5PZ0AAAAAAW9N0wBTQdEAAAAAAd74LwLBynsAAAAAAkxi8v9ejnMAAAAAAwFsEwFOWlcAAAAAARpRWv65HocAAAAAAayvGvz7opcAAAAAA2c43vvhTo8AAAAAA2c43vmPurMAAAAAAt9Fgv/vLqsAAAAAAt9Fgv7fRqkAAAAAAayvGvybkpUAAAAAAd74LwAponkAAAAAA2c43vv5lo0AAAAAA2c43vmkArUAAAAAARpRWvzxOoUAAAAAAkxi8v9ejnEAAAAAAOdYxwHKKlEAAAAAAwFsEwDqSlUAAAAAA+zoowNBEjEAAAAAAJlNJwKfogEAAAAAAUPxUwBB6iEAAAAAAat6lQGKhxr8AAAAAApqcQLpJvL8AAAAAhsmqQE7RYb8AAAAAZ0ShQB04V78AAAAAZvesQP+yO74AAAAAKVyjQP+yO74AAAAAM8RhP7fRqkAAAAAA/7I7PmkArUAAAAAA/7I7Pv5lo0AAAAAA+u0LQAponkAAAAAA1JrGPybkpUAAAAAAkDFXPzxOoUAAAAAA5j+8P9ejnEAAAAAARPoxQHKKlEAAAAAAB18EQDqSlUAAAAAAJzEoQNBEjEAAAAAA+zoowIxKjMAAAAAAOdYxwNSalMAAAAAAUPxUwFyPiMAAAAAAJlNJwMDsgMAAAAAAa5qVwNxoBMAAAAAADXGewM/3C8AAAAAA0m+jwP+yO74AAAAADwutwP+yO74AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMABAAFAAYABAAGAAcAAwACAAgAAwAIAAkACgALAAwACgAMAA0ADQAMAA4ADQAOAA8ADwAOABAADwAQABEAEgATABQAEgAUABUAFgAXABgAFgAYABkAGgAbABwAGgAcAB0AHgALAAoAHwALAB4AHwAgAAsAIQAgAB8AIgAjACAAIgAgACEAJAAlACYAJAAmACcAJwAmACgAJwAoACkAKgArACwAKgAsAC0ALgAvADAALgAwADEAGQAYADIAGQAyADMANAA1ABsANAAbABoAFQAUADYAFQA2ADcAOAA5ADoAOAA6ADsAPAA9AD4APAA/AD0AQAA/ADwAQABBAD8AQgBBAEAAQgBAAEMARABFAEYARABGAEcARABHAEgARgBJAEcARgBKAEkASwBKAEYASwBMAEoASwBNAEwACQAIAC8ACQAvAC4ALQAsADkALQA5ADgAOwA6AE4AOwBOAE8ATwBOAE0ATwBNAEsAKQAoACsAKQArACoANwA2AFAANwBQAFEAUQBQAFIAUQBSAFMAUwBSAFQAUwBUAFUAVgBXAFgAVgBYAFkAVgBZAFoAWwBZAFgAXABZAFsAXABdAFkAXgBdAFwAXwBdAF4APAA+AGAAPABgAGEAMQAwABcAMQAXABYAYgBjADUAYgA1ADQAYQBgAGMAYQBjAGIAMwAyAF0AMwBdAF8AHQAcAGQAHQBkAGUAZQBkAAUAZQAFAAQAZgBnAAcAZgAHAAYAEQAQABMAEQATABIA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:1248,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:1248,byteOffset:1248,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:576,byteOffset:2496,target:34963}],materials:[{name:"SVGMat_001",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan41:{accessors:[{name:"_1_0_positions",componentType:5126,count:39,min:[0,0,0],max:[5.489999771118164,0,5.488900184631348],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:39,min:[0,-.999939501285553,-1],max:[.13969914615154266,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:105,min:[0],max:[38],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yh41",byteLength:1148,uri:"data:application/octet-stream;base64,8tKXQAAAAACoNU09FK6vQAAAAAB1Ako/FK6vQAAAAAAAAACATfOAQAAAAAACmkg+K4dWQAAAAAAIrNw+WvUtQAAAAABbsT8/X5gIQAAAAACMSpI/OUWbQAAAAAD0/VQ/LbKHQAAAAAD0/XQ/W0JqQAAAAAC6SZQ/dLXNPwAAAACfq80/H4VHQAAAAAB0JLc/ZognQAAAAAA1XuI/YVSSPwAAAAAukAhABaMKQAAAAAB4nApABcU/PwAAAACF6y1Aw2TiPwAAAACRfidASS63PwAAAABKe0dAJLncPgAAAACze1ZAj1OUPwAAAADjNmpAAppIPgAAAADu64BAnRF1PwAAAAD8qYdAqDVNPQAAAADBypdAgQRVPwAAAAAIPZtAAAAAAAAAAAASpa9AAwlKPwAAAAASpa9AJJd/PAAAAAASpa9AAwlKPwAAAAASpa9AAAAAAAAAAAASpa9Asp1vPQAAAAASpa9AJLn8PQAAAAASpa9AqoJRPgAAAAASpa9ARwOYPgAAAAASpa9AHhbKPgAAAAASpa9A2hv8PgAAAAASpa9A5q4VPwAAAAASpa9A+n4qPwAAAAASpa9AQxw7PwAAAAASpa9AwhdGPwAAAAASpa9AAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAJ5X/OwL+fz8AAACAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIC/Kzs0PAn8f78AAACApLK/PA7uf78AAACAeJkZPefRfz8AAACA+ZldPQSgf78AAACA6XSTPelVfz8AAACALLO3PdT3fr8AAACAfkjZPR2Ofr8AAACANf32Paohfj8AAACAeUYHPqDBfT8AAACASw0PPlt9fb8AAACAAAABAAIAAwABAAAABAABAAMABQABAAQABgAHAAUABwABAAUABgAIAAcABgAJAAgACgAJAAYACgALAAkACgAMAAsADQAMAAoADQAOAAwADwAOAA0ADwAQAA4ADwARABAAEgARAA8AEgATABEAFAATABIAFAAVABMAFgAVABQAFgAXABUAGAAXABYAGAAZABcAGgAbABwAHQAbABoAHgAbAB0AHwAbAB4AIAAbAB8AIQAbACAAIgAbACEAIwAbACIAJAAbACMAJQAbACQAJgAbACUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:468,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:468,byteOffset:468,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:212,byteOffset:936,target:34963}],materials:[{name:"SVGMat_002",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanhuan411:{accessors:[{name:"_1_0_positions",componentType:5126,count:28,min:[.026000000536441803,-4.6834001541137695,0],max:[4.696700096130371,-.014800000004470348,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:28,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanhuan411",byteLength:828,uri:"data:application/octet-stream;base64,ufwXQLN7Mr8AAAAAObRAQLFQK78AAAAA1ediQMWP8b4AAAAAGQQ6QCv2174AAAAAqFdeQHUCWr4AAAAA7FGCQL6fmr0AAAAAHHyDQDLmrr4AAAAAXkuWQJf/kL4AAAAAXkuWQLN7crwAAAAAMCrxP2RdhL8AAAAA/BgDQJeQn78AAAAADeARQAg9i78AAAAAukkIQISeXb8AAAAAZaogQH/Zbb8AAAAA7Q3ePr4wOcAAAAAA5IMuP9/gP8AAAAAAJQZxPwrXH8AAAAAAPZs1P6UsF8AAAAAAdy2hP0VHAsAAAAAAb/CFP5eQ778AAAAA0ES4P32utr8AAAAAAprQPyL9zr8AAAAAi/1lPqqCXcAAAAAA9dv3PtcSYsAAAAAADi2yPZvmgcAAAAAAYTK1PssQg8AAAAAA9P3UPGrelcAAAAAA4liXPmrelcAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAACAAMAAwACAAQABQAGAAcABQAHAAgABAACAAYABAAGAAUACQAKAAsACQALAAwAAAANAAEADgAPABAADgAQABEAEQAQABIAEQASABMAFAAVAAoAFAAKAAkADAALAA0ADAANAAAAFgAXAA8AFgAPAA4AGAAZABcAGAAXABYAGgAZABgAGgAbABkAEwASABUAEwAVABQA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},yuanpan:{accessors:[{name:"Circle001_1_0_positions",componentType:5126,count:28,min:[-1.9510999917984009,0,-1.9510999917984009],max:[1.9510999917984009,0,1.9510999917984009],type:"VEC3",bufferView:0,byteOffset:0},{name:"Circle001_1_0_normals",componentType:5126,count:28,min:[0,1,0],max:[0,1,0],type:"VEC3",bufferView:1,byteOffset:0},{name:"Circle001_1_0_indices",componentType:5123,count:78,min:[0],max:[27],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"yuanpan",byteLength:828,uri:"data:application/octet-stream;base64,S+rkvgAAAADRIvM/AAAAAAAAAAClvfk/S+rkPgAAAADRIvM/0SLzvwAAAABL6uQ+MlXgvwAAAACsi1s/c9fCvwAAAACvJZw/pb35vwAAAAAAAAAA0SLzvwAAAABL6uS+MlXgvwAAAACsi1u/c9fCvwAAAACvJZy/ryWcvwAAAABz18K/rItbvwAAAAAyVeC/S+rkvgAAAADRIvO/AAAAgAAAAAClvfm/S+rkPgAAAADRIvO/rItbPwAAAAAyVeC/ryWcPwAAAABz18K/c9fCPwAAAACvJZy/MlXgPwAAAACsi1u/0SLzPwAAAABL6uS+pb35PwAAAAAAAACA0SLzPwAAAABL6uQ+MlXgPwAAAACsi1s/c9fCPwAAAACvJZw/ryWcvwAAAABz18I/ryWcPwAAAABz18I/rItbvwAAAAAyVeA/rItbPwAAAAAyVeA/AAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAAAAAAAgD8AAACAAAABAAIAAwAEAAUABgADAAUABwAGAAUACAAHAAUACQAIAAUACgAJAAUACwAKAAUADAALAAUADQAMAAUADgANAAUADwAOAAUAEAAPAAUAEQAQAAUAEgARAAUAEwASAAUAFAATAAUAFQAUAAUAFgAVAAUAFwAWAAUAFwAFABgAGQAXABgAGQAYABoAGwAZABoAAgAbABoAAAACABoA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:336,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:336,byteOffset:336,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:156,byteOffset:672,target:34963}],materials:[{name:"wire_008110135",pbrMetallicRoughness:{baseColorFactor:[.0314,.4314,.5294,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Circle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Circle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},zzhou:{accessors:[{name:"Cube.001-Mesh_0_positions",componentType:5126,count:45,min:[-.2711470127105713,-5.473427772521973,-.2711470127105713],max:[.2711470127105713,.46298399567604065,.2711470127105713],type:"VEC3",bufferView:0,byteOffset:0},{name:"Cube.001-Mesh_0_normals",componentType:5126,count:45,min:[-1,-1,-1],max:[1,1,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Cube.001-Mesh_0_texcoords",componentType:5126,count:45,min:[.125,0],max:[.875,1],type:"VEC2",bufferView:2,byteOffset:0},{name:"Cube.001-Mesh_0_indices",componentType:5123,count:72,min:[0],max:[44],type:"SCALAR",bufferView:3,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"Z",byteLength:1584,uri:"data:application/octet-stream;base64,/waNvZMdK77/Bo09/waNPZMdK77/Bo09/waNPR4Kr8D/Bo09l+KKPVImr8D/Bo09/waNvVImr8D/Bo09yNOKPsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04o+yNOKvsjTir7I04o+AAAAAD0M7T4AAAAAyNOKvsjTir7I04q+yNOKvsjTir7I04q+yNOKPsjTir7I04q+yNOKPsjTir7I04o+yNOKvsjTir7I04o+yNOKPsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04o+yNOKvsjTir7I04q+AAAAAD0M7T4AAAAAyNOKPsjTir7I04q+/waNPZMdK77/Bo09/waNPZMdK77/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09/waNPR4Kr8D/Bo09/waNvZMdK77/Bo09/waNvVImr8D/Bo09/waNvVImr8D/Bo29/waNvZMdK77/Bo29/waNvZMdK77/Bo29/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPZMdK77/Bo29/waNPZMdK77/Bo09/waNvZMdK77/Bo09/waNvZMdK77/Bo29/waNPZMdK77/Bo29/waNvVImr8D/Bo09cooOO1Imr8BAMTI7/waNvVImr8D/Bo29/waNPVImr8D/Bo29/waNPVImr8D/Bo09l+KKPVImr8D/Bo09/waNPVImr8D/Bo09AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAAAAAAAAAIC/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/AAAAAFFmsT5wJHA/cCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAcCRwv1FmsT4AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAcCRwP1FmsT4AAAAAAAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AAAAAFFmsT5wJHC/AACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAvwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAACAPwAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAAAAAAAAAAAAgD8AAAAAAADAPgAAQD8AAMA+AACAP2L1Hz8AAIA/AAAgP3uDfz8AACA/AABAPwAAwD4AAIA+AAAgPwAAAAAAAMA+AAAAAAAAwD4AAIA/AAAgPwAAQD8AAMA+AABAPwAAAD4AAAA/AADAPgAAAD8AAMA+AACAPgAAAD4AAIA+AADAPgAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAQD8AACA/AAAAPwAAwD4AAAA/AADAPgAAAD8AAMA+AABAPwAAID8AAEA/AAAgPwAAAD9i9R8/AAAAPwAAwD4AAAA/AAAgPwAAAD8AACA/AACAPgAAwD4AAIA+AADAPgAAgD4AACA/AACAPgAAID8AAAAAAADAPgAAAAAAAAA+AAAAPwAAwD4AAAA/AADAPgAAgD4AAAA+AACAPgAAID8AAAA/vAJBP/mGwj4AACA/AACAPgAAYD8AAIA+AAAgPwAAgD97g18/AAAAPwAAYD8AAAA/AAABAAIAAgADAAQAAgAEAAAABQAGAAcACAAJAAoACwAMAA0ACwANAA4ADwAQABEAEgATABQAFQAWABcAFwAYABkAFwAZABUAGgAbABwAGgAcAB0AHgAfACAAHgAgACEAIgAjACQAIgAkACUAJgAnACgAKAAnACkAAwACACoAKQAnACsAKQArACwAJwAmACsA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:540,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:540,byteOffset:540,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:360,byteOffset:1080,byteStride:8,target:34962},{name:"bufferView_3",buffer:0,byteLength:144,byteOffset:1440,target:34963}],materials:[{name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.8,.8,.8,1],metallicFactor:0,roughnessFactor:.676000006},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Cube.001-Mesh",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0,mode:4}]}],nodes:[{name:"Cube.001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},jiantou:{accessors:[{name:"_1_0_positions",componentType:5126,count:7,min:[-.47690001130104065,-.8044000267982483,0],max:[.47780001163482666,0,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"_1_0_normals",componentType:5126,count:7,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"_1_0_indices",componentType:5123,count:15,min:[0],max:[6],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"jiantou",byteLength:200,uri:"data:application/octet-stream;base64,bxIDOintTb8AAAAAH/RsvsKGp74AAAAAPSz0vsKGp74AAAAANs17PsKGp74AAAAANKL0PsKGp74AAAAANs17PgAAAAAAAAAAH/RsvgAAAAAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAAADAAEAAAAEAAMAAQAFAAYAAQADAAUAAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:84,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:84,byteOffset:84,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:32,byteOffset:168,target:34963}],materials:[{name:"SVGMat_003",pbrMetallicRoughness:{baseColorFactor:[.588,.588,.588,1],metallicFactor:0,roughnessFactor:.99},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xuanzhuan:{accessors:[{name:"001_1_0_positions",componentType:5126,count:369,min:[-6.572299957275391,-7.298999786376953,0],max:[6.5742998123168945,7.298299789428711,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"001_1_0_normals",componentType:5126,count:369,min:[0,-1,0],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"001_1_0_indices",componentType:5123,count:1089,min:[0],max:[368],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"-",byteLength:11036,uri:"data:application/octet-stream;base64,1zQDwHql3kAAAAAA48e4vgMJ1kAAAAAAQmD1v6yL6UAAAAAA2qxqv1Fr0EAAAAAAVHSkvnuD1UAAAAAAF7eRvjXv1EAAAAAAyeV/vqVO1EAAAAAA5INevsuh00AAAAAAW7E/vpHt0kAAAAAAZogjvoMv0kAAAAAAAwkKvrpr0UAAAAAA+aDnvTSi0EAAAAAAXCDBvWfVz0AAAAAAqoLZv4NRy0AAAAAALv+hvfcGz0AAAAAAAwmKvVg5zkAAAAAA/Yd0vYtszUAAAAAAak1zvSBBzUAAAAAA1xJyveQUzUAAAAAAIEFxvTLmzEAAAAAARdhwvd21zEAAAAAARdhwvbaEzEAAAAAAIEFxvb1SzEAAAAAAs3tyvSEfzEAAAAAARrZzvYXry0AAAAAAayt2vRe3y0AAAAAAkKB4vQaBy0AAAAAASFB8vfVKy0AAAAAAhXwcwLRZw0AAAAAAbjSAveQUy0AAAAAA3EaDvcX+ykAAAAAAb/CFvTLmykAAAAAAcM6IvRTQykAAAAAAcayLvSS5ykAAAAAAcoqOvQWjykAAAAAA4XqUvWx4ykAAAAAAUI2XvSBjykAAAAAACD2bvQFNykAAAAAAUrievbU3ykAAAAAAeJyivTojykAAAAAA5x2nve0NykAAAAAAMCqpvaMBykAAAAAAVp+rvVr1yUAAAAAAexSuvbPqyUAAAAAAxSCwvTvfyUAAAAAA6pWyvfLSyUAAAAAAoda0vUvIyUAAAAAAx0u3vQK8yUAAAAAAWvW5vVuxyUAAAAAA7Z68vYenyUAAAAAA7ny/veCcyUAAAAAAgSbCvQyTyUAAAAAAgQTFvQmKyUAAAAAA1CvlvRUdyUAAAAAAXW0FviS5yEAAAAAALNQavjVeyEAAAAAADi0yvqYKyEAAAAAAlkNLvki/x0AAAAAA5q5lvhx8x0AAAAAAZaqAvqs+x0AAAAAA4L6OvsgHx0AAAAAAyAedvnPXxkAAAAAAlkOrvqytxkAAAAAAEFi5vs6IxkAAAAAAH4XLvpVlxkAAAAAAAwnKvjhnxkAAAAAA54zIvjhnxkAAAAAAsAPHvgpoxkAAAAAAOwHNvsNkxkAAAAAAO3DOvvFjxkAAAAAA0ETYvpJcxkAAAAAAV+zPvk5ixkAAAAAAV1vRvtlfxkAAAAAAWMrSvgdfxkAAAAAAWDnUvmRdxkAAAAAAIo7VvpJcxkAAAAAA6+LWvpJcxkAAAAAAiIXavgRWxkAAAAAAJLncvkhQxkAAAAAA2/nevl5LxkAAAAAAkzrhvhdIxkAAAAAASnvjvtBExkAAAAAAMzPzvoY4xkAAAAAAArzlvrhAxkAAAAAAufznvkI+xkAAAAAAcT3qvs07xkAAAAAAKH7svlg5xkAAAAAAxLHuvoY4xkAAAAAAfPLwvoY4xkAAAAAA9Gz2vsoyxkAAAAAAtab5vj0sxkAAAAAAduD8vlInxkAAAAAAqRMAvzojxkAAAAAApb0Bv08exkAAAAAAE2EDvzcaxkAAAAAAnREFv00VxkAAAAAAC7UGvzQRxkAAAAAAlWUIv0oMxkAAAAAAHhYKv18HxkAAAAAAGsALv6MBxkAAAAAADk8Pv7n8xUAAAAAAgEgPv7n8xUAAAAAApHANv7n8xUAAAAAAUwWrv90kwkAAAAAASS4Pv7n8xUAAAAAApHANv7n8xUAAAAAAgEgPv7n8xUAAAAAA9wYPv7n8xUAAAAAAidIOv7n8xUAAAAAAG54Ov7n8xUAAAAAAIGMOv7n8xUAAAAAAJCgOv7n8xUAAAAAAKe0Nv7n8xUAAAAAASL8Nv7n8xUAAAAAA9pcNv7n8xUAAAAAAv30Nv7n8xUAAAAAABoFJwDm0uEAAAAAAZvcEwJtVu0AAAAAAwcoxwOzAsUAAAAAARiUFQFdbu8AAAAAAdZMcQM9mw8AAAAAA9pdJQIPAuMAAAAAAtvMxQEvIscAAAAAA2IFzQISeq8AAAAAAjLlbQECkpcAAAAAAZveMQPkxnMAAAAAAPQqBQNEil8AAAAAA+zqeQJOpisAAAAAAdk+SQPd1hsAAAAAAA3ihQFafZ8AAAAAAnl6tQN5xbsAAAAAAsi66QCEfRMAAAAAASFCuQLTIPsAAAAAA4XrEQPW5FsAAAAAAHqe4QJ/NEsAAAAAA1xLMQJhMzb8AAAAA6UjAQFInyL8AAAAAnMTQQM4ZUb8AAAAAsAPFQKMBTL8AAAAAduCMwKMjWcAAAAAA9P1wwOauOcAAAAAA6GqDwG1WGcAAAAAA46WZwA5PM8AAAAAANKLGQBe30TkAAAAAqmDSQBe30TkAAAAAdQLMwEYlzT8AAAAALUPAwAAAyD8AAAAAvp+4wFK4EkAAAAAArWnEwAWjFkAAAAAAF0iuwGizPkAAAAAATx66wI4GREAAAAAAXW2hwAmKZ0AAAAAAPE6twEtZbkAAAAAAW0KSwFFrhkAAAAAAayuewO2eikAAAAAAUPyAwPwYl0AAAAAA1eeMwK8lnEAAAAAAyJhbwA+cpUAAAAAAoWdzwDqSq0AAAAAA6GqrP8cpwsAAAAAA+zoQP6MBxsAAAAAAbqPZPxNhy8AAAAAAYHYPPxsNxsAAAAAAukkMPzQRxsAAAAAA0gAOPxsNxsAAAAAARPoNPxsNxsAAAAAAexQOPxsNxsAAAAAAPzUOPxsNxsAAAAAAIGMOPxsNxsAAAAAAcooOPxsNxsAAAAAAUrgOPxsNxsAAAAAAMuYOPxsNxsAAAAAAoBoPPxsNxsAAAAAAZDsPPxsNxsAAAAAAKVwPPxsNxsAAAAAA0m8PPxsNxsAAAAAAMZkKP00VxsAAAAAAp+gIPzcaxsAAAAAAqz4HPyEfxsAAAAAAIo4FP90kxsAAAAAAmN0DP2srxsAAAAAADi0CPycxxsAAAAAAhXwAP+M2xsAAAAAA9pf9PnE9xsAAAAAA/kP6PltCxsAAAAAA6+L2PqJFxsAAAAAA2IHzPulIxsAAAAAAc2jxPl5LxsAAAAAADk/vPtNNxsAAAAAAqDXtPkhQxsAAAAAAKA/rPr1SxsAAAAAAjNvoPmFUxsAAAAAAC7XmPjJVxsAAAAAAVHTkPgRWxsAAAAAA003iPnlYxsAAAAAAGw3gPh1axsAAAAAAZMzdPpJcxsAAAAAArIvbPgdfxsAAAAAA9UrZPnxhxsAAAAAA2c7XPvFjxsAAAAAA2V/WPpVlxsAAAAAA2PDUPgpoxsAAAAAA847TPn9qxsAAAAAA8x/SPiJsxsAAAAAA8rDQPvRsxsAAAAAA8kHPPphuxsAAAAAAKe3NPg1xxsAAAAAAKH7MPt5xxsAAAAAADALLPlR0xsAAAAAADJPJPsl2xsAAAAAA8BbIPj55xsAAAAAA4za6PryWxsAAAAAATRWsPvW5xsAAAAAASL+dPuvixsAAAAAAYHaPPp0Rx8AAAAAA5WGBPgtGx8AAAAAAi2xnPtiBx8AAAAAAOwFNPtbFx8AAAAAA6gQ0PmIQyMAAAAAAP8YcPiBjyMAAAAAA3pMHPrG/yMAAAAAAZ0TpPdEiycAAAAAAg1HJPcWPycAAAAAAy6HFPQ+cycAAAAAA7lrCPYenycAAAAAAEhS/PdCzycAAAAAAowG8PRrAycAAAAAAEFi5PZLLycAAAAAAfa62PdzXycAAAAAA6gS0PVTjycAAAAAAxY+xPZ7vycAAAAAADk+vPef7ycAAAAAA6NmsPV8HysAAAAAAn82qPakTysAAAAAAeVioPfMfysAAAAAAwaikPT81ysAAAAAA5WGhPYxKysAAAAAACRuePapgysAAAAAACD2bPcl2ysAAAAAAB1+YPbmNysAAAAAAdLWVPamkysAAAAAAvJaQPVvTysAAAAAABFaOPRzrysAAAAAA3+CLPd4Cy8AAAAAAldSJPXEby8AAAAAAcF+HPTMzy8AAAAAA3bWEPc9my8AAAAAALNRqP1Z90MAAAAAAuECCPciYy8AAAAAA3GiAPZLLy8AAAAAAtvN9PS7/y8AAAAAASFB8PScxzMAAAAAA/kN6PSBjzMAAAAAAI9t5PUaUzMAAAAAAI9t5PRHHzMAAAAAAI9t5PTj4zMAAAAAA/kN6PV8pzcAAAAAAkX57PYZazcAAAAAAJLl8PQmKzcAAAAAAcoqOPdZWzsAAAAAAMEymPaMjz8AAAAAAXW3FPZ7vz8AAAAAAjLnrPfW50MAAAAAAqz4DQN213sAAAAAAgy8MPmN/0cAAAAAA5q4lPrhA0sAAAAAAE/JBPn/70sAAAAAAnMRgPhSu08AAAAAAJQaBPnlY1MAAAAAAPL2SPpT21MAAAAAAeHqlPgmK1cAAAAAAhxa5Pr8O1sAAAAAA63P1P2iR6cAAAAAApb1Bv4xKsEAAAAAAMlVAP4xKsEAAAAAAw2QquxDpsUAAAAAAMne9v/OOq0AAAAAA3bW8P/OOq0AAAAAAYqEKwG/wo0AAAAAAcT0KQG/wo0AAAAAA/7IzwG6jmUAAAAAAak0zQG6jmUAAAAAA8IVZwAHejEAAAAAAHcklvw6+lkAAAAAAw2Qqu8UgmEAAAAAAxm0kPw6+lkAAAAAAuB5ZQAHejEAAAAAAc2ihP5aykkAAAAAA1xKiv5aykkAAAAAAKH7sP+AtjEAAAAAAjSjtv+AtjEAAAAAAuK97wBSue0AAAAAAOUV7QBSue0AAAAAAnl4ZQHBfg0AAAAAAdLUZwHBfg0AAAAAAXro5QGDlcEAAAAAA7Q06wGDlcEAAAAAAduCMwPCFWUAAAAAAZaqMQPCFWUAAAAAAqvFWQJAxV0AAAAAA3EZXwJAxV0AAAAAA46WZwEa2M0AAAAAA0m+ZQEa2M0AAAAAAHqdwQIv9OUAAAAAA9P1wwIv9OUAAAAAAIEGDQLWmGUAAAAAA6GqDwLWmGUAAAAAAnzyMwMZt7L8AAAAAiPSjwHE9CsAAAAAAIEGDQG1WGcAAAAAA0m+ZQA5PM8AAAAAA07yjQHE9CsAAAAAANBGMQMZt7L8AAAAA+1yrQAisvL8AAAAA6pWSQBBYob8AAAAAOpKrwAisvL8AAAAAVcGSwBBYob8AAAAA+8uWwI9TJL8AAAAA002wwG40QL8AAAAAYqGWQMbcJT8AAAAA8BawQPfkQT8AAAAA+1yrQE2EvT8AAAAA6pWSQJEPoj8AAAAAVTCYwInSXjsAAAAA+u2xwInSXjsAAAAA6gSYQInSXjsAAAAARraxQInSXjsAAAAAObTQwEXYUD8AAAAAIv3EwBrASz8AAAAAYqGWQI9TJL8AAAAA8BawQG40QL8AAAAA+8uWwMbcJT8AAAAA002wwPfkQT8AAAAAVcGSwJEPoj8AAAAAOpKrwE2EvT8AAAAAnzyMwOQU7T8AAAAAiPSjwEymCkAAAAAA07yjQEymCkAAAAAANBGMQOQU7T8AAAAAHqdwQOauOcAAAAAAZaqMQKMjWcAAAAAA3EZXwOviVsAAAAAAqvFWQOviVsAAAAAA7Q06wLyWcMAAAAAAXro5QLyWcMAAAAAAOUV7QMdLe8AAAAAAuK97wMdLe8AAAAAAdLUZwHo2g8AAAAAAnl4ZQHo2g8AAAAAAuB5ZQE+vjMAAAAAA8IVZwE+vjMAAAAAAjSjtv+oEjMAAAAAAKH7sP+oEjMAAAAAA1xKiv86IksAAAAAAc2ihP86IksAAAAAAak0zQGB2mcAAAAAA/7IzwGB2mcAAAAAAHcklv0aUlsAAAAAAxm0kP0aUlsAAAAAAw2Qqu/32l8AAAAAAcT0KQDPEo8AAAAAAYqEKwDPEo8AAAAAA3bW8P4hjq8AAAAAAMne9v4hjq8AAAAAAMlVAPyEfsMAAAAAApb1BvyEfsMAAAAAAw2Qqu3e+scAAAAAASFDSwG8Sg7oAAAAASZ3GwG8Sg7oAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAgL8AAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAwABAAAAAwAEAAEAAwAFAAQAAwAGAAUAAwAHAAYAAwAIAAcAAwAJAAgAAwAKAAkAAwALAAoAAwAMAAsADQAMAAMADQAOAAwADQAPAA4ADQAQAA8ADQARABAADQASABEADQATABIADQAUABMADQAVABQADQAWABUADQAXABYADQAYABcADQAZABgADQAaABkADQAbABoAHAAbAA0AHAAdABsAHAAeAB0AHAAfAB4AHAAgAB8AHAAhACAAHAAiACEAHAAjACIAHAAkACMAHAAlACQAHAAmACUAHAAnACYAHAAoACcAHAApACgAHAAqACkAHAArACoAHAAsACsAHAAtACwAHAAuAC0AHAAvAC4AHAAwAC8AHAAxADAAHAAyADEAHAAzADIAHAA0ADMAHAA1ADQAHAA2ADUAHAA3ADYAHAA4ADcAHAA5ADgAHAA6ADkAHAA7ADoAHAA8ADsAHAA9ADwAHAA+AD0AHAA/AD4AHABAAD8AQABBAD8AQQBCAD8AQgBDAD8AHABAAEQAHABEAEUAHABGAEUARgBHAEUARgBIAEcARgBJAEgARgBKAEkARgBLAEoARgBMAEsAHABNAEYAHABOAE0AHABPAE4AHABQAE8AHABRAFAAHABSAFEAUgBTAFEAUgBUAFMAUgBVAFQAUgBWAFUAUgBXAFYAUgBYAFcAHABZAFIAHABaAFkAHABbAFoAHABcAFsAHABdAFwAHABeAF0AHABfAF4AHABgAF8AHABhAGAAHABiAGEAHABjAGIAHABjAGQAZABlAGMAZQBmAGMAHABnAGQAaABpAGoAawBpAGgAbABpAGsAbQBpAGwAbgBpAG0AbwBpAG4AcABpAG8AcQBpAHAAcgBpAHEAcwBpAHIAdABnABwAdAB1AGcAdAB2AHUAdwB4AHkAdwB5AHoAegB5AHsAegB7AHwAfAB7AH0AfAB9AH4AfgB9AH8AfgB/AIAAgQCCAIMAgQCDAIQAhACDAIUAhACFAIYAhgCFAIcAhgCHAIgAiACHAIkAiACJAIoAiwCMAI0AiwCNAI4AjwCKAJAAigCJAJAAkQCSAJMAkQCTAJQAlACTAJUAlACVAJYAlgCVAJcAlgCXAJgAgAB/AIIAgACCAIEAmACXAJkAmACZAJoAmgCZAJsAmgCbAJwAnACbAJ0AnACdAJ4AngCdAHYAngB2AHQAnwB4AHcAoAB4AJ8AoAChAHgAogChAKAAowCkAKUAowCmAKQAowCnAKYAowCoAKcAowCpAKgAowCqAKkAowCrAKoAowCsAKsAowCtAKwAowCuAK0AowCvAK4AowCiAK8AowChAKIAsAChAKMAsQChALAAsgChALEAswChALIAtAChALMAtQChALQAtgChALUAtwChALYAuAChALcAuQChALgAugChALkAuwChALoAvAChALsAvQChALwAvgChAL0AvwChAL4AwAChAL8AwQChAMAAwgChAMEAwwChAMIAxAChAMMAxQChAMQAxgChAMUAxwChAMYAyAChAMcAyQChAMgAygChAMkAywChAMoAzAChAMsAzQChAMwAzgChAM0AzwChAM4A0AChAM8A0QChANAA0gChANEA0wChANIA1AChANMA1QChANQA1gChANUA1wChANYA2AChANcA2QChANgA2gChANkA2wChANoA3AChANsA3QChANwA3gChAN0A3wChAN4A4AChAN8A4QChAOAA4gChAOEA4wChAOIA5AChAOMA5QChAOQA5gChAOUA5wChAOYA6AChAOcA6QChAOgA6gChAOkA6wChAOoA7AChAOsA7QChAOwA7gChAO0A7wChAO4A8AChAO8A8QChAO8A8gChAPEA8wChAPIA9AChAPMA9QChAPQA9gChAPUA9gD3AKEA+AD3APYA+QD3APgA+gD3APkA+wD3APoA/AD3APsA/QD3APwA/gD3AP0A/wD3AP4AAAH3AP8AAQH3AAABAgH3AAEBAwH3AAIBBAH3AAMBBQH3AAQBBgH3AAUBBgEHAfcACAEHAQYBCQEHAQgBCgEHAQkBCwEHAQoBDAEHAQsBDQEHAQwBDgEHAQ0BDwEHAQ4BEAEHAQ8BEQESARMBFAESAREBFAEVARIBFgEVARQBFgEXARUBGAEXARYBGAEZARcBGgEbARgBGwEcARgBHAEZARgBHAEdARkBHQEeARkBHwEeAR0BGgEgARsBIQEeAR8BGgEiASABIwEiARoBIQEkAR4BJQEkASEBIwEmASIBJwEkASUBIwEoASYBKQEoASMBJwEqASQBKwEqAScBKQEsASgBLQEsASkBKwEuASoBLwEuASsBLQEwASwBMQEuAS8BLQEyATABjgCNADMBjgAzATQBNQE2ATcBNQE3ATgBOAE3ATkBOAE5AToBOwE8AT0BOwE9AT4BPwFAAUEBPwFBAUIBPgE9AUMBPgFDAUQBRQFGAUABRQFAAT8BRwFIAZIARwGSAJEASQFKAUYBSQFGAUUBRAFDAUsBRAFLAUwBOgE5AUoBOgFKAUkBTAFLAU0BTAFNAU4BTgFNAU8BTgFPAVABQgFBAVEBQgFRAVIBUgFRAS4BUgEuATEBNAEzATwBNAE8ATsBUwFUATYBUwE2ATUBUAFPATIBUAEyAS0BiwBVAYwAVgFUAVMBiwBXAVUBWAFUAVYBWAFZAVQBWgFXAYsAWgFbAVcBXAFZAVgBXAFdAVkBXgFbAVoBXgFfAVsBYAFdAVwBXgFhAV8BYgFdAWABYgFjAV0BZAFhAV4BZAFlAWEBZgFjAWIBZAFnAWUBZwFjAWYBZAFjAWcBZAFoAWMBaQFoAWQBaQFqAWgBawFqAWkBawFsAWoBbQFsAWsBbQFuAWwBbwFwAUgBbwFIAUcBAAA="}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:4428,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:4428,byteOffset:4428,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:2180,byteOffset:8856,target:34963}],materials:[{name:"SVGMat",pbrMetallicRoughness:{baseColorFactor:[.5,.5,.5,1],metallicFactor:0,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},plane:{accessors:[{name:"Rectangle001_1_0_positions",componentType:5126,count:4,min:[-5,-5,0],max:[5,5,0],type:"VEC3",bufferView:0,byteOffset:0},{name:"Rectangle001_1_0_normals",componentType:5126,count:4,min:[0,0,1],max:[0,0,1],type:"VEC3",bufferView:1,byteOffset:0},{name:"Rectangle001_1_0_indices",componentType:5123,count:6,min:[0],max:[3],type:"SCALAR",bufferView:2,byteOffset:0}],asset:{generator:"obj2gltf",version:"2.0"},buffers:[{name:"plane",byteLength:108,uri:"data:application/octet-stream;base64,AACgQAAAoEAAAAAAAACgwAAAoEAAAAAAAACgwAAAoMAAAAAAAACgQAAAoMAAAAAAAAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAAAAAAAAAAAAIA/AAABAAIAAgADAAAA"}],bufferViews:[{name:"bufferView_0",buffer:0,byteLength:48,byteOffset:0,byteStride:12,target:34962},{name:"bufferView_1",buffer:0,byteLength:48,byteOffset:48,byteStride:12,target:34962},{name:"bufferView_2",buffer:0,byteLength:12,byteOffset:96,target:34963}],materials:[{name:"wire_225198087",pbrMetallicRoughness:{baseColorFactor:[.8824,.7765,.3412,1],metallicFactor:0,roughnessFactor:.968},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",doubleSided:!1}],meshes:[{name:"Rectangle001_1",primitives:[{attributes:{POSITION:0,NORMAL:1},indices:2,material:0,mode:4}]}],nodes:[{name:"Rectangle001",mesh:0}],scene:0,scenes:[{nodes:[0]}]},xyzScale:{asset:{generator:"Khronos glTF Blender I/O v1.6.16",version:"2.0"},scene:0,scenes:[{name:"Scene",nodes:[0,1,2,3,4,5,6]}],nodes:[{mesh:0,name:"Cube",scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:1,name:"Cube.001",scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:2,name:"Cube.004",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:3,name:"Cube.003",rotation:[0,-.7071068286895752,0,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:4,name:"Cube.006",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.7008190751075745,.014999999664723873,.014999999664723873]},{mesh:5,name:"Cube.005",rotation:[0,0,.7071068286895752,.7071068286895752],scale:[.10000000149011612,.10000000149011612,.10000000149011612]},{mesh:6,name:"Cube.002",scale:[.10000000149011612,.10000000149011612,.10000000149011612]}],materials:[{doubleSided:!0,name:"Material",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.001",pbrMetallicRoughness:{baseColorFactor:[.6938720345497131,.020288480445742607,.011612260714173317,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.002",pbrMetallicRoughness:{baseColorFactor:[.626582869887352,.626582869887352,.626582869887352,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.006",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.005",pbrMetallicRoughness:{baseColorFactor:[.11193240433931351,.5583405494689941,.033104799687862396,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.010",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}},{doubleSided:!0,name:"Material.009",pbrMetallicRoughness:{baseColorFactor:[.004391402006149292,.21223078668117523,.5209956169128418,1],metallicFactor:0,roughnessFactor:.4000000059604645}}],meshes:[{name:"Cube",primitives:[{attributes:{POSITION:0,NORMAL:1,TEXCOORD_0:2},indices:3,material:0}]},{name:"Cube.001",primitives:[{attributes:{POSITION:4,NORMAL:5,TEXCOORD_0:6},indices:3,material:1}]},{name:"Cube.006",primitives:[{attributes:{POSITION:10,NORMAL:11,TEXCOORD_0:12},indices:3,material:3}]},{name:"Cube.005",primitives:[{attributes:{POSITION:13,NORMAL:14,TEXCOORD_0:15},indices:3,material:4}]},{name:"Cube.010",primitives:[{attributes:{POSITION:16,NORMAL:17,TEXCOORD_0:18},indices:3,material:5}]},{name:"Cube.009",primitives:[{attributes:{POSITION:19,NORMAL:20,TEXCOORD_0:21},indices:3,material:6}]},{name:"Cube.002",primitives:[{attributes:{POSITION:7,NORMAL:8,TEXCOORD_0:9},indices:3,material:2}]}],accessors:[{bufferView:0,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:1,componentType:5126,count:24,type:"VEC3"},{bufferView:2,componentType:5126,count:24,type:"VEC2"},{bufferView:3,componentType:5123,count:36,type:"SCALAR"},{bufferView:4,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:5,componentType:5126,count:24,type:"VEC3"},{bufferView:6,componentType:5126,count:24,type:"VEC2"},{bufferView:7,componentType:5126,count:24,max:[1,1,1],min:[-1,-1,-1],type:"VEC3"},{bufferView:8,componentType:5126,count:24,type:"VEC3"},{bufferView:9,componentType:5126,count:24,type:"VEC2"},{bufferView:10,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:11,componentType:5126,count:24,type:"VEC3"},{bufferView:12,componentType:5126,count:24,type:"VEC2"},{bufferView:13,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:14,componentType:5126,count:24,type:"VEC3"},{bufferView:15,componentType:5126,count:24,type:"VEC2"},{bufferView:16,componentType:5126,count:24,max:[2.0003609657287598,1,1],min:[.0003610849380493164,-1,-1],type:"VEC3"},{bufferView:17,componentType:5126,count:24,type:"VEC3"},{bufferView:18,componentType:5126,count:24,type:"VEC2"},{bufferView:19,componentType:5126,count:24,max:[14.549108505249023,1,1],min:[12.549108505249023,-1,-1],type:"VEC3"},{bufferView:20,componentType:5126,count:24,type:"VEC3"},{bufferView:21,componentType:5126,count:24,type:"VEC2"}],bufferViews:[{buffer:0,byteLength:288,byteOffset:0},{buffer:0,byteLength:288,byteOffset:288},{buffer:0,byteLength:192,byteOffset:576},{buffer:0,byteLength:72,byteOffset:768},{buffer:0,byteLength:288,byteOffset:840},{buffer:0,byteLength:288,byteOffset:1128},{buffer:0,byteLength:192,byteOffset:1416},{buffer:0,byteLength:288,byteOffset:1608},{buffer:0,byteLength:288,byteOffset:1896},{buffer:0,byteLength:192,byteOffset:2184},{buffer:0,byteLength:288,byteOffset:2376},{buffer:0,byteLength:288,byteOffset:2664},{buffer:0,byteLength:192,byteOffset:2952},{buffer:0,byteLength:288,byteOffset:3144},{buffer:0,byteLength:288,byteOffset:3432},{buffer:0,byteLength:192,byteOffset:3720},{buffer:0,byteLength:288,byteOffset:3912},{buffer:0,byteLength:288,byteOffset:4200},{buffer:0,byteLength:192,byteOffset:4488},{buffer:0,byteLength:288,byteOffset:4680},{buffer:0,byteLength:288,byteOffset:4968},{buffer:0,byteLength:192,byteOffset:5256}],buffers:[{byteLength:5448,uri:"data:application/octet-stream;base64,6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAQAOABQAAQAUAAcACgAGABMACgATABcAFQASAAwAFQAMAA8AEAADAAkAEAAJABYABQACAAgABQAIAAsAEQANAAAAEQAAAAQAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAAACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgD8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgL8AAIC/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgD8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAPwAAgL8AAIA/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgD8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgL8AAIC/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgD8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AACAvwAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgD8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgL8AAIC/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgD8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/6gUAQAAAgL8AAIA/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgD8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgL8AAIC/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgD8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AFC9OQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAAJsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgD8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgL8AAIC/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgD8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JsloQQAAgL8AAIA/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgD8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgL8AAIC/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgD8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/JslIQQAAgL8AAIA/AAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAPwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAPwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AACAPwAAAAAAAACAAACAvwAAAAAAAACAAAAAAAAAAAAAAIC/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIC/AACAvwAAAAAAAACAAAAAAAAAAAAAAIA/AAAAAAAAgD8AAACAAACAvwAAAAAAAACAAAAAAAAAgL8AAACAAAAAAAAAAAAAAIA/AAAgPwAAAD8AACA/AAAAPwAAID8AAAA/AADAPgAAAD8AAMA+AAAAPwAAwD4AAAA/AAAgPwAAgD4AACA/AACAPgAAID8AAIA+AADAPgAAgD4AAMA+AACAPgAAwD4AAIA+AAAgPwAAQD8AACA/AABAPwAAYD8AAAA/AADAPgAAQD8AAAA+AAAAPwAAwD4AAEA/AAAgPwAAgD8AACA/AAAAAAAAYD8AAIA+AADAPgAAgD8AAAA+AACAPgAAwD4AAAAA"}]}},Za=[];function Ka(t,e,n,i,s,o){const a=[],l=r["l"].fromEuler([],n[0],n[1],n[2]),h=r["k"].fromRotationTranslationScale([],l,e,i);return function(t){return new Qa["b"]("",JSON.parse(JSON.stringify(Ya[t]))).load().then(t=>t)}(t).then(t=>{r["m"].GLTFHelper.exportGLTFPack(t).getMeshesInfo().forEach((t,l)=>{const c=new r["m"].Material({color:s||t.materialInfo.baseColorFactor}),u=new r["m"].Mesh(t.geometry,c);u.setUniform("uPickingId",o+l);const f=u.getDefines();f.HAS_PICKING_ID=2,u.setDefines(f),u.translate=e,u.rotation=n,u.scaling=i,r["k"].multiply(u.localTransform,h,t.nodeMatrix),u.originTransform=r["k"].copy([],u.localTransform),u.originColor=s||t.materialInfo.baseColorFactor,a.push(u)}),o>100&&(a[0].properties.relatedMeshes=a.slice(1,2),a[1].properties.relatedMeshes=a.slice(0,1),a[2].properties.relatedMeshes=a.slice(3,4),a[3].properties.relatedMeshes=a.slice(2,3),a[4].properties.relatedMeshes=a.slice(5,6),a[5].properties.relatedMeshes=a.slice(4,5),a[6].properties.relatedMeshes=a.slice(0,6))}),a}function Ja(t,e){return Math.abs(t)*Math.sign(e)}function $a(t,e){const n=t.getCoordinates(),s=e.coordinateToPointAtRes(n,e.getGLRes()),o=[s.x,s.y,0],a=tl(e,t.getTranslation());r["p"].add(o,o,a);const l=function(t,e,n,r){return t._pointAtResToContainerPoint(e,n,r)}(e,new i["A"](o[0],o[1]),e.getGLRes());l.x+=85;const h=function(t,e,n,s){if(s){const o=n/t._getResolution(),a=t.width/2,l=t.height/2;Za[0]=(e.x-a)/a,Za[1]=e.y/l-1,Za[3]=s*o;const h=r["k"].invert([],t.projViewMatrix);r["p"].transformMat4(Za,Za,h);const c=t.getGLScale();return r["p"].set(Za,Za[0]/c,Za[1]/c,Za[2]/c),r["p"].scale(Za,Za,1/o),new i["A"](Za[0],Za[1])}{const r=t.containerPointToCoordinate(e);return t.coordinateToPointAtRes(r,n)}}(e,l,e.getGLRes());return Math.sqrt(Math.pow(h.x-o[0],2)+Math.pow(h.y-o[1],2))/5.272881136101205}function tl(t,e){if(!t)return e;const n=t.distanceToPointAtRes(e[0],e[1],t.getGLRes()),i=t.altitudeToPoint(e[2],t.getGLRes());return r["p"].set([],Ja(n.x,e[0]),Ja(n.y,e[1]),Ja(i,e[2]))}class el{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=340/177,n=Ka("jiantou",[1.2*e,0,0],[0,0,90],[e,e,e],[89/255,206/255,147/255,0],7),r=Ka("jiantou",[0,1.2*e,0],[0,0,180],[e,e,e],[89/255,206/255,147/255,0],8),i=Ka("jiantou",[-1.2*e,0,0],[0,0,270],[e,e,e],[89/255,206/255,147/255,0],9),s=Ka("jiantou",[0,-1.2*e,0],[0,0,0],[e,e,e],[89/255,206/255,147/255,0],10);return t.push(n,r,i,s),t}getMeshes(){return this._meshes}}class nl{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=Ka("xuanzhuan",[0,0,0],[180,0,0],[340/177*.5,340/177*.5,340/177*.5],[50/255,130/255,184/255,.8],11);return t.push(e),t}getMeshes(){return this._meshes}}class rl{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=Ka("yuanhuan",[0,0,0],[0,0,0],[340/177*.5,340/177*.5,340/177*.5],[149/255,179/255,199/255,.5],12);return t.push(e),t}getMeshes(){return this._meshes}}class il{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=Ka("plane",[0,0,0],[0,0,0],[10,10,10],[1,0,0,.5],16);return t.push(e),t}getMeshes(){return this._meshes}}class sl{constructor(t){this.A=t,this._meshes=this.t()}setCoordinate(t){this.A=t}t(){const t=[],e=Ka("xyzScale",[0,0,0],[0,0,0],[2,2,2],null,113);return t.push(e),t}getMeshes(){return this._meshes}}const ol=[],al=[],ll=[],hl=[],cl=[],ul=[177/170,177/170,177/170],fl=[],dl=[1,2,3,4,12];class pl{constructor(){this.translate=new el,this.rotation=new nl,this.scaling=new rl,this.planeHelper=new il,this.xyzScaleHelper=new sl,this._meshes=this.t(),this.s=!0}t(){const t={};t.translate=this.translate.getMeshes(),t.rotation=this.rotation.getMeshes(),t.scaling=this.scaling.getMeshes(),t.planeHelper=this.planeHelper.getMeshes(),t.xyzScale=this.xyzScaleHelper.getMeshes();const e=340/177,n=Ka("yuanhuan41",[-2.745*e,2.745*e,0],[90,0,0],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],1),r=Ka("yuanhuan41",[2.745*e,2.745*e,0],[-90,0,180],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],2),i=Ka("yuanhuan41",[2.745*e,-2.745*e,0],[90,0,180],[.5*e,.5*e,.5*e],[149/255,179/255,199/255,.6],3),s=Ka("yuanhuan41",[-2.745*e,-2.745*e,0],[-90,0,0],[.5*e,.5*e,.5*e],[50/255,130/255,184/255,.5],4),o=Ka("yuanpan",[0,0,0],[90,0,0],[.5*e,.5*e,.5*e],[89/255,206/255,147/255,.5],5),a=Ka("zzhou",[0,0,6.5],[90,0,0],[1,1,1],[14/255,127/255,191/255,1],6);return t.translate.push(n,r,i,s,o,a),t}updateMatrix(t,e,n,i,s){const o=e.getCoordinates(),a=t.coordinateToPointAtRes(o,t.getGLRes()),l=e.i();r["p"].set(al,a.x,a.y,l);const h=r["p"].copy(ol,s),c=tl(t,e.getTranslation());r["p"].add(al,al,c),r["p"].add(al,al,h);for(const u in this._meshes)for(let s=0;s<this._meshes[u].length;s++){const o=this._meshes[u][s];for(let s=0;s<o.length;s++){const a=o[s],l=a.getUniform("uPickingId"),h=r["p"].copy(ol,a.translate);let c=r["p"].copy(fl,a.rotation);const f=a.scaling;if(11===l&&(this.s?(c[2]+=n,a.rotation[2]+=n):this.s||(c[2]+=n,a.rotation[2]+=n,c[0]=360,c[2]-=90)),l>100&&1===e.getTargets().length&&(c=e.getTargets()[0].getRotation()),dl.indexOf(l)>-1)if(12!==l)f[0]+=i,f[1]+=i,f[2]+=i;else{const t=this._meshes.translate[4][0];f[0]=1.2*t.scaling[0],f[1]=1.2*t.scaling[0],f[2]=1.2*t.scaling[0]}let d=$a(e,t);if(d=r["p"].set(ll,d,d,d),r["p"].multiply(h,h,d),r["p"].multiply(d,d,f),1===l||2===l||3===l||4===l){const t=r["p"].multiply(cl,f,ul);r["p"].multiply(h,h,t)}const p=r["l"].fromEuler(hl,c[0],c[1],c[2]);if(r["p"].add(h,h,al),"xyzScale"===u){const t=r["k"].fromRotationTranslationScale([],p,h,d);r["k"].multiply(a.localTransform,t,a.originTransform)}else r["k"].fromRotationTranslationScale(a.localTransform,p,h,d)}}}getMeshes(t){const e={};return t?("xyzScale"===t?e[t]=this._meshes[t]:(e.translate=this._meshes.translate,"translate"!==t&&(e[t]=this._meshes[t])),e):e}I(t){this.s=t}dispose(){for(const t in this._meshes)for(let e=0;e<this._meshes[t].length;e++){const n=this._meshes[t][e];for(let t=0;t<n.length;t++){const e=n[t];e.geometry.dispose(),e.dispose()}}}}const Al=[],gl=[],ml=[],yl=new i["A"](0,0),vl=[],xl=[],bl=[],wl=[0,0,0];class _l{constructor(){this.o=[],this.g=[0,0,0],this.C=[1,1,1],this.h=[0,0,0]}l(t){Array.isArray(t)?t.forEach(t=>{this.l(t)}):(t.on("remove",this.P,this),t.D={coordinate:t.getCoordinates(),translation:t.getTranslation(),rotation:t.getRotation(),scale:t.getScale()},this.o.push(t))}u(){this.o.forEach(t=>{t.off("remove",this.P,this)}),this.o=[]}m(t,e,n,i,s,o,a){for(let l=0;l<this.o.length;l++){const a=this.o[l],h=a.getRotation(),c=a.getScale(),u=this.B(o,a,i,n,e);let f=null;f=i>=0?i:i*(this.options&&this.options.scaleStrength||1);const d=r["p"].add(bl,r["p"].set(Al,f*c[0],f*c[1],f*c[2]),c),p=Math.min(...d);if(Math.abs(p)<s){const t=Math.abs(p);d[0]=d[0]*(s/t),d[1]=d[1]*(s/t),d[2]=d[2]*(s/t)}const A=r["p"].add(h,n,h);a.setCoordinates(u),this.p(t,d,c);const g=a.getTranslation();a.setTRS(g,A,d)}r["p"].set(bl,i,i,i),r["p"].add(this.h,n,this.h),r["p"].add(this.C,bl,this.C),r["p"].add(this.g,e,this.g),t.indexOf("translate")>-1?a.fire("positionchange",{action:t,type:"positionchange",target:this.o,center:this.getCoordinates(),scale:this.C,rotation:this.h,translation:this.g,deltaTranslate:e,deltaRotation:n,deltaScale:i}):a.fire("transforming",{action:t,type:"transforming",target:this.o,center:this.o[0].getTransformOrigin(),scale:this.C,rotation:this.h,translation:this.g,deltaTranslate:e,deltaRotation:n,deltaScale:i})}B(t,e,n,i,s){const o=e.getCenter(),a=e.getTransformOrigin(),l=t.getGLRes(),h=t.coordinateToPointAtRes(o,l,yl);h.z=t.altitudeToPoint(o.z,l),r["p"].set(vl,h.x,h.y,h.z||0);const c=t.coordinateToPointAtRes(a,l,yl);c.z=t.altitudeToPoint(a.z,l),r["p"].set(xl,c.x,c.y,c.z||0);const u=r["p"].sub(Al,vl,xl),f=r["l"].fromEuler(gl,0,0,i[2]);r["p"].set(bl,n+1,n+1,n+1);const d=r["k"].fromRotationTranslationScale(ml,f,s,bl);r["p"].transformMat4(u,u,d),r["p"].add(u,u,xl),yl.set(u[0],u[1]);const p=t.pointAtResToCoordinate(yl,l);return p.z=u[2]/t.altitudeToPoint(1,l),p}p(t,e,n){return"x-scale"===t&&(e[1]=n[1],e[2]=n[2]),"y-scale"===t&&(e[0]=n[0],e[2]=n[2]),"z-scale"===t&&(e[0]=n[0],e[1]=n[1]),e}v(){this.o.forEach(t=>{if(t.D){const{coordinate:e,translation:n,rotation:r,scale:i}=t.D;t.setCoordinates(e),t.setTRS(n,r,i)}})}getScale(){return this.C}getTranslation(){return 1===this.o.length&&this.o[0].getTranslation()||wl}getRotation(){return this.h}L(){return this.o[0]?this.o[0].getLayer():null}getCoordinates(){let t=0,e=0,n=0;const r=this.o.length;if(!r)return null;for(let i=0;i<r;i++){const r=this.o[i].getCenter();t+=r.x,e+=r.y,n+=r.z||0}t/=r,e/=r,n/=r;const s=new i["f"](t,e,n);for(let i=0;i<r;i++)this.o[i].setTransformOrigin(s);return s}P(t){const e=t.target,n=this.o.indexOf(e);n>-1&&(delete e.D,this.o.splice(n,1))}getTargets(){return this.o}i(){let t=0;const e=this.o.length;for(let n=0;n<e;n++)t+=this.o[n].getPointZ();return t/=e,t}M(){for(let t=0;t<this.o.length;t++)if(this.o[t].isVisible())return!0;return!1}}const Ml=[5,6,7,8,9,10],Tl=[5,7,8,9,10],Sl=[2,4,11],Il=[1,3,12],Cl=[12,16],Ol=[1,2,3,4],El=[1,2,3,4,12],Pl=[],kl=[],Rl=[],Nl=[],Dl=[],Fl=[],Ll=[];class zl extends(Object(i["j"])(Object(i["n"])(i["e"]))){constructor(t={}){super(t),this.options=t,this.mouseAction="moving",this.O=this.options.mode||"translate",this.F=!0,this.TransformHelper=new pl,this.U=new _l,this.helperScene=new r["m"].Scene([]),this.addToMapCount=0}enable(){return this.F=!0,this.layerRenderer&&this.layerRenderer.setToRedraw(),this}disable(){return this.F=!1,this.layerRenderer&&this.layerRenderer.setToRedraw(),this.map&&this.map.resetCursor(),this}setMode(t){this.O=t,this.V(),this.layerRenderer&&this.layerRenderer.setToRedraw(),this.fire("modechange",{mode:t,type:"modechange"})}getMode(){return this.O}isEnable(){return this.F}S(t){Ml.indexOf(t)>-1?this.O="translate":Sl.indexOf(t)>-1?this.O="rotation":Il.indexOf(t)>-1?this.O="scaling":"xyzScale"!==this.O&&(this.O="translate")}k(){return this.O}addTo(t){this.map&&(this.T(),console.warn("transform control has been added to a map, it suggest remove from the map before")),this.addToMapCount++,this.map=t,this.container=t.getContainer(),t.on("dom:mousemove",this.H,this),t.on("dom:mousedown",this.J,this),t.on("dom:mouseup",this.N,this),t.on("zooming moving dragrotating",this.R,this),this._()}remove(){this.map&&this.container&&this.layerRenderer&&(this.T(),this.TransformHelper.dispose(),this.layerRenderer.setToRedraw(),delete this.map,delete this.layer,delete this.layerRenderer,delete this.container,delete this.U)}T(){this.container&&this.map&&(this.map.off("dom:mousemove",this.H,this),this.map.off("dom:mousedown",this.J,this),this.map.off("dom:mouseup",this.N,this),this.map.off("zooming moving dragrotating",this.R,this),this.layer&&this.layer.off("renderend",this.render,this))}H(t){if(this.K()){if(this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},"moving"===this.mouseAction){const t=this.G();this.currentPickingObject=this.j(this.currentMousePosition,t,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.pickingId?(this.S(this.currentPickingObject.pickingId),6===this.currentPickingObject.pickingId?this.Z(!0):this.Z(!1)):(this.Z(!1),this.S()),this.Y()}this.W(this.currentMousePosition)}}J(t){if(!this.K()||0!==t.domEvent.button)return;const e=this.G();this.currentMousePosition={x:t.containerPoint.x,y:t.containerPoint.y},this.q=!0,this.currentPickingObject=this.j(this.currentMousePosition,e,"meshes"),this.firstDownPoint=this.j(this.currentMousePosition,e,"meshes"),this.currentPickingObject&&null!=this.currentPickingObject.meshId?(this.mouseAction="transform",this.X(this.currentPickingObject.pickingId),this.map.config("zoomable",!1),this.map.config("draggable",!1),this.layerRenderer&&this.layerRenderer.setToRedraw()):(this.mouseAction="pan",this.map.config("zoomable",!0),this.map.config("draggable",!0),this.V()),this.lastMousePosition=this.currentMousePosition,this.lastPickingObject=this.currentPickingObject,this.lastPickingMesh=e[this.currentPickingObject.meshId]}N(){"transform"===this.mouseAction&&(this.firstDownPoint=null,this.V(),this.q=!0,this.fire("transformend",{action:this.$,type:"transformend"})),this.mouseAction="moving","xyzScale"!==this.O&&(this.O="translate"),this.map.config("zoomable",!0),this.map.config("draggable",!0),this.layerRenderer&&this.layerRenderer.setToRedraw()}R(){const t=this.TransformHelper.planeHelper.getMeshes()[0][0],e=this.map.getBearing();t.rotation[2]=-e,this.AA()}AA(){this.K()&&(this.TransformHelper.updateMatrix(this.map,this.U,0,0,[0,0,0]),this.q=!0)}picked(t){if(!this.layerRenderer)return!1;const e=this.G(),n=this.map;let r=t;t instanceof i["A"]||(r=n.coordinateToContainerPoint(new i["f"](t)));const s=this.j(r,e,"picked");return!(!s||null===s.meshId)}V(){const t=this.TransformHelper.getMeshes("scaling").scaling[0][0];t.scaling=[340/177*.6,340/177*.6,340/177*.6],this.layerRenderer&&(this.eA(t),this.tA())}tA(){this.TransformHelper._meshes.translate.forEach(t=>{for(let e=0;e<t.length;e++){const n=t[e];Ol.indexOf(n.getUniform("uPickingId"))>-1&&n.material.set("color",n.originColor)}})}eA(t){const e=this.U.getCoordinates(),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes()),i=[n.x,n.y,0],s=tl(this.map,this.U.getTranslation());r["p"].add(i,i,s);const o=r["p"].copy([],t.translate),a=t.scaling;let l=$a(this.U,this.map);l=r["p"].set([],l,l,l),r["p"].multiply(o,o,l),r["p"].multiply(l,l,a),r["p"].add(o,o,i),r["k"].fromRotationTranslationScale(t.localTransform,[0,0,0,1],o,l),this.G().forEach(t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=r["p"].copy([],t.translate),n=170/177;t.scaling=[n,n,n];const s=t.scaling,o=t.rotation;let a=$a(this.U,this.map);a=r["p"].set([],a,a,a),r["p"].multiply(e,e,a),r["p"].multiply(a,a,s),r["p"].add(e,e,i);const l=r["l"].fromEuler([],o[0],o[1],o[2]);r["k"].fromRotationTranslationScale(t.localTransform,l,e,a)}})}sA(t){const e=this.map.containerPointToCoordinate(t),n=this.map.coordinateToPointAtRes(e,this.map.getGLRes());return{point:[n.x,n.y]}}W(t){if("transform"===this.mouseAction){const t=this.k(),e=tl(this.map,this.U.getTranslation()),n=this.U.i();let s=null,o=null;if(e[2]+n<.01&&"z-translate"!==this.$)s=this.sA(this.currentMousePosition),o=this.sA(this.lastMousePosition);else{const t=this.TransformHelper.planeHelper.getMeshes()[0];if(s=this.j(this.currentMousePosition,t,"plane"),o=this.j(this.lastMousePosition,t,"plane"),!s||null===s.meshId||!o||null===o.meshId)return}const a=[0,0,0],l=[0,0,0];let h=0,c=0,u=0;if("translate"===t){if("xy-translate"===this.$){const t=s.point[0]-o.point[0],e=s.point[1]-o.point[1];a[0]=t,a[1]=e}else if("x-translate"===this.$){const t=s.point[0]-o.point[0];a[0]=t}else if("y-translate"===this.$){const t=s.point[1]-o.point[1];a[1]=t}else if("z-translate"===this.$){let t=0;if(this.iA()){const e=this.map.getGLRes(),n=this.map._pointAtResToContainerPoint(new i["A"](o.point[0],o.point[1]),e),a=this.map._pointAtResToContainerPoint(new i["A"](s.point[0],s.point[1]),e),l=r["o"].length(r["o"].set(Nl,s.point[0]-o.point[0],s.point[1]-o.point[1]));t=a.y<n.y?l:-l}else t=s.point[2]-o.point[2];a[2]=t}}else if("rotation"===t)c=this.nA(s.point,o.point),c>=0?this.TransformHelper.I(!0):this.TransformHelper.I(!1),l[2]+=c;else if("scaling"===t||"xyzScale"===t){const t=this.IA(),e=r["o"].length(r["o"].set(Nl,this.firstDownPoint.point[0]-t[0],this.firstDownPoint.point[1]-t[1])),n=r["o"].length(r["o"].set(Nl,o.point[0]-t[0],o.point[1]-t[1]));h=this.oA(s.point,o.point,t,n),u=this.oA(s.point,o.point,t,e)}this.TransformHelper.updateMatrix(this.map,this.U,c,u,a),this.U.m(this.$,a,l,h,.01,this.map,this)}this.lastMousePosition=t,this.lastPickingObject=this.currentPickingObject;const e=this.G();this.lastPickingMesh=e[this.currentPickingObject.meshId]}oA(t,e,n,i,s){const o=(r["o"].length(r["o"].set(Nl,t[0]-n[0],t[1]-n[1]))-r["o"].length(r["o"].set(Nl,e[0]-n[0],e[1]-n[1])))/i;return s?(s[0]-.01)*o:o}IA(){const t=this.map,e=this.U.getCoordinates(),n=t.coordinateToPointAtRes(e,t.getGLRes()),i=r["p"].set(Dl,n.x,n.y,0),s=tl(t,this.U.getTranslation());return r["p"].add(i,i,s),i}Z(t){const e=this.TransformHelper.planeHelper.getMeshes()[0][0],n=r["k"].getTranslation(Rl,e.localTransform),i=r["k"].getScaling(kl,e.localTransform);let s=r["l"].fromEuler(Pl,0,0,0);const o=this.map.getBearing();t&&!this.iA()?(s=r["l"].fromEuler(Pl,90,0,-o),0===e.rotation[0]&&(this.q=!0),r["p"].set(e.rotation,90,0,-o)):(90===e.rotation[0]&&(this.q=!0),r["p"].set(e.rotation,0,0,-o)),r["k"].fromRotationTranslationScale(e.localTransform,s,n,i)}iA(){if(this.map.getPitch())return!1;const t=this.map.cameraPosition,e=this.map.coordinateToPointAtRes(this.map.getCenter(),this.map.getGLRes());r["p"].set(e,e.x,e.y,0);const n=this.U.getCoordinates(),i=this.map.coordinateToPointAtRes(n,this.map.getGLRes()),s=tl(this.map,this.U.getTranslation()),o=r["p"].set(Rl,i.x,i.y,0),a=r["p"].add(o,o,s),l=r["p"].subtract([],t,a),h=r["p"].subtract([],t,e);return r["p"].angle(l,h)<1/180*Math.PI}Y(){const t=this.G();if(this.currentPickingObject&&null!=this.currentPickingObject.meshId){this.gA(),this.lastPickingObject&&null!=this.lastPickingObject.meshId&&this.lastPickingObject.meshId!==this.currentPickingObject.meshId&&this.rA();const e=t[this.currentPickingObject.meshId];if(e&&Cl.indexOf(this.currentPickingObject.pickingId)<0)if(this.currentPickingObject.pickingId>100)this.CA(e);else{const t=[e.originColor[0],e.originColor[1],e.originColor[2],.8];e.material.set("color",t),this.aA(e,.5)}this.layerRenderer.setToRedraw()}else this.lastPickingObject&&null!=this.lastPickingObject.meshId&&(this.map.resetCursor(),this.rA(),this.layerRenderer.setToRedraw())}CA(t){const e=[1,179/255,2/255,1];t.material.set("color",e),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach(t=>{t.material.set("color",e)})}gA(){6===this.currentPickingObject.pickingId?this.map.setCursor("ns-resize"):Tl.indexOf(this.currentPickingObject.pickingId)>-1?this.map.setCursor("move"):this.map.setCursor("pointer")}rA(){const t=this.lastPickingMesh;if(!t)return;const e=t.getUniform("uPickingId"),n=this.G();Tl.indexOf(e)>-1?n.forEach(t=>{Tl.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)}):El.indexOf(e)>-1?n.forEach(t=>{const e=t.getUniform("uPickingId");Ol.indexOf(e)>-1&&t.material.set("color",t.originColor)}):11===e&&n.forEach(t=>{Ol.indexOf(t.getUniform("uPickingId"))>-1&&t.material.set("color",t.originColor)}),t.material.set("color",t.originColor),t.properties.relatedMeshes&&t.properties.relatedMeshes.forEach(t=>{t.material.set("color",t.originColor)})}aA(t,e){const n=t.getUniform("uPickingId"),r=this.G();Tl.indexOf(n)>-1?r.forEach(n=>{if(Tl.indexOf(n.getUniform("uPickingId"))>-1&&n.getUniform("uPickingId")!==t.getUniform("uPickingId")){const t=[n.originColor[0],n.originColor[1],n.originColor[2],e];n.material.set("color",t)}}):"scaling"===this.O?r.forEach(t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=[149/255,179/255,199/255,.8];t.material.set("color",e)}}):"rotation"===this.O&&r.forEach(t=>{const e=t.getUniform("uPickingId");if(1===e||3===e||2===e||4===e){const e=t.originColor;t.material.set("color",[e[0],e[1],e[2],0])}})}reset(){this.map&&this.U&&(this.U.v(),this.TransformHelper.updateMatrix(this.map,this.U,0,0,[0,0,0]))}nA(t,e){const n=this.IA(),i=r["o"].set(Fl,e[0]-n[0],e[1]-n[1]),s=r["o"].set(Ll,t[0]-n[0],t[1]-n[1]),o=Math.atan2(i[1],i[0]);return(Math.atan2(s[1],s[0])-o)/Math.PI*180}X(t){return this.$=113===t||114===t?"x-scale":115===t||116===t?"z-scale":117===t||118===t?"y-scale":119===t?"xyz-scale":5===t?"xy-translate":6===t?"z-translate":7===t||9===t?"x-translate":8===t||10===t?"y-translate":11===t?"z-rotate":"scale",this.$}transform(t){if(!t)return;if(this.layerRenderer&&this.layerRenderer.layer&&(this.layerRenderer.layer.off("renderend",this.render),this.layerRenderer.layer.off("resizeCanvas",this.hA)),!this.map)return void console.error("should add to a target first");if(this.U&&(this.U.u(),this.U.l(t)),!this.U.getTargets().length)return;const e=this.map;this.TransformHelper.updateMatrix(e,this.U,0,0,[0,0,0]),this.wA(),this.q=!0}getTransformTarget(){return this.U}P(){delete this.U}wA(){const t=this.U.L();t&&(t.off("renderend",this.render),t.off("resizeCanvas",this.hA));const e=this.map.getLayers();let n=null;for(let l=0;l<e.length;l++)if(e[l]instanceof r["b"]){n=e[l];break}if(!n)return;const i=n.getLayers(),s=i.indexOf(t);if(s<0)return;i.splice(s,1),i.push(t);const o=this.map,a=t.getRenderer();this.layerRenderer=a,this.regl=a.regl,this.renderer=a.renderer,this.cA=this.layerRenderer.getFBORayPicking(),this.QA={projViewMatrix:o.projViewMatrix,projMatrix:o.projMatrix,viewMatrix:o.viewMatrix,pointSize:1},t.on("renderend",this.render,this),t.on("resizeCanvas",this.hA,this),a.setToRedraw()}hA(){this.cA.clear(),this.q=!0}j(t,e,n){const r=this.map;if(!(r&&this.cA&&this.layerRenderer&&this.layerRenderer.canvas))return null;const i=r.getDevicePixelRatio(),s=t.x*i,o=t.y*i,a=this.QA,l=this.layerRenderer.canvas.gl&&this.layerRenderer.canvas.gl.wrap;return(this.q||l||!this.fA||this.fA!==n)&&(this.cA.render(e,a,!0),this.fA=n,this.q=!1),this.cA.pick(s,o,10,a,{viewMatrix:this.map.viewMatrix,projMatrix:this.map.projMatrix,returnPoint:!0})}_(){const t=this.map.getDevicePixelRatio(),e={x:0,y:0,width:()=>this.map?this.map.width*t:1,height:()=>this.map?this.map.height*t:1};this.lA=new r["m"].MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewModelMatrix;\n\n\n\nvoid main()\n\n{\n\n    gl_Position = projViewModelMatrix * vec4(aPosition, 1.0);\n\n\n\n}\n\n",frag:"precision mediump float;\n\nuniform vec4 color;\n\n\n\nvoid main() {\n\n    gl_FragColor = color;\n\n}\n\n",uniforms:["color",{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,func:"always",mask:!0,range:[0,0]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}},defines:{}})}render(){if(!this.K())return;const t=this.G();this.helperScene.setMeshes(t);const e=this.layerRenderer.getFrameContext();if(e&&e.renderTarget&&this.layerRenderer.getFrameTimestamp()!==e.timestamp)return;this.AA(),this.lA.filter=e&&e.sceneFilter;const n=e&&e.renderTarget&&e.renderTarget.fbo;this.renderer.render(this.lA,this.QA,this.helperScene,n)}G(){let t=[];const e=this.TransformHelper.getMeshes(this.O);for(const r in e){if("translate"===r)continue;const n=e[r];for(let e=0;e<n.length;e++)t=t.concat(n[e])}const n=e.translate;if(n)for(let r=0;r<n.length;r++)t=t.concat(n[r]);return t}K(){const t=this.layerRenderer,e=t&&t.layer;return t&&this.U&&e&&e.isVisible()&&this.U.M()&&this.regl&&this.F}}zl.mergeOptions({scaleStrength:2}),"undefined"!=typeof console&&console.log("@maptalks/transform-control v0.97.4");
/*!
 * @maptalks/video-layer v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */
/*!
* Contains code from THREE.js
* MIT License
* https://github.com/mrdoob/three.js
*/
for(var Bl=[],Hl=0;Hl<6;Hl++)Bl[Hl]=[];var Ul=[];function jl(t,e,n){var r,i,s,o,a,l,h,c,u,f,d,p,A,g,m,y,v;i=(r=t)[0],s=r[1],o=r[2],a=r[3],l=r[4],h=r[5],c=r[6],u=r[7],f=r[8],d=r[9],p=r[10],A=r[11],g=r[12],m=r[13],y=r[14],v=r[15],Vl(Bl[0],a-i,u-l,A-f,v-g),Vl(Bl[1],a+i,u+l,A+f,v+g),Vl(Bl[2],a+s,u+h,A+d,v+m),Vl(Bl[3],a-s,u-h,A-d,v-m),Vl(Bl[4],a-o,u-c,A-p,v-y),Vl(Bl[5],a+o,u+c,A+p,v+y);for(var x=0;x<6;x++)if(!n||"0"!==n.charAt(x)){var b=Bl[x];if(Ul[0]=b[0]>0?e[1][0]:e[0][0],Ul[1]=b[1]>0?e[1][1]:e[0][1],Ul[2]=b[2]>0?e[1][2]:e[0][2],Gl(b,Ul)<0)return!1}return!0}function Vl(t,e,n,r,i){var s=1/Math.sqrt(e*e+n*n+r*r);return t[0]=e*s,t[1]=n*s,t[2]=r*s,t[3]=i*s,t}function Gl(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}const ql={vert:"\n    attribute vec3 aPosition;\n    attribute vec2 aTexCoord;\n    uniform mat4 projViewModelMatrix;\n    uniform mat4 positionMatrix;\n    uniform mat4 modelMatrix;\n    varying vec2 vTexCoords;\n    #include <get_output>\n    void main()\n    {\n        mat4 localPositionMatrix = getPositionMatrix();\n        vec4 localPosition = getPosition(aPosition);\n        gl_Position = projViewModelMatrix * localPositionMatrix * localPosition;\n        vTexCoords = aTexCoord;\n    }\n",frag:"\n    precision mediump float;\n    uniform sampler2D videoTexture;\n    uniform float opacity;\n\n    varying vec2 vTexCoords;\n    void main() {\n        vec4 color = texture2D(videoTexture, vTexCoords);\n        gl_FragColor = color * opacity;\n    }\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>r["k"].multiply([],e.projViewMatrix,e.modelMatrix)},"texture","opacity"],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,func:"always"},cull:{enable:!1,face:"back"},frontFace:"cw",blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},Wl=[1,0,3,3,2,1];class Xl extends i["P"].CanvasRenderer{constructor(t){super(t),this.t={}}draw(t,e){this.prepareCanvas(),this.i(e)}drawOnInteracting(t,e,n){this.i(n)}needToRedraw(){return!0}hitDetect(){return!1}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.s(this.canvas,t),this.regl=Object(r["h"])({gl:this.gl,extensions:["ANGLE_instanced_arrays","OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","EXT_shader_texture_lod","OES_element_index_uint","OES_standard_derivatives","WEBGL_depth_texture"],optionalExtensions:this.layer.options.glExtensions||[]})}this.o(),this.h();const t=this.layer.getVideoSurfaces();for(let e=0;e<t.length;e++)this.l(t[e])}s(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}h(){const t=this.layer.getMap(),e=new r["m"].Renderer(this.regl);this.renderer=e,this.u={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,halton:[.2107,-.0202],uHalton:[.2107,-.0202],uCameraPosition:t.cameraPosition,cameraPosition:t.cameraPosition,globalTexSize:[t.width,t.height]}}p(){return this.regl}o(){this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1},this.m()}m(){this.v&&this.v.dispose(),this.layer.options.showTopAlways?(ql.extraCommandProps.depth.mask=!1,ql.extraCommandProps.depth.range=[0,0]):(delete ql.extraCommandProps.depth.mask,delete ql.extraCommandProps.depth.range),ql.extraCommandProps.cull.enable=!this.layer.options.doubleSide,this.v=new r["m"].MeshShader(ql)}l(t){const e=this.regl.texture(),n=new r["m"].Material({videoTexture:e,opacity:1}),i=t.getCoordinates(),{worldCenter:s,points:o}=this._(i),a=this.g(o),l=new r["m"].Mesh(a,n);this.O(l,s);const h=new r["m"].Scene(l),c=t.S();this.t[c]=h}T(t){const e=t.S(),n=this.t[e].getMeshes()[0],r=t.getCoordinates();n.geometry.dispose();const{worldCenter:i,points:s}=this._(r),o=this.g(s);n.geometry=o,this.O(n,i)}i(t){const e=this.layer.getVideoSurfaces().filter(t=>t.isVisible());if(!e.length)return;const n=this.C(e);if(!n)return;let r=null;t&&(r=t.renderTarget&&t.renderTarget.fbo),this.renderer.render(this.v,this.u,n,r)}g(t){return new r["m"].Geometry({POSITION:t,TEXCOORD:[0,0,1,0,1,1,0,1]},Wl,0,{primitive:"triangles",positionAttribute:"POSITION",uv0Attribute:"TEXCOORD",normalAttribute:"NORMAL",positionSize:3})}_(t){let e=[];const n=this.getMap(),r=new i["C"](t).getCenter(),s=Ql(n,r,0);return this.M=s,n&&t.forEach(t=>{const r=new i["f"](t[0],t[1]),o=n.altitudeToPoint(t[2]||0,n.getGLRes()),a=Ql(n,r,o);a[0]=a[0]-s[0],a[1]=a[1]-s[1],e=e.concat(a)}),{worldCenter:s,points:e}}C(t){const e=[],n=this.layer.getMap();for(let r=0;r<t.length;r++){const i=t[r],s=this.t[i.S()];if(!s)continue;const o=s.getMeshes();for(let t=0;t<o.length;t++){const r=o[t],s=r.getMaterial(),a=s.get("videoTexture");a&&i.P()&&(a(i.video),s.set("opacity",i.getOpacity())),jl(n.projViewMatrix,r.getBoundingBox())&&e.push(r)}}return e.length?new r["m"].Scene(e):null}O(t,e){r["k"].fromRotationTranslationScale(t.localTransform,r["l"].fromEuler([],0,0,0),e,[1,1,1])}remove(){this.v&&this.v.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}V(t){const e=this.t[t];e&&e.getMeshes().forEach(t=>{t.geometry.dispose(),t.material&&t.material.dispose(),t.dispose()})}}function Ql(t,e,n){if(!t)return null;const r=t.coordinateToPointAtRes(e,t.getGLRes());return[r.x,r.y,n]}class Yl extends(Object(i["j"])(Object(i["n"])(i["e"]))){constructor(t,e){super(e),this.setCoordinates(t),this.A(this.options.url)}setCoordinates(t){this.k=t}getCoordinates(){return this.k}setVideo(t){this.I="stop",this.options.url=t,delete this.options.elementId,this.A()}setElementId(t){this.I="stop",this.options.elementId=t,delete this.options.url,this.A()}A(){this.I="stop";const t=this.options.url,e=this.options.elementId;let n=document.getElementById(e);if(t&&(n=document.createElement("video"),n.src=t),!n)throw new Error("there is no element or url setting for video mask");n.autoplay=!0,n.loop=!0,n.muted=!0,n.play(),n.addEventListener("playing",()=>{this.I="playing",this.fire("playing",{state:this.I,url:t})}),n.addEventListener("pause",()=>{this.I="pause",this.fire("pause",{state:this.I,url:t})}),n.addEventListener("error",()=>{throw this.I="pause",this.fire("error",{state:this.I,url:t}),new Error("video resource load error")}),this.video=n}getVideo(){return this.video}R(t){this.D=t}S(){return this.D}addTo(t){if(this.L)throw new Error("VideoSurface cannot be added to two or more layers at the same time.");return t.addSurfaces(this),this}show(){return this.options.visible=!0,this}hide(){return this.options.visible=!1,this}isVisible(){return this.options.visible}play(){this.video&&this.video.play()}pause(){this.video&&this.video.pause()}setAudio(t){this.video.muted=t}setOpacity(t){this.options.opacity=t}getOpacity(){return this.options.opacity}remove(){delete this.video;const t=this.getLayer();t&&t.removeVideoSurfaces(this),this.endEdit()}getLayer(){return this.L}P(){return"playing"===this.I}startEdit(){const t=this.getLayer();if(!t)return void console.warn("videosurface should be added to a map before edit");const e=t.getMap();if(!e)return void console.warn("videosurface should be added to a map before edit");if(this.j(),!this.F){const n=t.getId();this.F=new i["J"](`internal_${n}_edit`,{enableAltitude:!0}).addTo(e)}const n=this.getCoordinates();this.N=new i["C"](n,{symbol:{lineColor:"#34495e",lineWidth:2,polygonFill:"rgb(135,196,240)",polygonOpacity:.1}}).addTo(this.F),this.N.startEdit({newVertexHandleSymbol:{polygonFill:"rgba(0, 0, 0, 0)",polygonOpacity:0,markerType:"ellipse",markerWidth:1,markerHeight:1}}),this.N.on("shapechange",e=>{const n=e.target.getCoordinates()[0].slice(0,4).map(t=>[t.x,t.y,0]);this.setCoordinates(n),t.getRenderer().T(this)},this)}endEdit(){this.F&&(this.N.endEdit(),this.N.remove(),this.F.remove()),delete this.F,delete this.N}j(){this.F&&this.F.clear(),delete this.N}}Yl.mergeOptions({opacity:1,visible:!0});class Zl extends i["r"]{constructor(t,e,n){!e||Array.isArray(e)||e instanceof Yl||(n=e,e=null),super(t,n),this.G={},this.videoId=0,e&&this.addSurfaces(e)}addSurfaces(t){if(t)if(Array.isArray(t))t.forEach(t=>{this.addMarker(t)});else{t.L=this,this.G[this.videoId]=t,t.R(this.videoId);const e=this.getRenderer();e?e.p()&&e.l(t):this.on("renderercreate",e=>{e.renderer.p()&&e.renderer.l(t)}),this.videoId++}}showTopAlways(t){this.options.showTopAlways=t;const e=this.getRenderer();e&&e.m()}setDoubleSide(t){this.options.doubleSide=t;const e=this.getRenderer();e&&e.m()}getVideoSurfaces(){const t=[];for(const e in this.G)t.push(this.G[e]);return t}removeVideoSurfaces(t){if(Array.isArray(t))t.forEach(t=>{this.removeVideoSurfaces(t)});else{const e=t.S(),n=this.getRenderer();n&&n.V(e),delete this.G[e]}}remove(){this.clear(),super.remove()}clear(){const t=this.getVideoSurfaces();for(let e=0;e<t.length;e++)t[e].remove()}}Zl.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,showTopAlways:!0,doubleSide:!0}),Zl.registerJSONType("VideoLayer"),Zl.registerRenderer("gl",Xl),"undefined"!=typeof console&&console.log("@maptalks/video-layer v0.97.4");
/*!
 * @maptalks/analysis v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */
var Kl,Jl="undefined"!=typeof Float32Array?Float32Array:Array;function $l(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],d=e[10],p=e[11],A=e[12],g=e[13],m=e[14],y=e[15],v=n[0],x=n[1],b=n[2],w=n[3];return t[0]=v*r+x*a+b*u+w*A,t[1]=v*i+x*l+b*f+w*g,t[2]=v*s+x*h+b*d+w*m,t[3]=v*o+x*c+b*p+w*y,v=n[4],x=n[5],b=n[6],w=n[7],t[4]=v*r+x*a+b*u+w*A,t[5]=v*i+x*l+b*f+w*g,t[6]=v*s+x*h+b*d+w*m,t[7]=v*o+x*c+b*p+w*y,v=n[8],x=n[9],b=n[10],w=n[11],t[8]=v*r+x*a+b*u+w*A,t[9]=v*i+x*l+b*f+w*g,t[10]=v*s+x*h+b*d+w*m,t[11]=v*o+x*c+b*p+w*y,v=n[12],x=n[13],b=n[14],w=n[15],t[12]=v*r+x*a+b*u+w*A,t[13]=v*i+x*l+b*f+w*g,t[14]=v*s+x*h+b*d+w*m,t[15]=v*o+x*c+b*p+w*y,t}function th(){var t=new Jl(3);return Jl!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function eh(t,e,n){var r=new Jl(3);return r[0]=t,r[1]=e,r[2]=n,r}function nh(){var t=new Jl(4);return Jl!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function rh(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}th(),function(){var t;t=new Jl(4),Jl!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0)}(),th(),eh(1,0,0),eh(0,1,0),nh(),nh(),Kl=new Jl(9),Jl!=Float32Array&&(Kl[1]=0,Kl[2]=0,Kl[3]=0,Kl[5]=0,Kl[6]=0,Kl[7]=0),Kl[0]=1,Kl[4]=1,Kl[8]=1,function(){(function(){var t=new Jl(2);Jl!=Float32Array&&(t[0]=0,t[1]=0)})()}();class ih{constructor(t,e){this.renderer=t,this.regl=t.regl,this.u=e,this.h()}h(){this.l=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:2048,height:2048,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0})}g(t,e,n){const r={projViewMatrix:e,minAltitude:0,logDepthBufFC:2/(Math.log(n+1)/Math.LN2)};this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this.l}),this.renderer.render(this.C,r,t,this.l)}D(t,e){this.C=new r["m"].MeshShader({vert:"#include <gl2_vert>\n\n#ifdef HAS_ALTITUDE\n\n    attribute vec2 aPosition;\n\n    attribute float aAltitude;\n\n#else\n\n    attribute vec3 aPosition;\n\n#endif\n\n// uniform mat4 projViewMatrix;\n\n// uniform mat4 modelMatrix;\n\nuniform mat4 projViewModelMatrix;\n\nuniform mat4 positionMatrix;\n\nvarying vec2 vHighPrecisionZW;\n\n#include <get_output>\n\nvarying float vFragDepth;\n\n\n\n#ifdef HAS_ALTITUDE\n\n    vec3 unpackVTPosition() {\n\n        return vec3(aPosition, aAltitude);\n\n    }\n\n#endif\n\nvoid main()\n\n{\n\n    #ifdef HAS_ALTITUDE\n\n        vec3 i = unpackVTPosition();\n\n        vec4 j = vec4(i, 1.);\n\n        gl_Position = projViewModelMatrix * j;\n\n    #else\n\n        mat4 localPositionMatrix = getPositionMatrix();\n\n        gl_Position = projViewModelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    #endif\n\n    vFragDepth = 1.0 + gl_Position.w;\n\n    vHighPrecisionZW = gl_Position.zw;\n\n}\n\n",frag:"#ifdef GL_ES\n\nprecision highp float;\n\n#endif\n\n#include <gl2_frag>\n\n\n\nuniform float logDepthBufFC;\n\nvarying float vFragDepth;\n\nvarying vec2 vHighPrecisionZW;\n\n\n\nconst float PackUpscale = 256. / 255.;\n\nconst float UnpackDownscale = 255. / 256.;\n\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n\nconst float ShiftRight8 = 1. / 256.;\n\nvec4 packDepthToRGBA(const in float v ) {\n\n    vec4 r = vec4(fract(v * PackFactors), v);\n\n    r.yzw -= r.xyz * ShiftRight8;\n\n    return r * PackUpscale;\n\n}\n\nvoid main() {\n\n    gl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n\n    float fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\n    glFragColor = packDepthToRGBA(fragCoordZ);\n\n    #if __VERSION__ == 100\n\n        gl_FragColor = glFragColor;\n\n    #endif\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>$l([],e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:{x:0,y:0,width:()=>{const n=this.I(t,e);return n?n.width:1},height:()=>{const n=this.I(t,e);return n?n.height:1}}}}),this.C.version=300}I(t,e){return this.m(t,e)?{width:2048,height:2048}:null}m(t,e){return t&&e&&t*e>0}dispose(){this.l&&this.l.destroy(),this.C&&this.C.dispose()}}function sh(t,e){return t.altitudeToPoint(e||0,t.getGLRes())}const oh=new i["f"](0,0);function ah(t,e,n,r){if(!t)return null;oh.set(e,n);const i=t.coordinateToPointAtRes(oh,t.getGLRes()),s=sh(t,r);return[i.x,i.y,s]}var lh={exports:{}};function hh(t,e,n){n=n||2;var r,i,s,o,a,l,h,c=e&&e.length,u=c?e[0]*n:t.length,f=ch(t,0,u,n,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=function(t,e,n,r){var i,s,o,a,l,h=[];for(i=0,s=e.length;i<s;i++)o=e[i]*r,a=i<s-1?e[i+1]*r:t.length,(l=ch(t,o,a,r,!1))===l.next&&(l.steiner=!0),h.push(bh(l));for(h.sort(mh),i=0;i<h.length;i++)n=yh(h[i],n);return n}(t,e,f,n)),t.length>80*n){r=s=t[0],i=o=t[1];for(var p=n;p<u;p+=n)(a=t[p])<r&&(r=a),(l=t[p+1])<i&&(i=l),a>s&&(s=a),l>o&&(o=l);h=0!==(h=Math.max(s-r,o-i))?32767/h:0}return fh(f,d,n,r,i,h,0),d}function ch(t,e,n,r,i){var s,o;if(i===Nh(t,e,n,r)>0)for(s=e;s<n;s+=r)o=Ph(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=Ph(s,t[s],t[s+1],o);return o&&Th(o,o.next)&&(kh(o),o=o.next),o}function uh(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!Th(r,r.next)&&0!==Mh(r.prev,r,r.next))r=r.next;else{if(kh(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function fh(t,e,n,r,i,s,o){if(t){!o&&s&&function(t,e,n,r){var i=t;do{0===i.z&&(i.z=xh(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,s,o,a,l,h=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,r=n,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1)}(i)}(t,r,i,s);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,s?ph(t,r,i,s):dh(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),kh(t),t=l.next,h=l.next;else if((t=l)===h){o?1===o?fh(t=Ah(uh(t),e,n),e,n,r,i,s,2):2===o&&gh(t,e,n,r,i,s):fh(uh(t),e,n,r,i,s,1);break}}}function dh(t){var e=t.prev,n=t,r=t.next;if(Mh(e,n,r)>=0)return!1;for(var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&wh(i,a,s,l,o,h,p.x,p.y)&&Mh(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ph(t,e,n,r){var i=t.prev,s=t,o=t.next;if(Mh(i,s,o)>=0)return!1;for(var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=xh(d,p,e,n,r),y=xh(A,g,e,n,r),v=t.prevZ,x=t.nextZ;v&&v.z>=m&&x&&x.z<=y;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&wh(a,c,l,u,h,f,v.x,v.y)&&Mh(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&wh(a,c,l,u,h,f,x.x,x.y)&&Mh(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=m;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&wh(a,c,l,u,h,f,v.x,v.y)&&Mh(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&wh(a,c,l,u,h,f,x.x,x.y)&&Mh(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function Ah(t,e,n){var r=t;do{var i=r.prev,s=r.next.next;!Th(i,s)&&Sh(i,r,r.next,s)&&Oh(i,s)&&Oh(s,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(s.i/n|0),kh(r),kh(r.next),r=t=s),r=r.next}while(r!==t);return uh(r)}function gh(t,e,n,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&_h(o,a)){var l=Eh(o,a);return o=uh(o,o.next),l=uh(l,l.next),fh(o,e,n,r,i,s,0),void fh(l,e,n,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function mh(t,e){return t.x-e.x}function yh(t,e){var n=function(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&wh(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),Oh(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&vh(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}(t,e);if(!n)return e;var r=Eh(n,t);return uh(r,r.next),uh(n,n.next)}function vh(t,e){return Mh(t.prev,t,e.prev)<0&&Mh(e.next,t,t.next)<0}function xh(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function bh(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function wh(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function _h(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Sh(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Oh(t,e)&&Oh(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(Mh(t.prev,t,e.prev)||Mh(t,e.prev,e))||Th(t,e)&&Mh(t.prev,t,t.next)>0&&Mh(e.prev,e,e.next)>0)}function Mh(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Th(t,e){return t.x===e.x&&t.y===e.y}function Sh(t,e,n,r){var i=Ch(Mh(t,e,n)),s=Ch(Mh(t,e,r)),o=Ch(Mh(n,r,t)),a=Ch(Mh(n,r,e));return i!==s&&o!==a||!(0!==i||!Ih(t,n,e))||!(0!==s||!Ih(t,r,e))||!(0!==o||!Ih(n,t,r))||!(0!==a||!Ih(n,e,r))}function Ih(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Ch(t){return t>0?1:t<0?-1:0}function Oh(t,e){return Mh(t.prev,t,t.next)<0?Mh(t,e,t.next)>=0&&Mh(t,t.prev,e)>=0:Mh(t,e,t.prev)<0||Mh(t,t.next,e)<0}function Eh(t,e){var n=new Rh(t.i,t.x,t.y),r=new Rh(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function Ph(t,e,n,r){var i=new Rh(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function kh(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Rh(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Nh(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}lh.exports=hh,lh.exports.default=hh,hh.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(Nh(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(Nh(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},hh.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n};lh.exports;Object(i["j"])(Object(i["n"])(i["e"]));r["m"].MeshShader;rh([]),rh([]),new i["A"](0,0);"undefined"==typeof document||document.createElement("canvas");const Dh=[0,0,0,1],Fh=[],Lh=[];class zh extends ih{h(){this.T=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.O=new r["m"].MeshShader({vert:"attribute vec3 aPosition;\n\nuniform mat4 projViewModelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\n#include <get_output>\n\nvarying vec4 vPosition;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    vec4 worldPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\n\n    vPosition = worldPosition;\n\n    gl_Position = projViewModelMatrix * localPositionMatrix * getPosition(aPosition);\n\n}\n\n",frag:"#ifdef GL_ES\n\nprecision highp float;\n\n#endif\n\n#include <gl2_frag>\n\n\n\nvarying vec4 vPosition;\n\n\n\nconst vec2 range = vec2(-100.0, 1000.0);\n\nvec4 encodeHeight(const in float height) {\n\n    float alpha = 1.0;\n\n    vec4 pack = vec4(0.0);\n\n    pack.a = alpha;\n\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n\n    pack.rgb = vec3(code * height);\n\n    pack.gb = fract(pack.gb);\n\n    pack.rg -= pack.gb * (1.0 / 256.0);\n\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n\n    return pack;\n\n}\n\n\n\nvoid main() {\n\n    float height = (vPosition.z - range.x) / (range.y - range.x);\n\n    glFragColor = encodeHeight(height);\n\n    #if __VERSION__ == 100\n\n        gl_FragColor = glFragColor;\n\n    #endif\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>r["k"].multiply(Fh,e.viewMatrix,e.modelMatrix)},{name:"projViewModelMatrix",type:"function",fn:(t,e)=>r["k"].multiply(Lh,e.projViewMatrix,e.modelMatrix)}],extraCommandProps:{viewport:this.u,cull:{enable:!0},frontFace:"ccw"}}),this.F=new r["m"].Scene}render(t,e){this.U(),this.renderer.clear({color:Dh,depth:1,framebuffer:this.T}),this.F.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this.O,n,this.F,this.T),this.T}U(){const t=i["I"].isFunction(this.u.width)?this.u.width():this.u.width,e=i["I"].isFunction(this.u.height)?this.u.height():this.u.height;!this.T||this.T.width===t&&this.T.height===e||this.T.resize(t,e)}dispose(){this.T&&(this.T.destroy(),delete this.T),this.O&&(this.O.dispose(),delete this.O)}}const Bh=fr.getRendererClass("gl");class Hh extends fr{excavate(t){this.N=!0,this.wt=Array.isArray(t)?t:[t];const e=this.getRenderer();e&&(e.Pt(),e.setToRedraw())}getExcavatedLayers(){return this.wt}enable(){this.N=!0,this.Ct()}disable(){this.N=!1,this.Ct()}isEnable(){return this.N}Ct(){const t=this.getRenderer();t&&t.setToRedraw()}}Hh.registerRenderer("gl",class extends Bh{draw(t,e){this.layer.getExcavatedLayers()&&this.layer.isEnable()&&(this.Dt(),super.draw(t,e))}Dt(){this._&&this.It||this.Mt(),this.bt=this.bt||this.Pt();const t=this.getMap(),e=this.meshes;if(e&&this.bt){for(let n=0;n<e.length;n++){const r=e[n],i=r.getDefines();i.HAS_EXCAVATE_ANALYSIS=1,r.setDefines(i),r.setUniform("heightmap",this.bt),r.setUniform("excavateExtent",this.It),r.setUniform("excavateHeight",sh(t,this.options.height))}this.setToRedraw()}}Pt(){const t=this.layer.getExcavatedLayers();this.zt=[];for(let e=0;e<t.length;e++){const n=t[e].getRenderer();if(!n.getAnalysisMeshes)continue;const r=n.getAnalysisMeshes();i["I"].pushIn(this.zt,r)}return this.zt.length?(this.B=this.B||this.S(),this.B.render(this.zt,this._)):null}Mt(){const t=this.layer.getMap(),e=this.layer.getExtent(),n=t.getCenter(),i=t.getZoom(),s=t.getPitch(),o=t.getBearing(),a=t.getFitZoom(e),l=e.getCenter();t.setZoom(a),t.setCenter(l),t.setPitch(0),t.setBearing(0);const h=t.getExtent();this._=this._||[],r["k"].copy(this._,t.projViewMatrix);const c=ah(t,h.xmin,h.ymin),u=ah(t,h.xmax,h.ymax);this.It=r["q"].set(this.It||[],c[0],c[1],u[0],u[1]),t.setZoom(i),t.setCenter(n),t.setPitch(s),t.setBearing(o)}S(){this.u={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1};const t=new r["m"].Renderer(this.regl);return this.B=this.B||new zh(t,this.u),this.B}dt(){this.Mt(),this.setToRedraw()}onGeometryAdd(t){super.onGeometryAdd(t),this.dt()}onGeometryRemove(){super.onGeometryRemove(),this.dt()}remove(){super.remove(),this.B&&this.B.dispose()}});function Uh(t){var e=[1/0,1/0,-1/0,-1/0];return function t(e,n,r){if(null!==e)for(var i,s,o,a,l,h,c,u,f=0,d=0,p=e.type,A="FeatureCollection"===p,g="Feature"===p,m=A?e.features.length:1,y=0;y<m;y++){l=(u=!!(c=A?e.features[y].geometry:g?e.geometry:e)&&"GeometryCollection"===c.type)?c.geometries.length:1;for(var v=0;v<l;v++){var x=0,b=0;if(null!==(a=u?c.geometries[v]:c)){h=a.coordinates;var w=a.type;switch(f=!r||"Polygon"!==w&&"MultiPolygon"!==w?0:1,w){case null:break;case"Point":if(!1===n(h,d,y,x,b))return!1;d++,x++;break;case"LineString":case"MultiPoint":for(i=0;i<h.length;i++){if(!1===n(h[i],d,y,x,b))return!1;d++,"MultiPoint"===w&&x++}"LineString"===w&&x++;break;case"Polygon":case"MultiLineString":for(i=0;i<h.length;i++){for(s=0;s<h[i].length-f;s++){if(!1===n(h[i][s],d,y,x,b))return!1;d++}"MultiLineString"===w&&x++,"Polygon"===w&&b++}"Polygon"===w&&x++;break;case"MultiPolygon":for(i=0;i<h.length;i++){for(b=0,s=0;s<h[i].length;s++){for(o=0;o<h[i][s].length-f;o++){if(!1===n(h[i][s][o],d,y,x,b))return!1;d++}b++}x++}break;case"GeometryCollection":for(i=0;i<a.geometries.length;i++)if(!1===t(a.geometries[i],n,r))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}(t,(function(t){e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])})),e}Uh.default=Uh,"fill"in Array.prototype||Object.defineProperty(Array.prototype,"fill",{configurable:!0,value:function(t){if(null==this)throw new TypeError(this+" is not an object");var e=Object(this),n=Math.max(Math.min(e.length,9007199254740991),0)||0,r=1 in arguments&&parseInt(Number(arguments[1]),10)||0;r=r<0?Math.max(n+r,0):Math.min(r,n);var i=2 in arguments&&void 0!==arguments[2]?parseInt(Number(arguments[2]),10)||0:n;for(i=i<0?Math.max(n+arguments[2],0):Math.min(i,n);r<i;)e[r]=t,++r;return e},writable:!0}),Number.isFinite=Number.isFinite||function(t){return"number"==typeof t&&isFinite(t)},Number.isInteger=Number.isInteger||function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t},Number.parseFloat=Number.parseFloat||parseFloat,Number.isNaN=Number.isNaN||function(t){return t!=t},Math.trunc=Math.trunc||function(t){return t<0?Math.ceil(t):Math.floor(t)};var jh=function(){};jh.prototype.interfaces_=function(){return[]},jh.prototype.getClass=function(){return jh},jh.prototype.equalsWithTolerance=function(t,e,n){return Math.abs(t-e)<=n};var Vh=function(t){function e(e){t.call(this,e),this.name="IllegalArgumentException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),Gh=function(){},qh={MAX_VALUE:{configurable:!0}};Gh.isNaN=function(t){return Number.isNaN(t)},Gh.doubleToLongBits=function(t){return t},Gh.longBitsToDouble=function(t){return t},Gh.isInfinite=function(t){return!Number.isFinite(t)},qh.MAX_VALUE.get=function(){return Number.MAX_VALUE},Object.defineProperties(Gh,qh);var Wh=function(){},Xh=function(){},Qh=function(){};function Yh(){}var Zh=function t(){if(this.x=null,this.y=null,this.z=null,0===arguments.length)this.x=0,this.y=0,this.z=t.NULL_ORDINATE;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.z=e.z}else 2===arguments.length?(this.x=arguments[0],this.y=arguments[1],this.z=t.NULL_ORDINATE):3===arguments.length&&(this.x=arguments[0],this.y=arguments[1],this.z=arguments[2])},Kh={DimensionalComparator:{configurable:!0},serialVersionUID:{configurable:!0},NULL_ORDINATE:{configurable:!0},X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0}};Zh.prototype.setOrdinate=function(t,e){switch(t){case Zh.X:this.x=e;break;case Zh.Y:this.y=e;break;case Zh.Z:this.z=e;break;default:throw new Vh("Invalid ordinate index: "+t)}},Zh.prototype.equals2D=function(){if(1===arguments.length){var t=arguments[0];return this.x===t.x&&this.y===t.y}if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!jh.equalsWithTolerance(this.x,e.x,n)&&!!jh.equalsWithTolerance(this.y,e.y,n)}},Zh.prototype.getOrdinate=function(t){switch(t){case Zh.X:return this.x;case Zh.Y:return this.y;case Zh.Z:return this.z}throw new Vh("Invalid ordinate index: "+t)},Zh.prototype.equals3D=function(t){return this.x===t.x&&this.y===t.y&&(this.z===t.z||Gh.isNaN(this.z))&&Gh.isNaN(t.z)},Zh.prototype.equals=function(t){return t instanceof Zh&&this.equals2D(t)},Zh.prototype.equalInZ=function(t,e){return jh.equalsWithTolerance(this.z,t.z,e)},Zh.prototype.compareTo=function(t){var e=t;return this.x<e.x?-1:this.x>e.x?1:this.y<e.y?-1:this.y>e.y?1:0},Zh.prototype.clone=function(){},Zh.prototype.copy=function(){return new Zh(this)},Zh.prototype.toString=function(){return"("+this.x+", "+this.y+", "+this.z+")"},Zh.prototype.distance3D=function(t){var e=this.x-t.x,n=this.y-t.y,r=this.z-t.z;return Math.sqrt(e*e+n*n+r*r)},Zh.prototype.distance=function(t){var e=this.x-t.x,n=this.y-t.y;return Math.sqrt(e*e+n*n)},Zh.prototype.hashCode=function(){var t=17;return 37*(t=37*t+Zh.hashCode(this.x))+Zh.hashCode(this.y)},Zh.prototype.setCoordinate=function(t){this.x=t.x,this.y=t.y,this.z=t.z},Zh.prototype.interfaces_=function(){return[Wh,Xh,Yh]},Zh.prototype.getClass=function(){return Zh},Zh.hashCode=function(){if(1===arguments.length){var t=arguments[0],e=Gh.doubleToLongBits(t);return Math.trunc((e^e)>>>32)}},Kh.DimensionalComparator.get=function(){return Jh},Kh.serialVersionUID.get=function(){return 0x5cbf2c235c7e5800},Kh.NULL_ORDINATE.get=function(){return Gh.NaN},Kh.X.get=function(){return 0},Kh.Y.get=function(){return 1},Kh.Z.get=function(){return 2},Object.defineProperties(Zh,Kh);var Jh=function(t){if(this.xt=2,0===arguments.length);else if(1===arguments.length){var e=arguments[0];if(2!==e&&3!==e)throw new Vh("only 2 or 3 dimensions may be specified");this.xt=e}};Jh.prototype.compare=function(t,e){var n=t,r=e,i=Jh.compare(n.x,r.x);if(0!==i)return i;var s=Jh.compare(n.y,r.y);return 0!==s?s:this.xt<=2?0:Jh.compare(n.z,r.z)},Jh.prototype.interfaces_=function(){return[Qh]},Jh.prototype.getClass=function(){return Jh},Jh.compare=function(t,e){return t<e?-1:t>e?1:Gh.isNaN(t)?Gh.isNaN(e)?0:-1:Gh.isNaN(e)?1:0};var $h=function(){};$h.prototype.create=function(){},$h.prototype.interfaces_=function(){return[]},$h.prototype.getClass=function(){return $h};var tc=function(){},ec={INTERIOR:{configurable:!0},BOUNDARY:{configurable:!0},EXTERIOR:{configurable:!0},NONE:{configurable:!0}};tc.prototype.interfaces_=function(){return[]},tc.prototype.getClass=function(){return tc},tc.toLocationSymbol=function(t){switch(t){case tc.EXTERIOR:return"e";case tc.BOUNDARY:return"b";case tc.INTERIOR:return"i";case tc.NONE:return"-"}throw new Vh("Unknown location value: "+t)},ec.INTERIOR.get=function(){return 0},ec.BOUNDARY.get=function(){return 1},ec.EXTERIOR.get=function(){return 2},ec.NONE.get=function(){return-1},Object.defineProperties(tc,ec);var nc=function(t,e){return t.interfaces_&&t.interfaces_().indexOf(e)>-1},rc=function(){},ic={LOG_10:{configurable:!0}};rc.prototype.interfaces_=function(){return[]},rc.prototype.getClass=function(){return rc},rc.log10=function(t){var e=Math.log(t);return Gh.isInfinite(e)||Gh.isNaN(e)?e:e/rc.LOG_10},rc.min=function(t,e,n,r){var i=t;return e<i&&(i=e),n<i&&(i=n),r<i&&(i=r),i},rc.clamp=function(){if("number"==typeof arguments[2]&&"number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1],n=arguments[2];return t<e?e:t>n?n:t}if(Number.isInteger(arguments[2])&&Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var r=arguments[0],i=arguments[1],s=arguments[2];return r<i?i:r>s?s:r}},rc.wrap=function(t,e){return t<0?e- -t%e:t%e},rc.max=function(){if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],r=t;return e>r&&(r=e),n>r&&(r=n),r}if(4===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3],l=i;return s>l&&(l=s),o>l&&(l=o),a>l&&(l=a),l}},rc.average=function(t,e){return(t+e)/2},ic.LOG_10.get=function(){return Math.log(10)},Object.defineProperties(rc,ic);var sc=function(t){this.str=t};sc.prototype.append=function(t){this.str+=t},sc.prototype.setCharAt=function(t,e){this.str=this.str.substr(0,t)+e+this.str.substr(t+1)},sc.prototype.toString=function(t){return this.str};var oc=function(t){this.value=t};oc.prototype.intValue=function(){return this.value},oc.prototype.compareTo=function(t){return this.value<t?-1:this.value>t?1:0},oc.isNaN=function(t){return Number.isNaN(t)};var ac=function(){};ac.isWhitespace=function(t){return t<=32&&t>=0||127===t},ac.toUpperCase=function(t){return t.toUpperCase()};var lc=function t(){if(this.yt=0,this.Lt=0,0===arguments.length)this.init(0);else if(1===arguments.length){if("number"==typeof arguments[0]){var e=arguments[0];this.init(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}else if("string"==typeof arguments[0]){var r=arguments[0];t.call(this,t.parse(r))}}else if(2===arguments.length){var i=arguments[0],s=arguments[1];this.init(i,s)}},hc={PI:{configurable:!0},TWO_PI:{configurable:!0},PI_2:{configurable:!0},E:{configurable:!0},NaN:{configurable:!0},EPS:{configurable:!0},SPLIT:{configurable:!0},MAX_PRINT_DIGITS:{configurable:!0},TEN:{configurable:!0},ONE:{configurable:!0},SCI_NOT_EXPONENT_CHAR:{configurable:!0},SCI_NOT_ZERO:{configurable:!0}};lc.prototype.le=function(t){return(this.yt<t.yt||this.yt===t.yt)&&this.Lt<=t.Lt},lc.prototype.extractSignificantDigits=function(t,e){var n=this.abs(),r=lc.magnitude(n.yt),i=lc.TEN.pow(r);(n=n.divide(i)).gt(lc.TEN)?(n=n.divide(lc.TEN),r+=1):n.lt(lc.ONE)&&(n=n.multiply(lc.TEN),r-=1);for(var s=r+1,o=new sc,a=lc.MAX_PRINT_DIGITS-1,l=0;l<=a;l++){t&&l===s&&o.append(".");var h=Math.trunc(n.yt);if(h<0)break;var c=!1,u=0;h>9?(c=!0,u="9"):u="0"+h,o.append(u),n=n.subtract(lc.valueOf(h)).multiply(lc.TEN),c&&n.selfAdd(lc.TEN);var f=!0,d=lc.magnitude(n.yt);if(d<0&&Math.abs(d)>=a-l&&(f=!1),!f)break}return e[0]=r,o.toString()},lc.prototype.sqr=function(){return this.multiply(this)},lc.prototype.doubleValue=function(){return this.yt+this.Lt},lc.prototype.subtract=function(){if(arguments[0]instanceof lc){var t=arguments[0];return this.add(t.negate())}if("number"==typeof arguments[0]){var e=arguments[0];return this.add(-e)}},lc.prototype.equals=function(){if(1===arguments.length){var t=arguments[0];return this.yt===t.yt&&this.Lt===t.Lt}},lc.prototype.isZero=function(){return 0===this.yt&&0===this.Lt},lc.prototype.selfSubtract=function(){if(arguments[0]instanceof lc){var t=arguments[0];return this.isNaN()?this:this.selfAdd(-t.yt,-t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.isNaN()?this:this.selfAdd(-e,0)}},lc.prototype.getSpecialNumberString=function(){return this.isZero()?"0.0":this.isNaN()?"NaN ":null},lc.prototype.min=function(t){return this.le(t)?this:t},lc.prototype.selfDivide=function(){if(1===arguments.length){if(arguments[0]instanceof lc){var t=arguments[0];return this.selfDivide(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.selfDivide(e,0)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1],i=null,s=null,o=null,a=null,l=null,h=null,c=null,u=null;return l=this.yt/n,u=(i=(h=lc.SPLIT*l)-(i=h-l))*(o=(u=lc.SPLIT*n)-(o=u-n))-(c=l*n)+i*(a=n-o)+(s=l-i)*o+s*a,u=l+(h=(this.yt-c-u+this.Lt-l*r)/n),this.yt=u,this.Lt=l-u+h,this}},lc.prototype.dump=function(){return"DD<"+this.yt+", "+this.Lt+">"},lc.prototype.divide=function(){if(arguments[0]instanceof lc){var t=arguments[0],e=null,n=null,r=null,i=null,s=null,o=null,a=null,l=null;n=(s=this.yt/t.yt)-(e=(o=lc.SPLIT*s)-(e=o-s)),l=e*(r=(l=lc.SPLIT*t.yt)-(r=l-t.yt))-(a=s*t.yt)+e*(i=t.yt-r)+n*r+n*i;var h=l=s+(o=(this.yt-a-l+this.Lt-s*t.Lt)/t.yt),c=s-l+o;return new lc(h,c)}if("number"==typeof arguments[0]){var u=arguments[0];return Gh.isNaN(u)?lc.createNaN():lc.copy(this).selfDivide(u,0)}},lc.prototype.ge=function(t){return(this.yt>t.yt||this.yt===t.yt)&&this.Lt>=t.Lt},lc.prototype.pow=function(t){if(0===t)return lc.valueOf(1);var e=new lc(this),n=lc.valueOf(1),r=Math.abs(t);if(r>1)for(;r>0;)r%2==1&&n.selfMultiply(e),(r/=2)>0&&(e=e.sqr());else n=e;return t<0?n.reciprocal():n},lc.prototype.ceil=function(){if(this.isNaN())return lc.NaN;var t=Math.ceil(this.yt),e=0;return t===this.yt&&(e=Math.ceil(this.Lt)),new lc(t,e)},lc.prototype.compareTo=function(t){var e=t;return this.yt<e.yt?-1:this.yt>e.yt?1:this.Lt<e.Lt?-1:this.Lt>e.Lt?1:0},lc.prototype.rint=function(){return this.isNaN()?this:this.add(.5).floor()},lc.prototype.setValue=function(){if(arguments[0]instanceof lc){var t=arguments[0];return this.init(t),this}if("number"==typeof arguments[0]){var e=arguments[0];return this.init(e),this}},lc.prototype.max=function(t){return this.ge(t)?this:t},lc.prototype.sqrt=function(){if(this.isZero())return lc.valueOf(0);if(this.isNegative())return lc.NaN;var t=1/Math.sqrt(this.yt),e=this.yt*t,n=lc.valueOf(e),r=this.subtract(n.sqr()).yt*(.5*t);return n.add(r)},lc.prototype.selfAdd=function(){if(1===arguments.length){if(arguments[0]instanceof lc){var t=arguments[0];return this.selfAdd(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0],n=null,r=null,i=null,s=null,o=null,a=null;return s=(i=this.yt+e)-(o=i-this.yt),r=(a=(s=e-o+(this.yt-s))+this.Lt)+(i-(n=i+a)),this.yt=n+r,this.Lt=r+(n-this.yt),this}}else if(2===arguments.length){var l=arguments[0],h=arguments[1],c=null,u=null,f=null,d=null,p=null,A=null,g=null;d=this.yt+l,u=this.Lt+h,p=d-(A=d-this.yt),f=u-(g=u-this.Lt);var m=(c=d+(A=(p=l-A+(this.yt-p))+u))+(A=(f=h-g+(this.Lt-f))+(A+(d-c))),y=A+(c-m);return this.yt=m,this.Lt=y,this}},lc.prototype.selfMultiply=function(){if(1===arguments.length){if(arguments[0]instanceof lc){var t=arguments[0];return this.selfMultiply(t.yt,t.Lt)}if("number"==typeof arguments[0]){var e=arguments[0];return this.selfMultiply(e,0)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1],i=null,s=null,o=null,a=null,l=null,h=null;i=(l=lc.SPLIT*this.yt)-this.yt,h=lc.SPLIT*n,i=l-i,s=this.yt-i,o=h-n;var c=(l=this.yt*n)+(h=i*(o=h-o)-l+i*(a=n-o)+s*o+s*a+(this.yt*r+this.Lt*n)),u=h+(i=l-c);return this.yt=c,this.Lt=u,this}},lc.prototype.selfSqr=function(){return this.selfMultiply(this)},lc.prototype.floor=function(){if(this.isNaN())return lc.NaN;var t=Math.floor(this.yt),e=0;return t===this.yt&&(e=Math.floor(this.Lt)),new lc(t,e)},lc.prototype.negate=function(){return this.isNaN()?this:new lc(-this.yt,-this.Lt)},lc.prototype.clone=function(){},lc.prototype.multiply=function(){if(arguments[0]instanceof lc){var t=arguments[0];return t.isNaN()?lc.createNaN():lc.copy(this).selfMultiply(t)}if("number"==typeof arguments[0]){var e=arguments[0];return Gh.isNaN(e)?lc.createNaN():lc.copy(this).selfMultiply(e,0)}},lc.prototype.isNaN=function(){return Gh.isNaN(this.yt)},lc.prototype.intValue=function(){return Math.trunc(this.yt)},lc.prototype.toString=function(){var t=lc.magnitude(this.yt);return t>=-3&&t<=20?this.toStandardNotation():this.toSciNotation()},lc.prototype.toStandardNotation=function(){var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!0,e),r=e[0]+1,i=n;if("."===n.charAt(0))i="0"+n;else if(r<0)i="0."+lc.stringOfChar("0",-r)+n;else if(-1===n.indexOf(".")){var s=r-n.length;i=n+lc.stringOfChar("0",s)+".0"}return this.isNegative()?"-"+i:i},lc.prototype.reciprocal=function(){var t,e,n,r,i=null,s=null,o=null,a=null;t=(n=1/this.yt)-(i=(o=lc.SPLIT*n)-(i=o-n)),s=(a=lc.SPLIT*this.yt)-this.yt;var l=n+(o=(1-(r=n*this.yt)-(a=i*(s=a-s)-r+i*(e=this.yt-s)+t*s+t*e)-n*this.Lt)/this.yt);return new lc(l,n-l+o)},lc.prototype.toSciNotation=function(){if(this.isZero())return lc.SCI_NOT_ZERO;var t=this.getSpecialNumberString();if(null!==t)return t;var e=new Array(1).fill(null),n=this.extractSignificantDigits(!1,e),r=lc.SCI_NOT_EXPONENT_CHAR+e[0];if("0"===n.charAt(0))throw new Error("Found leading zero: "+n);var i="";n.length>1&&(i=n.substring(1));var s=n.charAt(0)+"."+i;return this.isNegative()?"-"+s+r:s+r},lc.prototype.abs=function(){return this.isNaN()?lc.NaN:this.isNegative()?this.negate():new lc(this)},lc.prototype.isPositive=function(){return(this.yt>0||0===this.yt)&&this.Lt>0},lc.prototype.lt=function(t){return(this.yt<t.yt||this.yt===t.yt)&&this.Lt<t.Lt},lc.prototype.add=function(){if(arguments[0]instanceof lc){var t=arguments[0];return lc.copy(this).selfAdd(t)}if("number"==typeof arguments[0]){var e=arguments[0];return lc.copy(this).selfAdd(e)}},lc.prototype.init=function(){if(1===arguments.length){if("number"==typeof arguments[0]){var t=arguments[0];this.yt=t,this.Lt=0}else if(arguments[0]instanceof lc){var e=arguments[0];this.yt=e.yt,this.Lt=e.Lt}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.yt=n,this.Lt=r}},lc.prototype.gt=function(t){return(this.yt>t.yt||this.yt===t.yt)&&this.Lt>t.Lt},lc.prototype.isNegative=function(){return(this.yt<0||0===this.yt)&&this.Lt<0},lc.prototype.trunc=function(){return this.isNaN()?lc.NaN:this.isPositive()?this.floor():this.ceil()},lc.prototype.signum=function(){return this.yt>0?1:this.yt<0?-1:this.Lt>0?1:this.Lt<0?-1:0},lc.prototype.interfaces_=function(){return[Yh,Wh,Xh]},lc.prototype.getClass=function(){return lc},lc.sqr=function(t){return lc.valueOf(t).selfMultiply(t)},lc.valueOf=function(){if("string"==typeof arguments[0]){var t=arguments[0];return lc.parse(t)}if("number"==typeof arguments[0]){var e=arguments[0];return new lc(e)}},lc.sqrt=function(t){return lc.valueOf(t).sqrt()},lc.parse=function(t){for(var e=0,n=t.length;ac.isWhitespace(t.charAt(e));)e++;var r=!1;if(e<n){var i=t.charAt(e);"-"!==i&&"+"!==i||(e++,"-"===i&&(r=!0))}for(var s=new lc,o=0,a=0,l=0;!(e>=n);){var h=t.charAt(e);if(e++,ac.isDigit(h)){var c=h-"0";s.selfMultiply(lc.TEN),s.selfAdd(c),o++}else{if("."!==h){if("e"===h||"E"===h){var u=t.substring(e);try{l=oc.parseInt(u)}catch(e){throw e instanceof Error?new Error("Invalid exponent "+u+" in string "+t):e}break}throw new Error("Unexpected character '"+h+"' at position "+e+" in string "+t)}a=o}}var f=s,d=o-a-l;if(0===d)f=s;else if(d>0){var p=lc.TEN.pow(d);f=s.divide(p)}else if(d<0){var A=lc.TEN.pow(-d);f=s.multiply(A)}return r?f.negate():f},lc.createNaN=function(){return new lc(Gh.NaN,Gh.NaN)},lc.copy=function(t){return new lc(t)},lc.magnitude=function(t){var e=Math.abs(t),n=Math.log(e)/Math.log(10),r=Math.trunc(Math.floor(n));return 10*Math.pow(10,r)<=e&&(r+=1),r},lc.stringOfChar=function(t,e){for(var n=new sc,r=0;r<e;r++)n.append(t);return n.toString()},hc.PI.get=function(){return new lc(3.141592653589793,12246467991473532e-32)},hc.TWO_PI.get=function(){return new lc(6.283185307179586,24492935982947064e-32)},hc.PI_2.get=function(){return new lc(1.5707963267948966,6123233995736766e-32)},hc.E.get=function(){return new lc(2.718281828459045,14456468917292502e-32)},hc.NaN.get=function(){return new lc(Gh.NaN,Gh.NaN)},hc.EPS.get=function(){return 123259516440783e-46},hc.SPLIT.get=function(){return 134217729},hc.MAX_PRINT_DIGITS.get=function(){return 32},hc.TEN.get=function(){return lc.valueOf(10)},hc.ONE.get=function(){return lc.valueOf(1)},hc.SCI_NOT_EXPONENT_CHAR.get=function(){return"E"},hc.SCI_NOT_ZERO.get=function(){return"0.0E0"},Object.defineProperties(lc,hc);var cc=function(){},uc={DP_SAFE_EPSILON:{configurable:!0}};cc.prototype.interfaces_=function(){return[]},cc.prototype.getClass=function(){return cc},cc.orientationIndex=function(t,e,n){var r=cc.orientationIndexFilter(t,e,n);if(r<=1)return r;var i=lc.valueOf(e.x).selfAdd(-t.x),s=lc.valueOf(e.y).selfAdd(-t.y),o=lc.valueOf(n.x).selfAdd(-e.x),a=lc.valueOf(n.y).selfAdd(-e.y);return i.selfMultiply(a).selfSubtract(s.selfMultiply(o)).signum()},cc.signOfDet2x2=function(t,e,n,r){return t.multiply(r).selfSubtract(e.multiply(n)).signum()},cc.intersection=function(t,e,n,r){var i=lc.valueOf(r.y).selfSubtract(n.y).selfMultiply(lc.valueOf(e.x).selfSubtract(t.x)),s=lc.valueOf(r.x).selfSubtract(n.x).selfMultiply(lc.valueOf(e.y).selfSubtract(t.y)),o=i.subtract(s),a=lc.valueOf(r.x).selfSubtract(n.x).selfMultiply(lc.valueOf(t.y).selfSubtract(n.y)),l=lc.valueOf(r.y).selfSubtract(n.y).selfMultiply(lc.valueOf(t.x).selfSubtract(n.x)),h=a.subtract(l).selfDivide(o).doubleValue(),c=lc.valueOf(t.x).selfAdd(lc.valueOf(e.x).selfSubtract(t.x).selfMultiply(h)).doubleValue(),u=lc.valueOf(e.x).selfSubtract(t.x).selfMultiply(lc.valueOf(t.y).selfSubtract(n.y)),f=lc.valueOf(e.y).selfSubtract(t.y).selfMultiply(lc.valueOf(t.x).selfSubtract(n.x)),d=u.subtract(f).selfDivide(o).doubleValue(),p=lc.valueOf(n.y).selfAdd(lc.valueOf(r.y).selfSubtract(n.y).selfMultiply(d)).doubleValue();return new Zh(c,p)},cc.orientationIndexFilter=function(t,e,n){var r=null,i=(t.x-n.x)*(e.y-n.y),s=(t.y-n.y)*(e.x-n.x),o=i-s;if(i>0){if(s<=0)return cc.signum(o);r=i+s}else{if(!(i<0))return cc.signum(o);if(s>=0)return cc.signum(o);r=-i-s}var a=cc.DP_SAFE_EPSILON*r;return o>=a||-o>=a?cc.signum(o):2},cc.signum=function(t){return t>0?1:t<0?-1:0},uc.DP_SAFE_EPSILON.get=function(){return 1e-15},Object.defineProperties(cc,uc);var fc=function(){},dc={X:{configurable:!0},Y:{configurable:!0},Z:{configurable:!0},M:{configurable:!0}};dc.X.get=function(){return 0},dc.Y.get=function(){return 1},dc.Z.get=function(){return 2},dc.M.get=function(){return 3},fc.prototype.setOrdinate=function(t,e,n){},fc.prototype.size=function(){},fc.prototype.getOrdinate=function(t,e){},fc.prototype.getCoordinate=function(){},fc.prototype.getCoordinateCopy=function(t){},fc.prototype.getDimension=function(){},fc.prototype.getX=function(t){},fc.prototype.clone=function(){},fc.prototype.expandEnvelope=function(t){},fc.prototype.copy=function(){},fc.prototype.getY=function(t){},fc.prototype.toCoordinateArray=function(){},fc.prototype.interfaces_=function(){return[Xh]},fc.prototype.getClass=function(){return fc},Object.defineProperties(fc,dc);var pc=function(){},Ac=function(t){function e(){t.call(this,"Projective point not representable on the Cartesian plane.")}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(pc),gc=function(){};gc.arraycopy=function(t,e,n,r,i){for(var s=0,o=e;o<e+i;o++)n[r+s]=t[o],s++},gc.getProperty=function(t){return{"line.separator":"\n"}[t]};var mc=function t(){if(this.x=null,this.y=null,this.w=null,0===arguments.length)this.x=0,this.y=0,this.w=1;else if(1===arguments.length){var e=arguments[0];this.x=e.x,this.y=e.y,this.w=1}else if(2===arguments.length){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var n=arguments[0],r=arguments[1];this.x=n,this.y=r,this.w=1}else if(arguments[0]instanceof t&&arguments[1]instanceof t){var i=arguments[0],s=arguments[1];this.x=i.y*s.w-s.y*i.w,this.y=s.x*i.w-i.x*s.w,this.w=i.x*s.y-s.x*i.y}else if(arguments[0]instanceof Zh&&arguments[1]instanceof Zh){var o=arguments[0],a=arguments[1];this.x=o.y-a.y,this.y=a.x-o.x,this.w=o.x*a.y-a.x*o.y}}else if(3===arguments.length){var l=arguments[0],h=arguments[1],c=arguments[2];this.x=l,this.y=h,this.w=c}else if(4===arguments.length){var u=arguments[0],f=arguments[1],d=arguments[2],p=arguments[3],A=u.y-f.y,g=f.x-u.x,m=u.x*f.y-f.x*u.y,y=d.y-p.y,v=p.x-d.x,x=d.x*p.y-p.x*d.y;this.x=g*x-v*m,this.y=y*m-A*x,this.w=A*v-y*g}};mc.prototype.getY=function(){var t=this.y/this.w;if(Gh.isNaN(t)||Gh.isInfinite(t))throw new Ac;return t},mc.prototype.getX=function(){var t=this.x/this.w;if(Gh.isNaN(t)||Gh.isInfinite(t))throw new Ac;return t},mc.prototype.getCoordinate=function(){var t=new Zh;return t.x=this.getX(),t.y=this.getY(),t},mc.prototype.interfaces_=function(){return[]},mc.prototype.getClass=function(){return mc},mc.intersection=function(t,e,n,r){var i=t.y-e.y,s=e.x-t.x,o=t.x*e.y-e.x*t.y,a=n.y-r.y,l=r.x-n.x,h=n.x*r.y-r.x*n.y,c=i*l-a*s,u=(s*h-l*o)/c,f=(a*o-i*h)/c;if(Gh.isNaN(u)||Gh.isInfinite(u)||Gh.isNaN(f)||Gh.isInfinite(f))throw new Ac;return new Zh(u,f)};var yc=function t(){if(this.Tt=null,this.Ot=null,this.Ft=null,this.Ut=null,0===arguments.length)this.init();else if(1===arguments.length){if(arguments[0]instanceof Zh){var e=arguments[0];this.init(e.x,e.x,e.y,e.y)}else if(arguments[0]instanceof t){var n=arguments[0];this.init(n)}}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.init(r.x,i.x,r.y,i.y)}else if(4===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3];this.init(s,o,a,l)}},vc={serialVersionUID:{configurable:!0}};yc.prototype.getArea=function(){return this.getWidth()*this.getHeight()},yc.prototype.equals=function(t){if(!(t instanceof yc))return!1;var e=t;return this.isNull()?e.isNull():this.Ot===e.getMaxX()&&this.Ut===e.getMaxY()&&this.Tt===e.getMinX()&&this.Ft===e.getMinY()},yc.prototype.intersection=function(t){if(this.isNull()||t.isNull()||!this.intersects(t))return new yc;var e=this.Tt>t.Tt?this.Tt:t.Tt,n=this.Ft>t.Ft?this.Ft:t.Ft,r=this.Ot<t.Ot?this.Ot:t.Ot,i=this.Ut<t.Ut?this.Ut:t.Ut;return new yc(e,r,n,i)},yc.prototype.isNull=function(){return this.Ot<this.Tt},yc.prototype.getMaxX=function(){return this.Ot},yc.prototype.covers=function(){if(1===arguments.length){if(arguments[0]instanceof Zh){var t=arguments[0];return this.covers(t.x,t.y)}if(arguments[0]instanceof yc){var e=arguments[0];return!this.isNull()&&!e.isNull()&&e.getMinX()>=this.Tt&&e.getMaxX()<=this.Ot&&e.getMinY()>=this.Ft&&e.getMaxY()<=this.Ut}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return!this.isNull()&&n>=this.Tt&&n<=this.Ot&&r>=this.Ft&&r<=this.Ut}},yc.prototype.intersects=function(){if(1===arguments.length){if(arguments[0]instanceof yc){var t=arguments[0];return!this.isNull()&&!t.isNull()&&!(t.Tt>this.Ot||t.Ot<this.Tt||t.Ft>this.Ut||t.Ut<this.Ft)}if(arguments[0]instanceof Zh){var e=arguments[0];return this.intersects(e.x,e.y)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return!this.isNull()&&!(n>this.Ot||n<this.Tt||r>this.Ut||r<this.Ft)}},yc.prototype.getMinY=function(){return this.Ft},yc.prototype.getMinX=function(){return this.Tt},yc.prototype.expandToInclude=function(){if(1===arguments.length){if(arguments[0]instanceof Zh){var t=arguments[0];this.expandToInclude(t.x,t.y)}else if(arguments[0]instanceof yc){var e=arguments[0];if(e.isNull())return null;this.isNull()?(this.Tt=e.getMinX(),this.Ot=e.getMaxX(),this.Ft=e.getMinY(),this.Ut=e.getMaxY()):(e.Tt<this.Tt&&(this.Tt=e.Tt),e.Ot>this.Ot&&(this.Ot=e.Ot),e.Ft<this.Ft&&(this.Ft=e.Ft),e.Ut>this.Ut&&(this.Ut=e.Ut))}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.isNull()?(this.Tt=n,this.Ot=n,this.Ft=r,this.Ut=r):(n<this.Tt&&(this.Tt=n),n>this.Ot&&(this.Ot=n),r<this.Ft&&(this.Ft=r),r>this.Ut&&(this.Ut=r))}},yc.prototype.minExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t<e?t:e},yc.prototype.getWidth=function(){return this.isNull()?0:this.Ot-this.Tt},yc.prototype.compareTo=function(t){var e=t;return this.isNull()?e.isNull()?0:-1:e.isNull()?1:this.Tt<e.Tt?-1:this.Tt>e.Tt?1:this.Ft<e.Ft?-1:this.Ft>e.Ft?1:this.Ot<e.Ot?-1:this.Ot>e.Ot?1:this.Ut<e.Ut?-1:this.Ut>e.Ut?1:0},yc.prototype.translate=function(t,e){if(this.isNull())return null;this.init(this.getMinX()+t,this.getMaxX()+t,this.getMinY()+e,this.getMaxY()+e)},yc.prototype.toString=function(){return"Env["+this.Tt+" : "+this.Ot+", "+this.Ft+" : "+this.Ut+"]"},yc.prototype.setToNull=function(){this.Tt=0,this.Ot=-1,this.Ft=0,this.Ut=-1},yc.prototype.getHeight=function(){return this.isNull()?0:this.Ut-this.Ft},yc.prototype.maxExtent=function(){if(this.isNull())return 0;var t=this.getWidth(),e=this.getHeight();return t>e?t:e},yc.prototype.expandBy=function(){if(1===arguments.length){var t=arguments[0];this.expandBy(t,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.isNull())return null;this.Tt-=e,this.Ot+=e,this.Ft-=n,this.Ut+=n,(this.Tt>this.Ot||this.Ft>this.Ut)&&this.setToNull()}},yc.prototype.contains=function(){if(1===arguments.length){if(arguments[0]instanceof yc){var t=arguments[0];return this.covers(t)}if(arguments[0]instanceof Zh){var e=arguments[0];return this.covers(e)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return this.covers(n,r)}},yc.prototype.centre=function(){return this.isNull()?null:new Zh((this.getMinX()+this.getMaxX())/2,(this.getMinY()+this.getMaxY())/2)},yc.prototype.init=function(){if(0===arguments.length)this.setToNull();else if(1===arguments.length){if(arguments[0]instanceof Zh){var t=arguments[0];this.init(t.x,t.x,t.y,t.y)}else if(arguments[0]instanceof yc){var e=arguments[0];this.Tt=e.Tt,this.Ot=e.Ot,this.Ft=e.Ft,this.Ut=e.Ut}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.init(n.x,r.x,n.y,r.y)}else if(4===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3];i<s?(this.Tt=i,this.Ot=s):(this.Tt=s,this.Ot=i),o<a?(this.Ft=o,this.Ut=a):(this.Ft=a,this.Ut=o)}},yc.prototype.getMaxY=function(){return this.Ut},yc.prototype.distance=function(t){if(this.intersects(t))return 0;var e=0;this.Ot<t.Tt?e=t.Tt-this.Ot:this.Tt>t.Ot&&(e=this.Tt-t.Ot);var n=0;return this.Ut<t.Ft?n=t.Ft-this.Ut:this.Ft>t.Ut&&(n=this.Ft-t.Ut),0===e?n:0===n?e:Math.sqrt(e*e+n*n)},yc.prototype.hashCode=function(){var t=17;return 37*(t=37*(t=37*(t=37*t+Zh.hashCode(this.Tt))+Zh.hashCode(this.Ot))+Zh.hashCode(this.Ft))+Zh.hashCode(this.Ut)},yc.prototype.interfaces_=function(){return[Wh,Yh]},yc.prototype.getClass=function(){return yc},yc.intersects=function(){if(3===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2];return n.x>=(t.x<e.x?t.x:e.x)&&n.x<=(t.x>e.x?t.x:e.x)&&n.y>=(t.y<e.y?t.y:e.y)&&n.y<=(t.y>e.y?t.y:e.y)}if(4===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2],o=arguments[3],a=Math.min(s.x,o.x),l=Math.max(s.x,o.x),h=Math.min(r.x,i.x),c=Math.max(r.x,i.x);return!(h>l)&&!(c<a)&&(a=Math.min(s.y,o.y),l=Math.max(s.y,o.y),h=Math.min(r.y,i.y),c=Math.max(r.y,i.y),!(h>l)&&!(c<a))}},vc.serialVersionUID.get=function(){return 0x51845cd552189800},Object.defineProperties(yc,vc);var xc={typeStr:/^\s*(\w+)\s*\(\s*(.*)\s*\)\s*$/,emptyTypeStr:/^\s*(\w+)\s*EMPTY\s*$/,spaces:/\s+/,parenComma:/\)\s*,\s*\(/,doubleParenComma:/\)\s*\)\s*,\s*\(\s*\(/,trimParens:/^\s*\(?(.*?)\)?\s*$/},bc=function(t){this.geometryFactory=t||new af};bc.prototype.read=function(t){var e,n,r;t=t.replace(/[\n\r]/g," ");var i=xc.typeStr.exec(t);if(-1!==t.search("EMPTY")&&((i=xc.emptyTypeStr.exec(t))[2]=void 0),i&&(n=i[1].toLowerCase(),r=i[2],_c[n]&&(e=_c[n].apply(this,[r]))),void 0===e)throw new Error("Could not parse WKT "+t);return e},bc.prototype.write=function(t){return this.extractGeometry(t)},bc.prototype.extractGeometry=function(t){var e=t.getGeometryType().toLowerCase();if(!wc[e])return null;var n=e.toUpperCase();return t.isEmpty()?n+" EMPTY":n+"("+wc[e].apply(this,[t])+")"};var wc={coordinate:function(t){return t.x+" "+t.y},point:function(t){return wc.coordinate.call(this,t.Et.Et[0])},multipoint:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+wc.point.apply(this,[t.Nt[n]])+")");return e.join(",")},linestring:function(t){for(var e=[],n=0,r=t.jt.Et.length;n<r;++n)e.push(wc.coordinate.apply(this,[t.jt.Et[n]]));return e.join(",")},linearring:function(t){for(var e=[],n=0,r=t.jt.Et.length;n<r;++n)e.push(wc.coordinate.apply(this,[t.jt.Et[n]]));return e.join(",")},multilinestring:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+wc.linestring.apply(this,[t.Nt[n]])+")");return e.join(",")},polygon:function(t){var e=[];e.push("("+wc.linestring.apply(this,[t.Qt])+")");for(var n=0,r=t.St.length;n<r;++n)e.push("("+wc.linestring.apply(this,[t.St[n]])+")");return e.join(",")},multipolygon:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push("("+wc.polygon.apply(this,[t.Nt[n]])+")");return e.join(",")},geometrycollection:function(t){for(var e=[],n=0,r=t.Nt.length;n<r;++n)e.push(this.extractGeometry(t.Nt[n]));return e.join(",")}},_c={point:function(t){if(void 0===t)return this.geometryFactory.createPoint();var e=t.trim().split(xc.spaces);return this.geometryFactory.createPoint(new Zh(Number.parseFloat(e[0]),Number.parseFloat(e[1])))},multipoint:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiPoint();for(var n=t.trim().split(","),r=[],i=0,s=n.length;i<s;++i)e=n[i].replace(xc.trimParens,"$1"),r.push(_c.point.apply(this,[e]));return this.geometryFactory.createMultiPoint(r)},linestring:function(t){if(void 0===t)return this.geometryFactory.createLineString();for(var e,n=t.trim().split(","),r=[],i=0,s=n.length;i<s;++i)e=n[i].trim().split(xc.spaces),r.push(new Zh(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLineString(r)},linearring:function(t){if(void 0===t)return this.geometryFactory.createLinearRing();for(var e,n=t.trim().split(","),r=[],i=0,s=n.length;i<s;++i)e=n[i].trim().split(xc.spaces),r.push(new Zh(Number.parseFloat(e[0]),Number.parseFloat(e[1])));return this.geometryFactory.createLinearRing(r)},multilinestring:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiLineString();for(var n=t.trim().split(xc.parenComma),r=[],i=0,s=n.length;i<s;++i)e=n[i].replace(xc.trimParens,"$1"),r.push(_c.linestring.apply(this,[e]));return this.geometryFactory.createMultiLineString(r)},polygon:function(t){var e,n,r;if(void 0===t)return this.geometryFactory.createPolygon();for(var i,s=t.trim().split(xc.parenComma),o=[],a=0,l=s.length;a<l;++a)e=s[a].replace(xc.trimParens,"$1"),n=_c.linestring.apply(this,[e]),r=this.geometryFactory.createLinearRing(n.jt),0===a?i=r:o.push(r);return this.geometryFactory.createPolygon(i,o)},multipolygon:function(t){var e;if(void 0===t)return this.geometryFactory.createMultiPolygon();for(var n=t.trim().split(xc.doubleParenComma),r=[],i=0,s=n.length;i<s;++i)e=n[i].replace(xc.trimParens,"$1"),r.push(_c.polygon.apply(this,[e]));return this.geometryFactory.createMultiPolygon(r)},geometrycollection:function(t){if(void 0===t)return this.geometryFactory.createGeometryCollection();for(var e=(t=t.replace(/,\s*([A-Za-z])/g,"|$1")).trim().split("|"),n=[],r=0,i=e.length;r<i;++r)n.push(this.read(e[r]));return this.geometryFactory.createGeometryCollection(n)}},Mc=function(t){this.parser=new bc(t)};Mc.prototype.write=function(t){return this.parser.write(t)},Mc.toLineString=function(t,e){if(2!==arguments.length)throw new Error("Not implemented");return"LINESTRING ( "+t.x+" "+t.y+", "+e.x+" "+e.y+" )"};var Tc=function(t){function e(e){t.call(this,e),this.name="RuntimeException",this.message=e,this.stack=(new t).stack}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(Error),Sc=function(t){function e(){if(t.call(this),0===arguments.length)t.call(this);else if(1===arguments.length){var e=arguments[0];t.call(this,e)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Tc),Ic=function(){};Ic.prototype.interfaces_=function(){return[]},Ic.prototype.getClass=function(){return Ic},Ic.shouldNeverReachHere=function(){if(0===arguments.length)Ic.shouldNeverReachHere(null);else if(1===arguments.length){var t=arguments[0];throw new Sc("Should never reach here"+(null!==t?": "+t:""))}},Ic.isTrue=function(){var t;if(1===arguments.length)Ic.isTrue(arguments[0],null);else if(2===arguments.length&&(t=arguments[1],!arguments[0]))throw null===t?new Sc:new Sc(t)},Ic.equals=function(){var t,e,n;if(2===arguments.length)Ic.equals(t=arguments[0],e=arguments[1],null);else if(3===arguments.length&&(t=arguments[0],n=arguments[2],!(e=arguments[1]).equals(t)))throw new Sc("Expected "+t+" but encountered "+e+(null!==n?": "+n:""))};var Cc=function(){this.Bt=null,this.kt=Array(2).fill().map((function(){return Array(2)})),this.Rt=new Array(2).fill(null),this.Gt=null,this.Yt=null,this.qt=null,this.Vt=null,this.Wt=null,this.Rt[0]=new Zh,this.Rt[1]=new Zh,this.qt=this.Rt[0],this.Vt=this.Rt[1],this.Bt=0},Oc={DONT_INTERSECT:{configurable:!0},DO_INTERSECT:{configurable:!0},COLLINEAR:{configurable:!0},NO_INTERSECTION:{configurable:!0},POINT_INTERSECTION:{configurable:!0},COLLINEAR_INTERSECTION:{configurable:!0}};Cc.prototype.getIndexAlongSegment=function(t,e){return this.computeIntLineIndex(),this.Gt[t][e]},Cc.prototype.getTopologySummary=function(){var t=new sc;return this.isEndPoint()&&t.append(" endpoint"),this.Yt&&t.append(" proper"),this.isCollinear()&&t.append(" collinear"),t.toString()},Cc.prototype.computeIntersection=function(t,e,n,r){this.kt[0][0]=t,this.kt[0][1]=e,this.kt[1][0]=n,this.kt[1][1]=r,this.Bt=this.computeIntersect(t,e,n,r)},Cc.prototype.getIntersectionNum=function(){return this.Bt},Cc.prototype.computeIntLineIndex=function(){if(0===arguments.length)null===this.Gt&&(this.Gt=Array(2).fill().map((function(){return Array(2)})),this.computeIntLineIndex(0),this.computeIntLineIndex(1));else if(1===arguments.length){var t=arguments[0],e=this.getEdgeDistance(t,0),n=this.getEdgeDistance(t,1);e>n?(this.Gt[t][0]=0,this.Gt[t][1]=1):(this.Gt[t][0]=1,this.Gt[t][1]=0)}},Cc.prototype.isProper=function(){return this.hasIntersection()&&this.Yt},Cc.prototype.setPrecisionModel=function(t){this.Wt=t},Cc.prototype.isInteriorIntersection=function(){var t=this;if(0===arguments.length)return!!this.isInteriorIntersection(0)||!!this.isInteriorIntersection(1);if(1===arguments.length){for(var e=arguments[0],n=0;n<this.Bt;n++)if(!t.Rt[n].equals2D(t.kt[e][0])&&!t.Rt[n].equals2D(t.kt[e][1]))return!0;return!1}},Cc.prototype.getIntersection=function(t){return this.Rt[t]},Cc.prototype.isEndPoint=function(){return this.hasIntersection()&&!this.Yt},Cc.prototype.hasIntersection=function(){return this.Bt!==Cc.NO_INTERSECTION},Cc.prototype.getEdgeDistance=function(t,e){return Cc.computeEdgeDistance(this.Rt[e],this.kt[t][0],this.kt[t][1])},Cc.prototype.isCollinear=function(){return this.Bt===Cc.COLLINEAR_INTERSECTION},Cc.prototype.toString=function(){return Mc.toLineString(this.kt[0][0],this.kt[0][1])+" - "+Mc.toLineString(this.kt[1][0],this.kt[1][1])+this.getTopologySummary()},Cc.prototype.getEndpoint=function(t,e){return this.kt[t][e]},Cc.prototype.isIntersection=function(t){for(var e=0;e<this.Bt;e++)if(this.Rt[e].equals2D(t))return!0;return!1},Cc.prototype.getIntersectionAlongSegment=function(t,e){return this.computeIntLineIndex(),this.Rt[this.Gt[t][e]]},Cc.prototype.interfaces_=function(){return[]},Cc.prototype.getClass=function(){return Cc},Cc.computeEdgeDistance=function(t,e,n){var r=Math.abs(n.x-e.x),i=Math.abs(n.y-e.y),s=-1;if(t.equals(e))s=0;else if(t.equals(n))s=r>i?r:i;else{var o=Math.abs(t.x-e.x),a=Math.abs(t.y-e.y);0!==(s=r>i?o:a)||t.equals(e)||(s=Math.max(o,a))}return Ic.isTrue(!(0===s&&!t.equals(e)),"Bad distance calculation"),s},Cc.nonRobustComputeEdgeDistance=function(t,e,n){var r=t.x-e.x,i=t.y-e.y,s=Math.sqrt(r*r+i*i);return Ic.isTrue(!(0===s&&!t.equals(e)),"Invalid distance calculation"),s},Oc.DONT_INTERSECT.get=function(){return 0},Oc.DO_INTERSECT.get=function(){return 1},Oc.COLLINEAR.get=function(){return 2},Oc.NO_INTERSECTION.get=function(){return 0},Oc.POINT_INTERSECTION.get=function(){return 1},Oc.COLLINEAR_INTERSECTION.get=function(){return 2},Object.defineProperties(Cc,Oc);var Ec=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isInSegmentEnvelopes=function(t){var e=new yc(this.kt[0][0],this.kt[0][1]),n=new yc(this.kt[1][0],this.kt[1][1]);return e.contains(t)&&n.contains(t)},e.prototype.computeIntersection=function(){if(3!==arguments.length)return t.prototype.computeIntersection.apply(this,arguments);var e=arguments[0],n=arguments[1],r=arguments[2];if(this.Yt=!1,yc.intersects(n,r,e)&&0===Rc.orientationIndex(n,r,e)&&0===Rc.orientationIndex(r,n,e))return this.Yt=!0,(e.equals(n)||e.equals(r))&&(this.Yt=!1),this.Bt=t.POINT_INTERSECTION,null;this.Bt=t.NO_INTERSECTION},e.prototype.normalizeToMinimum=function(t,e,n,r,i){i.x=this.smallestInAbsValue(t.x,e.x,n.x,r.x),i.y=this.smallestInAbsValue(t.y,e.y,n.y,r.y),t.x-=i.x,t.y-=i.y,e.x-=i.x,e.y-=i.y,n.x-=i.x,n.y-=i.y,r.x-=i.x,r.y-=i.y},e.prototype.safeHCoordinateIntersection=function(t,n,r,i){var s=null;try{s=mc.intersection(t,n,r,i)}catch(o){if(!(o instanceof Ac))throw o;s=e.nearestEndpoint(t,n,r,i)}return s},e.prototype.intersection=function(t,n,r,i){var s=this.intersectionWithNormalization(t,n,r,i);return this.isInSegmentEnvelopes(s)||(s=new Zh(e.nearestEndpoint(t,n,r,i))),null!==this.Wt&&this.Wt.makePrecise(s),s},e.prototype.smallestInAbsValue=function(t,e,n,r){var i=t,s=Math.abs(i);return Math.abs(e)<s&&(i=e,s=Math.abs(e)),Math.abs(n)<s&&(i=n,s=Math.abs(n)),Math.abs(r)<s&&(i=r),i},e.prototype.checkDD=function(t,e,n,r,i){var s=cc.intersection(t,e,n,r),o=this.isInSegmentEnvelopes(s);gc.out.println("DD in env = "+o+"  --------------------- "+s),i.distance(s)>1e-4&&gc.out.println("Distance = "+i.distance(s))},e.prototype.intersectionWithNormalization=function(t,e,n,r){var i=new Zh(t),s=new Zh(e),o=new Zh(n),a=new Zh(r),l=new Zh;this.normalizeToEnvCentre(i,s,o,a,l);var h=this.safeHCoordinateIntersection(i,s,o,a);return h.x+=l.x,h.y+=l.y,h},e.prototype.computeCollinearIntersection=function(e,n,r,i){var s=yc.intersects(e,n,r),o=yc.intersects(e,n,i),a=yc.intersects(r,i,e),l=yc.intersects(r,i,n);return s&&o?(this.Rt[0]=r,this.Rt[1]=i,t.COLLINEAR_INTERSECTION):a&&l?(this.Rt[0]=e,this.Rt[1]=n,t.COLLINEAR_INTERSECTION):s&&a?(this.Rt[0]=r,this.Rt[1]=e,!r.equals(e)||o||l?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):s&&l?(this.Rt[0]=r,this.Rt[1]=n,!r.equals(n)||o||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):o&&a?(this.Rt[0]=i,this.Rt[1]=e,!i.equals(e)||s||l?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):o&&l?(this.Rt[0]=i,this.Rt[1]=n,!i.equals(n)||s||a?t.COLLINEAR_INTERSECTION:t.POINT_INTERSECTION):t.NO_INTERSECTION},e.prototype.normalizeToEnvCentre=function(t,e,n,r,i){var s=t.x<e.x?t.x:e.x,o=t.y<e.y?t.y:e.y,a=t.x>e.x?t.x:e.x,l=t.y>e.y?t.y:e.y,h=n.x<r.x?n.x:r.x,c=n.y<r.y?n.y:r.y,u=n.x>r.x?n.x:r.x,f=n.y>r.y?n.y:r.y,d=((s>h?s:h)+(a<u?a:u))/2,p=((o>c?o:c)+(l<f?l:f))/2;i.x=d,i.y=p,t.x-=i.x,t.y-=i.y,e.x-=i.x,e.y-=i.y,n.x-=i.x,n.y-=i.y,r.x-=i.x,r.y-=i.y},e.prototype.computeIntersect=function(e,n,r,i){if(this.Yt=!1,!yc.intersects(e,n,r,i))return t.NO_INTERSECTION;var s=Rc.orientationIndex(e,n,r),o=Rc.orientationIndex(e,n,i);if(s>0&&o>0||s<0&&o<0)return t.NO_INTERSECTION;var a=Rc.orientationIndex(r,i,e),l=Rc.orientationIndex(r,i,n);return a>0&&l>0||a<0&&l<0?t.NO_INTERSECTION:0===s&&0===o&&0===a&&0===l?this.computeCollinearIntersection(e,n,r,i):(0===s||0===o||0===a||0===l?(this.Yt=!1,e.equals2D(r)||e.equals2D(i)?this.Rt[0]=e:n.equals2D(r)||n.equals2D(i)?this.Rt[0]=n:0===s?this.Rt[0]=new Zh(r):0===o?this.Rt[0]=new Zh(i):0===a?this.Rt[0]=new Zh(e):0===l&&(this.Rt[0]=new Zh(n))):(this.Yt=!0,this.Rt[0]=this.intersection(e,n,r,i)),t.POINT_INTERSECTION)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.nearestEndpoint=function(t,e,n,r){var i=t,s=Rc.distancePointLine(t,n,r),o=Rc.distancePointLine(e,n,r);return o<s&&(s=o,i=e),(o=Rc.distancePointLine(n,t,e))<s&&(s=o,i=n),(o=Rc.distancePointLine(r,t,e))<s&&(s=o,i=r),i},e}(Cc),Pc=function(){};Pc.prototype.interfaces_=function(){return[]},Pc.prototype.getClass=function(){return Pc},Pc.orientationIndex=function(t,e,n){var r=e.x-t.x,i=e.y-t.y,s=n.x-e.x,o=n.y-e.y;return Pc.signOfDet2x2(r,i,s,o)},Pc.signOfDet2x2=function(t,e,n,r){var i=null,s=null,o=null;if(i=1,0===t||0===r)return 0===e||0===n?0:e>0?n>0?-i:i:n>0?i:-i;if(0===e||0===n)return r>0?t>0?i:-i:t>0?-i:i;if(e>0?r>0?e<=r||(i=-i,s=t,t=n,n=s,s=e,e=r,r=s):e<=-r?(i=-i,n=-n,r=-r):(s=t,t=-n,n=s,s=e,e=-r,r=s):r>0?-e<=r?(i=-i,t=-t,e=-e):(s=-t,t=n,n=s,s=-e,e=r,r=s):e>=r?(t=-t,e=-e,n=-n,r=-r):(i=-i,s=-t,t=-n,n=s,s=-e,e=-r,r=s),t>0){if(!(n>0))return i;if(!(t<=n))return i}else{if(n>0)return-i;if(!(t>=n))return-i;i=-i,t=-t,n=-n}for(;;){if((r-=(o=Math.floor(n/t))*e)<0)return-i;if(r>e)return i;if(t>(n-=o*t)+n){if(e<r+r)return i}else{if(e>r+r)return-i;n=t-n,r=e-r,i=-i}if(0===r)return 0===n?0:-i;if(0===n)return i;if((e-=(o=Math.floor(t/n))*r)<0)return i;if(e>r)return-i;if(n>(t-=o*n)+t){if(r<e+e)return-i}else{if(r>e+e)return i;t=n-t,e=r-e,i=-i}if(0===e)return 0===t?0:i;if(0===t)return-i}};var kc=function(){this._t=null,this.Kt=0,this.Ht=!1;var t=arguments[0];this._t=t};kc.prototype.countSegment=function(t,e){if(t.x<this._t.x&&e.x<this._t.x)return null;if(this._t.x===e.x&&this._t.y===e.y)return this.Ht=!0,null;if(t.y===this._t.y&&e.y===this._t.y){var n=t.x,r=e.x;return n>r&&(n=e.x,r=t.x),this._t.x>=n&&this._t.x<=r&&(this.Ht=!0),null}if(t.y>this._t.y&&e.y<=this._t.y||e.y>this._t.y&&t.y<=this._t.y){var i=t.x-this._t.x,s=t.y-this._t.y,o=e.x-this._t.x,a=e.y-this._t.y,l=Pc.signOfDet2x2(i,s,o,a);if(0===l)return this.Ht=!0,null;a<s&&(l=-l),l>0&&this.Kt++}},kc.prototype.isPointInPolygon=function(){return this.getLocation()!==tc.EXTERIOR},kc.prototype.getLocation=function(){return this.Ht?tc.BOUNDARY:this.Kt%2==1?tc.INTERIOR:tc.EXTERIOR},kc.prototype.isOnSegment=function(){return this.Ht},kc.prototype.interfaces_=function(){return[]},kc.prototype.getClass=function(){return kc},kc.locatePointInRing=function(){if(arguments[0]instanceof Zh&&nc(arguments[1],fc)){for(var t=arguments[0],e=arguments[1],n=new kc(t),r=new Zh,i=new Zh,s=1;s<e.size();s++)if(e.getCoordinate(s,r),e.getCoordinate(s-1,i),n.countSegment(r,i),n.isOnSegment())return n.getLocation();return n.getLocation()}if(arguments[0]instanceof Zh&&arguments[1]instanceof Array){for(var o=arguments[0],a=arguments[1],l=new kc(o),h=1;h<a.length;h++){var c=a[h],u=a[h-1];if(l.countSegment(c,u),l.isOnSegment())return l.getLocation()}return l.getLocation()}};var Rc=function(){},Nc={CLOCKWISE:{configurable:!0},RIGHT:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},LEFT:{configurable:!0},COLLINEAR:{configurable:!0},STRAIGHT:{configurable:!0}};Rc.prototype.interfaces_=function(){return[]},Rc.prototype.getClass=function(){return Rc},Rc.orientationIndex=function(t,e,n){return cc.orientationIndex(t,e,n)},Rc.signedArea=function(){if(arguments[0]instanceof Array){var t=arguments[0];if(t.length<3)return 0;for(var e=0,n=t[0].x,r=1;r<t.length-1;r++){var i=t[r].x-n,s=t[r+1].y,o=t[r-1].y;e+=i*(o-s)}return e/2}if(nc(arguments[0],fc)){var a=arguments[0],l=a.size();if(l<3)return 0;var h=new Zh,c=new Zh,u=new Zh;a.getCoordinate(0,c),a.getCoordinate(1,u);var f=c.x;u.x-=f;for(var d=0,p=1;p<l-1;p++)h.y=c.y,c.x=u.x,c.y=u.y,a.getCoordinate(p+1,u),u.x-=f,d+=c.x*(h.y-u.y);return d/2}},Rc.distanceLineLine=function(t,e,n,r){if(t.equals(e))return Rc.distancePointLine(t,n,r);if(n.equals(r))return Rc.distancePointLine(r,t,e);var i=!1;if(yc.intersects(t,e,n,r)){var s=(e.x-t.x)*(r.y-n.y)-(e.y-t.y)*(r.x-n.x);if(0===s)i=!0;else{var o=(t.y-n.y)*(r.x-n.x)-(t.x-n.x)*(r.y-n.y),a=((t.y-n.y)*(e.x-t.x)-(t.x-n.x)*(e.y-t.y))/s,l=o/s;(l<0||l>1||a<0||a>1)&&(i=!0)}}else i=!0;return i?rc.min(Rc.distancePointLine(t,n,r),Rc.distancePointLine(e,n,r),Rc.distancePointLine(n,t,e),Rc.distancePointLine(r,t,e)):0},Rc.isPointInRing=function(t,e){return Rc.locatePointInRing(t,e)!==tc.EXTERIOR},Rc.computeLength=function(t){var e=t.size();if(e<=1)return 0;var n=0,r=new Zh;t.getCoordinate(0,r);for(var i=r.x,s=r.y,o=1;o<e;o++){t.getCoordinate(o,r);var a=r.x,l=r.y,h=a-i,c=l-s;n+=Math.sqrt(h*h+c*c),i=a,s=l}return n},Rc.isCCW=function(t){var e=t.length-1;if(e<3)throw new Vh("Ring has fewer than 4 points, so orientation cannot be determined");for(var n=t[0],r=0,i=1;i<=e;i++){var s=t[i];s.y>n.y&&(n=s,r=i)}var o=r;do{(o-=1)<0&&(o=e)}while(t[o].equals2D(n)&&o!==r);var a=r;do{a=(a+1)%e}while(t[a].equals2D(n)&&a!==r);var l=t[o],h=t[a];if(l.equals2D(n)||h.equals2D(n)||l.equals2D(h))return!1;var c=Rc.computeOrientation(l,n,h),u=!1;return u=0===c?l.x>h.x:c>0,u},Rc.locatePointInRing=function(t,e){return kc.locatePointInRing(t,e)},Rc.distancePointLinePerpendicular=function(t,e,n){var r=(n.x-e.x)*(n.x-e.x)+(n.y-e.y)*(n.y-e.y),i=((e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y))/r;return Math.abs(i)*Math.sqrt(r)},Rc.computeOrientation=function(t,e,n){return Rc.orientationIndex(t,e,n)},Rc.distancePointLine=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(0===e.length)throw new Vh("Line array must contain at least one vertex");for(var n=t.distance(e[0]),r=0;r<e.length-1;r++){var i=Rc.distancePointLine(t,e[r],e[r+1]);i<n&&(n=i)}return n}if(3===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2];if(o.x===a.x&&o.y===a.y)return s.distance(o);var l=(a.x-o.x)*(a.x-o.x)+(a.y-o.y)*(a.y-o.y),h=((s.x-o.x)*(a.x-o.x)+(s.y-o.y)*(a.y-o.y))/l;if(h<=0)return s.distance(o);if(h>=1)return s.distance(a);var c=((o.y-s.y)*(a.x-o.x)-(o.x-s.x)*(a.y-o.y))/l;return Math.abs(c)*Math.sqrt(l)}},Rc.isOnLine=function(t,e){for(var n=new Ec,r=1;r<e.length;r++){var i=e[r-1],s=e[r];if(n.computeIntersection(t,i,s),n.hasIntersection())return!0}return!1},Nc.CLOCKWISE.get=function(){return-1},Nc.RIGHT.get=function(){return Rc.CLOCKWISE},Nc.COUNTERCLOCKWISE.get=function(){return 1},Nc.LEFT.get=function(){return Rc.COUNTERCLOCKWISE},Nc.COLLINEAR.get=function(){return 0},Nc.STRAIGHT.get=function(){return Rc.COLLINEAR},Object.defineProperties(Rc,Nc);var Dc=function(){};Dc.prototype.filter=function(t){},Dc.prototype.interfaces_=function(){return[]},Dc.prototype.getClass=function(){return Dc};var Fc=function(){var t=arguments[0];this.Jt=null,this.Zt=null,this.Xt=null,this.$t=null,this.Zt=t,this.Xt=t.getSRID()},Lc={serialVersionUID:{configurable:!0},SORTINDEX_POINT:{configurable:!0},SORTINDEX_MULTIPOINT:{configurable:!0},SORTINDEX_LINESTRING:{configurable:!0},SORTINDEX_LINEARRING:{configurable:!0},SORTINDEX_MULTILINESTRING:{configurable:!0},SORTINDEX_POLYGON:{configurable:!0},SORTINDEX_MULTIPOLYGON:{configurable:!0},SORTINDEX_GEOMETRYCOLLECTION:{configurable:!0},geometryChangedFilter:{configurable:!0}};Fc.prototype.isGeometryCollection=function(){return this.getSortIndex()===Fc.SORTINDEX_GEOMETRYCOLLECTION},Fc.prototype.getFactory=function(){return this.Zt},Fc.prototype.getGeometryN=function(t){return this},Fc.prototype.getArea=function(){return 0},Fc.prototype.isRectangle=function(){return!1},Fc.prototype.equals=function(){if(arguments[0]instanceof Fc){var t=arguments[0];return null!==t&&this.equalsTopo(t)}if(arguments[0]instanceof Object){var e=arguments[0];if(!(e instanceof Fc))return!1;var n=e;return this.equalsExact(n)}},Fc.prototype.equalsExact=function(t){return this===t||this.equalsExact(t,0)},Fc.prototype.geometryChanged=function(){this.apply(Fc.geometryChangedFilter)},Fc.prototype.geometryChangedAction=function(){this.Jt=null},Fc.prototype.equalsNorm=function(t){return null!==t&&this.norm().equalsExact(t.norm())},Fc.prototype.getLength=function(){return 0},Fc.prototype.getNumGeometries=function(){return 1},Fc.prototype.compareTo=function(){if(1===arguments.length){var t=arguments[0],e=t;return this.getSortIndex()!==e.getSortIndex()?this.getSortIndex()-e.getSortIndex():this.isEmpty()&&e.isEmpty()?0:this.isEmpty()?-1:e.isEmpty()?1:this.compareToSameClass(t)}if(2===arguments.length){var n=arguments[0],r=arguments[1];return this.getSortIndex()!==n.getSortIndex()?this.getSortIndex()-n.getSortIndex():this.isEmpty()&&n.isEmpty()?0:this.isEmpty()?-1:n.isEmpty()?1:this.compareToSameClass(n,r)}},Fc.prototype.getUserData=function(){return this.$t},Fc.prototype.getSRID=function(){return this.Xt},Fc.prototype.getEnvelope=function(){return this.getFactory().toGeometry(this.getEnvelopeInternal())},Fc.prototype.checkNotGeometryCollection=function(t){if(t.getSortIndex()===Fc.SORTINDEX_GEOMETRYCOLLECTION)throw new Vh("This method does not support GeometryCollection arguments")},Fc.prototype.equal=function(t,e,n){return 0===n?t.equals(e):t.distance(e)<=n},Fc.prototype.norm=function(){var t=this.copy();return t.normalize(),t},Fc.prototype.getPrecisionModel=function(){return this.Zt.getPrecisionModel()},Fc.prototype.getEnvelopeInternal=function(){return null===this.Jt&&(this.Jt=this.computeEnvelopeInternal()),new yc(this.Jt)},Fc.prototype.setSRID=function(t){this.Xt=t},Fc.prototype.setUserData=function(t){this.$t=t},Fc.prototype.compare=function(t,e){for(var n=t.iterator(),r=e.iterator();n.hasNext()&&r.hasNext();){var i=n.next(),s=r.next(),o=i.compareTo(s);if(0!==o)return o}return n.hasNext()?1:r.hasNext()?-1:0},Fc.prototype.hashCode=function(){return this.getEnvelopeInternal().hashCode()},Fc.prototype.isGeometryCollectionOrDerived=function(){return this.getSortIndex()===Fc.SORTINDEX_GEOMETRYCOLLECTION||this.getSortIndex()===Fc.SORTINDEX_MULTIPOINT||this.getSortIndex()===Fc.SORTINDEX_MULTILINESTRING||this.getSortIndex()===Fc.SORTINDEX_MULTIPOLYGON},Fc.prototype.interfaces_=function(){return[Xh,Wh,Yh]},Fc.prototype.getClass=function(){return Fc},Fc.hasNonEmptyElements=function(t){for(var e=0;e<t.length;e++)if(!t[e].isEmpty())return!0;return!1},Fc.hasNullElements=function(t){for(var e=0;e<t.length;e++)if(null===t[e])return!0;return!1},Lc.serialVersionUID.get=function(){return 0x799ea46522854c00},Lc.SORTINDEX_POINT.get=function(){return 0},Lc.SORTINDEX_MULTIPOINT.get=function(){return 1},Lc.SORTINDEX_LINESTRING.get=function(){return 2},Lc.SORTINDEX_LINEARRING.get=function(){return 3},Lc.SORTINDEX_MULTILINESTRING.get=function(){return 4},Lc.SORTINDEX_POLYGON.get=function(){return 5},Lc.SORTINDEX_MULTIPOLYGON.get=function(){return 6},Lc.SORTINDEX_GEOMETRYCOLLECTION.get=function(){return 7},Lc.geometryChangedFilter.get=function(){return zc},Object.defineProperties(Fc,Lc);var zc=function(){};zc.interfaces_=function(){return[Dc]},zc.filter=function(t){t.geometryChangedAction()};var Bc=function(){};Bc.prototype.filter=function(t){},Bc.prototype.interfaces_=function(){return[]},Bc.prototype.getClass=function(){return Bc};var Hc=function(){},Uc={Mod2BoundaryNodeRule:{configurable:!0},EndPointBoundaryNodeRule:{configurable:!0},MultiValentEndPointBoundaryNodeRule:{configurable:!0},MonoValentEndPointBoundaryNodeRule:{configurable:!0},MOD2_BOUNDARY_RULE:{configurable:!0},ENDPOINT_BOUNDARY_RULE:{configurable:!0},MULTIVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},MONOVALENT_ENDPOINT_BOUNDARY_RULE:{configurable:!0},OGC_SFS_BOUNDARY_RULE:{configurable:!0}};Hc.prototype.isInBoundary=function(t){},Hc.prototype.interfaces_=function(){return[]},Hc.prototype.getClass=function(){return Hc},Uc.Mod2BoundaryNodeRule.get=function(){return jc},Uc.EndPointBoundaryNodeRule.get=function(){return Vc},Uc.MultiValentEndPointBoundaryNodeRule.get=function(){return Gc},Uc.MonoValentEndPointBoundaryNodeRule.get=function(){return qc},Uc.MOD2_BOUNDARY_RULE.get=function(){return new jc},Uc.ENDPOINT_BOUNDARY_RULE.get=function(){return new Vc},Uc.MULTIVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new Gc},Uc.MONOVALENT_ENDPOINT_BOUNDARY_RULE.get=function(){return new qc},Uc.OGC_SFS_BOUNDARY_RULE.get=function(){return Hc.MOD2_BOUNDARY_RULE},Object.defineProperties(Hc,Uc);var jc=function(){};jc.prototype.isInBoundary=function(t){return t%2==1},jc.prototype.interfaces_=function(){return[Hc]},jc.prototype.getClass=function(){return jc};var Vc=function(){};Vc.prototype.isInBoundary=function(t){return t>0},Vc.prototype.interfaces_=function(){return[Hc]},Vc.prototype.getClass=function(){return Vc};var Gc=function(){};Gc.prototype.isInBoundary=function(t){return t>1},Gc.prototype.interfaces_=function(){return[Hc]},Gc.prototype.getClass=function(){return Gc};var qc=function(){};qc.prototype.isInBoundary=function(t){return 1===t},qc.prototype.interfaces_=function(){return[Hc]},qc.prototype.getClass=function(){return qc};var Wc=function(){};function Xc(t){this.message=t||""}Wc.prototype.add=function(){},Wc.prototype.addAll=function(){},Wc.prototype.isEmpty=function(){},Wc.prototype.iterator=function(){},Wc.prototype.size=function(){},Wc.prototype.toArray=function(){},Wc.prototype.remove=function(){},Xc.prototype=new Error,Xc.prototype.name="IndexOutOfBoundsException";var Qc=function(){};Qc.prototype.hasNext=function(){},Qc.prototype.next=function(){},Qc.prototype.remove=function(){};var Yc=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(){},e.prototype.set=function(){},e.prototype.isEmpty=function(){},e}(Wc);function Zc(t){this.message=t||""}Zc.prototype=new Error,Zc.prototype.name="NoSuchElementException";var Kc=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof Wc&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.ensureCapacity=function(){},e.prototype.interfaces_=function(){return[t,Wc]},e.prototype.add=function(t){return 1===arguments.length?this.array_.push(t):this.array_.splice(arguments[0],arguments[1]),!0},e.prototype.clear=function(){this.array_=[]},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.set=function(t,e){var n=this.array_[t];return this.array_[t]=e,n},e.prototype.iterator=function(){return new Jc(this)},e.prototype.get=function(t){if(t<0||t>=this.size())throw new Xc;return this.array_[t]},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.size=function(){return this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.remove=function(t){for(var e=!1,n=0,r=this.array_.length;n<r;n++)if(this.array_[n]===t){this.array_.splice(n,1),e=!0;break}return e},e}(Yc),Jc=function(t){function e(e){t.call(this),this.arrayList_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.arrayList_.size())throw new Zc;return this.arrayList_.get(this.position_++)},e.prototype.hasNext=function(){return this.position_<this.arrayList_.size()},e.prototype.set=function(t){return this.arrayList_.set(this.position_-1,t)},e.prototype.remove=function(){this.arrayList_.remove(this.arrayList_.get(this.position_))},e}(Qc),$c=function(t){function e(){if(t.call(this),0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.ensureCapacity(e.length),this.add(e,!0)}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.ensureCapacity(n.length),this.add(n,r)}}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={coordArrayType:{configurable:!0}};return n.coordArrayType.get=function(){return new Array(0).fill(null)},e.prototype.getCoordinate=function(t){return this.get(t)},e.prototype.addAll=function(){var e=this;if(2===arguments.length){for(var n=arguments[0],r=arguments[1],i=!1,s=n.iterator();s.hasNext();)e.add(s.next(),r),i=!0;return i}return t.prototype.addAll.apply(this,arguments)},e.prototype.clone=function(){for(var e=t.prototype.clone.call(this),n=0;n<this.size();n++)e.add(n,this.get(n).copy());return e},e.prototype.toCoordinateArray=function(){return this.toArray(e.coordArrayType)},e.prototype.add=function(){var e=this;if(1===arguments.length){var n=arguments[0];t.prototype.add.call(this,n)}else if(2===arguments.length){if(arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var r=arguments[0],i=arguments[1];return this.add(r,i,!0),!0}if(arguments[0]instanceof Zh&&"boolean"==typeof arguments[1]){var s=arguments[0],o=arguments[1];if(!o&&this.size()>=1){var a=this.get(this.size()-1);if(a.equals2D(s))return null}t.prototype.add.call(this,s)}else if(arguments[0]instanceof Object&&"boolean"==typeof arguments[1]){var l=arguments[0],h=arguments[1];return this.add(l,h),!0}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&arguments[0]instanceof Array&&"boolean"==typeof arguments[1]){var c=arguments[0],u=arguments[1],f=arguments[2];if(f)for(var d=0;d<c.length;d++)e.add(c[d],u);else for(var p=c.length-1;p>=0;p--)e.add(c[p],u);return!0}if("boolean"==typeof arguments[2]&&Number.isInteger(arguments[0])&&arguments[1]instanceof Zh){var A=arguments[0],g=arguments[1],m=arguments[2];if(!m){var y=this.size();if(y>0){if(A>0){var v=this.get(A-1);if(v.equals2D(g))return null}if(A<y){var x=this.get(A);if(x.equals2D(g))return null}}}t.prototype.add.call(this,A,g)}}else if(4===arguments.length){var b=arguments[0],w=arguments[1],_=arguments[2],M=arguments[3],T=1;_>M&&(T=-1);for(var S=_;S!==M;S+=T)e.add(b[S],w);return!0}},e.prototype.closeRing=function(){this.size()>0&&this.add(new Zh(this.get(0)),!1)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},Object.defineProperties(e,n),e}(Kc),tu=function(){},eu={ForwardComparator:{configurable:!0},BidirectionalComparator:{configurable:!0},coordArrayType:{configurable:!0}};eu.ForwardComparator.get=function(){return nu},eu.BidirectionalComparator.get=function(){return ru},eu.coordArrayType.get=function(){return new Array(0).fill(null)},tu.prototype.interfaces_=function(){return[]},tu.prototype.getClass=function(){return tu},tu.isRing=function(t){return!(t.length<4)&&!!t[0].equals2D(t[t.length-1])},tu.ptNotInList=function(t,e){for(var n=0;n<t.length;n++){var r=t[n];if(tu.indexOf(r,e)<0)return r}return null},tu.scroll=function(t,e){var n=tu.indexOf(e,t);if(n<0)return null;var r=new Array(t.length).fill(null);gc.arraycopy(t,n,r,0,t.length-n),gc.arraycopy(t,0,r,t.length-n,n),gc.arraycopy(r,0,t,0,t.length)},tu.equals=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];if(t===e)return!0;if(null===t||null===e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;n++)if(!t[n].equals(e[n]))return!1;return!0}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2];if(r===i)return!0;if(null===r||null===i)return!1;if(r.length!==i.length)return!1;for(var o=0;o<r.length;o++)if(0!==s.compare(r[o],i[o]))return!1;return!0}},tu.intersection=function(t,e){for(var n=new $c,r=0;r<t.length;r++)e.intersects(t[r])&&n.add(t[r],!0);return n.toCoordinateArray()},tu.hasRepeatedPoints=function(t){for(var e=1;e<t.length;e++)if(t[e-1].equals(t[e]))return!0;return!1},tu.removeRepeatedPoints=function(t){return tu.hasRepeatedPoints(t)?new $c(t,!1).toCoordinateArray():t},tu.reverse=function(t){for(var e=t.length-1,n=Math.trunc(e/2),r=0;r<=n;r++){var i=t[r];t[r]=t[e-r],t[e-r]=i}},tu.removeNull=function(t){for(var e=0,n=0;n<t.length;n++)null!==t[n]&&e++;var r=new Array(e).fill(null);if(0===e)return r;for(var i=0,s=0;s<t.length;s++)null!==t[s]&&(r[i++]=t[s]);return r},tu.copyDeep=function(){if(1===arguments.length){for(var t=arguments[0],e=new Array(t.length).fill(null),n=0;n<t.length;n++)e[n]=new Zh(t[n]);return e}if(5===arguments.length)for(var r=arguments[0],i=arguments[1],s=arguments[2],o=arguments[3],a=arguments[4],l=0;l<a;l++)s[o+l]=new Zh(r[i+l])},tu.isEqualReversed=function(t,e){for(var n=0;n<t.length;n++){var r=t[n],i=e[t.length-n-1];if(0!==r.compareTo(i))return!1}return!0},tu.envelope=function(t){for(var e=new yc,n=0;n<t.length;n++)e.expandToInclude(t[n]);return e},tu.toCoordinateArray=function(t){return t.toArray(tu.coordArrayType)},tu.atLeastNCoordinatesOrNothing=function(t,e){return e.length>=t?e:[]},tu.indexOf=function(t,e){for(var n=0;n<e.length;n++)if(t.equals(e[n]))return n;return-1},tu.increasingDirection=function(t){for(var e=0;e<Math.trunc(t.length/2);e++){var n=t.length-1-e,r=t[e].compareTo(t[n]);if(0!==r)return r}return 1},tu.compare=function(t,e){for(var n=0;n<t.length&&n<e.length;){var r=t[n].compareTo(e[n]);if(0!==r)return r;n++}return n<e.length?-1:n<t.length?1:0},tu.minCoordinate=function(t){for(var e=null,n=0;n<t.length;n++)(null===e||e.compareTo(t[n])>0)&&(e=t[n]);return e},tu.extract=function(t,e,n){e=rc.clamp(e,0,t.length);var r=(n=rc.clamp(n,-1,t.length))-e+1;n<0&&(r=0),e>=t.length&&(r=0),n<e&&(r=0);var i=new Array(r).fill(null);if(0===r)return i;for(var s=0,o=e;o<=n;o++)i[s++]=t[o];return i},Object.defineProperties(tu,eu);var nu=function(){};nu.prototype.compare=function(t,e){return tu.compare(t,e)},nu.prototype.interfaces_=function(){return[Qh]},nu.prototype.getClass=function(){return nu};var ru=function(){};ru.prototype.compare=function(t,e){var n=t,r=e;if(n.length<r.length)return-1;if(n.length>r.length)return 1;if(0===n.length)return 0;var i=tu.compare(n,r);return tu.isEqualReversed(n,r)?0:i},ru.prototype.OLDcompare=function(t,e){var n=t,r=e;if(n.length<r.length)return-1;if(n.length>r.length)return 1;if(0===n.length)return 0;for(var i=tu.increasingDirection(n),s=tu.increasingDirection(r),o=i>0?0:n.length-1,a=s>0?0:n.length-1,l=0;l<n.length;l++){var h=n[o].compareTo(r[a]);if(0!==h)return h;o+=i,a+=s}return 0},ru.prototype.interfaces_=function(){return[Qh]},ru.prototype.getClass=function(){return ru};var iu=function(){};iu.prototype.get=function(){},iu.prototype.put=function(){},iu.prototype.size=function(){},iu.prototype.values=function(){},iu.prototype.entrySet=function(){};var su=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e}(iu);function ou(t){this.message=t||""}function au(){}ou.prototype=new Error,ou.prototype.name="OperationNotSupported",au.prototype=new Wc,au.prototype.contains=function(){};var lu=function(t){function e(){t.call(this),this.array_=[],arguments[0]instanceof Wc&&this.addAll(arguments[0])}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(this.array_[e]===t)return!0;return!1},e.prototype.add=function(t){return!this.contains(t)&&(this.array_.push(t),!0)},e.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},e.prototype.remove=function(t){throw new Error},e.prototype.size=function(){return this.array_.length},e.prototype.isEmpty=function(){return 0===this.array_.length},e.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},e.prototype.iterator=function(){return new hu(this)},e}(au),hu=function(t){function e(e){t.call(this),this.hashSet_=e,this.position_=0}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.next=function(){if(this.position_===this.hashSet_.size())throw new Zc;return this.hashSet_.array_[this.position_++]},e.prototype.hasNext=function(){return this.position_<this.hashSet_.size()},e.prototype.remove=function(){throw new ou},e}(Qc);function cu(t){return null===t?0:t.color}function uu(t){return null===t?null:t.parent}function fu(t,e){null!==t&&(t.color=e)}function du(t){return null===t?null:t.left}function pu(t){return null===t?null:t.right}function Au(){this.root_=null,this.size_=0}Au.prototype=new su,Au.prototype.get=function(t){for(var e=this.root_;null!==e;){var n=t.compareTo(e.key);if(n<0)e=e.left;else{if(!(n>0))return e.value;e=e.right}}return null},Au.prototype.put=function(t,e){if(null===this.root_)return this.root_={key:t,value:e,left:null,right:null,parent:null,color:0,getValue:function(){return this.value},getKey:function(){return this.key}},this.size_=1,null;var n,r,i=this.root_;do{if(n=i,(r=t.compareTo(i.key))<0)i=i.left;else{if(!(r>0)){var s=i.value;return i.value=e,s}i=i.right}}while(null!==i);var o={key:t,left:null,right:null,value:e,parent:n,color:0,getValue:function(){return this.value},getKey:function(){return this.key}};return r<0?n.left=o:n.right=o,this.fixAfterInsertion(o),this.size_++,null},Au.prototype.fixAfterInsertion=function(t){for(t.color=1;null!=t&&t!==this.root_&&1===t.parent.color;)if(uu(t)===du(uu(uu(t)))){var e=pu(uu(uu(t)));1===cu(e)?(fu(uu(t),0),fu(e,0),fu(uu(uu(t)),1),t=uu(uu(t))):(t===pu(uu(t))&&(t=uu(t),this.rotateLeft(t)),fu(uu(t),0),fu(uu(uu(t)),1),this.rotateRight(uu(uu(t))))}else{var n=du(uu(uu(t)));1===cu(n)?(fu(uu(t),0),fu(n,0),fu(uu(uu(t)),1),t=uu(uu(t))):(t===du(uu(t))&&(t=uu(t),this.rotateRight(t)),fu(uu(t),0),fu(uu(uu(t)),1),this.rotateLeft(uu(uu(t))))}this.root_.color=0},Au.prototype.values=function(){var t=new Kc,e=this.getFirstEntry();if(null!==e)for(t.add(e.value);null!==(e=Au.successor(e));)t.add(e.value);return t},Au.prototype.entrySet=function(){var t=new lu,e=this.getFirstEntry();if(null!==e)for(t.add(e);null!==(e=Au.successor(e));)t.add(e);return t},Au.prototype.rotateLeft=function(t){if(null!=t){var e=t.right;t.right=e.left,null!=e.left&&(e.left.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.left===t?t.parent.left=e:t.parent.right=e,e.left=t,t.parent=e}},Au.prototype.rotateRight=function(t){if(null!=t){var e=t.left;t.left=e.right,null!=e.right&&(e.right.parent=t),e.parent=t.parent,null===t.parent?this.root_=e:t.parent.right===t?t.parent.right=e:t.parent.left=e,e.right=t,t.parent=e}},Au.prototype.getFirstEntry=function(){var t=this.root_;if(null!=t)for(;null!=t.left;)t=t.left;return t},Au.successor=function(t){if(null===t)return null;if(null!==t.right){for(var e=t.right;null!==e.left;)e=e.left;return e}for(var n=t.parent,r=t;null!==n&&r===n.right;)r=n,n=n.parent;return n},Au.prototype.size=function(){return this.size_};var gu=function(){};function mu(){}function yu(){this.array_=[],arguments[0]instanceof Wc&&this.addAll(arguments[0])}gu.prototype.interfaces_=function(){return[]},gu.prototype.getClass=function(){return gu},mu.prototype=new au,yu.prototype=new mu,yu.prototype.contains=function(t){for(var e=0,n=this.array_.length;e<n;e++)if(0===this.array_[e].compareTo(t))return!0;return!1},yu.prototype.add=function(t){if(this.contains(t))return!1;for(var e=0,n=this.array_.length;e<n;e++)if(1===this.array_[e].compareTo(t))return this.array_.splice(e,0,t),!0;return this.array_.push(t),!0},yu.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next());return!0},yu.prototype.remove=function(t){throw new ou},yu.prototype.size=function(){return this.array_.length},yu.prototype.isEmpty=function(){return 0===this.array_.length},yu.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t},yu.prototype.iterator=function(){return new vu(this)};var vu=function(t){this.treeSet_=t,this.position_=0};vu.prototype.next=function(){if(this.position_===this.treeSet_.size())throw new Zc;return this.treeSet_.array_[this.position_++]},vu.prototype.hasNext=function(){return this.position_<this.treeSet_.size()},vu.prototype.remove=function(){throw new ou};var xu=function(){};xu.sort=function(){var t,e,n,r,i=arguments[0];if(1===arguments.length)r=function(t,e){return t.compareTo(e)},i.sort(r);else if(2===arguments.length)n=arguments[1],r=function(t,e){return n.compare(t,e)},i.sort(r);else if(3===arguments.length){(e=i.slice(arguments[1],arguments[2])).sort();var s=i.slice(0,arguments[1]).concat(e,i.slice(arguments[2],i.length));for(i.splice(0,i.length),t=0;t<s.length;t++)i.push(s[t])}else if(4===arguments.length)for(e=i.slice(arguments[1],arguments[2]),n=arguments[3],r=function(t,e){return n.compare(t,e)},e.sort(r),s=i.slice(0,arguments[1]).concat(e,i.slice(arguments[2],i.length)),i.splice(0,i.length),t=0;t<s.length;t++)i.push(s[t])},xu.asList=function(t){for(var e=new Kc,n=0,r=t.length;n<r;n++)e.add(t[n]);return e};var bu=function(){},wu={P:{configurable:!0},L:{configurable:!0},A:{configurable:!0},FALSE:{configurable:!0},TRUE:{configurable:!0},DONTCARE:{configurable:!0},SYM_FALSE:{configurable:!0},SYM_TRUE:{configurable:!0},SYM_DONTCARE:{configurable:!0},SYM_P:{configurable:!0},SYM_L:{configurable:!0},SYM_A:{configurable:!0}};wu.P.get=function(){return 0},wu.L.get=function(){return 1},wu.A.get=function(){return 2},wu.FALSE.get=function(){return-1},wu.TRUE.get=function(){return-2},wu.DONTCARE.get=function(){return-3},wu.SYM_FALSE.get=function(){return"F"},wu.SYM_TRUE.get=function(){return"T"},wu.SYM_DONTCARE.get=function(){return"*"},wu.SYM_P.get=function(){return"0"},wu.SYM_L.get=function(){return"1"},wu.SYM_A.get=function(){return"2"},bu.prototype.interfaces_=function(){return[]},bu.prototype.getClass=function(){return bu},bu.toDimensionSymbol=function(t){switch(t){case bu.FALSE:return bu.SYM_FALSE;case bu.TRUE:return bu.SYM_TRUE;case bu.DONTCARE:return bu.SYM_DONTCARE;case bu.P:return bu.SYM_P;case bu.L:return bu.SYM_L;case bu.A:return bu.SYM_A}throw new Vh("Unknown dimension value: "+t)},bu.toDimensionValue=function(t){switch(ac.toUpperCase(t)){case bu.SYM_FALSE:return bu.FALSE;case bu.SYM_TRUE:return bu.TRUE;case bu.SYM_DONTCARE:return bu.DONTCARE;case bu.SYM_P:return bu.P;case bu.SYM_L:return bu.L;case bu.SYM_A:return bu.A}throw new Vh("Unknown dimension symbol: "+t)},Object.defineProperties(bu,wu);var _u=function(){};_u.prototype.filter=function(t){},_u.prototype.interfaces_=function(){return[]},_u.prototype.getClass=function(){return _u};var Mu=function(){};Mu.prototype.filter=function(t,e){},Mu.prototype.isDone=function(){},Mu.prototype.isGeometryChanged=function(){},Mu.prototype.interfaces_=function(){return[]},Mu.prototype.getClass=function(){return Mu};var Tu=function(t){function e(e,n){if(t.call(this,n),this.Nt=e||[],t.hasNullElements(this.Nt))throw new Vh("geometries must not contain null elements")}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){for(var t=new yc,e=0;e<this.Nt.length;e++)t.expandToInclude(this.Nt[e].getEnvelopeInternal());return t},e.prototype.getGeometryN=function(t){return this.Nt[t]},e.prototype.getSortIndex=function(){return t.SORTINDEX_GEOMETRYCOLLECTION},e.prototype.getCoordinates=function(){for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=0;n<this.Nt.length;n++)for(var r=this.Nt[n].getCoordinates(),i=0;i<r.length;i++)t[++e]=r[i];return t},e.prototype.getArea=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getArea();return t},e.prototype.equalsExact=function(){var e=this;if(2===arguments.length){var n=arguments[0],r=arguments[1];if(!this.isEquivalentClass(n))return!1;var i=n;if(this.Nt.length!==i.Nt.length)return!1;for(var s=0;s<this.Nt.length;s++)if(!e.Nt[s].equalsExact(i.Nt[s],r))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=0;t<this.Nt.length;t++)this.Nt[t].normalize();xu.sort(this.Nt)},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this.Nt[0].getCoordinate()},e.prototype.getBoundaryDimension=function(){for(var t=bu.FALSE,e=0;e<this.Nt.length;e++)t=Math.max(t,this.Nt[e].getBoundaryDimension());return t},e.prototype.getDimension=function(){for(var t=bu.FALSE,e=0;e<this.Nt.length;e++)t=Math.max(t,this.Nt[e].getDimension());return t},e.prototype.getLength=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=0,e=0;e<this.Nt.length;e++)t+=this.Nt[e].getNumPoints();return t},e.prototype.getNumGeometries=function(){return this.Nt.length},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[n]=this.Nt[n].reverse();return this.getFactory().createGeometryCollection(e)},e.prototype.compareToSameClass=function(){var t=this;if(1===arguments.length){var e=arguments[0],n=new yu(xu.asList(this.Nt)),r=new yu(xu.asList(e.Nt));return this.compare(n,r)}if(2===arguments.length){for(var i=arguments[0],s=arguments[1],o=i,a=this.getNumGeometries(),l=o.getNumGeometries(),h=0;h<a&&h<l;){var c=t.getGeometryN(h),u=o.getGeometryN(h),f=c.compareToSameClass(u,s);if(0!==f)return f;h++}return h<a?1:h<l?-1:0}},e.prototype.apply=function(){var t=this;if(nc(arguments[0],Bc))for(var e=arguments[0],n=0;n<this.Nt.length;n++)t.Nt[n].apply(e);else if(nc(arguments[0],Mu)){var r=arguments[0];if(0===this.Nt.length)return null;for(var i=0;i<this.Nt.length&&(t.Nt[i].apply(r),!r.isDone());i++);r.isGeometryChanged()&&this.geometryChanged()}else if(nc(arguments[0],_u)){var s=arguments[0];s.filter(this);for(var o=0;o<this.Nt.length;o++)t.Nt[o].apply(s)}else if(nc(arguments[0],Dc)){var a=arguments[0];a.filter(this);for(var l=0;l<this.Nt.length;l++)t.Nt[l].apply(a)}},e.prototype.getBoundary=function(){return this.checkNotGeometryCollection(this),Ic.shouldNeverReachHere(),null},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e.Nt=new Array(this.Nt.length).fill(null);for(var n=0;n<this.Nt.length;n++)e.Nt[n]=this.Nt[n].clone();return e},e.prototype.getGeometryType=function(){return"GeometryCollection"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.isEmpty=function(){for(var t=0;t<this.Nt.length;t++)if(!this.Nt[t].isEmpty())return!1;return!0},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x4f07bcb1f857d800},Object.defineProperties(e,n),e}(Fc),Su=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return Fc.SORTINDEX_MULTILINESTRING},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?bu.FALSE:0},e.prototype.isClosed=function(){if(this.isEmpty())return!1;for(var t=0;t<this.Nt.length;t++)if(!this.Nt[t].isClosed())return!1;return!0},e.prototype.getDimension=function(){return 1},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[t-1-n]=this.Nt[n].reverse();return this.getFactory().createMultiLineString(e)},e.prototype.getBoundary=function(){return new Iu(this).getBoundary()},e.prototype.getGeometryType=function(){return"MultiLineString"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[gu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x7155d2ab4afa8000},Object.defineProperties(e,n),e}(Tu),Iu=function(){if(this.An=null,this.tn=null,this.nn=null,this.in=null,1===arguments.length){var t=arguments[0],e=Hc.MOD2_BOUNDARY_RULE;this.An=t,this.tn=t.getFactory(),this.nn=e}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.An=n,this.tn=n.getFactory(),this.nn=r}};Iu.prototype.boundaryMultiLineString=function(t){if(this.An.isEmpty())return this.getEmptyMultiPoint();var e=this.computeBoundaryCoordinates(t);return 1===e.length?this.tn.createPoint(e[0]):this.tn.createMultiPointFromCoords(e)},Iu.prototype.getBoundary=function(){return this.An instanceof zu?this.boundaryLineString(this.An):this.An instanceof Su?this.boundaryMultiLineString(this.An):this.An.getBoundary()},Iu.prototype.boundaryLineString=function(t){return this.An.isEmpty()?this.getEmptyMultiPoint():t.isClosed()?this.nn.isInBoundary(2)?t.getStartPoint():this.tn.createMultiPoint():this.tn.createMultiPoint([t.getStartPoint(),t.getEndPoint()])},Iu.prototype.getEmptyMultiPoint=function(){return this.tn.createMultiPoint()},Iu.prototype.computeBoundaryCoordinates=function(t){var e=new Kc;this.in=new Au;for(var n=0;n<t.getNumGeometries();n++){var r=t.getGeometryN(n);0!==r.getNumPoints()&&(this.addEndpoint(r.getCoordinateN(0)),this.addEndpoint(r.getCoordinateN(r.getNumPoints()-1)))}for(var i=this.in.entrySet().iterator();i.hasNext();){var s=i.next(),o=s.getValue().count;this.nn.isInBoundary(o)&&e.add(s.getKey())}return tu.toCoordinateArray(e)},Iu.prototype.addEndpoint=function(t){var e=this.in.get(t);null===e&&(e=new Cu,this.in.put(t,e)),e.count++},Iu.prototype.interfaces_=function(){return[]},Iu.prototype.getClass=function(){return Iu},Iu.getBoundary=function(){if(1===arguments.length){var t=arguments[0],e=new Iu(t);return e.getBoundary()}if(2===arguments.length){var n=arguments[0],r=arguments[1],i=new Iu(n,r);return i.getBoundary()}};var Cu=function(){this.count=null};function Ou(){}function Eu(){}Cu.prototype.interfaces_=function(){return[]},Cu.prototype.getClass=function(){return Cu};var Pu=function(){};function ku(){}function Ru(){}function Nu(){}var Du=function(){},Fu={NEWLINE:{configurable:!0},SIMPLE_ORDINATE_FORMAT:{configurable:!0}};Du.prototype.interfaces_=function(){return[]},Du.prototype.getClass=function(){return Du},Du.chars=function(t,e){for(var n=new Array(e).fill(null),r=0;r<e;r++)n[r]=t;return String(n)},Du.getStackTrace=function(){if(1===arguments.length){var t=arguments[0],e=new ku,n=new Ou;return t.printStackTrace(n),e.toString()}if(2===arguments.length){var r=arguments[0],i=arguments[1],s="";new Eu(Du.getStackTrace(r));for(var o=new Nu,a=0;a<i;a++)try{s+=o.readLine()+Du.NEWLINE}catch(t){if(!(t instanceof Ru))throw t;Ic.shouldNeverReachHere()}return s}},Du.split=function(t,e){for(var n=e.length,r=new Kc,i=""+t,s=i.indexOf(e);s>=0;){var o=i.substring(0,s);r.add(o),s=(i=i.substring(s+n)).indexOf(e)}i.length>0&&r.add(i);for(var a=new Array(r.size()).fill(null),l=0;l<a.length;l++)a[l]=r.get(l);return a},Du.toString=function(){if(1===arguments.length){var t=arguments[0];return Du.SIMPLE_ORDINATE_FORMAT.format(t)}},Du.spaces=function(t){return Du.chars(" ",t)},Fu.NEWLINE.get=function(){return gc.getProperty("line.separator")},Fu.SIMPLE_ORDINATE_FORMAT.get=function(){return new Pu},Object.defineProperties(Du,Fu);var Lu=function(){};Lu.prototype.interfaces_=function(){return[]},Lu.prototype.getClass=function(){return Lu},Lu.copyCoord=function(t,e,n,r){for(var i=Math.min(t.getDimension(),n.getDimension()),s=0;s<i;s++)n.setOrdinate(r,s,t.getOrdinate(e,s))},Lu.isRing=function(t){var e=t.size();return 0===e||!(e<=3)&&t.getOrdinate(0,fc.X)===t.getOrdinate(e-1,fc.X)&&t.getOrdinate(0,fc.Y)===t.getOrdinate(e-1,fc.Y)},Lu.isEqual=function(t,e){var n=t.size();if(n!==e.size())return!1;for(var r=Math.min(t.getDimension(),e.getDimension()),i=0;i<n;i++)for(var s=0;s<r;s++){var o=t.getOrdinate(i,s),a=e.getOrdinate(i,s);if(t.getOrdinate(i,s)!==e.getOrdinate(i,s)&&(!Gh.isNaN(o)||!Gh.isNaN(a)))return!1}return!0},Lu.extend=function(t,e,n){var r=t.create(n,e.getDimension()),i=e.size();if(Lu.copy(e,0,r,0,i),i>0)for(var s=i;s<n;s++)Lu.copy(e,i-1,r,s,1);return r},Lu.reverse=function(t){for(var e=t.size()-1,n=Math.trunc(e/2),r=0;r<=n;r++)Lu.swap(t,r,e-r)},Lu.swap=function(t,e,n){if(e===n)return null;for(var r=0;r<t.getDimension();r++){var i=t.getOrdinate(e,r);t.setOrdinate(e,r,t.getOrdinate(n,r)),t.setOrdinate(n,r,i)}},Lu.copy=function(t,e,n,r,i){for(var s=0;s<i;s++)Lu.copyCoord(t,e+s,n,r+s)},Lu.toString=function(){if(1===arguments.length){var t=arguments[0],e=t.size();if(0===e)return"()";var n=t.getDimension(),r=new sc;r.append("(");for(var i=0;i<e;i++){i>0&&r.append(" ");for(var s=0;s<n;s++)s>0&&r.append(","),r.append(Du.toString(t.getOrdinate(i,s)))}return r.append(")"),r.toString()}},Lu.ensureValidRing=function(t,e){var n=e.size();return 0===n?e:n<=3?Lu.createClosedRing(t,e,4):e.getOrdinate(0,fc.X)===e.getOrdinate(n-1,fc.X)&&e.getOrdinate(0,fc.Y)===e.getOrdinate(n-1,fc.Y)?e:Lu.createClosedRing(t,e,n+1)},Lu.createClosedRing=function(t,e,n){var r=t.create(n,e.getDimension()),i=e.size();Lu.copy(e,0,r,0,i);for(var s=i;s<n;s++)Lu.copy(e,0,r,s,1);return r};var zu=function(t){function e(e,n){t.call(this,n),this.jt=null,this.init(e)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this.isEmpty()?new yc:this.jt.expandEnvelope(new yc)},e.prototype.isRing=function(){return this.isClosed()&&this.isSimple()},e.prototype.getSortIndex=function(){return t.SORTINDEX_LINESTRING},e.prototype.getCoordinates=function(){return this.jt.toCoordinateArray()},e.prototype.equalsExact=function(){var e=this;if(2===arguments.length){var n=arguments[0],r=arguments[1];if(!this.isEquivalentClass(n))return!1;var i=n;if(this.jt.size()!==i.jt.size())return!1;for(var s=0;s<this.jt.size();s++)if(!e.equal(e.jt.getCoordinate(s),i.jt.getCoordinate(s),r))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){for(var t=0;t<Math.trunc(this.jt.size()/2);t++){var e=this.jt.size()-1-t;if(!this.jt.getCoordinate(t).equals(this.jt.getCoordinate(e)))return this.jt.getCoordinate(t).compareTo(this.jt.getCoordinate(e))>0&&Lu.reverse(this.jt),null}},e.prototype.getCoordinate=function(){return this.isEmpty()?null:this.jt.getCoordinate(0)},e.prototype.getBoundaryDimension=function(){return this.isClosed()?bu.FALSE:0},e.prototype.isClosed=function(){return!this.isEmpty()&&this.getCoordinateN(0).equals2D(this.getCoordinateN(this.getNumPoints()-1))},e.prototype.getEndPoint=function(){return this.isEmpty()?null:this.getPointN(this.getNumPoints()-1)},e.prototype.getDimension=function(){return 1},e.prototype.getLength=function(){return Rc.computeLength(this.jt)},e.prototype.getNumPoints=function(){return this.jt.size()},e.prototype.reverse=function(){var t=this.jt.copy();return Lu.reverse(t),this.getFactory().createLineString(t)},e.prototype.compareToSameClass=function(){var t=this;if(1===arguments.length){for(var e=arguments[0],n=e,r=0,i=0;r<this.jt.size()&&i<n.jt.size();){var s=t.jt.getCoordinate(r).compareTo(n.jt.getCoordinate(i));if(0!==s)return s;r++,i++}return r<this.jt.size()?1:i<n.jt.size()?-1:0}if(2===arguments.length){var o=arguments[0],a=arguments[1],l=o;return a.compare(this.jt,l.jt)}},e.prototype.apply=function(){var t=this;if(nc(arguments[0],Bc))for(var e=arguments[0],n=0;n<this.jt.size();n++)e.filter(t.jt.getCoordinate(n));else if(nc(arguments[0],Mu)){var r=arguments[0];if(0===this.jt.size())return null;for(var i=0;i<this.jt.size()&&(r.filter(t.jt,i),!r.isDone());i++);r.isGeometryChanged()&&this.geometryChanged()}else if(nc(arguments[0],_u)){var s=arguments[0];s.filter(this)}else if(nc(arguments[0],Dc)){var o=arguments[0];o.filter(this)}},e.prototype.getBoundary=function(){return new Iu(this).getBoundary()},e.prototype.isEquivalentClass=function(t){return t instanceof e},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e.jt=this.jt.clone(),e},e.prototype.getCoordinateN=function(t){return this.jt.getCoordinate(t)},e.prototype.getGeometryType=function(){return"LineString"},e.prototype.copy=function(){return new e(this.jt.copy(),this.Zt)},e.prototype.getCoordinateSequence=function(){return this.jt},e.prototype.isEmpty=function(){return 0===this.jt.size()},e.prototype.init=function(t){if(null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),1===t.size())throw new Vh("Invalid number of points in LineString (found "+t.size()+" - must be 0 or >= 2)");this.jt=t},e.prototype.isCoordinate=function(t){for(var e=0;e<this.jt.size();e++)if(this.jt.getCoordinate(e).equals(t))return!0;return!1},e.prototype.getStartPoint=function(){return this.isEmpty()?null:this.getPointN(0)},e.prototype.getPointN=function(t){return this.getFactory().createPoint(this.jt.getCoordinate(t))},e.prototype.interfaces_=function(){return[gu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x2b2b51ba435c8e00},Object.defineProperties(e,n),e}(Fc),Bu=function(){};Bu.prototype.interfaces_=function(){return[]},Bu.prototype.getClass=function(){return Bu};var Hu=function(t){function e(e,n){t.call(this,n),this.Et=e||null,this.init(this.Et)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){if(this.isEmpty())return new yc;var t=new yc;return t.expandToInclude(this.Et.getX(0),this.Et.getY(0)),t},e.prototype.getSortIndex=function(){return t.SORTINDEX_POINT},e.prototype.getCoordinates=function(){return this.isEmpty()?[]:[this.getCoordinate()]},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&(!(!this.isEmpty()||!e.isEmpty())||this.isEmpty()===e.isEmpty()&&this.equal(e.getCoordinate(),this.getCoordinate(),n))}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){},e.prototype.getCoordinate=function(){return 0!==this.Et.size()?this.Et.getCoordinate(0):null},e.prototype.getBoundaryDimension=function(){return bu.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getNumPoints=function(){return this.isEmpty()?0:1},e.prototype.reverse=function(){return this.copy()},e.prototype.getX=function(){if(null===this.getCoordinate())throw new Error("getX called on empty Point");return this.getCoordinate().x},e.prototype.compareToSameClass=function(){if(1===arguments.length){var t=arguments[0],e=t;return this.getCoordinate().compareTo(e.getCoordinate())}if(2===arguments.length){var n=arguments[0],r=arguments[1],i=n;return r.compare(this.Et,i.Et)}},e.prototype.apply=function(){if(nc(arguments[0],Bc)){var t=arguments[0];if(this.isEmpty())return null;t.filter(this.getCoordinate())}else if(nc(arguments[0],Mu)){var e=arguments[0];if(this.isEmpty())return null;e.filter(this.Et,0),e.isGeometryChanged()&&this.geometryChanged()}else if(nc(arguments[0],_u)){var n=arguments[0];n.filter(this)}else if(nc(arguments[0],Dc)){var r=arguments[0];r.filter(this)}},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);return e.Et=this.Et.clone(),e},e.prototype.getGeometryType=function(){return"Point"},e.prototype.copy=function(){return new e(this.Et.copy(),this.Zt)},e.prototype.getCoordinateSequence=function(){return this.Et},e.prototype.getY=function(){if(null===this.getCoordinate())throw new Error("getY called on empty Point");return this.getCoordinate().y},e.prototype.isEmpty=function(){return 0===this.Et.size()},e.prototype.init=function(t){null===t&&(t=this.getFactory().getCoordinateSequenceFactory().create([])),Ic.isTrue(t.size()<=1),this.Et=t},e.prototype.isSimple=function(){return!0},e.prototype.interfaces_=function(){return[Bu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return 0x44077bad161cbc00},Object.defineProperties(e,n),e}(Fc),Uu=function(){};Uu.prototype.interfaces_=function(){return[]},Uu.prototype.getClass=function(){return Uu};var ju=function(t){function e(e,n,r){if(t.call(this,r),this.Qt=null,this.St=null,null===e&&(e=this.getFactory().createLinearRing()),null===n&&(n=[]),t.hasNullElements(n))throw new Vh("holes must not contain null elements");if(e.isEmpty()&&t.hasNonEmptyElements(n))throw new Vh("shell is empty but holes are not");this.Qt=e,this.St=n}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.computeEnvelopeInternal=function(){return this.Qt.getEnvelopeInternal()},e.prototype.getSortIndex=function(){return t.SORTINDEX_POLYGON},e.prototype.getCoordinates=function(){if(this.isEmpty())return[];for(var t=new Array(this.getNumPoints()).fill(null),e=-1,n=this.Qt.getCoordinates(),r=0;r<n.length;r++)t[++e]=n[r];for(var i=0;i<this.St.length;i++)for(var s=this.St[i].getCoordinates(),o=0;o<s.length;o++)t[++e]=s[o];return t},e.prototype.getArea=function(){var t=0;t+=Math.abs(Rc.signedArea(this.Qt.getCoordinateSequence()));for(var e=0;e<this.St.length;e++)t-=Math.abs(Rc.signedArea(this.St[e].getCoordinateSequence()));return t},e.prototype.isRectangle=function(){if(0!==this.getNumInteriorRing())return!1;if(null===this.Qt)return!1;if(5!==this.Qt.getNumPoints())return!1;for(var t=this.Qt.getCoordinateSequence(),e=this.getEnvelopeInternal(),n=0;n<5;n++){var r=t.getX(n);if(r!==e.getMinX()&&r!==e.getMaxX())return!1;var i=t.getY(n);if(i!==e.getMinY()&&i!==e.getMaxY())return!1}for(var s=t.getX(0),o=t.getY(0),a=1;a<=4;a++){var l=t.getX(a),h=t.getY(a);if(l!==s===(h!==o))return!1;s=l,o=h}return!0},e.prototype.equalsExact=function(){var e=this;if(2===arguments.length){var n=arguments[0],r=arguments[1];if(!this.isEquivalentClass(n))return!1;var i=n,s=this.Qt,o=i.Qt;if(!s.equalsExact(o,r))return!1;if(this.St.length!==i.St.length)return!1;for(var a=0;a<this.St.length;a++)if(!e.St[a].equalsExact(i.St[a],r))return!1;return!0}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.normalize=function(){var t=this;if(0===arguments.length){this.normalize(this.Qt,!0);for(var e=0;e<this.St.length;e++)t.normalize(t.St[e],!1);xu.sort(this.St)}else if(2===arguments.length){var n=arguments[0],r=arguments[1];if(n.isEmpty())return null;var i=new Array(n.getCoordinates().length-1).fill(null);gc.arraycopy(n.getCoordinates(),0,i,0,i.length);var s=tu.minCoordinate(n.getCoordinates());tu.scroll(i,s),gc.arraycopy(i,0,n.getCoordinates(),0,i.length),n.getCoordinates()[i.length]=i[0],Rc.isCCW(n.getCoordinates())===r&&tu.reverse(n.getCoordinates())}},e.prototype.getCoordinate=function(){return this.Qt.getCoordinate()},e.prototype.getNumInteriorRing=function(){return this.St.length},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.getLength=function(){var t=0;t+=this.Qt.getLength();for(var e=0;e<this.St.length;e++)t+=this.St[e].getLength();return t},e.prototype.getNumPoints=function(){for(var t=this.Qt.getNumPoints(),e=0;e<this.St.length;e++)t+=this.St[e].getNumPoints();return t},e.prototype.reverse=function(){var t=this.copy();t.Qt=this.Qt.copy().reverse(),t.St=new Array(this.St.length).fill(null);for(var e=0;e<this.St.length;e++)t.St[e]=this.St[e].copy().reverse();return t},e.prototype.convexHull=function(){return this.getExteriorRing().convexHull()},e.prototype.compareToSameClass=function(){var t=this;if(1===arguments.length){var e=arguments[0],n=this.Qt,r=e.Qt;return n.compareToSameClass(r)}if(2===arguments.length){var i=arguments[0],s=arguments[1],o=i,a=this.Qt,l=o.Qt,h=a.compareToSameClass(l,s);if(0!==h)return h;for(var c=this.getNumInteriorRing(),u=o.getNumInteriorRing(),f=0;f<c&&f<u;){var d=t.getInteriorRingN(f),p=o.getInteriorRingN(f),A=d.compareToSameClass(p,s);if(0!==A)return A;f++}return f<c?1:f<u?-1:0}},e.prototype.apply=function(t){if(nc(t,Bc)){this.Qt.apply(t);for(var e=0;e<this.St.length;e++)this.St[e].apply(t)}else if(nc(t,Mu)){if(this.Qt.apply(t),!t.isDone())for(var n=0;n<this.St.length&&(this.St[n].apply(t),!t.isDone());n++);t.isGeometryChanged()&&this.geometryChanged()}else if(nc(t,_u))t.filter(this);else if(nc(t,Dc)){t.filter(this),this.Qt.apply(t);for(var r=0;r<this.St.length;r++)this.St[r].apply(t)}},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();var t=new Array(this.St.length+1).fill(null);t[0]=this.Qt;for(var e=0;e<this.St.length;e++)t[e+1]=this.St[e];return t.length<=1?this.getFactory().createLinearRing(t[0].getCoordinateSequence()):this.getFactory().createMultiLineString(t)},e.prototype.clone=function(){var e=t.prototype.clone.call(this);e.Qt=this.Qt.clone(),e.St=new Array(this.St.length).fill(null);for(var n=0;n<this.St.length;n++)e.St[n]=this.St[n].clone();return e},e.prototype.getGeometryType=function(){return"Polygon"},e.prototype.copy=function(){for(var t=this.Qt.copy(),n=new Array(this.St.length).fill(null),r=0;r<n.length;r++)n[r]=this.St[r].copy();return new e(t,n,this.Zt)},e.prototype.getExteriorRing=function(){return this.Qt},e.prototype.isEmpty=function(){return this.Qt.isEmpty()},e.prototype.getInteriorRingN=function(t){return this.St[t]},e.prototype.interfaces_=function(){return[Uu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x307ffefd8dc97200},Object.defineProperties(e,n),e}(Fc),Vu=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return Fc.SORTINDEX_MULTIPOINT},e.prototype.isValid=function(){return!0},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getCoordinate=function(){if(1===arguments.length){var e=arguments[0];return this.Nt[e].getCoordinate()}return t.prototype.getCoordinate.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return bu.FALSE},e.prototype.getDimension=function(){return 0},e.prototype.getBoundary=function(){return this.getFactory().createGeometryCollection(null)},e.prototype.getGeometryType=function(){return"MultiPoint"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[Bu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x6fb1ed4162e0fc00},Object.defineProperties(e,n),e}(Tu),Gu=function(t){function e(e,n){e instanceof Zh&&n instanceof af&&(e=n.getCoordinateSequenceFactory().create(e)),t.call(this,e,n),this.validateConstruction()}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={MINIMUM_VALID_SIZE:{configurable:!0},serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return Fc.SORTINDEX_LINEARRING},e.prototype.getBoundaryDimension=function(){return bu.FALSE},e.prototype.isClosed=function(){return!!this.isEmpty()||t.prototype.isClosed.call(this)},e.prototype.reverse=function(){var t=this.jt.copy();return Lu.reverse(t),this.getFactory().createLinearRing(t)},e.prototype.validateConstruction=function(){if(!this.isEmpty()&&!t.prototype.isClosed.call(this))throw new Vh("Points of LinearRing do not form a closed linestring");if(this.getCoordinateSequence().size()>=1&&this.getCoordinateSequence().size()<e.MINIMUM_VALID_SIZE)throw new Vh("Invalid number of points in LinearRing (found "+this.getCoordinateSequence().size()+" - must be 0 or >= 4)")},e.prototype.getGeometryType=function(){return"LinearRing"},e.prototype.copy=function(){return new e(this.jt.copy(),this.Zt)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.MINIMUM_VALID_SIZE.get=function(){return 4},n.serialVersionUID.get=function(){return-0x3b229e262367a600},Object.defineProperties(e,n),e}(zu),qu=function(t){function e(){t.apply(this,arguments)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={serialVersionUID:{configurable:!0}};return e.prototype.getSortIndex=function(){return Fc.SORTINDEX_MULTIPOLYGON},e.prototype.equalsExact=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return!!this.isEquivalentClass(e)&&t.prototype.equalsExact.call(this,e,n)}return t.prototype.equalsExact.apply(this,arguments)},e.prototype.getBoundaryDimension=function(){return 1},e.prototype.getDimension=function(){return 2},e.prototype.reverse=function(){for(var t=this.Nt.length,e=new Array(t).fill(null),n=0;n<this.Nt.length;n++)e[n]=this.Nt[n].reverse();return this.getFactory().createMultiPolygon(e)},e.prototype.getBoundary=function(){if(this.isEmpty())return this.getFactory().createMultiLineString();for(var t=new Kc,e=0;e<this.Nt.length;e++)for(var n=this.Nt[e].getBoundary(),r=0;r<n.getNumGeometries();r++)t.add(n.getGeometryN(r));var i=new Array(t.size()).fill(null);return this.getFactory().createMultiLineString(t.toArray(i))},e.prototype.getGeometryType=function(){return"MultiPolygon"},e.prototype.copy=function(){for(var t=new Array(this.Nt.length).fill(null),n=0;n<t.length;n++)t[n]=this.Nt[n].copy();return new e(t,this.Zt)},e.prototype.interfaces_=function(){return[Uu]},e.prototype.getClass=function(){return e},n.serialVersionUID.get=function(){return-0x7a5aa1369171980},Object.defineProperties(e,n),e}(Tu),Wu=function(t){this.Zt=t||null,this.rn=!1},Xu={NoOpGeometryOperation:{configurable:!0},CoordinateOperation:{configurable:!0},CoordinateSequenceOperation:{configurable:!0}};Wu.prototype.setCopyUserData=function(t){this.rn=t},Wu.prototype.edit=function(t,e){if(null===t)return null;var n=this.editInternal(t,e);return this.rn&&n.setUserData(t.getUserData()),n},Wu.prototype.editInternal=function(t,e){return null===this.Zt&&(this.Zt=t.getFactory()),t instanceof Tu?this.editGeometryCollection(t,e):t instanceof ju?this.editPolygon(t,e):t instanceof Hu||t instanceof zu?e.edit(t,this.Zt):(Ic.shouldNeverReachHere("Unsupported Geometry class: "+t.getClass().getName()),null)},Wu.prototype.editGeometryCollection=function(t,e){for(var n=e.edit(t,this.Zt),r=new Kc,i=0;i<n.getNumGeometries();i++){var s=this.edit(n.getGeometryN(i),e);null===s||s.isEmpty()||r.add(s)}return n.getClass()===Vu?this.Zt.createMultiPoint(r.toArray([])):n.getClass()===Su?this.Zt.createMultiLineString(r.toArray([])):n.getClass()===qu?this.Zt.createMultiPolygon(r.toArray([])):this.Zt.createGeometryCollection(r.toArray([]))},Wu.prototype.editPolygon=function(t,e){var n=e.edit(t,this.Zt);if(null===n&&(n=this.Zt.createPolygon(null)),n.isEmpty())return n;var r=this.edit(n.getExteriorRing(),e);if(null===r||r.isEmpty())return this.Zt.createPolygon();for(var i=new Kc,s=0;s<n.getNumInteriorRing();s++){var o=this.edit(n.getInteriorRingN(s),e);null===o||o.isEmpty()||i.add(o)}return this.Zt.createPolygon(r,i.toArray([]))},Wu.prototype.interfaces_=function(){return[]},Wu.prototype.getClass=function(){return Wu},Wu.GeometryEditorOperation=function(){},Xu.NoOpGeometryOperation.get=function(){return Qu},Xu.CoordinateOperation.get=function(){return Yu},Xu.CoordinateSequenceOperation.get=function(){return Zu},Object.defineProperties(Wu,Xu);var Qu=function(){};Qu.prototype.edit=function(t,e){return t},Qu.prototype.interfaces_=function(){return[Wu.GeometryEditorOperation]},Qu.prototype.getClass=function(){return Qu};var Yu=function(){};Yu.prototype.edit=function(t,e){var n=this.editCoordinates(t.getCoordinates(),t);return null===n?t:t instanceof Gu?e.createLinearRing(n):t instanceof zu?e.createLineString(n):t instanceof Hu?n.length>0?e.createPoint(n[0]):e.createPoint():t},Yu.prototype.interfaces_=function(){return[Wu.GeometryEditorOperation]},Yu.prototype.getClass=function(){return Yu};var Zu=function(){};Zu.prototype.edit=function(t,e){return t instanceof Gu?e.createLinearRing(this.edit(t.getCoordinateSequence(),t)):t instanceof zu?e.createLineString(this.edit(t.getCoordinateSequence(),t)):t instanceof Hu?e.createPoint(this.edit(t.getCoordinateSequence(),t)):t},Zu.prototype.interfaces_=function(){return[Wu.GeometryEditorOperation]},Zu.prototype.getClass=function(){return Zu};var Ku=function(){var t=this;if(this.en=3,this.Et=null,1===arguments.length){if(arguments[0]instanceof Array)this.Et=arguments[0],this.en=3;else if(Number.isInteger(arguments[0])){var e=arguments[0];this.Et=new Array(e).fill(null);for(var n=0;n<e;n++)t.Et[n]=new Zh}else if(nc(arguments[0],fc)){var r=arguments[0];if(null===r)return this.Et=new Array(0).fill(null),null;this.en=r.getDimension(),this.Et=new Array(r.size()).fill(null);for(var i=0;i<this.Et.length;i++)t.Et[i]=r.getCoordinateCopy(i)}}else if(2===arguments.length)if(arguments[0]instanceof Array&&Number.isInteger(arguments[1])){var s=arguments[0],o=arguments[1];this.Et=s,this.en=o,null===s&&(this.Et=new Array(0).fill(null))}else if(Number.isInteger(arguments[0])&&Number.isInteger(arguments[1])){var a=arguments[0],l=arguments[1];this.Et=new Array(a).fill(null),this.en=l;for(var h=0;h<a;h++)t.Et[h]=new Zh}},Ju={serialVersionUID:{configurable:!0}};Ku.prototype.setOrdinate=function(t,e,n){switch(e){case fc.X:this.Et[t].x=n;break;case fc.Y:this.Et[t].y=n;break;case fc.Z:this.Et[t].z=n;break;default:throw new Vh("invalid ordinateIndex")}},Ku.prototype.size=function(){return this.Et.length},Ku.prototype.getOrdinate=function(t,e){switch(e){case fc.X:return this.Et[t].x;case fc.Y:return this.Et[t].y;case fc.Z:return this.Et[t].z}return Gh.NaN},Ku.prototype.getCoordinate=function(){if(1===arguments.length){var t=arguments[0];return this.Et[t]}if(2===arguments.length){var e=arguments[0],n=arguments[1];n.x=this.Et[e].x,n.y=this.Et[e].y,n.z=this.Et[e].z}},Ku.prototype.getCoordinateCopy=function(t){return new Zh(this.Et[t])},Ku.prototype.getDimension=function(){return this.en},Ku.prototype.getX=function(t){return this.Et[t].x},Ku.prototype.clone=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this.Et.length;e++)t[e]=this.Et[e].clone();return new Ku(t,this.en)},Ku.prototype.expandEnvelope=function(t){for(var e=0;e<this.Et.length;e++)t.expandToInclude(this.Et[e]);return t},Ku.prototype.copy=function(){for(var t=new Array(this.size()).fill(null),e=0;e<this.Et.length;e++)t[e]=this.Et[e].copy();return new Ku(t,this.en)},Ku.prototype.toString=function(){if(this.Et.length>0){var t=new sc(17*this.Et.length);t.append("("),t.append(this.Et[0]);for(var e=1;e<this.Et.length;e++)t.append(", "),t.append(this.Et[e]);return t.append(")"),t.toString()}return"()"},Ku.prototype.getY=function(t){return this.Et[t].y},Ku.prototype.toCoordinateArray=function(){return this.Et},Ku.prototype.interfaces_=function(){return[fc,Yh]},Ku.prototype.getClass=function(){return Ku},Ju.serialVersionUID.get=function(){return-0xcb44a778db18e00},Object.defineProperties(Ku,Ju);var $u=function(){},tf={serialVersionUID:{configurable:!0},instanceObject:{configurable:!0}};$u.prototype.readResolve=function(){return $u.instance()},$u.prototype.create=function(){if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return new Ku(t)}if(nc(arguments[0],fc)){var e=arguments[0];return new Ku(e)}}else if(2===arguments.length){var n=arguments[0],r=arguments[1];return r>3&&(r=3),r<2?new Ku(n):new Ku(n,r)}},$u.prototype.interfaces_=function(){return[$h,Yh]},$u.prototype.getClass=function(){return $u},$u.instance=function(){return $u.instanceObject},tf.serialVersionUID.get=function(){return-0x38e49fa6cf6f2e00},tf.instanceObject.get=function(){return new $u},Object.defineProperties($u,tf);var ef=function(t){function e(){t.call(this),this.map_=new Map}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.get=function(t){return this.map_.get(t)||null},e.prototype.put=function(t,e){return this.map_.set(t,e),e},e.prototype.values=function(){for(var t=new Kc,e=this.map_.values(),n=e.next();!n.done;)t.add(n.value),n=e.next();return t},e.prototype.entrySet=function(){var t=new lu;return this.map_.entries().forEach((function(e){return t.add(e)})),t},e.prototype.size=function(){return this.map_.size()},e}(iu),nf=function t(){if(this.sn=null,this.xA=null,0===arguments.length)this.sn=t.FLOATING;else if(1===arguments.length)if(arguments[0]instanceof sf){var e=arguments[0];this.sn=e,e===t.FIXED&&this.setScale(1)}else if("number"==typeof arguments[0]){var n=arguments[0];this.sn=t.FIXED,this.setScale(n)}else if(arguments[0]instanceof t){var r=arguments[0];this.sn=r.sn,this.xA=r.xA}},rf={serialVersionUID:{configurable:!0},maximumPreciseValue:{configurable:!0}};nf.prototype.equals=function(t){if(!(t instanceof nf))return!1;var e=t;return this.sn===e.sn&&this.xA===e.xA},nf.prototype.compareTo=function(t){var e=t,n=this.getMaximumSignificantDigits(),r=e.getMaximumSignificantDigits();return new oc(n).compareTo(new oc(r))},nf.prototype.getScale=function(){return this.xA},nf.prototype.isFloating=function(){return this.sn===nf.FLOATING||this.sn===nf.FLOATING_SINGLE},nf.prototype.getType=function(){return this.sn},nf.prototype.toString=function(){var t="UNKNOWN";return this.sn===nf.FLOATING?t="Floating":this.sn===nf.FLOATING_SINGLE?t="Floating-Single":this.sn===nf.FIXED&&(t="Fixed (Scale="+this.getScale()+")"),t},nf.prototype.makePrecise=function(){if("number"==typeof arguments[0]){var t=arguments[0];return Gh.isNaN(t)||this.sn===nf.FLOATING_SINGLE?t:this.sn===nf.FIXED?Math.round(t*this.xA)/this.xA:t}if(arguments[0]instanceof Zh){var e=arguments[0];if(this.sn===nf.FLOATING)return null;e.x=this.makePrecise(e.x),e.y=this.makePrecise(e.y)}},nf.prototype.getMaximumSignificantDigits=function(){var t=16;return this.sn===nf.FLOATING?t=16:this.sn===nf.FLOATING_SINGLE?t=6:this.sn===nf.FIXED&&(t=1+Math.trunc(Math.ceil(Math.log(this.getScale())/Math.log(10)))),t},nf.prototype.setScale=function(t){this.xA=Math.abs(t)},nf.prototype.interfaces_=function(){return[Yh,Wh]},nf.prototype.getClass=function(){return nf},nf.mostPrecise=function(t,e){return t.compareTo(e)>=0?t:e},rf.serialVersionUID.get=function(){return 0x6bee6404e9a25c00},rf.maximumPreciseValue.get=function(){return 9007199254740992},Object.defineProperties(nf,rf);var sf=function t(e){this.un=e||null,t.nameToTypeMap.put(e,this)},of={serialVersionUID:{configurable:!0},nameToTypeMap:{configurable:!0}};sf.prototype.readResolve=function(){return sf.nameToTypeMap.get(this.un)},sf.prototype.toString=function(){return this.un},sf.prototype.interfaces_=function(){return[Yh]},sf.prototype.getClass=function(){return sf},of.serialVersionUID.get=function(){return-552860263173159e4},of.nameToTypeMap.get=function(){return new ef},Object.defineProperties(sf,of),nf.Type=sf,nf.FIXED=new sf("FIXED"),nf.FLOATING=new sf("FLOATING"),nf.FLOATING_SINGLE=new sf("FLOATING SINGLE");var af=function t(){this.Wt=new nf,this.Xt=0,this.hn=t.getDefaultCoordinateSequenceFactory(),0===arguments.length||(1===arguments.length?nc(arguments[0],$h)?this.hn=arguments[0]:arguments[0]instanceof nf&&(this.Wt=arguments[0]):2===arguments.length?(this.Wt=arguments[0],this.Xt=arguments[1]):3===arguments.length&&(this.Wt=arguments[0],this.Xt=arguments[1],this.hn=arguments[2]))},lf={serialVersionUID:{configurable:!0}};af.prototype.toGeometry=function(t){return t.isNull()?this.createPoint(null):t.getMinX()===t.getMaxX()&&t.getMinY()===t.getMaxY()?this.createPoint(new Zh(t.getMinX(),t.getMinY())):t.getMinX()===t.getMaxX()||t.getMinY()===t.getMaxY()?this.createLineString([new Zh(t.getMinX(),t.getMinY()),new Zh(t.getMaxX(),t.getMaxY())]):this.createPolygon(this.createLinearRing([new Zh(t.getMinX(),t.getMinY()),new Zh(t.getMinX(),t.getMaxY()),new Zh(t.getMaxX(),t.getMaxY()),new Zh(t.getMaxX(),t.getMinY()),new Zh(t.getMinX(),t.getMinY())]),null)},af.prototype.createLineString=function(t){return t?t instanceof Array?new zu(this.getCoordinateSequenceFactory().create(t),this):nc(t,fc)?new zu(t,this):void 0:new zu(this.getCoordinateSequenceFactory().create([]),this)},af.prototype.createMultiLineString=function(){if(0===arguments.length)return new Su(null,this);if(1===arguments.length){var t=arguments[0];return new Su(t,this)}},af.prototype.buildGeometry=function(t){for(var e=null,n=!1,r=!1,i=t.iterator();i.hasNext();){var s=i.next(),o=s.getClass();null===e&&(e=o),o!==e&&(n=!0),s.isGeometryCollectionOrDerived()&&(r=!0)}if(null===e)return this.createGeometryCollection();if(n||r)return this.createGeometryCollection(af.toGeometryArray(t));var a=t.iterator().next();if(t.size()>1){if(a instanceof ju)return this.createMultiPolygon(af.toPolygonArray(t));if(a instanceof zu)return this.createMultiLineString(af.toLineStringArray(t));if(a instanceof Hu)return this.createMultiPoint(af.toPointArray(t));Ic.shouldNeverReachHere("Unhandled class: "+a.getClass().getName())}return a},af.prototype.createMultiPointFromCoords=function(t){return this.createMultiPoint(null!==t?this.getCoordinateSequenceFactory().create(t):null)},af.prototype.createPoint=function(){if(0===arguments.length)return this.createPoint(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Zh){var t=arguments[0];return this.createPoint(null!==t?this.getCoordinateSequenceFactory().create([t]):null)}if(nc(arguments[0],fc)){var e=arguments[0];return new Hu(e,this)}}},af.prototype.getCoordinateSequenceFactory=function(){return this.hn},af.prototype.createPolygon=function(){if(0===arguments.length)return new ju(null,null,this);if(1===arguments.length){if(nc(arguments[0],fc)){var t=arguments[0];return this.createPolygon(this.createLinearRing(t))}if(arguments[0]instanceof Array){var e=arguments[0];return this.createPolygon(this.createLinearRing(e))}if(arguments[0]instanceof Gu){var n=arguments[0];return this.createPolygon(n,null)}}else if(2===arguments.length){var r=arguments[0],i=arguments[1];return new ju(r,i,this)}},af.prototype.getSRID=function(){return this.Xt},af.prototype.createGeometryCollection=function(){if(0===arguments.length)return new Tu(null,this);if(1===arguments.length){var t=arguments[0];return new Tu(t,this)}},af.prototype.createGeometry=function(t){return new Wu(this).edit(t,{edit:function(){if(2===arguments.length){var t=arguments[0];return this.hn.create(t)}}})},af.prototype.getPrecisionModel=function(){return this.Wt},af.prototype.createLinearRing=function(){if(0===arguments.length)return this.createLinearRing(this.getCoordinateSequenceFactory().create([]));if(1===arguments.length){if(arguments[0]instanceof Array){var t=arguments[0];return this.createLinearRing(null!==t?this.getCoordinateSequenceFactory().create(t):null)}if(nc(arguments[0],fc)){var e=arguments[0];return new Gu(e,this)}}},af.prototype.createMultiPolygon=function(){if(0===arguments.length)return new qu(null,this);if(1===arguments.length){var t=arguments[0];return new qu(t,this)}},af.prototype.createMultiPoint=function(){var t=this;if(0===arguments.length)return new Vu(null,this);if(1===arguments.length){if(arguments[0]instanceof Array){var e=arguments[0];return new Vu(e,this)}if(arguments[0]instanceof Array){var n=arguments[0];return this.createMultiPoint(null!==n?this.getCoordinateSequenceFactory().create(n):null)}if(nc(arguments[0],fc)){var r=arguments[0];if(null===r)return this.createMultiPoint(new Array(0).fill(null));for(var i=new Array(r.size()).fill(null),s=0;s<r.size();s++){var o=t.getCoordinateSequenceFactory().create(1,r.getDimension());Lu.copy(r,s,o,0,1),i[s]=t.createPoint(o)}return this.createMultiPoint(i)}}},af.prototype.interfaces_=function(){return[Yh]},af.prototype.getClass=function(){return af},af.toMultiPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toGeometryArray=function(t){if(null===t)return null;var e=new Array(t.size()).fill(null);return t.toArray(e)},af.getDefaultCoordinateSequenceFactory=function(){return $u.instance()},af.toMultiLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toLineStringArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toMultiPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toLinearRingArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toPointArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.toPolygonArray=function(t){var e=new Array(t.size()).fill(null);return t.toArray(e)},af.createPointFromInternalCoord=function(t,e){return e.getPrecisionModel().makePrecise(t),e.getFactory().createPoint(t)},lf.serialVersionUID.get=function(){return-0x5ea75f2051eeb400},Object.defineProperties(af,lf);var hf=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"],cf=function(t){this.geometryFactory=t||new af};cf.prototype.read=function(t){var e,n=(e="string"==typeof t?JSON.parse(t):t).type;if(!uf[n])throw new Error("Unknown GeoJSON type: "+e.type);return-1!==hf.indexOf(n)?uf[n].apply(this,[e.coordinates]):"GeometryCollection"===n?uf[n].apply(this,[e.geometries]):uf[n].apply(this,[e])},cf.prototype.write=function(t){var e=t.getGeometryType();if(!ff[e])throw new Error("Geometry is not supported");return ff[e].apply(this,[t])};var uf={Feature:function(t){var e={};for(var n in t)e[n]=t[n];if(t.geometry){var r=t.geometry.type;if(!uf[r])throw new Error("Unknown GeoJSON type: "+t.type);e.geometry=this.read(t.geometry)}return t.bbox&&(e.bbox=uf.bbox.apply(this,[t.bbox])),e},FeatureCollection:function(t){var e={};if(t.features){e.features=[];for(var n=0;n<t.features.length;++n)e.features.push(this.read(t.features[n]))}return t.bbox&&(e.bbox=this.parse.bbox.apply(this,[t.bbox])),e},coordinates:function(t){for(var e=[],n=0;n<t.length;++n){var r=t[n];e.push(new Zh(r[0],r[1]))}return e},bbox:function(t){return this.geometryFactory.createLinearRing([new Zh(t[0],t[1]),new Zh(t[2],t[1]),new Zh(t[2],t[3]),new Zh(t[0],t[3]),new Zh(t[0],t[1])])},Point:function(t){var e=new Zh(t[0],t[1]);return this.geometryFactory.createPoint(e)},MultiPoint:function(t){for(var e=[],n=0;n<t.length;++n)e.push(uf.Point.apply(this,[t[n]]));return this.geometryFactory.createMultiPoint(e)},LineString:function(t){var e=uf.coordinates.apply(this,[t]);return this.geometryFactory.createLineString(e)},MultiLineString:function(t){for(var e=[],n=0;n<t.length;++n)e.push(uf.LineString.apply(this,[t[n]]));return this.geometryFactory.createMultiLineString(e)},Polygon:function(t){for(var e=uf.coordinates.apply(this,[t[0]]),n=this.geometryFactory.createLinearRing(e),r=[],i=1;i<t.length;++i){var s=t[i],o=uf.coordinates.apply(this,[s]),a=this.geometryFactory.createLinearRing(o);r.push(a)}return this.geometryFactory.createPolygon(n,r)},MultiPolygon:function(t){for(var e=[],n=0;n<t.length;++n){var r=t[n];e.push(uf.Polygon.apply(this,[r]))}return this.geometryFactory.createMultiPolygon(e)},GeometryCollection:function(t){for(var e=[],n=0;n<t.length;++n){var r=t[n];e.push(this.read(r))}return this.geometryFactory.createGeometryCollection(e)}},ff={coordinate:function(t){return[t.x,t.y]},Point:function(t){return{type:"Point",coordinates:ff.coordinate.apply(this,[t.getCoordinate()])}},MultiPoint:function(t){for(var e=[],n=0;n<t.Nt.length;++n){var r=t.Nt[n],i=ff.Point.apply(this,[r]);e.push(i.coordinates)}return{type:"MultiPoint",coordinates:e}},LineString:function(t){for(var e=[],n=t.getCoordinates(),r=0;r<n.length;++r){var i=n[r];e.push(ff.coordinate.apply(this,[i]))}return{type:"LineString",coordinates:e}},MultiLineString:function(t){for(var e=[],n=0;n<t.Nt.length;++n){var r=t.Nt[n],i=ff.LineString.apply(this,[r]);e.push(i.coordinates)}return{type:"MultiLineString",coordinates:e}},Polygon:function(t){var e=[],n=ff.LineString.apply(this,[t.Qt]);e.push(n.coordinates);for(var r=0;r<t.St.length;++r){var i=t.St[r],s=ff.LineString.apply(this,[i]);e.push(s.coordinates)}return{type:"Polygon",coordinates:e}},MultiPolygon:function(t){for(var e=[],n=0;n<t.Nt.length;++n){var r=t.Nt[n],i=ff.Polygon.apply(this,[r]);e.push(i.coordinates)}return{type:"MultiPolygon",coordinates:e}},GeometryCollection:function(t){for(var e=[],n=0;n<t.Nt.length;++n){var r=t.Nt[n],i=r.getGeometryType();e.push(ff[i].apply(this,[r]))}return{type:"GeometryCollection",geometries:e}}},df=function(t){this.geometryFactory=t||new af,this.precisionModel=this.geometryFactory.getPrecisionModel(),this.parser=new cf(this.geometryFactory)};df.prototype.read=function(t){var e=this.parser.read(t);return this.precisionModel.getType()===nf.FIXED&&this.reducePrecision(e),e},df.prototype.reducePrecision=function(t){var e,n;if(t.coordinate)this.precisionModel.makePrecise(t.coordinate);else if(t.points)for(e=0,n=t.points.length;e<n;e++)this.precisionModel.makePrecise(t.points[e]);else if(t.geometries)for(e=0,n=t.geometries.length;e<n;e++)this.reducePrecision(t.geometries[e])};var pf=function(){this.parser=new cf(this.geometryFactory)};pf.prototype.write=function(t){return this.parser.write(t)};var Af=function(){},gf={ON:{configurable:!0},LEFT:{configurable:!0},RIGHT:{configurable:!0}};function mf(t){this.message=t||""}function yf(){this.array_=[]}Af.prototype.interfaces_=function(){return[]},Af.prototype.getClass=function(){return Af},Af.opposite=function(t){return t===Af.LEFT?Af.RIGHT:t===Af.RIGHT?Af.LEFT:t},gf.ON.get=function(){return 0},gf.LEFT.get=function(){return 1},gf.RIGHT.get=function(){return 2},Object.defineProperties(Af,gf),mf.prototype=new Error,mf.prototype.name="EmptyStackException",yf.prototype=new Yc,yf.prototype.add=function(t){return this.array_.push(t),!0},yf.prototype.get=function(t){if(t<0||t>=this.size())throw new Error;return this.array_[t]},yf.prototype.push=function(t){return this.array_.push(t),t},yf.prototype.pop=function(t){if(0===this.array_.length)throw new mf;return this.array_.pop()},yf.prototype.peek=function(){if(0===this.array_.length)throw new mf;return this.array_[this.array_.length-1]},yf.prototype.empty=function(){return 0===this.array_.length},yf.prototype.isEmpty=function(){return this.empty()},yf.prototype.search=function(t){return this.array_.indexOf(t)},yf.prototype.size=function(){return this.array_.length},yf.prototype.toArray=function(){for(var t=[],e=0,n=this.array_.length;e<n;e++)t.push(this.array_[e]);return t};var vf=function(){this.cn=-1,this.an=null,this.vn=null,this.ln=null};vf.prototype.getCoordinate=function(){return this.an},vf.prototype.getRightmostSide=function(t,e){var n=this.getRightmostSideOfSegment(t,e);return n<0&&(n=this.getRightmostSideOfSegment(t,e-1)),n<0&&(this.an=null,this.checkForRightmostCoordinate(t)),n},vf.prototype.findRightmostEdgeAtVertex=function(){var t=this.vn.getEdge().getCoordinates();Ic.isTrue(this.cn>0&&this.cn<t.length,"rightmost point expected to be interior vertex of edge");var e=t[this.cn-1],n=t[this.cn+1],r=Rc.computeOrientation(this.an,n,e),i=!1;(e.y<this.an.y&&n.y<this.an.y&&r===Rc.COUNTERCLOCKWISE||e.y>this.an.y&&n.y>this.an.y&&r===Rc.CLOCKWISE)&&(i=!0),i&&(this.cn=this.cn-1)},vf.prototype.getRightmostSideOfSegment=function(t,e){var n=t.getEdge().getCoordinates();if(e<0||e+1>=n.length)return-1;if(n[e].y===n[e+1].y)return-1;var r=Af.LEFT;return n[e].y<n[e+1].y&&(r=Af.RIGHT),r},vf.prototype.getEdge=function(){return this.ln},vf.prototype.checkForRightmostCoordinate=function(t){for(var e=t.getEdge().getCoordinates(),n=0;n<e.length-1;n++)(null===this.an||e[n].x>this.an.x)&&(this.vn=t,this.cn=n,this.an=e[n])},vf.prototype.findRightmostEdgeAtNode=function(){var t=this.vn.getNode().getEdges();this.vn=t.getRightmostEdge(),this.vn.isForward()||(this.vn=this.vn.getSym(),this.cn=this.vn.getEdge().getCoordinates().length-1)},vf.prototype.findEdge=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();n.isForward()&&this.checkForRightmostCoordinate(n)}Ic.isTrue(0!==this.cn||this.an.equals(this.vn.getCoordinate()),"inconsistency in rightmost processing"),0===this.cn?this.findRightmostEdgeAtNode():this.findRightmostEdgeAtVertex(),this.ln=this.vn,this.getRightmostSide(this.vn,this.cn)===Af.LEFT&&(this.ln=this.vn.getSym())},vf.prototype.interfaces_=function(){return[]},vf.prototype.getClass=function(){return vf};var xf=function(t){function e(n,r){t.call(this,e.msgWithCoord(n,r)),this.pt=r?new Zh(r):null,this.name="TopologyException"}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getCoordinate=function(){return this.pt},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.msgWithCoord=function(t,e){return e?t:t+" [ "+e+" ]"},e}(Tc),bf=function(){this.array_=[]};bf.prototype.addLast=function(t){this.array_.push(t)},bf.prototype.removeFirst=function(){return this.array_.shift()},bf.prototype.isEmpty=function(){return 0===this.array_.length};var wf=function(){this.wn=null,this.Pn=new Kc,this.gn=new Kc,this.Cn=null,this.Dn=null,this.wn=new vf};wf.prototype.clearVisitedEdges=function(){for(var t=this.Pn.iterator();t.hasNext();)t.next().setVisited(!1)},wf.prototype.getRightmostCoordinate=function(){return this.Cn},wf.prototype.computeNodeDepth=function(t){for(var e=null,n=t.getEdges().iterator();n.hasNext();){var r=n.next();if(r.isVisited()||r.getSym().isVisited()){e=r;break}}if(null===e)throw new xf("unable to find edge to compute depths at "+t.getCoordinate());t.getEdges().computeDepths(e);for(var i=t.getEdges().iterator();i.hasNext();){var s=i.next();s.setVisited(!0),this.copySymDepths(s)}},wf.prototype.computeDepth=function(t){this.clearVisitedEdges();var e=this.wn.getEdge();e.setEdgeDepths(Af.RIGHT,t),this.copySymDepths(e),this.computeDepths(e)},wf.prototype.create=function(t){this.addReachable(t),this.wn.findEdge(this.Pn),this.Cn=this.wn.getCoordinate()},wf.prototype.findResultEdges=function(){for(var t=this.Pn.iterator();t.hasNext();){var e=t.next();e.getDepth(Af.RIGHT)>=1&&e.getDepth(Af.LEFT)<=0&&!e.isInteriorAreaEdge()&&e.setInResult(!0)}},wf.prototype.computeDepths=function(t){var e=new lu,n=new bf,r=t.getNode();for(n.addLast(r),e.add(r),t.setVisited(!0);!n.isEmpty();){var i=n.removeFirst();e.add(i),this.computeNodeDepth(i);for(var s=i.getEdges().iterator();s.hasNext();){var o=s.next().getSym();if(!o.isVisited()){var a=o.getNode();e.contains(a)||(n.addLast(a),e.add(a))}}}},wf.prototype.compareTo=function(t){var e=t;return this.Cn.x<e.Cn.x?-1:this.Cn.x>e.Cn.x?1:0},wf.prototype.getEnvelope=function(){if(null===this.Dn){for(var t=new yc,e=this.Pn.iterator();e.hasNext();)for(var n=e.next().getEdge().getCoordinates(),r=0;r<n.length-1;r++)t.expandToInclude(n[r]);this.Dn=t}return this.Dn},wf.prototype.addReachable=function(t){var e=new yf;for(e.add(t);!e.empty();){var n=e.pop();this.add(n,e)}},wf.prototype.copySymDepths=function(t){var e=t.getSym();e.setDepth(Af.LEFT,t.getDepth(Af.RIGHT)),e.setDepth(Af.RIGHT,t.getDepth(Af.LEFT))},wf.prototype.add=function(t,e){t.setVisited(!0),this.gn.add(t);for(var n=t.getEdges().iterator();n.hasNext();){var r=n.next();this.Pn.add(r);var i=r.getSym().getNode();i.isVisited()||e.push(i)}},wf.prototype.getNodes=function(){return this.gn},wf.prototype.getDirectedEdges=function(){return this.Pn},wf.prototype.interfaces_=function(){return[Wh]},wf.prototype.getClass=function(){return wf};var _f=function t(){var e=this;if(this.location=null,1===arguments.length){if(arguments[0]instanceof Array){var n=arguments[0];this.init(n.length)}else if(Number.isInteger(arguments[0])){var r=arguments[0];this.init(1),this.location[Af.ON]=r}else if(arguments[0]instanceof t){var i=arguments[0];if(this.init(i.location.length),null!==i)for(var s=0;s<this.location.length;s++)e.location[s]=i.location[s]}}else if(3===arguments.length){var o=arguments[0],a=arguments[1],l=arguments[2];this.init(3),this.location[Af.ON]=o,this.location[Af.LEFT]=a,this.location[Af.RIGHT]=l}};_f.prototype.setAllLocations=function(t){for(var e=0;e<this.location.length;e++)this.location[e]=t},_f.prototype.isNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]!==tc.NONE)return!1;return!0},_f.prototype.setAllLocationsIfNull=function(t){for(var e=0;e<this.location.length;e++)this.location[e]===tc.NONE&&(this.location[e]=t)},_f.prototype.isLine=function(){return 1===this.location.length},_f.prototype.merge=function(t){if(t.location.length>this.location.length){var e=new Array(3).fill(null);e[Af.ON]=this.location[Af.ON],e[Af.LEFT]=tc.NONE,e[Af.RIGHT]=tc.NONE,this.location=e}for(var n=0;n<this.location.length;n++)this.location[n]===tc.NONE&&n<t.location.length&&(this.location[n]=t.location[n])},_f.prototype.getLocations=function(){return this.location},_f.prototype.flip=function(){if(this.location.length<=1)return null;var t=this.location[Af.LEFT];this.location[Af.LEFT]=this.location[Af.RIGHT],this.location[Af.RIGHT]=t},_f.prototype.toString=function(){var t=new sc;return this.location.length>1&&t.append(tc.toLocationSymbol(this.location[Af.LEFT])),t.append(tc.toLocationSymbol(this.location[Af.ON])),this.location.length>1&&t.append(tc.toLocationSymbol(this.location[Af.RIGHT])),t.toString()},_f.prototype.setLocations=function(t,e,n){this.location[Af.ON]=t,this.location[Af.LEFT]=e,this.location[Af.RIGHT]=n},_f.prototype.get=function(t){return t<this.location.length?this.location[t]:tc.NONE},_f.prototype.isArea=function(){return this.location.length>1},_f.prototype.isAnyNull=function(){for(var t=0;t<this.location.length;t++)if(this.location[t]===tc.NONE)return!0;return!1},_f.prototype.setLocation=function(){if(1===arguments.length){var t=arguments[0];this.setLocation(Af.ON,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.location[e]=n}},_f.prototype.init=function(t){this.location=new Array(t).fill(null),this.setAllLocations(tc.NONE)},_f.prototype.isEqualOnSide=function(t,e){return this.location[e]===t.location[e]},_f.prototype.allPositionsEqual=function(t){for(var e=0;e<this.location.length;e++)if(this.location[e]!==t)return!1;return!0},_f.prototype.interfaces_=function(){return[]},_f.prototype.getClass=function(){return _f};var Mf=function t(){if(this.elt=new Array(2).fill(null),1===arguments.length){if(Number.isInteger(arguments[0])){var e=arguments[0];this.elt[0]=new _f(e),this.elt[1]=new _f(e)}else if(arguments[0]instanceof t){var n=arguments[0];this.elt[0]=new _f(n.elt[0]),this.elt[1]=new _f(n.elt[1])}}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.elt[0]=new _f(tc.NONE),this.elt[1]=new _f(tc.NONE),this.elt[r].setLocation(i)}else if(3===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2];this.elt[0]=new _f(s,o,a),this.elt[1]=new _f(s,o,a)}else if(4===arguments.length){var l=arguments[0],h=arguments[1],c=arguments[2],u=arguments[3];this.elt[0]=new _f(tc.NONE,tc.NONE,tc.NONE),this.elt[1]=new _f(tc.NONE,tc.NONE,tc.NONE),this.elt[l].setLocations(h,c,u)}};Mf.prototype.getGeometryCount=function(){var t=0;return this.elt[0].isNull()||t++,this.elt[1].isNull()||t++,t},Mf.prototype.setAllLocations=function(t,e){this.elt[t].setAllLocations(e)},Mf.prototype.isNull=function(t){return this.elt[t].isNull()},Mf.prototype.setAllLocationsIfNull=function(){if(1===arguments.length){var t=arguments[0];this.setAllLocationsIfNull(0,t),this.setAllLocationsIfNull(1,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.elt[e].setAllLocationsIfNull(n)}},Mf.prototype.isLine=function(t){return this.elt[t].isLine()},Mf.prototype.merge=function(t){for(var e=0;e<2;e++)null===this.elt[e]&&null!==t.elt[e]?this.elt[e]=new _f(t.elt[e]):this.elt[e].merge(t.elt[e])},Mf.prototype.flip=function(){this.elt[0].flip(),this.elt[1].flip()},Mf.prototype.getLocation=function(){if(1===arguments.length){var t=arguments[0];return this.elt[t].get(Af.ON)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return this.elt[e].get(n)}},Mf.prototype.toString=function(){var t=new sc;return null!==this.elt[0]&&(t.append("A:"),t.append(this.elt[0].toString())),null!==this.elt[1]&&(t.append(" B:"),t.append(this.elt[1].toString())),t.toString()},Mf.prototype.isArea=function(){if(0===arguments.length)return this.elt[0].isArea()||this.elt[1].isArea();if(1===arguments.length){var t=arguments[0];return this.elt[t].isArea()}},Mf.prototype.isAnyNull=function(t){return this.elt[t].isAnyNull()},Mf.prototype.setLocation=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.elt[t].setLocation(Af.ON,e)}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.elt[n].setLocation(r,i)}},Mf.prototype.isEqualOnSide=function(t,e){return this.elt[0].isEqualOnSide(t.elt[0],e)&&this.elt[1].isEqualOnSide(t.elt[1],e)},Mf.prototype.allPositionsEqual=function(t,e){return this.elt[t].allPositionsEqual(e)},Mf.prototype.toLine=function(t){this.elt[t].isArea()&&(this.elt[t]=new _f(this.elt[t].location[0]))},Mf.prototype.interfaces_=function(){return[]},Mf.prototype.getClass=function(){return Mf},Mf.toLineLabel=function(t){for(var e=new Mf(tc.NONE),n=0;n<2;n++)e.setLocation(n,t.getLocation(n));return e};var Tf=function(){this.In=null,this.Mn=-1,this.bn=new Kc,this.zn=new Kc,this.dn=new Mf(tc.NONE),this.xn=null,this.mn=null,this.Qt=null,this.St=new Kc,this.yn=null;var t=arguments[0],e=arguments[1];this.yn=e,this.computePoints(t),this.computeRing()};Tf.prototype.computeRing=function(){if(null!==this.xn)return null;for(var t=new Array(this.zn.size()).fill(null),e=0;e<this.zn.size();e++)t[e]=this.zn.get(e);this.xn=this.yn.createLinearRing(t),this.mn=Rc.isCCW(this.xn.getCoordinates())},Tf.prototype.isIsolated=function(){return 1===this.dn.getGeometryCount()},Tf.prototype.computePoints=function(t){this.In=t;var e=t,n=!0;do{if(null===e)throw new xf("Found null DirectedEdge");if(e.getEdgeRing()===this)throw new xf("Directed Edge visited twice during ring-building at "+e.getCoordinate());this.bn.add(e);var r=e.getLabel();Ic.isTrue(r.isArea()),this.mergeLabel(r),this.addPoints(e.getEdge(),e.isForward(),n),n=!1,this.setEdgeRing(e,this),e=this.getNext(e)}while(e!==this.In)},Tf.prototype.getLinearRing=function(){return this.xn},Tf.prototype.getCoordinate=function(t){return this.zn.get(t)},Tf.prototype.computeMaxNodeDegree=function(){this.Mn=0;var t=this.In;do{var e=t.getNode().getEdges().getOutgoingDegree(this);e>this.Mn&&(this.Mn=e),t=this.getNext(t)}while(t!==this.In);this.Mn*=2},Tf.prototype.addPoints=function(t,e,n){var r=t.getCoordinates();if(e){var i=1;n&&(i=0);for(var s=i;s<r.length;s++)this.zn.add(r[s])}else{var o=r.length-2;n&&(o=r.length-1);for(var a=o;a>=0;a--)this.zn.add(r[a])}},Tf.prototype.isHole=function(){return this.mn},Tf.prototype.setInResult=function(){var t=this.In;do{t.getEdge().setInResult(!0),t=t.getNext()}while(t!==this.In)},Tf.prototype.containsPoint=function(t){var e=this.getLinearRing();if(!e.getEnvelopeInternal().contains(t))return!1;if(!Rc.isPointInRing(t,e.getCoordinates()))return!1;for(var n=this.St.iterator();n.hasNext();)if(n.next().containsPoint(t))return!1;return!0},Tf.prototype.addHole=function(t){this.St.add(t)},Tf.prototype.isShell=function(){return null===this.Qt},Tf.prototype.getLabel=function(){return this.dn},Tf.prototype.getEdges=function(){return this.bn},Tf.prototype.getMaxNodeDegree=function(){return this.Mn<0&&this.computeMaxNodeDegree(),this.Mn},Tf.prototype.getShell=function(){return this.Qt},Tf.prototype.mergeLabel=function(){if(1===arguments.length){var t=arguments[0];this.mergeLabel(t,0),this.mergeLabel(t,1)}else if(2===arguments.length){var e=arguments[0],n=arguments[1],r=e.getLocation(n,Af.RIGHT);if(r===tc.NONE)return null;if(this.dn.getLocation(n)===tc.NONE)return this.dn.setLocation(n,r),null}},Tf.prototype.setShell=function(t){this.Qt=t,null!==t&&t.addHole(this)},Tf.prototype.toPolygon=function(t){for(var e=new Array(this.St.size()).fill(null),n=0;n<this.St.size();n++)e[n]=this.St.get(n).getLinearRing();return t.createPolygon(this.getLinearRing(),e)},Tf.prototype.interfaces_=function(){return[]},Tf.prototype.getClass=function(){return Tf};var Sf=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.setEdgeRing=function(t,e){t.setMinEdgeRing(e)},e.prototype.getNext=function(t){return t.getNextMin()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Tf),If=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildMinimalRings=function(){var t=new Kc,e=this.In;do{if(null===e.getMinEdgeRing()){var n=new Sf(e,this.yn);t.add(n)}e=e.getNext()}while(e!==this.In);return t},e.prototype.setEdgeRing=function(t,e){t.setEdgeRing(e)},e.prototype.linkDirectedEdgesForMinimalEdgeRings=function(){var t=this.In;do{t.getNode().getEdges().linkMinimalDirectedEdges(this),t=t.getNext()}while(t!==this.In)},e.prototype.getNext=function(t){return t.getNext()},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Tf),Cf=function(){if(this.dn=null,this.pn=!1,this.Ln=!1,this.Tn=!1,this.On=!1,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.dn=t}};Cf.prototype.setVisited=function(t){this.On=t},Cf.prototype.setInResult=function(t){this.pn=t},Cf.prototype.isCovered=function(){return this.Ln},Cf.prototype.isCoveredSet=function(){return this.Tn},Cf.prototype.setLabel=function(t){this.dn=t},Cf.prototype.getLabel=function(){return this.dn},Cf.prototype.setCovered=function(t){this.Ln=t,this.Tn=!0},Cf.prototype.updateIM=function(t){Ic.isTrue(this.dn.getGeometryCount()>=2,"found partial label"),this.computeIM(t)},Cf.prototype.isInResult=function(){return this.pn},Cf.prototype.isVisited=function(){return this.On},Cf.prototype.interfaces_=function(){return[]},Cf.prototype.getClass=function(){return Cf};var Of=function(t){function e(){t.call(this),this.Fn=null,this.bn=null;var e=arguments[0],n=arguments[1];this.Fn=e,this.bn=n,this.dn=new Mf(0,tc.NONE)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isIncidentEdgeInResult=function(){for(var t=this.getEdges().getEdges().iterator();t.hasNext();)if(t.next().getEdge().isInResult())return!0;return!1},e.prototype.isIsolated=function(){return 1===this.dn.getGeometryCount()},e.prototype.getCoordinate=function(){return this.Fn},e.prototype.print=function(t){t.println("node "+this.Fn+" lbl: "+this.dn)},e.prototype.computeIM=function(t){},e.prototype.computeMergedLocation=function(t,e){var n=tc.NONE;if(n=this.dn.getLocation(e),!t.isNull(e)){var r=t.getLocation(e);n!==tc.BOUNDARY&&(n=r)}return n},e.prototype.setLabel=function(){if(2!==arguments.length)return t.prototype.setLabel.apply(this,arguments);var e=arguments[0],n=arguments[1];null===this.dn?this.dn=new Mf(e,n):this.dn.setLocation(e,n)},e.prototype.getEdges=function(){return this.bn},e.prototype.mergeLabel=function(){var t=this;if(arguments[0]instanceof e){var n=arguments[0];this.mergeLabel(n.dn)}else if(arguments[0]instanceof Mf)for(var r=arguments[0],i=0;i<2;i++){var s=t.computeMergedLocation(r,i),o=t.dn.getLocation(i);o===tc.NONE&&t.dn.setLocation(i,s)}},e.prototype.add=function(t){this.bn.insert(t),t.setNode(this)},e.prototype.setLabelBoundary=function(t){if(null===this.dn)return null;var e=tc.NONE;null!==this.dn&&(e=this.dn.getLocation(t));var n=null;switch(e){case tc.BOUNDARY:n=tc.INTERIOR;break;case tc.INTERIOR:default:n=tc.BOUNDARY}this.dn.setLocation(t,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Cf),Ef=function(){this.nodeMap=new Au,this.nodeFact=null;var t=arguments[0];this.nodeFact=t};Ef.prototype.find=function(t){return this.nodeMap.get(t)},Ef.prototype.addNode=function(){if(arguments[0]instanceof Zh){var t=arguments[0],e=this.nodeMap.get(t);return null===e&&(e=this.nodeFact.createNode(t),this.nodeMap.put(t,e)),e}if(arguments[0]instanceof Of){var n=arguments[0],r=this.nodeMap.get(n.getCoordinate());return null===r?(this.nodeMap.put(n.getCoordinate(),n),n):(r.mergeLabel(n),r)}},Ef.prototype.print=function(t){for(var e=this.iterator();e.hasNext();)e.next().print(t)},Ef.prototype.iterator=function(){return this.nodeMap.values().iterator()},Ef.prototype.values=function(){return this.nodeMap.values()},Ef.prototype.getBoundaryNodes=function(t){for(var e=new Kc,n=this.iterator();n.hasNext();){var r=n.next();r.getLabel().getLocation(t)===tc.BOUNDARY&&e.add(r)}return e},Ef.prototype.add=function(t){var e=t.getCoordinate();this.addNode(e).add(t)},Ef.prototype.interfaces_=function(){return[]},Ef.prototype.getClass=function(){return Ef};var Pf=function(){},kf={NE:{configurable:!0},NW:{configurable:!0},SW:{configurable:!0},SE:{configurable:!0}};Pf.prototype.interfaces_=function(){return[]},Pf.prototype.getClass=function(){return Pf},Pf.isNorthern=function(t){return t===Pf.NE||t===Pf.NW},Pf.isOpposite=function(t,e){return t!==e&&2===(t-e+4)%4},Pf.commonHalfPlane=function(t,e){if(t===e)return t;if(2===(t-e+4)%4)return-1;var n=t<e?t:e;return 0===n&&3===(t>e?t:e)?3:n},Pf.isInHalfPlane=function(t,e){return e===Pf.SE?t===Pf.SE||t===Pf.SW:t===e||t===e+1},Pf.quadrant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new Vh("Cannot compute the quadrant for point ( "+t+", "+e+" )");return t>=0?e>=0?Pf.NE:Pf.SE:e>=0?Pf.NW:Pf.SW}if(arguments[0]instanceof Zh&&arguments[1]instanceof Zh){var n=arguments[0],r=arguments[1];if(r.x===n.x&&r.y===n.y)throw new Vh("Cannot compute the quadrant for two identical points "+n);return r.x>=n.x?r.y>=n.y?Pf.NE:Pf.SE:r.y>=n.y?Pf.NW:Pf.SW}},kf.NE.get=function(){return 0},kf.NW.get=function(){return 1},kf.SW.get=function(){return 2},kf.SE.get=function(){return 3},Object.defineProperties(Pf,kf);var Rf=function(){if(this.Un=null,this.dn=null,this.En=null,this.Nn=null,this.jn=null,this.Qn=null,this.Sn=null,this.Bn=null,1===arguments.length){var t=arguments[0];this.Un=t}else if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2],i=null;this.Un=e,this.init(n,r),this.dn=i}else if(4===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2],l=arguments[3];this.Un=s,this.init(o,a),this.dn=l}};Rf.prototype.compareDirection=function(t){return this.Qn===t.Qn&&this.Sn===t.Sn?0:this.Bn>t.Bn?1:this.Bn<t.Bn?-1:Rc.computeOrientation(t.Nn,t.jn,this.jn)},Rf.prototype.getDy=function(){return this.Sn},Rf.prototype.getCoordinate=function(){return this.Nn},Rf.prototype.setNode=function(t){this.En=t},Rf.prototype.print=function(t){var e=Math.atan2(this.Sn,this.Qn),n=this.getClass().getName(),r=n.lastIndexOf("."),i=n.substring(r+1);t.print("  "+i+": "+this.Nn+" - "+this.jn+" "+this.Bn+":"+e+"   "+this.dn)},Rf.prototype.compareTo=function(t){var e=t;return this.compareDirection(e)},Rf.prototype.getDirectedCoordinate=function(){return this.jn},Rf.prototype.getDx=function(){return this.Qn},Rf.prototype.getLabel=function(){return this.dn},Rf.prototype.getEdge=function(){return this.Un},Rf.prototype.getQuadrant=function(){return this.Bn},Rf.prototype.getNode=function(){return this.En},Rf.prototype.toString=function(){var t=Math.atan2(this.Sn,this.Qn),e=this.getClass().getName(),n=e.lastIndexOf(".");return"  "+e.substring(n+1)+": "+this.Nn+" - "+this.jn+" "+this.Bn+":"+t+"   "+this.dn},Rf.prototype.computeLabel=function(t){},Rf.prototype.init=function(t,e){this.Nn=t,this.jn=e,this.Qn=e.x-t.x,this.Sn=e.y-t.y,this.Bn=Pf.quadrant(this.Qn,this.Sn),Ic.isTrue(!(0===this.Qn&&0===this.Sn),"EdgeEnd with identical endpoints found")},Rf.prototype.interfaces_=function(){return[Wh]},Rf.prototype.getClass=function(){return Rf};var Nf=function(t){function e(){var e=arguments[0],n=arguments[1];if(t.call(this,e),this.kn=null,this.pn=!1,this.On=!1,this.Rn=null,this.Gn=null,this.Yn=null,this.qn=null,this.Vn=null,this.Wn=[0,-999,-999],this.kn=n,n)this.init(e.getCoordinate(0),e.getCoordinate(1));else{var r=e.getNumPoints()-1;this.init(e.getCoordinate(r),e.getCoordinate(r-1))}this.computeDirectedLabel()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getNextMin=function(){return this.Yn},e.prototype.getDepth=function(t){return this.Wn[t]},e.prototype.setVisited=function(t){this.On=t},e.prototype.computeDirectedLabel=function(){this.dn=new Mf(this.Un.getLabel()),this.kn||this.dn.flip()},e.prototype.getNext=function(){return this.Gn},e.prototype.setDepth=function(t,e){if(-999!==this.Wn[t]&&this.Wn[t]!==e)throw new xf("assigned depths do not match",this.getCoordinate());this.Wn[t]=e},e.prototype.isInteriorAreaEdge=function(){for(var t=!0,e=0;e<2;e++)this.dn.isArea(e)&&this.dn.getLocation(e,Af.LEFT)===tc.INTERIOR&&this.dn.getLocation(e,Af.RIGHT)===tc.INTERIOR||(t=!1);return t},e.prototype.setNextMin=function(t){this.Yn=t},e.prototype.print=function(e){t.prototype.print.call(this,e),e.print(" "+this.Wn[Af.LEFT]+"/"+this.Wn[Af.RIGHT]),e.print(" ("+this.getDepthDelta()+")"),this.pn&&e.print(" inResult")},e.prototype.setMinEdgeRing=function(t){this.Vn=t},e.prototype.isLineEdge=function(){var t=this.dn.isLine(0)||this.dn.isLine(1),e=!this.dn.isArea(0)||this.dn.allPositionsEqual(0,tc.EXTERIOR),n=!this.dn.isArea(1)||this.dn.allPositionsEqual(1,tc.EXTERIOR);return t&&e&&n},e.prototype.setEdgeRing=function(t){this.qn=t},e.prototype.getMinEdgeRing=function(){return this.Vn},e.prototype.getDepthDelta=function(){var t=this.Un.getDepthDelta();return this.kn||(t=-t),t},e.prototype.setInResult=function(t){this.pn=t},e.prototype.getSym=function(){return this.Rn},e.prototype.isForward=function(){return this.kn},e.prototype.getEdge=function(){return this.Un},e.prototype.printEdge=function(t){this.print(t),t.print(" "),this.kn?this.Un.print(t):this.Un.printReverse(t)},e.prototype.setSym=function(t){this.Rn=t},e.prototype.setVisitedEdge=function(t){this.setVisited(t),this.Rn.setVisited(t)},e.prototype.setEdgeDepths=function(t,e){var n=this.getEdge().getDepthDelta();this.kn||(n=-n);var r=1;t===Af.LEFT&&(r=-1);var i=Af.opposite(t),s=e+n*r;this.setDepth(t,e),this.setDepth(i,s)},e.prototype.getEdgeRing=function(){return this.qn},e.prototype.isInResult=function(){return this.pn},e.prototype.setNext=function(t){this.Gn=t},e.prototype.isVisited=function(){return this.On},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.depthFactor=function(t,e){return t===tc.EXTERIOR&&e===tc.INTERIOR?1:t===tc.INTERIOR&&e===tc.EXTERIOR?-1:0},e}(Rf),Df=function(){};Df.prototype.createNode=function(t){return new Of(t,null)},Df.prototype.interfaces_=function(){return[]},Df.prototype.getClass=function(){return Df};var Ff=function(){if(this.bn=new Kc,this.gn=null,this._n=new Kc,0===arguments.length)this.gn=new Ef(new Df);else if(1===arguments.length){var t=arguments[0];this.gn=new Ef(t)}};Ff.prototype.printEdges=function(t){t.println("Edges:");for(var e=0;e<this.bn.size();e++){t.println("edge "+e+":");var n=this.bn.get(e);n.print(t),n.eiList.print(t)}},Ff.prototype.find=function(t){return this.gn.find(t)},Ff.prototype.addNode=function(){if(arguments[0]instanceof Of){var t=arguments[0];return this.gn.addNode(t)}if(arguments[0]instanceof Zh){var e=arguments[0];return this.gn.addNode(e)}},Ff.prototype.getNodeIterator=function(){return this.gn.iterator()},Ff.prototype.linkResultDirectedEdges=function(){for(var t=this.gn.iterator();t.hasNext();)t.next().getEdges().linkResultDirectedEdges()},Ff.prototype.debugPrintln=function(t){gc.out.println(t)},Ff.prototype.isBoundaryNode=function(t,e){var n=this.gn.find(e);if(null===n)return!1;var r=n.getLabel();return null!==r&&r.getLocation(t)===tc.BOUNDARY},Ff.prototype.linkAllDirectedEdges=function(){for(var t=this.gn.iterator();t.hasNext();)t.next().getEdges().linkAllDirectedEdges()},Ff.prototype.matchInSameDirection=function(t,e,n,r){return!!t.equals(n)&&Rc.computeOrientation(t,e,r)===Rc.COLLINEAR&&Pf.quadrant(t,e)===Pf.quadrant(n,r)},Ff.prototype.getEdgeEnds=function(){return this._n},Ff.prototype.debugPrint=function(t){gc.out.print(t)},Ff.prototype.getEdgeIterator=function(){return this.bn.iterator()},Ff.prototype.findEdgeInSameDirection=function(t,e){for(var n=0;n<this.bn.size();n++){var r=this.bn.get(n),i=r.getCoordinates();if(this.matchInSameDirection(t,e,i[0],i[1]))return r;if(this.matchInSameDirection(t,e,i[i.length-1],i[i.length-2]))return r}return null},Ff.prototype.insertEdge=function(t){this.bn.add(t)},Ff.prototype.findEdgeEnd=function(t){for(var e=this.getEdgeEnds().iterator();e.hasNext();){var n=e.next();if(n.getEdge()===t)return n}return null},Ff.prototype.addEdges=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this.bn.add(n);var r=new Nf(n,!0),i=new Nf(n,!1);r.setSym(i),i.setSym(r),this.add(r),this.add(i)}},Ff.prototype.add=function(t){this.gn.add(t),this._n.add(t)},Ff.prototype.getNodes=function(){return this.gn.values()},Ff.prototype.findEdge=function(t,e){for(var n=0;n<this.bn.size();n++){var r=this.bn.get(n),i=r.getCoordinates();if(t.equals(i[0])&&e.equals(i[1]))return r}return null},Ff.prototype.interfaces_=function(){return[]},Ff.prototype.getClass=function(){return Ff},Ff.linkResultDirectedEdges=function(t){for(var e=t.iterator();e.hasNext();)e.next().getEdges().linkResultDirectedEdges()};var Lf=function(){this.yn=null,this.Kn=new Kc;var t=arguments[0];this.yn=t};Lf.prototype.sortShellsAndHoles=function(t,e,n){for(var r=t.iterator();r.hasNext();){var i=r.next();i.isHole()?n.add(i):e.add(i)}},Lf.prototype.computePolygons=function(t){for(var e=new Kc,n=t.iterator();n.hasNext();){var r=n.next().toPolygon(this.yn);e.add(r)}return e},Lf.prototype.placeFreeHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();if(null===r.getShell()){var i=this.findEdgeRingContaining(r,t);if(null===i)throw new xf("unable to assign hole to a shell",r.getCoordinate(0));r.setShell(i)}}},Lf.prototype.buildMinimalEdgeRings=function(t,e,n){for(var r=new Kc,i=t.iterator();i.hasNext();){var s=i.next();if(s.getMaxNodeDegree()>2){s.linkDirectedEdgesForMinimalEdgeRings();var o=s.buildMinimalRings(),a=this.findShell(o);null!==a?(this.placePolygonHoles(a,o),e.add(a)):n.addAll(o)}else r.add(s)}return r},Lf.prototype.containsPoint=function(t){for(var e=this.Kn.iterator();e.hasNext();)if(e.next().containsPoint(t))return!0;return!1},Lf.prototype.buildMaximalEdgeRings=function(t){for(var e=new Kc,n=t.iterator();n.hasNext();){var r=n.next();if(r.isInResult()&&r.getLabel().isArea()&&null===r.getEdgeRing()){var i=new If(r,this.yn);e.add(i),i.setInResult()}}return e},Lf.prototype.placePolygonHoles=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();r.isHole()&&r.setShell(t)}},Lf.prototype.getPolygons=function(){return this.computePolygons(this.Kn)},Lf.prototype.findEdgeRingContaining=function(t,e){for(var n=t.getLinearRing(),r=n.getEnvelopeInternal(),i=n.getCoordinateN(0),s=null,o=null,a=e.iterator();a.hasNext();){var l=a.next(),h=l.getLinearRing(),c=h.getEnvelopeInternal();null!==s&&(o=s.getLinearRing().getEnvelopeInternal());var u=!1;c.contains(r)&&Rc.isPointInRing(i,h.getCoordinates())&&(u=!0),u&&(null===s||o.contains(c))&&(s=l)}return s},Lf.prototype.findShell=function(t){for(var e=0,n=null,r=t.iterator();r.hasNext();){var i=r.next();i.isHole()||(n=i,e++)}return Ic.isTrue(e<=1,"found two shells in MinimalEdgeRing list"),n},Lf.prototype.add=function(){if(1===arguments.length){var t=arguments[0];this.add(t.getEdgeEnds(),t.getNodes())}else if(2===arguments.length){var e=arguments[0],n=arguments[1];Ff.linkResultDirectedEdges(n);var r=this.buildMaximalEdgeRings(e),i=new Kc,s=this.buildMinimalEdgeRings(r,this.Kn,i);this.sortShellsAndHoles(s,this.Kn,i),this.placeFreeHoles(this.Kn,i)}},Lf.prototype.interfaces_=function(){return[]},Lf.prototype.getClass=function(){return Lf};var zf=function(){};zf.prototype.getBounds=function(){},zf.prototype.interfaces_=function(){return[]},zf.prototype.getClass=function(){return zf};var Bf=function(){this.Hn=null,this.Jn=null;var t=arguments[0],e=arguments[1];this.Hn=t,this.Jn=e};Bf.prototype.getItem=function(){return this.Jn},Bf.prototype.getBounds=function(){return this.Hn},Bf.prototype.interfaces_=function(){return[zf,Yh]},Bf.prototype.getClass=function(){return Bf};var Hf=function(){this.Zn=null,this.Xn=null,this.Zn=0,this.Xn=new Kc,this.Xn.add(null)};Hf.prototype.poll=function(){if(this.isEmpty())return null;var t=this.Xn.get(1);return this.Xn.set(1,this.Xn.get(this.Zn)),this.Zn-=1,this.reorder(1),t},Hf.prototype.size=function(){return this.Zn},Hf.prototype.reorder=function(t){for(var e=null,n=this.Xn.get(t);2*t<=this.Zn&&((e=2*t)!==this.Zn&&this.Xn.get(e+1).compareTo(this.Xn.get(e))<0&&e++,this.Xn.get(e).compareTo(n)<0);t=e)this.Xn.set(t,this.Xn.get(e));this.Xn.set(t,n)},Hf.prototype.clear=function(){this.Zn=0,this.Xn.clear()},Hf.prototype.isEmpty=function(){return 0===this.Zn},Hf.prototype.add=function(t){this.Xn.add(null),this.Zn+=1;var e=this.Zn;for(this.Xn.set(0,t);t.compareTo(this.Xn.get(Math.trunc(e/2)))<0;e/=2)this.Xn.set(e,this.Xn.get(Math.trunc(e/2)));this.Xn.set(e,t)},Hf.prototype.interfaces_=function(){return[]},Hf.prototype.getClass=function(){return Hf};var Uf=function(){};Uf.prototype.visitItem=function(t){},Uf.prototype.interfaces_=function(){return[]},Uf.prototype.getClass=function(){return Uf};var jf=function(){};jf.prototype.insert=function(t,e){},jf.prototype.remove=function(t,e){},jf.prototype.query=function(){},jf.prototype.interfaces_=function(){return[]},jf.prototype.getClass=function(){return jf};var Vf=function(){if(this.$n=new Kc,this.Hn=null,this.Ai=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.Ai=t}},Gf={serialVersionUID:{configurable:!0}};Vf.prototype.getLevel=function(){return this.Ai},Vf.prototype.size=function(){return this.$n.size()},Vf.prototype.getChildBoundables=function(){return this.$n},Vf.prototype.addChildBoundable=function(t){Ic.isTrue(null===this.Hn),this.$n.add(t)},Vf.prototype.isEmpty=function(){return this.$n.isEmpty()},Vf.prototype.getBounds=function(){return null===this.Hn&&(this.Hn=this.computeBounds()),this.Hn},Vf.prototype.interfaces_=function(){return[zf,Yh]},Vf.prototype.getClass=function(){return Vf},Gf.serialVersionUID.get=function(){return 0x5a1e55ec41369800},Object.defineProperties(Vf,Gf);var qf=function(){};qf.reverseOrder=function(){return{compare:function(t,e){return e.compareTo(t)}}},qf.min=function(t){return qf.sort(t),t.get(0)},qf.sort=function(t,e){var n=t.toArray();e?xu.sort(n,e):xu.sort(n);for(var r=t.iterator(),i=0,s=n.length;i<s;i++)r.next(),r.set(n[i])},qf.singletonList=function(t){var e=new Kc;return e.add(t),e};var Wf=function(){this.ti=null,this.ni=null,this.ii=null,this.ri=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.ti=t,this.ni=e,this.ri=n,this.ii=this.distance()};Wf.prototype.expandToQueue=function(t,e){var n=Wf.isComposite(this.ti),r=Wf.isComposite(this.ni);if(n&&r)return Wf.area(this.ti)>Wf.area(this.ni)?(this.expand(this.ti,this.ni,t,e),null):(this.expand(this.ni,this.ti,t,e),null);if(n)return this.expand(this.ti,this.ni,t,e),null;if(r)return this.expand(this.ni,this.ti,t,e),null;throw new Vh("neither boundable is composite")},Wf.prototype.isLeaves=function(){return!(Wf.isComposite(this.ti)||Wf.isComposite(this.ni))},Wf.prototype.compareTo=function(t){var e=t;return this.ii<e.ii?-1:this.ii>e.ii?1:0},Wf.prototype.expand=function(t,e,n,r){for(var i=t.getChildBoundables().iterator();i.hasNext();){var s=i.next(),o=new Wf(s,e,this.ri);o.getDistance()<r&&n.add(o)}},Wf.prototype.getBoundable=function(t){return 0===t?this.ti:this.ni},Wf.prototype.getDistance=function(){return this.ii},Wf.prototype.distance=function(){return this.isLeaves()?this.ri.distance(this.ti,this.ni):this.ti.getBounds().distance(this.ni.getBounds())},Wf.prototype.interfaces_=function(){return[Wh]},Wf.prototype.getClass=function(){return Wf},Wf.area=function(t){return t.getBounds().getArea()},Wf.isComposite=function(t){return t instanceof Vf};var Xf=function t(){if(this.ei=null,this.si=!1,this.ui=new Kc,this.oi=null,0===arguments.length){var e=t.DEFAULT_NODE_CAPACITY;this.oi=e}else if(1===arguments.length){var n=arguments[0];Ic.isTrue(n>1,"Node capacity must be greater than 1"),this.oi=n}},Qf={IntersectsOp:{configurable:!0},serialVersionUID:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};Xf.prototype.getNodeCapacity=function(){return this.oi},Xf.prototype.lastNode=function(t){return t.get(t.size()-1)},Xf.prototype.size=function(){var t=this;if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.size(this.ei));if(1===arguments.length){for(var e=arguments[0],n=0,r=e.getChildBoundables().iterator();r.hasNext();){var i=r.next();i instanceof Vf?n+=t.size(i):i instanceof Bf&&(n+=1)}return n}},Xf.prototype.removeItem=function(t,e){for(var n=null,r=t.getChildBoundables().iterator();r.hasNext();){var i=r.next();i instanceof Bf&&i.getItem()===e&&(n=i)}return null!==n&&(t.getChildBoundables().remove(n),!0)},Xf.prototype.itemsTree=function(){var t=this;if(0===arguments.length){this.build();var e=this.itemsTree(this.ei);return null===e?new Kc:e}if(1===arguments.length){for(var n=arguments[0],r=new Kc,i=n.getChildBoundables().iterator();i.hasNext();){var s=i.next();if(s instanceof Vf){var o=t.itemsTree(s);null!==o&&r.add(o)}else s instanceof Bf?r.add(s.getItem()):Ic.shouldNeverReachHere()}return r.size()<=0?null:r}},Xf.prototype.insert=function(t,e){Ic.isTrue(!this.si,"Cannot insert items into an STR packed R-tree after it has been built."),this.ui.add(new Bf(t,e))},Xf.prototype.boundablesAtLevel=function(){var t=this;if(1===arguments.length){var e=arguments[0],n=new Kc;return this.boundablesAtLevel(e,this.ei,n),n}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2];if(Ic.isTrue(r>-2),i.getLevel()===r)return s.add(i),null;for(var o=i.getChildBoundables().iterator();o.hasNext();){var a=o.next();a instanceof Vf?t.boundablesAtLevel(r,a,s):(Ic.isTrue(a instanceof Bf),-1===r&&s.add(a))}return null}},Xf.prototype.query=function(){var t=this;if(1===arguments.length){var e=arguments[0];this.build();var n=new Kc;return this.isEmpty()||this.getIntersectsOp().intersects(this.ei.getBounds(),e)&&this.query(e,this.ei,n),n}if(2===arguments.length){var r=arguments[0],i=arguments[1];if(this.build(),this.isEmpty())return null;this.getIntersectsOp().intersects(this.ei.getBounds(),r)&&this.query(r,this.ei,i)}else if(3===arguments.length)if(nc(arguments[2],Uf)&&arguments[0]instanceof Object&&arguments[1]instanceof Vf)for(var s=arguments[0],o=arguments[1],a=arguments[2],l=o.getChildBoundables(),h=0;h<l.size();h++){var c=l.get(h);t.getIntersectsOp().intersects(c.getBounds(),s)&&(c instanceof Vf?t.query(s,c,a):c instanceof Bf?a.visitItem(c.getItem()):Ic.shouldNeverReachHere())}else if(nc(arguments[2],Yc)&&arguments[0]instanceof Object&&arguments[1]instanceof Vf)for(var u=arguments[0],f=arguments[1],d=arguments[2],p=f.getChildBoundables(),A=0;A<p.size();A++){var g=p.get(A);t.getIntersectsOp().intersects(g.getBounds(),u)&&(g instanceof Vf?t.query(u,g,d):g instanceof Bf?d.add(g.getItem()):Ic.shouldNeverReachHere())}},Xf.prototype.build=function(){if(this.si)return null;this.ei=this.ui.isEmpty()?this.createNode(0):this.createHigherLevels(this.ui,-1),this.ui=null,this.si=!0},Xf.prototype.getRoot=function(){return this.build(),this.ei},Xf.prototype.remove=function(){var t=this;if(2===arguments.length){var e=arguments[0],n=arguments[1];return this.build(),!!this.getIntersectsOp().intersects(this.ei.getBounds(),e)&&this.remove(e,this.ei,n)}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2],o=this.removeItem(i,s);if(o)return!0;for(var a=null,l=i.getChildBoundables().iterator();l.hasNext();){var h=l.next();if(t.getIntersectsOp().intersects(h.getBounds(),r)&&h instanceof Vf&&(o=t.remove(r,h,s))){a=h;break}}return null!==a&&a.getChildBoundables().isEmpty()&&i.getChildBoundables().remove(a),o}},Xf.prototype.createHigherLevels=function(t,e){Ic.isTrue(!t.isEmpty());var n=this.createParentBoundables(t,e+1);return 1===n.size()?n.get(0):this.createHigherLevels(n,e+1)},Xf.prototype.depth=function(){var t=this;if(0===arguments.length)return this.isEmpty()?0:(this.build(),this.depth(this.ei));if(1===arguments.length){for(var e=arguments[0],n=0,r=e.getChildBoundables().iterator();r.hasNext();){var i=r.next();if(i instanceof Vf){var s=t.depth(i);s>n&&(n=s)}}return n+1}},Xf.prototype.createParentBoundables=function(t,e){Ic.isTrue(!t.isEmpty());var n=new Kc;n.add(this.createNode(e));var r=new Kc(t);qf.sort(r,this.getComparator());for(var i=r.iterator();i.hasNext();){var s=i.next();this.lastNode(n).getChildBoundables().size()===this.getNodeCapacity()&&n.add(this.createNode(e)),this.lastNode(n).addChildBoundable(s)}return n},Xf.prototype.isEmpty=function(){return this.si?this.ei.isEmpty():this.ui.isEmpty()},Xf.prototype.interfaces_=function(){return[Yh]},Xf.prototype.getClass=function(){return Xf},Xf.compareDoubles=function(t,e){return t>e?1:t<e?-1:0},Qf.IntersectsOp.get=function(){return Yf},Qf.serialVersionUID.get=function(){return-0x35ef64c82d4c5400},Qf.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(Xf,Qf);var Yf=function(){},Zf=function(){};Zf.prototype.distance=function(t,e){},Zf.prototype.interfaces_=function(){return[]},Zf.prototype.getClass=function(){return Zf};var Kf=function(t){function e(n){n=n||e.DEFAULT_NODE_CAPACITY,t.call(this,n)}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={STRtreeNode:{configurable:!0},serialVersionUID:{configurable:!0},xComparator:{configurable:!0},yComparator:{configurable:!0},intersectsOp:{configurable:!0},DEFAULT_NODE_CAPACITY:{configurable:!0}};return e.prototype.createParentBoundablesFromVerticalSlices=function(t,e){Ic.isTrue(t.length>0);for(var n=new Kc,r=0;r<t.length;r++)n.addAll(this.createParentBoundablesFromVerticalSlice(t[r],e));return n},e.prototype.createNode=function(t){return new Jf(t)},e.prototype.size=function(){return 0===arguments.length?t.prototype.size.call(this):t.prototype.size.apply(this,arguments)},e.prototype.insert=function(){if(2!==arguments.length)return t.prototype.insert.apply(this,arguments);var e=arguments[0],n=arguments[1];if(e.isNull())return null;t.prototype.insert.call(this,e,n)},e.prototype.getIntersectsOp=function(){return e.intersectsOp},e.prototype.verticalSlices=function(t,e){for(var n=Math.trunc(Math.ceil(t.size()/e)),r=new Array(e).fill(null),i=t.iterator(),s=0;s<e;s++){r[s]=new Kc;for(var o=0;i.hasNext()&&o<n;){var a=i.next();r[s].add(a),o++}}return r},e.prototype.query=function(){if(1===arguments.length){var e=arguments[0];return t.prototype.query.call(this,e)}if(2===arguments.length){var n=arguments[0],r=arguments[1];t.prototype.query.call(this,n,r)}else if(3===arguments.length)if(nc(arguments[2],Uf)&&arguments[0]instanceof Object&&arguments[1]instanceof Vf){var i=arguments[0],s=arguments[1],o=arguments[2];t.prototype.query.call(this,i,s,o)}else if(nc(arguments[2],Yc)&&arguments[0]instanceof Object&&arguments[1]instanceof Vf){var a=arguments[0],l=arguments[1],h=arguments[2];t.prototype.query.call(this,a,l,h)}},e.prototype.getComparator=function(){return e.yComparator},e.prototype.createParentBoundablesFromVerticalSlice=function(e,n){return t.prototype.createParentBoundables.call(this,e,n)},e.prototype.remove=function(){if(2===arguments.length){var e=arguments[0],n=arguments[1];return t.prototype.remove.call(this,e,n)}return t.prototype.remove.apply(this,arguments)},e.prototype.depth=function(){return 0===arguments.length?t.prototype.depth.call(this):t.prototype.depth.apply(this,arguments)},e.prototype.createParentBoundables=function(t,n){Ic.isTrue(!t.isEmpty());var r=Math.trunc(Math.ceil(t.size()/this.getNodeCapacity())),i=new Kc(t);qf.sort(i,e.xComparator);var s=this.verticalSlices(i,Math.trunc(Math.ceil(Math.sqrt(r))));return this.createParentBoundablesFromVerticalSlices(s,n)},e.prototype.nearestNeighbour=function(){if(1===arguments.length){if(nc(arguments[0],Zf)){var t=arguments[0],n=new Wf(this.getRoot(),this.getRoot(),t);return this.nearestNeighbour(n)}if(arguments[0]instanceof Wf){var r=arguments[0];return this.nearestNeighbour(r,Gh.POSITIVE_INFINITY)}}else if(2===arguments.length){if(arguments[0]instanceof e&&nc(arguments[1],Zf)){var i=arguments[0],s=arguments[1],o=new Wf(this.getRoot(),i.getRoot(),s);return this.nearestNeighbour(o)}if(arguments[0]instanceof Wf&&"number"==typeof arguments[1]){var a=arguments[0],l=arguments[1],h=l,c=null,u=new Hf;for(u.add(a);!u.isEmpty()&&h>0;){var f=u.poll(),d=f.getDistance();if(d>=h)break;f.isLeaves()?(h=d,c=f):f.expandToQueue(u,h)}return[c.getBoundable(0).getItem(),c.getBoundable(1).getItem()]}}else if(3===arguments.length){var p=arguments[0],A=arguments[1],g=arguments[2],m=new Bf(p,A),y=new Wf(this.getRoot(),m,g);return this.nearestNeighbour(y)[0]}},e.prototype.interfaces_=function(){return[jf,Yh]},e.prototype.getClass=function(){return e},e.centreX=function(t){return e.avg(t.getMinX(),t.getMaxX())},e.avg=function(t,e){return(t+e)/2},e.centreY=function(t){return e.avg(t.getMinY(),t.getMaxY())},n.STRtreeNode.get=function(){return Jf},n.serialVersionUID.get=function(){return 0x39920f7d5f261e0},n.xComparator.get=function(){return{interfaces_:function(){return[Qh]},compare:function(n,r){return t.compareDoubles(e.centreX(n.getBounds()),e.centreX(r.getBounds()))}}},n.yComparator.get=function(){return{interfaces_:function(){return[Qh]},compare:function(n,r){return t.compareDoubles(e.centreY(n.getBounds()),e.centreY(r.getBounds()))}}},n.intersectsOp.get=function(){return{interfaces_:function(){return[t.IntersectsOp]},intersects:function(t,e){return t.intersects(e)}}},n.DEFAULT_NODE_CAPACITY.get=function(){return 10},Object.defineProperties(e,n),e}(Xf),Jf=function(t){function e(){var e=arguments[0];t.call(this,e)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.computeBounds=function(){for(var t=null,e=this.getChildBoundables().iterator();e.hasNext();){var n=e.next();null===t?t=new yc(n.getBounds()):t.expandToInclude(n.getBounds())}return t},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Vf),$f=function(){};$f.prototype.interfaces_=function(){return[]},$f.prototype.getClass=function(){return $f},$f.relativeSign=function(t,e){return t<e?-1:t>e?1:0},$f.compare=function(t,e,n){if(e.equals2D(n))return 0;var r=$f.relativeSign(e.x,n.x),i=$f.relativeSign(e.y,n.y);switch(t){case 0:return $f.compareValue(r,i);case 1:return $f.compareValue(i,r);case 2:return $f.compareValue(i,-r);case 3:return $f.compareValue(-r,i);case 4:return $f.compareValue(-r,-i);case 5:return $f.compareValue(-i,-r);case 6:return $f.compareValue(-i,r);case 7:return $f.compareValue(r,-i)}return Ic.shouldNeverReachHere("invalid octant value"),0},$f.compareValue=function(t,e){return t<0?-1:t>0?1:e<0?-1:e>0?1:0};var td=function(){this.hi=null,this.coord=null,this.segmentIndex=null,this.fi=null,this.ci=null;var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.hi=t,this.coord=new Zh(e),this.segmentIndex=n,this.fi=r,this.ci=!e.equals2D(t.getCoordinate(n))};td.prototype.getCoordinate=function(){return this.coord},td.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex)},td.prototype.compareTo=function(t){var e=t;return this.segmentIndex<e.segmentIndex?-1:this.segmentIndex>e.segmentIndex?1:this.coord.equals2D(e.coord)?0:$f.compare(this.fi,this.coord,e.coord)},td.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&!this.ci||this.segmentIndex===t},td.prototype.isInterior=function(){return this.ci},td.prototype.interfaces_=function(){return[Wh]},td.prototype.getClass=function(){return td};var ed=function(){this.ai=new Au,this.Un=null;var t=arguments[0];this.Un=t};ed.prototype.getSplitCoordinates=function(){var t=new $c;this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next();this.addEdgeCoordinates(n,r,t),n=r}return t.toCoordinateArray()},ed.prototype.addCollapsedNodes=function(){var t=new Kc;this.findCollapsesFromInsertedNodes(t),this.findCollapsesFromExistingVertices(t);for(var e=t.iterator();e.hasNext();){var n=e.next().intValue();this.add(this.Un.getCoordinate(n),n)}},ed.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},ed.prototype.findCollapsesFromExistingVertices=function(t){for(var e=0;e<this.Un.size()-2;e++){var n=this.Un.getCoordinate(e),r=this.Un.getCoordinate(e+2);n.equals2D(r)&&t.add(new oc(e+1))}},ed.prototype.addEdgeCoordinates=function(t,e,n){var r=this.Un.getCoordinate(e.segmentIndex),i=e.isInterior()||!e.coord.equals2D(r);n.add(new Zh(t.coord),!1);for(var s=t.segmentIndex+1;s<=e.segmentIndex;s++)n.add(this.Un.getCoordinate(s));i&&n.add(new Zh(e.coord))},ed.prototype.iterator=function(){return this.ai.values().iterator()},ed.prototype.addSplitEdges=function(t){this.addEndpoints(),this.addCollapsedNodes();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next(),i=this.createSplitEdge(n,r);t.add(i),n=r}},ed.prototype.findCollapseIndex=function(t,e,n){if(!t.coord.equals2D(e.coord))return!1;var r=e.segmentIndex-t.segmentIndex;return e.isInterior()||r--,1===r&&(n[0]=t.segmentIndex+1,!0)},ed.prototype.findCollapsesFromInsertedNodes=function(t){for(var e=new Array(1).fill(null),n=this.iterator(),r=n.next();n.hasNext();){var i=n.next();this.findCollapseIndex(r,i,e)&&t.add(new oc(e[0])),r=i}},ed.prototype.getEdge=function(){return this.Un},ed.prototype.addEndpoints=function(){var t=this.Un.size()-1;this.add(this.Un.getCoordinate(0),0),this.add(this.Un.getCoordinate(t),t)},ed.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,r=this.Un.getCoordinate(e.segmentIndex),i=e.isInterior()||!e.coord.equals2D(r);i||n--;var s=new Array(n).fill(null),o=0;s[o++]=new Zh(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)s[o++]=this.Un.getCoordinate(a);return i&&(s[o]=new Zh(e.coord)),new sd(s,this.Un.getData())},ed.prototype.add=function(t,e){var n=new td(this.Un,t,e,this.Un.getSegmentOctant(e)),r=this.ai.get(n);return null!==r?(Ic.isTrue(r.coord.equals2D(t),"Found equal nodes with different coordinates"),r):(this.ai.put(n,n),n)},ed.prototype.checkSplitEdgesCorrectness=function(t){var e=this.Un.getCoordinates(),n=t.get(0).getCoordinate(0);if(!n.equals2D(e[0]))throw new Tc("bad split edge start point at "+n);var r=t.get(t.size()-1).getCoordinates(),i=r[r.length-1];if(!i.equals2D(e[e.length-1]))throw new Tc("bad split edge end point at "+i)},ed.prototype.interfaces_=function(){return[]},ed.prototype.getClass=function(){return ed};var nd=function(){};nd.prototype.interfaces_=function(){return[]},nd.prototype.getClass=function(){return nd},nd.octant=function(){if("number"==typeof arguments[0]&&"number"==typeof arguments[1]){var t=arguments[0],e=arguments[1];if(0===t&&0===e)throw new Vh("Cannot compute the octant for point ( "+t+", "+e+" )");var n=Math.abs(t),r=Math.abs(e);return t>=0?e>=0?n>=r?0:1:n>=r?7:6:e>=0?n>=r?3:2:n>=r?4:5}if(arguments[0]instanceof Zh&&arguments[1]instanceof Zh){var i=arguments[0],s=arguments[1],o=s.x-i.x,a=s.y-i.y;if(0===o&&0===a)throw new Vh("Cannot compute the octant for two identical points "+i);return nd.octant(o,a)}};var rd=function(){};rd.prototype.getCoordinates=function(){},rd.prototype.size=function(){},rd.prototype.getCoordinate=function(t){},rd.prototype.isClosed=function(){},rd.prototype.setData=function(t){},rd.prototype.getData=function(){},rd.prototype.interfaces_=function(){return[]},rd.prototype.getClass=function(){return rd};var id=function(){};id.prototype.addIntersection=function(t,e){},id.prototype.interfaces_=function(){return[rd]},id.prototype.getClass=function(){return id};var sd=function(){this.vi=new ed(this),this.zn=null,this.li=null;var t=arguments[0],e=arguments[1];this.zn=t,this.li=e};sd.prototype.getCoordinates=function(){return this.zn},sd.prototype.size=function(){return this.zn.length},sd.prototype.getCoordinate=function(t){return this.zn[t]},sd.prototype.isClosed=function(){return this.zn[0].equals(this.zn[this.zn.length-1])},sd.prototype.getSegmentOctant=function(t){return t===this.zn.length-1?-1:this.safeOctant(this.getCoordinate(t),this.getCoordinate(t+1))},sd.prototype.setData=function(t){this.li=t},sd.prototype.safeOctant=function(t,e){return t.equals2D(e)?0:nd.octant(t,e)},sd.prototype.getData=function(){return this.li},sd.prototype.addIntersection=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];this.addIntersectionNode(t,e)}else if(4===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[3],s=new Zh(n.getIntersection(i));this.addIntersection(s,r)}},sd.prototype.toString=function(){return Mc.toLineString(new Ku(this.zn))},sd.prototype.getNodeList=function(){return this.vi},sd.prototype.addIntersectionNode=function(t,e){var n=e,r=n+1;if(r<this.zn.length){var i=this.zn[r];t.equals2D(i)&&(n=r)}return this.vi.add(t,n)},sd.prototype.addIntersections=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++)this.addIntersection(t,e,n,r)},sd.prototype.interfaces_=function(){return[id]},sd.prototype.getClass=function(){return sd},sd.getNodedSubstrings=function(){if(1===arguments.length){var t=arguments[0],e=new Kc;return sd.getNodedSubstrings(t,e),e}if(2===arguments.length)for(var n=arguments[0],r=arguments[1],i=n.iterator();i.hasNext();){var s=i.next();s.getNodeList().addSplitEdges(r)}};var od=function(){if(this.p0=null,this.p1=null,0===arguments.length)this.p0=new Zh,this.p1=new Zh;else if(1===arguments.length){var t=arguments[0];this.p0=new Zh(t.p0),this.p1=new Zh(t.p1)}else if(2===arguments.length)this.p0=arguments[0],this.p1=arguments[1];else if(4===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2],i=arguments[3];this.p0=new Zh(e,n),this.p1=new Zh(r,i)}},ad={serialVersionUID:{configurable:!0}};od.prototype.minX=function(){return Math.min(this.p0.x,this.p1.x)},od.prototype.orientationIndex=function(){if(arguments[0]instanceof od){var t=arguments[0],e=Rc.orientationIndex(this.p0,this.p1,t.p0),n=Rc.orientationIndex(this.p0,this.p1,t.p1);return e>=0&&n>=0||e<=0&&n<=0?Math.max(e,n):0}if(arguments[0]instanceof Zh){var r=arguments[0];return Rc.orientationIndex(this.p0,this.p1,r)}},od.prototype.toGeometry=function(t){return t.createLineString([this.p0,this.p1])},od.prototype.isVertical=function(){return this.p0.x===this.p1.x},od.prototype.equals=function(t){if(!(t instanceof od))return!1;var e=t;return this.p0.equals(e.p0)&&this.p1.equals(e.p1)},od.prototype.intersection=function(t){var e=new Ec;return e.computeIntersection(this.p0,this.p1,t.p0,t.p1),e.hasIntersection()?e.getIntersection(0):null},od.prototype.project=function(){if(arguments[0]instanceof Zh){var t=arguments[0];if(t.equals(this.p0)||t.equals(this.p1))return new Zh(t);var e=this.projectionFactor(t),n=new Zh;return n.x=this.p0.x+e*(this.p1.x-this.p0.x),n.y=this.p0.y+e*(this.p1.y-this.p0.y),n}if(arguments[0]instanceof od){var r=arguments[0],i=this.projectionFactor(r.p0),s=this.projectionFactor(r.p1);if(i>=1&&s>=1)return null;if(i<=0&&s<=0)return null;var o=this.project(r.p0);i<0&&(o=this.p0),i>1&&(o=this.p1);var a=this.project(r.p1);return s<0&&(a=this.p0),s>1&&(a=this.p1),new od(o,a)}},od.prototype.normalize=function(){this.p1.compareTo(this.p0)<0&&this.reverse()},od.prototype.angle=function(){return Math.atan2(this.p1.y-this.p0.y,this.p1.x-this.p0.x)},od.prototype.getCoordinate=function(t){return 0===t?this.p0:this.p1},od.prototype.distancePerpendicular=function(t){return Rc.distancePointLinePerpendicular(t,this.p0,this.p1)},od.prototype.minY=function(){return Math.min(this.p0.y,this.p1.y)},od.prototype.midPoint=function(){return od.midPoint(this.p0,this.p1)},od.prototype.projectionFactor=function(t){if(t.equals(this.p0))return 0;if(t.equals(this.p1))return 1;var e=this.p1.x-this.p0.x,n=this.p1.y-this.p0.y,r=e*e+n*n;return r<=0?Gh.NaN:((t.x-this.p0.x)*e+(t.y-this.p0.y)*n)/r},od.prototype.closestPoints=function(t){var e=this.intersection(t);if(null!==e)return[e,e];var n=new Array(2).fill(null),r=Gh.MAX_VALUE,i=null,s=this.closestPoint(t.p0);r=s.distance(t.p0),n[0]=s,n[1]=t.p0;var o=this.closestPoint(t.p1);(i=o.distance(t.p1))<r&&(r=i,n[0]=o,n[1]=t.p1);var a=t.closestPoint(this.p0);(i=a.distance(this.p0))<r&&(r=i,n[0]=this.p0,n[1]=a);var l=t.closestPoint(this.p1);return(i=l.distance(this.p1))<r&&(r=i,n[0]=this.p1,n[1]=l),n},od.prototype.closestPoint=function(t){var e=this.projectionFactor(t);return e>0&&e<1?this.project(t):this.p0.distance(t)<this.p1.distance(t)?this.p0:this.p1},od.prototype.maxX=function(){return Math.max(this.p0.x,this.p1.x)},od.prototype.getLength=function(){return this.p0.distance(this.p1)},od.prototype.compareTo=function(t){var e=t,n=this.p0.compareTo(e.p0);return 0!==n?n:this.p1.compareTo(e.p1)},od.prototype.reverse=function(){var t=this.p0;this.p0=this.p1,this.p1=t},od.prototype.equalsTopo=function(t){return this.p0.equals(t.p0)&&(this.p1.equals(t.p1)||this.p0.equals(t.p1))&&this.p1.equals(t.p0)},od.prototype.lineIntersection=function(t){try{return mc.intersection(this.p0,this.p1,t.p0,t.p1)}catch(t){if(!(t instanceof Ac))throw t}return null},od.prototype.maxY=function(){return Math.max(this.p0.y,this.p1.y)},od.prototype.pointAlongOffset=function(t,e){var n=this.p0.x+t*(this.p1.x-this.p0.x),r=this.p0.y+t*(this.p1.y-this.p0.y),i=this.p1.x-this.p0.x,s=this.p1.y-this.p0.y,o=Math.sqrt(i*i+s*s),a=0,l=0;if(0!==e){if(o<=0)throw new Error("Cannot compute offset from zero-length line segment");a=e*i/o,l=e*s/o}return new Zh(n-l,r+a)},od.prototype.setCoordinates=function(){if(1===arguments.length){var t=arguments[0];this.setCoordinates(t.p0,t.p1)}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.p0.x=e.x,this.p0.y=e.y,this.p1.x=n.x,this.p1.y=n.y}},od.prototype.segmentFraction=function(t){var e=this.projectionFactor(t);return e<0?e=0:(e>1||Gh.isNaN(e))&&(e=1),e},od.prototype.toString=function(){return"LINESTRING( "+this.p0.x+" "+this.p0.y+", "+this.p1.x+" "+this.p1.y+")"},od.prototype.isHorizontal=function(){return this.p0.y===this.p1.y},od.prototype.distance=function(){if(arguments[0]instanceof od){var t=arguments[0];return Rc.distanceLineLine(this.p0,this.p1,t.p0,t.p1)}if(arguments[0]instanceof Zh){var e=arguments[0];return Rc.distancePointLine(e,this.p0,this.p1)}},od.prototype.pointAlong=function(t){var e=new Zh;return e.x=this.p0.x+t*(this.p1.x-this.p0.x),e.y=this.p0.y+t*(this.p1.y-this.p0.y),e},od.prototype.hashCode=function(){var t=Gh.doubleToLongBits(this.p0.x);t^=31*Gh.doubleToLongBits(this.p0.y);var e=Math.trunc(t)^Math.trunc(t>>32),n=Gh.doubleToLongBits(this.p1.x);return n^=31*Gh.doubleToLongBits(this.p1.y),e^Math.trunc(n)^Math.trunc(n>>32)},od.prototype.interfaces_=function(){return[Wh,Yh]},od.prototype.getClass=function(){return od},od.midPoint=function(t,e){return new Zh((t.x+e.x)/2,(t.y+e.y)/2)},ad.serialVersionUID.get=function(){return 0x2d2172135f411c00},Object.defineProperties(od,ad);var ld=function(){this.tempEnv1=new yc,this.tempEnv2=new yc,this.wi=new od,this.Pi=new od};ld.prototype.overlap=function(){if(2===arguments.length);else if(4===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];t.getLineSegment(e,this.wi),n.getLineSegment(r,this.Pi),this.overlap(this.wi,this.Pi)}},ld.prototype.interfaces_=function(){return[]},ld.prototype.getClass=function(){return ld};var hd=function(){this.zn=null,this.gi=null,this.Ci=null,this.Dn=null,this.Di=null,this.Ii=null;var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.zn=t,this.gi=e,this.Ci=n,this.Di=r};hd.prototype.getLineSegment=function(t,e){e.p0=this.zn[t],e.p1=this.zn[t+1]},hd.prototype.computeSelect=function(t,e,n,r){var i=this.zn[e],s=this.zn[n];if(r.tempEnv1.init(i,s),n-e==1)return r.select(this,e),null;if(!t.intersects(r.tempEnv1))return null;var o=Math.trunc((e+n)/2);e<o&&this.computeSelect(t,e,o,r),o<n&&this.computeSelect(t,o,n,r)},hd.prototype.getCoordinates=function(){for(var t=new Array(this.Ci-this.gi+1).fill(null),e=0,n=this.gi;n<=this.Ci;n++)t[e++]=this.zn[n];return t},hd.prototype.computeOverlaps=function(t,e){this.computeOverlapsInternal(this.gi,this.Ci,t,t.gi,t.Ci,e)},hd.prototype.setId=function(t){this.Ii=t},hd.prototype.select=function(t,e){this.computeSelect(t,this.gi,this.Ci,e)},hd.prototype.getEnvelope=function(){if(null===this.Dn){var t=this.zn[this.gi],e=this.zn[this.Ci];this.Dn=new yc(t,e)}return this.Dn},hd.prototype.getEndIndex=function(){return this.Ci},hd.prototype.getStartIndex=function(){return this.gi},hd.prototype.getContext=function(){return this.Di},hd.prototype.getId=function(){return this.Ii},hd.prototype.computeOverlapsInternal=function(t,e,n,r,i,s){var o=this.zn[t],a=this.zn[e],l=n.zn[r],h=n.zn[i];if(e-t==1&&i-r==1)return s.overlap(this,t,n,r),null;if(s.tempEnv1.init(o,a),s.tempEnv2.init(l,h),!s.tempEnv1.intersects(s.tempEnv2))return null;var c=Math.trunc((t+e)/2),u=Math.trunc((r+i)/2);t<c&&(r<u&&this.computeOverlapsInternal(t,c,n,r,u,s),u<i&&this.computeOverlapsInternal(t,c,n,u,i,s)),c<e&&(r<u&&this.computeOverlapsInternal(c,e,n,r,u,s),u<i&&this.computeOverlapsInternal(c,e,n,u,i,s))},hd.prototype.interfaces_=function(){return[]},hd.prototype.getClass=function(){return hd};var cd=function(){};cd.prototype.interfaces_=function(){return[]},cd.prototype.getClass=function(){return cd},cd.getChainStartIndices=function(t){var e=0,n=new Kc;n.add(new oc(e));do{var r=cd.findChainEnd(t,e);n.add(new oc(r)),e=r}while(e<t.length-1);return cd.toIntArray(n)},cd.findChainEnd=function(t,e){for(var n=e;n<t.length-1&&t[n].equals2D(t[n+1]);)n++;if(n>=t.length-1)return t.length-1;for(var r=Pf.quadrant(t[n],t[n+1]),i=e+1;i<t.length;){if(!t[i-1].equals2D(t[i])&&Pf.quadrant(t[i-1],t[i])!==r)break;i++}return i-1},cd.getChains=function(){if(1===arguments.length){var t=arguments[0];return cd.getChains(t,null)}if(2===arguments.length){for(var e=arguments[0],n=arguments[1],r=new Kc,i=cd.getChainStartIndices(e),s=0;s<i.length-1;s++){var o=new hd(e,i[s],i[s+1],n);r.add(o)}return r}},cd.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var ud=function(){};ud.prototype.computeNodes=function(t){},ud.prototype.getNodedSubstrings=function(){},ud.prototype.interfaces_=function(){return[]},ud.prototype.getClass=function(){return ud};var fd=function(){if(this.Mi=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];this.setSegmentIntersector(t)}};fd.prototype.setSegmentIntersector=function(t){this.Mi=t},fd.prototype.interfaces_=function(){return[ud]},fd.prototype.getClass=function(){return fd};var dd=function(t){function e(e){e?t.call(this,e):t.call(this),this.bi=new Kc,this.zi=new Kf,this.di=0,this.xi=null,this.mi=0}t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e;var n={SegmentOverlapAction:{configurable:!0}};return e.prototype.getMonotoneChains=function(){return this.bi},e.prototype.getNodedSubstrings=function(){return sd.getNodedSubstrings(this.xi)},e.prototype.getIndex=function(){return this.zi},e.prototype.add=function(t){for(var e=cd.getChains(t.getCoordinates(),t).iterator();e.hasNext();){var n=e.next();n.setId(this.di++),this.zi.insert(n.getEnvelope(),n),this.bi.add(n)}},e.prototype.computeNodes=function(t){this.xi=t;for(var e=t.iterator();e.hasNext();)this.add(e.next());this.intersectChains()},e.prototype.intersectChains=function(){for(var t=new pd(this.Mi),e=this.bi.iterator();e.hasNext();)for(var n=e.next(),r=this.zi.query(n.getEnvelope()).iterator();r.hasNext();){var i=r.next();if(i.getId()>n.getId()&&(n.computeOverlaps(i,t),this.mi++),this.Mi.isDone())return null}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},n.SegmentOverlapAction.get=function(){return pd},Object.defineProperties(e,n),e}(fd),pd=function(t){function e(){t.call(this),this.yi=null;var e=arguments[0];this.yi=e}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.overlap=function(){if(4!==arguments.length)return t.prototype.overlap.apply(this,arguments);var e=arguments[0],n=arguments[1],r=arguments[2],i=arguments[3],s=e.getContext(),o=r.getContext();this.yi.processIntersections(s,n,o,i)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(ld),Ad=function t(){if(this.pi=t.DEFAULT_QUADRANT_SEGMENTS,this.Li=t.CAP_ROUND,this.Ti=t.JOIN_ROUND,this.Oi=t.DEFAULT_MITRE_LIMIT,this.Fi=!1,this.Ui=t.DEFAULT_SIMPLIFY_FACTOR,0===arguments.length);else if(1===arguments.length){var e=arguments[0];this.setQuadrantSegments(e)}else if(2===arguments.length){var n=arguments[0],r=arguments[1];this.setQuadrantSegments(n),this.setEndCapStyle(r)}else if(4===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3];this.setQuadrantSegments(i),this.setEndCapStyle(s),this.setJoinStyle(o),this.setMitreLimit(a)}},gd={CAP_ROUND:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},JOIN_ROUND:{configurable:!0},JOIN_MITRE:{configurable:!0},JOIN_BEVEL:{configurable:!0},DEFAULT_QUADRANT_SEGMENTS:{configurable:!0},DEFAULT_MITRE_LIMIT:{configurable:!0},DEFAULT_SIMPLIFY_FACTOR:{configurable:!0}};Ad.prototype.getEndCapStyle=function(){return this.Li},Ad.prototype.isSingleSided=function(){return this.Fi},Ad.prototype.setQuadrantSegments=function(t){this.pi=t,0===this.pi&&(this.Ti=Ad.JOIN_BEVEL),this.pi<0&&(this.Ti=Ad.JOIN_MITRE,this.Oi=Math.abs(this.pi)),t<=0&&(this.pi=1),this.Ti!==Ad.JOIN_ROUND&&(this.pi=Ad.DEFAULT_QUADRANT_SEGMENTS)},Ad.prototype.getJoinStyle=function(){return this.Ti},Ad.prototype.setJoinStyle=function(t){this.Ti=t},Ad.prototype.setSimplifyFactor=function(t){this.Ui=t<0?0:t},Ad.prototype.getSimplifyFactor=function(){return this.Ui},Ad.prototype.getQuadrantSegments=function(){return this.pi},Ad.prototype.setEndCapStyle=function(t){this.Li=t},Ad.prototype.getMitreLimit=function(){return this.Oi},Ad.prototype.setMitreLimit=function(t){this.Oi=t},Ad.prototype.setSingleSided=function(t){this.Fi=t},Ad.prototype.interfaces_=function(){return[]},Ad.prototype.getClass=function(){return Ad},Ad.bufferDistanceError=function(t){var e=Math.PI/2/t;return 1-Math.cos(e/2)},gd.CAP_ROUND.get=function(){return 1},gd.CAP_FLAT.get=function(){return 2},gd.CAP_SQUARE.get=function(){return 3},gd.JOIN_ROUND.get=function(){return 1},gd.JOIN_MITRE.get=function(){return 2},gd.JOIN_BEVEL.get=function(){return 3},gd.DEFAULT_QUADRANT_SEGMENTS.get=function(){return 8},gd.DEFAULT_MITRE_LIMIT.get=function(){return 5},gd.DEFAULT_SIMPLIFY_FACTOR.get=function(){return.01},Object.defineProperties(Ad,gd);var md=function(t){this.Ei=null,this.Ni=null,this.ji=Rc.COUNTERCLOCKWISE,this.Qi=t||null},yd={INIT:{configurable:!0},DELETE:{configurable:!0},KEEP:{configurable:!0},NUM_PTS_TO_CHECK:{configurable:!0}};md.prototype.isDeletable=function(t,e,n,r){var i=this.Qi[t],s=this.Qi[e],o=this.Qi[n];return!!this.isConcave(i,s,o)&&!!this.isShallow(i,s,o,r)&&this.isShallowSampled(i,s,t,n,r)},md.prototype.deleteShallowConcavities=function(){for(var t=1,e=this.findNextNonDeletedIndex(t),n=this.findNextNonDeletedIndex(e),r=!1;n<this.Qi.length;){var i=!1;this.isDeletable(t,e,n,this.Ei)&&(this.Ni[e]=md.DELETE,i=!0,r=!0),t=i?n:e,e=this.findNextNonDeletedIndex(t),n=this.findNextNonDeletedIndex(e)}return r},md.prototype.isShallowConcavity=function(t,e,n,r){return Rc.computeOrientation(t,e,n)===this.ji&&Rc.distancePointLine(e,t,n)<r},md.prototype.isShallowSampled=function(t,e,n,r,i){var s=Math.trunc((r-n)/md.NUM_PTS_TO_CHECK);s<=0&&(s=1);for(var o=n;o<r;o+=s)if(!this.isShallow(t,e,this.Qi[o],i))return!1;return!0},md.prototype.isConcave=function(t,e,n){var r=Rc.computeOrientation(t,e,n)===this.ji;return r},md.prototype.simplify=function(t){this.Ei=Math.abs(t),t<0&&(this.ji=Rc.CLOCKWISE),this.Ni=new Array(this.Qi.length).fill(null);var e=!1;do{e=this.deleteShallowConcavities()}while(e);return this.collapseLine()},md.prototype.findNextNonDeletedIndex=function(t){for(var e=t+1;e<this.Qi.length&&this.Ni[e]===md.DELETE;)e++;return e},md.prototype.isShallow=function(t,e,n,r){return Rc.distancePointLine(e,t,n)<r},md.prototype.collapseLine=function(){for(var t=new $c,e=0;e<this.Qi.length;e++)this.Ni[e]!==md.DELETE&&t.add(this.Qi[e]);return t.toCoordinateArray()},md.prototype.interfaces_=function(){return[]},md.prototype.getClass=function(){return md},md.simplify=function(t,e){return new md(t).simplify(e)},yd.INIT.get=function(){return 0},yd.DELETE.get=function(){return 1},yd.KEEP.get=function(){return 1},yd.NUM_PTS_TO_CHECK.get=function(){return 10},Object.defineProperties(md,yd);var vd=function(){this.Si=null,this.Wt=null,this.Bi=0,this.Si=new Kc},xd={COORDINATE_ARRAY_TYPE:{configurable:!0}};vd.prototype.getCoordinates=function(){return this.Si.toArray(vd.COORDINATE_ARRAY_TYPE)},vd.prototype.setPrecisionModel=function(t){this.Wt=t},vd.prototype.addPt=function(t){var e=new Zh(t);if(this.Wt.makePrecise(e),this.isRedundant(e))return null;this.Si.add(e)},vd.prototype.revere=function(){},vd.prototype.addPts=function(t,e){if(e)for(var n=0;n<t.length;n++)this.addPt(t[n]);else for(var r=t.length-1;r>=0;r--)this.addPt(t[r])},vd.prototype.isRedundant=function(t){if(this.Si.size()<1)return!1;var e=this.Si.get(this.Si.size()-1);return t.distance(e)<this.Bi},vd.prototype.toString=function(){return(new af).createLineString(this.getCoordinates()).toString()},vd.prototype.closeRing=function(){if(this.Si.size()<1)return null;var t=new Zh(this.Si.get(0)),e=this.Si.get(this.Si.size()-1);if(t.equals(e))return null;this.Si.add(t)},vd.prototype.setMinimumVertexDistance=function(t){this.Bi=t},vd.prototype.interfaces_=function(){return[]},vd.prototype.getClass=function(){return vd},xd.COORDINATE_ARRAY_TYPE.get=function(){return new Array(0).fill(null)},Object.defineProperties(vd,xd);var bd=function(){},wd={PI_TIMES_2:{configurable:!0},PI_OVER_2:{configurable:!0},PI_OVER_4:{configurable:!0},COUNTERCLOCKWISE:{configurable:!0},CLOCKWISE:{configurable:!0},NONE:{configurable:!0}};bd.prototype.interfaces_=function(){return[]},bd.prototype.getClass=function(){return bd},bd.toDegrees=function(t){return 180*t/Math.PI},bd.normalize=function(t){for(;t>Math.PI;)t-=bd.PI_TIMES_2;for(;t<=-Math.PI;)t+=bd.PI_TIMES_2;return t},bd.angle=function(){if(1===arguments.length){var t=arguments[0];return Math.atan2(t.y,t.x)}if(2===arguments.length){var e=arguments[0],n=arguments[1],r=n.x-e.x,i=n.y-e.y;return Math.atan2(i,r)}},bd.isAcute=function(t,e,n){var r=t.x-e.x,i=t.y-e.y;return r*(n.x-e.x)+i*(n.y-e.y)>0},bd.isObtuse=function(t,e,n){var r=t.x-e.x,i=t.y-e.y;return r*(n.x-e.x)+i*(n.y-e.y)<0},bd.interiorAngle=function(t,e,n){var r=bd.angle(e,t),i=bd.angle(e,n);return Math.abs(i-r)},bd.normalizePositive=function(t){if(t<0){for(;t<0;)t+=bd.PI_TIMES_2;t>=bd.PI_TIMES_2&&(t=0)}else{for(;t>=bd.PI_TIMES_2;)t-=bd.PI_TIMES_2;t<0&&(t=0)}return t},bd.angleBetween=function(t,e,n){var r=bd.angle(e,t),i=bd.angle(e,n);return bd.diff(r,i)},bd.diff=function(t,e){var n=null;return(n=t<e?e-t:t-e)>Math.PI&&(n=2*Math.PI-n),n},bd.toRadians=function(t){return t*Math.PI/180},bd.getTurn=function(t,e){var n=Math.sin(e-t);return n>0?bd.COUNTERCLOCKWISE:n<0?bd.CLOCKWISE:bd.NONE},bd.angleBetweenOriented=function(t,e,n){var r=bd.angle(e,t),i=bd.angle(e,n)-r;return i<=-Math.PI?i+bd.PI_TIMES_2:i>Math.PI?i-bd.PI_TIMES_2:i},wd.PI_TIMES_2.get=function(){return 2*Math.PI},wd.PI_OVER_2.get=function(){return Math.PI/2},wd.PI_OVER_4.get=function(){return Math.PI/4},wd.COUNTERCLOCKWISE.get=function(){return Rc.COUNTERCLOCKWISE},wd.CLOCKWISE.get=function(){return Rc.CLOCKWISE},wd.NONE.get=function(){return Rc.COLLINEAR},Object.defineProperties(bd,wd);var _d=function t(){this.ki=0,this.Ri=null,this.Gi=1,this.Yi=null,this.ii=0,this.Wt=null,this.qi=null,this.Vi=null,this.Wi=null,this._i=null,this.Ki=null,this.Hi=new od,this.Ji=new od,this.Zi=new od,this.Xi=new od,this.$i=0,this.Ar=!1;var e=arguments[0],n=arguments[1],r=arguments[2];this.Wt=e,this.qi=n,this.Vi=new Ec,this.Ri=Math.PI/2/n.getQuadrantSegments(),n.getQuadrantSegments()>=8&&n.getJoinStyle()===Ad.JOIN_ROUND&&(this.Gi=t.MAX_CLOSING_SEG_LEN_FACTOR),this.init(r)},Md={OFFSET_SEGMENT_SEPARATION_FACTOR:{configurable:!0},INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},CURVE_VERTEX_SNAP_DISTANCE_FACTOR:{configurable:!0},MAX_CLOSING_SEG_LEN_FACTOR:{configurable:!0}};_d.prototype.addNextSegment=function(t,e){if(this.Wi=this._i,this._i=this.Ki,this.Ki=t,this.Hi.setCoordinates(this.Wi,this._i),this.computeOffsetSegment(this.Hi,this.$i,this.ii,this.Zi),this.Ji.setCoordinates(this._i,this.Ki),this.computeOffsetSegment(this.Ji,this.$i,this.ii,this.Xi),this._i.equals(this.Ki))return null;var n=Rc.computeOrientation(this.Wi,this._i,this.Ki),r=n===Rc.CLOCKWISE&&this.$i===Af.LEFT||n===Rc.COUNTERCLOCKWISE&&this.$i===Af.RIGHT;0===n?this.addCollinear(e):r?this.addOutsideTurn(n,e):this.addInsideTurn(n,e)},_d.prototype.addLineEndCap=function(t,e){var n=new od(t,e),r=new od;this.computeOffsetSegment(n,Af.LEFT,this.ii,r);var i=new od;this.computeOffsetSegment(n,Af.RIGHT,this.ii,i);var s=e.x-t.x,o=e.y-t.y,a=Math.atan2(o,s);switch(this.qi.getEndCapStyle()){case Ad.CAP_ROUND:this.Yi.addPt(r.p1),this.addFilletArc(e,a+Math.PI/2,a-Math.PI/2,Rc.CLOCKWISE,this.ii),this.Yi.addPt(i.p1);break;case Ad.CAP_FLAT:this.Yi.addPt(r.p1),this.Yi.addPt(i.p1);break;case Ad.CAP_SQUARE:var l=new Zh;l.x=Math.abs(this.ii)*Math.cos(a),l.y=Math.abs(this.ii)*Math.sin(a);var h=new Zh(r.p1.x+l.x,r.p1.y+l.y),c=new Zh(i.p1.x+l.x,i.p1.y+l.y);this.Yi.addPt(h),this.Yi.addPt(c)}},_d.prototype.getCoordinates=function(){return this.Yi.getCoordinates()},_d.prototype.addMitreJoin=function(t,e,n,r){var i=!0,s=null;try{s=mc.intersection(e.p0,e.p1,n.p0,n.p1),(r<=0?1:s.distance(t)/Math.abs(r))>this.qi.getMitreLimit()&&(i=!1)}catch(t){if(!(t instanceof Ac))throw t;s=new Zh(0,0),i=!1}i?this.Yi.addPt(s):this.addLimitedMitreJoin(e,n,r,this.qi.getMitreLimit())},_d.prototype.addFilletCorner=function(t,e,n,r,i){var s=e.x-t.x,o=e.y-t.y,a=Math.atan2(o,s),l=n.x-t.x,h=n.y-t.y,c=Math.atan2(h,l);r===Rc.CLOCKWISE?a<=c&&(a+=2*Math.PI):a>=c&&(a-=2*Math.PI),this.Yi.addPt(e),this.addFilletArc(t,a,c,r,i),this.Yi.addPt(n)},_d.prototype.addOutsideTurn=function(t,e){if(this.Zi.p1.distance(this.Xi.p0)<this.ii*_d.OFFSET_SEGMENT_SEPARATION_FACTOR)return this.Yi.addPt(this.Zi.p1),null;this.qi.getJoinStyle()===Ad.JOIN_MITRE?this.addMitreJoin(this._i,this.Zi,this.Xi,this.ii):this.qi.getJoinStyle()===Ad.JOIN_BEVEL?this.addBevelJoin(this.Zi,this.Xi):(e&&this.Yi.addPt(this.Zi.p1),this.addFilletCorner(this._i,this.Zi.p1,this.Xi.p0,t,this.ii),this.Yi.addPt(this.Xi.p0))},_d.prototype.createSquare=function(t){this.Yi.addPt(new Zh(t.x+this.ii,t.y+this.ii)),this.Yi.addPt(new Zh(t.x+this.ii,t.y-this.ii)),this.Yi.addPt(new Zh(t.x-this.ii,t.y-this.ii)),this.Yi.addPt(new Zh(t.x-this.ii,t.y+this.ii)),this.Yi.closeRing()},_d.prototype.addSegments=function(t,e){this.Yi.addPts(t,e)},_d.prototype.addFirstSegment=function(){this.Yi.addPt(this.Xi.p0)},_d.prototype.addLastSegment=function(){this.Yi.addPt(this.Xi.p1)},_d.prototype.initSideSegments=function(t,e,n){this._i=t,this.Ki=e,this.$i=n,this.Ji.setCoordinates(t,e),this.computeOffsetSegment(this.Ji,n,this.ii,this.Xi)},_d.prototype.addLimitedMitreJoin=function(t,e,n,r){var i=this.Hi.p1,s=bd.angle(i,this.Hi.p0),o=bd.angleBetweenOriented(this.Hi.p0,i,this.Ji.p1)/2,a=bd.normalize(s+o),l=bd.normalize(a+Math.PI),h=r*n,c=n-h*Math.abs(Math.sin(o)),u=i.x+h*Math.cos(l),f=i.y+h*Math.sin(l),d=new Zh(u,f),p=new od(i,d),A=p.pointAlongOffset(1,c),g=p.pointAlongOffset(1,-c);this.$i===Af.LEFT?(this.Yi.addPt(A),this.Yi.addPt(g)):(this.Yi.addPt(g),this.Yi.addPt(A))},_d.prototype.computeOffsetSegment=function(t,e,n,r){var i=e===Af.LEFT?1:-1,s=t.p1.x-t.p0.x,o=t.p1.y-t.p0.y,a=Math.sqrt(s*s+o*o),l=i*n*s/a,h=i*n*o/a;r.p0.x=t.p0.x-h,r.p0.y=t.p0.y+l,r.p1.x=t.p1.x-h,r.p1.y=t.p1.y+l},_d.prototype.addFilletArc=function(t,e,n,r,i){var s=r===Rc.CLOCKWISE?-1:1,o=Math.abs(e-n),a=Math.trunc(o/this.Ri+.5);if(a<1)return null;for(var l=o/a,h=0,c=new Zh;h<o;){var u=e+s*h;c.x=t.x+i*Math.cos(u),c.y=t.y+i*Math.sin(u),this.Yi.addPt(c),h+=l}},_d.prototype.addInsideTurn=function(t,e){if(this.Vi.computeIntersection(this.Zi.p0,this.Zi.p1,this.Xi.p0,this.Xi.p1),this.Vi.hasIntersection())this.Yi.addPt(this.Vi.getIntersection(0));else if(this.Ar=!0,this.Zi.p1.distance(this.Xi.p0)<this.ii*_d.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR)this.Yi.addPt(this.Zi.p1);else{if(this.Yi.addPt(this.Zi.p1),this.Gi>0){var n=new Zh((this.Gi*this.Zi.p1.x+this._i.x)/(this.Gi+1),(this.Gi*this.Zi.p1.y+this._i.y)/(this.Gi+1));this.Yi.addPt(n);var r=new Zh((this.Gi*this.Xi.p0.x+this._i.x)/(this.Gi+1),(this.Gi*this.Xi.p0.y+this._i.y)/(this.Gi+1));this.Yi.addPt(r)}else this.Yi.addPt(this._i);this.Yi.addPt(this.Xi.p0)}},_d.prototype.createCircle=function(t){var e=new Zh(t.x+this.ii,t.y);this.Yi.addPt(e),this.addFilletArc(t,0,2*Math.PI,-1,this.ii),this.Yi.closeRing()},_d.prototype.addBevelJoin=function(t,e){this.Yi.addPt(t.p1),this.Yi.addPt(e.p0)},_d.prototype.init=function(t){this.ii=t,this.ki=t*(1-Math.cos(this.Ri/2)),this.Yi=new vd,this.Yi.setPrecisionModel(this.Wt),this.Yi.setMinimumVertexDistance(t*_d.CURVE_VERTEX_SNAP_DISTANCE_FACTOR)},_d.prototype.addCollinear=function(t){this.Vi.computeIntersection(this.Wi,this._i,this._i,this.Ki),this.Vi.getIntersectionNum()>=2&&(this.qi.getJoinStyle()===Ad.JOIN_BEVEL||this.qi.getJoinStyle()===Ad.JOIN_MITRE?(t&&this.Yi.addPt(this.Zi.p1),this.Yi.addPt(this.Xi.p0)):this.addFilletCorner(this._i,this.Zi.p1,this.Xi.p0,Rc.CLOCKWISE,this.ii))},_d.prototype.closeRing=function(){this.Yi.closeRing()},_d.prototype.hasNarrowConcaveAngle=function(){return this.Ar},_d.prototype.interfaces_=function(){return[]},_d.prototype.getClass=function(){return _d},Md.OFFSET_SEGMENT_SEPARATION_FACTOR.get=function(){return.001},Md.INSIDE_TURN_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return.001},Md.CURVE_VERTEX_SNAP_DISTANCE_FACTOR.get=function(){return 1e-6},Md.MAX_CLOSING_SEG_LEN_FACTOR.get=function(){return 80},Object.defineProperties(_d,Md);var Td=function(){this.ii=0,this.Wt=null,this.qi=null;var t=arguments[0],e=arguments[1];this.Wt=t,this.qi=e};Td.prototype.getOffsetCurve=function(t,e){if(this.ii=e,0===e)return null;var n=e<0,r=Math.abs(e),i=this.getSegGen(r);t.length<=1?this.computePointCurve(t[0],i):this.computeOffsetCurve(t,n,i);var s=i.getCoordinates();return n&&tu.reverse(s),s},Td.prototype.computeSingleSidedBufferCurve=function(t,e,n){var r=this.simplifyTolerance(this.ii);if(e){n.addSegments(t,!0);var i=md.simplify(t,-r),s=i.length-1;n.initSideSegments(i[s],i[s-1],Af.LEFT),n.addFirstSegment();for(var o=s-2;o>=0;o--)n.addNextSegment(i[o],!0)}else{n.addSegments(t,!1);var a=md.simplify(t,r),l=a.length-1;n.initSideSegments(a[0],a[1],Af.LEFT),n.addFirstSegment();for(var h=2;h<=l;h++)n.addNextSegment(a[h],!0)}n.addLastSegment(),n.closeRing()},Td.prototype.computeRingBufferCurve=function(t,e,n){var r=this.simplifyTolerance(this.ii);e===Af.RIGHT&&(r=-r);var i=md.simplify(t,r),s=i.length-1;n.initSideSegments(i[s-1],i[0],e);for(var o=1;o<=s;o++){var a=1!==o;n.addNextSegment(i[o],a)}n.closeRing()},Td.prototype.computeLineBufferCurve=function(t,e){var n=this.simplifyTolerance(this.ii),r=md.simplify(t,n),i=r.length-1;e.initSideSegments(r[0],r[1],Af.LEFT);for(var s=2;s<=i;s++)e.addNextSegment(r[s],!0);e.addLastSegment(),e.addLineEndCap(r[i-1],r[i]);var o=md.simplify(t,-n),a=o.length-1;e.initSideSegments(o[a],o[a-1],Af.LEFT);for(var l=a-2;l>=0;l--)e.addNextSegment(o[l],!0);e.addLastSegment(),e.addLineEndCap(o[1],o[0]),e.closeRing()},Td.prototype.computePointCurve=function(t,e){switch(this.qi.getEndCapStyle()){case Ad.CAP_ROUND:e.createCircle(t);break;case Ad.CAP_SQUARE:e.createSquare(t)}},Td.prototype.getLineCurve=function(t,e){if(this.ii=e,e<0&&!this.qi.isSingleSided())return null;if(0===e)return null;var n=Math.abs(e),r=this.getSegGen(n);if(t.length<=1)this.computePointCurve(t[0],r);else if(this.qi.isSingleSided()){var i=e<0;this.computeSingleSidedBufferCurve(t,i,r)}else this.computeLineBufferCurve(t,r);return r.getCoordinates()},Td.prototype.getBufferParameters=function(){return this.qi},Td.prototype.simplifyTolerance=function(t){return t*this.qi.getSimplifyFactor()},Td.prototype.getRingCurve=function(t,e,n){if(this.ii=n,t.length<=2)return this.getLineCurve(t,n);if(0===n)return Td.copyCoordinates(t);var r=this.getSegGen(n);return this.computeRingBufferCurve(t,e,r),r.getCoordinates()},Td.prototype.computeOffsetCurve=function(t,e,n){var r=this.simplifyTolerance(this.ii);if(e){var i=md.simplify(t,-r),s=i.length-1;n.initSideSegments(i[s],i[s-1],Af.LEFT),n.addFirstSegment();for(var o=s-2;o>=0;o--)n.addNextSegment(i[o],!0)}else{var a=md.simplify(t,r),l=a.length-1;n.initSideSegments(a[0],a[1],Af.LEFT),n.addFirstSegment();for(var h=2;h<=l;h++)n.addNextSegment(a[h],!0)}n.addLastSegment()},Td.prototype.getSegGen=function(t){return new _d(this.Wt,this.qi,t)},Td.prototype.interfaces_=function(){return[]},Td.prototype.getClass=function(){return Td},Td.copyCoordinates=function(t){for(var e=new Array(t.length).fill(null),n=0;n<e.length;n++)e[n]=new Zh(t[n]);return e};var Sd=function(){this.tr=null,this.nr=new od,this.ir=new Rc;var t=arguments[0];this.tr=t},Id={DepthSegment:{configurable:!0}};Sd.prototype.findStabbedSegments=function(){var t=this;if(1===arguments.length){for(var e=arguments[0],n=new Kc,r=this.tr.iterator();r.hasNext();){var i=r.next(),s=i.getEnvelope();e.y<s.getMinY()||e.y>s.getMaxY()||t.findStabbedSegments(e,i.getDirectedEdges(),n)}return n}if(3===arguments.length)if(nc(arguments[2],Yc)&&arguments[0]instanceof Zh&&arguments[1]instanceof Nf)for(var o=arguments[0],a=arguments[1],l=arguments[2],h=a.getEdge().getCoordinates(),c=0;c<h.length-1;c++){t.nr.p0=h[c],t.nr.p1=h[c+1],t.nr.p0.y>t.nr.p1.y&&t.nr.reverse();var u=Math.max(t.nr.p0.x,t.nr.p1.x);if(!(u<o.x)&&!(t.nr.isHorizontal()||o.y<t.nr.p0.y||o.y>t.nr.p1.y||Rc.computeOrientation(t.nr.p0,t.nr.p1,o)===Rc.RIGHT)){var f=a.getDepth(Af.LEFT);t.nr.p0.equals(h[c])||(f=a.getDepth(Af.RIGHT));var d=new Cd(t.nr,f);l.add(d)}}else if(nc(arguments[2],Yc)&&arguments[0]instanceof Zh&&nc(arguments[1],Yc))for(var p=arguments[0],A=arguments[1],g=arguments[2],m=A.iterator();m.hasNext();){var y=m.next();y.isForward()&&t.findStabbedSegments(p,y,g)}},Sd.prototype.getDepth=function(t){var e=this.findStabbedSegments(t);return 0===e.size()?0:qf.min(e).rr},Sd.prototype.interfaces_=function(){return[]},Sd.prototype.getClass=function(){return Sd},Id.DepthSegment.get=function(){return Cd},Object.defineProperties(Sd,Id);var Cd=function(){this.er=null,this.rr=null;var t=arguments[0],e=arguments[1];this.er=new od(t),this.rr=e};Cd.prototype.compareTo=function(t){var e=t;if(this.er.minX()>=e.er.maxX())return 1;if(this.er.maxX()<=e.er.minX())return-1;var n=this.er.orientationIndex(e.er);return 0!==n||0!==(n=-1*e.er.orientationIndex(this.er))?n:this.er.compareTo(e.er)},Cd.prototype.compareX=function(t,e){var n=t.p0.compareTo(e.p0);return 0!==n?n:t.p1.compareTo(e.p1)},Cd.prototype.toString=function(){return this.er.toString()},Cd.prototype.interfaces_=function(){return[Wh]},Cd.prototype.getClass=function(){return Cd};var Od=function(t,e,n){this.p0=t||null,this.p1=e||null,this.p2=n||null};Od.prototype.area=function(){return Od.area(this.p0,this.p1,this.p2)},Od.prototype.signedArea=function(){return Od.signedArea(this.p0,this.p1,this.p2)},Od.prototype.interpolateZ=function(t){if(null===t)throw new Vh("Supplied point is null.");return Od.interpolateZ(t,this.p0,this.p1,this.p2)},Od.prototype.longestSideLength=function(){return Od.longestSideLength(this.p0,this.p1,this.p2)},Od.prototype.isAcute=function(){return Od.isAcute(this.p0,this.p1,this.p2)},Od.prototype.circumcentre=function(){return Od.circumcentre(this.p0,this.p1,this.p2)},Od.prototype.area3D=function(){return Od.area3D(this.p0,this.p1,this.p2)},Od.prototype.centroid=function(){return Od.centroid(this.p0,this.p1,this.p2)},Od.prototype.inCentre=function(){return Od.inCentre(this.p0,this.p1,this.p2)},Od.prototype.interfaces_=function(){return[]},Od.prototype.getClass=function(){return Od},Od.area=function(t,e,n){return Math.abs(((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2)},Od.signedArea=function(t,e,n){return((n.x-t.x)*(e.y-t.y)-(e.x-t.x)*(n.y-t.y))/2},Od.det=function(t,e,n,r){return t*r-e*n},Od.interpolateZ=function(t,e,n,r){var i=e.x,s=e.y,o=n.x-i,a=r.x-i,l=n.y-s,h=r.y-s,c=o*h-a*l,u=t.x-i,f=t.y-s,d=(h*u-a*f)/c,p=(-l*u+o*f)/c;return e.z+d*(n.z-e.z)+p*(r.z-e.z)},Od.longestSideLength=function(t,e,n){var r=t.distance(e),i=e.distance(n),s=n.distance(t),o=r;return i>o&&(o=i),s>o&&(o=s),o},Od.isAcute=function(t,e,n){return!!bd.isAcute(t,e,n)&&!!bd.isAcute(e,n,t)&&!!bd.isAcute(n,t,e)},Od.circumcentre=function(t,e,n){var r=n.x,i=n.y,s=t.x-r,o=t.y-i,a=e.x-r,l=e.y-i,h=2*Od.det(s,o,a,l),c=Od.det(o,s*s+o*o,l,a*a+l*l),u=Od.det(s,s*s+o*o,a,a*a+l*l);return new Zh(r-c/h,i+u/h)},Od.perpendicularBisector=function(t,e){var n=e.x-t.x,r=e.y-t.y,i=new mc(t.x+n/2,t.y+r/2,1),s=new mc(t.x-r+n/2,t.y+n+r/2,1);return new mc(i,s)},Od.angleBisector=function(t,e,n){var r=e.distance(t),i=r/(r+e.distance(n)),s=n.x-t.x,o=n.y-t.y;return new Zh(t.x+i*s,t.y+i*o)},Od.area3D=function(t,e,n){var r=e.x-t.x,i=e.y-t.y,s=e.z-t.z,o=n.x-t.x,a=n.y-t.y,l=n.z-t.z,h=i*l-s*a,c=s*o-r*l,u=r*a-i*o,f=h*h+c*c+u*u,d=Math.sqrt(f)/2;return d},Od.centroid=function(t,e,n){var r=(t.x+e.x+n.x)/3,i=(t.y+e.y+n.y)/3;return new Zh(r,i)},Od.inCentre=function(t,e,n){var r=e.distance(n),i=t.distance(n),s=t.distance(e),o=r+i+s,a=(r*t.x+i*e.x+s*n.x)/o,l=(r*t.y+i*e.y+s*n.y)/o;return new Zh(a,l)};var Ed=function(){this.sr=null,this.ii=null,this.ur=null,this.or=new Kc;var t=arguments[0],e=arguments[1],n=arguments[2];this.sr=t,this.ii=e,this.ur=n};Ed.prototype.addPoint=function(t){if(this.ii<=0)return null;var e=t.getCoordinates(),n=this.ur.getLineCurve(e,this.ii);this.addCurve(n,tc.EXTERIOR,tc.INTERIOR)},Ed.prototype.addPolygon=function(t){var e=this.ii,n=Af.LEFT;this.ii<0&&(e=-this.ii,n=Af.RIGHT);var r=t.getExteriorRing(),i=tu.removeRepeatedPoints(r.getCoordinates());if(this.ii<0&&this.isErodedCompletely(r,this.ii))return null;if(this.ii<=0&&i.length<3)return null;this.addPolygonRing(i,e,n,tc.EXTERIOR,tc.INTERIOR);for(var s=0;s<t.getNumInteriorRing();s++){var o=t.getInteriorRingN(s),a=tu.removeRepeatedPoints(o.getCoordinates());this.ii>0&&this.isErodedCompletely(o,-this.ii)||this.addPolygonRing(a,e,Af.opposite(n),tc.INTERIOR,tc.EXTERIOR)}},Ed.prototype.isTriangleErodedCompletely=function(t,e){var n=new Od(t[0],t[1],t[2]),r=n.inCentre();return Rc.distancePointLine(r,n.p0,n.p1)<Math.abs(e)},Ed.prototype.addLineString=function(t){if(this.ii<=0&&!this.ur.getBufferParameters().isSingleSided())return null;var e=tu.removeRepeatedPoints(t.getCoordinates()),n=this.ur.getLineCurve(e,this.ii);this.addCurve(n,tc.EXTERIOR,tc.INTERIOR)},Ed.prototype.addCurve=function(t,e,n){if(null===t||t.length<2)return null;var r=new sd(t,new Mf(0,tc.BOUNDARY,e,n));this.or.add(r)},Ed.prototype.getCurves=function(){return this.add(this.sr),this.or},Ed.prototype.addPolygonRing=function(t,e,n,r,i){if(0===e&&t.length<Gu.MINIMUM_VALID_SIZE)return null;var s=r,o=i;t.length>=Gu.MINIMUM_VALID_SIZE&&Rc.isCCW(t)&&(s=i,o=r,n=Af.opposite(n));var a=this.ur.getRingCurve(t,n,e);this.addCurve(a,s,o)},Ed.prototype.add=function(t){if(t.isEmpty())return null;t instanceof ju?this.addPolygon(t):t instanceof zu?this.addLineString(t):t instanceof Hu?this.addPoint(t):(t instanceof Vu||t instanceof Su||t instanceof qu||t instanceof Tu)&&this.addCollection(t)},Ed.prototype.isErodedCompletely=function(t,e){var n=t.getCoordinates();if(n.length<4)return e<0;if(4===n.length)return this.isTriangleErodedCompletely(n,e);var r=t.getEnvelopeInternal(),i=Math.min(r.getHeight(),r.getWidth());return e<0&&2*Math.abs(e)>i},Ed.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},Ed.prototype.interfaces_=function(){return[]},Ed.prototype.getClass=function(){return Ed};var Pd=function(){};Pd.prototype.locate=function(t){},Pd.prototype.interfaces_=function(){return[]},Pd.prototype.getClass=function(){return Pd};var kd=function(){this.hr=null,this.cr=null,this.ar=null,this.zi=null,this.vr=null;var t=arguments[0];this.hr=t,this.cr=!0,this.zi=0,this.ar=t.getNumGeometries()};kd.prototype.next=function(){if(this.cr)return this.cr=!1,kd.isAtomic(this.hr)&&this.zi++,this.hr;if(null!==this.vr){if(this.vr.hasNext())return this.vr.next();this.vr=null}if(this.zi>=this.ar)throw new Zc;var t=this.hr.getGeometryN(this.zi++);return t instanceof Tu?(this.vr=new kd(t),this.vr.next()):t},kd.prototype.remove=function(){throw new Error(this.getClass().getName())},kd.prototype.hasNext=function(){if(this.cr)return!0;if(null!==this.vr){if(this.vr.hasNext())return!0;this.vr=null}return!(this.zi>=this.ar)},kd.prototype.interfaces_=function(){return[Qc]},kd.prototype.getClass=function(){return kd},kd.isAtomic=function(t){return!(t instanceof Tu)};var Rd=function(){this.An=null;var t=arguments[0];this.An=t};Rd.prototype.locate=function(t){return Rd.locate(t,this.An)},Rd.prototype.interfaces_=function(){return[Pd]},Rd.prototype.getClass=function(){return Rd},Rd.isPointInRing=function(t,e){return!!e.getEnvelopeInternal().intersects(t)&&Rc.isPointInRing(t,e.getCoordinates())},Rd.containsPointInPolygon=function(t,e){if(e.isEmpty())return!1;var n=e.getExteriorRing();if(!Rd.isPointInRing(t,n))return!1;for(var r=0;r<e.getNumInteriorRing();r++){var i=e.getInteriorRingN(r);if(Rd.isPointInRing(t,i))return!1}return!0},Rd.containsPoint=function(t,e){if(e instanceof ju)return Rd.containsPointInPolygon(t,e);if(e instanceof Tu)for(var n=new kd(e);n.hasNext();){var r=n.next();if(r!==e&&Rd.containsPoint(t,r))return!0}return!1},Rd.locate=function(t,e){return e.isEmpty()?tc.EXTERIOR:Rd.containsPoint(t,e)?tc.INTERIOR:tc.EXTERIOR};var Nd=function(){this.lr=new Au,this.wr=null,this.Pr=[tc.NONE,tc.NONE]};Nd.prototype.getNextCW=function(t){this.getEdges();var e=this.wr.indexOf(t),n=e-1;return 0===e&&(n=this.wr.size()-1),this.wr.get(n)},Nd.prototype.propagateSideLabels=function(t){for(var e=tc.NONE,n=this.iterator();n.hasNext();){var r=n.next().getLabel();r.isArea(t)&&r.getLocation(t,Af.LEFT)!==tc.NONE&&(e=r.getLocation(t,Af.LEFT))}if(e===tc.NONE)return null;for(var i=e,s=this.iterator();s.hasNext();){var o=s.next(),a=o.getLabel();if(a.getLocation(t,Af.ON)===tc.NONE&&a.setLocation(t,Af.ON,i),a.isArea(t)){var l=a.getLocation(t,Af.LEFT),h=a.getLocation(t,Af.RIGHT);if(h!==tc.NONE){if(h!==i)throw new xf("side location conflict",o.getCoordinate());l===tc.NONE&&Ic.shouldNeverReachHere("found single null side (at "+o.getCoordinate()+")"),i=l}else Ic.isTrue(a.getLocation(t,Af.LEFT)===tc.NONE,"found single null side"),a.setLocation(t,Af.RIGHT,i),a.setLocation(t,Af.LEFT,i)}}},Nd.prototype.getCoordinate=function(){var t=this.iterator();return t.hasNext()?t.next().getCoordinate():null},Nd.prototype.print=function(t){gc.out.println("EdgeEndStar:   "+this.getCoordinate());for(var e=this.iterator();e.hasNext();)e.next().print(t)},Nd.prototype.isAreaLabelsConsistent=function(t){return this.computeEdgeEndLabels(t.getBoundaryNodeRule()),this.checkAreaLabelsConsistent(0)},Nd.prototype.checkAreaLabelsConsistent=function(t){var e=this.getEdges();if(e.size()<=0)return!0;var n=e.size()-1,r=e.get(n).getLabel().getLocation(t,Af.LEFT);Ic.isTrue(r!==tc.NONE,"Found unlabelled area edge");for(var i=r,s=this.iterator();s.hasNext();){var o=s.next().getLabel();Ic.isTrue(o.isArea(t),"Found non-area edge");var a=o.getLocation(t,Af.LEFT),l=o.getLocation(t,Af.RIGHT);if(a===l)return!1;if(l!==i)return!1;i=a}return!0},Nd.prototype.findIndex=function(t){this.iterator();for(var e=0;e<this.wr.size();e++)if(this.wr.get(e)===t)return e;return-1},Nd.prototype.iterator=function(){return this.getEdges().iterator()},Nd.prototype.getEdges=function(){return null===this.wr&&(this.wr=new Kc(this.lr.values())),this.wr},Nd.prototype.getLocation=function(t,e,n){return this.Pr[t]===tc.NONE&&(this.Pr[t]=Rd.locate(e,n[t].getGeometry())),this.Pr[t]},Nd.prototype.toString=function(){var t=new sc;t.append("EdgeEndStar:   "+this.getCoordinate()),t.append("\n");for(var e=this.iterator();e.hasNext();){var n=e.next();t.append(n),t.append("\n")}return t.toString()},Nd.prototype.computeEdgeEndLabels=function(t){for(var e=this.iterator();e.hasNext();)e.next().computeLabel(t)},Nd.prototype.computeLabelling=function(t){this.computeEdgeEndLabels(t[0].getBoundaryNodeRule()),this.propagateSideLabels(0),this.propagateSideLabels(1);for(var e=[!1,!1],n=this.iterator();n.hasNext();)for(var r=n.next().getLabel(),i=0;i<2;i++)r.isLine(i)&&r.getLocation(i)===tc.BOUNDARY&&(e[i]=!0);for(var s=this.iterator();s.hasNext();)for(var o=s.next(),a=o.getLabel(),l=0;l<2;l++)if(a.isAnyNull(l)){var h=tc.NONE;if(e[l])h=tc.EXTERIOR;else{var c=o.getCoordinate();h=this.getLocation(l,c,t)}a.setAllLocationsIfNull(l,h)}},Nd.prototype.getDegree=function(){return this.lr.size()},Nd.prototype.insertEdgeEnd=function(t,e){this.lr.put(t,e),this.wr=null},Nd.prototype.interfaces_=function(){return[]},Nd.prototype.getClass=function(){return Nd};var Dd=function(t){function e(){t.call(this),this.gr=null,this.dn=null,this.Cr=1,this.Dr=2}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.linkResultDirectedEdges=function(){this.getResultAreaEdges();for(var t=null,e=null,n=this.Cr,r=0;r<this.gr.size();r++){var i=this.gr.get(r),s=i.getSym();if(i.getLabel().isArea())switch(null===t&&i.isInResult()&&(t=i),n){case this.Cr:if(!s.isInResult())continue;e=s,n=this.Dr;break;case this.Dr:if(!i.isInResult())continue;e.setNext(i),n=this.Cr}}if(n===this.Dr){if(null===t)throw new xf("no outgoing dirEdge found",this.getCoordinate());Ic.isTrue(t.isInResult(),"unable to link last incoming dirEdge"),e.setNext(t)}},e.prototype.insert=function(t){var e=t;this.insertEdgeEnd(e,e)},e.prototype.getRightmostEdge=function(){var t=this.getEdges(),e=t.size();if(e<1)return null;var n=t.get(0);if(1===e)return n;var r=t.get(e-1),i=n.getQuadrant(),s=r.getQuadrant();return Pf.isNorthern(i)&&Pf.isNorthern(s)?n:Pf.isNorthern(i)||Pf.isNorthern(s)?0!==n.getDy()?n:0!==r.getDy()?r:(Ic.shouldNeverReachHere("found two horizontal edges incident on node"),null):r},e.prototype.print=function(t){gc.out.println("DirectedEdgeStar: "+this.getCoordinate());for(var e=this.iterator();e.hasNext();){var n=e.next();t.print("out "),n.print(t),t.println(),t.print("in "),n.getSym().print(t),t.println()}},e.prototype.getResultAreaEdges=function(){if(null!==this.gr)return this.gr;this.gr=new Kc;for(var t=this.iterator();t.hasNext();){var e=t.next();(e.isInResult()||e.getSym().isInResult())&&this.gr.add(e)}return this.gr},e.prototype.updateLabelling=function(t){for(var e=this.iterator();e.hasNext();){var n=e.next().getLabel();n.setAllLocationsIfNull(0,t.getLocation(0)),n.setAllLocationsIfNull(1,t.getLocation(1))}},e.prototype.linkAllDirectedEdges=function(){this.getEdges();for(var t=null,e=null,n=this.wr.size()-1;n>=0;n--){var r=this.wr.get(n),i=r.getSym();null===e&&(e=i),null!==t&&i.setNext(t),t=r}e.setNext(t)},e.prototype.computeDepths=function(){var t=this;if(1===arguments.length){var e=arguments[0],n=this.findIndex(e),r=e.getDepth(Af.LEFT),i=e.getDepth(Af.RIGHT),s=this.computeDepths(n+1,this.wr.size(),r),o=this.computeDepths(0,n,s);if(o!==i)throw new xf("depth mismatch at "+e.getCoordinate())}else if(3===arguments.length){for(var a=arguments[0],l=arguments[1],h=arguments[2],c=h,u=a;u<l;u++){var f=t.wr.get(u);f.setEdgeDepths(Af.RIGHT,c),c=f.getDepth(Af.LEFT)}return c}},e.prototype.mergeSymLabels=function(){for(var t=this.iterator();t.hasNext();){var e=t.next();e.getLabel().merge(e.getSym().getLabel())}},e.prototype.linkMinimalDirectedEdges=function(t){for(var e=null,n=null,r=this.Cr,i=this.gr.size()-1;i>=0;i--){var s=this.gr.get(i),o=s.getSym();switch(null===e&&s.getEdgeRing()===t&&(e=s),r){case this.Cr:if(o.getEdgeRing()!==t)continue;n=o,r=this.Dr;break;case this.Dr:if(s.getEdgeRing()!==t)continue;n.setNextMin(s),r=this.Cr}}r===this.Dr&&(Ic.isTrue(null!==e,"found null for first outgoing dirEdge"),Ic.isTrue(e.getEdgeRing()===t,"unable to link last incoming dirEdge"),n.setNextMin(e))},e.prototype.getOutgoingDegree=function(){if(0===arguments.length){for(var t=0,e=this.iterator();e.hasNext();){var n=e.next();n.isInResult()&&t++}return t}if(1===arguments.length){for(var r=arguments[0],i=0,s=this.iterator();s.hasNext();){var o=s.next();o.getEdgeRing()===r&&i++}return i}},e.prototype.getLabel=function(){return this.dn},e.prototype.findCoveredLineEdges=function(){for(var t=tc.NONE,e=this.iterator();e.hasNext();){var n=e.next(),r=n.getSym();if(!n.isLineEdge()){if(n.isInResult()){t=tc.INTERIOR;break}if(r.isInResult()){t=tc.EXTERIOR;break}}}if(t===tc.NONE)return null;for(var i=t,s=this.iterator();s.hasNext();){var o=s.next(),a=o.getSym();o.isLineEdge()?o.getEdge().setCovered(i===tc.INTERIOR):(o.isInResult()&&(i=tc.EXTERIOR),a.isInResult()&&(i=tc.INTERIOR))}},e.prototype.computeLabelling=function(e){t.prototype.computeLabelling.call(this,e),this.dn=new Mf(tc.NONE);for(var n=this.iterator();n.hasNext();)for(var r=n.next().getEdge().getLabel(),i=0;i<2;i++){var s=r.getLocation(i);s!==tc.INTERIOR&&s!==tc.BOUNDARY||this.dn.setLocation(i,tc.INTERIOR)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Nd),Fd=function(t){function e(){t.apply(this,arguments)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.createNode=function(t){return new Of(t,new Dd)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Df),Ld=function t(){this.zn=null,this.Ir=null;var e=arguments[0];this.zn=e,this.Ir=t.orientation(e)};Ld.prototype.compareTo=function(t){var e=t;return Ld.compareOriented(this.zn,this.Ir,e.zn,e.Ir)},Ld.prototype.interfaces_=function(){return[Wh]},Ld.prototype.getClass=function(){return Ld},Ld.orientation=function(t){return 1===tu.increasingDirection(t)},Ld.compareOriented=function(t,e,n,r){for(var i=e?1:-1,s=r?1:-1,o=e?t.length:-1,a=r?n.length:-1,l=e?0:t.length-1,h=r?0:n.length-1;;){var c=t[l].compareTo(n[h]);if(0!==c)return c;var u=(l+=i)===o,f=(h+=s)===a;if(u&&!f)return-1;if(!u&&f)return 1;if(u&&f)return 0}};var zd=function(){this.bn=new Kc,this.Mr=new Au};zd.prototype.print=function(t){t.print("MULTILINESTRING ( ");for(var e=0;e<this.bn.size();e++){var n=this.bn.get(e);e>0&&t.print(","),t.print("(");for(var r=n.getCoordinates(),i=0;i<r.length;i++)i>0&&t.print(","),t.print(r[i].x+" "+r[i].y);t.println(")")}t.print(")  ")},zd.prototype.addAll=function(t){for(var e=t.iterator();e.hasNext();)this.add(e.next())},zd.prototype.findEdgeIndex=function(t){for(var e=0;e<this.bn.size();e++)if(this.bn.get(e).equals(t))return e;return-1},zd.prototype.iterator=function(){return this.bn.iterator()},zd.prototype.getEdges=function(){return this.bn},zd.prototype.get=function(t){return this.bn.get(t)},zd.prototype.findEqualEdge=function(t){var e=new Ld(t.getCoordinates());return this.Mr.get(e)},zd.prototype.add=function(t){this.bn.add(t);var e=new Ld(t.getCoordinates());this.Mr.put(e,t)},zd.prototype.interfaces_=function(){return[]},zd.prototype.getClass=function(){return zd};var Bd=function(){};Bd.prototype.processIntersections=function(t,e,n,r){},Bd.prototype.isDone=function(){},Bd.prototype.interfaces_=function(){return[]},Bd.prototype.getClass=function(){return Bd};var Hd=function(){this.br=!1,this.zr=!1,this.dr=!1,this.xr=!1,this.mr=null,this.Vi=null,this.yr=null,this.numIntersections=0,this.numInteriorIntersections=0,this.numProperIntersections=0,this.numTests=0;var t=arguments[0];this.Vi=t};Hd.prototype.isTrivialIntersection=function(t,e,n,r){if(t===n&&1===this.Vi.getIntersectionNum()){if(Hd.isAdjacentSegments(e,r))return!0;if(t.isClosed()){var i=t.size()-1;if(0===e&&r===i||0===r&&e===i)return!0}}return!1},Hd.prototype.getProperIntersectionPoint=function(){return this.mr},Hd.prototype.hasProperInteriorIntersection=function(){return this.dr},Hd.prototype.getLineIntersector=function(){return this.Vi},Hd.prototype.hasProperIntersection=function(){return this.zr},Hd.prototype.processIntersections=function(t,e,n,r){if(t===n&&e===r)return null;this.numTests++;var i=t.getCoordinates()[e],s=t.getCoordinates()[e+1],o=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Vi.computeIntersection(i,s,o,a),this.Vi.hasIntersection()&&(this.numIntersections++,this.Vi.isInteriorIntersection()&&(this.numInteriorIntersections++,this.xr=!0),this.isTrivialIntersection(t,e,n,r)||(this.br=!0,t.addIntersections(this.Vi,e,0),n.addIntersections(this.Vi,r,1),this.Vi.isProper()&&(this.numProperIntersections++,this.zr=!0,this.dr=!0)))},Hd.prototype.hasIntersection=function(){return this.br},Hd.prototype.isDone=function(){return!1},Hd.prototype.hasInteriorIntersection=function(){return this.xr},Hd.prototype.interfaces_=function(){return[Bd]},Hd.prototype.getClass=function(){return Hd},Hd.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var Ud=function(){this.coord=null,this.segmentIndex=null,this.dist=null;var t=arguments[0],e=arguments[1],n=arguments[2];this.coord=new Zh(t),this.segmentIndex=e,this.dist=n};Ud.prototype.getSegmentIndex=function(){return this.segmentIndex},Ud.prototype.getCoordinate=function(){return this.coord},Ud.prototype.print=function(t){t.print(this.coord),t.print(" seg # = "+this.segmentIndex),t.println(" dist = "+this.dist)},Ud.prototype.compareTo=function(t){var e=t;return this.compare(e.segmentIndex,e.dist)},Ud.prototype.isEndPoint=function(t){return 0===this.segmentIndex&&0===this.dist||this.segmentIndex===t},Ud.prototype.toString=function(){return this.coord+" seg # = "+this.segmentIndex+" dist = "+this.dist},Ud.prototype.getDistance=function(){return this.dist},Ud.prototype.compare=function(t,e){return this.segmentIndex<t?-1:this.segmentIndex>t?1:this.dist<e?-1:this.dist>e?1:0},Ud.prototype.interfaces_=function(){return[Wh]},Ud.prototype.getClass=function(){return Ud};var jd=function(){this.ai=new Au,this.edge=null;var t=arguments[0];this.edge=t};jd.prototype.print=function(t){t.println("Intersections:");for(var e=this.iterator();e.hasNext();)e.next().print(t)},jd.prototype.iterator=function(){return this.ai.values().iterator()},jd.prototype.addSplitEdges=function(t){this.addEndpoints();for(var e=this.iterator(),n=e.next();e.hasNext();){var r=e.next(),i=this.createSplitEdge(n,r);t.add(i),n=r}},jd.prototype.addEndpoints=function(){var t=this.edge.pts.length-1;this.add(this.edge.pts[0],0,0),this.add(this.edge.pts[t],t,0)},jd.prototype.createSplitEdge=function(t,e){var n=e.segmentIndex-t.segmentIndex+2,r=this.edge.pts[e.segmentIndex],i=e.dist>0||!e.coord.equals2D(r);i||n--;var s=new Array(n).fill(null),o=0;s[o++]=new Zh(t.coord);for(var a=t.segmentIndex+1;a<=e.segmentIndex;a++)s[o++]=this.edge.pts[a];return i&&(s[o]=e.coord),new Xd(s,new Mf(this.edge.dn))},jd.prototype.add=function(t,e,n){var r=new Ud(t,e,n),i=this.ai.get(r);return null!==i?i:(this.ai.put(r,r),r)},jd.prototype.isIntersection=function(t){for(var e=this.iterator();e.hasNext();)if(e.next().coord.equals(t))return!0;return!1},jd.prototype.interfaces_=function(){return[]},jd.prototype.getClass=function(){return jd};var Vd=function(){};Vd.prototype.getChainStartIndices=function(t){var e=0,n=new Kc;n.add(new oc(e));do{var r=this.findChainEnd(t,e);n.add(new oc(r)),e=r}while(e<t.length-1);return Vd.toIntArray(n)},Vd.prototype.findChainEnd=function(t,e){for(var n=Pf.quadrant(t[e],t[e+1]),r=e+1;r<t.length;){if(Pf.quadrant(t[r-1],t[r])!==n)break;r++}return r-1},Vd.prototype.interfaces_=function(){return[]},Vd.prototype.getClass=function(){return Vd},Vd.toIntArray=function(t){for(var e=new Array(t.size()).fill(null),n=0;n<e.length;n++)e[n]=t.get(n).intValue();return e};var Gd=function(){this.e=null,this.pts=null,this.startIndex=null,this.env1=new yc,this.env2=new yc;var t=arguments[0];this.e=t,this.pts=t.getCoordinates();var e=new Vd;this.startIndex=e.getChainStartIndices(this.pts)};Gd.prototype.getCoordinates=function(){return this.pts},Gd.prototype.getMaxX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e>n?e:n},Gd.prototype.getMinX=function(t){var e=this.pts[this.startIndex[t]].x,n=this.pts[this.startIndex[t+1]].x;return e<n?e:n},Gd.prototype.computeIntersectsForChain=function(){if(4===arguments.length){var t=arguments[0],e=arguments[1],n=arguments[2],r=arguments[3];this.computeIntersectsForChain(this.startIndex[t],this.startIndex[t+1],e,e.startIndex[n],e.startIndex[n+1],r)}else if(6===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2],a=arguments[3],l=arguments[4],h=arguments[5],c=this.pts[i],u=this.pts[s],f=o.pts[a],d=o.pts[l];if(s-i==1&&l-a==1)return h.addIntersections(this.e,i,o.e,a),null;if(this.env1.init(c,u),this.env2.init(f,d),!this.env1.intersects(this.env2))return null;var p=Math.trunc((i+s)/2),A=Math.trunc((a+l)/2);i<p&&(a<A&&this.computeIntersectsForChain(i,p,o,a,A,h),A<l&&this.computeIntersectsForChain(i,p,o,A,l,h)),p<s&&(a<A&&this.computeIntersectsForChain(p,s,o,a,A,h),A<l&&this.computeIntersectsForChain(p,s,o,A,l,h))}},Gd.prototype.getStartIndexes=function(){return this.startIndex},Gd.prototype.computeIntersects=function(t,e){for(var n=0;n<this.startIndex.length-1;n++)for(var r=0;r<t.startIndex.length-1;r++)this.computeIntersectsForChain(n,t,r,e)},Gd.prototype.interfaces_=function(){return[]},Gd.prototype.getClass=function(){return Gd};var qd=function t(){this.Wn=Array(2).fill().map((function(){return Array(3)}));for(var e=0;e<2;e++)for(var n=0;n<3;n++)this.Wn[e][n]=t.NULL_VALUE},Wd={NULL_VALUE:{configurable:!0}};qd.prototype.getDepth=function(t,e){return this.Wn[t][e]},qd.prototype.setDepth=function(t,e,n){this.Wn[t][e]=n},qd.prototype.isNull=function(){var t=this;if(0===arguments.length){for(var e=0;e<2;e++)for(var n=0;n<3;n++)if(t.Wn[e][n]!==qd.NULL_VALUE)return!1;return!0}if(1===arguments.length){var r=arguments[0];return this.Wn[r][1]===qd.NULL_VALUE}if(2===arguments.length){var i=arguments[0],s=arguments[1];return this.Wn[i][s]===qd.NULL_VALUE}},qd.prototype.normalize=function(){for(var t=0;t<2;t++)if(!this.isNull(t)){var e=this.Wn[t][1];this.Wn[t][2]<e&&(e=this.Wn[t][2]),e<0&&(e=0);for(var n=1;n<3;n++){var r=0;this.Wn[t][n]>e&&(r=1),this.Wn[t][n]=r}}},qd.prototype.getDelta=function(t){return this.Wn[t][Af.RIGHT]-this.Wn[t][Af.LEFT]},qd.prototype.getLocation=function(t,e){return this.Wn[t][e]<=0?tc.EXTERIOR:tc.INTERIOR},qd.prototype.toString=function(){return"A: "+this.Wn[0][1]+","+this.Wn[0][2]+" B: "+this.Wn[1][1]+","+this.Wn[1][2]},qd.prototype.add=function(){var t=this;if(1===arguments.length)for(var e=arguments[0],n=0;n<2;n++)for(var r=1;r<3;r++){var i=e.getLocation(n,r);i!==tc.EXTERIOR&&i!==tc.INTERIOR||(t.isNull(n,r)?t.Wn[n][r]=qd.depthAtLocation(i):t.Wn[n][r]+=qd.depthAtLocation(i))}else if(3===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2];a===tc.INTERIOR&&this.Wn[s][o]++}},qd.prototype.interfaces_=function(){return[]},qd.prototype.getClass=function(){return qd},qd.depthAtLocation=function(t){return t===tc.EXTERIOR?0:t===tc.INTERIOR?1:qd.NULL_VALUE},Wd.NULL_VALUE.get=function(){return-1},Object.defineProperties(qd,Wd);var Xd=function(t){function e(){if(t.call(this),this.pts=null,this.Dn=null,this.eiList=new jd(this),this.un=null,this.pr=null,this.Lr=!0,this.Wn=new qd,this.Tr=0,1===arguments.length){var n=arguments[0];e.call(this,n,null)}else if(2===arguments.length){var r=arguments[0],i=arguments[1];this.pts=r,this.dn=i}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.getDepth=function(){return this.Wn},e.prototype.getCollapsedEdge=function(){var t=new Array(2).fill(null);return t[0]=this.pts[0],t[1]=this.pts[1],new e(t,Mf.toLineLabel(this.dn))},e.prototype.isIsolated=function(){return this.Lr},e.prototype.getCoordinates=function(){return this.pts},e.prototype.setIsolated=function(t){this.Lr=t},e.prototype.setName=function(t){this.un=t},e.prototype.equals=function(t){if(!(t instanceof e))return!1;var n=t;if(this.pts.length!==n.pts.length)return!1;for(var r=!0,i=!0,s=this.pts.length,o=0;o<this.pts.length;o++)if(this.pts[o].equals2D(n.pts[o])||(r=!1),this.pts[o].equals2D(n.pts[--s])||(i=!1),!r&&!i)return!1;return!0},e.prototype.getCoordinate=function(){if(0===arguments.length)return this.pts.length>0?this.pts[0]:null;if(1===arguments.length){var t=arguments[0];return this.pts[t]}},e.prototype.print=function(t){t.print("edge "+this.un+": "),t.print("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.print(","),t.print(this.pts[e].x+" "+this.pts[e].y);t.print(")  "+this.dn+" "+this.Tr)},e.prototype.computeIM=function(t){e.updateIM(this.dn,t)},e.prototype.isCollapsed=function(){return!!this.dn.isArea()&&3===this.pts.length&&!!this.pts[0].equals(this.pts[2])},e.prototype.isClosed=function(){return this.pts[0].equals(this.pts[this.pts.length-1])},e.prototype.getMaximumSegmentIndex=function(){return this.pts.length-1},e.prototype.getDepthDelta=function(){return this.Tr},e.prototype.getNumPoints=function(){return this.pts.length},e.prototype.printReverse=function(t){t.print("edge "+this.un+": ");for(var e=this.pts.length-1;e>=0;e--)t.print(this.pts[e]+" ");t.println("")},e.prototype.getMonotoneChainEdge=function(){return null===this.pr&&(this.pr=new Gd(this)),this.pr},e.prototype.getEnvelope=function(){if(null===this.Dn){this.Dn=new yc;for(var t=0;t<this.pts.length;t++)this.Dn.expandToInclude(this.pts[t])}return this.Dn},e.prototype.addIntersection=function(t,e,n,r){var i=new Zh(t.getIntersection(r)),s=e,o=t.getEdgeDistance(n,r),a=s+1;if(a<this.pts.length){var l=this.pts[a];i.equals2D(l)&&(s=a,o=0)}this.eiList.add(i,s,o)},e.prototype.toString=function(){var t=new sc;t.append("edge "+this.un+": "),t.append("LINESTRING (");for(var e=0;e<this.pts.length;e++)e>0&&t.append(","),t.append(this.pts[e].x+" "+this.pts[e].y);return t.append(")  "+this.dn+" "+this.Tr),t.toString()},e.prototype.isPointwiseEqual=function(t){if(this.pts.length!==t.pts.length)return!1;for(var e=0;e<this.pts.length;e++)if(!this.pts[e].equals2D(t.pts[e]))return!1;return!0},e.prototype.setDepthDelta=function(t){this.Tr=t},e.prototype.getEdgeIntersectionList=function(){return this.eiList},e.prototype.addIntersections=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++)this.addIntersection(t,e,n,r)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.updateIM=function(){if(2!==arguments.length)return t.prototype.updateIM.apply(this,arguments);var e=arguments[0],n=arguments[1];n.setAtLeastIfValid(e.getLocation(0,Af.ON),e.getLocation(1,Af.ON),1),e.isArea()&&(n.setAtLeastIfValid(e.getLocation(0,Af.LEFT),e.getLocation(1,Af.LEFT),2),n.setAtLeastIfValid(e.getLocation(0,Af.RIGHT),e.getLocation(1,Af.RIGHT),2))},e}(Cf),Qd=function(t){this.Or=null,this.Fr=null,this.tn=null,this.Ur=null,this.wr=new zd,this.qi=t||null};Qd.prototype.setWorkingPrecisionModel=function(t){this.Or=t},Qd.prototype.insertUniqueEdge=function(t){var e=this.wr.findEqualEdge(t);if(null!==e){var n=e.getLabel(),r=t.getLabel();e.isPointwiseEqual(t)||(r=new Mf(t.getLabel())).flip(),n.merge(r);var i=Qd.depthDelta(r),s=e.getDepthDelta()+i;e.setDepthDelta(s)}else this.wr.add(t),t.setDepthDelta(Qd.depthDelta(t.getLabel()))},Qd.prototype.buildSubgraphs=function(t,e){for(var n=new Kc,r=t.iterator();r.hasNext();){var i=r.next(),s=i.getRightmostCoordinate(),o=new Sd(n).getDepth(s);i.computeDepth(o),i.findResultEdges(),n.add(i),e.add(i.getDirectedEdges(),i.getNodes())}},Qd.prototype.createSubgraphs=function(t){for(var e=new Kc,n=t.getNodes().iterator();n.hasNext();){var r=n.next();if(!r.isVisited()){var i=new wf;i.create(r),e.add(i)}}return qf.sort(e,qf.reverseOrder()),e},Qd.prototype.createEmptyResultGeometry=function(){return this.tn.createPolygon()},Qd.prototype.getNoder=function(t){if(null!==this.Fr)return this.Fr;var e=new dd,n=new Ec;return n.setPrecisionModel(t),e.setSegmentIntersector(new Hd(n)),e},Qd.prototype.buffer=function(t,e){var n=this.Or;null===n&&(n=t.getPrecisionModel()),this.tn=t.getFactory();var r=new Td(n,this.qi),i=new Ed(t,e,r).getCurves();if(i.size()<=0)return this.createEmptyResultGeometry();this.computeNodedEdges(i,n),this.Ur=new Ff(new Fd),this.Ur.addEdges(this.wr.getEdges());var s=this.createSubgraphs(this.Ur),o=new Lf(this.tn);this.buildSubgraphs(s,o);var a=o.getPolygons();return a.size()<=0?this.createEmptyResultGeometry():this.tn.buildGeometry(a)},Qd.prototype.computeNodedEdges=function(t,e){var n=this.getNoder(e);n.computeNodes(t);for(var r=n.getNodedSubstrings().iterator();r.hasNext();){var i=r.next(),s=i.getCoordinates();if(2!==s.length||!s[0].equals2D(s[1])){var o=i.getData(),a=new Xd(i.getCoordinates(),new Mf(o));this.insertUniqueEdge(a)}}},Qd.prototype.setNoder=function(t){this.Fr=t},Qd.prototype.interfaces_=function(){return[]},Qd.prototype.getClass=function(){return Qd},Qd.depthDelta=function(t){var e=t.getLocation(0,Af.LEFT),n=t.getLocation(0,Af.RIGHT);return e===tc.INTERIOR&&n===tc.EXTERIOR?1:e===tc.EXTERIOR&&n===tc.INTERIOR?-1:0},Qd.convertSegStrings=function(t){for(var e=new af,n=new Kc;t.hasNext();){var r=t.next(),i=e.createLineString(r.getCoordinates());n.add(i)}return e.buildGeometry(n)};var Yd=function(){if(this.Er=null,this.Nr=null,this.jr=null,this.Qr=null,this.Sr=!1,2===arguments.length){var t=arguments[0],e=arguments[1];this.Er=t,this.Nr=e,this.jr=0,this.Qr=0,this.Sr=!this.isIntegerPrecision()}else if(4===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2],s=arguments[3];this.Er=n,this.Nr=r,this.jr=i,this.Qr=s,this.Sr=!this.isIntegerPrecision()}};Yd.prototype.rescale=function(){var t=this;if(nc(arguments[0],Wc))for(var e=arguments[0],n=e.iterator();n.hasNext();){var r=n.next();t.rescale(r.getCoordinates())}else if(arguments[0]instanceof Array){for(var i=arguments[0],s=0;s<i.length;s++)i[s].x=i[s].x/t.Nr+t.jr,i[s].y=i[s].y/t.Nr+t.Qr;2===i.length&&i[0].equals2D(i[1])&&gc.out.println(i)}},Yd.prototype.scale=function(){var t=this;if(nc(arguments[0],Wc)){for(var e=arguments[0],n=new Kc,r=e.iterator();r.hasNext();){var i=r.next();n.add(new sd(t.scale(i.getCoordinates()),i.getData()))}return n}if(arguments[0]instanceof Array){for(var s=arguments[0],o=new Array(s.length).fill(null),a=0;a<s.length;a++)o[a]=new Zh(Math.round((s[a].x-t.jr)*t.Nr),Math.round((s[a].y-t.Qr)*t.Nr),s[a].z);var l=tu.removeRepeatedPoints(o);return l}},Yd.prototype.isIntegerPrecision=function(){return 1===this.Nr},Yd.prototype.getNodedSubstrings=function(){var t=this.Er.getNodedSubstrings();return this.Sr&&this.rescale(t),t},Yd.prototype.computeNodes=function(t){var e=t;this.Sr&&(e=this.scale(t)),this.Er.computeNodes(e)},Yd.prototype.interfaces_=function(){return[ud]},Yd.prototype.getClass=function(){return Yd};var Zd=function(){this.Vi=new Ec,this.Br=null;var t=arguments[0];this.Br=t},Kd={fact:{configurable:!0}};Zd.prototype.checkEndPtVertexIntersections=function(){var t=this;if(0===arguments.length)for(var e=this.Br.iterator();e.hasNext();){var n=e.next(),r=n.getCoordinates();t.checkEndPtVertexIntersections(r[0],t.Br),t.checkEndPtVertexIntersections(r[r.length-1],t.Br)}else if(2===arguments.length)for(var i=arguments[0],s=arguments[1],o=s.iterator();o.hasNext();)for(var a=o.next(),l=a.getCoordinates(),h=1;h<l.length-1;h++)if(l[h].equals(i))throw new Tc("found endpt/interior pt intersection at index "+h+" :pt "+i)},Zd.prototype.checkInteriorIntersections=function(){var t=this;if(0===arguments.length)for(var e=this.Br.iterator();e.hasNext();)for(var n=e.next(),r=this.Br.iterator();r.hasNext();){var i=r.next();t.checkInteriorIntersections(n,i)}else if(2===arguments.length)for(var s=arguments[0],o=arguments[1],a=s.getCoordinates(),l=o.getCoordinates(),h=0;h<a.length-1;h++)for(var c=0;c<l.length-1;c++)t.checkInteriorIntersections(s,h,o,c);else if(4===arguments.length){var u=arguments[0],f=arguments[1],d=arguments[2],p=arguments[3];if(u===d&&f===p)return null;var A=u.getCoordinates()[f],g=u.getCoordinates()[f+1],m=d.getCoordinates()[p],y=d.getCoordinates()[p+1];if(this.Vi.computeIntersection(A,g,m,y),this.Vi.hasIntersection()&&(this.Vi.isProper()||this.hasInteriorIntersection(this.Vi,A,g)||this.hasInteriorIntersection(this.Vi,m,y)))throw new Tc("found non-noded intersection at "+A+"-"+g+" and "+m+"-"+y)}},Zd.prototype.checkValid=function(){this.checkEndPtVertexIntersections(),this.checkInteriorIntersections(),this.checkCollapses()},Zd.prototype.checkCollapses=function(){var t=this;if(0===arguments.length)for(var e=this.Br.iterator();e.hasNext();){var n=e.next();t.checkCollapses(n)}else if(1===arguments.length)for(var r=arguments[0],i=r.getCoordinates(),s=0;s<i.length-2;s++)t.checkCollapse(i[s],i[s+1],i[s+2])},Zd.prototype.hasInteriorIntersection=function(t,e,n){for(var r=0;r<t.getIntersectionNum();r++){var i=t.getIntersection(r);if(!i.equals(e)&&!i.equals(n))return!0}return!1},Zd.prototype.checkCollapse=function(t,e,n){if(t.equals(n))throw new Tc("found non-noded collapse at "+Zd.fact.createLineString([t,e,n]))},Zd.prototype.interfaces_=function(){return[]},Zd.prototype.getClass=function(){return Zd},Kd.fact.get=function(){return new af},Object.defineProperties(Zd,Kd);var Jd=function(){this.Vi=null,this.kr=null,this.Rr=null,this.Gr=null,this.Yr=null,this.qr=null,this.Nr=null,this.Tt=null,this.Ot=null,this.Ft=null,this.Ut=null,this.Vr=new Array(4).fill(null),this.Wr=null;var t=arguments[0],e=arguments[1],n=arguments[2];if(this.Rr=t,this.kr=t,this.Nr=e,this.Vi=n,e<=0)throw new Vh("Scale factor must be non-zero");1!==e&&(this.kr=new Zh(this.scale(t.x),this.scale(t.y)),this.Yr=new Zh,this.qr=new Zh),this.initCorners(this.kr)},$d={SAFE_ENV_EXPANSION_FACTOR:{configurable:!0}};Jd.prototype.intersectsScaled=function(t,e){var n=Math.min(t.x,e.x),r=Math.max(t.x,e.x),i=Math.min(t.y,e.y),s=Math.max(t.y,e.y),o=this.Ot<n||this.Tt>r||this.Ut<i||this.Ft>s;if(o)return!1;var a=this.intersectsToleranceSquare(t,e);return Ic.isTrue(!(o&&a),"Found bad envelope test"),a},Jd.prototype.initCorners=function(t){this.Tt=t.x-.5,this.Ot=t.x+.5,this.Ft=t.y-.5,this.Ut=t.y+.5,this.Vr[0]=new Zh(this.Ot,this.Ut),this.Vr[1]=new Zh(this.Tt,this.Ut),this.Vr[2]=new Zh(this.Tt,this.Ft),this.Vr[3]=new Zh(this.Ot,this.Ft)},Jd.prototype.intersects=function(t,e){return 1===this.Nr?this.intersectsScaled(t,e):(this.copyScaled(t,this.Yr),this.copyScaled(e,this.qr),this.intersectsScaled(this.Yr,this.qr))},Jd.prototype.scale=function(t){return Math.round(t*this.Nr)},Jd.prototype.getCoordinate=function(){return this.Rr},Jd.prototype.copyScaled=function(t,e){e.x=this.scale(t.x),e.y=this.scale(t.y)},Jd.prototype.getSafeEnvelope=function(){if(null===this.Wr){var t=Jd.SAFE_ENV_EXPANSION_FACTOR/this.Nr;this.Wr=new yc(this.Rr.x-t,this.Rr.x+t,this.Rr.y-t,this.Rr.y+t)}return this.Wr},Jd.prototype.intersectsPixelClosure=function(t,e){return this.Vi.computeIntersection(t,e,this.Vr[0],this.Vr[1]),!!this.Vi.hasIntersection()||(this.Vi.computeIntersection(t,e,this.Vr[1],this.Vr[2]),!!this.Vi.hasIntersection()||(this.Vi.computeIntersection(t,e,this.Vr[2],this.Vr[3]),!!this.Vi.hasIntersection()||(this.Vi.computeIntersection(t,e,this.Vr[3],this.Vr[0]),!!this.Vi.hasIntersection())))},Jd.prototype.intersectsToleranceSquare=function(t,e){var n=!1,r=!1;return this.Vi.computeIntersection(t,e,this.Vr[0],this.Vr[1]),!!this.Vi.isProper()||(this.Vi.computeIntersection(t,e,this.Vr[1],this.Vr[2]),!!this.Vi.isProper()||(this.Vi.hasIntersection()&&(n=!0),this.Vi.computeIntersection(t,e,this.Vr[2],this.Vr[3]),!!this.Vi.isProper()||(this.Vi.hasIntersection()&&(r=!0),this.Vi.computeIntersection(t,e,this.Vr[3],this.Vr[0]),!!this.Vi.isProper()||!(!n||!r)||!!t.equals(this.kr)||!!e.equals(this.kr))))},Jd.prototype.addSnappedNode=function(t,e){var n=t.getCoordinate(e),r=t.getCoordinate(e+1);return!!this.intersects(n,r)&&(t.addIntersection(this.getCoordinate(),e),!0)},Jd.prototype.interfaces_=function(){return[]},Jd.prototype.getClass=function(){return Jd},$d.SAFE_ENV_EXPANSION_FACTOR.get=function(){return.75},Object.defineProperties(Jd,$d);var tp=function(){this.tempEnv1=new yc,this.selectedSegment=new od};tp.prototype.select=function(){if(1===arguments.length);else if(2===arguments.length){var t=arguments[0],e=arguments[1];t.getLineSegment(e,this.selectedSegment),this.select(this.selectedSegment)}},tp.prototype.interfaces_=function(){return[]},tp.prototype.getClass=function(){return tp};var ep=function(){this.zi=null;var t=arguments[0];this.zi=t},np={HotPixelSnapAction:{configurable:!0}};ep.prototype.snap=function(){if(1===arguments.length){var t=arguments[0];return this.snap(t,null,-1)}if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2],i=e.getSafeEnvelope(),s=new rp(e,n,r);return this.zi.query(i,{interfaces_:function(){return[Uf]},visitItem:function(t){t.select(i,s)}}),s.isNodeAdded()}},ep.prototype.interfaces_=function(){return[]},ep.prototype.getClass=function(){return ep},np.HotPixelSnapAction.get=function(){return rp},Object.defineProperties(ep,np);var rp=function(t){function e(){t.call(this),this._r=null,this.Kr=null,this.Hr=null,this.Jr=!1;var e=arguments[0],n=arguments[1],r=arguments[2];this._r=e,this.Kr=n,this.Hr=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.isNodeAdded=function(){return this.Jr},e.prototype.select=function(){if(2!==arguments.length)return t.prototype.select.apply(this,arguments);var e=arguments[0],n=arguments[1],r=e.getContext();if(null!==this.Kr&&r===this.Kr&&n===this.Hr)return null;this.Jr=this._r.addSnappedNode(r,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(tp),ip=function(){this.Vi=null,this.Zr=null;var t=arguments[0];this.Vi=t,this.Zr=new Kc};ip.prototype.processIntersections=function(t,e,n,r){if(t===n&&e===r)return null;var i=t.getCoordinates()[e],s=t.getCoordinates()[e+1],o=n.getCoordinates()[r],a=n.getCoordinates()[r+1];if(this.Vi.computeIntersection(i,s,o,a),this.Vi.hasIntersection()&&this.Vi.isInteriorIntersection()){for(var l=0;l<this.Vi.getIntersectionNum();l++)this.Zr.add(this.Vi.getIntersection(l));t.addIntersections(this.Vi,e,0),n.addIntersections(this.Vi,r,1)}},ip.prototype.isDone=function(){return!1},ip.prototype.getInteriorIntersections=function(){return this.Zr},ip.prototype.interfaces_=function(){return[Bd]},ip.prototype.getClass=function(){return ip};var sp=function(){this.Xr=null,this.Vi=null,this.Nr=null,this.Er=null,this.$r=null,this.xi=null;var t=arguments[0];this.Xr=t,this.Vi=new Ec,this.Vi.setPrecisionModel(t),this.Nr=t.getScale()};sp.prototype.checkCorrectness=function(t){var e=sd.getNodedSubstrings(t),n=new Zd(e);try{n.checkValid()}catch(t){if(!(t instanceof pc))throw t;t.printStackTrace()}},sp.prototype.getNodedSubstrings=function(){return sd.getNodedSubstrings(this.xi)},sp.prototype.snapRound=function(t,e){var n=this.findInteriorIntersections(t,e);this.computeIntersectionSnaps(n),this.computeVertexSnaps(t)},sp.prototype.findInteriorIntersections=function(t,e){var n=new ip(e);return this.Er.setSegmentIntersector(n),this.Er.computeNodes(t),n.getInteriorIntersections()},sp.prototype.computeVertexSnaps=function(){var t=this;if(nc(arguments[0],Wc))for(var e=arguments[0],n=e.iterator();n.hasNext();){var r=n.next();t.computeVertexSnaps(r)}else if(arguments[0]instanceof sd)for(var i=arguments[0],s=i.getCoordinates(),o=0;o<s.length;o++){var a=new Jd(s[o],t.Nr,t.Vi),l=t.$r.snap(a,i,o);l&&i.addIntersection(s[o],o)}},sp.prototype.computeNodes=function(t){this.xi=t,this.Er=new dd,this.$r=new ep(this.Er.getIndex()),this.snapRound(t,this.Vi)},sp.prototype.computeIntersectionSnaps=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),r=new Jd(n,this.Nr,this.Vi);this.$r.snap(r)}},sp.prototype.interfaces_=function(){return[ud]},sp.prototype.getClass=function(){return sp};var op=function(){if(this.Ae=null,this.ii=null,this.qi=new Ad,this.te=null,this.ne=null,1===arguments.length){var t=arguments[0];this.Ae=t}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.Ae=e,this.qi=n}},ap={CAP_ROUND:{configurable:!0},CAP_BUTT:{configurable:!0},CAP_FLAT:{configurable:!0},CAP_SQUARE:{configurable:!0},MAX_PRECISION_DIGITS:{configurable:!0}};op.prototype.bufferFixedPrecision=function(t){var e=new Yd(new sp(new nf(1)),t.getScale()),n=new Qd(this.qi);n.setWorkingPrecisionModel(t),n.setNoder(e),this.te=n.buffer(this.Ae,this.ii)},op.prototype.bufferReducedPrecision=function(){var t=this;if(0===arguments.length){for(var e=op.MAX_PRECISION_DIGITS;e>=0;e--){try{t.bufferReducedPrecision(e)}catch(e){if(!(e instanceof xf))throw e;t.ne=e}if(null!==t.te)return null}throw this.ne}if(1===arguments.length){var n=arguments[0],r=op.precisionScaleFactor(this.Ae,this.ii,n),i=new nf(r);this.bufferFixedPrecision(i)}},op.prototype.computeGeometry=function(){if(this.bufferOriginalPrecision(),null!==this.te)return null;var t=this.Ae.getFactory().getPrecisionModel();t.getType()===nf.FIXED?this.bufferFixedPrecision(t):this.bufferReducedPrecision()},op.prototype.setQuadrantSegments=function(t){this.qi.setQuadrantSegments(t)},op.prototype.bufferOriginalPrecision=function(){try{var t=new Qd(this.qi);this.te=t.buffer(this.Ae,this.ii)}catch(t){if(!(t instanceof Tc))throw t;this.ne=t}},op.prototype.getResultGeometry=function(t){return this.ii=t,this.computeGeometry(),this.te},op.prototype.setEndCapStyle=function(t){this.qi.setEndCapStyle(t)},op.prototype.interfaces_=function(){return[]},op.prototype.getClass=function(){return op},op.bufferOp=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new op(t),r=n.getResultGeometry(e);return r}if(3===arguments.length){if(Number.isInteger(arguments[2])&&arguments[0]instanceof Fc&&"number"==typeof arguments[1]){var i=arguments[0],s=arguments[1],o=arguments[2],a=new op(i);a.setQuadrantSegments(o);var l=a.getResultGeometry(s);return l}if(arguments[2]instanceof Ad&&arguments[0]instanceof Fc&&"number"==typeof arguments[1]){var h=arguments[0],c=arguments[1],u=arguments[2],f=new op(h,u),d=f.getResultGeometry(c);return d}}else if(4===arguments.length){var p=arguments[0],A=arguments[1],g=arguments[2],m=arguments[3],y=new op(p);y.setQuadrantSegments(g),y.setEndCapStyle(m);var v=y.getResultGeometry(A);return v}},op.precisionScaleFactor=function(t,e,n){var r=t.getEnvelopeInternal(),i=rc.max(Math.abs(r.getMaxX()),Math.abs(r.getMaxY()),Math.abs(r.getMinX()),Math.abs(r.getMinY()))+2*(e>0?e:0),s=n-Math.trunc(Math.log(i)/Math.log(10)+1);return Math.pow(10,s)},ap.CAP_ROUND.get=function(){return Ad.CAP_ROUND},ap.CAP_BUTT.get=function(){return Ad.CAP_FLAT},ap.CAP_FLAT.get=function(){return Ad.CAP_FLAT},ap.CAP_SQUARE.get=function(){return Ad.CAP_SQUARE},ap.MAX_PRECISION_DIGITS.get=function(){return 12},Object.defineProperties(op,ap);var lp=function(){this.kr=[new Zh,new Zh],this.ii=Gh.NaN,this.ie=!0};lp.prototype.getCoordinates=function(){return this.kr},lp.prototype.getCoordinate=function(t){return this.kr[t]},lp.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t.kr[0],t.kr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.ie)return this.initialize(e,n),null;var r=e.distance(n);r<this.ii&&this.initialize(e,n,r)}},lp.prototype.initialize=function(){if(0===arguments.length)this.ie=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this.kr[0].setCoordinate(t),this.kr[1].setCoordinate(e),this.ii=t.distance(e),this.ie=!1}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.kr[0].setCoordinate(n),this.kr[1].setCoordinate(r),this.ii=i,this.ie=!1}},lp.prototype.getDistance=function(){return this.ii},lp.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t.kr[0],t.kr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.ie)return this.initialize(e,n),null;var r=e.distance(n);r>this.ii&&this.initialize(e,n,r)}},lp.prototype.interfaces_=function(){return[]},lp.prototype.getClass=function(){return lp};var hp=function(){};hp.prototype.interfaces_=function(){return[]},hp.prototype.getClass=function(){return hp},hp.computeDistance=function(){if(arguments[2]instanceof lp&&arguments[0]instanceof zu&&arguments[1]instanceof Zh)for(var t=arguments[0],e=arguments[1],n=arguments[2],r=t.getCoordinates(),i=new od,s=0;s<r.length-1;s++){i.setCoordinates(r[s],r[s+1]);var o=i.closestPoint(e);n.setMinimum(o,e)}else if(arguments[2]instanceof lp&&arguments[0]instanceof ju&&arguments[1]instanceof Zh){var a=arguments[0],l=arguments[1],h=arguments[2];hp.computeDistance(a.getExteriorRing(),l,h);for(var c=0;c<a.getNumInteriorRing();c++)hp.computeDistance(a.getInteriorRingN(c),l,h)}else if(arguments[2]instanceof lp&&arguments[0]instanceof Fc&&arguments[1]instanceof Zh){var u=arguments[0],f=arguments[1],d=arguments[2];if(u instanceof zu)hp.computeDistance(u,f,d);else if(u instanceof ju)hp.computeDistance(u,f,d);else if(u instanceof Tu)for(var p=u,A=0;A<p.getNumGeometries();A++){var g=p.getGeometryN(A);hp.computeDistance(g,f,d)}else d.setMinimum(u.getCoordinate(),f)}else if(arguments[2]instanceof lp&&arguments[0]instanceof od&&arguments[1]instanceof Zh){var m=arguments[0],y=arguments[1],v=arguments[2],x=m.closestPoint(y);v.setMinimum(x,y)}};var cp=function(t){this.re=new lp,this.sr=t||null},up={MaxPointDistanceFilter:{configurable:!0},MaxMidpointDistanceFilter:{configurable:!0}};cp.prototype.computeMaxMidpointDistance=function(t){var e=new dp(this.sr);t.apply(e),this.re.setMaximum(e.getMaxPointDistance())},cp.prototype.computeMaxVertexDistance=function(t){var e=new fp(this.sr);t.apply(e),this.re.setMaximum(e.getMaxPointDistance())},cp.prototype.findDistance=function(t){return this.computeMaxVertexDistance(t),this.computeMaxMidpointDistance(t),this.re.getDistance()},cp.prototype.getDistancePoints=function(){return this.re},cp.prototype.interfaces_=function(){return[]},cp.prototype.getClass=function(){return cp},up.MaxPointDistanceFilter.get=function(){return fp},up.MaxMidpointDistanceFilter.get=function(){return dp},Object.defineProperties(cp,up);var fp=function(t){this.re=new lp,this.ee=new lp,this.An=t||null};fp.prototype.filter=function(t){this.ee.initialize(),hp.computeDistance(this.An,t,this.ee),this.re.setMaximum(this.ee)},fp.prototype.getMaxPointDistance=function(){return this.re},fp.prototype.interfaces_=function(){return[Bc]},fp.prototype.getClass=function(){return fp};var dp=function(t){this.re=new lp,this.ee=new lp,this.An=t||null};dp.prototype.filter=function(t,e){if(0===e)return null;var n=t.getCoordinate(e-1),r=t.getCoordinate(e),i=new Zh((n.x+r.x)/2,(n.y+r.y)/2);this.ee.initialize(),hp.computeDistance(this.An,i,this.ee),this.re.setMaximum(this.ee)},dp.prototype.isDone=function(){return!1},dp.prototype.isGeometryChanged=function(){return!1},dp.prototype.getMaxPointDistance=function(){return this.re},dp.prototype.interfaces_=function(){return[Mu]},dp.prototype.getClass=function(){return dp};var pp=function(t){this.se=t||null};pp.prototype.filter=function(t){t instanceof ju&&this.se.add(t)},pp.prototype.interfaces_=function(){return[_u]},pp.prototype.getClass=function(){return pp},pp.getPolygons=function(){if(1===arguments.length){var t=arguments[0];return pp.getPolygons(t,new Kc)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e instanceof ju?n.add(e):e instanceof Tu&&e.apply(new pp(n)),n}};var Ap=function(){if(this.ot=null,this.ue=!1,1===arguments.length){var t=arguments[0];this.ot=t}else if(2===arguments.length){var e=arguments[0],n=arguments[1];this.ot=e,this.ue=n}};Ap.prototype.filter=function(t){if(this.ue&&t instanceof Gu){var e=t.getFactory().createLineString(t.getCoordinateSequence());return this.ot.add(e),null}t instanceof zu&&this.ot.add(t)},Ap.prototype.setForceToLineString=function(t){this.ue=t},Ap.prototype.interfaces_=function(){return[Dc]},Ap.prototype.getClass=function(){return Ap},Ap.getGeometry=function(){if(1===arguments.length){var t=arguments[0];return t.getFactory().buildGeometry(Ap.getLines(t))}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e.getFactory().buildGeometry(Ap.getLines(e,n))}},Ap.getLines=function(){if(1===arguments.length){var t=arguments[0];return Ap.getLines(t,!1)}if(2===arguments.length){if(nc(arguments[0],Wc)&&nc(arguments[1],Wc)){for(var e=arguments[0],n=arguments[1],r=e.iterator();r.hasNext();){var i=r.next();Ap.getLines(i,n)}return n}if(arguments[0]instanceof Fc&&"boolean"==typeof arguments[1]){var s=arguments[0],o=arguments[1],a=new Kc;return s.apply(new Ap(a,o)),a}if(arguments[0]instanceof Fc&&nc(arguments[1],Wc)){var l=arguments[0],h=arguments[1];return l instanceof zu?h.add(l):l.apply(new Ap(h)),h}}else if(3===arguments.length){if("boolean"==typeof arguments[2]&&nc(arguments[0],Wc)&&nc(arguments[1],Wc)){for(var c=arguments[0],u=arguments[1],f=arguments[2],d=c.iterator();d.hasNext();){var p=d.next();Ap.getLines(p,u,f)}return u}if("boolean"==typeof arguments[2]&&arguments[0]instanceof Fc&&nc(arguments[1],Wc)){var A=arguments[0],g=arguments[1],m=arguments[2];return A.apply(new Ap(g,m)),g}}};var gp=function(){if(this.oe=Hc.OGC_SFS_BOUNDARY_RULE,this.he=null,this.fe=null,0===arguments.length);else if(1===arguments.length){var t=arguments[0];if(null===t)throw new Vh("Rule must be non-null");this.oe=t}};gp.prototype.locateInternal=function(){var t=this;if(arguments[0]instanceof Zh&&arguments[1]instanceof ju){var e=arguments[0],n=arguments[1];if(n.isEmpty())return tc.EXTERIOR;var r=n.getExteriorRing(),i=this.locateInPolygonRing(e,r);if(i===tc.EXTERIOR)return tc.EXTERIOR;if(i===tc.BOUNDARY)return tc.BOUNDARY;for(var s=0;s<n.getNumInteriorRing();s++){var o=n.getInteriorRingN(s),a=t.locateInPolygonRing(e,o);if(a===tc.INTERIOR)return tc.EXTERIOR;if(a===tc.BOUNDARY)return tc.BOUNDARY}return tc.INTERIOR}if(arguments[0]instanceof Zh&&arguments[1]instanceof zu){var l=arguments[0],h=arguments[1];if(!h.getEnvelopeInternal().intersects(l))return tc.EXTERIOR;var c=h.getCoordinates();return h.isClosed()||!l.equals(c[0])&&!l.equals(c[c.length-1])?Rc.isOnLine(l,c)?tc.INTERIOR:tc.EXTERIOR:tc.BOUNDARY}if(arguments[0]instanceof Zh&&arguments[1]instanceof Hu){var u=arguments[0],f=arguments[1],d=f.getCoordinate();return d.equals2D(u)?tc.INTERIOR:tc.EXTERIOR}},gp.prototype.locateInPolygonRing=function(t,e){return e.getEnvelopeInternal().intersects(t)?Rc.locatePointInRing(t,e.getCoordinates()):tc.EXTERIOR},gp.prototype.intersects=function(t,e){return this.locate(t,e)!==tc.EXTERIOR},gp.prototype.updateLocationInfo=function(t){t===tc.INTERIOR&&(this.he=!0),t===tc.BOUNDARY&&this.fe++},gp.prototype.computeLocation=function(t,e){if(e instanceof Hu&&this.updateLocationInfo(this.locateInternal(t,e)),e instanceof zu)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof ju)this.updateLocationInfo(this.locateInternal(t,e));else if(e instanceof Su)for(var n=e,r=0;r<n.getNumGeometries();r++){var i=n.getGeometryN(r);this.updateLocationInfo(this.locateInternal(t,i))}else if(e instanceof qu)for(var s=e,o=0;o<s.getNumGeometries();o++){var a=s.getGeometryN(o);this.updateLocationInfo(this.locateInternal(t,a))}else if(e instanceof Tu)for(var l=new kd(e);l.hasNext();){var h=l.next();h!==e&&this.computeLocation(t,h)}},gp.prototype.locate=function(t,e){return e.isEmpty()?tc.EXTERIOR:e instanceof zu||e instanceof ju?this.locateInternal(t,e):(this.he=!1,this.fe=0,this.computeLocation(t,e),this.oe.isInBoundary(this.fe)?tc.BOUNDARY:this.fe>0||this.he?tc.INTERIOR:tc.EXTERIOR)},gp.prototype.interfaces_=function(){return[]},gp.prototype.getClass=function(){return gp};var mp=function t(){if(this.ce=null,this.ae=null,this.kr=null,2===arguments.length){var e=arguments[0],n=arguments[1];t.call(this,e,t.INSIDE_AREA,n)}else if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2];this.ce=r,this.ae=i,this.kr=s}},yp={INSIDE_AREA:{configurable:!0}};mp.prototype.isInsideArea=function(){return this.ae===mp.INSIDE_AREA},mp.prototype.getCoordinate=function(){return this.kr},mp.prototype.getGeometryComponent=function(){return this.ce},mp.prototype.getSegmentIndex=function(){return this.ae},mp.prototype.interfaces_=function(){return[]},mp.prototype.getClass=function(){return mp},yp.INSIDE_AREA.get=function(){return-1},Object.defineProperties(mp,yp);var vp=function(t){this.zn=t||null};vp.prototype.filter=function(t){t instanceof Hu&&this.zn.add(t)},vp.prototype.interfaces_=function(){return[_u]},vp.prototype.getClass=function(){return vp},vp.getPoints=function(){if(1===arguments.length){var t=arguments[0];return t instanceof Hu?qf.singletonList(t):vp.getPoints(t,new Kc)}if(2===arguments.length){var e=arguments[0],n=arguments[1];return e instanceof Hu?n.add(e):e instanceof Tu&&e.apply(new vp(n)),n}};var xp=function(){this.ve=null;var t=arguments[0];this.ve=t};xp.prototype.filter=function(t){(t instanceof Hu||t instanceof zu||t instanceof ju)&&this.ve.add(new mp(t,0,t.getCoordinate()))},xp.prototype.interfaces_=function(){return[_u]},xp.prototype.getClass=function(){return xp},xp.getLocations=function(t){var e=new Kc;return t.apply(new xp(e)),e};var bp=function(){if(this.An=null,this.we=0,this.Pe=new gp,this.Ce=null,this.De=Gh.MAX_VALUE,2===arguments.length){var t=arguments[0],e=arguments[1];this.An=[t,e],this.we=0}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.An=new Array(2).fill(null),this.An[0]=n,this.An[1]=r,this.we=i}};bp.prototype.computeContainmentDistance=function(){var t=this;if(0===arguments.length){var e=new Array(2).fill(null);if(this.computeContainmentDistance(0,e),this.De<=this.we)return null;this.computeContainmentDistance(1,e)}else if(2===arguments.length){var n=arguments[0],r=arguments[1],i=1-n,s=pp.getPolygons(this.An[n]);if(s.size()>0){var o=xp.getLocations(this.An[i]);if(this.computeContainmentDistance(o,s,r),this.De<=this.we)return this.Ce[i]=r[0],this.Ce[n]=r[1],null}}else if(3===arguments.length)if(arguments[2]instanceof Array&&nc(arguments[0],Yc)&&nc(arguments[1],Yc)){for(var a=arguments[0],l=arguments[1],h=arguments[2],c=0;c<a.size();c++)for(var u=a.get(c),f=0;f<l.size();f++)if(t.computeContainmentDistance(u,l.get(f),h),t.De<=t.we)return null}else if(arguments[2]instanceof Array&&arguments[0]instanceof mp&&arguments[1]instanceof ju){var d=arguments[0],p=arguments[1],A=arguments[2],g=d.getCoordinate();if(tc.EXTERIOR!==this.Pe.locate(g,p))return this.De=0,A[0]=d,A[1]=new mp(p,g),null}},bp.prototype.computeMinDistanceLinesPoints=function(t,e,n){for(var r=0;r<t.size();r++)for(var i=t.get(r),s=0;s<e.size();s++){var o=e.get(s);if(this.computeMinDistance(i,o,n),this.De<=this.we)return null}},bp.prototype.computeFacetDistance=function(){var t=new Array(2).fill(null),e=Ap.getLines(this.An[0]),n=Ap.getLines(this.An[1]),r=vp.getPoints(this.An[0]),i=vp.getPoints(this.An[1]);return this.computeMinDistanceLines(e,n,t),this.updateMinDistance(t,!1),this.De<=this.we?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(e,i,t),this.updateMinDistance(t,!1),this.De<=this.we?null:(t[0]=null,t[1]=null,this.computeMinDistanceLinesPoints(n,r,t),this.updateMinDistance(t,!0),this.De<=this.we?null:(t[0]=null,t[1]=null,this.computeMinDistancePoints(r,i,t),void this.updateMinDistance(t,!1))))},bp.prototype.nearestLocations=function(){return this.computeMinDistance(),this.Ce},bp.prototype.updateMinDistance=function(t,e){if(null===t[0])return null;e?(this.Ce[0]=t[1],this.Ce[1]=t[0]):(this.Ce[0]=t[0],this.Ce[1]=t[1])},bp.prototype.nearestPoints=function(){return this.computeMinDistance(),[this.Ce[0].getCoordinate(),this.Ce[1].getCoordinate()]},bp.prototype.computeMinDistance=function(){var t=this;if(0===arguments.length){if(null!==this.Ce)return null;if(this.Ce=new Array(2).fill(null),this.computeContainmentDistance(),this.De<=this.we)return null;this.computeFacetDistance()}else if(3===arguments.length)if(arguments[2]instanceof Array&&arguments[0]instanceof zu&&arguments[1]instanceof Hu){var e=arguments[0],n=arguments[1],r=arguments[2];if(e.getEnvelopeInternal().distance(n.getEnvelopeInternal())>this.De)return null;for(var i=e.getCoordinates(),s=n.getCoordinate(),o=0;o<i.length-1;o++){var a=Rc.distancePointLine(s,i[o],i[o+1]);if(a<t.De){t.De=a;var l=new od(i[o],i[o+1]),h=l.closestPoint(s);r[0]=new mp(e,o,h),r[1]=new mp(n,0,s)}if(t.De<=t.we)return null}}else if(arguments[2]instanceof Array&&arguments[0]instanceof zu&&arguments[1]instanceof zu){var c=arguments[0],u=arguments[1],f=arguments[2];if(c.getEnvelopeInternal().distance(u.getEnvelopeInternal())>this.De)return null;for(var d=c.getCoordinates(),p=u.getCoordinates(),A=0;A<d.length-1;A++)for(var g=0;g<p.length-1;g++){var m=Rc.distanceLineLine(d[A],d[A+1],p[g],p[g+1]);if(m<t.De){t.De=m;var y=new od(d[A],d[A+1]),v=new od(p[g],p[g+1]),x=y.closestPoints(v);f[0]=new mp(c,A,x[0]),f[1]=new mp(u,g,x[1])}if(t.De<=t.we)return null}}},bp.prototype.computeMinDistancePoints=function(t,e,n){for(var r=0;r<t.size();r++)for(var i=t.get(r),s=0;s<e.size();s++){var o=e.get(s),a=i.getCoordinate().distance(o.getCoordinate());if(a<this.De&&(this.De=a,n[0]=new mp(i,0,i.getCoordinate()),n[1]=new mp(o,0,o.getCoordinate())),this.De<=this.we)return null}},bp.prototype.distance=function(){if(null===this.An[0]||null===this.An[1])throw new Vh("null geometries are not supported");return this.An[0].isEmpty()||this.An[1].isEmpty()?0:(this.computeMinDistance(),this.De)},bp.prototype.computeMinDistanceLines=function(t,e,n){for(var r=0;r<t.size();r++)for(var i=t.get(r),s=0;s<e.size();s++){var o=e.get(s);if(this.computeMinDistance(i,o,n),this.De<=this.we)return null}},bp.prototype.interfaces_=function(){return[]},bp.prototype.getClass=function(){return bp},bp.distance=function(t,e){return new bp(t,e).distance()},bp.isWithinDistance=function(t,e,n){return new bp(t,e,n).distance()<=n},bp.nearestPoints=function(t,e){return new bp(t,e).nearestPoints()};var wp=function(){this.kr=[new Zh,new Zh],this.ii=Gh.NaN,this.ie=!0};wp.prototype.getCoordinates=function(){return this.kr},wp.prototype.getCoordinate=function(t){return this.kr[t]},wp.prototype.setMinimum=function(){if(1===arguments.length){var t=arguments[0];this.setMinimum(t.kr[0],t.kr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.ie)return this.initialize(e,n),null;var r=e.distance(n);r<this.ii&&this.initialize(e,n,r)}},wp.prototype.initialize=function(){if(0===arguments.length)this.ie=!0;else if(2===arguments.length){var t=arguments[0],e=arguments[1];this.kr[0].setCoordinate(t),this.kr[1].setCoordinate(e),this.ii=t.distance(e),this.ie=!1}else if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2];this.kr[0].setCoordinate(n),this.kr[1].setCoordinate(r),this.ii=i,this.ie=!1}},wp.prototype.toString=function(){return Mc.toLineString(this.kr[0],this.kr[1])},wp.prototype.getDistance=function(){return this.ii},wp.prototype.setMaximum=function(){if(1===arguments.length){var t=arguments[0];this.setMaximum(t.kr[0],t.kr[1])}else if(2===arguments.length){var e=arguments[0],n=arguments[1];if(this.ie)return this.initialize(e,n),null;var r=e.distance(n);r>this.ii&&this.initialize(e,n,r)}},wp.prototype.interfaces_=function(){return[]},wp.prototype.getClass=function(){return wp};var _p=function(){};_p.prototype.interfaces_=function(){return[]},_p.prototype.getClass=function(){return _p},_p.computeDistance=function(){if(arguments[2]instanceof wp&&arguments[0]instanceof zu&&arguments[1]instanceof Zh)for(var t=arguments[0],e=arguments[1],n=arguments[2],r=new od,i=t.getCoordinates(),s=0;s<i.length-1;s++){r.setCoordinates(i[s],i[s+1]);var o=r.closestPoint(e);n.setMinimum(o,e)}else if(arguments[2]instanceof wp&&arguments[0]instanceof ju&&arguments[1]instanceof Zh){var a=arguments[0],l=arguments[1],h=arguments[2];_p.computeDistance(a.getExteriorRing(),l,h);for(var c=0;c<a.getNumInteriorRing();c++)_p.computeDistance(a.getInteriorRingN(c),l,h)}else if(arguments[2]instanceof wp&&arguments[0]instanceof Fc&&arguments[1]instanceof Zh){var u=arguments[0],f=arguments[1],d=arguments[2];if(u instanceof zu)_p.computeDistance(u,f,d);else if(u instanceof ju)_p.computeDistance(u,f,d);else if(u instanceof Tu)for(var p=u,A=0;A<p.getNumGeometries();A++){var g=p.getGeometryN(A);_p.computeDistance(g,f,d)}else d.setMinimum(u.getCoordinate(),f)}else if(arguments[2]instanceof wp&&arguments[0]instanceof od&&arguments[1]instanceof Zh){var m=arguments[0],y=arguments[1],v=arguments[2],x=m.closestPoint(y);v.setMinimum(x,y)}};var Mp=function(){this.Ie=null,this.Me=null,this.be=new wp,this.ze=0;var t=arguments[0],e=arguments[1];this.Ie=t,this.Me=e},Tp={MaxPointDistanceFilter:{configurable:!0},MaxDensifiedByFractionDistanceFilter:{configurable:!0}};Mp.prototype.getCoordinates=function(){return this.be.getCoordinates()},Mp.prototype.setDensifyFraction=function(t){if(t>1||t<=0)throw new Vh("Fraction is not in range (0.0 - 1.0]");this.ze=t},Mp.prototype.compute=function(t,e){this.computeOrientedDistance(t,e,this.be),this.computeOrientedDistance(e,t,this.be)},Mp.prototype.distance=function(){return this.compute(this.Ie,this.Me),this.be.getDistance()},Mp.prototype.computeOrientedDistance=function(t,e,n){var r=new Sp(e);if(t.apply(r),n.setMaximum(r.getMaxPointDistance()),this.ze>0){var i=new Ip(e,this.ze);t.apply(i),n.setMaximum(i.getMaxPointDistance())}},Mp.prototype.orientedDistance=function(){return this.computeOrientedDistance(this.Ie,this.Me,this.be),this.be.getDistance()},Mp.prototype.interfaces_=function(){return[]},Mp.prototype.getClass=function(){return Mp},Mp.distance=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new Mp(t,e);return n.distance()}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2],o=new Mp(r,i);return o.setDensifyFraction(s),o.distance()}},Tp.MaxPointDistanceFilter.get=function(){return Sp},Tp.MaxDensifiedByFractionDistanceFilter.get=function(){return Ip},Object.defineProperties(Mp,Tp);var Sp=function(){this.re=new wp,this.ee=new wp,this.de=new _p,this.An=null;var t=arguments[0];this.An=t};Sp.prototype.filter=function(t){this.ee.initialize(),_p.computeDistance(this.An,t,this.ee),this.re.setMaximum(this.ee)},Sp.prototype.getMaxPointDistance=function(){return this.re},Sp.prototype.interfaces_=function(){return[Bc]},Sp.prototype.getClass=function(){return Sp};var Ip=function(){this.re=new wp,this.ee=new wp,this.An=null,this.xe=0;var t=arguments[0],e=arguments[1];this.An=t,this.xe=Math.trunc(Math.round(1/e))};Ip.prototype.filter=function(t,e){if(0===e)return null;for(var n=t.getCoordinate(e-1),r=t.getCoordinate(e),i=(r.x-n.x)/this.xe,s=(r.y-n.y)/this.xe,o=0;o<this.xe;o++){var a=n.x+o*i,l=n.y+o*s,h=new Zh(a,l);this.ee.initialize(),_p.computeDistance(this.An,h,this.ee),this.re.setMaximum(this.ee)}},Ip.prototype.isDone=function(){return!1},Ip.prototype.isGeometryChanged=function(){return!1},Ip.prototype.getMaxPointDistance=function(){return this.re},Ip.prototype.interfaces_=function(){return[Mu]},Ip.prototype.getClass=function(){return Ip};var Cp=function(t,e,n){this.me=null,this.ye=null,this.pe=null,this.Le=null,this.Te=!0,this.Oe=null,this.Fe=null,this.Ue=null,this.Ee=t||null,this.Ne=e||null,this.Bt=n||null},Op={VERBOSE:{configurable:!0},MAX_DISTANCE_DIFF_FRAC:{configurable:!0}};Cp.prototype.checkMaximumDistance=function(t,e,n){var r=new Mp(e,t);if(r.setDensifyFraction(.25),this.Le=r.orientedDistance(),this.Le>n){this.Te=!1;var i=r.getCoordinates();this.Fe=i[1],this.Ue=t.getFactory().createLineString(i),this.Oe="Distance between buffer curve and input is too large ("+this.Le+" at "+Mc.toLineString(i[0],i[1])+")"}},Cp.prototype.isValid=function(){var t=Math.abs(this.Ne),e=Cp.MAX_DISTANCE_DIFF_FRAC*t;return this.me=t-e,this.ye=t+e,!(!this.Ee.isEmpty()&&!this.Bt.isEmpty())||(this.Ne>0?this.checkPositiveValid():this.checkNegativeValid(),Cp.VERBOSE&&gc.out.println("Min Dist= "+this.pe+"  err= "+(1-this.pe/this.Ne)+"  Max Dist= "+this.Le+"  err= "+(this.Le/this.Ne-1)),this.Te)},Cp.prototype.checkNegativeValid=function(){if(!(this.Ee instanceof ju||this.Ee instanceof qu||this.Ee instanceof Tu))return null;var t=this.getPolygonLines(this.Ee);if(this.checkMinimumDistance(t,this.Bt,this.me),!this.Te)return null;this.checkMaximumDistance(t,this.Bt,this.ye)},Cp.prototype.getErrorIndicator=function(){return this.Ue},Cp.prototype.checkMinimumDistance=function(t,e,n){var r=new bp(t,e,n);if(this.pe=r.distance(),this.pe<n){this.Te=!1;var i=r.nearestPoints();this.Fe=r.nearestPoints()[1],this.Ue=t.getFactory().createLineString(i),this.Oe="Distance between buffer curve and input is too small ("+this.pe+" at "+Mc.toLineString(i[0],i[1])+" )"}},Cp.prototype.checkPositiveValid=function(){var t=this.Bt.getBoundary();if(this.checkMinimumDistance(this.Ee,t,this.me),!this.Te)return null;this.checkMaximumDistance(this.Ee,t,this.ye)},Cp.prototype.getErrorLocation=function(){return this.Fe},Cp.prototype.getPolygonLines=function(t){for(var e=new Kc,n=new Ap(e),r=pp.getPolygons(t).iterator();r.hasNext();)r.next().apply(n);return t.getFactory().buildGeometry(e)},Cp.prototype.getErrorMessage=function(){return this.Oe},Cp.prototype.interfaces_=function(){return[]},Cp.prototype.getClass=function(){return Cp},Op.VERBOSE.get=function(){return!1},Op.MAX_DISTANCE_DIFF_FRAC.get=function(){return.012},Object.defineProperties(Cp,Op);var Ep=function(t,e,n){this.Te=!0,this.je=null,this.Fe=null,this.Ue=null,this.Ee=t||null,this.ii=e||null,this.Bt=n||null},Pp={VERBOSE:{configurable:!0},MAX_ENV_DIFF_FRAC:{configurable:!0}};Ep.prototype.isValid=function(){return this.checkPolygonal(),this.Te?(this.checkExpectedEmpty(),this.Te?(this.checkEnvelope(),this.Te?(this.checkArea(),this.Te?(this.checkDistance(),this.Te):this.Te):this.Te):this.Te):this.Te},Ep.prototype.checkEnvelope=function(){if(this.ii<0)return null;var t=this.ii*Ep.MAX_ENV_DIFF_FRAC;0===t&&(t=.001);var e=new yc(this.Ee.getEnvelopeInternal());e.expandBy(this.ii);var n=new yc(this.Bt.getEnvelopeInternal());n.expandBy(t),n.contains(e)||(this.Te=!1,this.je="Buffer envelope is incorrect",this.Ue=this.Ee.getFactory().toGeometry(n)),this.report("Envelope")},Ep.prototype.checkDistance=function(){var t=new Cp(this.Ee,this.ii,this.Bt);t.isValid()||(this.Te=!1,this.je=t.getErrorMessage(),this.Fe=t.getErrorLocation(),this.Ue=t.getErrorIndicator()),this.report("Distance")},Ep.prototype.checkArea=function(){var t=this.Ee.getArea(),e=this.Bt.getArea();this.ii>0&&t>e&&(this.Te=!1,this.je="Area of positive buffer is smaller than input",this.Ue=this.Bt),this.ii<0&&t<e&&(this.Te=!1,this.je="Area of negative buffer is larger than input",this.Ue=this.Bt),this.report("Area")},Ep.prototype.checkPolygonal=function(){this.Bt instanceof ju||this.Bt instanceof qu||(this.Te=!1),this.je="Result is not polygonal",this.Ue=this.Bt,this.report("Polygonal")},Ep.prototype.getErrorIndicator=function(){return this.Ue},Ep.prototype.getErrorLocation=function(){return this.Fe},Ep.prototype.checkExpectedEmpty=function(){return this.Ee.getDimension()>=2||this.ii>0?null:(this.Bt.isEmpty()||(this.Te=!1,this.je="Result is non-empty",this.Ue=this.Bt),void this.report("ExpectedEmpty"))},Ep.prototype.report=function(t){if(!Ep.VERBOSE)return null;gc.out.println("Check "+t+": "+(this.Te?"passed":"FAILED"))},Ep.prototype.getErrorMessage=function(){return this.je},Ep.prototype.interfaces_=function(){return[]},Ep.prototype.getClass=function(){return Ep},Ep.isValidMsg=function(t,e,n){var r=new Ep(t,e,n);return r.isValid()?null:r.getErrorMessage()},Ep.isValid=function(t,e,n){return!!new Ep(t,e,n).isValid()},Pp.VERBOSE.get=function(){return!1},Pp.MAX_ENV_DIFF_FRAC.get=function(){return.012},Object.defineProperties(Ep,Pp);var kp=function(){this.zn=null,this.li=null;var t=arguments[0],e=arguments[1];this.zn=t,this.li=e};kp.prototype.getCoordinates=function(){return this.zn},kp.prototype.size=function(){return this.zn.length},kp.prototype.getCoordinate=function(t){return this.zn[t]},kp.prototype.isClosed=function(){return this.zn[0].equals(this.zn[this.zn.length-1])},kp.prototype.getSegmentOctant=function(t){return t===this.zn.length-1?-1:nd.octant(this.getCoordinate(t),this.getCoordinate(t+1))},kp.prototype.setData=function(t){this.li=t},kp.prototype.getData=function(){return this.li},kp.prototype.toString=function(){return Mc.toLineString(new Ku(this.zn))},kp.prototype.interfaces_=function(){return[rd]},kp.prototype.getClass=function(){return kp};var Rp=function(){this.Qe=!1,this.Se=!1,this.Vi=null,this.Be=null,this.ke=null,this.Re=new Kc,this.Ge=0,this.Ye=!0;var t=arguments[0];this.Vi=t,this.Be=null};Rp.prototype.getInteriorIntersection=function(){return this.Be},Rp.prototype.setCheckEndSegmentsOnly=function(t){this.Se=t},Rp.prototype.getIntersectionSegments=function(){return this.ke},Rp.prototype.count=function(){return this.Ge},Rp.prototype.getIntersections=function(){return this.Re},Rp.prototype.setFindAllIntersections=function(t){this.Qe=t},Rp.prototype.setKeepIntersections=function(t){this.Ye=t},Rp.prototype.processIntersections=function(t,e,n,r){if(!this.Qe&&this.hasIntersection())return null;if(t===n&&e===r)return null;if(this.Se&&!this.isEndSegment(t,e)&&!this.isEndSegment(n,r))return null;var i=t.getCoordinates()[e],s=t.getCoordinates()[e+1],o=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Vi.computeIntersection(i,s,o,a),this.Vi.hasIntersection()&&this.Vi.isInteriorIntersection()&&(this.ke=new Array(4).fill(null),this.ke[0]=i,this.ke[1]=s,this.ke[2]=o,this.ke[3]=a,this.Be=this.Vi.getIntersection(0),this.Ye&&this.Re.add(this.Be),this.Ge++)},Rp.prototype.isEndSegment=function(t,e){return 0===e||e>=t.size()-2},Rp.prototype.hasIntersection=function(){return null!==this.Be},Rp.prototype.isDone=function(){return!this.Qe&&null!==this.Be},Rp.prototype.interfaces_=function(){return[Bd]},Rp.prototype.getClass=function(){return Rp},Rp.createAllIntersectionsFinder=function(t){var e=new Rp(t);return e.setFindAllIntersections(!0),e},Rp.createAnyIntersectionFinder=function(t){return new Rp(t)},Rp.createIntersectionCounter=function(t){var e=new Rp(t);return e.setFindAllIntersections(!0),e.setKeepIntersections(!1),e};var Np=function(){this.Vi=new Ec,this.Br=null,this.Qe=!1,this.Mi=null,this.Te=!0;var t=arguments[0];this.Br=t};Np.prototype.execute=function(){if(null!==this.Mi)return null;this.checkInteriorIntersections()},Np.prototype.getIntersections=function(){return this.Mi.getIntersections()},Np.prototype.isValid=function(){return this.execute(),this.Te},Np.prototype.setFindAllIntersections=function(t){this.Qe=t},Np.prototype.checkInteriorIntersections=function(){this.Te=!0,this.Mi=new Rp(this.Vi),this.Mi.setFindAllIntersections(this.Qe);var t=new dd;if(t.setSegmentIntersector(this.Mi),t.computeNodes(this.Br),this.Mi.hasIntersection())return this.Te=!1,null},Np.prototype.checkValid=function(){if(this.execute(),!this.Te)throw new xf(this.getErrorMessage(),this.Mi.getInteriorIntersection())},Np.prototype.getErrorMessage=function(){if(this.Te)return"no intersections found";var t=this.Mi.getIntersectionSegments();return"found non-noded intersection between "+Mc.toLineString(t[0],t[1])+" and "+Mc.toLineString(t[2],t[3])},Np.prototype.interfaces_=function(){return[]},Np.prototype.getClass=function(){return Np},Np.computeIntersections=function(t){var e=new Np(t);return e.setFindAllIntersections(!0),e.isValid(),e.getIntersections()};var Dp=function t(){this.qe=null;var e=arguments[0];this.qe=new Np(t.toSegmentStrings(e))};Dp.prototype.checkValid=function(){this.qe.checkValid()},Dp.prototype.interfaces_=function(){return[]},Dp.prototype.getClass=function(){return Dp},Dp.toSegmentStrings=function(t){for(var e=new Kc,n=t.iterator();n.hasNext();){var r=n.next();e.add(new kp(r.getCoordinates(),r))}return e},Dp.checkValid=function(t){new Dp(t).checkValid()};var Fp=function(t){this.Ve=t};Fp.prototype.map=function(t){for(var e=new Kc,n=0;n<t.getNumGeometries();n++){var r=this.Ve.map(t.getGeometryN(n));r.isEmpty()||e.add(r)}return t.getFactory().createGeometryCollection(af.toGeometryArray(e))},Fp.prototype.interfaces_=function(){return[]},Fp.prototype.getClass=function(){return Fp},Fp.map=function(t,e){return new Fp(e).map(t)};var Lp=function(){this.We=null,this.yn=null,this.Pe=null,this._e=new Kc,this.Ke=new Kc;var t=arguments[0],e=arguments[1],n=arguments[2];this.We=t,this.yn=e,this.Pe=n};Lp.prototype.collectLines=function(t){for(var e=this.We.getGraph().getEdgeEnds().iterator();e.hasNext();){var n=e.next();this.collectLineEdge(n,t,this._e),this.collectBoundaryTouchEdge(n,t,this._e)}},Lp.prototype.labelIsolatedLine=function(t,e){var n=this.Pe.locate(t.getCoordinate(),this.We.getArgGeometry(e));t.getLabel().setLocation(e,n)},Lp.prototype.build=function(t){return this.findCoveredLineEdges(),this.collectLines(t),this.buildLines(t),this.Ke},Lp.prototype.collectLineEdge=function(t,e,n){var r=t.getLabel(),i=t.getEdge();t.isLineEdge()&&(t.isVisited()||!mA.isResultOfOp(r,e)||i.isCovered()||(n.add(i),t.setVisitedEdge(!0)))},Lp.prototype.findCoveredLineEdges=function(){for(var t=this.We.getGraph().getNodes().iterator();t.hasNext();)t.next().getEdges().findCoveredLineEdges();for(var e=this.We.getGraph().getEdgeEnds().iterator();e.hasNext();){var n=e.next(),r=n.getEdge();if(n.isLineEdge()&&!r.isCoveredSet()){var i=this.We.isCoveredByA(n.getCoordinate());r.setCovered(i)}}},Lp.prototype.labelIsolatedLines=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next(),r=n.getLabel();n.isIsolated()&&(r.isNull(0)?this.labelIsolatedLine(n,0):this.labelIsolatedLine(n,1))}},Lp.prototype.buildLines=function(t){for(var e=this._e.iterator();e.hasNext();){var n=e.next(),r=this.yn.createLineString(n.getCoordinates());this.Ke.add(r),n.setInResult(!0)}},Lp.prototype.collectBoundaryTouchEdge=function(t,e,n){var r=t.getLabel();return t.isLineEdge()||t.isVisited()||t.isInteriorAreaEdge()||t.getEdge().isInResult()?null:(Ic.isTrue(!(t.isInResult()||t.getSym().isInResult())||!t.getEdge().isInResult()),void(mA.isResultOfOp(r,e)&&e===mA.INTERSECTION&&(n.add(t.getEdge()),t.setVisitedEdge(!0))))},Lp.prototype.interfaces_=function(){return[]},Lp.prototype.getClass=function(){return Lp};var zp=function(){this.We=null,this.yn=null,this.He=new Kc;var t=arguments[0],e=arguments[1];this.We=t,this.yn=e};zp.prototype.filterCoveredNodeToPoint=function(t){var e=t.getCoordinate();if(!this.We.isCoveredByLA(e)){var n=this.yn.createPoint(e);this.He.add(n)}},zp.prototype.extractNonCoveredResultNodes=function(t){for(var e=this.We.getGraph().getNodes().iterator();e.hasNext();){var n=e.next();if(!n.isInResult()&&!n.isIncidentEdgeInResult()&&(0===n.getEdges().getDegree()||t===mA.INTERSECTION)){var r=n.getLabel();mA.isResultOfOp(r,t)&&this.filterCoveredNodeToPoint(n)}}},zp.prototype.build=function(t){return this.extractNonCoveredResultNodes(t),this.He},zp.prototype.interfaces_=function(){return[]},zp.prototype.getClass=function(){return zp};var Bp=function(){this.sr=null,this.Zt=null,this.Je=!0,this.Ze=!0,this.Xe=!1,this.$e=!1};Bp.prototype.transformPoint=function(t,e){return this.Zt.createPoint(this.transformCoordinates(t.getCoordinateSequence(),t))},Bp.prototype.transformPolygon=function(t,e){var n=!0,r=this.transformLinearRing(t.getExteriorRing(),t);null!==r&&r instanceof Gu&&!r.isEmpty()||(n=!1);for(var i=new Kc,s=0;s<t.getNumInteriorRing();s++){var o=this.transformLinearRing(t.getInteriorRingN(s),t);null===o||o.isEmpty()||(o instanceof Gu||(n=!1),i.add(o))}if(n)return this.Zt.createPolygon(r,i.toArray([]));var a=new Kc;return null!==r&&a.add(r),a.addAll(i),this.Zt.buildGeometry(a)},Bp.prototype.createCoordinateSequence=function(t){return this.Zt.getCoordinateSequenceFactory().create(t)},Bp.prototype.getInputGeometry=function(){return this.sr},Bp.prototype.transformMultiLineString=function(t,e){for(var n=new Kc,r=0;r<t.getNumGeometries();r++){var i=this.transformLineString(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},Bp.prototype.transformCoordinates=function(t,e){return this.copy(t)},Bp.prototype.transformLineString=function(t,e){return this.Zt.createLineString(this.transformCoordinates(t.getCoordinateSequence(),t))},Bp.prototype.transformMultiPoint=function(t,e){for(var n=new Kc,r=0;r<t.getNumGeometries();r++){var i=this.transformPoint(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},Bp.prototype.transformMultiPolygon=function(t,e){for(var n=new Kc,r=0;r<t.getNumGeometries();r++){var i=this.transformPolygon(t.getGeometryN(r),t);null!==i&&(i.isEmpty()||n.add(i))}return this.Zt.buildGeometry(n)},Bp.prototype.copy=function(t){return t.copy()},Bp.prototype.transformGeometryCollection=function(t,e){for(var n=new Kc,r=0;r<t.getNumGeometries();r++){var i=this.transform(t.getGeometryN(r));null!==i&&(this.Je&&i.isEmpty()||n.add(i))}return this.Ze?this.Zt.createGeometryCollection(af.toGeometryArray(n)):this.Zt.buildGeometry(n)},Bp.prototype.transform=function(t){if(this.sr=t,this.Zt=t.getFactory(),t instanceof Hu)return this.transformPoint(t,null);if(t instanceof Vu)return this.transformMultiPoint(t,null);if(t instanceof Gu)return this.transformLinearRing(t,null);if(t instanceof zu)return this.transformLineString(t,null);if(t instanceof Su)return this.transformMultiLineString(t,null);if(t instanceof ju)return this.transformPolygon(t,null);if(t instanceof qu)return this.transformMultiPolygon(t,null);if(t instanceof Tu)return this.transformGeometryCollection(t,null);throw new Vh("Unknown Geometry subtype: "+t.getClass().getName())},Bp.prototype.transformLinearRing=function(t,e){var n=this.transformCoordinates(t.getCoordinateSequence(),t);if(null===n)return this.Zt.createLinearRing(null);var r=n.size();return r>0&&r<4&&!this.$e?this.Zt.createLineString(n):this.Zt.createLinearRing(n)},Bp.prototype.interfaces_=function(){return[]},Bp.prototype.getClass=function(){return Bp};var Hp=function t(){if(this.As=0,this.ts=null,this.nr=new od,this.ns=!1,this.rs=!1,arguments[0]instanceof zu&&"number"==typeof arguments[1]){var e=arguments[0],n=arguments[1];t.call(this,e.getCoordinates(),n)}else if(arguments[0]instanceof Array&&"number"==typeof arguments[1]){var r=arguments[0],i=arguments[1];this.ts=r,this.rs=t.isClosed(r),this.As=i}};Hp.prototype.snapVertices=function(t,e){for(var n=this.rs?t.size()-1:t.size(),r=0;r<n;r++){var i=t.get(r),s=this.findSnapForVertex(i,e);null!==s&&(t.set(r,new Zh(s)),0===r&&this.rs&&t.set(t.size()-1,new Zh(s)))}},Hp.prototype.findSnapForVertex=function(t,e){for(var n=0;n<e.length;n++){if(t.equals2D(e[n]))return null;if(t.distance(e[n])<this.As)return e[n]}return null},Hp.prototype.snapTo=function(t){var e=new $c(this.ts);return this.snapVertices(e,t),this.snapSegments(e,t),e.toCoordinateArray()},Hp.prototype.snapSegments=function(t,e){if(0===e.length)return null;var n=e.length;e[0].equals2D(e[e.length-1])&&(n=e.length-1);for(var r=0;r<n;r++){var i=e[r],s=this.findSegmentIndexToSnap(i,t);s>=0&&t.add(s+1,new Zh(i),!1)}},Hp.prototype.findSegmentIndexToSnap=function(t,e){for(var n=Gh.MAX_VALUE,r=-1,i=0;i<e.size()-1;i++){if(this.nr.p0=e.get(i),this.nr.p1=e.get(i+1),this.nr.p0.equals2D(t)||this.nr.p1.equals2D(t)){if(this.ns)continue;return-1}var s=this.nr.distance(t);s<this.As&&s<n&&(n=s,r=i)}return r},Hp.prototype.setAllowSnappingToSourceVertices=function(t){this.ns=t},Hp.prototype.interfaces_=function(){return[]},Hp.prototype.getClass=function(){return Hp},Hp.isClosed=function(t){return!(t.length<=1)&&t[0].equals2D(t[t.length-1])};var Up=function(t){this.es=t||null},jp={SNAP_PRECISION_FACTOR:{configurable:!0}};Up.prototype.snapTo=function(t,e){var n=this.extractTargetCoordinates(t);return new Vp(e,n).transform(this.es)},Up.prototype.snapToSelf=function(t,e){var n=this.extractTargetCoordinates(this.es),r=new Vp(t,n,!0).transform(this.es),i=r;return e&&nc(i,Uu)&&(i=r.buffer(0)),i},Up.prototype.computeSnapTolerance=function(t){return this.computeMinimumSegmentLength(t)/10},Up.prototype.extractTargetCoordinates=function(t){for(var e=new yu,n=t.getCoordinates(),r=0;r<n.length;r++)e.add(n[r]);return e.toArray(new Array(0).fill(null))},Up.prototype.computeMinimumSegmentLength=function(t){for(var e=Gh.MAX_VALUE,n=0;n<t.length-1;n++){var r=t[n].distance(t[n+1]);r<e&&(e=r)}return e},Up.prototype.interfaces_=function(){return[]},Up.prototype.getClass=function(){return Up},Up.snap=function(t,e,n){var r=new Array(2).fill(null),i=new Up(t);r[0]=i.snapTo(e,n);var s=new Up(e);return r[1]=s.snapTo(r[0],n),r},Up.computeOverlaySnapTolerance=function(){if(1===arguments.length){var t=arguments[0],e=Up.computeSizeBasedSnapTolerance(t),n=t.getPrecisionModel();if(n.getType()===nf.FIXED){var r=1/n.getScale()*2/1.415;r>e&&(e=r)}return e}if(2===arguments.length){var i=arguments[0],s=arguments[1];return Math.min(Up.computeOverlaySnapTolerance(i),Up.computeOverlaySnapTolerance(s))}},Up.computeSizeBasedSnapTolerance=function(t){var e=t.getEnvelopeInternal();return Math.min(e.getHeight(),e.getWidth())*Up.SNAP_PRECISION_FACTOR},Up.snapToSelf=function(t,e,n){return new Up(t).snapToSelf(e,n)},jp.SNAP_PRECISION_FACTOR.get=function(){return 1e-9},Object.defineProperties(Up,jp);var Vp=function(t){function e(e,n,r){t.call(this),this.As=e||null,this.ss=n||null,this.us=void 0!==r&&r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.snapLine=function(t,e){var n=new Hp(t,this.As);return n.setAllowSnappingToSourceVertices(this.us),n.snapTo(e)},e.prototype.transformCoordinates=function(t,e){var n=t.toCoordinateArray(),r=this.snapLine(n,this.ss);return this.Zt.getCoordinateSequenceFactory().create(r)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(Bp),Gp=function(){this.os=!0,this.hs=53,this.fs=0,this.cs=null};Gp.prototype.getCommon=function(){return Gh.longBitsToDouble(this.fs)},Gp.prototype.add=function(t){var e=Gh.doubleToLongBits(t);return this.os?(this.fs=e,this.cs=Gp.signExpBits(this.fs),this.os=!1,null):Gp.signExpBits(e)!==this.cs?(this.fs=0,null):(this.hs=Gp.numCommonMostSigMantissaBits(this.fs,e),void(this.fs=Gp.zeroLowerBits(this.fs,64-(12+this.hs))))},Gp.prototype.toString=function(){if(1===arguments.length){var t=arguments[0],e=Gh.longBitsToDouble(t),n=Gh.toBinaryString(t),r="0000000000000000000000000000000000000000000000000000000000000000"+n,i=r.substring(r.length-64),s=i.substring(0,1)+"  "+i.substring(1,12)+"(exp) "+i.substring(12)+" [ "+e+" ]";return s}},Gp.prototype.interfaces_=function(){return[]},Gp.prototype.getClass=function(){return Gp},Gp.getBit=function(t,e){return 0!=(t&1<<e)?1:0},Gp.signExpBits=function(t){return t>>52},Gp.zeroLowerBits=function(t,e){return t&~((1<<e)-1)},Gp.numCommonMostSigMantissaBits=function(t,e){for(var n=0,r=52;r>=0;r--){if(Gp.getBit(t,r)!==Gp.getBit(e,r))return n;n++}return 52};var qp=function(){this.as=null,this.vs=new Xp},Wp={CommonCoordinateFilter:{configurable:!0},Translater:{configurable:!0}};qp.prototype.addCommonBits=function(t){var e=new Qp(this.as);t.apply(e),t.geometryChanged()},qp.prototype.removeCommonBits=function(t){if(0===this.as.x&&0===this.as.y)return t;var e=new Zh(this.as);e.x=-e.x,e.y=-e.y;var n=new Qp(e);return t.apply(n),t.geometryChanged(),t},qp.prototype.getCommonCoordinate=function(){return this.as},qp.prototype.add=function(t){t.apply(this.vs),this.as=this.vs.getCommonCoordinate()},qp.prototype.interfaces_=function(){return[]},qp.prototype.getClass=function(){return qp},Wp.CommonCoordinateFilter.get=function(){return Xp},Wp.Translater.get=function(){return Qp},Object.defineProperties(qp,Wp);var Xp=function(){this.ls=new Gp,this.ws=new Gp};Xp.prototype.filter=function(t){this.ls.add(t.x),this.ws.add(t.y)},Xp.prototype.getCommonCoordinate=function(){return new Zh(this.ls.getCommon(),this.ws.getCommon())},Xp.prototype.interfaces_=function(){return[Bc]},Xp.prototype.getClass=function(){return Xp};var Qp=function(){this.trans=null;var t=arguments[0];this.trans=t};Qp.prototype.filter=function(t,e){var n=t.getOrdinate(e,0)+this.trans.x,r=t.getOrdinate(e,1)+this.trans.y;t.setOrdinate(e,0,n),t.setOrdinate(e,1,r)},Qp.prototype.isDone=function(){return!1},Qp.prototype.isGeometryChanged=function(){return!0},Qp.prototype.interfaces_=function(){return[Mu]},Qp.prototype.getClass=function(){return Qp};var Yp=function(t,e){this.An=new Array(2).fill(null),this.As=null,this.Ps=null,this.An[0]=t,this.An[1]=e,this.computeSnapTolerance()};Yp.prototype.selfSnap=function(t){return new Up(t).snapTo(t,this.As)},Yp.prototype.removeCommonBits=function(t){this.Ps=new qp,this.Ps.add(t[0]),this.Ps.add(t[1]);var e=new Array(2).fill(null);return e[0]=this.Ps.removeCommonBits(t[0].copy()),e[1]=this.Ps.removeCommonBits(t[1].copy()),e},Yp.prototype.prepareResult=function(t){return this.Ps.addCommonBits(t),t},Yp.prototype.getResultGeometry=function(t){var e=this.snap(this.An),n=mA.overlayOp(e[0],e[1],t);return this.prepareResult(n)},Yp.prototype.checkValid=function(t){t.isValid()||gc.out.println("Snapped geometry is invalid")},Yp.prototype.computeSnapTolerance=function(){this.As=Up.computeOverlaySnapTolerance(this.An[0],this.An[1])},Yp.prototype.snap=function(t){var e=this.removeCommonBits(t);return Up.snap(e[0],e[1],this.As)},Yp.prototype.interfaces_=function(){return[]},Yp.prototype.getClass=function(){return Yp},Yp.overlayOp=function(t,e,n){return new Yp(t,e).getResultGeometry(n)},Yp.union=function(t,e){return Yp.overlayOp(t,e,mA.UNION)},Yp.intersection=function(t,e){return Yp.overlayOp(t,e,mA.INTERSECTION)},Yp.symDifference=function(t,e){return Yp.overlayOp(t,e,mA.SYMDIFFERENCE)},Yp.difference=function(t,e){return Yp.overlayOp(t,e,mA.DIFFERENCE)};var Zp=function(t,e){this.An=new Array(2).fill(null),this.An[0]=t,this.An[1]=e};Zp.prototype.getResultGeometry=function(t){var e=null,n=!1,r=null;try{e=mA.overlayOp(this.An[0],this.An[1],t),n=!0}catch(t){if(!(t instanceof Tc))throw t;r=t}if(!n)try{e=Yp.overlayOp(this.An[0],this.An[1],t)}catch(t){throw t instanceof Tc?r:t}return e},Zp.prototype.interfaces_=function(){return[]},Zp.prototype.getClass=function(){return Zp},Zp.overlayOp=function(t,e,n){return new Zp(t,e).getResultGeometry(n)},Zp.union=function(t,e){return Zp.overlayOp(t,e,mA.UNION)},Zp.intersection=function(t,e){return Zp.overlayOp(t,e,mA.INTERSECTION)},Zp.symDifference=function(t,e){return Zp.overlayOp(t,e,mA.SYMDIFFERENCE)},Zp.difference=function(t,e){return Zp.overlayOp(t,e,mA.DIFFERENCE)};var Kp=function(){this.mce=null,this.chainIndex=null;var t=arguments[0],e=arguments[1];this.mce=t,this.chainIndex=e};Kp.prototype.computeIntersections=function(t,e){this.mce.computeIntersectsForChain(this.chainIndex,t.mce,t.chainIndex,e)},Kp.prototype.interfaces_=function(){return[]},Kp.prototype.getClass=function(){return Kp};var Jp=function t(){if(this.dn=null,this.gs=null,this.Cs=null,this.Ds=null,this.Is=null,this.Ms=null,2===arguments.length){var e=arguments[0],n=arguments[1];this.Cs=t.DELETE,this.gs=e,this.Ds=n}else if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2];this.Cs=t.INSERT,this.dn=r,this.gs=i,this.Ms=s}},$p={INSERT:{configurable:!0},DELETE:{configurable:!0}};Jp.prototype.isDelete=function(){return this.Cs===Jp.DELETE},Jp.prototype.setDeleteEventIndex=function(t){this.Is=t},Jp.prototype.getObject=function(){return this.Ms},Jp.prototype.compareTo=function(t){var e=t;return this.gs<e.gs?-1:this.gs>e.gs?1:this.Cs<e.Cs?-1:this.Cs>e.Cs?1:0},Jp.prototype.getInsertEvent=function(){return this.Ds},Jp.prototype.isInsert=function(){return this.Cs===Jp.INSERT},Jp.prototype.isSameLabel=function(t){return null!==this.dn&&this.dn===t.dn},Jp.prototype.getDeleteEventIndex=function(){return this.Is},Jp.prototype.interfaces_=function(){return[Wh]},Jp.prototype.getClass=function(){return Jp},$p.INSERT.get=function(){return 1},$p.DELETE.get=function(){return 2},Object.defineProperties(Jp,$p);var tA=function(){};tA.prototype.interfaces_=function(){return[]},tA.prototype.getClass=function(){return tA};var eA=function(){this.br=!1,this.zr=!1,this.dr=!1,this.mr=null,this.Vi=null,this.bs=null,this.zs=null,this.yr=null,this.ds=0,this.numTests=0,this.xs=null,this.ms=!1,this.ys=!1;var t=arguments[0],e=arguments[1],n=arguments[2];this.Vi=t,this.bs=e,this.zs=n};eA.prototype.isTrivialIntersection=function(t,e,n,r){if(t===n&&1===this.Vi.getIntersectionNum()){if(eA.isAdjacentSegments(e,r))return!0;if(t.isClosed()){var i=t.getNumPoints()-1;if(0===e&&r===i||0===r&&e===i)return!0}}return!1},eA.prototype.getProperIntersectionPoint=function(){return this.mr},eA.prototype.setIsDoneIfProperInt=function(t){this.ys=t},eA.prototype.hasProperInteriorIntersection=function(){return this.dr},eA.prototype.isBoundaryPointInternal=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next().getCoordinate();if(t.isIntersection(r))return!0}return!1},eA.prototype.hasProperIntersection=function(){return this.zr},eA.prototype.hasIntersection=function(){return this.br},eA.prototype.isDone=function(){return this.ms},eA.prototype.isBoundaryPoint=function(t,e){return null!==e&&(!!this.isBoundaryPointInternal(t,e[0])||!!this.isBoundaryPointInternal(t,e[1]))},eA.prototype.setBoundaryNodes=function(t,e){this.xs=new Array(2).fill(null),this.xs[0]=t,this.xs[1]=e},eA.prototype.addIntersections=function(t,e,n,r){if(t===n&&e===r)return null;this.numTests++;var i=t.getCoordinates()[e],s=t.getCoordinates()[e+1],o=n.getCoordinates()[r],a=n.getCoordinates()[r+1];this.Vi.computeIntersection(i,s,o,a),this.Vi.hasIntersection()&&(this.zs&&(t.setIsolated(!1),n.setIsolated(!1)),this.ds++,this.isTrivialIntersection(t,e,n,r)||(this.br=!0,!this.bs&&this.Vi.isProper()||(t.addIntersections(this.Vi,e,0),n.addIntersections(this.Vi,r,1)),this.Vi.isProper()&&(this.mr=this.Vi.getIntersection(0).copy(),this.zr=!0,this.ys&&(this.ms=!0),this.isBoundaryPoint(this.Vi,this.xs)||(this.dr=!0))))},eA.prototype.interfaces_=function(){return[]},eA.prototype.getClass=function(){return eA},eA.isAdjacentSegments=function(t,e){return 1===Math.abs(t-e)};var nA=function(t){function e(){t.call(this),this.events=new Kc,this.nOverlaps=null}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.prepareEvents=function(){qf.sort(this.events);for(var t=0;t<this.events.size();t++){var e=this.events.get(t);e.isDelete()&&e.getInsertEvent().setDeleteEventIndex(t)}},e.prototype.computeIntersections=function(){var t=this;if(1===arguments.length){var e=arguments[0];this.nOverlaps=0,this.prepareEvents();for(var n=0;n<this.events.size();n++){var r=t.events.get(n);if(r.isInsert()&&t.processOverlaps(n,r.getDeleteEventIndex(),r,e),e.isDone())break}}else if(3===arguments.length)if(arguments[2]instanceof eA&&nc(arguments[0],Yc)&&nc(arguments[1],Yc)){var i=arguments[0],s=arguments[1],o=arguments[2];this.addEdges(i,i),this.addEdges(s,s),this.computeIntersections(o)}else if("boolean"==typeof arguments[2]&&nc(arguments[0],Yc)&&arguments[1]instanceof eA){var a=arguments[0],l=arguments[1],h=arguments[2];h?this.addEdges(a,null):this.addEdges(a),this.computeIntersections(l)}},e.prototype.addEdge=function(t,e){for(var n=t.getMonotoneChainEdge(),r=n.getStartIndexes(),i=0;i<r.length-1;i++){var s=new Kp(n,i),o=new Jp(e,n.getMinX(i),s);this.events.add(o),this.events.add(new Jp(n.getMaxX(i),o))}},e.prototype.processOverlaps=function(t,e,n,r){for(var i=n.getObject(),s=t;s<e;s++){var o=this.events.get(s);if(o.isInsert()){var a=o.getObject();n.isSameLabel(o)||(i.computeIntersections(a,r),this.nOverlaps++)}}},e.prototype.addEdges=function(){var t=this;if(1===arguments.length)for(var e=arguments[0],n=e.iterator();n.hasNext();){var r=n.next();t.addEdge(r,r)}else if(2===arguments.length)for(var i=arguments[0],s=arguments[1],o=i.iterator();o.hasNext();){var a=o.next();t.addEdge(a,s)}},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(tA),rA=function(){this.ps=Gh.POSITIVE_INFINITY,this.ar=Gh.NEGATIVE_INFINITY},iA={NodeComparator:{configurable:!0}};rA.prototype.getMin=function(){return this.ps},rA.prototype.intersects=function(t,e){return!(this.ps>e||this.ar<t)},rA.prototype.getMax=function(){return this.ar},rA.prototype.toString=function(){return Mc.toLineString(new Zh(this.ps,0),new Zh(this.ar,0))},rA.prototype.interfaces_=function(){return[]},rA.prototype.getClass=function(){return rA},iA.NodeComparator.get=function(){return sA},Object.defineProperties(rA,iA);var sA=function(){};sA.prototype.compare=function(t,e){var n=t,r=e,i=(n.ps+n.ar)/2,s=(r.ps+r.ar)/2;return i<s?-1:i>s?1:0},sA.prototype.interfaces_=function(){return[Qh]},sA.prototype.getClass=function(){return sA};var oA=function(t){function e(){t.call(this),this.Jn=null;var e=arguments[0],n=arguments[1],r=arguments[2];this.ps=e,this.ar=n,this.Jn=r}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;n.visitItem(this.Jn)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(rA),aA=function(t){function e(){t.call(this),this.Ls=null,this.Ts=null;var e=arguments[0],n=arguments[1];this.Ls=e,this.Ts=n,this.buildExtent(this.Ls,this.Ts)}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.buildExtent=function(t,e){this.ps=Math.min(t.ps,e.ps),this.ar=Math.max(t.ar,e.ar)},e.prototype.query=function(t,e,n){if(!this.intersects(t,e))return null;null!==this.Ls&&this.Ls.query(t,e,n),null!==this.Ts&&this.Ts.query(t,e,n)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(rA),lA=function(){this.Os=new Kc,this.ei=null,this.Ai=0};lA.prototype.buildTree=function(){qf.sort(this.Os,new rA.NodeComparator);for(var t=this.Os,e=null,n=new Kc;;){if(this.buildLevel(t,n),1===n.size())return n.get(0);e=t,t=n,n=e}},lA.prototype.insert=function(t,e,n){if(null!==this.ei)throw new Error("Index cannot be added to once it has been queried");this.Os.add(new oA(t,e,n))},lA.prototype.query=function(t,e,n){this.init(),this.ei.query(t,e,n)},lA.prototype.buildRoot=function(){if(null!==this.ei)return null;this.ei=this.buildTree()},lA.prototype.printNode=function(t){gc.out.println(Mc.toLineString(new Zh(t.ps,this.Ai),new Zh(t.ar,this.Ai)))},lA.prototype.init=function(){if(null!==this.ei)return null;this.buildRoot()},lA.prototype.buildLevel=function(t,e){this.Ai++,e.clear();for(var n=0;n<t.size();n+=2){var r=t.get(n);if(null===(n+1<t.size()?t.get(n):null))e.add(r);else{var i=new aA(t.get(n),t.get(n+1));e.add(i)}}},lA.prototype.interfaces_=function(){return[]},lA.prototype.getClass=function(){return lA};var hA=function(){this.Xn=new Kc};hA.prototype.visitItem=function(t){this.Xn.add(t)},hA.prototype.getItems=function(){return this.Xn},hA.prototype.interfaces_=function(){return[Uf]},hA.prototype.getClass=function(){return hA};var cA=function(){this.zi=null;var t=arguments[0];if(!nc(t,Uu))throw new Vh("Argument must be Polygonal");this.zi=new dA(t)},uA={SegmentVisitor:{configurable:!0},IntervalIndexedGeometry:{configurable:!0}};cA.prototype.locate=function(t){var e=new kc(t),n=new fA(e);return this.zi.query(t.y,t.y,n),e.getLocation()},cA.prototype.interfaces_=function(){return[Pd]},cA.prototype.getClass=function(){return cA},uA.SegmentVisitor.get=function(){return fA},uA.IntervalIndexedGeometry.get=function(){return dA},Object.defineProperties(cA,uA);var fA=function(){this.Fs=null;var t=arguments[0];this.Fs=t};fA.prototype.visitItem=function(t){var e=t;this.Fs.countSegment(e.getCoordinate(0),e.getCoordinate(1))},fA.prototype.interfaces_=function(){return[Uf]},fA.prototype.getClass=function(){return fA};var dA=function(){this.zi=new lA;var t=arguments[0];this.init(t)};dA.prototype.init=function(t){for(var e=Ap.getLines(t).iterator();e.hasNext();){var n=e.next().getCoordinates();this.addLine(n)}},dA.prototype.addLine=function(t){for(var e=1;e<t.length;e++){var n=new od(t[e-1],t[e]),r=Math.min(n.p0.y,n.p1.y),i=Math.max(n.p0.y,n.p1.y);this.zi.insert(r,i,n)}},dA.prototype.query=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new hA;return this.zi.query(t,e,n),n.getItems()}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2];this.zi.query(r,i,s)}},dA.prototype.interfaces_=function(){return[]},dA.prototype.getClass=function(){return dA};var pA=function(t){function e(){if(t.call(this),this.Us=null,this.Es=new ef,this.Ns=null,this.js=!0,this.Qs=null,this.Ss=null,this.Bs=!1,this.ks=null,this.Rs=null,this.Pe=new gp,2===arguments.length){var e=arguments[0],n=arguments[1],r=Hc.OGC_SFS_BOUNDARY_RULE;this.Qs=e,this.Us=n,this.Ns=r,null!==n&&this.add(n)}else if(3===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2];this.Qs=i,this.Us=s,this.Ns=o,null!==s&&this.add(s)}}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertBoundaryPoint=function(t,n){var r=this.gn.addNode(n).getLabel(),i=1;r.getLocation(t,Af.ON)===tc.BOUNDARY&&i++;var s=e.determineBoundary(this.Ns,i);r.setLocation(t,s)},e.prototype.computeSelfNodes=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1];return this.computeSelfNodes(t,e,!1)}if(3===arguments.length){var n=arguments[0],r=arguments[1],i=arguments[2],s=new eA(n,!0,!1);s.setIsDoneIfProperInt(i);var o=this.createEdgeSetIntersector(),a=this.Us instanceof Gu||this.Us instanceof ju||this.Us instanceof qu,l=r||!a;return o.computeIntersections(this.bn,s,l),this.addSelfIntersectionNodes(this.Qs),s}},e.prototype.computeSplitEdges=function(t){for(var e=this.bn.iterator();e.hasNext();)e.next().eiList.addSplitEdges(t)},e.prototype.computeEdgeIntersections=function(t,e,n){var r=new eA(e,n,!0);return r.setBoundaryNodes(this.getBoundaryNodes(),t.getBoundaryNodes()),this.createEdgeSetIntersector().computeIntersections(this.bn,t.bn,r),r},e.prototype.getGeometry=function(){return this.Us},e.prototype.getBoundaryNodeRule=function(){return this.Ns},e.prototype.hasTooFewPoints=function(){return this.Bs},e.prototype.addPoint=function(){if(arguments[0]instanceof Hu){var t=arguments[0],e=t.getCoordinate();this.insertPoint(this.Qs,e,tc.INTERIOR)}else if(arguments[0]instanceof Zh){var n=arguments[0];this.insertPoint(this.Qs,n,tc.INTERIOR)}},e.prototype.addPolygon=function(t){this.addPolygonRing(t.getExteriorRing(),tc.EXTERIOR,tc.INTERIOR);for(var e=0;e<t.getNumInteriorRing();e++){var n=t.getInteriorRingN(e);this.addPolygonRing(n,tc.INTERIOR,tc.EXTERIOR)}},e.prototype.addEdge=function(t){this.insertEdge(t);var e=t.getCoordinates();this.insertPoint(this.Qs,e[0],tc.BOUNDARY),this.insertPoint(this.Qs,e[e.length-1],tc.BOUNDARY)},e.prototype.addLineString=function(t){var e=tu.removeRepeatedPoints(t.getCoordinates());if(e.length<2)return this.Bs=!0,this.ks=e[0],null;var n=new Xd(e,new Mf(this.Qs,tc.INTERIOR));this.Es.put(t,n),this.insertEdge(n),Ic.isTrue(e.length>=2,"found LineString with single point"),this.insertBoundaryPoint(this.Qs,e[0]),this.insertBoundaryPoint(this.Qs,e[e.length-1])},e.prototype.getInvalidPoint=function(){return this.ks},e.prototype.getBoundaryPoints=function(){for(var t=this.getBoundaryNodes(),e=new Array(t.size()).fill(null),n=0,r=t.iterator();r.hasNext();){var i=r.next();e[n++]=i.getCoordinate().copy()}return e},e.prototype.getBoundaryNodes=function(){return null===this.Ss&&(this.Ss=this.gn.getBoundaryNodes(this.Qs)),this.Ss},e.prototype.addSelfIntersectionNode=function(t,e,n){if(this.isBoundaryNode(t,e))return null;n===tc.BOUNDARY&&this.js?this.insertBoundaryPoint(t,e):this.insertPoint(t,e,n)},e.prototype.addPolygonRing=function(t,e,n){if(t.isEmpty())return null;var r=tu.removeRepeatedPoints(t.getCoordinates());if(r.length<4)return this.Bs=!0,this.ks=r[0],null;var i=e,s=n;Rc.isCCW(r)&&(i=n,s=e);var o=new Xd(r,new Mf(this.Qs,tc.BOUNDARY,i,s));this.Es.put(t,o),this.insertEdge(o),this.insertPoint(this.Qs,r[0],tc.BOUNDARY)},e.prototype.insertPoint=function(t,e,n){var r=this.gn.addNode(e),i=r.getLabel();null===i?r.dn=new Mf(t,n):i.setLocation(t,n)},e.prototype.createEdgeSetIntersector=function(){return new nA},e.prototype.addSelfIntersectionNodes=function(t){for(var e=this.bn.iterator();e.hasNext();)for(var n=e.next(),r=n.getLabel().getLocation(t),i=n.eiList.iterator();i.hasNext();){var s=i.next();this.addSelfIntersectionNode(t,s.coord,r)}},e.prototype.add=function(){if(1!==arguments.length)return t.prototype.add.apply(this,arguments);var e=arguments[0];if(e.isEmpty())return null;if(e instanceof qu&&(this.js=!1),e instanceof ju)this.addPolygon(e);else if(e instanceof zu)this.addLineString(e);else if(e instanceof Hu)this.addPoint(e);else if(e instanceof Vu)this.addCollection(e);else if(e instanceof Su)this.addCollection(e);else if(e instanceof qu)this.addCollection(e);else{if(!(e instanceof Tu))throw new Error(e.getClass().getName());this.addCollection(e)}},e.prototype.addCollection=function(t){for(var e=0;e<t.getNumGeometries();e++){var n=t.getGeometryN(e);this.add(n)}},e.prototype.locate=function(t){return nc(this.Us,Uu)&&this.Us.getNumGeometries()>50?(null===this.Rs&&(this.Rs=new cA(this.Us)),this.Rs.locate(t)):this.Pe.locate(t,this.Us)},e.prototype.findEdge=function(){if(1===arguments.length){var e=arguments[0];return this.Es.get(e)}return t.prototype.findEdge.apply(this,arguments)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e.determineBoundary=function(t,e){return t.isInBoundary(e)?tc.BOUNDARY:tc.INTERIOR},e}(Ff),AA=function(){if(this.Vi=new Ec,this.Gs=null,this.Ys=null,1===arguments.length){var t=arguments[0];this.setComputationPrecision(t.getPrecisionModel()),this.Ys=new Array(1).fill(null),this.Ys[0]=new pA(0,t)}else if(2===arguments.length){var e=arguments[0],n=arguments[1],r=Hc.OGC_SFS_BOUNDARY_RULE;e.getPrecisionModel().compareTo(n.getPrecisionModel())>=0?this.setComputationPrecision(e.getPrecisionModel()):this.setComputationPrecision(n.getPrecisionModel()),this.Ys=new Array(2).fill(null),this.Ys[0]=new pA(0,e,r),this.Ys[1]=new pA(1,n,r)}else if(3===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2];i.getPrecisionModel().compareTo(s.getPrecisionModel())>=0?this.setComputationPrecision(i.getPrecisionModel()):this.setComputationPrecision(s.getPrecisionModel()),this.Ys=new Array(2).fill(null),this.Ys[0]=new pA(0,i,o),this.Ys[1]=new pA(1,s,o)}};AA.prototype.getArgGeometry=function(t){return this.Ys[t].getGeometry()},AA.prototype.setComputationPrecision=function(t){this.Gs=t,this.Vi.setPrecisionModel(this.Gs)},AA.prototype.interfaces_=function(){return[]},AA.prototype.getClass=function(){return AA};var gA=function(){};gA.prototype.interfaces_=function(){return[]},gA.prototype.getClass=function(){return gA},gA.map=function(){if(arguments[0]instanceof Fc&&nc(arguments[1],gA.MapOp)){for(var t=arguments[0],e=arguments[1],n=new Kc,r=0;r<t.getNumGeometries();r++){var i=e.map(t.getGeometryN(r));null!==i&&n.add(i)}return t.getFactory().buildGeometry(n)}if(nc(arguments[0],Wc)&&nc(arguments[1],gA.MapOp)){for(var s=arguments[0],o=arguments[1],a=new Kc,l=s.iterator();l.hasNext();){var h=l.next(),c=o.map(h);null!==c&&a.add(c)}return a}},gA.MapOp=function(){};var mA=function(t){function e(){var e=arguments[0],n=arguments[1];t.call(this,e,n),this.Pe=new gp,this.tn=null,this.qs=null,this.Ur=null,this.wr=new zd,this.Vs=new Kc,this.Ke=new Kc,this.He=new Kc,this.Ur=new Ff(new Fd),this.tn=e.getFactory()}return t&&(e.__proto__=t),e.prototype=Object.create(t&&t.prototype),e.prototype.constructor=e,e.prototype.insertUniqueEdge=function(t){var e=this.wr.findEqualEdge(t);if(null!==e){var n=e.getLabel(),r=t.getLabel();e.isPointwiseEqual(t)||(r=new Mf(t.getLabel())).flip();var i=e.getDepth();i.isNull()&&i.add(n),i.add(r),n.merge(r)}else this.wr.add(t)},e.prototype.getGraph=function(){return this.Ur},e.prototype.cancelDuplicateResultEdges=function(){for(var t=this.Ur.getEdgeEnds().iterator();t.hasNext();){var e=t.next(),n=e.getSym();e.isInResult()&&n.isInResult()&&(e.setInResult(!1),n.setInResult(!1))}},e.prototype.isCoveredByLA=function(t){return!!this.isCovered(t,this.Ke)||!!this.isCovered(t,this.Vs)},e.prototype.computeGeometry=function(t,n,r,i){var s=new Kc;return s.addAll(t),s.addAll(n),s.addAll(r),s.isEmpty()?e.createEmptyResult(i,this.Ys[0].getGeometry(),this.Ys[1].getGeometry(),this.tn):this.tn.buildGeometry(s)},e.prototype.mergeSymLabels=function(){for(var t=this.Ur.getNodes().iterator();t.hasNext();)t.next().getEdges().mergeSymLabels()},e.prototype.isCovered=function(t,e){for(var n=e.iterator();n.hasNext();){var r=n.next();if(this.Pe.locate(t,r)!==tc.EXTERIOR)return!0}return!1},e.prototype.replaceCollapsedEdges=function(){for(var t=new Kc,e=this.wr.iterator();e.hasNext();){var n=e.next();n.isCollapsed()&&(e.remove(),t.add(n.getCollapsedEdge()))}this.wr.addAll(t)},e.prototype.updateNodeLabelling=function(){for(var t=this.Ur.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getEdges().getLabel();e.getLabel().merge(n)}},e.prototype.getResultGeometry=function(t){return this.computeOverlay(t),this.qs},e.prototype.insertUniqueEdges=function(t){for(var e=t.iterator();e.hasNext();){var n=e.next();this.insertUniqueEdge(n)}},e.prototype.computeOverlay=function(t){this.copyPoints(0),this.copyPoints(1),this.Ys[0].computeSelfNodes(this.Vi,!1),this.Ys[1].computeSelfNodes(this.Vi,!1),this.Ys[0].computeEdgeIntersections(this.Ys[1],this.Vi,!0);var e=new Kc;this.Ys[0].computeSplitEdges(e),this.Ys[1].computeSplitEdges(e),this.insertUniqueEdges(e),this.computeLabelsFromDepths(),this.replaceCollapsedEdges(),Dp.checkValid(this.wr.getEdges()),this.Ur.addEdges(this.wr.getEdges()),this.computeLabelling(),this.labelIncompleteNodes(),this.findResultAreaEdges(t),this.cancelDuplicateResultEdges();var n=new Lf(this.tn);n.add(this.Ur),this.Vs=n.getPolygons();var r=new Lp(this,this.tn,this.Pe);this.Ke=r.build(t);var i=new zp(this,this.tn,this.Pe);this.He=i.build(t),this.qs=this.computeGeometry(this.He,this.Ke,this.Vs,t)},e.prototype.labelIncompleteNode=function(t,e){var n=this.Pe.locate(t.getCoordinate(),this.Ys[e].getGeometry());t.getLabel().setLocation(e,n)},e.prototype.copyPoints=function(t){for(var e=this.Ys[t].getNodeIterator();e.hasNext();){var n=e.next();this.Ur.addNode(n.getCoordinate()).setLabel(t,n.getLabel().getLocation(t))}},e.prototype.findResultAreaEdges=function(t){for(var n=this.Ur.getEdgeEnds().iterator();n.hasNext();){var r=n.next(),i=r.getLabel();i.isArea()&&!r.isInteriorAreaEdge()&&e.isResultOfOp(i.getLocation(0,Af.RIGHT),i.getLocation(1,Af.RIGHT),t)&&r.setInResult(!0)}},e.prototype.computeLabelsFromDepths=function(){for(var t=this.wr.iterator();t.hasNext();){var e=t.next(),n=e.getLabel(),r=e.getDepth();if(!r.isNull()){r.normalize();for(var i=0;i<2;i++)n.isNull(i)||!n.isArea()||r.isNull(i)||(0===r.getDelta(i)?n.toLine(i):(Ic.isTrue(!r.isNull(i,Af.LEFT),"depth of LEFT side has not been initialized"),n.setLocation(i,Af.LEFT,r.getLocation(i,Af.LEFT)),Ic.isTrue(!r.isNull(i,Af.RIGHT),"depth of RIGHT side has not been initialized"),n.setLocation(i,Af.RIGHT,r.getLocation(i,Af.RIGHT))))}}},e.prototype.computeLabelling=function(){for(var t=this.Ur.getNodes().iterator();t.hasNext();)t.next().getEdges().computeLabelling(this.Ys);this.mergeSymLabels(),this.updateNodeLabelling()},e.prototype.labelIncompleteNodes=function(){for(var t=this.Ur.getNodes().iterator();t.hasNext();){var e=t.next(),n=e.getLabel();e.isIsolated()&&(n.isNull(0)?this.labelIncompleteNode(e,0):this.labelIncompleteNode(e,1)),e.getEdges().updateLabelling(n)}},e.prototype.isCoveredByA=function(t){return!!this.isCovered(t,this.Vs)},e.prototype.interfaces_=function(){return[]},e.prototype.getClass=function(){return e},e}(AA);mA.overlayOp=function(t,e,n){return new mA(t,e).getResultGeometry(n)},mA.intersection=function(t,e){if(t.isEmpty()||e.isEmpty())return mA.createEmptyResult(mA.INTERSECTION,t,e,t.getFactory());if(t.isGeometryCollection()){var n=e;return Fp.map(t,{interfaces_:function(){return[gA.MapOp]},map:function(t){return t.intersection(n)}})}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),Zp.overlayOp(t,e,mA.INTERSECTION)},mA.symDifference=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return mA.createEmptyResult(mA.SYMDIFFERENCE,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),Zp.overlayOp(t,e,mA.SYMDIFFERENCE)},mA.resultDimension=function(t,e,n){var r=e.getDimension(),i=n.getDimension(),s=-1;switch(t){case mA.INTERSECTION:s=Math.min(r,i);break;case mA.UNION:s=Math.max(r,i);break;case mA.DIFFERENCE:s=r;break;case mA.SYMDIFFERENCE:s=Math.max(r,i)}return s},mA.createEmptyResult=function(t,e,n,r){var i=null;switch(mA.resultDimension(t,e,n)){case-1:i=r.createGeometryCollection(new Array(0).fill(null));break;case 0:i=r.createPoint();break;case 1:i=r.createLineString();break;case 2:i=r.createPolygon()}return i},mA.difference=function(t,e){return t.isEmpty()?mA.createEmptyResult(mA.DIFFERENCE,t,e,t.getFactory()):e.isEmpty()?t.copy():(t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),Zp.overlayOp(t,e,mA.DIFFERENCE))},mA.isResultOfOp=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=t.getLocation(0),r=t.getLocation(1);return mA.isResultOfOp(n,r,e)}if(3===arguments.length){var i=arguments[0],s=arguments[1],o=arguments[2];switch(i===tc.BOUNDARY&&(i=tc.INTERIOR),s===tc.BOUNDARY&&(s=tc.INTERIOR),o){case mA.INTERSECTION:return i===tc.INTERIOR&&s===tc.INTERIOR;case mA.UNION:return i===tc.INTERIOR||s===tc.INTERIOR;case mA.DIFFERENCE:return i===tc.INTERIOR&&s!==tc.INTERIOR;case mA.SYMDIFFERENCE:return i===tc.INTERIOR&&s!==tc.INTERIOR||i!==tc.INTERIOR&&s===tc.INTERIOR}return!1}},mA.INTERSECTION=1,mA.UNION=2,mA.DIFFERENCE=3,mA.SYMDIFFERENCE=4;var yA=function(){this.Ws=null,this._s=null,this.Ks=null,this.Pe=new gp,this.nr=new od;var t=arguments[0],e=arguments[1];this.Ws=t,this._s=e,this.Ks=this.extractLinework(t)};yA.prototype.isWithinToleranceOfBoundary=function(t){for(var e=0;e<this.Ks.getNumGeometries();e++)for(var n=this.Ks.getGeometryN(e).getCoordinateSequence(),r=0;r<n.size()-1;r++)if(n.getCoordinate(r,this.nr.p0),n.getCoordinate(r+1,this.nr.p1),this.nr.distance(t)<=this._s)return!0;return!1},yA.prototype.getLocation=function(t){return this.isWithinToleranceOfBoundary(t)?tc.BOUNDARY:this.Pe.locate(t,this.Ws)},yA.prototype.extractLinework=function(t){var e=new vA;t.apply(e);var n=e.getLinework(),r=af.toLineStringArray(n);return t.getFactory().createMultiLineString(r)},yA.prototype.interfaces_=function(){return[]},yA.prototype.getClass=function(){return yA};var vA=function(){this.Ks=null,this.Ks=new Kc};vA.prototype.getLinework=function(){return this.Ks},vA.prototype.filter=function(t){if(t instanceof ju){var e=t;this.Ks.add(e.getExteriorRing());for(var n=0;n<e.getNumInteriorRing();n++)this.Ks.add(e.getInteriorRingN(n))}},vA.prototype.interfaces_=function(){return[_u]},vA.prototype.getClass=function(){return vA};var xA=function(){this.Ws=null,this.Hs=!0,this.Js=!0;var t=arguments[0];this.Ws=t};xA.prototype.extractPoints=function(t,e,n){for(var r=t.getCoordinates(),i=0;i<r.length-1;i++)this.computeOffsetPoints(r[i],r[i+1],e,n)},xA.prototype.setSidesToGenerate=function(t,e){this.Hs=t,this.Js=e},xA.prototype.getPoints=function(t){for(var e=new Kc,n=Ap.getLines(this.Ws).iterator();n.hasNext();){var r=n.next();this.extractPoints(r,t,e)}return e},xA.prototype.computeOffsetPoints=function(t,e,n,r){var i=e.x-t.x,s=e.y-t.y,o=Math.sqrt(i*i+s*s),a=n*i/o,l=n*s/o,h=(e.x+t.x)/2,c=(e.y+t.y)/2;if(this.Hs){var u=new Zh(h-l,c+a);r.add(u)}if(this.Js){var f=new Zh(h+l,c-a);r.add(f)}},xA.prototype.interfaces_=function(){return[]},xA.prototype.getClass=function(){return xA};var bA=function t(){this.An=null,this.Zs=null,this.Xs=new Array(3).fill(null),this.$s=null,this._s=t.TOLERANCE,this.Au=new Kc;var e=arguments[0],n=arguments[1],r=arguments[2];this._s=t.computeBoundaryDistanceTolerance(e,n),this.An=[e,n,r],this.Zs=[new yA(this.An[0],this._s),new yA(this.An[1],this._s),new yA(this.An[2],this._s)]},wA={TOLERANCE:{configurable:!0}};bA.prototype.reportResult=function(t,e,n){gc.out.println("Overlay result invalid - A:"+tc.toLocationSymbol(e[0])+" B:"+tc.toLocationSymbol(e[1])+" expected:"+(n?"i":"e")+" actual:"+tc.toLocationSymbol(e[2]))},bA.prototype.isValid=function(t){this.addTestPts(this.An[0]),this.addTestPts(this.An[1]);var e=this.checkValid(t);return e},bA.prototype.checkValid=function(){var t=this;if(1===arguments.length){for(var e=arguments[0],n=0;n<this.Au.size();n++){var r=t.Au.get(n);if(!t.checkValid(e,r))return t.$s=r,!1}return!0}if(2===arguments.length){var i=arguments[0],s=arguments[1];return this.Xs[0]=this.Zs[0].getLocation(s),this.Xs[1]=this.Zs[1].getLocation(s),this.Xs[2]=this.Zs[2].getLocation(s),!!bA.hasLocation(this.Xs,tc.BOUNDARY)||this.isValidResult(i,this.Xs)}},bA.prototype.addTestPts=function(t){var e=new xA(t);this.Au.addAll(e.getPoints(5*this._s))},bA.prototype.isValidResult=function(t,e){var n=mA.isResultOfOp(e[0],e[1],t),r=!(n^e[2]===tc.INTERIOR);return r||this.reportResult(t,e,n),r},bA.prototype.getInvalidLocation=function(){return this.$s},bA.prototype.interfaces_=function(){return[]},bA.prototype.getClass=function(){return bA},bA.hasLocation=function(t,e){for(var n=0;n<3;n++)if(t[n]===e)return!0;return!1},bA.computeBoundaryDistanceTolerance=function(t,e){return Math.min(Up.computeSizeBasedSnapTolerance(t),Up.computeSizeBasedSnapTolerance(e))},bA.isValid=function(t,e,n,r){return new bA(t,e,r).isValid(n)},wA.TOLERANCE.get=function(){return 1e-6},Object.defineProperties(bA,wA);var _A=function t(e){this.tu=null,this.nu=!1,this.iu=null,this.tu=t.extractFactory(e),this.iu=e};_A.prototype.extractElements=function(t,e){if(null===t)return null;for(var n=0;n<t.getNumGeometries();n++){var r=t.getGeometryN(n);this.nu&&r.isEmpty()||e.add(r)}},_A.prototype.combine=function(){for(var t=new Kc,e=this.iu.iterator();e.hasNext();){var n=e.next();this.extractElements(n,t)}return 0===t.size()?null!==this.tu?this.tu.createGeometryCollection(null):null:this.tu.buildGeometry(t)},_A.prototype.interfaces_=function(){return[]},_A.prototype.getClass=function(){return _A},_A.combine=function(){if(1===arguments.length){var t=arguments[0],e=new _A(t);return e.combine()}if(2===arguments.length){var n=arguments[0],r=arguments[1],i=new _A(_A.createList(n,r));return i.combine()}if(3===arguments.length){var s=arguments[0],o=arguments[1],a=arguments[2],l=new _A(_A.createList(s,o,a));return l.combine()}},_A.extractFactory=function(t){return t.isEmpty()?null:t.iterator().next().getFactory()},_A.createList=function(){if(2===arguments.length){var t=arguments[0],e=arguments[1],n=new Kc;return n.add(t),n.add(e),n}if(3===arguments.length){var r=arguments[0],i=arguments[1],s=arguments[2],o=new Kc;return o.add(r),o.add(i),o.add(s),o}};var MA=function(){this.ru=null,this.tu=null;var t=arguments[0];this.ru=t,null===this.ru&&(this.ru=new Kc)},TA={STRTREE_NODE_CAPACITY:{configurable:!0}};MA.prototype.reduceToGeometries=function(t){for(var e=new Kc,n=t.iterator();n.hasNext();){var r=n.next(),i=null;nc(r,Yc)?i=this.unionTree(r):r instanceof Fc&&(i=r),e.add(i)}return e},MA.prototype.extractByEnvelope=function(t,e,n){for(var r=new Kc,i=0;i<e.getNumGeometries();i++){var s=e.getGeometryN(i);s.getEnvelopeInternal().intersects(t)?r.add(s):n.add(s)}return this.tu.buildGeometry(r)},MA.prototype.unionOptimized=function(t,e){var n=t.getEnvelopeInternal(),r=e.getEnvelopeInternal();if(!n.intersects(r))return _A.combine(t,e);if(t.getNumGeometries()<=1&&e.getNumGeometries()<=1)return this.unionActual(t,e);var i=n.intersection(r);return this.unionUsingEnvelopeIntersection(t,e,i)},MA.prototype.union=function(){if(null===this.ru)throw new Error("union() method cannot be called twice");if(this.ru.isEmpty())return null;this.tu=this.ru.iterator().next().getFactory();for(var t=new Kf(MA.STRTREE_NODE_CAPACITY),e=this.ru.iterator();e.hasNext();){var n=e.next();t.insert(n.getEnvelopeInternal(),n)}this.ru=null;var r=t.itemsTree();return this.unionTree(r)},MA.prototype.binaryUnion=function(){if(1===arguments.length){var t=arguments[0];return this.binaryUnion(t,0,t.size())}if(3===arguments.length){var e=arguments[0],n=arguments[1],r=arguments[2];if(r-n<=1){var i=MA.getGeometry(e,n);return this.unionSafe(i,null)}if(r-n==2)return this.unionSafe(MA.getGeometry(e,n),MA.getGeometry(e,n+1));var s=Math.trunc((r+n)/2),o=this.binaryUnion(e,n,s),a=this.binaryUnion(e,s,r);return this.unionSafe(o,a)}},MA.prototype.repeatedUnion=function(t){for(var e=null,n=t.iterator();n.hasNext();){var r=n.next();e=null===e?r.copy():e.union(r)}return e},MA.prototype.unionSafe=function(t,e){return null===t&&null===e?null:null===t?e.copy():null===e?t.copy():this.unionOptimized(t,e)},MA.prototype.unionActual=function(t,e){return MA.restrictToPolygons(t.union(e))},MA.prototype.unionTree=function(t){var e=this.reduceToGeometries(t);return this.binaryUnion(e)},MA.prototype.unionUsingEnvelopeIntersection=function(t,e,n){var r=new Kc,i=this.extractByEnvelope(n,t,r),s=this.extractByEnvelope(n,e,r),o=this.unionActual(i,s);return r.add(o),_A.combine(r)},MA.prototype.bufferUnion=function(){if(1===arguments.length){var t=arguments[0],e=t.get(0).getFactory(),n=e.buildGeometry(t),r=n.buffer(0);return r}if(2===arguments.length){var i=arguments[0],s=arguments[1],o=i.getFactory(),a=o.createGeometryCollection([i,s]),l=a.buffer(0);return l}},MA.prototype.interfaces_=function(){return[]},MA.prototype.getClass=function(){return MA},MA.restrictToPolygons=function(t){if(nc(t,Uu))return t;var e=pp.getPolygons(t);return 1===e.size()?e.get(0):t.getFactory().createMultiPolygon(af.toPolygonArray(e))},MA.getGeometry=function(t,e){return e>=t.size()?null:t.get(e)},MA.union=function(t){return new MA(t).union()},TA.STRTREE_NODE_CAPACITY.get=function(){return 4},Object.defineProperties(MA,TA);var SA=function(){};function IA(){return new CA}function CA(){this.reset()}SA.prototype.interfaces_=function(){return[]},SA.prototype.getClass=function(){return SA},SA.union=function(t,e){if(t.isEmpty()||e.isEmpty()){if(t.isEmpty()&&e.isEmpty())return mA.createEmptyResult(mA.UNION,t,e,t.getFactory());if(t.isEmpty())return e.copy();if(e.isEmpty())return t.copy()}return t.checkNotGeometryCollection(t),t.checkNotGeometryCollection(e),Zp.overlayOp(t,e,mA.UNION)},CA.prototype={constructor:CA,reset:function(){this.s=this.t=0},add:function(t){EA(OA,t,this.t),EA(this,OA.s,this.s),this.s?this.t+=OA.t:this.s=OA.t},valueOf:function(){return this.s}};var OA=new CA;function EA(t,e,n){var r=t.s=e+n,i=r-e,s=r-i;t.t=e-s+(n-i)}var PA=1e-6,kA=Math.PI,RA=kA/2,NA=kA/4,DA=2*kA,FA=kA/180,LA=Math.abs,zA=Math.atan,BA=Math.atan2,HA=Math.cos,UA=Math.sin,jA=Math.sqrt;function VA(t){return t>1?0:t<-1?kA:Math.acos(t)}function GA(t){return t>1?RA:t<-1?-RA:Math.asin(t)}function qA(){}var WA,XA;function QA(t){var e=t[0],n=t[1],r=HA(n);return[r*HA(e),r*UA(e),UA(n)]}function YA(t,e){return[t[1]*e[2]-t[2]*e[1],t[2]*e[0]-t[0]*e[2],t[0]*e[1]-t[1]*e[0]]}function ZA(t){var e=jA(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]/=e,t[1]/=e,t[2]/=e}function KA(t,e){return[t>kA?t-DA:t<-kA?t+DA:t,e]}function JA(){var t,e=[];return{point:function(e,n){t.push([e,n])},lineStart:function(){e.push(t=[])},lineEnd:qA,rejoin:function(){e.length>1&&e.push(e.pop().concat(e.shift()))},result:function(){var n=e;return e=[],t=null,n}}}function $A(t,e){return LA(t[0]-e[0])<PA&&LA(t[1]-e[1])<PA}function tg(t,e,n,r){this.x=t,this.z=e,this.o=n,this.e=r,this.v=!1,this.n=this.p=null}function eg(t,e,n,r,i){var s,o,a=[],l=[];if(t.forEach((function(t){if(!((e=t.length-1)<=0)){var e,n,r=t[0],o=t[e];if($A(r,o)){for(i.lineStart(),s=0;s<e;++s)i.point((r=t[s])[0],r[1]);i.lineEnd()}else a.push(n=new tg(r,t,null,!0)),l.push(n.o=new tg(r,null,n,!1)),a.push(n=new tg(o,t,null,!1)),l.push(n.o=new tg(o,null,n,!0))}})),a.length){for(l.sort(e),ng(a),ng(l),s=0,o=l.length;s<o;++s)l[s].e=n=!n;for(var h,c,u=a[0];;){for(var f=u,d=!0;f.v;)if((f=f.n)===u)return;h=f.z,i.lineStart();do{if(f.v=f.o.v=!0,f.e){if(d)for(s=0,o=h.length;s<o;++s)i.point((c=h[s])[0],c[1]);else r(f.x,f.n.x,1,i);f=f.n}else{if(d)for(h=f.p.z,s=h.length-1;s>=0;--s)i.point((c=h[s])[0],c[1]);else r(f.x,f.p.x,-1,i);f=f.p}h=(f=f.o).z,d=!d}while(!f.v);i.lineEnd()}}}function ng(t){if(e=t.length){for(var e,n,r=0,i=t[0];++r<e;)i.n=n=t[r],n.p=i,i=n;i.n=n=t[0],n.p=i}}function rg(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function ig(t){for(var e,n,r,i=t.length,s=-1,o=0;++s<i;)o+=t[s].length;for(n=new Array(o);--i>=0;)for(e=(r=t[i]).length;--e>=0;)n[--o]=r[e];return n}IA(),IA(),IA(),KA.invert=KA,1===(WA=rg).length&&(XA=WA,WA=function(t,e){return rg(XA(t),e)});var sg=IA();IA(),IA(),IA();function og(t,e,n,r){return function(i,s){var o,a,l,h=e(s),c=i.invert(r[0],r[1]),u=JA(),f=e(u),d=!1,p={point:A,lineStart:m,lineEnd:y,polygonStart:function(){p.point=v,p.lineStart=x,p.lineEnd=b,a=[],o=[]},polygonEnd:function(){p.point=A,p.lineStart=m,p.lineEnd=y,a=ig(a);var t=function(t,e){var n=e[0],r=e[1],i=[UA(n),-HA(n),0],s=0,o=0;sg.reset();for(var a=0,l=t.length;a<l;++a)if(c=(h=t[a]).length)for(var h,c,u=h[c-1],f=u[0],d=u[1]/2+NA,p=UA(d),A=HA(d),g=0;g<c;++g,f=y,p=x,A=b,u=m){var m=h[g],y=m[0],v=m[1]/2+NA,x=UA(v),b=HA(v),w=y-f,_=w>=0?1:-1,M=_*w,T=M>kA,S=p*x;if(sg.add(BA(S*_*UA(M),A*b+S*HA(M))),s+=T?w+_*DA:w,T^f>=n^y>=n){var I=YA(QA(u),QA(m));ZA(I);var C=YA(i,I);ZA(C);var O=(T^w>=0?-1:1)*GA(C[2]);(r>O||r===O&&(I[0]||I[1]))&&(o+=T^w>=0?1:-1)}}return(s<-PA||s<PA&&sg<-PA)^1&o}(o,c);a.length?(d||(s.polygonStart(),d=!0),eg(a,lg,t,n,s)):t&&(d||(s.polygonStart(),d=!0),s.lineStart(),n(null,null,1,s),s.lineEnd()),d&&(s.polygonEnd(),d=!1),a=o=null},sphere:function(){s.polygonStart(),s.lineStart(),n(null,null,1,s),s.lineEnd(),s.polygonEnd()}};function A(e,n){var r=i(e,n);t(e=r[0],n=r[1])&&s.point(e,n)}function g(t,e){var n=i(t,e);h.point(n[0],n[1])}function m(){p.point=g,h.lineStart()}function y(){p.point=A,h.lineEnd()}function v(t,e){l.push([t,e]);var n=i(t,e);f.point(n[0],n[1])}function x(){f.lineStart(),l=[]}function b(){v(l[0][0],l[0][1]),f.lineEnd();var t,e,n,r,i=f.clean(),h=u.result(),c=h.length;if(l.pop(),o.push(l),l=null,c)if(1&i){if((e=(n=h[0]).length-1)>0){for(d||(s.polygonStart(),d=!0),s.lineStart(),t=0;t<e;++t)s.point((r=n[t])[0],r[1]);s.lineEnd()}}else c>1&&2&i&&h.push(h.pop().concat(h.shift())),a.push(h.filter(ag))}return p}}function ag(t){return t.length>1}function lg(t,e){return((t=t.x)[0]<0?t[1]-RA-PA:RA-t[1])-((e=e.x)[0]<0?e[1]-RA-PA:RA-e[1])}IA();og((function(){return!0}),(function(t){var e,n=NaN,r=NaN,i=NaN;return{lineStart:function(){t.lineStart(),e=1},point:function(s,o){var a=s>0?kA:-kA,l=LA(s-n);LA(l-kA)<PA?(t.point(n,r=(r+o)/2>0?RA:-RA),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(a,r),t.point(s,r),e=0):i!==a&&l>=kA&&(LA(n-i)<PA&&(n-=i*PA),LA(s-a)<PA&&(s-=a*PA),r=function(t,e,n,r){var i,s,o=UA(t-n);return LA(o)>PA?zA((UA(e)*(s=HA(r))*UA(n)-UA(r)*(i=HA(e))*UA(t))/(i*s*o)):(e+r)/2}(n,r,s,o),t.point(i,r),t.lineEnd(),t.lineStart(),t.point(a,r),e=0),t.point(n=s,r=o),i=a},lineEnd:function(){t.lineEnd(),n=r=NaN},clean:function(){return 2-e}}}),(function(t,e,n,r){var i;if(null==t)i=n*RA,r.point(-kA,i),r.point(0,i),r.point(kA,i),r.point(kA,0),r.point(kA,-i),r.point(0,-i),r.point(-kA,-i),r.point(-kA,0),r.point(-kA,i);else if(LA(t[0]-e[0])>PA){var s=t[0]<e[0]?kA:-kA;i=n*s/2,r.point(-s,i),r.point(0,i),r.point(s,i)}else r.point(e[0],e[1])}),[-kA,-RA]);function hg(t){return function(e){var n=new cg;for(var r in t)n[r]=t[r];return n.stream=e,n}}function cg(){}cg.prototype={constructor:cg,point:function(t,e){this.stream.point(t,e)},sphere:function(){this.stream.sphere()},lineStart:function(){this.stream.lineStart()},lineEnd:function(){this.stream.lineEnd()},polygonStart:function(){this.stream.polygonStart()},polygonEnd:function(){this.stream.polygonEnd()}};HA(30*FA);hg({point:function(t,e){this.stream.point(t*FA,e*FA)}});function ug(t){return function(e,n){var r=HA(e),i=HA(n),s=t(r*i);return[s*i*UA(e),s*UA(n)]}}function fg(t){return function(e,n){var r=jA(e*e+n*n),i=t(r),s=UA(i),o=HA(i);return[BA(e*s,r*o),GA(r&&n*s/r)]}}ug((function(t){return jA(2/(1+t))})).invert=fg((function(t){return 2*GA(t/2)}));var dg=ug((function(t){return(t=VA(t))&&t/UA(t)}));function pg(t,e){return[t,e]}dg.invert=fg((function(t){return t})),pg.invert=pg;class Ag extends i["h"]{constructor(t){super(t),this.on("enable",this.lu,this),this.on("disable",this.wu,this),this.Pu=[]}addTo(t){return t&&(super.addTo(t),this.gu=t,this.Cu()),this}Cu(){const t=i["o"]+"drawtool";this.gu.getLayer(t).hide()}lu(){this.on("drawstart",this.Du,this).on("drawvertex",this.Iu,this).on("mousemove",this.Mu,this).on("drawend",this.bu,this)}wu(){this.off("drawstart",this.Du,this).off("drawvertex",this.Iu,this).off("mousemove",this.Mu,this).off("drawend",this.bu,this)}zu(t){const{coordinate:e,containerPoint:n}=t,r=this.gu.getLayers(t=>t.queryTerrainAtPoint)[0];if(!r)return e.z=e.z||0,e;const s=r.identify(e,{includeInternals:!1})[0];let o=null;if(s&&s.coordinate?o=new i["f"](s.coordinate):(e.z=e.z||0,o=e),r.getTerrainLayer()){const t=r.queryTerrainAtPoint(n);return t&&t.z>o.z?t:o}return o}Du(t){const e=this.zu(t);e&&(this.du=!0,this.Pu.push(e),this.xu(e))}Iu(t){const e=this.zu(t);e&&(this.du=!0,this.Pu[this.Pu.length-1]=e,this.mu())}Mu(t){const e=this.zu(t);e&&(this.du?this.Pu.push(e):this.Pu[this.Pu.length-1]=e,this.mu(),this.du=!1)}bu(t){const e=this.zu(t);e&&(this.Pu.push(e),this.yu())}yu(){this.mu(),this.Pu=[],this.et=null,this.dn=null}remove(){this.pu&&this.pu.remove(),this.Lu&&this.Lu.remove()}clear(){this.pu&&this.pu.clear(),this.Lu&&this.Lu.clear()}}Ag.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,once:!0,symbol:{lineColor:"#e8542b",lineWidth:2,polygonFill:"#eee",polygonOpacity:.5},vertexSymbol:{markerType:"ellipse",markerFill:"#e8542b",markerLineColor:"#fff",markerLineWidth:2,markerWidth:10,markerHeight:10,markerDy:0},labelSymbol:{boxStyle:{padding:[15,6],verticalAlignment:"top",horizontalAlignment:"left",minWidth:150,minHeight:30,symbol:{markerType:"square",markerFill:"rgb(60, 60, 60)",markerFillOpacity:.8,markerLineColor:"#fff",markerLineWidth:2,textDx:-110}},textSymbol:{textFill:"#fff",textSize:16,textVerticalAlignment:"top"}}});"undefined"!=typeof console&&console.log("@maptalks/analysis v0.97.4"),"undefined"!==typeof window&&(window.maptalksgl=window.maptalksgl||{},window.maptalksgl.transcoders=window.maptalksgl.transcoders||r["n"])},2514:function(t,e,n){"use strict";var r=n("b8fa"),i=Array.prototype.concat,s=Array.prototype.slice,o=t.exports=function(t){for(var e=[],n=0,o=t.length;n<o;n++){var a=t[n];r(a)?e=i.call(e,s.call(a)):e.push(a)}return e};o.wrap=function(t){return function(){return t(o(arguments))}}},"25a5":function(t,e,n){!function(e,n){t.exports=n()}(0,(function(){"use strict";function t(t,r,i,s,o){!function t(n,r,i,s,o){for(;s>i;){if(s-i>600){var a=s-i+1,l=r-i+1,h=Math.log(a),c=.5*Math.exp(2*h/3),u=.5*Math.sqrt(h*c*(a-c)/a)*(l-a/2<0?-1:1),f=Math.max(i,Math.floor(r-l*c/a+u)),d=Math.min(s,Math.floor(r+(a-l)*c/a+u));t(n,r,f,d,o)}var p=n[r],A=i,g=s;for(e(n,i,r),o(n[s],p)>0&&e(n,i,s);A<g;){for(e(n,A,g),A++,g--;o(n[A],p)<0;)A++;for(;o(n[g],p)>0;)g--}0===o(n[i],p)?e(n,i,g):e(n,++g,s),g<=r&&(i=g+1),r<=g&&(s=g-1)}}(t,r,i||0,s||t.length-1,o||n)}function e(t,e,n){var r=t[e];t[e]=t[n],t[n]=r}function n(t,e){return t<e?-1:t>e?1:0}var r=function(t){void 0===t&&(t=9),this._maxEntries=Math.max(4,t),this._minEntries=Math.max(2,Math.ceil(.4*this._maxEntries)),this.clear()};function i(t,e,n){if(!n)return e.indexOf(t);for(var r=0;r<e.length;r++)if(n(t,e[r]))return r;return-1}function s(t,e){o(t,0,t.children.length,e,t)}function o(t,e,n,r,i){i||(i=p(null)),i.minX=1/0,i.minY=1/0,i.maxX=-1/0,i.maxY=-1/0;for(var s=e;s<n;s++){var o=t.children[s];a(i,t.leaf?r(o):o)}return i}function a(t,e){return t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),t}function l(t,e){return t.minX-e.minX}function h(t,e){return t.minY-e.minY}function c(t){return(t.maxX-t.minX)*(t.maxY-t.minY)}function u(t){return t.maxX-t.minX+(t.maxY-t.minY)}function f(t,e){return t.minX<=e.minX&&t.minY<=e.minY&&e.maxX<=t.maxX&&e.maxY<=t.maxY}function d(t,e){return e.minX<=t.maxX&&e.minY<=t.maxY&&e.maxX>=t.minX&&e.maxY>=t.minY}function p(t){return{children:t,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(e,n,r,i,s){for(var o=[n,r];o.length;)if(!((r=o.pop())-(n=o.pop())<=i)){var a=n+Math.ceil((r-n)/i/2)*i;t(e,a,n,r,s),o.push(n,a,a,r)}}return r.prototype.all=function(){return this._all(this.data,[])},r.prototype.search=function(t){var e=this.data,n=[];if(!d(t,e))return n;for(var r=this.toBBox,i=[];e;){for(var s=0;s<e.children.length;s++){var o=e.children[s],a=e.leaf?r(o):o;d(t,a)&&(e.leaf?n.push(o):f(t,a)?this._all(o,n):i.push(o))}e=i.pop()}return n},r.prototype.collides=function(t){var e=this.data;if(!d(t,e))return!1;for(var n=[];e;){for(var r=0;r<e.children.length;r++){var i=e.children[r],s=e.leaf?this.toBBox(i):i;if(d(t,s)){if(e.leaf||f(t,s))return!0;n.push(i)}}e=n.pop()}return!1},r.prototype.load=function(t){if(!t||!t.length)return this;if(t.length<this._minEntries){for(var e=0;e<t.length;e++)this.insert(t[e]);return this}var n=this._build(t.slice(),0,t.length-1,0);if(this.data.children.length)if(this.data.height===n.height)this._splitRoot(this.data,n);else{if(this.data.height<n.height){var r=this.data;this.data=n,n=r}this._insert(n,this.data.height-n.height-1,!0)}else this.data=n;return this},r.prototype.insert=function(t){return t&&this._insert(t,this.data.height-1),this},r.prototype.clear=function(){return this.data=p([]),this},r.prototype.remove=function(t,e){if(!t)return this;for(var n,r,s,o=this.data,a=this.toBBox(t),l=[],h=[];o||l.length;){if(o||(o=l.pop(),r=l[l.length-1],n=h.pop(),s=!0),o.leaf){var c=i(t,o.children,e);if(-1!==c)return o.children.splice(c,1),l.push(o),this._condense(l),this}s||o.leaf||!f(o,a)?r?(n++,o=r.children[n],s=!1):o=null:(l.push(o),h.push(n),n=0,r=o,o=o.children[0])}return this},r.prototype.toBBox=function(t){return t},r.prototype.compareMinX=function(t,e){return t.minX-e.minX},r.prototype.compareMinY=function(t,e){return t.minY-e.minY},r.prototype.toJSON=function(){return this.data},r.prototype.fromJSON=function(t){return this.data=t,this},r.prototype._all=function(t,e){for(var n=[];t;)t.leaf?e.push.apply(e,t.children):n.push.apply(n,t.children),t=n.pop();return e},r.prototype._build=function(t,e,n,r){var i,o=n-e+1,a=this._maxEntries;if(o<=a)return s(i=p(t.slice(e,n+1)),this.toBBox),i;r||(r=Math.ceil(Math.log(o)/Math.log(a)),a=Math.ceil(o/Math.pow(a,r-1))),(i=p([])).leaf=!1,i.height=r;var l=Math.ceil(o/a),h=l*Math.ceil(Math.sqrt(a));A(t,e,n,h,this.compareMinX);for(var c=e;c<=n;c+=h){var u=Math.min(c+h-1,n);A(t,c,u,l,this.compareMinY);for(var f=c;f<=u;f+=l){var d=Math.min(f+l-1,u);i.children.push(this._build(t,f,d,r-1))}}return s(i,this.toBBox),i},r.prototype._chooseSubtree=function(t,e,n,r){for(;r.push(e),!e.leaf&&r.length-1!==n;){for(var i=1/0,s=1/0,o=void 0,a=0;a<e.children.length;a++){var l=e.children[a],h=c(l),u=(f=t,d=l,(Math.max(d.maxX,f.maxX)-Math.min(d.minX,f.minX))*(Math.max(d.maxY,f.maxY)-Math.min(d.minY,f.minY))-h);u<s?(s=u,i=h<i?h:i,o=l):u===s&&h<i&&(i=h,o=l)}e=o||e.children[0]}var f,d;return e},r.prototype._insert=function(t,e,n){var r=n?t:this.toBBox(t),i=[],s=this._chooseSubtree(r,this.data,e,i);for(s.children.push(t),a(s,r);e>=0&&i[e].children.length>this._maxEntries;)this._split(i,e),e--;this._adjustParentBBoxes(r,i,e)},r.prototype._split=function(t,e){var n=t[e],r=n.children.length,i=this._minEntries;this._chooseSplitAxis(n,i,r);var o=this._chooseSplitIndex(n,i,r),a=p(n.children.splice(o,n.children.length-o));a.height=n.height,a.leaf=n.leaf,s(n,this.toBBox),s(a,this.toBBox),e?t[e-1].children.push(a):this._splitRoot(n,a)},r.prototype._splitRoot=function(t,e){this.data=p([t,e]),this.data.height=t.height+1,this.data.leaf=!1,s(this.data,this.toBBox)},r.prototype._chooseSplitIndex=function(t,e,n){for(var r,i,s,a,l,h,u,f=1/0,d=1/0,p=e;p<=n-e;p++){var A=o(t,0,p,this.toBBox),g=o(t,p,n,this.toBBox),m=(i=A,s=g,a=void 0,l=void 0,h=void 0,u=void 0,a=Math.max(i.minX,s.minX),l=Math.max(i.minY,s.minY),h=Math.min(i.maxX,s.maxX),u=Math.min(i.maxY,s.maxY),Math.max(0,h-a)*Math.max(0,u-l)),y=c(A)+c(g);m<f?(f=m,r=p,d=y<d?y:d):m===f&&y<d&&(d=y,r=p)}return r||n-e},r.prototype._chooseSplitAxis=function(t,e,n){var r=t.leaf?this.compareMinX:l,i=t.leaf?this.compareMinY:h;this._allDistMargin(t,e,n,r)<this._allDistMargin(t,e,n,i)&&t.children.sort(r)},r.prototype._allDistMargin=function(t,e,n,r){t.children.sort(r);for(var i=this.toBBox,s=o(t,0,e,i),l=o(t,n-e,n,i),h=u(s)+u(l),c=e;c<n-e;c++){var f=t.children[c];a(s,t.leaf?i(f):f),h+=u(s)}for(var d=n-e-1;d>=e;d--){var p=t.children[d];a(l,t.leaf?i(p):p),h+=u(l)}return h},r.prototype._adjustParentBBoxes=function(t,e,n){for(var r=n;r>=0;r--)a(e[r],t)},r.prototype._condense=function(t){for(var e=t.length-1,n=void 0;e>=0;e--)0===t[e].children.length?e>0?(n=t[e-1].children).splice(n.indexOf(t[e]),1):this.clear():s(t[e],this.toBBox)},r}))},"31d3":function(t,e,n){"use strict";n.d(e,"a",(function(){return b})),n.d(e,"b",(function(){return j}));var r=n("c3b8");
/*!
 * @maptalks/gltf-loader v0.97.2
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */let i=0;function s(t){return null==t}function o(t){return!s(t)}function a(t){return!s(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function l(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function h(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView's component type: "+t)}function c(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function u(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let i=0;i<n;i++)r[i]=e.charCodeAt(i);return r.buffer}const f=[],d=[],p=[],A=[0,0,0],g=r["d"].identity([]),m=[1,1,1];function y(t,e,n,r,i,s,o){const a=h(o);if((0===i||i===r*a.BYTES_PER_ELEMENT)&&s%a.BYTES_PER_ELEMENT==0){const i=new a(e,s,n*r);return t.set(i),t}0===i&&(i=r*a.BYTES_PER_ELEMENT);const l=new Uint8Array(r*a.BYTES_PER_ELEMENT);for(let h=0;h<n;h++){let n=null;const o=new Uint8Array(e,i*h+s,r*a.BYTES_PER_ELEMENT);l.set(o),n=new a(l.buffer,0,r);for(let e=0;e<r;e++)t[h*r+e]=n[e]}return t}const v="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function x(t,e,n){const r=new Uint8Array(t,e,n);return v.decode(r)}const b={get:function(t,e={},n){e||(e={});const r=new AbortController,i=r.signal,s=l({},e);s.signal=i,s.method||(s.method="GET"),s.referrerPolicy=s.referrerPolicy||"origin","undefined"==typeof window||s.referrer||(s.referrer=window.location.href),n&&(t=n(t));const o=fetch(t,s).then(t=>{const n=this._parseResponse(t,e.responseType);return n.message?n:n.then(n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t})}).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t});return o.xhr=r,o},_parseResponse:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",b.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?b.jsonp(t):((e=e||{}).responseType="json",b.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+i++;t.match(/\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise(t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)})}};class w{constructor(t,e,n,r,i){this._requestImage=t,this.decoders=e,this._supportedFormats=n,this.images={},this._imgRequests={},this._fetchOptions=r||{},this._urlModifier=i}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}if(this._imgRequests[t.id])return this._imgRequests[t.id].then(()=>{const r=this.buffers[t.id],i=this._createDataView(e,r);return this.getImageByBuffer(i,n)});if(c(t.uri)){const r=this.buffers[t.id]=u(t.uri),i=this._createDataView(e,r);return this.getImageByBuffer(i,n)}let r;const i=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||i?t.uri:this.rootPath+"/"+t.uri,this._imgRequests[t.id]=b.getArrayBuffer(r,this._fetchOptions,this._urlModifier).then(r=>{const i=this.buffers[t.id]=r.data,s=this._createDataView(e,i);return this.getImageByBuffer(s,n)})}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this._supportedFormats}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this._getImageInfo(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this._imgRequests[t.id]?this._imgRequests[t.id].then(()=>this.images[t.id]):this._imgRequests[t.id]=this._getImageInfo(t.id,e)}_getImageInfo(t,e){return new Promise((n,r)=>{let i=e;this._urlModifier&&(i=this._urlModifier(e)),this._requestImage(i,this._fetchOptions,(i,s)=>{i?r(i):(URL.revokeObjectURL(e),this.images[t]=s,n(this.images[t]))})})}}const _=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],M=[];class T{constructor(t,e,n,r,i){this.rootPath=t,this.gltf=e,this._enableInterleave=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this._compareAccessor(),this._fetchOptions=r,this._urlModifier=i}_requestData(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this._toBufferData(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const i=n.bufferViews[r.bufferView];return this._requestBufferOfBufferView(i).then(n=>{const{buffer:i,byteOffset:s}=n;return this.accessors[r.id]=this._toBufferData(t,e,i,s)})}_requestBufferOfBufferView(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then(()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})});if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(c(e.uri)){const t=this.buffers[e.id]=u(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=b.getArrayBuffer(t,this._fetchOptions,!n&&this._urlModifier).then(r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0}))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}_toBufferData(t,e,n,i=0){const s=this.gltf,o=s.accessors[e],a=void 0!==o.bufferView?s.bufferViews[o.bufferView]:{},l=(a.byteOffset||0)+i,c=this._getTypeItemSize(o.type),u=h(o.componentType),f=a.byteStride||0,d={array:void 0,name:t,accessorName:e,byteLength:o.count*c*u.BYTES_PER_ELEMENT,componentType:o.componentType,count:o.count,type:o.type,itemSize:c,max:o.max,min:o.min,extensions:o.extensions};if(o.min&&(d.min=o.min),o.max&&(d.max=o.max),n)if(this._enableInterleave)d.byteStride=f,d.byteOffset=l+(o.byteOffset||0),!f||f===c*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(d.array=this._typedArray(n,o.count,c,l+(o.byteOffset||0),u),d.array.buffer.byteLength===d.byteLength&&(d.byteOffset=0)):d.array=new Uint8Array(n,l,a.byteLength);else if(o.interleaved){d.byteStride=0,d.byteOffset=0;const t=new u(o.count*c);if(d.array=y(t,n,o.count,c,f,l+(o.byteOffset||0),o.componentType),d.extensions&&d.extensions.WEB3D_quantized_attributes&&c>2){const t=new Float32Array(d.array.length),{decodeMatrix:e}=d.extensions.WEB3D_quantized_attributes;for(let n=0;n<d.array.length;n+=c){M[0]=d.array[n],M[1]=d.array[n+1],M[2]=d.array[n+2],M[3]=1;const i=r["g"].transformMat4(M,M,e);t[n]=i[0],t[n+1]=i[1],t[n+2]=i[2]}d.componentType=5126,d.array=t}}else d.byteStride=0,d.array=this._typedArray(n,o.count,c,l+(o.byteOffset||0),u),d.byteOffset=d.array.byteOffset;else{d.array=new u(o.count);const t=d.min||d.max;t&&(d.array[0]=t[0],d.array[1]=t[1],d.array[2]=t[2])}return d}_compareAccessor(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}_typedArray(t,e,n,r,i){return r%i.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*i.BYTES_PER_ELEMENT),r=0),new i(t,r,n*e)}_getTypeItemSize(t){const e=_.indexOf(t);return _[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map(t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this._requestBufferOfBufferView(e).then(r=>{const{buffer:i,byteOffset:s}=r,o=x(i,s+(e.byteOffset||0),n);return t.content=o,t})}if(t.uri){if(c(t.uri)){const e=u(t.uri),n=x(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return b.get(e,this._fetchOptions,this._urlModifier).then(e=>(t.content=e,t))}}return Promise.resolve(t)});return Promise.all(n).then(()=>t)}}class S extends w{constructor(t,e,n,r,i,s,o,a){super(r,i,s,o,a),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new T(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const i in n)t(i,n[i],r++)}createNode(t){const e={};if(o(t.name)&&(e.name=t.name),o(t.children)&&(e.children=t.children),o(t.jointName)&&(e.jointName=t.jointName),o(t.matrix)&&(e.matrix=t.matrix),o(t.rotation)&&(e.rotation=t.rotation),o(t.scale)&&(e.scale=t.scale),o(t.translation)&&(e.translation=t.translation),o(t.extras)&&(e.extras=t.extras),o(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=r["c"].fromTranslation(f,e.translation||A),i=r["c"].fromQuat(d,e.rotation||g),s=r["c"].fromScaling(p,e.scale||m);return r["c"].multiply(s,i,s),r["c"].multiply(t,n,s)}return r["c"].identity(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}_loadMaterials(t){const e={};for(const n in t){const r=t[n];let i,s;r.instanceTechnique&&r.instanceTechnique.values?(i=r.instanceTechnique,s=i.values.diffuse):(i=r,s=i.values.tex||i.values.diffuseTex||i.values.diffuse);const o={baseColorTexture:{index:s}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}_loadImage(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,i=n.byteLength,s=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,i);return this.getImageByBuffer(s,t)}return this.requestExternalImage(t)}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this._loadImage(n).then(t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}})}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const i=this.gltf.textures[r];if(!i)return null;const s=this.gltf.samplers[i.sampler];return{format:i.format||6408,internalFormat:i.internalFormat||6408,type:i.type||5121,sampler:s,source:this.gltf.images[i.source]}}getMaterial(){return null}getAnimations(){return null}}class I extends w{constructor(t,e,n,r,i,s,o,a){super(r,i,s,o,a),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new T(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(n)for(let r=0;r<n.length;r++)t(r,n[r],r)}createNode(t){const e={};return l(e,t),!o(t.weights)&&this.gltf.meshes&&o(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}_getTexture(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!o(n))return null;const r=this.gltf.images[n];return this._loadImage(r).then(t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};l(n,e);const i=o(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return i&&(n.sampler=i,n.sampler.magFilter=i.magFilter||9729,n.sampler.minFilter=i.minFilter||9729,n.sampler.wrapS=i.wrapS||10497,n.sampler.wrapT=i.wrapT||10497),t.format&&(n.format=t.format),n})}_loadImage(t){if(!o(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this._requestFromGlbBuffer(e,t)}return null}_requestFromGlbBuffer(t,e){const n=this._createDataView(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}_createDataView(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,i=t.byteLength;return new Uint8Array(e,r,i)}_transformArrayBufferToBase64(t,e){const n=new Array(t.byteLength);for(let r=0;r<t.byteLength;r++)n[r]=String.fromCharCode(t[r]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach(t=>{e.push(this.getSamplers(t.samplers))}),Promise.all(e).then(e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t})}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(o(t[n].input)||o(t[n].output))&&(e.push(this.accessor._requestData("input",t[n].input)),e.push(this.accessor._requestData("output",t[n].output)));return Promise.all(e).then(e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t})}}const C="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null,O=1313821514,E=5130562;class P{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),i=r.getUint32(4,!0);if(1===i)return P.readV1(r,e);if(2===i)return P.readV2(t,e);throw new Error("Unsupported glb version : "+i)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb's byte length.");const i=k(t.buffer,20+e,r);return{json:JSON.parse(i),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,i;const s=new DataView(t,e+12);let o=0;for(;o<s.byteLength;){const a=s.getUint32(o,!0);o+=4;const l=s.getUint32(o,!0);if(o+=4,l===O)n=k(t,e+12+o,a);else if(l===E){i=e+12+o,r=a;break}o+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:i,buffer:t,byteLength:r}}}}function k(t,e,n){if(C){const r=new Uint8Array(t,e,n);return C.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=R[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}(new Uint8Array(t,e,n))}const R=[1,1,1,1,2,2,3,0],N=[0,0,0],D=[0,0,0,1],F=[1,1,1],L={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},z={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},B={_getTRSW(t,e,n,i,s,a,l,h){const c=o(t)?e.animations:[e.animations[0]],u={};for(let f=0;f<c.length;f++){const e=c[f],d=e.name||f;if(o(t)&&d!==t)continue;const p=e.channelsMap[n];if(p)for(let t=0;t<p.length;t++){const n=p[t];"translation"===n.target.path?(this._getAnimateData(s,e.samplers[n.sampler],i,1),u.translation=r["f"].copy(N,s)):"rotation"===n.target.path?(this._getQuaternion(a,e.samplers[n.sampler],i,1),u.rotation=r["d"].copy(D,a)):"scale"===n.target.path?(this._getAnimateData(l,e.samplers[n.sampler],i,1),u.scale=r["f"].copy(F,l)):"weights"===n.target.path&&h&&(this._getAnimateData(h,e.samplers[n.sampler],i,h.length),u.weights=h)}}return u},_getAnimateData(t,e,n,r){switch(e.interpolation){case"LINEAR":{const i=this._getPreNext(z,e,n,1*r);i&&(t=function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t}(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION));break}case"STEP":{const i=this._getPreNext(z,e,n,1*r);i&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const i=this._getPreNext(z,e,n,3*r);i&&(t=this._getCubicSpline(t,i,e.input.array,3*r));break}}return t},_getQuaternion(t,e,n){switch(e.interpolation){case"LINEAR":{const i=this._getPreNext(z,e,n,1);i&&r["d"].slerp(t,i.PREVIOUS,i.NEXT,i.INTERPOLATION);break}case"STEP":{const i=this._getPreNext(z,e,n,1);i&&(t=r["g"].set(t,...i.PREVIOUS));break}case"CUBICSPLINE":{const r=this._getPreNext(z,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this._getCubicSpline(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},_search(t,e){const n=t.length;let r,i,s,o=0,a=n-1,l=Math.floor((o+a)/2);for(;o<=n-1&&a>=0;){if(o===a)return null;if(t[l]<=e&&e<=t[l+1]){const n=t[l];return r=l,i=l+1,s=(e-n)/(t[l+1]-n),{preIndx:r,nextIndex:i,interpolation:s}}e<t[l]?(a=l,l=Math.floor((o+a)/2)):t[l+1]<e&&(o=l,l=Math.floor((o+a)/2))}return null},_getPreNext(t,e,n,r){const i=e.input.array,s=e.output.array,o=e.output.itemSize;(n<i[0]||n>i[i.length-1])&&(n=Math.max(i[0],Math.min(i[i.length-1],n))),n===i[i.length-1]&&(n=i[0]);const a=this._search(i,n);if(!a||!a.nextIndex)return null;const{preIndx:l,nextIndex:h,interpolation:c}=a;t.PREINDEX=l,t.NEXTINDEX=h,t.INTERPOLATION=c;const u=o*r;return t.PREVIOUS=s.subarray(t.PREINDEX*u,(t.PREINDEX+1)*u),t.NEXT=s.subarray(t.NEXTINDEX*u,(t.NEXTINDEX+1)*u),t},_getCubicSpline(t,e,n,r){const i=e.INTERPOLATION,s=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let a=0;a<3;a++){const n=e.PREVIOUS[r+a],l=(o-s)*e.PREVIOUS[2*r+a],h=e.NEXT[3+a],c=(o-s)*e.NEXT[a],u=(2*Math.pow(i,3)-3*Math.pow(i,2)+1)*n+(Math.pow(i,3)-2*Math.pow(i,2)+i)*l+(2*-Math.pow(i,3)+3*Math.pow(i,2))*h+(Math.pow(i,3)-Math.pow(i,2))*c;t[a]=u}return t},getAnimationClip(t,e,n,i){const s=t.nodes[e]&&t.nodes[e].weights;return r["f"].set(N,...L.TRANSLATION),r["g"].set(D,...L.ROTATION),r["f"].set(F,...L.SCALE),this._getTRSW(i,t,e,n,N,D,F,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach((e,n)=>{let r=-1/0,i=1/0;const s=e.channels;for(let t=0;t<s.length;t++){const n=s[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<i&&(i=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:i}}),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?o(e)?n[e]:n[Object.keys(n)[0]]:null}};let H=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(J){}t&&"undefined"!=typeof createImageBitmap&&(H=!0)}const U="undefined"==typeof document?null:document.createElement("canvas");class j{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this._fetchOptions=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=P.read(e.buffer,e.byteOffset,e.byteLength);this._init(t,n,r)}else this._init(t,e);this._accessor=new T(this.rootPath,this.gltf,this.glbBuffer,this._fetchOptions,this.options.urlModifier),this._checkExtensions()}_checkExtensions(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}_loadExtensions(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this._accessor.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then(e=>(t.KHR_techniques_webgl=e,t)):Promise.resolve(t)}load(t){t=t||{};const e=this._loadScene(t),n=this._loadAnimations(),r=this._loadTextures(),i=this._loadExtensions();return Promise.all([e,n,r,i]).then(t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0]))}createChannelsMap(t){const e=t.animations;if(e)for(let n=0;n<e.length;n++){const t=e[n];t.channelsMap={};for(let e=0;e<t.channels.length;e++){const n=t.channels[e];t.channelsMap[n.target.node]||(t.channelsMap[n.target.node]=[]),t.channelsMap[n.target.node].push(n)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let r=0;r<e.length;r++)e[r].uri&&e[r].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[r].uri});for(let r=0;r<n.length;r++)n[r].uri&&n[r].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[r].uri})}return t}static getAnimationClip(t,e,n,r){return B.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return B.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return h(t)}static readInterleavedArray(t,e,n,r,i,s,o){return y(t,e,n,r,i,s,o)}_init(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=H?Q.bind(this):this.options.requestImage||V,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new I(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="buffer_"+n},"buffers"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors")):(this.adapter=new S(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this._fetchOptions,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"))}_parseNodes(t,e){if(t.children&&t.children.length>0){if(n=t.children[0],!("number"==typeof n&&isFinite(n)||a(t.children[0])))return t;const r=t.children.map(t=>{const n=e[t];return n.nodeIndex=t,this._parseNodes(n,e)});t.children=r}var n;return t}_loadScene(t){return this._loadNodes(t).then(t=>{const e=this.scenes=[];let n;for(const i in t)t[i]=this._parseNodes(t[i],t),t[i].nodeIndex=Number(i)?Number(i):i;this.adapter.iterate((r,i,s)=>{const o={};i.name&&(o.name=i.name),i.nodes&&(o.nodes=i.nodes.map(e=>t[e])),this.gltf.scene===r&&(n=s),e.push(o)},"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter._loadMaterials(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r})}_loadNodes(t){return this._loadMeshes(t).then(()=>{const t=this.nodes={};return this.adapter.iterate((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r},"nodes"),t})}_loadSkins(){this.skins=[];const t=[];return this.adapter.iterate((e,n,r)=>{t.push(this._loadSkin(n).then(t=>{t.index=r,this.skins.push(t)}))},"skins"),t}_loadSkin(t){const e=t.inverseBindMatrices;return this.adapter.accessor._requestData("inverseBindMatrices",e).then(e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t))}_loadAnimations(){const t=this.gltf.animations;return o(t)?this.adapter.getAnimations(t):null}_loadMeshes(t){this.meshes={};let e=[];return this.adapter.iterate((n,r,i)=>{e.push(this._loadMesh(r,t).then(t=>{t.index=i,this.meshes[n]=t}))},"meshes"),e=e.concat(this._loadSkins()),Promise.all(e)}_loadMesh(t,e){const n=t.primitives.map(t=>this._loadPrimitive(t,e)).filter(t=>!!t);return Promise.all(n).then(e=>{const n={};return l(n,t),n.primitives=e,n})}_loadTextures(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter._getTexture(n));return Promise.all(e).then(e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t].image.array;if(e[t]&&n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e})}_loadPrimitive(t,e){let n;const i=[],s=t.extensions;if(o(t.targets))for(let r=0;r<t.targets.length;r++){const e=t.targets[r];for(const t in e){const n=this.adapter.accessor._requestData(`morphTargets_${t}_${r}`,e[t]);n&&i.push(n)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:r,attributes:o}=s.KHR_draco_mesh_compression,a=this.gltf.bufferViews[r],l=this._accessor._requestBufferOfBufferView(a).then(n=>{const{buffer:r,byteOffset:i}=n;let{byteOffset:s}=a;const l=a.byteLength;s||(s=0);const h=new DataView(r,i+s,l),c={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(h,c).then(t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e})});i.push(l),n=Promise.all(i)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._requestData(t,e[t]);n&&i.push(n)}if(o(t.indices)){const e=this.adapter.accessor._requestData("indices",t.indices);e&&i.push(e)}n=Promise.all(i)}return n.then(e=>{if(s&&s.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,i;const a={attributes:e.reduce((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)i=i||{},i[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:i,array:s}=e,o=s.length/i;for(let e=0;e<o;e++)for(let r=0;r<i;r++){const o=e*i+r;s[o]<t[r]&&(t[r]=s[o]),s[o]>n[r]&&(n[r]=s[o])}if(e.quantization){const i=e.quantization,s=i.range/(1<<i.quantizationBits),o=i.minValues;r["f"].scale(t,t,s),r["f"].add(t,t,o),r["f"].scale(n,n,s),r["f"].add(n,n,o)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t},{}),material:t.material};return n&&(a.indices=n),i&&(a.morphTargets=i),a.mode=o(t.mode)?t.mode:4,o(t.extras)&&(a.extras=t.extras),a})}}function V(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!U)return void n(new Error("There is no canvas to draw image!"));U.width=r.width,U.height=r.height;const t=U.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),i={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,i)},r.onerror=function(t){n(t)},r.src=t}const G=[],q=[];let W,X;function Q(t,e,n){W||(W=new OffscreenCanvas(2,2),X=W.getContext("2d",{willReadFrequently:!0}));let r=null;if(a(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),G.push([t,e,n,this]),function t(){if(!G.length||q.length>10)return;const e=G.shift(),[n,r,i,s]=e;q.push(e),fetch(n,r).then(t=>t.arrayBuffer()).then(t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)}).then(Y.bind(s)).then(n=>{i.call(s,null,n);const r=q.indexOf(e);q.splice(r,1),t()}).catch(n=>{console.warn(n),i.call(s,n);const r=q.indexOf(e);q.splice(r,1),t()})}();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(Y.bind(this)).then(t=>{n(null,t)}).catch(t=>{console.warn(t),n(t)})}}function Y(t){let{width:e,height:n}=t;Z(e)||(e=K(e)),Z(n)||(n=K(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),W.width=e,W.height=n,X.drawImage(t,0,0,e,n),t.close();const i=X.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(i.data)}}function Z(t){return 0==(t&t-1)&&0!==t}function K(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}},"3dd5":function(t,e,n){"use strict";function r(t,e,n){n=n||{},this.w=t||64,this.h=e||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}function i(t,e,n){this.x=0,this.y=t,this.w=this.free=e,this.h=n}function s(t,e,n,r,i,s,o){this.id=t,this.x=e,this.y=n,this.w=r,this.h=i,this.maxw=s||r,this.maxh=o||i,this.refcount=0}e["a"]=r,r.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var n,r,i,s,o=[],a=0;a<t.length;a++)if(n=t[a].w||t[a].width,r=t[a].h||t[a].height,i=t[a].id,n&&r){if(s=this.packOne(n,r,i),!s)continue;e.inPlace&&(t[a].x=s.x,t[a].y=s.y,t[a].id=s.id),o.push(s)}return this.shrink(),o},r.prototype.packOne=function(t,e,n){var r,s,o,a,l,h,c,u,f={freebin:-1,shelf:-1,waste:1/0},d=0;if("string"===typeof n||"number"===typeof n){if(r=this.getBin(n),r)return this.ref(r),r;"number"===typeof n&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(a=0;a<this.freebins.length;a++){if(r=this.freebins[a],e===r.maxh&&t===r.maxw)return this.allocFreebin(a,t,e,n);e>r.maxh||t>r.maxw||e<=r.maxh&&t<=r.maxw&&(o=r.maxw*r.maxh-t*e,o<f.waste&&(f.waste=o,f.freebin=a))}for(a=0;a<this.shelves.length;a++)if(s=this.shelves[a],d+=s.h,!(t>s.free)){if(e===s.h)return this.allocShelf(a,t,e,n);e>s.h||e<s.h&&(o=(s.h-e)*t,o<f.waste&&(f.freebin=-1,f.waste=o,f.shelf=a))}return-1!==f.freebin?this.allocFreebin(f.freebin,t,e,n):-1!==f.shelf?this.allocShelf(f.shelf,t,e,n):e<=this.h-d&&t<=this.w?(s=new i(d,this.w,e),this.allocShelf(this.shelves.push(s)-1,t,e,n)):this.autoResize?(l=h=this.h,c=u=this.w,(c<=l||t>c)&&(u=2*Math.max(t,c)),(l<c||e>l)&&(h=2*Math.max(e,l)),this.resize(u,h),this.packOne(t,e,n)):null},r.prototype.allocFreebin=function(t,e,n,r){var i=this.freebins.splice(t,1)[0];return i.id=r,i.w=e,i.h=n,i.refcount=0,this.bins[r]=i,this.ref(i),i},r.prototype.allocShelf=function(t,e,n,r){var i=this.shelves[t],s=i.alloc(e,n,r);return this.bins[r]=s,this.ref(s),s},r.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,n=0;n<this.shelves.length;n++){var r=this.shelves[n];e+=r.h,t=Math.max(r.w-r.free,t)}this.resize(t,e)}},r.prototype.getBin=function(t){return this.bins[t]},r.prototype.ref=function(t){if(1===++t.refcount){var e=t.h;this.stats[e]=1+(0|this.stats[e])}return t.refcount},r.prototype.unref=function(t){return 0===t.refcount?0:(0===--t.refcount&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},r.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},r.prototype.resize=function(t,e){this.w=t,this.h=e;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(t);return!0},i.prototype.alloc=function(t,e,n){if(t>this.free||e>this.h)return null;var r=this.x;return this.x+=t,this.free-=t,new s(n,r,this.y,t,e,t,this.h)},i.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0}},"4e8c":function(t,e,n){(function(e,n){t.exports=n()})(0,(function(){function t(t,e){this.id=Y++,this.type=t,this.data=e}function e(t){if(0===t.length)return[];var n=t.charAt(0),r=t.charAt(t.length-1);if(1<t.length&&n===r&&('"'===n||"'"===n))return['"'+t.substr(1,t.length-2).replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];if(n=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(t))return e(t.substr(0,n.index)).concat(e(n[1])).concat(e(t.substr(n.index+n[0].length)));if(n=t.split("."),1===n.length)return['"'+t.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'];for(t=[],r=0;r<n.length;++r)t=t.concat(e(n[r]));return t}function n(t){return"["+e(t).join("][")+"]"}function r(e,n){return"function"===typeof e?new t(0,e):"number"===typeof e||"boolean"===typeof e?new t(5,e):Array.isArray(e)?new t(6,e.map((function(t,e){return r(t,n+"["+e+"]")}))):e instanceof t?e:void 0}function i(){var t={"":0},e=[""];return{id:function(n){var r=t[n];return r||(r=t[n]=e.length,e.push(n),r)},str:function(t){return e[t]}}}function s(t,e,n){function r(){var e=window.innerWidth,r=window.innerHeight;t!==document.body&&(r=t.getBoundingClientRect(),e=r.right-r.left,r=r.bottom-r.top),s.width=n*e,s.height=n*r,Q(s.style,{width:e+"px",height:r+"px"})}var i,s=document.createElement("canvas");return Q(s.style,{border:0,margin:0,padding:0,top:0,left:0}),t.appendChild(s),t===document.body&&(s.style.position="absolute",Q(t.style,{margin:0,padding:0})),t!==document.body&&"function"===typeof ResizeObserver?(i=new ResizeObserver((function(){setTimeout(r)})),i.observe(t)):window.addEventListener("resize",r,!1),r(),{canvas:s,onDestroy:function(){i?i.disconnect():window.removeEventListener("resize",r),t.removeChild(s)}}}function o(t,e){function n(n){try{return t.getContext(n,e)}catch(r){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function a(t){return"string"===typeof t?t.split():t}function l(t){return"string"===typeof t?document.querySelector(t):t}function h(t){var e,n,r,i,h=t||{};t={};var c=[],u=[],f="undefined"===typeof window?1:window.devicePixelRatio,d=!1,p=function(t){},A=function(){};if("string"===typeof h?e=document.querySelector(h):"object"===typeof h&&("string"===typeof h.nodeName&&"function"===typeof h.appendChild&&"function"===typeof h.getBoundingClientRect?e=h:"function"===typeof h.drawArrays||"function"===typeof h.drawElements?(i=h,r=i.canvas):("gl"in h?i=h.gl:"canvas"in h?r=l(h.canvas):"container"in h&&(n=l(h.container)),"attributes"in h&&(t=h.attributes),"extensions"in h&&(c=a(h.extensions)),"optionalExtensions"in h&&(u=a(h.optionalExtensions)),"onDone"in h&&(p=h.onDone),"profile"in h&&(d=!!h.profile),"pixelRatio"in h&&(f=+h.pixelRatio))),e&&("canvas"===e.nodeName.toLowerCase()?r=e:n=e),!i){if(!r){if(e=s(n||document.body,p,f),!e)return null;r=e.canvas,A=e.onDestroy}void 0===t.premultipliedAlpha&&(t.premultipliedAlpha=!0),i=o(r,t)}return i?{gl:i,canvas:r,container:n,extensions:c,optionalExtensions:u,pixelRatio:f,profile:d,onDone:p,onDestroy:A}:(A(),p("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function c(t,e){function n(e){var n;e=e.toLowerCase();try{n=r[e]=t.getExtension(e)}catch(i){}return!!n}for(var r={},i=0;i<e.extensions.length;++i){var s=e.extensions[i];if(!n(s))return e.onDestroy(),e.onDone('"'+s+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return e.optionalExtensions.forEach(n),{extensions:r,restore:function(){Object.keys(r).forEach((function(t){if(r[t]&&!n(t))throw Error("(regl): error restoring extension "+t)}))}}}function u(t,e){for(var n=Array(t),r=0;r<t;++r)n[r]=e(r);return n}function f(t){var e,n;return e=(65535<t)<<4,t>>>=e,n=(255<t)<<3,t>>>=n,e|=n,n=(15<t)<<2,t>>>=n,e|=n,n=(3<t)<<1,e|n|t>>>n>>1}function d(){function t(t){t:{for(var e=16;268435456>=e;e*=16)if(t<=e){t=e;break t}t=0}return e=n[f(t)>>2],0<e.length?e.pop():new ArrayBuffer(t)}function e(t){n[f(t.byteLength)>>2].push(t)}var n=u(8,(function(){return[]}));return{alloc:t,free:e,allocType:function(e,n){var r=null;switch(e){case 5120:r=new Int8Array(t(n),0,n);break;case 5121:r=new Uint8Array(t(n),0,n);break;case 5122:r=new Int16Array(t(2*n),0,n);break;case 5123:r=new Uint16Array(t(2*n),0,n);break;case 5124:r=new Int32Array(t(4*n),0,n);break;case 5125:r=new Uint32Array(t(4*n),0,n);break;case 5126:r=new Float32Array(t(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r},freeType:function(t){e(t.buffer)}}}function p(t){return!!t&&"object"===typeof t&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"===typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||et(t.data))}function A(t,e,n,r,i,s){for(var o=0;o<e;++o)for(var a=t[o],l=0;l<n;++l)for(var h=a[l],c=0;c<r;++c)i[s++]=h[c]}function g(t,e,n,r,i){for(var s=1,o=n+1;o<e.length;++o)s*=e[o];var a=e[n];if(4===e.length-n){var l=e[n+1],h=e[n+2];for(e=e[n+3],o=0;o<a;++o)A(t[o],l,h,e,r,i),i+=s}else for(o=0;o<a;++o)g(t[o],e,n+1,r,i),i+=s}function m(t){return 0|it[Object.prototype.toString.call(t)]}function y(t,e){for(var n=0;n<e.length;++n)t[n]=e[n]}function v(t,e,n,r,i,s,o){for(var a=0,l=0;l<n;++l)for(var h=0;h<r;++h)t[a++]=e[i*l+s*h+o]}function x(t,e,n,r){function i(e){this.id=l++,this.buffer=t.createBuffer(),this.type=e,this.usage=35044,this.byteLength=0,this.dimension=1,this.dtype=5121,this.persistentData=null,n.profile&&(this.stats={size:0})}function s(e,n,r){e.byteLength=n.byteLength,t.bufferData(e.type,n,r)}function o(t,e,n,r,i,o){if(t.usage=n,Array.isArray(e)){if(t.dtype=r||5126,0<e.length)if(Array.isArray(e[0])){i=lt(e);for(var a=r=1;a<i.length;++a)r*=i[a];t.dimension=r,e=at(e,i,t.dtype),s(t,e,n),o?t.persistentData=e:$.freeType(e)}else"number"===typeof e[0]?(t.dimension=i,i=$.allocType(t.dtype,e.length),y(i,e),s(t,i,n),o?t.persistentData=i:$.freeType(i)):et(e[0])&&(t.dimension=e[0].length,t.dtype=r||m(e[0])||5126,e=at(e,[e.length,e[0].length],t.dtype),s(t,e,n),o?t.persistentData=e:$.freeType(e))}else if(et(e))t.dtype=r||m(e),t.dimension=i,s(t,e,n),o&&(t.persistentData=new Uint8Array(new Uint8Array(e.buffer)));else if(p(e)){i=e.shape;var l=e.stride,h=(a=e.offset,0),c=0,u=0,f=0;1===i.length?(h=i[0],c=1,u=l[0],f=0):2===i.length&&(h=i[0],c=i[1],u=l[0],f=l[1]),t.dtype=r||m(e.data)||5126,t.dimension=c,i=$.allocType(t.dtype,h*c),v(i,e.data,h,c,u,f,a),s(t,i,n),o?t.persistentData=i:$.freeType(i)}else e instanceof ArrayBuffer&&(t.dtype=5121,t.dimension=i,s(t,e,n),o&&(t.persistentData=new Uint8Array(new Uint8Array(e))))}function a(n){e.bufferCount--,r(n),t.deleteBuffer(n.buffer),n.buffer=null,delete h[n.id]}var l=0,h={};i.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},i.prototype.destroy=function(){a(this)};var c=[];return n.profile&&(e.getTotalBufferSize=function(){var t=0;return Object.keys(h).forEach((function(e){t+=h[e].stats.size})),t}),{create:function(r,s,l,c){function u(e){var r=35044,i=null,s=0,a=0,l=f&&f.dimension||1;return Array.isArray(e)||et(e)||p(e)||e instanceof ArrayBuffer?i=e:"number"===typeof e?s=0|e:e&&("data"in e&&(i=e.data),"usage"in e&&(r=ot[e.usage]),"type"in e&&(a=st[e.type]),"dimension"in e&&(l=0|e.dimension),"length"in e&&(s=0|e.length)),f.bind(),i?o(f,i,r,a,l,c):(s&&t.bufferData(f.type,s,r),f.dtype=a||5121,f.usage=r,f.dimension=l,f.byteLength=s),n.profile&&(f.stats.size=f.byteLength*ht[f.dtype]),u}e.bufferCount++;var f=new i(s);return h[f.id]=f,l||u(r),u._reglType="buffer",u._buffer=f,u.subdata=function(e,n){var r,i=0|(n||0);if(f.bind(),et(e)||e instanceof ArrayBuffer)t.bufferSubData(f.type,i,e);else if(Array.isArray(e)){if(0<e.length)if("number"===typeof e[0]){var s=$.allocType(f.dtype,e.length);y(s,e),t.bufferSubData(f.type,i,s),$.freeType(s)}else(Array.isArray(e[0])||et(e[0]))&&(r=lt(e),s=at(e,r,f.dtype),t.bufferSubData(f.type,i,s),$.freeType(s))}else if(p(e)){r=e.shape;var o=e.stride,a=s=0,l=0,h=0;1===r.length?(s=r[0],a=1,l=o[0],h=0):2===r.length&&(s=r[0],a=r[1],l=o[0],h=o[1]),r=Array.isArray(e.data)?f.dtype:m(e.data),r=$.allocType(r,s*a),v(r,e.data,s,a,l,h,e.offset),t.bufferSubData(f.type,i,r),$.freeType(r)}return u},n.profile&&(u.stats=f.stats),u.destroy=function(){a(f)},u},createStream:function(t,e){var n=c.pop();return n||(n=new i(t)),n.bind(),o(n,e,35040,0,1,!1),n},destroyStream:function(t){c.push(t)},clear:function(){nt(h).forEach(a),c.forEach(a)},getBuffer:function(t){return t&&t._buffer instanceof i?t._buffer:null},restore:function(){nt(h).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))},_initBuffer:o}}function b(t,e,n,r){function i(t){this.id=l++,a[this.id]=this,this.buffer=t,this.primType=4,this.type=this.vertCount=0}function s(r,i,s,o,a,l,h){var c;if(r.buffer.bind(),i?((c=h)||et(i)&&(!p(i)||et(i.data))||(c=e.oes_element_index_uint?5125:5123),n._initBuffer(r.buffer,i,s,c,3)):(t.bufferData(34963,l,s),r.buffer.dtype=c||5121,r.buffer.usage=s,r.buffer.dimension=3,r.buffer.byteLength=l),c=h,!h){switch(r.buffer.dtype){case 5121:case 5120:c=5121;break;case 5123:case 5122:c=5123;break;case 5125:case 5124:c=5125}r.buffer.dtype=c}r.type=c,i=a,0>i&&(i=r.buffer.byteLength,5123===c?i>>=1:5125===c&&(i>>=2)),r.vertCount=i,i=o,0>o&&(i=4,o=r.buffer.dimension,1===o&&(i=0),2===o&&(i=1),3===o&&(i=4)),r.primType=i}function o(t){r.elementsCount--,delete a[t.id],t.buffer.destroy(),t.buffer=null}var a={},l=0,h={uint8:5121,uint16:5123};e.oes_element_index_uint&&(h.uint32=5125),i.prototype.bind=function(){this.buffer.bind()};var c=[];return{create:function(t,e){function a(t){if(t)if("number"===typeof t)l(t),c.primType=4,c.vertCount=0|t,c.type=5121;else{var e=null,n=35044,r=-1,i=-1,o=0,u=0;Array.isArray(t)||et(t)||p(t)?e=t:("data"in t&&(e=t.data),"usage"in t&&(n=ot[t.usage]),"primitive"in t&&(r=ct[t.primitive]),"count"in t&&(i=0|t.count),"type"in t&&(u=h[t.type]),"length"in t?o=0|t.length:(o=i,5123===u||5122===u?o*=2:5125!==u&&5124!==u||(o*=4))),s(c,e,n,r,i,o,u)}else l(),c.primType=4,c.vertCount=0,c.type=5121;return a}var l=n.create(null,34963,!0),c=new i(l._buffer);return r.elementsCount++,a(t),a._reglType="elements",a._elements=c,a.subdata=function(t,e){return l.subdata(t,e),a},a.destroy=function(){o(c)},a},createStream:function(t){var e=c.pop();return e||(e=new i(n.create(null,34963,!0,!1)._buffer)),s(e,t,35040,-1,-1,0,0),e},destroyStream:function(t){c.push(t)},getElements:function(t){return"function"===typeof t&&t._elements instanceof i?t._elements:null},clear:function(){nt(a).forEach(o)}}}function w(t){for(var e=$.allocType(5123,t.length),n=0;n<t.length;++n)if(isNaN(t[n]))e[n]=65535;else if(1/0===t[n])e[n]=31744;else if(-1/0===t[n])e[n]=64512;else{ut[0]=t[n];var r=ft[0],i=r>>>31<<15,s=(r<<1>>>24)-127;r=r>>13&1023;e[n]=-24>s?i:-14>s?i+(r+1024>>-14-s):15<s?i+31744:i+(s+15<<10)+r}return e}function _(t){return Array.isArray(t)||et(t)}function M(t){return"[object "+t+"]"}function T(t){return Array.isArray(t)&&(0===t.length||"number"===typeof t[0])}function S(t){return!(!Array.isArray(t)||0===t.length||!_(t[0]))}function I(t){return Object.prototype.toString.call(t)}function C(t){if(!t)return!1;var e=I(t);return 0<=wt.indexOf(e)||(T(t)||S(t)||p(t))}function O(t,e){36193===t.type?(t.data=w(e),$.freeType(e)):t.data=e}function E(t,e,n,r,i,s){if(t="undefined"!==typeof Mt[t]?Mt[t]:At[t]*_t[e],s&&(t*=6),i){for(r=0;1<=n;)r+=t*n*n,n/=2;return r}return t*n*r}function P(t,e,n,r,i,s,o){function a(){this.format=this.internalformat=6408,this.type=5121,this.flipY=this.premultiplyAlpha=this.compressed=!1,this.unpackAlignment=1,this.colorSpace=37444,this.channels=this.height=this.width=0}function l(t,e){t.internalformat=e.internalformat,t.format=e.format,t.type=e.type,t.compressed=e.compressed,t.premultiplyAlpha=e.premultiplyAlpha,t.flipY=e.flipY,t.unpackAlignment=e.unpackAlignment,t.colorSpace=e.colorSpace,t.width=e.width,t.height=e.height,t.channels=e.channels}function h(t,e){if("object"===typeof e&&e){"premultiplyAlpha"in e&&(t.premultiplyAlpha=e.premultiplyAlpha),"flipY"in e&&(t.flipY=e.flipY),"alignment"in e&&(t.unpackAlignment=e.alignment),"colorSpace"in e&&(t.colorSpace=j[e.colorSpace]),"type"in e&&(t.type=V[e.type]);var n=t.width,r=t.height,i=t.channels,s=!1;"shape"in e?(n=e.shape[0],r=e.shape[1],3===e.shape.length&&(i=e.shape[2],s=!0)):("radius"in e&&(n=r=e.radius),"width"in e&&(n=e.width),"height"in e&&(r=e.height),"channels"in e&&(i=e.channels,s=!0)),t.width=0|n,t.height=0|r,t.channels=0|i,n=!1,"format"in e&&(n=e.format,r=t.internalformat=G[n],t.format=st[r],n in V&&!("type"in e)&&(t.type=V[n]),n in q&&(t.compressed=!0),n=!0),!s&&n?t.channels=At[t.format]:s&&!n&&t.channels!==pt[t.format]&&(t.format=t.internalformat=pt[t.channels])}}function c(e){t.pixelStorei(37440,e.flipY),t.pixelStorei(37441,e.premultiplyAlpha),t.pixelStorei(37443,e.colorSpace),t.pixelStorei(3317,e.unpackAlignment)}function u(){a.call(this),this.yOffset=this.xOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function f(t,e){var n=null;if(C(e)?n=e:e&&(h(t,e),"x"in e&&(t.xOffset=0|e.x),"y"in e&&(t.yOffset=0|e.y),C(e.data)&&(n=e.data)),e.copy){var r=i.viewportWidth,s=i.viewportHeight;t.width=t.width||r-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0}else if(n){if(et(n))t.channels=t.channels||4,t.data=n,"type"in e||5121!==t.type||(t.type=0|it[Object.prototype.toString.call(n)]);else if(T(n)){switch(t.channels=t.channels||4,r=n,s=r.length,t.type){case 5121:case 5123:case 5125:case 5126:s=$.allocType(t.type,s),s.set(r),t.data=s;break;case 36193:t.data=w(r)}t.alignment=1,t.needsFree=!0}else if(p(n)){r=n.data,Array.isArray(r)||5121!==t.type||(t.type=0|it[Object.prototype.toString.call(r)]);s=n.shape;var o,a,l,c,u=n.stride;3===s.length?(l=s[2],c=u[2]):c=l=1,o=s[0],a=s[1],s=u[0],u=u[1],t.alignment=1,t.width=o,t.height=a,t.channels=l,t.format=t.internalformat=pt[l],t.needsFree=!0,o=c,n=n.offset,l=t.width,c=t.height,a=t.channels;for(var f=$.allocType(36193===t.type?5126:t.type,l*c*a),d=0,A=0;A<c;++A)for(var g=0;g<l;++g)for(var m=0;m<a;++m)f[d++]=r[s*g+u*A+o*m+n];O(t,f)}else if(I(n)===gt||I(n)===mt||I(n)===yt)I(n)===gt||I(n)===mt?t.element=n:t.element=n.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(I(n)===vt)t.element=n,t.width=n.width,t.height=n.height,t.channels=4;else if(I(n)===xt)t.element=n,t.width=n.naturalWidth,t.height=n.naturalHeight,t.channels=4;else if(I(n)===bt)t.element=n,t.width=n.videoWidth,t.height=n.videoHeight,t.channels=4;else if(S(n)){for(r=t.width||n[0].length,s=t.height||n.length,u=t.channels,u=_(n[0][0])?u||n[0][0].length:u||1,o=rt.shape(n),l=1,c=0;c<o.length;++c)l*=o[c];l=$.allocType(36193===t.type?5126:t.type,l),rt.flatten(n,o,"",l),O(t,l),t.alignment=1,t.width=r,t.height=s,t.channels=u,t.format=t.internalformat=pt[u],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4}function d(e,n,i,s,o){var a=e.element,l=e.data,h=e.internalformat,u=e.format,f=e.type,d=e.width,p=e.height;c(e),a?t.texSubImage2D(n,o,i,s,u,f,a):e.compressed?t.compressedTexSubImage2D(n,o,i,s,h,d,p,l):e.needsCopy?(r(),t.copyTexSubImage2D(n,o,i,s,e.xOffset,e.yOffset,d,p)):t.texSubImage2D(n,o,i,s,d,p,u,f,l)}function A(){return ot.pop()||new u}function g(t){t.needsFree&&$.freeType(t.data),u.call(t),ot.push(t)}function m(){a.call(this),this.genMipmaps=!1,this.mipmapHint=4352,this.mipmask=0,this.images=Array(16)}function y(t,e,n){var r=t.images[0]=A();t.mipmask=1,r.width=t.width=e,r.height=t.height=n,r.channels=t.channels=4}function v(t,e){var n=null;if(C(e))n=t.images[0]=A(),l(n,t),f(n,e),t.mipmask=1;else if(h(t,e),Array.isArray(e.mipmap))for(var r=e.mipmap,i=0;i<r.length;++i)n=t.images[i]=A(),l(n,t),n.width>>=i,n.height>>=i,f(n,r[i]),t.mipmask|=1<<i;else n=t.images[0]=A(),l(n,t),f(n,e),t.mipmask=1;l(t,t.images[0])}function x(e,n){for(var i=e.images,s=0;s<i.length&&i[s];++s){var o=i[s],a=n,l=s,h=o.element,u=o.data,f=o.internalformat,d=o.format,p=o.type,A=o.width,g=o.height;c(o),h?t.texImage2D(a,l,d,d,p,h):o.compressed?t.compressedTexImage2D(a,l,f,Math.max(1,A),Math.max(1,g),0,u):o.needsCopy?(r(),t.copyTexImage2D(a,l,d,o.xOffset,o.yOffset,A,g,0)):t.texImage2D(a,l,d,A,g,0,d,p,u||null)}}function b(){var t=at.pop()||new m;a.call(t);for(var e=t.mipmask=0;16>e;++e)t.images[e]=null;return t}function M(t){for(var e=t.images,n=0;n<e.length;++n)e[n]&&g(e[n]),e[n]=null;at.push(t)}function P(){this.magFilter=this.minFilter=9728,this.wrapT=this.wrapS=33071,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=4352}function k(t,e){"min"in e&&(t.minFilter=U[e.min],0<=dt.indexOf(t.minFilter)&&!("faces"in e)&&(t.genMipmaps=!0)),"mag"in e&&(t.magFilter=H[e.mag]);var n=t.wrapS,r=t.wrapT;if("wrap"in e){var i=e.wrap;"string"===typeof i?n=r=B[i]:Array.isArray(i)&&(n=B[i[0]],r=B[i[1]])}else"wrapS"in e&&(n=B[e.wrapS]),"wrapT"in e&&(r=B[e.wrapT]);if(t.wrapS=n,t.wrapT=r,"anisotropic"in e&&(t.anisotropic=e.anisotropic),"mipmap"in e){switch(n=!1,typeof e.mipmap){case"string":t.mipmapHint=z[e.mipmap],n=t.genMipmaps=!0;break;case"boolean":n=t.genMipmaps=e.mipmap;break;case"object":t.genMipmaps=!1,n=!0}!n||"min"in e||(t.minFilter=9984)}}function R(n,r){t.texParameteri(r,10241,n.minFilter),t.texParameteri(r,10240,n.magFilter),t.texParameteri(r,10242,n.wrapS),t.texParameteri(r,10243,n.wrapT),e.ext_texture_filter_anisotropic&&t.texParameteri(r,34046,n.anisotropic),n.genMipmaps&&(t.hint(33170,n.mipmapHint),t.generateMipmap(r))}function N(e){a.call(this),this.mipmask=0,this.internalformat=6408,this.id=lt++,this.refCount=1,this.target=e,this.texture=t.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new P,o.profile&&(this.stats={size:0})}function D(e){t.activeTexture(33984),t.bindTexture(e.target,e.texture)}function F(){var e=ut[0];e?t.bindTexture(e.target,e.texture):t.bindTexture(3553,null)}function L(e){var n=e.texture,r=e.unit,i=e.target;0<=r&&(t.activeTexture(33984+r),t.bindTexture(i,null),ut[r]=null),t.deleteTexture(n),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete ht[e.id],s.textureCount--}var z={"don't care":4352,"dont care":4352,nice:4354,fast:4353},B={repeat:10497,clamp:33071,mirror:33648},H={nearest:9728,linear:9729},U=Q({mipmap:9987,"nearest mipmap nearest":9984,"linear mipmap nearest":9985,"nearest mipmap linear":9986,"linear mipmap linear":9987},H),j={none:0,browser:37444},V={uint8:5121,rgba4:32819,rgb565:33635,"rgb5 a1":32820},G={alpha:6406,luminance:6409,"luminance alpha":6410,rgb:6407,rgba:6408,rgba4:32854,"rgb5 a1":32855,rgb565:36194},q={};e.ext_srgb&&(G.srgb=35904,G.srgba=35906),e.oes_texture_float&&(V.float32=V["float"]=5126),e.oes_texture_half_float&&(V.float16=V["half float"]=36193),e.webgl_depth_texture&&(Q(G,{depth:6402,"depth stencil":34041}),Q(V,{uint16:5123,uint32:5125,"depth stencil":34042})),e.webgl_compressed_texture_s3tc&&Q(q,{"rgb s3tc dxt1":33776,"rgba s3tc dxt1":33777,"rgba s3tc dxt3":33778,"rgba s3tc dxt5":33779}),e.webgl_compressed_texture_atc&&Q(q,{"rgb atc":35986,"rgba atc explicit alpha":35987,"rgba atc interpolated alpha":34798}),e.webgl_compressed_texture_pvrtc&&Q(q,{"rgb pvrtc 4bppv1":35840,"rgb pvrtc 2bppv1":35841,"rgba pvrtc 4bppv1":35842,"rgba pvrtc 2bppv1":35843}),e.webgl_compressed_texture_etc1&&(q["rgb etc1"]=36196);var W=Array.prototype.slice.call(t.getParameter(34467));Object.keys(q).forEach((function(t){var e=q[t];0<=W.indexOf(e)&&(G[t]=e)}));var X=Object.keys(G);n.textureFormats=X;var Y=[];Object.keys(G).forEach((function(t){Y[G[t]]=t}));var Z=[];Object.keys(V).forEach((function(t){Z[V[t]]=t}));var K=[];Object.keys(H).forEach((function(t){K[H[t]]=t}));var J=[];Object.keys(U).forEach((function(t){J[U[t]]=t}));var tt=[];Object.keys(B).forEach((function(t){tt[B[t]]=t}));var st=X.reduce((function(t,n){var r=G[n];return 6409===r||6406===r||6409===r||6410===r||6402===r||34041===r||e.ext_srgb&&(35904===r||35906===r)?t[r]=r:32855===r||0<=n.indexOf("rgba")?t[r]=6408:t[r]=6407,t}),{}),ot=[],at=[],lt=0,ht={},ct=n.maxTextureUnits,ut=Array(ct).map((function(){return null}));return Q(N.prototype,{bind:function(){this.bindCount+=1;var e=this.unit;if(0>e){for(var n=0;n<ct;++n){var r=ut[n];if(r){if(0<r.bindCount)continue;r.unit=-1}ut[n]=this,e=n;break}o.profile&&s.maxTextureUnits<e+1&&(s.maxTextureUnits=e+1),this.unit=e,t.activeTexture(33984+e),t.bindTexture(this.target,this.texture)}return e},unbind:function(){--this.bindCount},decRef:function(){0>=--this.refCount&&L(this)}}),o.profile&&(s.getTotalTextureSize=function(){var t=0;return Object.keys(ht).forEach((function(e){t+=ht[e].stats.size})),t}),{create2D:function(e,n){function r(t,e){var n=i.texInfo;P.call(n);var s=b();return"number"===typeof t?y(s,0|t,"number"===typeof e?0|e:0|t):t?(k(n,t),v(s,t)):y(s,1,1),n.genMipmaps&&(s.mipmask=(Math.max(s.width,s.height)<<1)-1),i.mipmask=s.mipmask,l(i,s),i.internalformat=s.internalformat,r.width=s.width,r.height=s.height,D(i),x(s,3553),R(n,3553),F(),M(s),o.profile&&(i.stats.size=E(i.internalformat,i.type,s.width,s.height,n.genMipmaps,!1)),r.format=Y[i.internalformat],r.type=Z[i.type],r.mag=K[n.magFilter],r.min=J[n.minFilter],r.wrapS=tt[n.wrapS],r.wrapT=tt[n.wrapT],r}var i=new N(3553);return ht[i.id]=i,s.textureCount++,r(e,n),r.subimage=function(t,e,n,s){e|=0,n|=0,s|=0;var o=A();return l(o,i),o.width=0,o.height=0,f(o,t),o.width=o.width||(i.width>>s)-e,o.height=o.height||(i.height>>s)-n,D(i),d(o,3553,e,n,s),F(),g(o),r},r.resize=function(e,n){var s=0|e,a=0|n||s;if(s===i.width&&a===i.height)return r;r.width=i.width=s,r.height=i.height=a,D(i);for(var l=0;i.mipmask>>l;++l){var h=s>>l,c=a>>l;if(!h||!c)break;t.texImage2D(3553,l,i.format,h,c,0,i.format,i.type,null)}return F(),o.profile&&(i.stats.size=E(i.internalformat,i.type,s,a,!1,!1)),r},r._reglType="texture2d",r._texture=i,o.profile&&(r.stats=i.stats),r.destroy=function(){i.decRef()},r},createCube:function(e,n,r,i,a,c){function u(t,e,n,r,i,s){var a,c=p.texInfo;for(P.call(c),a=0;6>a;++a)m[a]=b();if("number"!==typeof t&&t){if("object"===typeof t)if(e)v(m[0],t),v(m[1],e),v(m[2],n),v(m[3],r),v(m[4],i),v(m[5],s);else if(k(c,t),h(p,t),"faces"in t)for(t=t.faces,a=0;6>a;++a)l(m[a],p),v(m[a],t[a]);else for(a=0;6>a;++a)v(m[a],t)}else for(t=0|t||1,a=0;6>a;++a)y(m[a],t,t);for(l(p,m[0]),p.mipmask=c.genMipmaps?(Math.max(m[0].width,m[0].height)<<1)-1:m[0].mipmask,p.internalformat=m[0].internalformat,u.width=m[0].width,u.height=m[0].height,D(p),a=0;6>a;++a)x(m[a],34069+a);for(R(c,34067),F(),o.profile&&(p.stats.size=E(p.internalformat,p.type,u.width,u.height,c.genMipmaps,!0)),u.format=Y[p.internalformat],u.type=Z[p.type],u.mag=K[c.magFilter],u.min=J[c.minFilter],u.wrapS=tt[c.wrapS],u.wrapT=tt[c.wrapT],a=0;6>a;++a)M(m[a]);return u}var p=new N(34067);ht[p.id]=p,s.cubeCount++;var m=Array(6);return u(e,n,r,i,a,c),u.subimage=function(t,e,n,r,i){n|=0,r|=0,i|=0;var s=A();return l(s,p),s.width=0,s.height=0,f(s,e),s.width=s.width||(p.width>>i)-n,s.height=s.height||(p.height>>i)-r,D(p),d(s,34069+t,n,r,i),F(),g(s),u},u.resize=function(e){if(e|=0,e!==p.width){u.width=p.width=e,u.height=p.height=e,D(p);for(var n=0;6>n;++n)for(var r=0;p.mipmask>>r;++r)t.texImage2D(34069+n,r,p.format,e>>r,e>>r,0,p.format,p.type,null);return F(),o.profile&&(p.stats.size=E(p.internalformat,p.type,u.width,u.height,!1,!0)),u}},u._reglType="textureCube",u._texture=p,o.profile&&(u.stats=p.stats),u.destroy=function(){p.decRef()},u},clear:function(){for(var e=0;e<ct;++e)t.activeTexture(33984+e),t.bindTexture(3553,null),ut[e]=null;nt(ht).forEach(L),s.cubeCount=0,s.textureCount=0},getTexture:function(t){return null},restore:function(){for(var e=0;e<ct;++e){var n=ut[e];n&&(n.bindCount=0,n.unit=-1,ut[e]=null)}nt(ht).forEach((function(e){e.texture=t.createTexture(),t.bindTexture(e.target,e.texture);for(var n=0;32>n;++n)if(0!==(e.mipmask&1<<n))if(3553===e.target)t.texImage2D(3553,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);else for(var r=0;6>r;++r)t.texImage2D(34069+r,n,e.internalformat,e.width>>n,e.height>>n,0,e.internalformat,e.type,null);R(e.texInfo,e.target)}))},refresh:function(){for(var e=0;e<ct;++e){var n=ut[e];n&&(n.bindCount=0,n.unit=-1,ut[e]=null),t.activeTexture(33984+e),t.bindTexture(3553,null),t.bindTexture(34067,null)}}}}function k(t,e,n,r,i,s){function o(t,e,n){this.target=t,this.texture=e,this.renderbuffer=n;var r=t=0;e?(t=e.width,r=e.height):n&&(t=n.width,r=n.height),this.width=t,this.height=r}function a(t){t&&(t.texture&&t.texture._texture.decRef(),t.renderbuffer&&t.renderbuffer._renderbuffer.decRef())}function l(t,e,n){t&&(t.texture?t.texture._texture.refCount+=1:t.renderbuffer._renderbuffer.refCount+=1)}function h(e,n){n&&(n.texture?t.framebufferTexture2D(36160,e,n.target,n.texture._texture.texture,0):t.framebufferRenderbuffer(36160,e,36161,n.renderbuffer._renderbuffer.renderbuffer))}function c(t){var e=3553,n=null,r=null,i=t;return"object"===typeof t&&(i=t.data,"target"in t&&(e=0|t.target)),t=i._reglType,"texture2d"===t||"textureCube"===t?n=i:"renderbuffer"===t&&(r=i,e=36161),new o(e,n,r)}function u(t,e,n,s,a){return n?(t=r.create2D({width:t,height:e,format:s,type:a}),t._texture.refCount=0,new o(3553,t,null)):(t=i.create({width:t,height:e,format:s}),t._renderbuffer.refCount=0,new o(36161,null,t))}function f(t){return t&&(t.texture||t.renderbuffer)}function d(t,e,n){t&&(t.texture?t.texture.resize(e,n):t.renderbuffer&&t.renderbuffer.resize(e,n),t.width=e,t.height=n)}function p(){this.id=_++,M[this.id]=this,this.framebuffer=t.createFramebuffer(),this.height=this.width=0,this.colorAttachments=[],this.depthStencilAttachment=this.stencilAttachment=this.depthAttachment=null}function A(t){t.colorAttachments.forEach(a),a(t.depthAttachment),a(t.stencilAttachment),a(t.depthStencilAttachment)}function g(e){t.deleteFramebuffer(e.framebuffer),e.framebuffer=null,s.framebufferCount--,delete M[e.id]}function m(e,r){var i;t.bindFramebuffer(36160,e.framebuffer);var s=e.colorAttachments;for(i=0;i<s.length;++i)h(36064+i,s[i]);for(i=s.length;i<n.maxColorAttachments;++i)t.framebufferTexture2D(36160,36064+i,3553,null,0);t.framebufferTexture2D(36160,33306,3553,null,0),t.framebufferTexture2D(36160,36096,3553,null,0),t.framebufferTexture2D(36160,36128,3553,null,0),h(36096,e.depthAttachment),h(36128,e.stencilAttachment),h(33306,e.depthStencilAttachment),r||(t.checkFramebufferStatus(36160),t.isContextLost()),t.bindFramebuffer(36160,v.next?v.next.framebuffer:null),v.cur=v.next,r||t.getError()}function y(e,n){function r(t,e){var n,s=0,o=0,a=!0,h=!0;n=null;var d=!0,p="rgba",g="uint8",y=1,v=null,w=null,_=null,M=!1;if("number"===typeof t)s=0|t,o=0|e||s;else if(t){var T=t;"shape"in T?(o=T.shape,s=o[0],o=o[1]):("radius"in T&&(s=o=T.radius),"width"in T&&(s=T.width),"height"in T&&(o=T.height)),("color"in T||"colors"in T)&&(n=T.color||T.colors,Array.isArray(n)),n||("colorCount"in T&&(y=0|T.colorCount),"colorTexture"in T&&(d=!!T.colorTexture,p="rgba4"),"colorType"in T&&(g=T.colorType,!d)&&("half float"===g||"float16"===g?p="rgba16f":"float"!==g&&"float32"!==g||(p="rgba32f")),"colorFormat"in T&&(p=T.colorFormat,0<=x.indexOf(p)?d=!0:0<=b.indexOf(p)&&(d=!1))),("depthTexture"in T||"depthStencilTexture"in T)&&(M=!(!T.depthTexture&&!T.depthStencilTexture)),"depth"in T&&("boolean"===typeof T.depth?a=T.depth:(v=T.depth,h=!1)),"stencil"in T&&("boolean"===typeof T.stencil?h=T.stencil:(w=T.stencil,a=!1)),"depthStencil"in T&&("boolean"===typeof T.depthStencil?a=h=T.depthStencil:(_=T.depthStencil,h=a=!1))}else s=o=1;var S=null,I=null,C=null,O=null;if(Array.isArray(n))S=n.map(c);else if(n)S=[c(n)];else for(S=Array(y),n=0;n<y;++n)S[n]=u(s,o,d,p,g);for(s=s||S[0].width,o=o||S[0].height,v?I=c(v):a&&!h&&(I=u(s,o,M,"depth","uint32")),w?C=c(w):h&&!a&&(C=u(s,o,!1,"stencil","uint8")),_?O=c(_):!v&&!w&&h&&a&&(O=u(s,o,M,"depth stencil","depth stencil")),a=null,n=0;n<S.length;++n)l(S[n],s,o),S[n]&&S[n].texture&&(h=It[S[n].texture._texture.format]*Ct[S[n].texture._texture.type],null===a&&(a=h));return l(I,s,o),l(C,s,o),l(O,s,o),A(i),i.width=s,i.height=o,i.colorAttachments=S,i.depthAttachment=I,i.stencilAttachment=C,i.depthStencilAttachment=O,r.color=S.map(f),r.depth=f(I),r.stencil=f(C),r.depthStencil=f(O),r.width=i.width,r.height=i.height,m(i,T&&T.ignoreStatusCheck),r}var i=new p;return s.framebufferCount++,r(e,n),Q(r,{resize:function(t,e){var n=Math.max(0|t,1),s=Math.max(0|e||n,1);if(n===i.width&&s===i.height)return r;for(var o=i.colorAttachments,a=0;a<o.length;++a)d(o[a],n,s);return d(i.depthAttachment,n,s),d(i.stencilAttachment,n,s),d(i.depthStencilAttachment,n,s),i.width=r.width=n,i.height=r.height=s,m(i),r},blit:function(e,n,r){t.bindFramebuffer(36008,e._framebuffer.framebuffer),t.bindFramebuffer(36009,i.framebuffer),n||(n=16384),t.blitFramebuffer(0,0,e.width,e.height,0,0,i.width,i.height,n,"linear"===r?9729:9728),t.bindFramebuffer(36008,null),t.bindFramebuffer(36009,null)},_reglType:"framebuffer",_framebuffer:i,destroy:function(){g(i),A(i)},use:function(t){v.setFBO({framebuffer:r},t)}})}var v={cur:null,next:null,dirty:!1,setFBO:null},x=["rgba"],b=["rgba4","rgb565","rgb5 a1"];e.ext_srgb&&b.push("srgba"),e.ext_color_buffer_half_float&&b.push("rgba16f","rgb16f"),e.webgl_color_buffer_float&&b.push("rgba32f");var w=["uint8"];e.oes_texture_half_float&&w.push("half float","float16"),e.oes_texture_float&&w.push("float","float32");var _=0,M={};return Q(v,{getFramebuffer:function(t){return"function"===typeof t&&"framebuffer"===t._reglType&&(t=t._framebuffer,t instanceof p)?t:null},create:y,createCube:function(t){function e(t){var i,s={color:null},o=0,a=null;i="rgba";var l="uint8",h=1;if("number"===typeof t?o=0|t:t?("shape"in t?o=t.shape[0]:("radius"in t&&(o=0|t.radius),"width"in t?o=0|t.width:"height"in t&&(o=0|t.height)),("color"in t||"colors"in t)&&(a=t.color||t.colors,Array.isArray(a)),a||("colorCount"in t&&(h=0|t.colorCount),"colorType"in t&&(l=t.colorType),"colorFormat"in t&&(i=t.colorFormat)),"depth"in t&&(s.depth=t.depth),"stencil"in t&&(s.stencil=t.stencil),"depthStencil"in t&&(s.depthStencil=t.depthStencil)):o=1,a)if(Array.isArray(a))for(t=[],i=0;i<a.length;++i)t[i]=a[i];else t=[a];else for(t=Array(h),a={radius:o,format:i,type:l},i=0;i<h;++i)t[i]=r.createCube(a);for(s.color=Array(t.length),i=0;i<t.length;++i)h=t[i],o=o||h.width,s.color[i]={target:34069,data:t[i]};for(i=0;6>i;++i){for(h=0;h<t.length;++h)s.color[h].target=34069+i;0<i&&(s.depth=n[0].depth,s.stencil=n[0].stencil,s.depthStencil=n[0].depthStencil),n[i]?n[i](s):n[i]=y(s)}return Q(e,{width:o,height:o,color:t})}var n=Array(6);return e(t),Q(e,{faces:n,resize:function(t){var r=0|t;if(r===e.width)return e;var i=e.color;for(t=0;t<i.length;++t)i[t].resize(r);for(t=0;6>t;++t)n[t].resize(r);return e.width=e.height=r,e},_reglType:"framebufferCube",destroy:function(){n.forEach((function(t){t.destroy()}))}})},clear:function(){nt(M).forEach(g)},restore:function(){v.cur=null,v.next=null,v.dirty=!0,nt(M).forEach((function(e){e.framebuffer=t.createFramebuffer(),m(e)}))}})}function R(){this.w=this.z=this.y=this.x=this.state=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=5126,this.divisor=this.stride=this.offset=0}function N(t,e,n,r,i,s,o){function a(t){if(t!==m.currentVAO){var n=e.oes_vertex_array_object;t?n.bindVertexArrayOES(t.vao):n.bindVertexArrayOES(null),m.currentVAO=t}}function l(n){if(n!==m.currentVAO){if(n)n.bindAttrs();else{for(var r=e.angle_instanced_arrays,i=0;i<d.length;++i){var s=d[i];s.buffer?(t.enableVertexAttribArray(i),s.buffer.bind(),t.vertexAttribPointer(i,s.size,s.type,s.normalized,s.stride,s.offfset),r&&s.divisor&&r.vertexAttribDivisorANGLE(i,s.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,s.x,s.y,s.z,s.w))}o.elements?t.bindBuffer(34963,o.elements.buffer.buffer):t.bindBuffer(34963,null)}m.currentVAO=n}}function h(){nt(g).forEach((function(t){t.destroy()}))}function c(){this.id=++A,this.attributes=[],this.elements=null,this.ownsElements=!1,this.offset=this.count=0,this.instances=-1,this.primitive=4;var t=e.oes_vertex_array_object;this.vao=t?t.createVertexArrayOES():null,g[this.id]=this,this.buffers=[]}function u(){e.oes_vertex_array_object&&nt(g).forEach((function(t){t.refresh()}))}var f=n.maxAttributes,d=Array(f);for(n=0;n<f;++n)d[n]=new R;var A=0,g={},m={Record:R,scope:{},state:d,currentVAO:null,targetVAO:null,restore:e.oes_vertex_array_object?u:function(){},createVAO:function(t){function e(t){var r;Array.isArray(t)?(r=t,n.elements&&n.ownsElements&&n.elements.destroy(),n.elements=null,n.ownsElements=!1,n.offset=0,n.count=0,n.instances=-1,n.primitive=4):(t.elements?(r=t.elements,n.ownsElements?("function"===typeof r&&"elements"===r._reglType?n.elements.destroy():n.elements(r),n.ownsElements=!1):s.getElements(t.elements)?(n.elements=t.elements,n.ownsElements=!1):(n.elements=s.create(t.elements),n.ownsElements=!0)):(n.elements=null,n.ownsElements=!1),r=t.attributes,n.offset=0,n.count=-1,n.instances=-1,n.primitive=4,n.elements&&(n.count=n.elements._elements.vertCount,n.primitive=n.elements._elements.primType),"offset"in t&&(n.offset=0|t.offset),"count"in t&&(n.count=0|t.count),"instances"in t&&(n.instances=0|t.instances),"primitive"in t&&(n.primitive=ct[t.primitive])),t={};var o=n.attributes;o.length=r.length;for(var a=0;a<r.length;++a){var l,h=r[a],c=o[a]=new R,u=h.data||h;if(Array.isArray(u)||et(u)||p(u))n.buffers[a]&&(l=n.buffers[a],et(u)&&l._buffer.byteLength>=u.byteLength?l.subdata(u):(l.destroy(),n.buffers[a]=null)),n.buffers[a]||(l=n.buffers[a]=i.create(h,34962,!1,!0)),c.buffer=i.getBuffer(l),c.size=0|c.buffer.dimension,c.normalized=!1,c.type=c.buffer.dtype,c.offset=0,c.stride=0,c.divisor=0,c.state=1,t[a]=1;else i.getBuffer(h)?(c.buffer=i.getBuffer(h),c.size=0|c.buffer.dimension,c.normalized=!1,c.type=c.buffer.dtype,c.offset=0,c.stride=0,c.divisor=0,c.state=1):i.getBuffer(h.buffer)?(c.buffer=i.getBuffer(h.buffer),c.size=0|(+h.size||c.buffer.dimension),c.normalized=!!h.normalized||!1,c.type="type"in h?st[h.type]:c.buffer.dtype,c.offset=0|(h.offset||0),c.stride=0|(h.stride||0),c.divisor=0|(h.divisor||0),c.state=1):"x"in h&&(c.x=+h.x||0,c.y=+h.y||0,c.z=+h.z||0,c.w=+h.w||0,c.state=2)}for(l=0;l<n.buffers.length;++l)!t[l]&&n.buffers[l]&&(n.buffers[l].destroy(),n.buffers[l]=null);return n.refresh(),e}var n=new c;return r.vaoCount+=1,e.destroy=function(){for(var t=0;t<n.buffers.length;++t)n.buffers[t]&&n.buffers[t].destroy();n.buffers.length=0,n.ownsElements&&(n.elements.destroy(),n.elements=null,n.ownsElements=!1),n.destroy()},e._vao=n,e._reglType="vao",e(t)},getVAO:function(t){return"function"===typeof t&&t._vao?t._vao:null},destroyBuffer:function(e){for(var n=0;n<d.length;++n){var r=d[n];r.buffer===e&&(t.disableVertexAttribArray(n),r.buffer=null)}},setVAO:e.oes_vertex_array_object?a:l,clear:e.oes_vertex_array_object?h:function(){}};return c.prototype.bindAttrs=function(){for(var n=e.angle_instanced_arrays,r=this.attributes,i=0;i<r.length;++i){var o=r[i];o.buffer?(t.enableVertexAttribArray(i),t.bindBuffer(34962,o.buffer.buffer),t.vertexAttribPointer(i,o.size,o.type,o.normalized,o.stride,o.offset),n&&o.divisor&&n.vertexAttribDivisorANGLE(i,o.divisor)):(t.disableVertexAttribArray(i),t.vertexAttrib4f(i,o.x,o.y,o.z,o.w))}for(n=r.length;n<f;++n)t.disableVertexAttribArray(n);(n=s.getElements(this.elements))?t.bindBuffer(34963,n.buffer.buffer):t.bindBuffer(34963,null)},c.prototype.refresh=function(){var t=e.oes_vertex_array_object;t&&(t.bindVertexArrayOES(this.vao),this.bindAttrs(),m.currentVAO=null,t.bindVertexArrayOES(null))},c.prototype.destroy=function(){if(this.vao){var t=e.oes_vertex_array_object;this===m.currentVAO&&(m.currentVAO=null,t.bindVertexArrayOES(null)),t.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),g[this.id]&&(delete g[this.id],--r.vaoCount)},m}function D(t,e,n,r){function i(t,e,n,r){this.name=t,this.id=e,this.location=n,this.info=r}function s(t,e){for(var n=0;n<t.length;++n)if(t[n].id===e.id)return void(t[n].location=e.location);t.push(e)}function o(n,r,i){i=35632===n?h:c;var s=i[r];if(!s){var o=e.str(r);s=t.createShader(n);t.shaderSource(s,o),t.compileShader(s),i[r]=s}return s}function a(t,e){this.id=d++,this.fragId=t,this.vertId=e,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function l(n,a,l){var h;h=o(35632,n.fragId);var c=o(35633,n.vertId);if(a=n.program=t.createProgram(),t.attachShader(a,h),t.attachShader(a,c),l)for(h=0;h<l.length;++h)c=l[h],t.bindAttribLocation(a,c[0],c[1]);t.linkProgram(a),c=t.getProgramParameter(a,35718),r.profile&&(n.stats.uniformsCount=c);var u=n.uniforms;for(h=0;h<c;++h)if(l=t.getActiveUniform(a,h)){if(1<l.size)for(var f=0;f<l.size;++f){var d=l.name.replace("[0]","["+f+"]");s(u,new i(d,e.id(d),t.getUniformLocation(a,d),l))}f=l.name,1<l.size&&(f=f.replace("[0]","")),s(u,new i(f,e.id(f),t.getUniformLocation(a,f),l))}for(c=t.getProgramParameter(a,35721),r.profile&&(n.stats.attributesCount=c),n=n.attributes,h=0;h<c;++h)(l=t.getActiveAttrib(a,h))&&s(n,new i(l.name,e.id(l.name),t.getAttribLocation(a,l.name),l))}var h={},c={},u={},f=[],d=0;return r.profile&&(n.getMaxUniformsCount=function(){var t=0;return f.forEach((function(e){e.stats.uniformsCount>t&&(t=e.stats.uniformsCount)})),t},n.getMaxAttributesCount=function(){var t=0;return f.forEach((function(e){e.stats.attributesCount>t&&(t=e.stats.attributesCount)})),t}),{clear:function(){var e=t.deleteShader.bind(t);nt(h).forEach(e),h={},nt(c).forEach(e),c={},f.forEach((function(e){t.deleteProgram(e.program)})),f.length=0,u={},n.shaderCount=0},program:function(e,r,i,s){var o=u[r];o||(o=u[r]={});var d=o[e];if(d&&(d.refCount++,!s))return d;var p=new a(r,e);return n.shaderCount++,l(p,i,s),d||(o[e]=p),f.push(p),Q(p,{destroy:function(){if(p.refCount--,0>=p.refCount){t.deleteProgram(p.program);var e=f.indexOf(p);f.splice(e,1),n.shaderCount--}0>=o[p.vertId].refCount&&(t.deleteShader(c[p.vertId]),delete c[p.vertId],delete u[p.fragId][p.vertId]),Object.keys(u[p.fragId]).length||(t.deleteShader(h[p.fragId]),delete h[p.fragId],delete u[p.fragId])}})},restore:function(){h={},c={};for(var t=0;t<f.length;++t)l(f[t],null,f[t].attributes.map((function(t){return[t.location,t.name]})))},shader:o,frag:-1,vert:-1}}function F(t,e,n,r,i,s,o){function a(i){var s;s=null===e.next?5121:e.next.colorAttachments[0].texture._texture.type;var o=0,a=0,l=r.framebufferWidth,h=r.framebufferHeight,c=null;return et(i)?c=i:i&&(o=0|i.x,a=0|i.y,l=0|(i.width||r.framebufferWidth-o),h=0|(i.height||r.framebufferHeight-a),c=i.data||null),n(),i=l*h*4,c||(5121===s?c=new Uint8Array(i):5126===s&&(c=c||new Float32Array(i))),t.pixelStorei(3333,4),t.readPixels(o,a,l,h,6408,s,c),c}function l(t){var n;return e.setFBO({framebuffer:t.framebuffer},(function(){n=a(t)})),n}return function(t){return t&&"framebuffer"in t?l(t):a(t)}}function L(t){return Array.prototype.slice.call(t)}function z(t){return L(t).join("")}function B(){function t(){var t=[],e=[];return Q((function(){t.push.apply(t,L(arguments))}),{def:function(){var r="v"+n++;return e.push(r),0<arguments.length&&(t.push(r,"="),t.push.apply(t,L(arguments)),t.push(";")),r},toString:function(){return z([0<e.length?"var "+e.join(",")+";":"",z(t)])}})}function e(){function e(t,e){r(t,e,"=",n.def(t,e),";")}var n=t(),r=t(),i=n.toString,s=r.toString;return Q((function(){n.apply(n,L(arguments))}),{def:n.def,entry:n,exit:r,save:e,set:function(t,r,i){e(t,r),n(t,r,"=",i,";")},toString:function(){return i()+s()}})}var n=0,r=[],i=[],s=t(),o={};return{global:s,link:function(t){for(var e=0;e<i.length;++e)if(i[e]===t)return r[e];return e="g"+n++,r.push(e),i.push(t),e},block:t,proc:function(t,n){function r(){var t="a"+i.length;return i.push(t),t}var i=[];n=n||0;for(var s=0;s<n;++s)r();s=e();var a=s.toString;return o[t]=Q(s,{arg:r,toString:function(){return z(["function(",i.join(),"){",a(),"}"])}})},scope:e,cond:function(){var t=z(arguments),n=e(),r=e(),i=n.toString,s=r.toString;return Q(n,{then:function(){return n.apply(n,L(arguments)),this},else:function(){return r.apply(r,L(arguments)),this},toString:function(){var e=s();return e&&(e="else{"+e+"}"),z(["if(",t,"){",i(),"}",e])}})},compile:function(){var t=['"use strict";',s,"return {"];Object.keys(o).forEach((function(e){t.push('"',e,'":',o[e].toString(),",")})),t.push("}");var e=z(t).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,r.concat(e)).apply(null,i)}}}function H(t){return Array.isArray(t)||et(t)||p(t)}function U(t){return t.sort((function(t,e){return"viewport"===t?-1:"viewport"===e?1:t<e?-1:1}))}function j(t,e,n,r){this.thisDep=t,this.contextDep=e,this.propDep=n,this.append=r}function V(t){return t&&!(t.thisDep||t.contextDep||t.propDep)}function G(t){return new j(!1,!1,!1,t)}function q(t,e){var n=t.type;if(0===n)return n=t.data.length,new j(!0,1<=n,2<=n,e);if(4===n)return n=t.data,new j(n.thisDep,n.contextDep,n.propDep,e);if(5===n)return new j(!1,!1,!1,e);if(6===n){for(var r=n=!1,i=!1,s=0;s<t.data.length;++s){var o=t.data[s];1===o.type?i=!0:2===o.type?r=!0:3===o.type?n=!0:0===o.type?(n=!0,o=o.data,1<=o&&(r=!0),2<=o&&(i=!0)):4===o.type&&(n=n||o.data.thisDep,r=r||o.data.contextDep,i=i||o.data.propDep)}return new j(n,r,i,e)}return new j(3===n,2===n,1===n,e)}function W(t,e,n,r,i,s,o,a,l,h,c,f,d,p,A){function g(t){return t.replace(".","_")}function m(t,e,n){var r=g(t);pt.push(t),dt[r]=ft[r]=!!n,At[r]=e}function y(t,e,n){var r=g(t);pt.push(t),Array.isArray(n)?(ft[r]=n.slice(),dt[r]=n.slice()):ft[r]=dt[r]=n,gt[r]=e}function v(){var t=B(),n=t.link,r=t.global;t.id=vt++,t.batchId="0";var i=n(mt),s=t.shared={props:"a0"};Object.keys(mt).forEach((function(t){s[t]=r.def(i,".",t)}));var o=t.next={},a=t.current={};Object.keys(gt).forEach((function(t){Array.isArray(ft[t])&&(o[t]=r.def(s.next,".",t),a[t]=r.def(s.current,".",t))}));var l=t.constants={};Object.keys(yt).forEach((function(t){l[t]=r.def(JSON.stringify(yt[t]))})),t.invoke=function(e,r){switch(r.type){case 0:var i=["this",s.context,s.props,t.batchId];return e.def(n(r.data),".call(",i.slice(0,Math.max(r.data.length+1,4)),")");case 1:return e.def(s.props,r.data);case 2:return e.def(s.context,r.data);case 3:return e.def("this",r.data);case 4:return r.data.append(t,e),r.data.ref;case 5:return r.data.toString();case 6:return r.data.map((function(n){return t.invoke(e,n)}))}},t.attribCache={};var c={};return t.scopeAttrib=function(t){if(t=e.id(t),t in c)return c[t];var r=h.scope[t];return r||(r=h.scope[t]=new ot),c[t]=n(r)},t}function x(t){var e,n=t["static"];if(t=t.dynamic,"profile"in n){var r=!!n.profile;e=G((function(t,e){return r})),e.enable=r}else if("profile"in t){var i=t.profile;e=q(i,(function(t,e){return t.invoke(e,i)}))}return e}function b(t,e){var n=t["static"],r=t.dynamic;if("framebuffer"in n){var i=n.framebuffer;return i?(i=a.getFramebuffer(i),G((function(t,e){var n=t.link(i),r=t.shared;return e.set(r.framebuffer,".next",n),r=r.context,e.set(r,".framebufferWidth",n+".width"),e.set(r,".framebufferHeight",n+".height"),n}))):G((function(t,e){var n=t.shared;return e.set(n.framebuffer,".next","null"),n=n.context,e.set(n,".framebufferWidth",n+".drawingBufferWidth"),e.set(n,".framebufferHeight",n+".drawingBufferHeight"),"null"}))}if("framebuffer"in r){var s=r.framebuffer;return q(s,(function(t,e){var n=t.invoke(e,s),r=t.shared,i=r.framebuffer;n=e.def(i,".getFramebuffer(",n,")");return e.set(i,".next",n),r=r.context,e.set(r,".framebufferWidth",n+"?"+n+".width:"+r+".drawingBufferWidth"),e.set(r,".framebufferHeight",n+"?"+n+".height:"+r+".drawingBufferHeight"),n}))}return null}function w(t,e,n){function r(t){if(t in i){var n=i[t];t=!0;var r,o,a=0|n.x,l=0|n.y;return"width"in n?r=0|n.width:t=!1,"height"in n?o=0|n.height:t=!1,new j(!t&&e&&e.thisDep,!t&&e&&e.contextDep,!t&&e&&e.propDep,(function(t,e){var i=t.shared.context,s=r;"width"in n||(s=e.def(i,".","framebufferWidth","-",a));var h=o;return"height"in n||(h=e.def(i,".","framebufferHeight","-",l)),[a,l,s,h]}))}if(t in s){var h=s[t];return t=q(h,(function(t,e){var n=t.invoke(e,h),r=t.shared.context,i=e.def(n,".x|0"),s=e.def(n,".y|0"),o=e.def('"width" in ',n,"?",n,".width|0:","(",r,".","framebufferWidth","-",i,")");n=e.def('"height" in ',n,"?",n,".height|0:","(",r,".","framebufferHeight","-",s,")");return[i,s,o,n]})),e&&(t.thisDep=t.thisDep||e.thisDep,t.contextDep=t.contextDep||e.contextDep,t.propDep=t.propDep||e.propDep),t}return e?new j(e.thisDep,e.contextDep,e.propDep,(function(t,e){var n=t.shared.context;return[0,0,e.def(n,".","framebufferWidth"),e.def(n,".","framebufferHeight")]})):null}var i=t["static"],s=t.dynamic;if(t=r("viewport")){var o=t;t=new j(t.thisDep,t.contextDep,t.propDep,(function(t,e){var n=o.append(t,e),r=t.shared.context;return e.set(r,".viewportWidth",n[2]),e.set(r,".viewportHeight",n[3]),n}))}return{viewport:t,scissor_box:r("scissor.box")}}function M(t,e){var n=t["static"];if("string"===typeof n.frag&&"string"===typeof n.vert){if(0<Object.keys(e.dynamic).length)return null;n=e["static"];var r=Object.keys(n);if(0<r.length&&"number"===typeof n[r[0]]){for(var i=[],s=0;s<r.length;++s)i.push([0|n[r[s]],r[s]]);return i}}return null}function T(t,n,r){function i(t){if(t in s){var n=e.id(s[t]);return t=G((function(){return n})),t.id=n,t}if(t in o){var r=o[t];return q(r,(function(t,e){var n=t.invoke(e,r);return e.def(t.shared.strings,".id(",n,")")}))}return null}var s=t["static"],o=t.dynamic,a=i("frag"),l=i("vert"),h=null;return V(a)&&V(l)?(h=c.program(l.id,a.id,null,r),t=G((function(t,e){return t.link(h)}))):t=new j(a&&a.thisDep||l&&l.thisDep,a&&a.contextDep||l&&l.contextDep,a&&a.propDep||l&&l.propDep,(function(t,e){var n,r,i=t.shared.shader;return n=a?a.append(t,e):e.def(i,".","frag"),r=l?l.append(t,e):e.def(i,".","vert"),e.def(i+".program("+r+","+n+")")})),{frag:a,vert:l,progVar:t,program:h}}function S(t,e){function n(t,e){if(t in r){var n=0|r[t];return e?o.offset=n:o.instances=n,G((function(t,r){return e&&(t.OFFSET=n),n}))}if(t in i){var s=i[t];return q(s,(function(t,n){var r=t.invoke(n,s);return e&&(t.OFFSET=r),r}))}if(e){if(c)return G((function(t,e){return t.OFFSET=0}));if(a)return new j(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.offset:0")}))}else if(a)return new j(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.instances:-1")}));return null}var r=t["static"],i=t.dynamic,o={},a=!1,l=function(){if("vao"in r){var t=r.vao;return null!==t&&null===h.getVAO(t)&&(t=h.createVAO(t)),a=!0,o.vao=t,G((function(e){var n=h.getVAO(t);return n?e.link(n):"null"}))}if("vao"in i){a=!0;var e=i.vao;return q(e,(function(t,n){var r=t.invoke(n,e);return n.def(t.shared.vao+".getVAO("+r+")")}))}return null}(),c=!1,u=function(){if("elements"in r){var t=r.elements;if(o.elements=t,H(t)){var e=o.elements=s.create(t,!0);t=s.getElements(e);c=!0}else t&&(t=s.getElements(t),c=!0);return e=G((function(e,n){if(t){var r=e.link(t);return e.ELEMENTS=r}return e.ELEMENTS=null})),e.value=t,e}if("elements"in i){c=!0;var n=i.elements;return q(n,(function(t,e){var r=t.shared,i=r.isBufferArgs,s=(r=r.elements,t.invoke(e,n)),o=e.def("null");i=e.def(i,"(",s,")"),s=t.cond(i).then(o,"=",r,".createStream(",s,");")["else"](o,"=",r,".getElements(",s,");");return e.entry(s),e.exit(t.cond(i).then(r,".destroyStream(",o,");")),t.ELEMENTS=o}))}return a?new j(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.elements+".getElements("+t.shared.vao+".currentVAO.elements):null")})):null}(),f=n("offset",!0),d=function(){if("primitive"in r){var t=r.primitive;return o.primitive=t,G((function(e,n){return ct[t]}))}if("primitive"in i){var e=i.primitive;return q(e,(function(t,n){var r=t.constants.primTypes,i=t.invoke(n,e);return n.def(r,"[",i,"]")}))}return c?V(u)?u.value?G((function(t,e){return e.def(t.ELEMENTS,".primType")})):G((function(){return 4})):new j(u.thisDep,u.contextDep,u.propDep,(function(t,e){var n=t.ELEMENTS;return e.def(n,"?",n,".primType:",4)})):a?new j(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao+".currentVAO?"+t.shared.vao+".currentVAO.primitive:4")})):null}(),p=function(){if("count"in r){var t=0|r.count;return o.count=t,G((function(){return t}))}if("count"in i){var e=i.count;return q(e,(function(t,n){return t.invoke(n,e)}))}return c?V(u)?u?f?new j(f.thisDep,f.contextDep,f.propDep,(function(t,e){return e.def(t.ELEMENTS,".vertCount-",t.OFFSET)})):G((function(t,e){return e.def(t.ELEMENTS,".vertCount")})):G((function(){return-1})):new j(u.thisDep||f.thisDep,u.contextDep||f.contextDep,u.propDep||f.propDep,(function(t,e){var n=t.ELEMENTS;return t.OFFSET?e.def(n,"?",n,".vertCount-",t.OFFSET,":-1"):e.def(n,"?",n,".vertCount:-1")})):a?new j(l.thisDep,l.contextDep,l.propDep,(function(t,e){return e.def(t.shared.vao,".currentVAO?",t.shared.vao,".currentVAO.count:-1")})):null}(),A=n("instances",!1);return{elements:u,primitive:d,count:p,instances:A,offset:f,vao:l,vaoActive:a,elementsActive:c,static:o}}function I(t,e){var n=t["static"],r=t.dynamic,i={};return pt.forEach((function(t){function e(e,o){if(t in n){var a=e(n[t]);i[s]=G((function(){return a}))}else if(t in r){var l=r[t];i[s]=q(l,(function(t,e){return o(t,e,t.invoke(e,l))}))}}var s=g(t);switch(t){case"cull.enable":case"blend.enable":case"dither":case"stencil.enable":case"depth.enable":case"scissor.enable":case"polygonOffset.enable":case"sample.alpha":case"sample.enable":case"depth.mask":return e((function(t){return t}),(function(t,e,n){return n}));case"depth.func":return e((function(t){return kt[t]}),(function(t,e,n){return e.def(t.constants.compareFuncs,"[",n,"]")}));case"depth.range":return e((function(t){return t}),(function(t,e,n){return t=e.def("+",n,"[0]"),e=e.def("+",n,"[1]"),[t,e]}));case"blend.func":return e((function(t){return[Pt["srcRGB"in t?t.srcRGB:t.src],Pt["dstRGB"in t?t.dstRGB:t.dst],Pt["srcAlpha"in t?t.srcAlpha:t.src],Pt["dstAlpha"in t?t.dstAlpha:t.dst]]}),(function(t,e,n){function r(t,r){return e.def('"',t,r,'" in ',n,"?",n,".",t,r,":",n,".",t)}t=t.constants.blendFuncs;var i=r("src","RGB"),s=r("dst","RGB"),o=(i=e.def(t,"[",i,"]"),e.def(t,"[",r("src","Alpha"),"]"));s=e.def(t,"[",s,"]");return t=e.def(t,"[",r("dst","Alpha"),"]"),[i,s,o,t]}));case"blend.equation":return e((function(t){return"string"===typeof t?[at[t],at[t]]:"object"===typeof t?[at[t.rgb],at[t.alpha]]:void 0}),(function(t,e,n){var r=t.constants.blendEquations,i=e.def(),s=e.def();return t=t.cond("typeof ",n,'==="string"'),t.then(i,"=",s,"=",r,"[",n,"];"),t["else"](i,"=",r,"[",n,".rgb];",s,"=",r,"[",n,".alpha];"),e(t),[i,s]}));case"blend.color":return e((function(t){return u(4,(function(e){return+t[e]}))}),(function(t,e,n){return u(4,(function(t){return e.def("+",n,"[",t,"]")}))}));case"stencil.mask":return e((function(t){return 0|t}),(function(t,e,n){return e.def(n,"|0")}));case"stencil.func":return e((function(t){return[kt[t.cmp||"keep"],t.ref||0,"mask"in t?t.mask:-1]}),(function(t,e,n){t=e.def('"cmp" in ',n,"?",t.constants.compareFuncs,"[",n,".cmp]",":",7680);var r=e.def(n,".ref|0");return e=e.def('"mask" in ',n,"?",n,".mask|0:-1"),[t,r,e]}));case"stencil.opFront":case"stencil.opBack":return e((function(e){return["stencil.opBack"===t?1029:1028,Rt[e.fail||"keep"],Rt[e.zfail||"keep"],Rt[e.zpass||"keep"]]}),(function(e,n,r){function i(t){return n.def('"',t,'" in ',r,"?",s,"[",r,".",t,"]:",7680)}var s=e.constants.stencilOps;return["stencil.opBack"===t?1029:1028,i("fail"),i("zfail"),i("zpass")]}));case"polygonOffset.offset":return e((function(t){return[0|t.factor,0|t.units]}),(function(t,e,n){return t=e.def(n,".factor|0"),e=e.def(n,".units|0"),[t,e]}));case"cull.face":return e((function(t){var e=0;return"front"===t?e=1028:"back"===t&&(e=1029),e}),(function(t,e,n){return e.def(n,'==="front"?',1028,":",1029)}));case"lineWidth":return e((function(t){return t}),(function(t,e,n){return n}));case"frontFace":return e((function(t){return Nt[t]}),(function(t,e,n){return e.def(n+'==="cw"?2304:2305')}));case"colorMask":return e((function(t){return t.map((function(t){return!!t}))}),(function(t,e,n){return u(4,(function(t){return"!!"+n+"["+t+"]"}))}));case"sample.coverage":return e((function(t){return["value"in t?t.value:1,!!t.invert]}),(function(t,e,n){return t=e.def('"value" in ',n,"?+",n,".value:1"),e=e.def("!!",n,".invert"),[t,e]}))}})),i}function C(t,e){var n=t["static"],r=t.dynamic,i={};return Object.keys(n).forEach((function(t){var e,r=n[t];if("number"===typeof r||"boolean"===typeof r)e=G((function(){return r}));else if("function"===typeof r){var s=r._reglType;"texture2d"===s||"textureCube"===s?e=G((function(t){return t.link(r)})):"framebuffer"!==s&&"framebufferCube"!==s||(e=G((function(t){return t.link(r.color[0])})))}else _(r)&&(e=G((function(t){return t.global.def("[",u(r.length,(function(t){return r[t]})),"]")})));e.value=r,i[t]=e})),Object.keys(r).forEach((function(t){var e=r[t];i[t]=q(e,(function(t,n){return t.invoke(n,e)}))})),i}function O(t,n){var r=t["static"],s=t.dynamic,o={};return Object.keys(r).forEach((function(t){var n=r[t],s=e.id(t),a=new ot;if(H(n))a.state=1,a.buffer=i.getBuffer(i.create(n,34962,!1,!0)),a.type=0;else{var l=i.getBuffer(n);if(l)a.state=1,a.buffer=l,a.type=0;else if("constant"in n){var h=n.constant;a.buffer="null",a.state=2,"number"===typeof h?a.x=h:Ot.forEach((function(t,e){e<h.length&&(a[t]=h[e])}))}else{l=H(n.buffer)?i.getBuffer(i.create(n.buffer,34962,!1,!0)):i.getBuffer(n.buffer);var c=0|n.offset,u=0|n.stride,f=0|n.size,d=!!n.normalized,p=0;"type"in n&&(p=st[n.type]),n=0|n.divisor,a.buffer=l,a.state=1,a.size=f,a.normalized=d,a.type=p||l.dtype,a.offset=c,a.stride=u,a.divisor=n}}o[t]=G((function(t,e){var n=t.attribCache;if(s in n)return n[s];var r={isStream:!1};return Object.keys(a).forEach((function(t){r[t]=a[t]})),a.buffer&&(r.buffer=t.link(a.buffer),r.type=r.type||r.buffer+".dtype"),n[s]=r}))})),Object.keys(s).forEach((function(t){var e=s[t];o[t]=q(e,(function(t,n){function r(t){n(l[t],"=",i,".",t,"|0;")}var i=t.invoke(n,e),s=t.shared,o=t.constants,a=s.isBufferArgs,l=(s=s.buffer,{isStream:n.def(!1)}),h=new ot;h.state=1,Object.keys(h).forEach((function(t){l[t]=n.def(""+h[t])}));var c=l.buffer,u=l.type;return n("if(",a,"(",i,")){",l.isStream,"=true;",c,"=",s,".createStream(",34962,",",i,");",u,"=",c,".dtype;","}else{",c,"=",s,".getBuffer(",i,");","if(",c,"){",u,"=",c,".dtype;",'}else if("constant" in ',i,"){",l.state,"=",2,";","if(typeof "+i+'.constant === "number"){',l[Ot[0]],"=",i,".constant;",Ot.slice(1).map((function(t){return l[t]})).join("="),"=0;","}else{",Ot.map((function(t,e){return l[t]+"="+i+".constant.length>"+e+"?"+i+".constant["+e+"]:0;"})).join(""),"}}else{","if(",a,"(",i,".buffer)){",c,"=",s,".createStream(",34962,",",i,".buffer);","}else{",c,"=",s,".getBuffer(",i,".buffer);","}",u,'="type" in ',i,"?",o.glTypes,"[",i,".type]:",c,".dtype;",l.normalized,"=!!",i,".normalized;"),r("size"),r("offset"),r("stride"),r("divisor"),n("}}"),n.exit("if(",l.isStream,"){",s,".destroyStream(",c,");","}"),l}))})),o}function E(t){var e=t["static"],n=t.dynamic,r={};return Object.keys(e).forEach((function(t){var n=e[t];r[t]=G((function(t,e){return"number"===typeof n||"boolean"===typeof n?""+n:t.link(n)}))})),Object.keys(n).forEach((function(t){var e=n[t];r[t]=q(e,(function(t,n){return t.invoke(n,e)}))})),r}function P(t,e,r,i,s){function o(t){var e=c[t];e&&(f[t]=e)}var a=M(t,e),l=b(t,s),c=w(t,l,s),u=S(t,s),f=I(t,s),d=T(t,s,a);o("viewport"),o(g("scissor.box"));var p=0<Object.keys(f).length;l={framebuffer:l,draw:u,shader:d,state:f,dirty:p,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(l.profile=x(t,s),l.uniforms=C(r,s),l.drawVAO=l.scopeVAO=u.vao,!l.drawVAO&&d.program&&!a&&n.angle_instanced_arrays&&u["static"].elements){var A=!0;if(t=d.program.attributes.map((function(t){return t=e["static"][t],A=A&&!!t,t})),A&&0<t.length){var m=h.getVAO(h.createVAO({attributes:t,elements:u["static"].elements}));l.drawVAO=new j(null,null,null,(function(t,e){return t.link(m)})),l.useVAO=!0}}return a?l.useVAO=!0:l.attributes=O(e,s),l.context=E(i,s),l}function k(t,e,n){var r=t.shared.context,i=t.scope();Object.keys(n).forEach((function(s){e.save(r,"."+s);var o=n[s].append(t,e);Array.isArray(o)?i(r,".",s,"=[",o.join(),"];"):i(r,".",s,"=",o,";")})),e(i)}function R(t,e,n,r){var i,s=t.shared,o=s.gl,a=s.framebuffer;ht&&(i=e.def(s.extensions,".webgl_draw_buffers"));var l=t.constants;s=l.drawBuffer,l=l.backBuffer;t=n?n.append(t,e):e.def(a,".next"),r||e("if(",t,"!==",a,".cur){"),e("if(",t,"){",o,".bindFramebuffer(",36160,",",t,".framebuffer);"),ht&&e(i,".drawBuffersWEBGL(",s,"[",t,".colorAttachments.length]);"),e("}else{",o,".bindFramebuffer(",36160,",null);"),ht&&e(i,".drawBuffersWEBGL(",l,");"),e("}",a,".cur=",t,";"),r||e("}")}function N(t,e,n){var r=t.shared,i=r.gl,s=t.current,o=t.next,a=r.current,l=r.next,h=t.cond(a,".dirty");pt.forEach((function(e){var r,c;if(e=g(e),!(e in n.state))if(e in o){r=o[e],c=s[e];var f=u(ft[e].length,(function(t){return h.def(r,"[",t,"]")}));h(t.cond(f.map((function(t,e){return t+"!=="+c+"["+e+"]"})).join("||")).then(i,".",gt[e],"(",f,");",f.map((function(t,e){return c+"["+e+"]="+t})).join(";"),";"))}else r=h.def(l,".",e),f=t.cond(r,"!==",a,".",e),h(f),e in At?f(t.cond(r).then(i,".enable(",At[e],");")["else"](i,".disable(",At[e],");"),a,".",e,"=",r,";"):f(i,".",gt[e],"(",r,");",a,".",e,"=",r,";")})),0===Object.keys(n.state).length&&h(a,".dirty=false;"),e(h)}function D(t,e,n,r){var i=t.shared,s=t.current,o=i.current,a=i.gl;U(Object.keys(n)).forEach((function(i){var l=n[i];if(!r||r(l)){var h=l.append(t,e);if(At[i]){var c=At[i];V(l)?e(a,h?".enable(":".disable(",c,");"):e(t.cond(h).then(a,".enable(",c,");")["else"](a,".disable(",c,");")),e(o,".",i,"=",h,";")}else if(_(h)){var u=s[i];e(a,".",gt[i],"(",h,");",h.map((function(t,e){return u+"["+e+"]="+t})).join(";"),";")}else e(a,".",gt[i],"(",h,");",o,".",i,"=",h,";")}}))}function F(t,e){lt&&(t.instancing=e.def(t.shared.extensions,".angle_instanced_arrays"))}function L(t,e,n,r,i){function s(){return"undefined"===typeof performance?"Date.now()":"performance.now()"}function o(t){h=e.def(),t(h,"=",s(),";"),"string"===typeof i?t(f,".count+=",i,";"):t(f,".count++;"),p&&(r?(c=e.def(),t(c,"=",A,".getNumPendingQueries();")):t(A,".beginQuery(",f,");"))}function a(t){t(f,".cpuTime+=",s(),"-",h,";"),p&&(r?t(A,".pushScopeStats(",c,",",A,".getNumPendingQueries(),",f,");"):t(A,".endQuery();"))}function l(t){var n=e.def(d,".profile");e(d,".profile=",t,";"),e.exit(d,".profile=",n,";")}var h,c,u=t.shared,f=t.stats,d=u.current,A=u.timer;if(n=n.profile,n){if(V(n))return void(n.enable?(o(e),a(e.exit),l("true")):l("false"));n=n.append(t,e),l(n)}else n=e.def(d,".profile");u=t.block(),o(u),e("if(",n,"){",u,"}"),t=t.block(),a(t),e.exit("if(",n,"){",t,"}")}function z(t,e,n,r,i){function s(t){switch(t){case 35664:case 35667:case 35671:return 2;case 35665:case 35668:case 35672:return 3;case 35666:case 35669:case 35673:return 4;default:return 1}}function o(n,r,i){function s(){e(l,".enableVertexAttribArray(",h,");");var n,s=i.type;n=i.size?e.def(i.size,"||",r):r,e(l,".bindBuffer(",34962,",",u,".buffer);",l,".vertexAttribPointer(",[h,n,s,i.normalized,i.stride,i.offset],");",c,".type=",s,";",c,".size=",n,";",d.map((function(t){return c+"."+t+"="+i[t]+";"})).join("")),lt&&(s=i.divisor,e("if(",c,".divisor!==",s,"){",t.instancing,".vertexAttribDivisorANGLE(",[h,s],");",c,".divisor=",s,";}"))}function o(){e("if(",c,".buffer){",l,".disableVertexAttribArray(",h,");",c,".buffer=null;","}if(",Ot.map((function(t,e){return c+"."+t+"!=="+f[e]})).join("||"),"){",l,".vertexAttrib4f(",h,",",f,");",Ot.map((function(t,e){return c+"."+t+"="+f[e]+";"})).join(""),"}")}var l=a.gl,h=e.def(n,".location"),c=e.def(a.attributes,"[",h,"]");n=i.state;var u=i.buffer,f=[i.x,i.y,i.z,i.w],d=["buffer","normalized","offset","stride"];1===n?s():2===n?o():(e("if(",n,"===",1,"){"),s(),e("}else{"),o(),e("}"))}var a=t.shared;r.forEach((function(r){var a,l=r.name,h=n.attributes[l];if(h){if(!i(h))return;a=h.append(t,e)}else{if(!i(Dt))return;var c=t.scopeAttrib(l);a={},Object.keys(new ot).forEach((function(t){a[t]=e.def(c,".",t)}))}o(t.link(r),s(r.info.type),a)}))}function W(t,n,r,i,s,o){for(var a,l=t.shared,h=l.gl,c={},f=0;f<i.length;++f){var d=i[f],p=d.name,A=d.info.type,g=d.info.size,m=r.uniforms[p];if(1<g){if(!m)continue;var y=p.replace("[0]","");if(c[y])continue;c[y]=1}var v;d=t.link(d)+".location";if(m){if(!s(m))continue;if(V(m)){if(p=m.value,35678===A||35680===A)A=t.link(p._texture||p.color[0]._texture),n(h,".uniform1i(",d,",",A+".bind());"),n.exit(A,".unbind();");else if(35674===A||35675===A||35676===A)g=t.global.def("new Float32Array(["+Array.prototype.slice.call(p)+"])"),p=2,35675===A?p=3:35676===A&&(p=4),n(h,".uniformMatrix",p,"fv(",d,",false,",g,");");else{switch(A){case 5126:a="1f";break;case 35664:a="2f";break;case 35665:a="3f";break;case 35666:a="4f";break;case 35670:a="1i";break;case 5124:a="1i";break;case 35671:a="2i";break;case 35667:a="2i";break;case 35672:a="3i";break;case 35668:a="3i";break;case 35673:a="4i";break;case 35669:a="4i"}1<g?(a+="v",p=t.global.def("["+Array.prototype.slice.call(p)+"]")):p=_(p)?Array.prototype.slice.call(p):p,n(h,".uniform",a,"(",d,",",p,");")}continue}v=m.append(t,n)}else{if(!s(Dt))continue;v=n.def(l.uniforms,"[",e.id(p),"]")}switch(35678===A?n("if(",v,"&&",v,'._reglType==="framebuffer"){',v,"=",v,".color[0];","}"):35680===A&&n("if(",v,"&&",v,'._reglType==="framebufferCube"){',v,"=",v,".color[0];","}"),p=1,A){case 35678:case 35680:A=n.def(v,"._texture"),n(h,".uniform1i(",d,",",A,".bind());"),n.exit(A,".unbind();");continue;case 5124:case 35670:a="1i";break;case 35667:case 35671:a="2i",p=2;break;case 35668:case 35672:a="3i",p=3;break;case 35669:case 35673:a="4i",p=4;break;case 5126:a="1f";break;case 35664:a="2f",p=2;break;case 35665:a="3f",p=3;break;case 35666:a="4f",p=4;break;case 35674:a="Matrix2fv";break;case 35675:a="Matrix3fv";break;case 35676:a="Matrix4fv"}if(-1===a.indexOf("Matrix")&&1<g&&(a+="v",p=1),"M"===a.charAt(0)){n(h,".uniform",a,"(",d,",");d=Math.pow(A-35674+2,2);var x=t.global.def("new Float32Array(",d,")");Array.isArray(v)?n("false,(",u(d,(function(t){return x+"["+t+"]="+v[t]})),",",x,")"):n("false,(Array.isArray(",v,")||",v," instanceof Float32Array)?",v,":(",u(d,(function(t){return x+"["+t+"]="+v+"["+t+"]"})),",",x,")"),n(");")}else{if(1<p){A=[];var b=[];for(g=0;g<p;++g)Array.isArray(v)?b.push(v[g]):b.push(n.def(v+"["+g+"]")),o&&A.push(n.def());o&&n("if(!",t.batchId,"||",A.map((function(t,e){return t+"!=="+b[e]})).join("||"),"){",A.map((function(t,e){return t+"="+b[e]+";"})).join("")),n(h,".uniform",a,"(",d,",",b.join(","),");")}else o&&(A=n.def(),n("if(!",t.batchId,"||",A,"!==",v,"){",A,"=",v,";")),n(h,".uniform",a,"(",d,",",v,");");o&&n("}")}}}function X(t,e,n,r){function i(i){var s=f[i];return s?s.contextDep&&r.contextDynamic||s.propDep?s.append(t,n):s.append(t,e):e.def(u,".",i)}function s(){function t(){n(l,".drawElementsInstancedANGLE(",[p,g,m,A+"<<(("+m+"-5121)>>1)",a],");")}function e(){n(l,".drawArraysInstancedANGLE(",[p,A,g,a],");")}d&&"null"!==d?y?t():(n("if(",d,"){"),t(),n("}else{"),e(),n("}")):e()}function o(){function t(){n(c+".drawElements("+[p,g,m,A+"<<(("+m+"-5121)>>1)"]+");")}function e(){n(c+".drawArrays("+[p,A,g]+");")}d&&"null"!==d?y?t():(n("if(",d,"){"),t(),n("}else{"),e(),n("}")):e()}var a,l,h=t.shared,c=h.gl,u=h.draw,f=r.draw,d=function(){var i=f.elements,s=e;return i?((i.contextDep&&r.contextDynamic||i.propDep)&&(s=n),i=i.append(t,s),f.elementsActive&&s("if("+i+")"+c+".bindBuffer(34963,"+i+".buffer.buffer);")):(i=s.def(),s(i,"=",u,".","elements",";","if(",i,"){",c,".bindBuffer(",34963,",",i,".buffer.buffer);}","else if(",h.vao,".currentVAO){",i,"=",t.shared.elements+".getElements("+h.vao,".currentVAO.elements);",ut?"":"if("+i+")"+c+".bindBuffer(34963,"+i+".buffer.buffer);","}")),i}(),p=i("primitive"),A=i("offset"),g=function(){var i=f.count,s=e;return i?((i.contextDep&&r.contextDynamic||i.propDep)&&(s=n),i=i.append(t,s)):i=s.def(u,".","count"),i}();if("number"===typeof g){if(0===g)return}else n("if(",g,"){"),n.exit("}");lt&&(a=i("instances"),l=t.instancing);var m=d+".type",y=f.elements&&V(f.elements)&&!f.vaoActive;lt&&("number"!==typeof a||0<=a)?"string"===typeof a?(n("if(",a,">0){"),s(),n("}else if(",a,"<0){"),o(),n("}")):s():o()}function Y(t,e,n,r,i){return e=v(),i=e.proc("body",i),lt&&(e.instancing=i.def(e.shared.extensions,".angle_instanced_arrays")),t(e,i,n,r),e.compile().body}function K(t,e,n,r){F(t,e),n.useVAO?n.drawVAO?e(t.shared.vao,".setVAO(",n.drawVAO.append(t,e),");"):e(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(e(t.shared.vao,".setVAO(null);"),z(t,e,n,r.attributes,(function(){return!0}))),W(t,e,n,r.uniforms,(function(){return!0}),!1),X(t,e,e,n)}function J(t,e){var n=t.proc("draw",1);F(t,n),k(t,n,e.context),R(t,n,e.framebuffer),N(t,n,e),D(t,n,e.state),L(t,n,e,!1,!0);var r=e.shader.progVar.append(t,n);if(n(t.shared.gl,".useProgram(",r,".program);"),e.shader.program)K(t,n,e,e.shader.program);else{n(t.shared.vao,".setVAO(null);");var i=t.global.def("{}"),s=n.def(r,".id"),o=n.def(i,"[",s,"]");n(t.cond(o).then(o,".call(this,a0);")["else"](o,"=",i,"[",s,"]=",t.link((function(n){return Y(K,t,e,n,1)})),"(",r,");",o,".call(this,a0);"))}0<Object.keys(e.state).length&&n(t.shared.current,".dirty=true;"),t.shared.vao&&n(t.shared.vao,".setVAO(null);")}function $(t,e,n,r){function i(){return!0}t.batchId="a1",F(t,e),z(t,e,n,r.attributes,i),W(t,e,n,r.uniforms,i,!1),X(t,e,e,n)}function tt(t,e,n,r){function i(t){return t.contextDep&&o||t.propDep}function s(t){return!i(t)}F(t,e);var o=n.contextDep,a=e.def(),l=e.def();t.shared.props=l,t.batchId=a;var h=t.scope(),c=t.scope();e(h.entry,"for(",a,"=0;",a,"<","a1",";++",a,"){",l,"=","a0","[",a,"];",c,"}",h.exit),n.needsContext&&k(t,c,n.context),n.needsFramebuffer&&R(t,c,n.framebuffer),D(t,c,n.state,i),n.profile&&i(n.profile)&&L(t,c,n,!1,!0),r?(n.useVAO?n.drawVAO?i(n.drawVAO)?c(t.shared.vao,".setVAO(",n.drawVAO.append(t,c),");"):h(t.shared.vao,".setVAO(",n.drawVAO.append(t,h),");"):h(t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"):(h(t.shared.vao,".setVAO(null);"),z(t,h,n,r.attributes,s),z(t,c,n,r.attributes,i)),W(t,h,n,r.uniforms,s,!1),W(t,c,n,r.uniforms,i,!0),X(t,h,c,n)):(e=t.global.def("{}"),r=n.shader.progVar.append(t,c),l=c.def(r,".id"),h=c.def(e,"[",l,"]"),c(t.shared.gl,".useProgram(",r,".program);","if(!",h,"){",h,"=",e,"[",l,"]=",t.link((function(e){return Y($,t,n,e,2)})),"(",r,");}",h,".call(this,a0[",a,"],",a,");"))}function et(t,e){function n(t){return t.contextDep&&i||t.propDep}var r=t.proc("batch",2);t.batchId="0",F(t,r);var i=!1,s=!0;Object.keys(e.context).forEach((function(t){i=i||e.context[t].propDep})),i||(k(t,r,e.context),s=!1);var o=e.framebuffer,a=!1;if(o?(o.propDep?i=a=!0:o.contextDep&&i&&(a=!0),a||R(t,r,o)):R(t,r,null),e.state.viewport&&e.state.viewport.propDep&&(i=!0),N(t,r,e),D(t,r,e.state,(function(t){return!n(t)})),e.profile&&n(e.profile)||L(t,r,e,!1,"a1"),e.contextDep=i,e.needsContext=s,e.needsFramebuffer=a,s=e.shader.progVar,s.contextDep&&i||s.propDep)tt(t,r,e,null);else if(s=s.append(t,r),r(t.shared.gl,".useProgram(",s,".program);"),e.shader.program)tt(t,r,e,e.shader.program);else{r(t.shared.vao,".setVAO(null);");o=t.global.def("{}"),a=r.def(s,".id");var l=r.def(o,"[",a,"]");r(t.cond(l).then(l,".call(this,a0,a1);")["else"](l,"=",o,"[",a,"]=",t.link((function(n){return Y(tt,t,e,n,2)})),"(",s,");",l,".call(this,a0,a1);"))}0<Object.keys(e.state).length&&r(t.shared.current,".dirty=true;"),t.shared.vao&&r(t.shared.vao,".setVAO(null);")}function nt(t,n){function r(e){var r=n.shader[e];r&&i.set(s.shader,"."+e,r.append(t,i))}var i=t.proc("scope",3);t.batchId="a2";var s=t.shared,o=s.current;k(t,i,n.context),n.framebuffer&&n.framebuffer.append(t,i),U(Object.keys(n.state)).forEach((function(e){var r=n.state[e].append(t,i);_(r)?r.forEach((function(n,r){i.set(t.next[e],"["+r+"]",n)})):i.set(s.next,"."+e,r)})),L(t,i,n,!0,!0),["elements","offset","count","instances","primitive"].forEach((function(e){var r=n.draw[e];r&&i.set(s.draw,"."+e,""+r.append(t,i))})),Object.keys(n.uniforms).forEach((function(r){var o=n.uniforms[r].append(t,i);Array.isArray(o)&&(o="["+o.join()+"]"),i.set(s.uniforms,"["+e.id(r)+"]",o)})),Object.keys(n.attributes).forEach((function(e){var r=n.attributes[e].append(t,i),s=t.scopeAttrib(e);Object.keys(new ot).forEach((function(t){i.set(s,"."+t,r[t])}))})),n.scopeVAO&&i.set(s.vao,".targetVAO",n.scopeVAO.append(t,i)),r("vert"),r("frag"),0<Object.keys(n.state).length&&(i(o,".dirty=true;"),i.exit(o,".dirty=true;")),i("a1(",t.shared.context,",a0,",t.batchId,");")}function rt(t){if("object"===typeof t&&!_(t)){for(var e=Object.keys(t),n=0;n<e.length;++n)if(Z.isDynamic(t[e[n]]))return!0;return!1}}function it(t,e,n){function r(t,e){o.forEach((function(n){var r=i[n];Z.isDynamic(r)&&(r=t.invoke(e,r),e(c,".",n,"=",r,";"))}))}var i=e["static"][n];if(i&&rt(i)){var s=t.global,o=Object.keys(i),a=!1,l=!1,h=!1,c=t.global.def("{}");o.forEach((function(e){var n=i[e];if(Z.isDynamic(n))"function"===typeof n&&(n=i[e]=Z.unbox(n)),e=q(n,null),a=a||e.thisDep,h=h||e.propDep,l=l||e.contextDep;else{switch(s(c,".",e,"="),typeof n){case"number":s(n);break;case"string":s('"',n,'"');break;case"object":Array.isArray(n)&&s("[",n.join(),"]");break;default:s(t.link(n))}s(";")}})),e.dynamic[n]=new Z.DynamicVariable(4,{thisDep:a,contextDep:l,propDep:h,ref:c,append:r}),delete e["static"][n]}}var ot=h.Record,at={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(at.min=32775,at.max=32776);var lt=n.angle_instanced_arrays,ht=n.webgl_draw_buffers,ut=n.oes_vertex_array_object,ft={dirty:!0,profile:A.profile},dt={},pt=[],At={},gt={};m("dither",3024),m("blend.enable",3042),y("blend.color","blendColor",[0,0,0,0]),y("blend.equation","blendEquationSeparate",[32774,32774]),y("blend.func","blendFuncSeparate",[1,0,1,0]),m("depth.enable",2929,!0),y("depth.func","depthFunc",513),y("depth.range","depthRange",[0,1]),y("depth.mask","depthMask",!0),y("colorMask","colorMask",[!0,!0,!0,!0]),m("cull.enable",2884),y("cull.face","cullFace",1029),y("frontFace","frontFace",2305),y("lineWidth","lineWidth",1),m("polygonOffset.enable",32823),y("polygonOffset.offset","polygonOffset",[0,0]),m("sample.alpha",32926),m("sample.enable",32928),y("sample.coverage","sampleCoverage",[1,!1]),m("stencil.enable",2960),y("stencil.mask","stencilMask",-1),y("stencil.func","stencilFunc",[519,0,-1]),y("stencil.opFront","stencilOpSeparate",[1028,7680,7680,7680]),y("stencil.opBack","stencilOpSeparate",[1029,7680,7680,7680]),m("scissor.enable",3089),y("scissor.box","scissor",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]),y("viewport","viewport",[0,0,t.drawingBufferWidth,t.drawingBufferHeight]);var mt={gl:t,context:d,strings:e,next:dt,current:ft,draw:f,elements:s,buffer:i,shader:c,attributes:h.state,vao:h,uniforms:l,framebuffer:a,extensions:n,timer:p,isBufferArgs:H},yt={primTypes:ct,compareFuncs:kt,blendFuncs:Pt,blendEquations:at,stencilOps:Rt,glTypes:st,orientationType:Nt};ht&&(yt.backBuffer=[1029],yt.drawBuffer=u(r.maxDrawbuffers,(function(t){return 0===t?[0]:u(t,(function(t){return 36064+t}))})));var vt=0;return{next:dt,current:ft,procs:function(){var t=v(),e=t.proc("poll"),i=t.proc("refresh"),s=t.block();e(s),i(s);var o,a=t.shared,l=a.gl,h=a.next,c=a.current;s(c,".dirty=false;"),R(t,e),R(t,i,null,!0),lt&&(o=t.link(lt)),n.oes_vertex_array_object&&i(t.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var f=0;f<r.maxAttributes;++f){var d=i.def(a.attributes,"[",f,"]"),p=t.cond(d,".buffer");p.then(l,".enableVertexAttribArray(",f,");",l,".bindBuffer(",34962,",",d,".buffer.buffer);",l,".vertexAttribPointer(",f,",",d,".size,",d,".type,",d,".normalized,",d,".stride,",d,".offset);")["else"](l,".disableVertexAttribArray(",f,");",l,".vertexAttrib4f(",f,",",d,".x,",d,".y,",d,".z,",d,".w);",d,".buffer=null;"),i(p),lt&&i(o,".vertexAttribDivisorANGLE(",f,",",d,".divisor);")}return i(t.shared.vao,".currentVAO=null;",t.shared.vao,".setVAO(",t.shared.vao,".targetVAO);"),Object.keys(At).forEach((function(n){var r=At[n],o=s.def(h,".",n),a=t.block();a("if(",o,"){",l,".enable(",r,")}else{",l,".disable(",r,")}",c,".",n,"=",o,";"),i(a),e("if(",o,"!==",c,".",n,"){",a,"}")})),Object.keys(gt).forEach((function(n){var r,o,a=gt[n],f=ft[n],d=t.block();d(l,".",a,"("),_(f)?(a=f.length,r=t.global.def(h,".",n),o=t.global.def(c,".",n),d(u(a,(function(t){return r+"["+t+"]"})),");",u(a,(function(t){return o+"["+t+"]="+r+"["+t+"];"})).join("")),e("if(",u(a,(function(t){return r+"["+t+"]!=="+o+"["+t+"]"})).join("||"),"){",d,"}")):(r=s.def(h,".",n),o=s.def(c,".",n),d(r,");",c,".",n,"=",r,";"),e("if(",r,"!==",o,"){",d,"}")),i(d)})),t.compile()}(),compile:function(t,e,n,r,i){var s=v();s.stats=s.link(i),Object.keys(e["static"]).forEach((function(t){it(s,e,t)})),Et.forEach((function(e){it(s,t,e)}));var o=P(t,e,n,r,s);return J(s,o),nt(s,o),et(s,o),Q(s.compile(),{destroy:function(){o.shader.program.destroy()}})}}}function X(t,e){for(var n=0;n<t.length;++n)if(t[n]===e)return n;return-1}var Q=function(t,e){for(var n=Object.keys(e),r=0;r<n.length;++r)t[n[r]]=e[n[r]];return t},Y=0,Z={DynamicVariable:t,define:function(e,r){return new t(e,n(r+""))},isDynamic:function(e){return"function"===typeof e&&!e._reglType||e instanceof t},unbox:r,accessor:n},K={next:"function"===typeof requestAnimationFrame?function(t){return requestAnimationFrame(t)}:function(t){return setTimeout(t,16)},cancel:"function"===typeof cancelAnimationFrame?function(t){return cancelAnimationFrame(t)}:clearTimeout},J="undefined"!==typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date},$=d();$.zero=d();var tt=function(t,e){var n=1;e.ext_texture_filter_anisotropic&&(n=t.getParameter(34047));var r=1,i=1;e.webgl_draw_buffers&&(r=t.getParameter(34852),i=t.getParameter(36063));var s=!!e.oes_texture_float;if(s){s=t.createTexture(),t.bindTexture(3553,s),t.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var o=t.createFramebuffer();if(t.bindFramebuffer(36160,o),t.framebufferTexture2D(36160,36064,3553,s,0),t.bindTexture(3553,null),36053!==t.checkFramebufferStatus(36160))s=!1;else{t.viewport(0,0,1,1),t.clearColor(1,0,0,1),t.clear(16384);var a=$.allocType(5126,4);t.readPixels(0,0,1,1,6408,5126,a),t.getError()?s=!1:(t.deleteFramebuffer(o),t.deleteTexture(s),s=1===a[0]),$.freeType(a)}}return a=!0,"undefined"!==typeof navigator&&(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))||(a=t.createTexture(),o=$.allocType(5121,36),t.activeTexture(33984),t.bindTexture(34067,a),t.texImage2D(34069,0,6408,3,3,0,6408,5121,o),$.freeType(o),t.bindTexture(34067,null),t.deleteTexture(a),a=!t.getError()),{colorBits:[t.getParameter(3410),t.getParameter(3411),t.getParameter(3412),t.getParameter(3413)],depthBits:t.getParameter(3414),stencilBits:t.getParameter(3415),subpixelBits:t.getParameter(3408),extensions:Object.keys(e).filter((function(t){return!!e[t]})),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:t.getParameter(33901),lineWidthDims:t.getParameter(33902),maxViewportDims:t.getParameter(3386),maxCombinedTextureUnits:t.getParameter(35661),maxCubeMapSize:t.getParameter(34076),maxRenderbufferSize:t.getParameter(34024),maxTextureUnits:t.getParameter(34930),maxTextureSize:t.getParameter(3379),maxAttributes:t.getParameter(34921),maxVertexUniforms:t.getParameter(36347),maxVertexTextureUnits:t.getParameter(35660),maxVaryingVectors:t.getParameter(36348),maxFragmentUniforms:t.getParameter(36349),glsl:t.getParameter(35724),renderer:t.getParameter(7937),vendor:t.getParameter(7936),version:t.getParameter(7938),readFloat:s,npotTextureCube:a}},et=function(t){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Float32Array||t instanceof Float64Array||t instanceof Uint8ClampedArray},nt=function(t){return Object.keys(t).map((function(e){return t[e]}))},rt={shape:function(t){for(var e=[];t.length;t=t[0])e.push(t.length);return e},flatten:function(t,e,n,r){var i=1;if(e.length)for(var s=0;s<e.length;++s)i*=e[s];else i=0;switch(n=r||$.allocType(n,i),e.length){case 0:break;case 1:for(r=e[0],e=0;e<r;++e)n[e]=t[e];break;case 2:for(r=e[0],e=e[1],s=i=0;s<r;++s)for(var o=t[s],a=0;a<e;++a)n[i++]=o[a];break;case 3:A(t,e[0],e[1],e[2],n,0);break;default:g(t,e,0,n,0)}return n}},it={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},st={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},ot={dynamic:35048,stream:35040,static:35044},at=rt.flatten,lt=rt.shape,ht=[];ht[5120]=1,ht[5122]=2,ht[5124]=4,ht[5121]=1,ht[5123]=2,ht[5125]=4,ht[5126]=4;var ct={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},ut=new Float32Array(1),ft=new Uint32Array(ut.buffer),dt=[9984,9986,9985,9987],pt=[0,6409,6410,6407,6408],At={};At[6409]=At[6406]=At[6402]=1,At[34041]=At[6410]=2,At[6407]=At[35904]=3,At[6408]=At[35906]=4;var gt=M("HTMLCanvasElement"),mt=M("OffscreenCanvas"),yt=M("CanvasRenderingContext2D"),vt=M("ImageBitmap"),xt=M("HTMLImageElement"),bt=M("HTMLVideoElement"),wt=Object.keys(it).concat([gt,mt,yt,vt,xt,bt]),_t=[];_t[5121]=1,_t[5126]=4,_t[36193]=2,_t[5123]=2,_t[5125]=4;var Mt=[];Mt[32854]=2,Mt[32855]=2,Mt[36194]=2,Mt[34041]=4,Mt[33776]=.5,Mt[33777]=.5,Mt[33778]=1,Mt[33779]=1,Mt[35986]=.5,Mt[35987]=1,Mt[34798]=1,Mt[35840]=.5,Mt[35841]=.25,Mt[35842]=.5,Mt[35843]=.25,Mt[36196]=.5;var Tt=[];Tt[32854]=2,Tt[32855]=2,Tt[36194]=2,Tt[33189]=2,Tt[36168]=1,Tt[34041]=4,Tt[35056]=4,Tt[35907]=4,Tt[34836]=16,Tt[34842]=8,Tt[34843]=6;var St=function(t,e,n,r,i){function s(t){this.id=h++,this.refCount=1,this.renderbuffer=t,this.format=32854,this.height=this.width=0,i.profile&&(this.stats={size:0})}function o(e){var n=e.renderbuffer;t.bindRenderbuffer(36161,null),t.deleteRenderbuffer(n),e.renderbuffer=null,e.refCount=0,delete c[e.id],r.renderbufferCount--}var a={rgba4:32854,rgba8:32856,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041,"depth24 stencil8":35056};e.ext_srgb&&(a.srgba=35907),e.ext_color_buffer_half_float&&(a.rgba16f=34842,a.rgb16f=34843),e.webgl_color_buffer_float&&(a.rgba32f=34836);var l=[];Object.keys(a).forEach((function(t){l[a[t]]=t}));var h=0,c={};return s.prototype.decRef=function(){0>=--this.refCount&&o(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var t=0;return Object.keys(c).forEach((function(e){t+=c[e].stats.size})),t}),{create:function(e,n){function o(e,n){var r=0,s=0,c=32854,u=0;if("object"===typeof e&&e?("shape"in e?(s=e.shape,r=0|s[0],s=0|s[1]):("radius"in e&&(r=s=0|e.radius),"width"in e&&(r=0|e.width),"height"in e&&(s=0|e.height)),"format"in e&&(c=a[e.format]),"samples"in e&&(u=e.samples)):"number"===typeof e?(r=0|e,s="number"===typeof n?0|n:r):e||(r=s=1),r!==h.width||s!==h.height||c!==h.format)return o.width=h.width=r,o.height=h.height=s,o.samples=u,h.format=c,h.samples=u,t.bindRenderbuffer(36161,h.renderbuffer),u&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,u,c,r,s):t.renderbufferStorage(36161,c,r,s),i.profile&&(h.stats.size=Tt[h.format]*h.width*h.height),o.format=l[h.format],o}var h=new s(t.createRenderbuffer());return c[h.id]=h,r.renderbufferCount++,o(e,n),o.resize=function(e,n){var r=0|e,s=0|n||r;if(r===h.width&&s===h.height)return o;o.width=h.width=r,o.height=h.height=s;var a=o.samples;return t.bindRenderbuffer(36161,h.renderbuffer),a&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,a,h.format,r,s):t.renderbufferStorage(36161,h.format,r,s),i.profile&&(h.stats.size=Tt[h.format]*h.width*h.height),o},o._reglType="renderbuffer",o._renderbuffer=h,i.profile&&(o.stats=h.stats),o.destroy=function(){h.decRef()},o},clear:function(){nt(c).forEach(o)},restore:function(){nt(c).forEach((function(e){e.renderbuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,e.renderbuffer),e.samples&&t.renderbufferStorageMultisample?t.renderbufferStorageMultisample(36161,e.samples,e.format,e.width,e.height):t.renderbufferStorage(36161,e.format,e.width,e.height)})),t.bindRenderbuffer(36161,null)}}},It=[];It[6408]=4,It[6407]=3;var Ct=[];Ct[5121]=1,Ct[5126]=4,Ct[36193]=2;var Ot=["x","y","z","w"],Et="blend.func blend.equation stencil.func stencil.opFront stencil.opBack sample.coverage viewport scissor.box polygonOffset.offset".split(" "),Pt={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},kt={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},Rt={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Nt={cw:2304,ccw:2305},Dt=new j(!1,!1,!1,(function(){})),Ft=function(t,e){function n(){this.endQueryIndex=this.startQueryIndex=-1,this.sum=0,this.stats=null}function r(t,e,r){var i=o.pop()||new n;i.startQueryIndex=t,i.endQueryIndex=e,i.sum=0,i.stats=r,a.push(i)}if(!e.ext_disjoint_timer_query)return null;var i=[],s=[],o=[],a=[],l=[],h=[];return{beginQuery:function(t){var n=i.pop()||e.ext_disjoint_timer_query.createQueryEXT();e.ext_disjoint_timer_query.beginQueryEXT(35007,n),s.push(n),r(s.length-1,s.length,t)},endQuery:function(){e.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:r,update:function(){var t,n;if(t=s.length,0!==t){h.length=Math.max(h.length,t+1),l.length=Math.max(l.length,t+1),l[0]=0;var r=h[0]=0;for(n=t=0;n<s.length;++n){var c=s[n];e.ext_disjoint_timer_query.getQueryObjectEXT(c,34919)?(r+=e.ext_disjoint_timer_query.getQueryObjectEXT(c,34918),i.push(c)):s[t++]=c,l[n+1]=r,h[n+1]=t}for(s.length=t,n=t=0;n<a.length;++n){r=a[n];var u=r.startQueryIndex;c=r.endQueryIndex;r.sum+=l[c]-l[u],u=h[u],c=h[c],c===u?(r.stats.gpuTime+=r.sum/1e6,o.push(r)):(r.startQueryIndex=u,r.endQueryIndex=c,a[t++]=r)}a.length=t}},getNumPendingQueries:function(){return s.length},clear:function(){i.push.apply(i,s);for(var t=0;t<i.length;t++)e.ext_disjoint_timer_query.deleteQueryEXT(i[t]);s.length=0,i.length=0},restore:function(){s.length=0,i.length=0}}};return function(t){function e(){if(0===q.length)M&&M.update(),nt=null;else{nt=K.next(e),d();for(var t=q.length-1;0<=t;--t){var n=q[t];n&&n(C,null,0)}g.flush(),M&&M.update()}}function n(){!nt&&0<q.length&&(nt=K.next(e))}function r(){nt&&(K.cancel(e),nt=null)}function s(t){t.preventDefault(),r(),Y.forEach((function(t){t()}))}function o(t){g.getError(),y.restore(),z.restore(),E.restore(),B.restore(),H.restore(),U.restore(),L.restore(),M&&M.restore(),j.procs.refresh(),n(),$.forEach((function(t){t()}))}function a(t){function e(t,e){var n={},r={};return Object.keys(t).forEach((function(i){var s=t[i];if(Z.isDynamic(s))r[i]=Z.unbox(s,i);else{if(e&&Array.isArray(s))for(var o=0;o<s.length;++o)if(Z.isDynamic(s[o]))return void(r[i]=Z.unbox(s,i));n[i]=s}})),{dynamic:r,static:n}}function n(t){for(;u.length<t;)u.push(null);return u}var r=e(t.context||{},!0),i=e(t.uniforms||{},!0),s=e(t.attributes||{},!1);t=e(function(t){function e(t){if(t in n){var e=n[t];delete n[t],Object.keys(e).forEach((function(r){n[t+"."+r]=e[r]}))}}var n=Q({},t);return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),e("blend"),e("depth"),e("cull"),e("stencil"),e("polygonOffset"),e("scissor"),e("sample"),"vao"in t&&(n.vao=t.vao),n}(t),!1);var o={gpuTime:0,cpuTime:0,count:0},a=j.compile(t,s,i,r,o),l=a.draw,h=a.batch,c=a.scope,u=[];return Q((function(t,e){var r;if("function"===typeof t)return c.call(this,null,t,0);if("function"===typeof e)if("number"===typeof t)for(r=0;r<t;++r)c.call(this,null,e,r);else{if(!Array.isArray(t))return c.call(this,t,e,0);for(r=0;r<t.length;++r)c.call(this,t[r],e,r)}else if("number"===typeof t){if(0<t)return h.call(this,n(0|t),0|t)}else{if(!Array.isArray(t))return l.call(this,t);if(t.length)return h.call(this,t,t.length)}}),{stats:o,destroy:function(){a.destroy()}})}function l(t,e){var n=0;j.procs.poll();var r=e.color;r&&(g.clearColor(+r[0]||0,+r[1]||0,+r[2]||0,+r[3]||0),n|=16384),"depth"in e&&(g.clearDepth(+e.depth),n|=256),"stencil"in e&&(g.clearStencil(0|e.stencil),n|=1024),g.clear(n)}function u(t){return q.push(t),n(),{cancel:function(){function e(){var t=X(q,e);q[t]=q[q.length-1],--q.length,0>=q.length&&r()}var n=X(q,t);q[n]=e}}}function f(){var t=V.viewport,e=V.scissor_box;t[0]=t[1]=e[0]=e[1]=0,C.viewportWidth=C.framebufferWidth=C.drawingBufferWidth=t[2]=e[2]=g.drawingBufferWidth,C.viewportHeight=C.framebufferHeight=C.drawingBufferHeight=t[3]=e[3]=g.drawingBufferHeight}function d(){C.tick+=1,C.time=A(),f(),j.procs.poll()}function p(){B.refresh(),f(),j.procs.refresh(),M&&M.update()}function A(){return(J()-T)/1e3}if(t=h(t),!t)return null;var g=t.gl,m=g.getContextAttributes();g.isContextLost();var y=c(g,t);if(!y)return null;var v=i(),w={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},_=y.extensions,M=Ft(g,_),T=J(),S=g.drawingBufferWidth,I=g.drawingBufferHeight,C={tick:0,time:0,viewportWidth:S,viewportHeight:I,framebufferWidth:S,framebufferHeight:I,drawingBufferWidth:S,drawingBufferHeight:I,pixelRatio:t.pixelRatio},O=(S={elements:null,primitive:4,count:-1,offset:0,instances:-1},tt(g,_)),E=x(g,w,t,(function(t){return L.destroyBuffer(t)})),R=b(g,_,E,w),L=N(g,_,O,w,E,R,S),z=D(g,v,w,t),B=P(g,_,O,(function(){j.procs.poll()}),C,w,t),H=St(g,_,O,w,t),U=k(g,_,O,B,H,w),j=W(g,v,_,O,E,R,B,U,{},L,z,S,C,M,t),V=(v=F(g,U,j.procs.poll,C,m,_,O),j.next),G=g.canvas,q=[],Y=[],$=[],et=[t.onDestroy],nt=null;G&&(G.addEventListener("webglcontextlost",s,!1),G.addEventListener("webglcontextrestored",o,!1));var rt=U.setFBO=a({framebuffer:Z.define.call(null,1,"framebuffer")});return p(),m=Q(a,{clear:function(t){if("framebuffer"in t)if(t.framebuffer&&"framebufferCube"===t.framebuffer_reglType)for(var e=0;6>e;++e)rt(Q({framebuffer:t.framebuffer.faces[e]},t),l);else rt(t,l);else l(null,t)},prop:Z.define.bind(null,1),context:Z.define.bind(null,2),this:Z.define.bind(null,3),draw:a({}),buffer:function(t){return E.create(t,34962,!1,!1)},elements:function(t){return R.create(t,!1)},texture:B.create2D,cube:B.createCube,renderbuffer:H.create,framebuffer:U.create,framebufferCube:U.createCube,vao:L.createVAO,attributes:m,frame:u,on:function(t,e){var n;switch(t){case"frame":return u(e);case"lost":n=Y;break;case"restore":n=$;break;case"destroy":n=et}return n.push(e),{cancel:function(){for(var t=0;t<n.length;++t)if(n[t]===e){n[t]=n[n.length-1],n.pop();break}}}},limits:O,hasExtension:function(t){return 0<=O.extensions.indexOf(t.toLowerCase())},read:v,destroy:function(){q.length=0,r(),G&&(G.removeEventListener("webglcontextlost",s),G.removeEventListener("webglcontextrestored",o)),z.clear(),U.clear(),H.clear(),L.clear(),B.clear(),R.clear(),E.clear(),M&&M.clear(),et.forEach((function(t){t()}))},_gl:g,_refresh:p,poll:function(){d(),M&&M.update()},now:A,stats:w,blit:U.blit}),t.onDone(null,m),m}}))},"4f4d":function(t,e,n){"use strict";t.exports={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]}},5765:function(t,e,n){"use strict";n.d(e,"a",(function(){return Cs}));var r=n("18b7"),i=n("5a89");const s=parseInt(i["REVISION"].replace("dev",""));function o(t,e,n){return s>109?t.setAttribute(e,n):t.addAttribute(e,n),t}function a(t,e){s>113?t.params.Line.threshold=e:t.linePrecision=e}function l(){const t=i;return t}function h(t){return t["VertexColors"]?t["VertexColors"]:2}function c(){return h(l())}function u(t,e,n){const r=l();return r.BoxBufferGeometry?new r.BoxBufferGeometry(t,e,n):r.BoxGeometry?new r.BoxGeometry(t,e,n):void 0}console.log("maptalks.three log: current three.js version is %c"+s,"color:red;font-size: 16px;font-weight: bold;");class f extends i["InstancedBufferGeometry"]{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";var t=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],e=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],n=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(n),o(this,"position",new i["Float32BufferAttribute"](t,3)),o(this,"uv",new i["Float32BufferAttribute"](e,2))}applyMatrix(t){var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(t.applyToBufferAttribute(e),t.applyToBufferAttribute(n),e.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new i["InstancedInterleavedBuffer"](e,6,1);return o(this,"instanceStart",new i["InterleavedBufferAttribute"](n,3,0)),o(this,"instanceEnd",new i["InterleavedBufferAttribute"](n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){var e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));var n=new i["InstancedInterleavedBuffer"](e,6,1);return o(this,"instanceColorStart",new i["InterleavedBufferAttribute"](n,3,0)),o(this,"instanceColorEnd",new i["InterleavedBufferAttribute"](n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new i["WireframeGeometry"](t.geometry)),this}fromLineSegements(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}computeBoundingBox(){var t=new i["Box3"];null===this.boundingBox&&(this.boundingBox=new i["Box3"]);var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;void 0!==e&&void 0!==n&&(this.boundingBox.setFromBufferAttribute(e),t.setFromBufferAttribute(n),this.boundingBox.union(t))}computeBoundingSphere(){var t=new i["Vector3"];null===this.boundingSphere&&(this.boundingSphere=new i["Sphere"]),null===this.boundingBox&&this.computeBoundingBox();var e=this.attributes.instanceStart,n=this.attributes.instanceEnd;if(void 0!==e&&void 0!==n){var r=this.boundingSphere.center;this.boundingBox.getCenter(r);for(var s=0,o=0,a=e.count;o<a;o++)t.fromBufferAttribute(e,o),s=Math.max(s,r.distanceToSquared(t)),t.fromBufferAttribute(n,o),s=Math.max(s,r.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}copy(t){return this}}var d=f;const p={},A={};p.line={linewidth:{value:1},resolution:{value:new i["Vector2"](1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},A["line"]={uniforms:i["UniformsUtils"].merge([i["UniformsLib"].common,i["UniformsLib"].fog,p.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\tfloat a = vUv.x;\n\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"};class g extends i["ShaderMaterial"]{constructor(t){super({uniforms:i["UniformsUtils"].clone(A["line"].uniforms),vertexShader:A["line"].vertexShader,fragmentShader:A["line"].fragmentShader}),this.dashed=!0,this.isLineMaterial=!0,this.type="LineMaterial",Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}}}),this.setValues(t)}}var m=g;class y extends i["Mesh"]{constructor(t,e){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2",this.geometry=void 0!==t?t:new d,this.material=void 0!==e?e:new m({color:16777215*Math.random()})}computeLineDistances(){var t=new i["Vector3"],e=new i["Vector3"],n=this.geometry,r=n.attributes.instanceStart,s=n.attributes.instanceEnd;if(!r||!s)return this;for(var a=new Float32Array(2*r.data.count),l=0,h=0,c=r.data.count;l<c;l++,h+=2)t.fromBufferAttribute(r,l),e.fromBufferAttribute(s,l),a[h]=0===h?0:a[h-1],a[h+1]=a[h]+t.distanceTo(e);var u=new i["InstancedInterleavedBuffer"](a,2,1);return o(n,"instanceDistanceStart",new i["InterleavedBufferAttribute"](u,1,0)),o(n,"instanceDistanceEnd",new i["InterleavedBufferAttribute"](u,1,1)),this}}var v=y;class x extends d{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}fromLine(t){var e=t.geometry;return e.isGeometry?this.setPositions(e.vertices):e.isBufferGeometry&&this.setPositions(e.position.array),this}}var b=x;class w extends v{constructor(t,e){super(t,e),this.isLine2=!0,this.type="Line2",this.geometry=void 0!==t?t:new b,this.material=void 0!==e?e:new m({color:16777215*Math.random()})}copy(t){return this}}var _=w;const M={interactive:!0,altitude:0,minZoom:0,maxZoom:30,asynchronous:!1,bloom:!1,pickWeight:-1};function T(){}class S extends(r["j"](T)){constructor(t){super(),this.isAdd=!1,this._mouseover=!1,this._visible=!0,this._zoomVisible=!0,this.picked=!1,this.isBaseObject=!0,void 0===t&&(t=r["I"].GUID()),this.id=t}addTo(t){return t&&"ThreeLayer"===t.type?t.addMesh([this]):console.error("layer only support maptalks.ThreeLayer"),this}remove(){const t=this.getLayer();return t&&t.removeMesh([this]),this}getObject3d(){return this.object3d}getId(){return this.id}setId(t){const e=this.getId();return this.id=t,this._fire("idchange",{old:e,new:t,target:this}),this}getType(){return this.type}getOptions(){return this.options}getProperties(){return(this.options||{}).properties}setProperties(t){const e=Object.assign({},this.getProperties());return this.options.properties=t,this._fire("propertieschange",{old:e,new:t,target:this}),this}getLayer(){return this.options.layer}getMap(){const t=this.getLayer();if(t)return t.getMap()}getCenter(){const t=this.getOptions(),{coordinate:e,lineString:n,polygon:i}=t;if(e)return e instanceof r["f"]?e:new r["f"](e);{const t=i||n;if(t&&t.getCenter)return t.getCenter()}}getAltitude(){return this.getOptions().altitude}setAltitude(t){if(r["I"].isNumber(t)){const e=this.getLayer().altitudeToVector3(t,t).x;if(this.getObject3d().position.z=e,this.options.altitude=t,this.pickObject3d&&(this.pickObject3d.position.z=e),this._baseObjects&&Array.isArray(this._baseObjects))for(let t=0,n=this._baseObjects.length;t<n;t++)this._baseObjects[t]&&(this._baseObjects[t].getObject3d().position.z=e)}return this}supportHeight(){return this.getOptions().heightEnable}getHeight(){const{height:t}=this.getOptions();return r["I"].isNumber(t)?t:0}setHeight(t){if(!r["I"].isNumber(t)||this._baseObjects||!this.supportHeight())return this;const e=this.getLayer();if(!e)return this;const{geometry:n}=this.getObject3d();if(n instanceof i["BufferGeometry"]){const{position:r}=n.attributes||{};if(!r)return this;const i=r.array;let s=1/0,o=-1/0;for(let t=0,e=i.length;t<e;t+=3){const e=i[t+2];s=Math.min(e,s),o=Math.max(e,o)}const a=(s+o)/2;let l=e.altitudeToVector3(t,t).x;l=Math.max(l,1e-6);for(let t=0,e=i.length;t<e;t+=3)i[t+2]>a&&(i[t+2]=l);n.attributes.position.needsUpdate=!0,n.computeBoundingBox(),n.computeBoundingSphere(),this.getOptions().height=t}return this}show(){return this._zoomVisible&&(this.getObject3d().visible=!0,this._fire("show")),this._visible=!0,this}hide(){return this.getObject3d().visible=!1,this._fire("hide"),this._visible=!1,this._hideUI(),this}isVisible(){return!!this.getObject3d().visible}getSymbol(){return this.getObject3d().material}setSymbol(t){if(t&&t instanceof i["Material"]){t.needsUpdate=!0,t.vertexColors=this.getObject3d().material.vertexColors;const e=this.getObject3d().material.clone();this.getObject3d().material=t,this._fire("symbolchange",{old:e,new:t,target:this})}return this}setInfoWindow(t){return this.removeInfoWindow(),this.infoWindow=new r["Q"].InfoWindow(t),this.infoWindow.addTo(this),this}getInfoWindow(){return this.infoWindow}openInfoWindow(t){return t=t||this.getCenter(),t instanceof r["f"]||(t=new r["f"](t)),t&&this.infoWindow&&this.infoWindow.show(t),this}closeInfoWindow(){return this.infoWindow&&this.infoWindow.hide(),this}removeInfoWindow(){return this.infoWindow&&(this.infoWindow.remove(),delete this.infoWindow),this}setToolTip(t,e){return this.removeToolTip(),this.toolTip=new r["Q"].ToolTip(t,e),this.toolTip.addTo(this),this}getToolTip(){return this.toolTip}openToolTip(t){return this}closeToolTip(){return this.toolTip&&this.toolTip.hide(),this}removeToolTip(){return this.toolTip&&(this.toolTip.remove(),delete this.toolTip),this}_hideUI(){return this.closeInfoWindow(),this.closeToolTip(),this}animateShow(t={},e){this._showPlayer&&this._showPlayer.cancel(),r["I"].isFunction(t)&&(t={},e=t);const n=t["duration"]||1e3,i=t["easing"]||"out",s=this._showPlayer=r["K"].Animation.animate({scale:1},{duration:n,easing:i},t=>{const n=t.styles.scale;n>0&&(this.getObject3d().scale.z=n),e&&e(t,n)});return s.play(),s}getMinZoom(){return this.getOptions().minZoom}getMaxZoom(){return this.getOptions().maxZoom}isAsynchronous(){return this.getOptions().asynchronous}get bloom(){return this.getOptions().bloom}fire(t,e){return this._fire(t,e),this._vt&&this._vt.onSelectMesh&&this._vt.onSelectMesh(t,e),this}config(){return this}setPickObject3d(t){return this.pickObject3d=t,this.pickObject3d["__parent"]=this,this}getPickObject3d(){return this.pickObject3d}_initOptions(t){return this.options=r["I"].extend({},M,t),this}_createMesh(t,e){return this.object3d=new i["Mesh"](t,e),this.object3d["__parent"]=this,this}_createInstancedMesh(t,e,n){return this.object3d=new i["InstancedMesh"](t,e,n),this.object3d["__parent"]=this,this}_createGroup(){return this.object3d=new i["Group"],this.object3d["__parent"]=this,this}_createLine(t,e){return this.object3d=new i["Line"](t,e),this._computeLineDistances(t),this.object3d["__parent"]=this,this}_createLine2(t,e){return this.object3d=new _(t,e),this.object3d.computeLineDistances(),this.object3d["__parent"]=this,this}_createPoints(t,e){return this.object3d=new i["Points"](t,e),this.object3d["__parent"]=this,this}_createLineSegments(t,e){return this.object3d=new i["LineSegments"](t,e),this._computeLineDistances(t),this.object3d["__parent"]=this,this}_computeLineDistances(t){const e=t.attributes.position.array,n=t.attributes.position.count,r=new Float32Array(n);r[0]=0;const s=new i["Vector3"](0,0,0),a=new i["Vector3"](0,0,0);for(let i=1;i<n;i++){const t=3*(i-1);s.x=e[t],s.y=e[t+1],s.z=e[t+2];const n=3*i;a.x=e[n],a.y=e[n+1],a.z=e[n+2];const o=a.distanceTo(s);r[i]=r[i-1]+o}o(t,"lineDistance",new i["BufferAttribute"](r,1))}}var I=S;const C=["Point","MultiPoint","LineString","MultiLineString","Polygon","MultiPolygon"];function O(t){return t.geometry?t.geometry.type:null}function E(t){const e=O(t);if(e)for(let n=0,r=C.length;n<r;n++)if(C[n]===e)return!0;return!1}function P(t){const e=O(t);return!(!e||e!==C[4]&&e!==C[5])}function k(t){const e=O(t);return!(!e||e!==C[2]&&e!==C[3])}function R(t){const e=O(t);return!(!e||e!==C[0]&&e!==C[1])}function N(t){const e=O(t);return!!(e&&e.indexOf("Multi")>-1)}function D(t){return t.geometry?t.geometry.coordinates:[]}function F(t,e){const n=O(t);if(!n||!t.geometry)return null;const i=t.geometry,s=i.coordinates;if(!s)return null;let o=0,a=0,l=0;switch(n){case"Point":o=s[0],a=s[1],l++;break;case"MultiPoint":case"LineString":for(let t=0,e=s.length;t<e;t++)o+=s[t][0],a+=s[t][1],l++;break;case"MultiLineString":case"Polygon":for(let t=0,e=s.length;t<e;t++)for(let n=0,r=s[t].length;n<r;n++)o+=s[t][n][0],a+=s[t][n][1],l++;break;case"MultiPolygon":for(let t=0,e=s.length;t<e;t++)for(let n=0,r=s[t].length;n<r;n++)for(let e=0,i=s[t][n].length;e<i;e++)o+=s[t][n][e][0],a+=s[t][n][e][1],l++;break}const h=o/l,c=a/l;return e?(e.x=h,e.y=c,e):new r["f"](h,c)}function L(t){const e=O(t);if(!e||!t.geometry)return null;const n=t.geometry,r=t.properties||{},i=n.coordinates;if(!i)return null;const s=[];let o;switch(e){case"MultiPoint":o="Point";break;case"MultiLineString":o="LineString";break;case"MultiPolygon":o="Polygon";break}if(o)for(let a=0,l=i.length;a<l;a++)s.push({type:"Feature",geometry:{type:o,coordinates:i[a]},properties:r});else s.push(t);return s}
/*!
 * poly-extrude v0.3.0
  */var z={exports:{}};function B(t,e,n){n=n||2;var r,i,s,o,a,l,h,c=e&&e.length,u=c?e[0]*n:t.length,f=H(t,0,u,n,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=X(t,e,f,n)),t.length>80*n){r=s=t[0],i=o=t[1];for(var p=n;p<u;p+=n)a=t[p],l=t[p+1],a<r&&(r=a),l<i&&(i=l),a>s&&(s=a),l>o&&(o=l);h=Math.max(s-r,o-i),h=0!==h?32767/h:0}return j(f,d,n,r,i,h,0),d}function H(t,e,n,r,i){var s,o;if(i===gt(t,e,n,r)>0)for(s=e;s<n;s+=r)o=dt(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=dt(s,t[s],t[s+1],o);return o&&st(o,o.next)&&(pt(o),o=o.next),o}function U(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!st(r,r.next)&&0!==it(r.prev,r,r.next))r=r.next;else{if(pt(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function j(t,e,n,r,i,s,o){if(t){!o&&s&&J(t,r,i,s);var a,l,h=t;while(t.prev!==t.next)if(a=t.prev,l=t.next,s?G(t,r,i,s):V(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),pt(t),t=l.next,h=l.next;else if(t=l,t===h){o?1===o?(t=q(U(t),e,n),j(t,e,n,r,i,s,2)):2===o&&W(t,e,n,r,i,s):j(U(t),e,n,r,i,s,1);break}}}function V(t){var e=t.prev,n=t,r=t.next;if(it(e,n,r)>=0)return!1;var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;while(p!==e){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&nt(i,a,s,l,o,h,p.x,p.y)&&it(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function G(t,e,n,r){var i=t.prev,s=t,o=t.next;if(it(i,s,o)>=0)return!1;var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=tt(d,p,e,n,r),y=tt(A,g,e,n,r),v=t.prevZ,x=t.nextZ;while(v&&v.z>=m&&x&&x.z<=y){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&nt(a,c,l,u,h,f,v.x,v.y)&&it(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&nt(a,c,l,u,h,f,x.x,x.y)&&it(x.prev,x,x.next)>=0)return!1;x=x.nextZ}while(v&&v.z>=m){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&nt(a,c,l,u,h,f,v.x,v.y)&&it(v.prev,v,v.next)>=0)return!1;v=v.prevZ}while(x&&x.z<=y){if(x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&nt(a,c,l,u,h,f,x.x,x.y)&&it(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function q(t,e,n){var r=t;do{var i=r.prev,s=r.next.next;!st(i,s)&&ot(i,r,r.next,s)&&ct(i,s)&&ct(s,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(s.i/n|0),pt(r),pt(r.next),r=t=s),r=r.next}while(r!==t);return U(r)}function W(t,e,n,r,i,s){var o=t;do{var a=o.next.next;while(a!==o.prev){if(o.i!==a.i&&rt(o,a)){var l=ft(o,a);return o=U(o,o.next),l=U(l,l.next),j(o,e,n,r,i,s,0),void j(l,e,n,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function X(t,e,n,r){var i,s,o,a,l,h=[];for(i=0,s=e.length;i<s;i++)o=e[i]*r,a=i<s-1?e[i+1]*r:t.length,l=H(t,o,a,r,!1),l===l.next&&(l.steiner=!0),h.push(et(l));for(h.sort(Q),i=0;i<h.length;i++)n=Y(h[i],n);return n}function Q(t,e){return t.x-e.x}function Y(t,e){var n=Z(t,e);if(!n)return e;var r=ft(n,t);return U(r,r.next),U(n,n.next)}function Z(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&nt(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),ct(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&K(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}function K(t,e){return it(t.prev,t,e.prev)<0&&it(e.next,t,t.next)<0}function J(t,e,n,r){var i=t;do{0===i.z&&(i.z=tt(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,$(i)}function $(t){var e,n,r,i,s,o,a,l,h=1;do{n=t,t=null,s=null,o=0;while(n){for(o++,r=n,a=0,e=0;e<h;e++)if(a++,r=r.nextZ,!r)break;l=h;while(a>0||l>0&&r)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1);return t}function tt(t,e,n,r,i){return t=(t-n)*i|0,e=(e-r)*i|0,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function et(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function nt(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function rt(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!ht(t,e)&&(ct(t,e)&&ct(e,t)&&ut(t,e)&&(it(t.prev,t,e.prev)||it(t,e.prev,e))||st(t,e)&&it(t.prev,t,t.next)>0&&it(e.prev,e,e.next)>0)}function it(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function st(t,e){return t.x===e.x&&t.y===e.y}function ot(t,e,n,r){var i=lt(it(t,e,n)),s=lt(it(t,e,r)),o=lt(it(n,r,t)),a=lt(it(n,r,e));return i!==s&&o!==a||(!(0!==i||!at(t,n,e))||(!(0!==s||!at(t,r,e))||(!(0!==o||!at(n,t,r))||!(0!==a||!at(n,e,r)))))}function at(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function lt(t){return t>0?1:t<0?-1:0}function ht(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&ot(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function ct(t,e){return it(t.prev,t,t.next)<0?it(t,e,t.next)>=0&&it(t,t.prev,e)>=0:it(t,e,t.prev)<0||it(t,t.next,e)<0}function ut(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!==n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}function ft(t,e){var n=new At(t.i,t.x,t.y),r=new At(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function dt(t,e,n,r){var i=new At(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function pt(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function At(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function gt(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}z.exports=B,z.exports["default"]=B,B.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(gt(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(gt(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},B.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n};var mt=z.exports;function yt(t){var e,n,r=0,i=1,s=t.length;while(i<s)e=n||t[0],n=t[i],r+=(n[0]-e[0])*(n[1]+e[1]),i++;return r>0}function vt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function xt(t,e){var n=e[0],r=e[1],i=e[2],s=Math.sqrt(n*n+r*r+i*i)||1;return t[0]=n/s,t[1]=r/s,t[2]=i/s,t}function bt(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[0],a=n[1],l=n[2];return t[0]=i*l-s*a,t[1]=s*o-r*l,t[2]=r*a-i*o,t}function wt(t,e){function n(t,e,n,r){t[0]=e,t[1]=n,t[2]=r}var r=[],i=[],s=[],o=[],a=[],l=[],h=t.length,c=new Float32Array(e.length),u=0;while(u<h){var f=t[u],d=t[u+1],p=t[u+2],A=3*f,g=3*d,m=3*p;n(r,e[A],e[A+1],e[A+2]),n(i,e[g],e[g+1],e[g+2]),n(s,e[m],e[m+1],e[m+2]),vt(a,s,i),vt(o,r,i),bt(l,a,o);for(var y=0;y<3;y++)c[A+y]+=l[y],c[g+y]+=l[y],c[m+y]+=l[y];u+=3}var v=0,x=c.length;while(v<x)n(l,c[v],c[v+1],c[v+2]),xt(l,l),c[v]=l[0]||0,c[v+1]=l[1]||0,c[v+2]=l[2]||0,v+=3;return c}function _t(t){if(1===t.length){var e={position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};return e}for(var n=0,r=0,i=0,s=t.length;i<s;i++){var o=t[i],a=o.position,l=o.indices;n+=a.length,r+=l.length}for(var h={position:new Float32Array(n),normal:new Float32Array(n),uv:new Float32Array(n/3*2),indices:new Uint32Array(r),results:t},c=0,u=0,f=0,d=0,p=0,A=t.length;p<A;p++){var g=t[p],m=g.position,y=g.indices,v=g.normal,x=g.uv;h.position.set(m,c),h.normal.set(v,c),h.uv.set(x,d);var b=0,w=y.length;while(b<w){var _=y[b]+u;h.indices[f]=_,f++,b++}d+=x.length,c+=m.length,u+=m.length/3}return h}function Mt(t){return 180*t/Math.PI}function Tt(t){return t/180*Math.PI}function St(t,e,n,r,i,s){var o=3*n,a=3*r,l=3*i,h=3*s,c=e[o],u=e[o+1],f=e[o+2],d=e[a],p=e[a+1],A=e[a+2],g=e[l],m=e[l+1],y=e[l+2],v=e[h],x=e[h+1],b=e[h+2];Math.abs(u-p)<Math.abs(c-d)?(t.push(c,1-f),t.push(d,1-A),t.push(g,1-y),t.push(v,1-b)):(t.push(u,1-f),t.push(p,1-A),t.push(m,1-y),t.push(x,1-b))}function It(t,e){e=Object.assign({},{depth:2},e);var n=t.map((function(t){for(var n=0,r=t.length;n<r;n++){var i=t[n];kt(i),0===n?yt(i)||(t[n]=i.reverse()):yt(i)&&(t[n]=i.reverse()),Rt(i)&&i.splice(i.length-1,1)}var s=Pt(t,e);s.polygon=t;var o=mt(s.flatVertices,s.holes,2);return Ct(s,o),Ot(s,e),s.position=new Float32Array(s.points),s.indices=new Uint32Array(s.index),s.uv=new Float32Array(s.uvs),s.normal=wt(s.indices,s.position),s})),r=_t(n);return r.polygons=t,r}function Ct(t,e){for(var n=[],r=t.count,i=0,s=e.length;i<s;i+=3){var o=e[i],a=e[i+1],l=e[i+2];n[i]=o,n[i+1]=a,n[i+2]=l;var h=s+i,c=r+o,u=r+a,f=r+l;n[h]=c,n[h+1]=u,n[h+2]=f}t.index=n}function Ot(t,e){for(var n=t.points,r=t.index,i=t.polygon,s=t.uvs,o=e.depth,a=0,l=i.length;a<l;a++){var h=i[a],c=0,u=h.length;while(c<u){var f=h[c],d=h[c+1];c===u-1&&(d=h[0]);var p=n.length/3,A=f[0],g=f[1],m=d[0],y=d[1];n.push(A,g,o,m,y,o,A,g,0,m,y,0);var v=p+2,x=p+3,b=p,w=p+1;r.push(v,b,x,b,w,x),St(s,n,v,x,b,w),c++}}}function Et(t){var e=0,n=0,r=t.length;while(n<r)e+=t[n].length,n++;return e}function Pt(t,e){for(var n=Et(t),r=t.length,i=[],s=new Float32Array(2*n),o=[],a=[],l=3*n,h=2*n,c=e.depth,u=0,f=0,d=0,p=0;p<r;p++){var A=t[p];p>0&&i.push(u/2);var g=0,m=A.length;while(g<m){var y=A[g],v=y[0],x=y[1];s[u++]=v,s[u++]=x,o[f]=v,o[f+1]=x,o[f+2]=c,o[l+f]=v,o[l+f+1]=x,o[l+f+2]=0,a[d]=v,a[d+1]=x,a[h+d]=v,a[h+d+1]=x,f+=3,d+=2,g++}}return{flatVertices:s,holes:i,points:o,count:n,uvs:a}}function kt(t){Rt(t)||t.push(t[0])}function Rt(t){var e=t.length,n=t[0],r=n[0],i=n[1],s=t[e-1],o=s[0],a=s[1];return r===o&&i===a}function Nt(t,e){e=Object.assign({},{depth:2,lineWidth:1},e);var n=t.map((function(t){var n=Bt(t,e);return n.line=t,Dt(n,e),Ft(n,e),n.position=new Float32Array(n.points),n.indices=new Uint32Array(n.index),n.uv=new Float32Array(n.uvs),n.normal=wt(n.indices,n.position),n})),r=_t(n);return r.lines=t,r}function Dt(t,e){var n=e.depth,r=[],i=[],s=[],o=t.leftPoints,a=t.rightPoints,l=0,h=o.length;while(l<h){var c=3*l,u=o[l],f=u[0],d=u[1],p=u[2];r[c]=f,r[c+1]=d,r[c+2]=n+p;var A=a[l],g=A[0],m=A[1],y=A[2],v=3*h+c;r[v]=g,r[v+1]=m,r[v+2]=n+y;var x=2*h*3+c;r[x]=f,r[x+1]=d,r[x+2]=p;var b=2*h*3+3*h+c;r[b]=g,r[b+1]=m,r[b+2]=y,l++}l=0,h=r.length;while(l<h){var w=r[l],_=r[l+1];s.push(w,_),l+=3}l=0,h=o.length;while(l<h-1){var M=l,T=l+1,S=M+h,I=T+h;i.push(M,S,T),i.push(S,I,T);var C=2*h,O=l+C,E=O+1,P=O+h,k=E+h;i.push(O,P,E),i.push(P,k,E),l++}t.index=i,t.points=r,t.uvs=s}function Ft(t,e){var n=t.points,r=t.index,i=t.leftPoints,s=t.rightPoints,o=t.uvs,a=e.depth,l=[i,s];function h(t,e){var i=n.length/3;n.push(t[0],t[1],a+t[2],e[0],e[1],a+e[2],t[0],t[1],t[2],e[0],e[1],e[2]);var s=i+2,l=i+3,h=i,c=i+1;r.push(s,h,l,h,c,l),St(o,n,s,l,h,c)}for(var c=0,u=l.length;c<u;c++){var f=l[c];c>0&&(f=f.map((function(t){return t})),f=f.reverse());var d=0,p=f.length-1;while(d<p){var A=f[d],g=f[d+1];h(A,g),d++}}for(var m=i.length,y=[s[0],i[0],i[m-1],s[m-1]],v=0;v<y.length;v+=2){var x=y[v],b=y[v+1];h(x,b)}}var Lt={x:0,y:0},zt={x:0,y:0};function Bt(t,e){var n=0,r=e.lineWidth/2,i=[],s=[],o=[],a=t.length,l=0;while(l<a-1){var h=t[l],c=t[l+1],u=c[1]-h[1],f=c[0]-h[0],d=0,p=Math.atan(u/f),A=Mt(p);if(n=A,0===l)d=A,d-=90;else{var g=t[l-1];Lt.x=g[0]-h[0],Lt.y=g[1]-h[1],zt.x=c[0]-h[0],zt.y=c[1]-h[1];var m=Ut(Lt,zt);d=A-m/2}var y=Tt(d),v=Ht(y,r,h),x=v[0],b=v[1];i.push(x,b),jt(x,h,c)?(s.push(x),o.push(b)):(s.push(b),o.push(x)),l++}var w=n;w-=90;var _=Tt(w),M=t[a-2],T=t[a-1],S=Ht(_,r,T),I=S[0],C=S[1];return i.push(I,C),jt(I,M,T)?(s.push(I),o.push(C)):(s.push(C),o.push(I)),{offsetPoints:i,leftPoints:s,rightPoints:o}}function Ht(t,e,n){var r=n[0],i=n[1],s=n[2]||0,o=Math.cos(t)*e,a=Math.sin(t)*e,l=[r+o,i+a,s],h=t+=Math.PI,c=Math.cos(h)*e,u=Math.sin(h)*e,f=[r+c,i+u,s];return[l,f]}var Ut=function(t,e){var n=t.x,r=t.y,i=e.x,s=e.y,o=n*i+r*s,a=n*s-r*i,l=Math.atan2(a,o)/Math.PI*180;return(l+360)%360};function jt(t,e,n){var r=e[0],i=e[1],s=n[0],o=n[1],a=t[0],l=t[1];return(i-o)*a+(s-r)*l+r*o-s*i>0}function Vt(t,e){void 0===e&&(e={}),e=Object.assign({},{radius:1,height:2,radialSegments:6},e);for(var n=Math.round(Math.max(4,e.radialSegments)),r=e,i=r.radius,s=r.height,o=360/n/360*Math.PI*2,a=n+1,l=new Float32Array(3*a*2),h=t[0],c=t[1],u=0,f=0,d=3*a,p=2*a,A=[],g=[],m=-1;m<n;m++){var y=o*m,v=Math.cos(y)*i+h,x=Math.sin(y)*i+c;l[u]=v,l[u+1]=x,l[u+2]=0,l[u+d]=v,l[u+1+d]=x,l[u+2+d]=s;var b=0,w=0;b=.5+v/i/2,w=.5+x/i/2,g[f]=b,g[f+1]=w,g[f+p]=b,g[f+1+p]=w,u+=3,f+=2,m>1&&A.push(0,m-1,m)}u-=3,l[u]=l[0],l[u+1]=l[1],l[u+2]=l[2];var _=l.length;l[_-3]=l[0],l[_-2]=l[1],l[_-1]=s;for(var M=A.length,T=0;T<M;T++){var S=A[T];A.push(S+a)}var I=new Float32Array(2*(3*a*2-6)),C=-1;u=2*a,f=0;for(var O=0,E=l.length/2;O<E-3;O+=3){var P=l[O],k=l[O+1],R=l[O+3],N=l[O+4];I[++C]=P,I[++C]=k,I[++C]=s,I[++C]=R,I[++C]=N,I[++C]=s,I[++C]=P,I[++C]=k,I[++C]=0,I[++C]=R,I[++C]=N,I[++C]=0;var D=u+2,F=u+3,L=u,z=u+1;A.push(L,D,z,D,F,z),u+=4;var B=f/a,H=(f+1)/a;g.push(B,s/i/2,H,s/i/2,B,0,H,0),f++}var U=new Float32Array(l.length+I.length);U.set(l,0),U.set(I,l.length);var j=wt(A,U);return{points:l,indices:new Uint32Array(A),position:U,normal:j,uv:new Float32Array(g)}}var Gt=function(){function t(t,e,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this.x=t,this.y=e,this.z=n}var e=t.prototype;return e.set=function(t,e,n){return void 0===n&&(n=this.z),this.x=t,this.y=e,this.z=n,this},e.clone=function(){return new this.constructor(this.x,this.y,this.z)},e.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},e.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},e.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},e.addVectors=function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},e.addScaledVector=function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},e.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},e.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},e.subVectors=function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},e.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},e.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},e.multiplyVectors=function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},e.applyMatrix4=function(t){var e=this.x,n=this.y,r=this.z,i=t.elements,s=1/(i[3]*e+i[7]*n+i[11]*r+i[15]);return this.x=(i[0]*e+i[4]*n+i[8]*r+i[12])*s,this.y=(i[1]*e+i[5]*n+i[9]*r+i[13])*s,this.z=(i[2]*e+i[6]*n+i[10]*r+i[14])*s,this},e.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},e.divideScalar=function(t){return this.multiplyScalar(1/t)},e.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},e.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},e.clamp=function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},e.clampScalar=function(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this},e.clampLength=function(t,e){var n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(t,Math.min(e,n)))},e.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},e.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},e.normalize=function(){return this.divideScalar(this.length()||1)},e.setLength=function(t){return this.normalize().multiplyScalar(t)},e.lerp=function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},e.lerpVectors=function(t,e,n){return this.x=t.x+(e.x-t.x)*n,this.y=t.y+(e.y-t.y)*n,this.z=t.z+(e.z-t.z)*n,this},e.cross=function(t){return this.crossVectors(this,t)},e.crossVectors=function(t,e){var n=t.x,r=t.y,i=t.z,s=e.x,o=e.y,a=e.z;return this.x=r*a-i*o,this.y=i*s-n*a,this.z=n*o-r*s,this},e.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},e.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},e.fromArray=function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},e.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}(),qt=function(){function t(){this.pos=new Gt,this.dir=new Gt,this.right=new Gt,this.up=new Gt,this.dist=0,this.widthScale=1,this.sharp=!1}var e=t.prototype;return e.lerpPathPoints=function(t,e,n){this.pos.lerpVectors(t.pos,e.pos,n),this.dir.lerpVectors(t.dir,e.dir,n),this.up.lerpVectors(t.up,e.up,n),this.right.lerpVectors(t.right,e.right,n),this.dist=(e.dist-t.dist)*n+t.dist,this.widthScale=(e.widthScale-t.widthScale)*n+t.widthScale},e.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),Wt=function(){function t(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A)}var e=t.prototype;return e.set=function(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A){var g=this.elements;return g[0]=t,g[4]=e,g[8]=n,g[12]=r,g[1]=i,g[5]=s,g[9]=o,g[13]=a,g[2]=l,g[6]=h,g[10]=c,g[14]=u,g[3]=f,g[7]=d,g[11]=p,g[15]=A,this},e.multiply=function(t){return this.multiplyMatrices(this,t)},e.makeRotationAxis=function(t,e){var n=Math.cos(e),r=Math.sin(e),i=1-n,s=t.x,o=t.y,a=t.z,l=i*s,h=i*o;return this.set(l*s+n,l*o-r*a,l*a+r*o,0,l*o+r*a,h*o+n,h*a-r*s,0,l*a-r*o,h*a+r*s,i*a*a+n,0,0,0,0,1),this},e.equals=function(t){for(var e=this.elements,n=t.elements,r=0;r<16;r++)if(e[r]!==n[r])return!1;return!0},t}();function Xt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,Qt(t,e)}function Qt(t,e){return Qt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Qt(t,e)}var Yt=function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var e=t.prototype;return e.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},e.getPointAt=function(t,e){var n=this.getUtoTmapping(t);return this.getPoint(n,e)},e.getPoints=function(t){void 0===t&&(t=5);for(var e=[],n=0;n<=t;n++)e.push(this.getPoint(n/t));return e},e.getLength=function(){var t=this.getLengths();return t[t.length-1]},e.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,n=[],r=this.getPoint(0),i=0;n.push(0);for(var s=1;s<=t;s++)e=this.getPoint(s/t),i+=e.distanceTo(r),n.push(i),r=e;return this.cacheArcLengths=n,n},e.getUtoTmapping=function(t,e){var n,r=this.getLengths(),i=0,s=r.length;n=e||t*r[s-1];var o,a=0,l=s-1;while(a<=l)if(i=Math.floor(a+(l-a)/2),o=r[i]-n,o<0)a=i+1;else{if(!(o>0)){l=i;break}l=i-1}if(i=l,r[i]===n)return i/(s-1);var h=r[i],c=r[i+1],u=c-h,f=(n-h)/u,d=(i+f)/(s-1);return d},t}();function Zt(t,e){var n=1-t;return n*n*e}function Kt(t,e){return 2*(1-t)*t*e}function Jt(t,e){return t*t*e}function $t(t,e,n,r){return Zt(t,e)+Kt(t,n)+Jt(t,r)}var te=function(t){function e(e,n,r){var i;return void 0===e&&(e=new Gt),void 0===n&&(n=new Gt),void 0===r&&(r=new Gt),i=t.call(this)||this,i.isQuadraticBezierCurve3=!0,i.type="QuadraticBezierCurve3",i.v0=e,i.v1=n,i.v2=r,i}Xt(e,t);var n=e.prototype;return n.getPoint=function(t,e){void 0===e&&(e=new Gt);var n=e,r=this.v0,i=this.v1,s=this.v2;return n.set($t(t,r.x,i.x,s.x),$t(t,r.y,i.y,s.y),$t(t,r.z,i.z,s.z)),n},e}(Yt),ee=new Gt,ne=new Gt,re=new Gt,ie=new Wt,se=new te;function oe(t,e,n,r,i,s){var o=ee.subVectors(e,t),a=ne.subVectors(n,e),l=o.length(),h=a.length();o.normalize(),a.normalize();var c=Math.min(.999999*(i?l/2:l),r);s.v0.copy(e).sub(o.multiplyScalar(c)),s.v1.copy(e);var u=Math.min(h/2*.999999,r);return s.v2.copy(e).add(a.multiplyScalar(u)),s}var ae=function(){function t(){this.array=[],this.count=0}var e=t.prototype;return e.set=function(t,e,n,r,i){if(void 0===e&&(e=.1),void 0===n&&(n=10),void 0===r&&(r=null),void 0===i&&(i=!1),t=t.slice(0),t.length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);i&&!t[0].equals(t[t.length-1])&&t.push((new Gt).copy(t[0]));for(var s=0,o=t.length;s<o;s++)if(0===s)this._start(t[s],t[s+1],r);else if(s===o-1)if(i){this._corner(t[s],t[1],e,n,r);var a=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=a}else this._end(t[s]);else this._corner(t[s],t[s+1],e,n,r)},e.distance=function(){return this.count>0?this.array[this.count-1].dist:0},e._getByIndex=function(t){return this.array[t]||(this.array[t]=new qt),this.array[t]},e._start=function(t,e,n){this.count=0;var r=this._getByIndex(this.count);if(r.pos.copy(t),r.dir.subVectors(e,t),n)r.up.copy(n);else{var i=Number.MAX_VALUE,s=Math.abs(r.dir.x),o=Math.abs(r.dir.y),a=Math.abs(r.dir.z);s<i&&(i=s,r.up.set(1,0,0)),o<i&&(i=o,r.up.set(0,1,0)),a<i&&r.up.set(0,0,1)}r.right.crossVectors(r.dir,r.up).normalize(),r.up.crossVectors(r.right,r.dir).normalize(),r.dist=0,r.widthScale=1,r.sharp=!1,r.dir.normalize(),this.count++},e._end=function(t){var e=this.array[this.count-1],n=this._getByIndex(this.count);n.pos.copy(t),n.dir.subVectors(t,e.pos);var r=n.dir.length();n.dir.normalize(),n.up.copy(e.up);var i=ee.crossVectors(e.dir,n.dir);if(i.length()>Number.EPSILON){i.normalize();var s=Math.acos(Math.min(Math.max(e.dir.dot(n.dir),-1),1));n.up.applyMatrix4(ie.makeRotationAxis(i,s))}n.right.crossVectors(n.dir,n.up).normalize(),n.dist=e.dist+r,n.widthScale=1,n.sharp=!1,this.count++},e._corner=function(t,e,n,r,i){if(n>0&&r>0){for(var s=this.array[this.count-1],o=oe(s.pos,t,e,n,this.count-1===0,se),a=o.getPoints(r),l=0;l<r;l++)this._sharpCorner(a[l],a[l+1],i,0===l?1:0);a[r].equals(e)||this._sharpCorner(a[r],e,i,2)}else this._sharpCorner(t,e,i,0,!0)},e._sharpCorner=function(t,e,n,r,i){void 0===r&&(r=0),void 0===i&&(i=!1);var s=this.array[this.count-1],o=this._getByIndex(this.count),a=ee.subVectors(t,s.pos),l=ne.subVectors(e,t),h=a.length();if(a.normalize(),l.normalize(),o.pos.copy(t),1===r?o.dir.copy(a):2===r?o.dir.copy(l):(o.dir.addVectors(a,l),o.dir.normalize()),n)1===o.dir.dot(n)?o.right.crossVectors(l,n).normalize():o.right.crossVectors(o.dir,n).normalize(),o.up.crossVectors(o.right,o.dir).normalize();else{o.up.copy(s.up);var c=re.crossVectors(s.dir,o.dir);if(c.length()>Number.EPSILON){c.normalize();var u=Math.acos(Math.min(Math.max(s.dir.dot(o.dir),-1),1));o.up.applyMatrix4(ie.makeRotationAxis(c,u))}o.right.crossVectors(o.dir,o.up).normalize()}o.dist=s.dist+h;var f=a.dot(l);o.widthScale=Math.min(1/Math.sqrt((1+f)/2),1.415)||1,o.sharp=Math.abs(f-1)>.05&&i,this.count++},t}(),le=new Gt(0,0,1);function he(t,e){e=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},e);var n=t.map((function(t){var n=t.map((function(t){var e=t[0],n=t[1],r=t[2];return new Gt(e,n,r||0)})),r=new ae;r.set(n,e.cornerRadius,e.cornerSplit,le);var i=ce(r,e);return i.line=t,i.position=new Float32Array(i.points),i.indices=new Uint32Array(i.index),i.uv=new Float32Array(i.uvs),i.normal=new Float32Array(i.normal),i})),r=_t(n);return r.lines=t,r}function ce(t,e){var n=e.lineWidth||.1,r=1,i=n/2,s=n,o=t.distance(),a=r*o;if(0===o)return null;var l,h=i/s,c=0,u=[],f=[],d=[],p=[],A=0,g=new Gt,m=new Gt,y=new Gt,v=new Gt,x=new Gt,b=new Gt;function w(t){var e=0===u.length,n=t.sharp&&!e,r=t.dist/s,o=t.dir,a=t.up,l=t.right;if(g.copy(l).multiplyScalar(i*t.widthScale),m.copy(l).multiplyScalar(-i*t.widthScale),g.add(t.pos),m.add(t.pos),n){y.fromArray(u,u.length-6).sub(m),v.fromArray(u,u.length-3).sub(g);var w,_,M=y.length(),T=v.length(),S=M-T;S>0?(w=y,_=m):(w=v,_=g),x.copy(w).setLength(Math.abs(S)).add(_);var I=b.copy(_).sub(x).normalize().dot(o),C=b.copy(_).sub(x).length(),O=I*C*2;b.copy(o).setLength(O).add(x),S>0?(u.push(x.x,x.y,x.z,g.x,g.y,g.z,m.x,m.y,m.z,g.x,g.y,g.z,b.x,b.y,b.z,g.x,g.y,g.z),A+=6,p.push(A-6,A-8,A-7,A-6,A-7,A-5,A-4,A-6,A-5,A-2,A-4,A-1),c+=12):(u.push(m.x,m.y,m.z,x.x,x.y,x.z,m.x,m.y,m.z,g.x,g.y,g.z,m.x,m.y,m.z,b.x,b.y,b.z),A+=6,p.push(A-6,A-8,A-7,A-6,A-7,A-5,A-6,A-5,A-3,A-2,A-3,A-1),c+=12),f.push(a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z),d.push(r-h,0,r-h,1,r,0,r,1,r+h,0,r+h,1)}else u.push(m.x,m.y,m.z,g.x,g.y,g.z),f.push(a.x,a.y,a.z,a.x,a.y,a.z),d.push(r,0,r,1),A+=2,e||(p.push(A-2,A-4,A-3,A-2,A-3,A-1),c+=6)}if(a>0)for(var _=0;_<t.count;_++){var M=t.array[_];if(M.dist>a){var T=t.array[_-1];l=new qt;var S=(a-T.dist)/(M.dist-T.dist);l.lerpPathPoints(T,M,S),w(l);break}w(M)}else l=t.array[0];return{points:u,normal:f,uvs:d,index:p,count:c}}function ue(t,e,n={}){return void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]}function fe(t,e,n={}){return void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]}function de(t=[]){let e=0,n=0;const i=t.length;for(let s=0;s<i;s++){const{coordinate:i,lnglat:o,lnglats:a,xy:l,xys:h}=t[s],c=i||o||a||l||h||t[s];let u,f;Array.isArray(c)?(u=c[0],f=c[1]):c instanceof r["f"]&&(u=c.x,f=c.y),e+=u,n+=f}return new r["f"](e/i,n/i)}function pe(t,e,n,r){if(void 0===e||"number"!==typeof e||0===e)return 0;let s;s=t instanceof i["BufferGeometry"]?t.attributes.position.array:Array.isArray(t)||t instanceof Float32Array?t:t.position;let o=0;if(s){r?(void 0===r[e]&&(r[e]=n.altitudeToVector3(e,e).x),o=r[e]):o=n.altitudeToVector3(e,e).x;const t=s.length;if(s[0]instanceof i["Vector3"])for(let e=0;e<t;e++)s[e].z+=o;else for(let e=0;e<t;e+=3)s[e+2]+=o}return o}function Ae(t){const e=t.length;let n=0;for(let r=0;r<e;r++){const{count:e}=t[r].position;n+=e}return new Float32Array(3*n)}const ge=new i["Vector3"],me=new Map;function ye(t=[],e){const n=t.length,r=!!e,i=r?3:2,s=new Float64Array(n*i);me.clear();for(let o=0;o<n;o++){let n,a;const l=t[o];let h;if(l.x?(n=l.x,a=l.y,h=l.z):(n=l[0],a=l[1],h=l[2]),s[o*i]=n,s[o*i+1]=a,h=h||0,r&&0!==h){if(!me.has(h)){const t=e.altitudeToVector3(h,h,null,ge).x;me.set(h,t)}s[o*i+2]=me.get(h)}}return s.buffer}function ve(t){return(P(t)?t["properties"]:t.getProperties())||{}}function xe(t){return(k(t)?t["properties"]:t.getProperties())||{}}const be=new i["Color"]("#fff"),we=new i["Color"]("#fff");function _e(t,e,n,r){const{position:s,normal:a,uv:l,indices:h}=Me(t,e,n,r),c=new Float32Array(s.length);c.fill(1,0,s.length);const u=new i["BufferGeometry"];return o(u,"color",new i["BufferAttribute"](c,3)),o(u,"normal",new i["BufferAttribute"](a,3)),o(u,"position",new i["BufferAttribute"](s,3)),o(u,"uv",new i["BufferAttribute"](l,2)),u.setIndex(new i["BufferAttribute"](h,1)),u}function Me(t,e,n,r,i,s){const o=Se(t,n,r,i,!1),a=o;if(!a)return null;s?(null==s[e]&&(s[e]=n.altitudeToVector3(e,e).x),e=s[e]):e=n.altitudeToVector3(e,e).x;const{position:l,normal:h,uv:c,indices:u}=It(a,{depth:e});return{position:l,normal:h,uv:c,indices:u}}function Te(t,e,n,r){void 0===r&&(r=0);const s=t.attributes.position.array,a=s.length;let l;if(we.setStyle(e),be.setStyle(n),Array.isArray(r)){let t=0;for(let e=0,n=r.length;e<n;e++){const{count:n}=r[e].position;t+=3*n}l=new Float32Array(t)}else l=new Float32Array(s.length);if(Array.isArray(r))for(let i=0,o=r.length;i<o;i++){const{middleZ:t,start:e,end:n}=r[i].position;for(let r=e;r<n;r+=3){const e=s[r+2];e>t?(l[r]=be.r,l[r+1]=be.g,l[r+2]=be.b):(l[r]=we.r,l[r+1]=we.g,l[r+2]=we.b)}}else for(let i=0;i<a;i+=3){const t=s[i+2];t>r?(l[i]=be.r,l[i+1]=be.g,l[i+2]=be.b):(l[i]=we.r,l[i+1]=we.g,l[i+2]=we.b)}return o(t,"color",new i["BufferAttribute"](l,3,!0)),l}function Se(t,e,n,i,s=!1){if(!t)return null;let o=[];if(t instanceof r["x"])o=t.getGeometries().map(r=>Ie(r,e,n||t.getCenter(),i,s));else if(t instanceof r["C"]){const r=Ie(t,e,n||t.getCenter(),i,s);o.push(r)}else if(P(t))if(N(t)){const r=L(t);for(let a=0,l=r.length;a<l;a++)o.push(Ie(r[a],e,n||F(t),i,s))}else{const r=Ie(t,e,n||F(t),i,s);o.push(r)}return o}function Ie(t,e,n,i,s=!1){let o,a,l;if(P(t)){const e=D(t);o=e[0],a=e.slice(1,e.length),n=n||F(t)}else t instanceof r["C"]&&(o=t.getShell(),a=t.getHoles(),n=n||t.getCenter());i=i||e.coordinateToVector3(n),l=s?e.coordinatiesToGLFloatArray(o,i).positons2d:e.coordinatiesToGLArray(o,i);const h=[s?l.buffer:l];if(a&&a.length>0)for(let r=0,c=a.length;r<c;r++){let t;t=s?e.coordinatiesToGLFloatArray(a[r],i).positons2d:e.coordinatiesToGLArray(a[r],i),h.push(s?t.buffer:t)}return h}function Ce(t){if(!t)return null;let e=[];if(t instanceof r["x"])e=t.getGeometries().map(t=>Oe(t,!1));else if(t instanceof r["C"]){const n=Oe(t,!1);e.push(n)}else if(P(t))if(N(t)){const n=L(t);for(let t=0,r=n.length;t<r;t++)e.push(Oe(n[t],!0))}else{const n=Oe(t,!0);e.push(n)}return e}function Oe(t,e){let n,i;if(e){const e=D(t);n=e[0],i=e.slice(1,e.length)}else t instanceof r["C"]&&(n=t.getShell(),i=t.getHoles());const s=ye(n),o=[s];if(i&&i.length>0)for(let r=0,a=i.length;r<a;r++){const t=ye(i[r]);o.push(t)}return o}const Ee=",",Pe=new Map,ke=new i["Vector3"];function Re(t,e,n,s=!0){let o,a,l=[];if(Array.isArray(t)&&t[0]instanceof i["Vector3"])l=t;else{Array.isArray(t)&&(t=new r["s"](t));const i=0;let h,c;E(t)?(h=D(t),n||(c=F(t))):t instanceof r["s"]&&(h=t.getCoordinates(),n||(c=t.getCenter()));const u=e.coordinateToVector3(n||c);if(s){Pe.clear();for(let t=0,n=h.length;t<n;t++){const n=h[t],r=n.z||n[2]||0;if(!Pe.has(r)){const t=e.altitudeToVector3(r,r,null,ke).x;Pe.set(r,t)}const s=e.coordinateToVector3(n,i).sub(u);s.z+=Pe.get(r)||0,l.push(s)}}else{const t=e.coordinatiesToGLFloatArray(h,u,!0);o=t.positions,a=t.positons2d}}if(!s)return{positions:o,positionsV:l,positions2d:a,arrayBuffer:o.buffer};a=new Float32Array(2*l.length),o=new Float32Array(3*l.length);for(let r=0,i=l.length;r<i;r++){const t=3*r,e=l[r];o[t]=e.x,o[t+1]=e.y,o[t+2]=e.z;const n=2*r;a[n]=e.x,a[n+1]=e.y}return{positions:o,positionsV:l,positions2d:a,arrayBuffer:o.buffer}}function Ne(t,e,n,r){const i=[],s=[],o=[];let a,l;for(let h=0,c=t.length;h<c;h++){const n=t[h];for(let t=0,h=n.length;t<h;t++){const h=n[t],c=h.join(Ee).toString();a?(c!==a&&(l=e.coordinateToVector3(h,0).sub(r),i.push(l.x,l.y,l.z),s.push(l),o.push(h)),a=c):(o.push(h),a=c,l=e.coordinateToVector3(h,0).sub(r),i.push(l.x,l.y,l.z),s.push(l))}}return{positions:i,positionsV:s,lnglats:o}}function De(t){let e;const n=[];for(let r=0,i=t.length;r<i;r++){const i=t[r];for(let t=0,r=i.length;t<r;t++){const r=i[t],s=r.join(Ee).toString();e?(s!==e&&n.push(r),e=s):(n.push(r),e=s)}}return n}function Fe(t,e=1,n=1,r,i){const s=Re(t,r,i).positionsV,o=[];for(let u=0,f=s.length;u<f;u++){const t=s[u];o.push([t.x,t.y,t.z])}const{indices:a,position:l,normal:h,uv:c}=Nt([o],{lineWidth:e,depth:n});return{position:l,normal:h,indices:a,uv:c}}function Le(t,e=1,n=1,r,i){const s=Re(t,r,i).positionsV,o=[];for(let u=0,f=s.length;u<f;u++){const t=s[u];o.push([t.x,t.y,t.z])}const{indices:a,position:l,normal:h,uv:c}=he([o],{lineWidth:e,cornerRadius:n});return{position:l,normal:h,indices:a,uv:c}}function ze(t){let e,n=[];return t instanceof r["v"]?(n=t.getGeometries(),e=t.getCenter()):t instanceof r["s"]?(n.push(t),e=t.getCenter()):E(t)&&(e=F(t),N(t)?n=L(t):n.push(t)),{lineStrings:n,center:e}}function Be(t){const e=new Float32Array(2*t.length-6);let n=0;for(let r=0,i=t.length/3;r<i;r++){const s=t[3*r],o=t[3*r+1],a=t[3*r+2];if(r>0&&r<i-1){const t=3*n;e[t]=s,e[t+1]=o,e[t+2]=a,n++}const l=3*n;e[l]=s,e[l+1]=o,e[l+2]=a,n++}return e}function He(t){let e=0;const n=t.length;if(1===n)return t[0];for(let s=0;s<n;s++)e+=t[s].length;const r=new Float32Array(e);let i=0;for(let s=0;s<n;s++)r.set(t[s],i),i+=t[s].length;return r}function Ue(t,e){return t instanceof r["s"]?ye(t.getCoordinates(),e):k(t)?ye(t.geometry.coordinates,e):void 0}let je;function Ve(){return je||(je=new i["BufferGeometry"],o(je,"position",new i["BufferAttribute"](new Float32Array(3),3))),je}const Ge="__maptalks.three__";function qe(){return Ge}let We;var Xe;function Qe(){return r["R"]||console.error("maptalks.worker is not defined,You can't use ThreeVectorTileLayer"),!Xe&&We&&(Xe=new We(qe())),Xe}function Ye(t,e,n={}){return void 0!==t&&"number"===typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.distanceToVector3(t,t).x),n[t]):0}function Ze(t,e,n={}){return void 0!==t&&"number"===typeof t&&0!==t?(void 0===n[t]&&(n[t]=e.altitudeToVector3(t,t).x),n[t]):0}function Ke(t,e){return e?Object.assign({},e,t):t||{}}function Je(t=[],e,n,r=[],i){const s=n.isMercator();let o,a,l;if(s){const t=n.getMap();o=t.getGLRes(),a=t.getSpatialReference().getTransformation().matrix}e&&(l=n.coordinateToVector3(e));const h=t.length,c=[],u=[],f={};for(let d=0;d<h;d++){const o=t[d],a=o;let h,p=r[d]?r[d]:ve(a);p=Ke(p,i),e||(l=n.coordinateToVector3(p.center)),h=s?Ce(o):Se(o,n,p.center||e,l,!0);for(let t=0,e=h.length;t<e;t++){const e=h[t];for(let t=0,n=e.length;t<n;t++)u.push(e[t])}let A=p.height||1,g=p.bottomHeight||0;A=Ze(A,n,f),g=Ze(g,n,f);const m={id:p.id,data:h,height:A,bottomHeight:g};s&&(m.center=[l.x,l.y]),c.push(m),a._properties&&delete a._properties}return{datas:c,transfer:u,glRes:o,matrix:a,center:s?[l.x,l.y]:null}}function $e(t,e,n,r,i=[],s){const o=n.isMercator();let a,l,h;if(o){const t=n.getMap();a=t.getGLRes(),l=t.getSpatialReference().getTransformation().matrix}e&&(h=n.coordinateToVector3(e));const c=[],u=[],f={},d={},p=t.length;for(let A=0;A<p;A++){const a=t[A];let l=i[A]?i[A]:xe(r[A]);l=Ke(l,s),e||(h=n.coordinateToVector3(l.center));let p=l.width||1,g=l.height||1,m=l.cornerRadius||0,y=l.bottomHeight||0;const v=l.parentCenter;p=Ye(p,n,f),m=Ye(m,n,f),g=Ze(g,n,d),y=Ze(y,n,d);const x=[];for(let t=0,r=a.length;t<r;t++){const r=a[t];let i;i=o?Ue(r,n):Re(r,n,v||e,!1).arrayBuffer,u.push(i),x.push(i)}const b={id:l.id,data:x,height:g,width:p,cornerRadius:m,bottomHeight:y};o&&(b.center=[h.x,h.y]),c.push(b)}return{datas:c,transfer:u,glRes:a,matrix:l,center:o?[h.x,h.y]:null}}function tn(t,e,n,r,i=[],s){const o=n.isMercator();let a,l,h;if(o){const t=n.getMap();a=t.getGLRes(),l=t.getSpatialReference().getTransformation().matrix}e&&(h=n.coordinateToVector3(e));const c=[],u=[],f={},d=t.length;for(let p=0;p<d;p++){const a=t[p];let l=i[p]?i[p]:xe(r[p]);l=Ke(l,s),e||(h=n.coordinateToVector3(l.center));let d=l.bottomHeight||0;d=Ze(d,n,f);const A=[];for(let t=0,r=a.length;t<r;t++){const r=a[t];if(o){const t=Ue(r,n);u.push(t),A.push(t)}else{const t=Re(r,n,e,!1).arrayBuffer;u.push(t),A.push(t)}}const g={id:l.id,data:A,bottomHeight:d};o&&(g.center=[h.x,h.y]),c.push(g)}return{datas:c,transfer:u,glRes:a,matrix:l,center:o?[h.x,h.y]:null}}function en(t){const e=t.length,n=new Float32Array(7*e);let r=0;for(let s=0;s<e;s++){let{center:e,radialSegments:i,radius:o,height:a,altitude:l,id:h}=t[s];e=e||[0,0],n[r]=e[0],n[r+1]=e[1],n[r+2]=i||6,n[r+3]=o||1,n[r+4]=a,n[r+5]=l||0,n[r+6]=h,r+=7}const i=n.buffer;return{datas:i,transfer:[i]}}function nn(t){return t.map(t=>t.data)}function rn(t){return t.map(t=>t.option||t.baseObject.getOptions())}r["R"]&&(We=class extends r["R"].Actor{test(t,e){this.send(t,null,e)}pushQueue(t={}){const{type:e,data:n,callback:r,layer:i,key:s,center:o,lineStrings:a,options:l,id:h,baseOptions:c}=t;let u;e.indexOf("ExtrudePolygon")>-1?u=Je(n,o,i,l,c):"ExtrudeLines"===e||"Paths"===e?u=$e(n,o,i,a,l,c):"Point"===e||("Line"===e||"FatLine"===e||"Lines"===e||"FatLines"===e?u=tn(n,o,i,a,l,c):"ExtrudeLine"===e||"Path"===e?u=$e(n,o,i,a,l,c):"Bar"!==e&&"Bars"!==e||(u=en(n))),u?this.send({type:e,datas:u.datas,glRes:u.glRes,matrix:u.matrix,center:u.center},u.transfer,(function(t,e){t&&console.error(t),e.key=s,e.id=h,r(e)})):console.error("No processing logic found for type:"+e)}});class sn{constructor(){this.queueMap={},this.tempQueue=[],this.time=this.getCurrentTime(),this.deQueueCount=5,this.resultQueue=[]}getActor(){return Qe()}getCurrentTime(){return r["I"].now()}loop(){this.deQueue()}push(t){return this.tempQueue.push(t),t.id&&(this.queueMap[t.id]=t),this}reset(){return this.time=this.getCurrentTime(),this.tempQueue=[],this}pushResult(t){if(t)return Array.isArray(t)||(t=[t]),t.forEach(t=>{this.resultQueue.push(t)}),this}deQueue(){if(!this.resultQueue.length)return this;const t=this.deQueueCount,e=this.resultQueue.slice(0,t)||[];return e.forEach(t=>{const{id:e}=t;if(this.queueMap[e]){const{baseObject:n}=this.queueMap[e];if(n&&n._workerLoad){const e=n.getLayer();e?n._workerLoad(t):console.warn(n," worker Processing completed but removed from the layer")}delete this.queueMap[e]}}),this.resultQueue.splice(0,t),this}}class on extends sn{constructor(){super(),this.deQueueCount=100}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"ExtrudePolygon",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class an extends sn{loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"ExtrudePolygons",layer:e.layer,data:e.data,key:e.key,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}class ln extends sn{constructor(){super(),this.deQueueCount=100}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"ExtrudeLine",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),lineStrings:this.tempQueue.map(t=>t.lineString),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class hn extends sn{loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"ExtrudeLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}class cn extends sn{constructor(){super(),this.deQueueCount=200}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"Line",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),lineStrings:this.tempQueue.map(t=>t.lineString),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class un extends sn{loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"Lines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}class fn extends sn{constructor(){super(),this.deQueueCount=100}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"FatLine",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),lineStrings:this.tempQueue.map(t=>t.lineString),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class dn extends sn{loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"FatLines",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}class pn extends sn{constructor(){super(),this.deQueueCount=100}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"Bar",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class An extends sn{constructor(){super(),this.deQueueCount=1}loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"Bars",layer:e.layer,data:e.data,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}class gn extends sn{constructor(){super(),this.deQueueCount=100}loop(){const t=this.getCurrentTime();if((t-this.time>=32||this.tempQueue.length>=1e3)&&this.tempQueue.length){const t=Qe();t.pushQueue({type:"Path",layer:this.tempQueue[0].layer,data:nn(this.tempQueue),options:rn(this.tempQueue),lineStrings:this.tempQueue.map(t=>t.lineString),callback:t=>{this.pushResult(t)}}),this.reset()}super.loop()}}class mn extends sn{loop(){if(this.tempQueue.length){const t=Qe();this.tempQueue.forEach(e=>{t.pushQueue({id:e.id,type:"Paths",layer:e.layer,data:e.data,key:e.key,lineStrings:e.lineStrings,center:e.center,baseOptions:e.option,callback:t=>{this.pushResult(t)}})}),this.reset()}super.loop()}}const yn=new on,vn=new an,xn=new ln,bn=new hn,wn=new cn,_n=new un,Mn=new fn,Tn=new dn,Sn=new pn,In=new An,Cn=new gn,On=new mn,En={isRunning:!1,tasks:[],addTask:t=>{t&&En.tasks.push(t)},removeTask:t=>{En.tasks.splice(En.tasks.indexOf(t),1)},loop(){yn.loop(),vn.loop(),xn.loop(),bn.loop(),wn.loop(),_n.loop(),Mn.loop(),Tn.loop(),Sn.loop(),In.loop(),Cn.loop(),On.loop(),En.tasks.forEach(t=>{t&&t.loop&&t.loop()}),r["I"].requestAnimFrame(En.loop)},star(){En.isRunning||(En.isRunning=!0,En.loop())}};function Pn(t){const{position:e,normal:n,uv:r,indices:s}=kn(t),a=new i["BufferGeometry"],l=new Float32Array(e.length);return l.fill(1,0,e.length),o(a,"color",new i["BufferAttribute"](l,3)),o(a,"normal",new i["BufferAttribute"](n,3)),o(a,"position",new i["BufferAttribute"](e,3)),r&&r.length&&o(a,"uv",new i["BufferAttribute"](r,2)),a.setIndex(new i["BufferAttribute"](s,1)),a}function kn(t){const e={},n={};for(let o=0;o<t.length;++o){const r=t[o];for(const t in r)void 0===e[t]&&(e[t]=[],n[t]=0),e[t].push(r[t]),n[t]+=r[t].length}const r={};let i=0;const s=new Uint32Array(n["indices"]);for(const o in e)if("indices"===o){const t=e[o];let n=0;for(let r=0,o=t.length;r<o;r++){const o=t[r];for(let t=0,e=o.length;t<e;t++)s[n]=o[t]+i,n++;i+=e["position"][r].length/3}}else{const t=Rn(e[o],n[o]);if(!t)return null;r[o]=t}return r["indices"]=s,r}function Rn(t,e){const n=new Float32Array(e);let r=0;for(let i=0;i<t.length;++i)n.set(t[i],r),r+=t[i].length;return n}function Nn(t){const{position:e,normal:n,uv:r,indices:s}=t,a=new i["BufferGeometry"];return o(a,"normal",new i["BufferAttribute"](new Float32Array(n),3)),o(a,"position",new i["BufferAttribute"](new Float32Array(e),3)),o(a,"uv",new i["BufferAttribute"](new Float32Array(r),2)),a.setIndex(new i["BufferAttribute"](new Uint32Array(s),1)),a}function Dn(t){const e=new i["BufferGeometry"];return o(e,"normal",t.getAttribute("normal")),o(e,"position",t.getAttribute("position").clone()),e.setIndex(t.getIndex()),e}let Fn;function Ln(){if(!Fn){const t=1e-6;Fn=u(t,t,t)}return Fn}Ln();const zn=u(1,1,1);zn.translate(0,0,.5);const Bn=new i["Color"]("#fff"),Hn=new i["Color"]("#fff");function Un(t){const{position:e,normal:n,uv:r,indices:s}=Vt(t.center||[0,0],t),a=new i["BufferGeometry"];return o(a,"normal",new i["BufferAttribute"](n,3)),o(a,"position",new i["BufferAttribute"](e,3)),o(a,"uv",new i["BufferAttribute"](r,2)),a.setIndex(new i["BufferAttribute"](s,1)),a}function jn(t){const e=Object.assign({},t);return e._radius&&(e.radius=e._radius),Un(e)}function Vn(t,e,n,r="y",s=0){let a=0;"y"===r?a=1:"z"===r&&(a=2);const l=t.attributes.position.array,h=l.length;Hn.setStyle(e),Bn.setStyle(n);const c=new Float32Array(h);if(Array.isArray(s))for(let i=0,o=s.length;i<o;i++){const{middleZ:t,start:e,end:n}=s[i].position;for(let r=e;r<n;r+=3){const e=l[r+2];e>t?(c[r]=Bn.r,c[r+1]=Bn.g,c[r+2]=Bn.b):(c[r]=Hn.r,c[r+1]=Hn.g,c[r+2]=Hn.b)}}else for(let i=0;i<h;i+=3){const t=l[i+a];t>s?(c[i]=Bn.r,c[i+1]=Bn.g,c[i+2]=Bn.b):(c[i]=Hn.r,c[i+1]=Hn.g,c[i+2]=Hn.b)}return o(t,"color",new i["BufferAttribute"](c,3,!0)),c}function Gn(t){const e=[],n=t.length;let r=0;for(let i=0;i<n;i++){const{color:e}=t[i].attributes;e&&(r+=e.array.length)}const s=new Float32Array(r);let a=0;for(let i=0,o=t.length;i<o;i++){const{color:n,normal:r,position:o,uv:l}=t[i].attributes,h=t[i].index;n&&(s.set(n.array,a),a+=n.array.length),e.push({normal:r.array,uv:l.array,position:o.array,indices:h.array})}const l=Pn(e);s.length&&o(l,"color",new i["BufferAttribute"](s,3,!0));for(let i=0,o=t.length;i<o;i++)t[i].dispose();return l}function qn(){return zn}const Wn={radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class Xn extends I{constructor(t,e,n,i){e=r["I"].extend({},Wn,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:s,radius:o,topColor:a,bottomColor:l,altitude:h,asynchronous:u}=e;let f;if(e.height=i.altitudeToVector3(s,s).x,e.radius=i.distanceToVector3(o,o).x,u){f=Ln();const t=r["I"].GUID();this.getOptions().id=t,Sn.push({data:{radius:e.radius,height:e.height,radialSegments:e.radialSegments,id:t},layer:i,id:t,baseObject:this})}else f=jn(e),a&&(Vn(f,l,a,"z",e.height/2),n.vertexColors=c());this._createMesh(f,n);const d=i.altitudeToVector3(h,h).x,p=i.coordinateToVector3(t,d);this.getObject3d().position.copy(p),this.type="Bar"}_workerLoad(t){const e=Nn(t),{topColor:n,bottomColor:r,height:i}=this.getOptions(),s=this.getObject3d(),o=s.material;if(n){const t=this.getLayer(),s=t.altitudeToVector3(i,i).x;Vn(e,r,n,"z",s/2),o.vertexColors=c()}s.geometry=e,s.material.needsUpdate=!0,this._fire("workerload",{target:this})}}var Qn=Xn;function Yn(t){const e=[];return t&&t.length&&t.forEach(t=>{t=t instanceof i["Color"]?t:new i["Color"](t),e.push(t.r,t.g,t.b)}),e}const Zn={altitude:0,bottomHeight:0,colors:null};class Kn extends I{constructor(t,e,n,s){e=r["I"].extend({},Zn,e,{layer:s,lineString:t}),super(),this._initOptions(e);const{lineStrings:a,center:l}=ze(t),{asynchronous:h}=e;let u;if(h){u=Ve();const n=r["I"].GUID();this.getOptions().id=n,this.getOptions().center=l,wn.push({id:n,data:a,layer:s,key:e.key,lineString:t,baseObject:this})}else{const t=[];for(let e=0,n=a.length;e<n;e++){const n=a[e],{positions:r}=Re(n,s,l,!1);t.push(Be(r))}const r=He(t);u=new i["BufferGeometry"],o(u,"position",new i["BufferAttribute"](r,3)),pe(u,e.bottomHeight,s);const h=Yn(e.colors);h&&h.length&&(o(u,"color",new i["Float32BufferAttribute"](h,3)),n.vertexColors=c())}this._createLineSegments(u,n);const{altitude:f}=e,d=s.altitudeToVector3(f,f).x,p=s.coordinateToVector3(l,d);this.getObject3d().position.copy(p),this.type="Line"}_workerLoad(t){const e=new i["BufferGeometry"];o(e,"position",new i["BufferAttribute"](new Float32Array(t.position),3));const n=Yn(this.getOptions().colors),r=this.getObject3d(),s=r.material;n&&n.length&&(o(e,"color",new i["Float32BufferAttribute"](n,3)),s.vertexColors=c()),this._computeLineDistances(e),r.geometry=e,r.material.needsUpdate=!0,this._fire("workerload",{target:this})}}var Jn=Kn;const $n={bottomHeight:0,width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class tr extends I{constructor(t,e,n,i){e=r["I"].extend({},$n,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{height:s,width:o,bottomColor:a,topColor:l,bottomHeight:h,altitude:u,asynchronous:f}=e,d=i.altitudeToVector3(s,s).x,p=i.distanceToVector3(o,o).x,{lineStrings:A,center:g}=ze(t);let m;if(f){m=Ln();const e=r["I"].GUID();this.getOptions().id=e,this.getOptions().center=g,xn.push({id:e,data:A,layer:i,center:g,lineString:t,baseObject:this})}else{const t=[];let e=0;const r={};for(let n=0,s=A.length;n<s;n++){const s=Fe(A[n],p,d,i,g);e=pe(s,h,i,r),t.push(s)}m=Pn(t),l&&(Te(m,a,l,e+d/2),n.vertexColors=c())}this._createMesh(m,n);const y=i.altitudeToVector3(u,u).x,v=i.coordinateToVector3(g,y);this.getObject3d().position.copy(v),this.type="ExtrudeLine"}_workerLoad(t){const e=Nn(t),{topColor:n,bottomColor:r,bottomHeight:i,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer(),o=t.altitudeToVector3(i,i).x,l=t.altitudeToVector3(s,s).x;Te(e,r,n,o+l/2),a.vertexColors=c()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}var er=tr;const nr={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class rr extends I{constructor(t,e,n,i){e=r["I"].extend({},nr,e,{layer:i,polygon:t}),super(),this._initOptions(e);const{height:s,topColor:o,bottomColor:a,altitude:l,bottomHeight:h,asynchronous:u}=e;let f;const d=P(t)?F(t):t.getCenter();if(u){f=Ln();const e=r["I"].GUID();this.getOptions().id=e,this.getOptions().center=d,yn.push({data:t,layer:i,id:e,baseObject:this})}else{f=_e(t,s,i);const e=pe(f,h,i);if(o){const t=i.altitudeToVector3(s,s).x;Te(f,a,o,e+t/2),n.vertexColors=c()}}this._createMesh(f,n);const p=i.altitudeToVector3(l,l).x,A=i.coordinateToVector3(d,p);this.getObject3d().position.copy(A),this.type="ExtrudePolygon"}_workerLoad(t){const e=Nn(t),{topColor:n,bottomColor:r,bottomHeight:i,height:s}=this.getOptions(),o=this.getObject3d(),a=o.material;if(n){const t=this.getLayer(),o=t.altitudeToVector3(i,i).x,l=t.altitudeToVector3(s,s).x;Te(e,r,n,o+l/2),a.vertexColors=c()}o.geometry=e,o.material.needsUpdate=!0,this._fire("workerload",{target:this})}}var ir=rr;const sr={altitude:0,coordinate:null};class or extends I{constructor(t,e={},n){e.coordinate||(console.warn("coordinate is null,it is important to locate the model"),e.coordinate=n.getMap().getCenter()),e=r["I"].extend({},sr,e,{layer:n,model:t}),super(),this._initOptions(e),this._createGroup(),this.getObject3d().add(t);const{altitude:i,coordinate:s}=e,o=n.altitudeToVector3(i,i).x,a=n.coordinateToVector3(s,o);this.getObject3d().position.copy(a),this.type="Model"}getCoordinates(){const t=this.options.coordinate,e=this.options.altitude,n=new r["f"](t);return n.z=e,n}}var ar=or;const lr=Math.PI/180,hr=6378137,cr=.1;function ur(t){const e=t.getCoordinates();return e.map(t=>t.toArray())}function fr(t){return t*lr}function dr(t,e){if(!t||!e)return 0;Array.isArray(t)||(t=t.toArray()),Array.isArray(e)||(e=e.toArray());let n=fr(t[1]);const r=fr(e[1]),i=n-r,s=fr(t[0])-fr(e[0]);return n=2*Math.asin(Math.sqrt(Math.pow(Math.sin(i/2),2)+Math.cos(n)*Math.cos(r)*Math.pow(Math.sin(s/2),2))),n*=hr,Math.round(1e5*n)/1e5}function pr(t,e){const{len:n,c1:r,c2:i}=t,s=i[0]-r[0],o=i[1]-r[1],a=e/n,l=r[0]+a*s,h=r[1]+a*o;return[l,h]}function Ar(t,e=10){e=Math.max(e,cr),Array.isArray(t)||(t=ur(t));const n=t.length;let r=[],i=0;for(let f=0;f<n-1;f++){const e=dr(t[f],t[f+1]),n=Math.floor(e);r.push({c1:t[f],len:n,c2:t[f+1]}),i+=n}if(i<=e){const t=r.map(t=>[t.c1,t.c2]);return t}if(1===r.length&&r[0].len<=e)return[[r[0].c1,r[0].c2]];const s=r.length,o=r[0];let a,l=0,h=0;const c=[];let u=[o.c1];while(l<s){const{len:t,c2:n}=r[l];if(h+=t,h<e&&(u.push(n),l===s-1&&c.push(u),l++),h===e&&(u.push(n),h=0,c.push(u),u=[n],l++),h>e){const n=t-h+e;a=pr(r[l],n),u.push(a),c.push(u),h=0,r[l].c1=a,r[l].len=t-n,u=[],u.push(a)}}return c}const gr=1e3;function mr(t,e,n,r){const i=e.length;t.attributes.normal.count=i,t.attributes.position.count=i;const s=t.attributes.position.array,o=t.attributes.normal.array;for(let a=0;a<i;a++)s[a]=e[a],o[a]=n[a];t.index.count=r.length;for(let a=0,l=r.length;a<l;a++)t.index.array[a]=r[a]}const yr={trail:5,chunkLength:50,width:2,height:1,speed:1,altitude:0,interactive:!1,heightEnable:!0};class vr extends I{constructor(t,e,n,s){e=r["I"].extend({},yr,e,{layer:s,lineString:t}),super(),this._initOptions(e);const{width:a,height:l,altitude:h,speed:c,chunkLength:u,trail:f}=e;let d,p;E(t)?(d=F(t),p=D(t)):(d=t.getCenter(),p=t);const A=Ar(p,u),g=s.coordinateToVector3(d),m=new i["BufferGeometry"],y=new Float32Array(3*gr),v=new Float32Array(3*gr),x=new Uint16Array(gr);o(m,"position",new i["BufferAttribute"](y,3)),o(m,"normal",new i["BufferAttribute"](v,3)),m.setIndex(new i["BufferAttribute"](x,1));const b=s.distanceToVector3(a,a).x,w=s.altitudeToVector3(l,l).x;this._createMesh(m,n);const _=s.altitudeToVector3(h,h).x,M=s.coordinateToVector3(d,_);this.getObject3d().position.copy(M),this._params={index:0,chunkLines:A,geometries:[],layer:s,trail:Math.max(1,f),lineWidth:b,depth:w,speed:Math.min(1,c),idx:0,loaded:!0,center:d,centerPt:g,workerInitCount:0},this._init(this._params),this.type="ExtrudeLineTrail"}_init(t){const{layer:e,trail:n,lineWidth:i,depth:s,chunkLines:o,positionMap:a,centerPt:l,center:h}=t,c=o.length,u=[];if(this.options.asynchronous){t.loaded=!1;const i=r["I"].GUID();for(let t=0;t<c;t++){const s=o.slice(t,t+n),a=De(s),l={type:"Feature",geometry:{type:"LineString",coordinates:a}},c=`${i}-${t}`,u=r["I"].extend({},this.options);u.parentCenter=h,u.id=c,u.center=h,xn.push({id:c,data:[l],layer:e,center:h,lineString:l,baseObject:this,option:u})}}else for(let r=0;r<c;r++){const t=o.slice(r,r+n),h=Ne(t,e,a,l).positionsV;u.push(Fe(h,i,s,e))}}_animation(){const{index:t,geometries:e,speed:n,idx:r,chunkLines:i,trail:s,lineWidth:o,depth:a,loaded:l,layer:h,positionMap:c,centerPt:u}=this._params;if(!l)return;const f=Math.round(t);if(f>r&&f<=i.length-1){this._params.idx++;let t=e[f];if(!t){const n=i.slice(f,f+s),r=Ne(n,h,c,u).positionsV;t=Fe(r,o,a,h),e[f]=t}const n=this.getObject3d();mr(n.geometry,t.position,t.normal,t.indices),n.geometry.attributes.position.needsUpdate=!0,n.geometry.attributes.normal.needsUpdate=!0,n.geometry.index.needsUpdate=!0}t>=i.length-1&&(this._params.index=-1,this._params.idx=-1),this._params.index+=n}_workerLoad(t){if(!t)return this;const{id:e,indices:n,position:i,normal:s,uv:o}=t;if(!e||!n||!i||!s||!o)return;let a=e.split("-")[1];if(a=parseInt(a),r["I"].isNumber(a)){const t=this._params.geometries;t[a]={indices:new Uint32Array(n),position:new Float32Array(i),uv:new Float32Array(o),normal:new Float32Array(s)},this._params.workerInitCount++}this._params.workerInitCount===this._params.chunkLines.length&&(this._params.loaded=!0,this._fire("workerload",{target:this}))}}var xr=vr;const br=["click","mousemove","mousedown","mouseup","dblclick","contextmenu"].join(" ").toString(),wr=new i["MeshBasicMaterial"];wr.vertexColors=c();const _r=t=>class extends t{_initBaseObjectsEvent(t){if(t&&Array.isArray(t)&&t.length)for(let e=0,n=t.length;e<n;e++){const n=t[e];this._proxyEvent(n)}return this}_proxyEvent(t){t.on("add",t=>{this._showGeometry(t.target,!0)}),t.on("remove",t=>{this._showGeometry(t.target,!1)}),t.on("mouseout",t=>{this._mouseover=!1,this.fire("mouseout",Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))}),t.on(br,t=>{this.fire(t.type,Object.assign({},t,{target:this,selectMesh:this.getSelectMesh?this.getSelectMesh():null}))})}_getHideGeometryIndex(t){const e=[];let n=0;for(let r=0,i=this._geometriesAttributes.length;r<i;r++)!0===this._geometriesAttributes[r].hide&&(e.push(r),n+=this._geometriesAttributes[r][t].count);return{indexs:e,count:n}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),r=this._geometryCache.attributes[e].array,s=r.length;for(let i=0;i<s;i++)t.array[i]=r[i];let o=NaN;this.getObject3d()instanceof i["LineSegments"]&&(o=0);for(let i=0;i<n.length;i++){const r=n[i],{start:s,end:a}=this._geometriesAttributes[r][e];for(let e=s;e<a;e++)t.array[e]=o}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:r}=t;if(r===e)return this;t.hide=e;const i=this.getObject3d().geometry;this._updateAttribute(i.attributes.position,"position"),i.attributes.position.needsUpdate=!0,this.isHide=e}return this}getSelectMesh(){const t=this._getIndex();if(null!=t)return{data:this._datas[t],baseObject:this._baseObjects[t]}}_getIndex(t){return null==t&&(t=this.faceIndex||this.index),t}_init(){const t=this.getLayer().getPick();this.on("add",()=>{t.add(this.pickObject3d)}),this.on("remove",()=>{t.remove(this.pickObject3d)})}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,r=n.length,s=Ae(n);let a=0;for(let i=0;i<r;i++){const t=e.getColor(),r=t.getHex();this._colorMap[r]=i;const{count:o}=n[i].position;this._datas[i].colorIndex=r;for(let e=0;e<o;e++)s[a]=t.r,s[a+1]=t.g,s[a+2]=t.b,a+=3}o(t,"color",new i["BufferAttribute"](s,3,!0));const l=e.getColor(),h=l.getHex(),c=new i["Mesh"](t,wr);c.position.copy(this.getObject3d().position),c["_colorIndex"]=h,this.setPickObject3d(c)}};var Mr=_r;const Tr={altitude:0,height:1,bottomHeight:0,topColor:null,bottomColor:"#2d2f61"},Sr=new r["f"](0,0);class Ir extends(Mr(I)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=t.length;0===s&&console.error("polygons is empty");let o=1/0,a=1/0,l=-1/0,h=-1/0;for(let c=0;c<s;c++){const e=t[c],n=e.getCenter?e.getCenter():F(e,Sr);let i,s;Array.isArray(n)?(i=n[0],s=n[1]):n instanceof r["f"]&&(i=n.x,s=n.y),o=Math.min(o,i),a=Math.min(a,s),l=Math.max(l,i),h=Math.max(h,s)}const u=new r["f"]((o+l)/2,(a+h)/2);e=r["I"].extend({},Tr,e,{layer:i,polygons:t,coordinate:u});const{topColor:f,bottomColor:d,altitude:p,asynchronous:A}=e;let g;const m=[],y=[];if(super(),A)g=Ln(),vn.push({id:r["I"].GUID(),layer:i,key:e.key,center:u,data:t,baseObject:this,option:e});else{const o=i.coordinateToVector3(u),a=[];let l=0,h=0,p=0,A=0;const m={};for(let n=0;n<s;n++){const s=t[n],c=r["I"].extend({},e,ve(s)),f=c.height||1,d=c.bottomHeight||0,g=Me(s,f,i,u,o,m);a.push(g);const v=pe(g,d,i,m),{position:x,normal:b,uv:w,indices:_}=g,M=_.length/3;l+=M;const T=x.length/3,S=b.length/3,I=w.length/2;y[n]={position:{middleZ:v+m[f]/2,count:T,start:h,end:h+3*T},hide:!1},h+=3*T,p+=3*S,A+=2*I}g=Pn(a),f&&(Te(g,d,f,y),n.vertexColors=c())}this._initOptions(e),this._createMesh(g,n);const v=i.altitudeToVector3(p,p).x,x=i.coordinateToVector3(u,v);this.getObject3d().position.copy(x),this._baseObjects=m,this._datas=t,this._geometriesAttributes=y,this.faceIndex=null,this._geometryCache=Dn(g),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(m),A||(this._setPickObject3d(),this._init()),this.type="ExtrudePolygons"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,P(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ir(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Nn(t);this._geometryCache=Dn(n);const{topColor:r,bottomColor:i}=this.getOptions(),s=this.getObject3d(),o=s.material;if(r&&(Te(n,i,r,e),o.vertexColors=c()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}}var Cr=Ir;function Or(t,e,n){const r=t.project(n),i=e.width/2,s=e.height/2,o={x:Math.round(r.x*i+i),y:Math.round(-r.y*s+s)};return o}const Er={altitude:0,height:0,color:null},Pr=new i["Vector3"];class kr extends I{constructor(t,e,n,s){e=r["I"].extend({},Er,e,{layer:s,coordinate:t}),super();let{height:a,altitude:l,color:h,size:c}=e;const u=[],f=[];h&&(h=h instanceof i["Color"]?h:new i["Color"](h),f.push(h.r,h.g,h.b));const d=s.altitudeToVector3(a,a).x,p=s.coordinateToVector3(t,d);u.push(0,0,p.z);const A=new i["BufferGeometry"];o(A,"position",new i["Float32BufferAttribute"](u,3,!0)),f.length&&o(A,"color",new i["Float32BufferAttribute"](f,3,!0)),void 0!==c&&o(A,"size",new i["Float32BufferAttribute"]([c],1,!0)),e.positions=p,this._initOptions(e),this._createPoints(A,n);const g=s.altitudeToVector3(l,l).x,m=new i["Vector3"](p.x,p.y,g);this.getObject3d().position.copy(m),this.type="Point"}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().positions,s=this.getOptions().altitude;let o=this.getObject3d().material.size;void 0===o&&(o=this.options.size||1);const a=this.getMap().coordToContainerPoint(t),l=e.altitudeToVector3(s,s).x;Pr.x=i.x,Pr.y=i.y,Pr.z=i.z+l;const h=Or(Pr,n,r),c=Math.sqrt(Math.pow(a.x-h.x,2)+Math.pow(a.y-h.y,2));return c<=o/2}}var Rr=kr;const Nr=30,Dr=30;function Fr(t,e){const{minx:n,miny:r,maxx:i,maxy:s}=t,[o,a]=e;return n<=o&&o<=i&&r<=a&&a<=s}class Lr{constructor(t,e,n,r){this.minlng=t,this.minlat=e,this.maxlng=n,this.maxlat=r,this.minx=1/0,this.miny=1/0,this.maxx=-1/0,this.maxy=-1/0,this.coordinates=[],this.positions=[],this.indexs=[],this.key=null}updateBBoxPixel(t){let e=1/0,n=1/0,i=-1/0,s=-1/0;const{minlng:o,minlat:a,maxlng:l,maxlat:h}=this;return[[o,a],[o,h],[l,a],[l,h]].map(t=>new r["f"](t)).map(e=>t.coordToContainerPoint(e)).forEach(t=>{e=Math.min(e,t.x),n=Math.min(n,t.y),i=Math.max(i,t.x),s=Math.max(s,t.y)}),this.minx=e,this.miny=n,this.maxx=i,this.maxy=s,this}containsCoordinate(t){let e,n;Array.isArray(t)?(e=t[0],n=t[1]):t instanceof r["f"]&&(e=t.x,n=t.y);const{minlng:i,minlat:s,maxlng:o,maxlat:a}=this;return i<=e&&e<=o&&s<=n&&n<=a}isRecCross(t,e){const{x:n,y:r}=t,i={minx:n-e/2,miny:r-e/2,maxx:n+e/2,maxy:r+e/2},{minx:s,miny:o,maxx:a,maxy:l}=i;return!!(Fr(this,[s,o])||Fr(this,[s,l])||Fr(this,[a,o])||Fr(this,[a,l])||Fr(i,[this.minx,this.miny])||Fr(i,[this.minx,this.maxy])||Fr(i,[this.maxx,this.miny])||Fr(i,[this.maxx,this.maxy]))}static initGrids(t,e,n,r){const i=[],s=n-t,o=r-e,a=s/Dr,l=o/Nr;let h=t,c=e;for(let u=0;u<Dr;u++){h=t+u*a;for(let t=0;t<Nr;t++){c=e+t*l;const n=new Lr(h,c,h+a,c+l);n.key=t+"-"+u,i.push(n)}}return{grids:i,averageX:a,averageY:l,ROWS:Nr,COLS:Dr}}}var zr=Lr;const Br={altitude:0},Hr=new i["Vector3"];function Ur(t,e){const n=Math.pow(10,e);return Math.round(t*n)/n}class jr extends(Mr(I)){constructor(t,e,n,s){Array.isArray(t)||(t=[t]),e=r["I"].extend({},Br,e,{layer:s,points:t});let a=1/0,l=1/0,h=-1/0,c=-1/0;for(let i=0,o=t.length;i<o;i++){const{coordinate:e}=t[i];let n,s;Array.isArray(e)?(n=e[0],s=e[1]):e instanceof r["f"]&&(n=e.x,s=e.y),t[i].coords=[n,s],a=Math.min(a,n),l=Math.min(l,s),h=Math.max(h,n),c=Math.max(c,s)}const u=s.coordinateToVector3([(a+h)/2,(l+c)/2]),{grids:f,averageX:d,averageY:p,ROWS:A,COLS:g}=zr.initGrids(a,l,h,c),m=(f.length,new Float32Array(3*t.length)),y=[],v=new Float32Array(3*t.length),x=new Float32Array(t.length),b=[],w=[],_={};let M=0,T=!1,S=!1;const I=new i["Vector3"](0,0,0);for(let r=0,o=t.length;r<o;r++){let{coordinate:e,height:n,color:o,size:h,coords:c}=t[r];const g=3*r;o&&(T=!0,o=o instanceof i["Color"]?o:new i["Color"](o),v[g]=o.r,v[g+1]=o.g,v[g+2]=o.b),h&&(S=!0,x[r]=h,M=Math.max(M,h));const b=fe(n,s,_),C=s.coordinateToVector3(e,b);I.x=C.x,I.y=C.y,I.z=C.z,I.sub(u),m[g]=I.x,m[g+1]=I.y,m[g+2]=I.z,y.push(C),w[r]={position:{count:1,start:3*r,end:3*r+3},hide:!1};let O=Ur((c[1]-l)/p,4),E=Ur((c[0]-a)/d,4);O-=1,E-=1,O=Math.max(0,O),E=Math.max(0,E),O=Math.ceil(O),E=Math.ceil(E);const P=E*A+O;f[P]&&(f[P].positions.push(C),f[P].indexs.push(r))}const C=new i["BufferGeometry"];o(C,"position",new i["BufferAttribute"](m,3,!0)),T&&o(C,"color",new i["BufferAttribute"](v,3,!0)),S&&o(C,"size",new i["BufferAttribute"](x,1,!0)),e.positions=y,super(),this._initOptions(e),this._createPoints(C,n);const O=e.altitude,E=s.altitudeToVector3(O,O).x,P=u.clone();P.z=E,this.getObject3d().position.copy(P),this._baseObjects=b,this._datas=t,this.faceIndex=null,this._geometriesAttributes=w,this._geometryCache=C.clone(),this.isHide=!1,this._initBaseObjectsEvent(b),this._grids=f,this._bindMapEvents(),this.type="Points",this.maxSize=M}_bindMapEvents(){const t=this.getMap(),e="zoomstart zooming zoomend movestart moving moveend pitch rotate";this.on("add",()=>{this._updateGrids(),t.on(e,this._updateGrids,this)}),this.on("remove",()=>{t.off(e,this._updateGrids,this)})}_updateGrids(){const t=this.getMap();this._grids.forEach(e=>{e.indexs.length&&e.updateBBoxPixel(t)})}getSelectMesh(){const t=this.faceIndex;if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],{coordinate:n,height:r,color:i,size:s}=e;this._baseObjects[t]=new Rr(n,{height:r,index:t,color:i,size:s},this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){const e=this.getLayer(),n=this.getMap().getSize(),r=this.getLayer().getCamera(),i=this.getOptions().altitude,s=this.getMap(),o=e.altitudeToVector3(i,i).x;let a=this.getObject3d().material.size;const l=void 0===a,h=s.coordToContainerPoint(t),c=[];if(this._grids.forEach(t=>{t.indexs.length&&t.isRecCross(h,l?this.maxSize:a)&&c.push(t)}),c.length<1)return!1;for(let u=0,f=c.length;u<f;u++)for(let t=c[u].positions.length,e=t-1;e>=0;e--){l&&(a=this._datas[c[u].indexs[e]].size||1);const t=c[u].positions[e];Hr.x=t.x,Hr.y=t.y,Hr.z=t.z+o;const i=Or(Hr,n,r),s=Math.sqrt(Math.pow(h.x-i.x,2)+Math.pow(h.y-i.y,2));if(s<=a/2)return this.faceIndex=c[u].indexs[e],!0}return!1}}var Vr=jr;const Gr={coordinate:"",radius:10,height:100,radialSegments:6,altitude:0,topColor:"",bottomColor:"#2d2f61"};class qr extends(Mr(I)){constructor(t,e,n,s){Array.isArray(t)||(t=[t]);const o=t.length,a=de(t),l=s.coordinateToVector3(a),h=[],u=[],f=[];let d=0,p=0,A=0,g=0;const m={},y={};let v;super(),e=r["I"].extend({},{altitude:0,layer:s,points:t},Gr,e),this._initOptions(e);const x=new i["Vector3"];if(e.asynchronous){v=Ln();const n=r["I"].GUID();this.getOptions().id=n;const i=[];for(let a=0;a<o;a++){const n=r["I"].extend({index:a},e,t[a]),{radius:o,radialSegments:h,altitude:c,height:u,coordinate:f}=n,d=ue(o,s,m);t[a]._radius=d;const p=fe(u,s,y),A=fe(c,s,y),g=s.coordinateToVector3(f,0,x).sub(l);i.push({radialSegments:h,radius:d,height:p,center:[g.x,g.y],altitude:A})}In.push({id:n,data:i,layer:s,baseObject:this})}else{for(let i=0;i<o;i++){const o=r["I"].extend({index:i},e,t[i]),{radius:a,radialSegments:v,altitude:b,topColor:w,bottomColor:_,height:M,coordinate:T}=o,S=ue(a,s,m),I=fe(M,s,y),C=fe(b,s,y),O=s.coordinateToVector3(T,0,x).sub(l),E=jn({radius:S,height:I,radialSegments:v,center:[O.x,O.y]});w&&(Vn(E,_,w,"z",I/2),n.vertexColors=c());const P=E.attributes.position.array;for(let t=0,e=P.length;t<e;t+=3)P[t+2]+=C;h.push(E);const k=new Qn(T,o,n,s);u.push(k);const R=E.index.count/3;d+=R;const N=E.attributes.position.count,D=E.attributes.normal.count,F=E.attributes.uv.count;f[i]={position:{count:N,start:p,end:p+3*N},hide:!1},p+=3*N,A+=3*D,g+=2*F}v=Gn(h)}this._createMesh(v,n);const b=e.altitude,w=s.altitudeToVector3(b,b).x,_=l.clone();_.z=w,this.getObject3d().position.copy(_),this._baseObjects=u,this._datas=t,this._geometriesAttributes=f,this.faceIndex=null,this._geometryCache=Dn(v),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(u),e.asynchronous||(this._setPickObject3d(),this._init()),this.type="Bars"}identify(){return this.picked}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,e,{index:t,asynchronous:!1});this._baseObjects[t]=new Qn(e.coordinate,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Nn(t);this._geometryCache=Dn(n);const{topColor:r,bottomColor:i}=this.getOptions(),s=this.getObject3d(),o=s.material;if(r&&(Vn(n,i,r,"z",e),o.vertexColors=c()),s.geometry=n,s.material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}}var Wr=qr;const Xr={width:3,height:1,altitude:0,topColor:null,bottomColor:"#2d2f61"};class Qr extends(Mr(I)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let r=0;r<a;r++){const e=t[r],n=ze(e);s.push(n.center),o.push(n.lineStrings)}const l=de(s);e=r["I"].extend({},Xr,e,{layer:i,lineStrings:t,coordinate:l});const{altitude:h,topColor:u,bottomColor:f,asynchronous:d}=e;let p;const A=[],g=[];if(super(),d)p=Ln(),bn.push({id:r["I"].GUID(),layer:i,key:e.key,center:l,data:o,lineStrings:t,baseObject:this,option:e});else{const s=[];let h=0,d=0,A=0;const m={},y={};for(let n=0;n<a;n++){const a=t[n],c=r["I"].extend({},e,xe(a),{index:n}),{height:u,width:f,bottomHeight:p}=c,v=ue(f,i,m),x=fe(u,i,y),b=o[n],w=[];let _=0;for(let t=0,e=b.length;t<e;t++){const e=Fe(b[t],v,x,i,l);_=pe(e,p,i,m),w.push(e)}const M=kn(w);s.push(M);const{position:T,normal:S,indices:I}=M,C=I.length/3;h+=C;const O=T.length/3,E=S.length/3;g[n]={position:{middleZ:_+x/2,count:O,start:d,end:d+3*O},hide:!1},d+=3*O,A+=3*E}p=Pn(s),u&&(Te(p,f,u,g),n.vertexColors=c())}this._initOptions(e),this._createMesh(p,n);const m=i.altitudeToVector3(h,h).x,y=i.coordinateToVector3(l,m);this.getObject3d().position.copy(y),this._baseObjects=A,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this._geometryCache=Dn(p),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(A),d||(this._setPickObject3d(),this._init()),this.type="ExtrudeLines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,k(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new er(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Nn(t);this._geometryCache=Dn(n);const{topColor:r,bottomColor:i,bottomHeight:s,height:o}=this.getOptions(),a=this.getObject3d(),l=a.material;if(r&&(Te(n,i,r,e),l.vertexColors=c()),this.getObject3d().geometry=n,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}}var Yr=Qr;const Zr={altitude:0,colors:null};class Kr extends(Mr(I)){constructor(t,e,n,s){Array.isArray(t)||(t=[t]);const a=[],l=[],h=t.length;for(let r=0;r<h;r++){const e=t[r],n=ze(e);a.push(n.center),l.push(n.lineStrings)}const c=de(a);e=r["I"].extend({},Zr,e,{layer:s,lineStrings:t,coordinate:c}),super(),this._initOptions(e);const{asynchronous:u}=e;let f;const d=[],p={};let A=0,g=[],m=0,y=[];if(u)f=Ve(),_n.push({id:r["I"].GUID(),layer:s,key:e.key,center:c,data:l,lineStrings:t,baseObject:this,option:e});else{for(let n=0;n<h;n++){const t=l[n];let i=0;for(let n=0,a=t.length;n<a;n++){const o=xe(t[n]),a=r["I"].extend({},e,o),{positions:l}=Re(t[n],s,c,!1);pe(l,a.bottomHeight,s,p),i+=l.length/3*2-2,y.push(Be(l))}const o=i;A+=o,g[n]={position:{count:i,start:m,end:m+3*i},hide:!1},m+=3*i}const t=He(y);f=new i["BufferGeometry"],o(f,"position",new i["BufferAttribute"](t,3))}this._createLineSegments(f,n);const{altitude:v}=e,x=s.altitudeToVector3(v,v).x,b=s.coordinateToVector3(c,x);this.getObject3d().position.copy(b),this._baseObjects=d,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=f.clone(),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(d),u||(this._setPickObject3d(),this._init()),this.type="Lines"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r["I"].extend({},this.getOptions(),{index:t},k(e)?e.properties:e.getProperties());this._baseObjects[t]=new Jn(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_setPickObject3d(){if(!this._colorMap)return;const t=this._geometryCache||this.getObject3d().geometry.clone(),e=this.getLayer().getPick(),{_geometriesAttributes:n}=this,r=n.length,s=Ae(n);let a=0;for(let i=0;i<r;i++){const t=e.getColor(),r=t.getHex();this._colorMap[r]=i;const{count:o}=n[i].position;this._datas[i].colorIndex=r;for(let e=0;e<o;e++)s[a]=t.r,s[a+1]=t.g,s[a+2]=t.b,a+=3}o(t,"color",new i["BufferAttribute"](s,3,!0));const l=this.getObject3d().material.clone();l.color.set("#fff"),l.vertexColors=c();const h=e.getColor(),u=h.getHex(),f=new i["LineSegments"](t,l);f.position.copy(this.getObject3d().position),f["_colorIndex"]=u,this.setPickObject3d(f)}identify(t){return this.picked}_workerLoad(t){const{position:e,geometriesAttributes:n}=t;this._geometriesAttributes=n;const r=new i["BufferGeometry"];if(o(r,"position",new i["BufferAttribute"](new Float32Array(e),3)),this._computeLineDistances(r),this._geometryCache=r.clone(),this.getObject3d().geometry=r,this.getObject3d().material.needsUpdate=!0,this._setPickObject3d(),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}}var Jr=Kr;const $r=10,ti=[],ei=[];function ni(){return{waitingQueue:ti,currentQueue:ei}}function ri(t,e,n,r,i){const s={key:t,url:e,callback:n,img:r,vt:i};ei.length<$r?(ei.push(s),i.loopMessage(s)):ti.push(s)}function ii(t){const e=si(ti,t);e&&e(t)}function si(t,e){for(let n=0,r=t.length;n<r;n++){const r=t[n];if(r){const{key:i,callback:s}=r;if(e===i)return t.splice(n,1),s}}return null}function oi(t,e){if(si(ei,t),ti.length){ei.push(ti[0]),ti.splice(0,1);const t=ei[ei.length-1];e.loopMessage(t)}}const ai=document.createElement("canvas"),li=256;let hi;function ci(t,e=!1){if(hi)return hi;const n=ai.getContext("2d");return n.clearRect(0,0,li,li),n.save(),hi=ai.toDataURL(),hi}function ui(t=1,e=1){let n;return"undefined"===typeof document||(n=document.createElement("canvas"),t&&(n.width=t),e&&(n.height=e)),n}ai.width=ai.height=li;class fi extends r["H"]{constructor(t,e={}){super(r["I"].GUID(),r["I"].extend({urlTemplate:t},e)),this._opts=null,this._layer=null,this.material=null,this.getMaterial=null,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime()}isAsynchronous(){return this._opts.worker}getBaseObjects(){const t=this._loadTiles,e=[];for(let n in t){const t=this._baseObjectKeys[n];if(t&&Array.isArray(t)&&t.length)for(let n=0,r=t.length;n<r;n++)e.push(t[n])}return e}onSelectMesh(t,e){}formatBaseObjects(t,e){return[]}loopMessage(t){}getTileData(t){const{key:e,url:n,callback:i,img:s}=t;r["a"].getJSON(n,{},(function(t,n){t?(console.error(t),i(e,null,s)):i(e,n,s)}))}_getCurentTileKeys(){const t=this.getTiles().tileGrids||[],e=[],n={};for(let r=0,i=t.length;r<i;r++){const i=t[r],s=i.tiles||[];for(let t=0,r=s.length;t<r;t++){const{id:r}=s[t];e.push(r),n[r]=!0}}return{keys:e,keysMap:n}}_isLoad(){const{keys:t}=this._getCurentTileKeys(),e=Object.keys(this._renderer.tilesInView);return t.length===e.length}_layerOnLoad(){const t=(new Date).getTime(),e=t-this._layerLaodTime;if(e<20)return;this._layerLaodTime=t;const n=this._renderer.tilesInView,r=this._loadTiles,i=this._layer,s=this._baseObjectKeys,o=Object.keys(n).length,a=Object.keys(r).length,l=[];if(o&&a)for(let h in r)n[h]||s[h]&&(s[h]||[]).forEach(t=>{l.push(t)});if(l.length&&i.removeMesh(l,!1),o&&a)for(let h in n)if(!r[h])if(s[h]){const t=s[h];i.addMesh(t)}else{const{x:t,y:e,z:n}=this._getXYZOfIndex(h);this.getTileUrl(t,e,n)}this._loadTiles=Object.assign({},n),this._diffCache()}_init(){}_workerLoad(t){const e=t.target,n=e._img;n.currentCount++,n.currentCount===n.needCount&&(n.src=ci(n._key,this._opts.debug))}_generateBaseObjects(t,e,n){if(e&&n){const{keysMap:r}=this._getCurentTileKeys();if(!r[t])return void(n.src=ci(t,this._opts.debug));const i=this.formatBaseObjects(t,e);if(i.length){n.needCount=i.length,n.currentCount=0;for(let e=0,r=i.length;e<r;e++){const r=i[e];r._img=n,r._vt=this,this.isVisible()||r.hide(),this._cachetile(t,r),r.isAsynchronous()||n.currentCount++}this._layer.addMesh(i,!1),n.needCount===n.currentCount&&(n.src=ci(t,this._opts.debug)),this.isAsynchronous()?i.filter(t=>t.isAsynchronous()).forEach(t=>{t.on("workerload",this._workerLoad,this)}):n.src=ci(t,this._opts.debug)}else n.src=ci(t,this._opts.debug);this._loadTiles[t]=!0}else n&&(n.src=ci(t,this._opts.debug))}_diffCache(){if(Object.keys(this._baseObjectKeys).length>this._renderer.tileCache.max){const t=this._renderer.tileCache.data,e=this._renderer.tilesInView,n=[];for(let r in this._baseObjectKeys)t[r]||e[r]||((this._baseObjectKeys[r]||[]).forEach(t=>{t.isAdd&&n.push(t)}),this._diposeBaseObject(r),delete this._baseObjectKeys[r]);n.length&&this._layer.removeMesh(n,!1)}}_diposeBaseObject(t){const e=this._baseObjectKeys[t];e&&e.length&&e.forEach(t=>{t.getObject3d().geometry.dispose(),t._geometryCache&&t._geometryCache.dispose();const e=t._baseObjects;e&&e.length&&e.forEach(t=>{t.getObject3d().geometry.dispose(),t=null}),t._datas=null,t._geometriesAttributes=null,t._faceMap=null,t._colorMap=null,t.pickObject3d&&t.pickObject3d.geometry.dispose(),t=null})}_cachetile(t,e){this._baseObjectKeys[t]||(this._baseObjectKeys[t]=[]),this._baseObjectKeys[t].push(e)}_getXYZOfIndex(t){const e=t.indexOf("_")>-1?"_":"-";let[n,r,i]=t.split(e).slice(1,4);const s=parseInt(r),o=parseInt(n),a=parseInt(i);return{x:s,y:o,z:a}}_getTileExtent(t,e,n){const r=this.getMap(),i=r._getResolution(n),s=this._getTileConfig(),o=s.getTilePrjExtent(t,e,i);return o}_getTileLngLatExtent(t,e,n){const i=this._getTileExtent(t,e,n);let s=i.getMax(),o=i.getMin();const a=this.getMap(),l=a.getProjection();return o=l.unproject(o),s=l.unproject(s),new r["k"](o,s)}}var di=fi;const pi={worker:!1};class Ai extends di{constructor(t,e={},n,i){super(r["I"].GUID(),r["I"].extend({urlTemplate:t},pi,e)),this._opts=e,this._layer=i,this.getMaterial=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._layerLaodTime=(new Date).getTime(),this._init()}formatBaseObjects(t,e){const n=this._opts,s=[],o=this.isAsynchronous();for(let a in e){const l=e[a]||{};let h;if(Array.isArray(l)?h=l:"FeatureCollection"===l.type&&(h=l.features),h&&h.length){const e=[],c=[],u=[];for(let t=0,n=h.length;t<n;t++){const n=h[t];if(P(n))e.push(n);else if(k(n)){const t=L(n);for(let e=0,n=t.length;e<n;e++)c.push(t[e])}else if(R(n)){const t=L(n);for(let e=0,n=t.length;e<n;e++)u.push(r["I"].extend({},t[e].properties,t[e],{coordinate:D(t[e])}))}}if(e.length){const i=this._getMaterial(a,e,t,l);if(i){const l=this._layer.toExtrudePolygons(e,r["I"].extend({},{topColor:"#fff",layerName:a,asynchronous:o,key:t},n),i);s.push(l)}}if(c.length){const e=this._getMaterial(a,c,t,l);if(e&&(e instanceof i["LineBasicMaterial"]||e instanceof i["LineDashedMaterial"])){const t=this._layer.toLines(c,r["I"].extend({},{layerName:a,asynchronous:o},n),e);s.push(t)}}if(u.length){const e=this._getMaterial(a,u,t,l);if(e&&e instanceof i["PointsMaterial"]){const t=this._layer.toPoints(u,r["I"].extend({},{layerName:a,asynchronous:o},n),e);s.push(t)}}}}return s}loopMessage(t){const{currentQueue:e}=ni();e.length>0&&this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval(()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")},1e3)}),this.on("remove",()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)}),this.on("show",()=>{const t=this.getBaseObjects();t.forEach(t=>{t.show()});for(let e in this._baseObjectKeys){const t=this._baseObjectKeys[e]||[];t.forEach(t=>{t.show()})}}),this.on("hide",()=>{const t=this.getBaseObjects();t.forEach(t=>{t.hide()});for(let e in this._baseObjectKeys){const t=this._baseObjectKeys[e]||[];t.forEach(t=>{t.hide()})}}),this.on("renderercreate",t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e["width"],n.height=e["height"],n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t["url"],t.id),n},t.renderer.deleteTile=function(t){if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{};ii(e.id)},t.renderer.loadTileImage=(t,e,n)=>{t._key=n,ri(n,e,(t,e,n)=>{this._generateBaseObjects(t,e,n),oi(t,this)},t,this)}})}_getMaterial(t,e,n,i){return this.getMaterial&&r["I"].isFunction(this.getMaterial)?this.getMaterial(t,e,n,i):null}}var gi=Ai;function mi(t,e,n,r){const i=t/n,s=e/r,o=-t/2,a=e/2,l=-e/2,h=(n+1)*(r+1),c=new Float32Array(3*h),u=new Float32Array(2*h),f=new Float32Array(3*h),d=new Uint32Array(10*h);let p=0,A=0,g=0;for(let y=0;y<=r;y++)for(let h=0;h<=n;h++){const m=o+i*h,v=a-s*y;c[p]=m,c[p+1]=v,c[p+2]=0,f[p]=0,f[p+1]=0,f[p+2]=1;const x=(m-o)/t,b=(v-l)/e;if(u[A]=x,u[A+1]=b,p+=3,A+=2,h<n&&y<r){const t=y*(n+1)+h,e=t+1,r=(n+1)*(y+1)+h,i=r+1;d[g]=t,d[g+1]=r,d[g+2]=e,d[g+3]=r,d[g+4]=i,d[g+5]=e,g+=6}}const m=new Uint32Array(g);for(let y=0,v=m.length;y<v;y++)m[y]=d[y];return{position:c,uv:u,normal:f,indexs:m}}function yi(t,e,n,r){const{position:s,uv:a,normal:l,indexs:h}=mi(t,e,n,r),c=new i["BufferGeometry"];return o(c,"position",new i["BufferAttribute"](s,3)),o(c,"normal",new i["BufferAttribute"](l,3)),o(c,"uv",new i["BufferAttribute"](a,2)),c.setIndex(new i["BufferAttribute"](h,1)),c}const vi=new i["TextureLoader"],xi=document.createElement("canvas"),bi=256;function wi(t,e=bi,n=bi){xi.width=e,xi.height=n;const r=xi.getContext("2d");return r.drawImage(t,0,0,e,n),r.getImageData(0,0,e,n).data}function _i(t){if(!t)return null;let e;return"string"===typeof t?(e=new Image,e.src=t):t instanceof HTMLCanvasElement?(e=new Image,e.src=t.toDataURL()):t instanceof Image&&(e=new Image,e.src=t.src,e.crossOrigin=t.crossOrigin),e&&!e.crossOrigin&&(e.crossOrigin="Anonymous"),e}const Mi=new Map;function Ti(t,e,n,r){if(!e||!n)return;const{imageWidth:s,imageHeight:o,flaserBoundary:a}=r;let l;if(l=t instanceof Uint32Array||t instanceof Uint8ClampedArray?t:wi(t,s,o),!l)return void console.error("image is error type data",t);let h=0,c=0,u=0;const f=()=>0===c||c+1===o||0===u||u+1===s,d=new i["Vector3"],p=Mi;for(let i=0,A=l.length;i<A;i+=4){const t=l[i],r=l[i+1],o=l[i+2],A=.1*(256*t*256+256*r+o)-1e4;let g=0;if(!f()||!a){const t=p.get(A);void 0!==t?g=t:(g=n.altitudeToVector3(A,A,null,d).x,p.set(A,g))}e.attributes.position.array[3*h+2]=g,h++,u++,u===s&&(c++,u=0)}e.attributes.position.needsUpdate=!0}const Si={interactive:!1,altitude:0,image:null,imageWidth:256,imageHeight:256,texture:null,flaserBoundary:!0,bufferPixel:1};class Ii extends I{constructor(t,e,n,i){e=r["I"].extend({},Si,e,{layer:i,extent:t});const{texture:s,image:o,altitude:a,imageHeight:l,imageWidth:h,flaserBoundary:c,bufferPixel:u}=e;t instanceof r["k"]||(t=new r["k"](t));const{xmin:f,ymin:d,xmax:p,ymax:A}=t,g=[[f,d],[f,A],[p,A],[p,d]];let m=1/0,y=1/0,v=-1/0,x=-1/0;g.forEach(t=>{const e=i.coordinateToVector3(t),{x:n,y:r}=e;m=Math.min(n,m),y=Math.min(r,y),v=Math.max(n,v),x=Math.max(r,x)});const b=v-m,w=x-y,_=b/h,M=w/l;m-=_*u,v+=_*u,y-=M*u,x+=M*u;const T=Math.abs(v-m),S=Math.abs(x-y),I=_i(o),C=_i(s),O=yi(T,S,h-1,l-1);super(),this._initOptions(e),this._createMesh(O,n);const E=i.altitudeToVector3(a,a).x,P=i.coordinateToVector3(t.getCenter(),E);this.getObject3d().position.copy(P),n.transparent=!0,I&&(I.onload=()=>{Ti(I,O,i,{imageWidth:h,imageHeight:l,flaserBoundary:c}),this.fire("dataload",{})},I.onerror=function(){console.error("not load "+I.src),this.fire("dataerror",{})}),C?(n.opacity=0,vi.load(C.src,t=>{n.map=t,n.opacity=1,n.needsUpdate=!0,this.fire("textureload",{})})):n.opacity=1,this.type="Terrain"}updateData(t){const e=this.getObject3d().geometry,n=this.getLayer();return Ti(t,e,n,this.getOptions()),this.fire("updatedata",{}),this}}var Ci=Ii;const Oi={scale:1,tileDivisor:4};class Ei extends di{constructor(t,e={},n,i){super(r["I"].GUID(),r["I"].extend({urlTemplate:t},Oi,e)),this._opts=e,this._layer=i,this.material=n,this._baseObjectKeys={},this._loadTiles={},this._add=null,this._imgQueue={},this._layerLaodTime=(new Date).getTime(),this._init()}isAsynchronous(){return!1}formatBaseObjects(t,e){const n=this.options,r=[],{scale:i,tileDivisor:s}=n,{x:o,y:a,z:l}=this._getXYZOfIndex(t),h=this.getMap().getZoom(),c=this.getTileUrl(o,a,l),[u,f]=this.options.tileSize,d=this._getTileLngLatExtent(o,a,l),p=this.material.clone();if(l+1>=Math.round(h)){const t=new Ci(d,{image:e,imageWidth:u/s,imageHeight:f/s,texture:c},p,this._layer);t.getObject3d().scale.set(i,i,1),r.push(t)}return r}loopMessage(t){this.getTileData(t)}_init(){this.on("layerload",this._layerOnLoad),this.on("add",()=>{if(!1===this._add){const t=this.getBaseObjects();this._layer.addMesh(t)}this._add=!0,this.intervalId=setInterval(()=>{this._isLoad()&&!this._layer.getMap().isInteracting()&&this.fire("layerload")},1e3)}),this.on("remove",()=>{this._add=!1;const t=this.getBaseObjects();this._layer.removeMesh(t),clearInterval(this.intervalId)}),this.on("show",()=>{const t=this.getBaseObjects();t.forEach(t=>{t.show()});for(let e in this._baseObjectKeys){const t=this._baseObjectKeys[e]||[];t.forEach(t=>{t.show()})}}),this.on("hide",()=>{const t=this.getBaseObjects();t.forEach(t=>{t.hide()});for(let e in this._baseObjectKeys){const t=this._baseObjectKeys[e]||[];t.forEach(t=>{t.hide()})}}),this.on("renderercreate",t=>{t.renderer.loadTile=function(t){var e=this.layer.getTileSize(),n=new Image;return n.width=e["width"],n.height=e["height"],n.onload=this.onTileLoad.bind(this,n,t),n.onerror=this.onTileError.bind(this,n,t),this.loadTileImage(n,t["url"],t.id),n},t.renderer.deleteTile=t=>{if(!t||!t.image)return;t.image.onload=null,t.image.onerror=null;const e=t.info||{},n=this._imgQueue[e.id];n&&(n.src="",n.onload=null,n.onerror=null,delete this._imgQueue[e.id])},t.renderer.loadTileImage=(t,e,n)=>{t._key=n;const r=new Image;this._imgQueue[n]=r;const i={key:n,url:e,rgbImage:r,callback:(t,e,n)=>{this._generateBaseObjects(t,e,n)},img:t,vt:this};this.loopMessage(i)}})}}var Pi=Ei;
/*!
 * Code from baidu mapv
 * License: BSD-3
 * https://github.com/huiyan-fe/mapv
 *
 */function ki(t){t=t||{},this.gradient=t.gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}ki.prototype.setMax=function(t){this.max=t||100},ki.prototype.setMin=function(t){this.min=t||0},ki.prototype.setMaxSize=function(t){this.maxSize=t||35},ki.prototype.setMinSize=function(t){this.minSize=t||0},ki.prototype.initPalette=function(){var t=this.gradient,e=ui(256,1),n=this.paletteCtx=e.getContext("2d"),r=n.createLinearGradient(0,0,256,1);for(var i in t)r.addColorStop(parseFloat(i),t[i]);n.fillStyle=r,n.fillRect(0,0,256,1)},ki.prototype.getColor=function(t){var e=this.getImageData(t);return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]/256+")"},ki.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var n=this.max,r=this.min;t>n&&(t=n),t<r&&(t=r);var i=4*Math.floor((t-r)/(n-r)*255);return[e[i],e[i+1],e[i+2],e[i+3]]},ki.prototype.getSize=function(t){var e=0,n=this.max,r=this.min,i=this.maxSize,s=this.minSize;return t>n&&(t=n),t<r&&(t=r),n>r?(e=s+(t-r)/(n-r)*(i-s),e):i},ki.prototype.getLegend=function(t){var e=this.gradient,n=t.width||20,r=t.height||180,i=ui(n,r),s=i.getContext("2d"),o=s.createLinearGradient(0,r,0,0);for(var a in e)o.addColorStop(parseFloat(a),e[a]);return s.fillStyle=o,s.fillRect(0,0,n,r),i};var Ri=ki;
/*!
 * Code from baidu mapv
 * License: BSD-3
 * https://github.com/huiyan-fe/mapv
 *
 */function Ni(t){var e=t/2,n=t+e,r=1e4,i=ui(2*n,2*n),s=i.getContext("2d");return s.shadowBlur=e,s.shadowColor="black",s.shadowOffsetX=s.shadowOffsetY=r,s.beginPath(),s.arc(n-r,n-r,t,0,2*Math.PI,!0),s.closePath(),s.fill(),i}function Di(t,e,n){var r=Fi(n),i=Li(n),s=r-i,o=n.range||null,a=0,l=1024;o&&2===o.length&&(a=(o[0]-i)/s*1024),o&&2===o.length&&(l=(o[1]-i)/s*1024);for(var h,c=n.maxOpacity||.8,u=n.minOpacity||0,f=3,d=t.length;f<d;f+=4)h=4*t[f],t[f]/256>c&&(t[f]=256*c),t[f]/256<u&&(t[f]=256*u),h&&h>=a&&h<=l?(t[f-3]=e[h],t[f-2]=e[h+1],t[f-1]=e[h+2]):t[f]=0}function Fi(t){var e=t.max||100;return e}function Li(t){var e=t.min||0;return e}function zi(t,e,n){var r=Fi(n),i=n._size||n.size||13,s=Ni(i),o=s.width/2,a=s.height/2,l=e,h={};for(var c in l.forEach((function(t){var e=void 0===t.count?1:t.count,n=Math.min(1,e/r).toFixed(2);h[n]=h[n]||[],h[n].push(t)})),h)if(!isNaN(c)){var u=h[c];t.beginPath(),n.withoutAlpha||(t.globalAlpha=c),u.forEach((function(e){var n=e.coordinate,i=void 0===e.count?1:e.count;t.globalAlpha=i/r,t.drawImage(s,n[0]-o,n[1]-a)}))}}function Bi(t,e,n){if(!(t.canvas.width<=0||t.canvas.height<=0)){var r=n.strength||.3;t.strokeStyle="rgba(0,0,0,"+r+")";var i=ui(t.canvas.width,t.canvas.height),s=i.getContext("2d");s.scale(devicePixelRatio,devicePixelRatio),n=n||{},t.save();var o=new Ri({gradient:n.gradient});if(zi(s,e,n),!n.absolute){var a=s.getImageData(0,0,t.canvas.width,t.canvas.height);Di(a.data,o.getImageData(),n),t.putImageData(a,0,0),t.restore()}o=null,i=null}}var Hi={draw:Bi,drawGray:zi,colorize:Di};const Ui={altitude:0,interactive:!1,min:0,max:100,size:13,gradient:{.25:"rgb(0,0,255)",.55:"rgb(0,255,0)",.85:"yellow",1:"rgb(255,0,0)"},gridScale:.5},ji=2048;class Vi extends I{constructor(t,e,n,s){Array.isArray(t)||(t=[t]);let a=1/0,l=1/0,h=-1/0,u=-1/0;const f=[];for(let r=0,i=t.length;r<i;r++){const{coordinate:e,lnglat:n,xy:i}=t[r],o=e||n||i;if(!o){console.warn("not find coordinate");continue}const c=s.coordinateToVector3(o);f.push(c);const{x:d,y:p}=c;a=Math.min(a,d),l=Math.min(l,p),h=Math.max(h,d),u=Math.max(u,p)}e=r["I"].extend({},Ui,e,{layer:s,points:t});let{gridScale:d,altitude:p,size:A}=e;const g=Math.abs(h-a),m=Math.abs(u-l),y=Math.max(g*d,m*d);if(y>ji){console.warn(`gridScale: ${d} it's too big. I hope it's a smaller value,canvas max size is ${ji}* ${ji}`);const t=y/d;d=ji/t}let v=Math.ceil(g*d),x=Math.ceil(m*d);const b=v/g,w=x/m,_=[],M=Math.ceil(2*A);for(let r=0,i=f.length;r<i;r++){const e=f[r];e.x-=a,e.y-=l,e.x*=b,e.y*=w,e.y=x-e.y,e.x+=M,e.y+=M,_.push({coordinate:[e.x,e.y],count:t[r].count})}v+=2*M,x+=2*M;let T=ui(v,x),S=T.getContext("2d");Hi.drawGray(S,_,e);const I=S.getImageData(0,0,S.canvas.width,S.canvas.height);let C=-1/0;const O=new Float32Array(I.data.length/4),E=new Float32Array(I.data.length/4);for(let r=3,i=I.data.length,o=0;r<i;r+=4){const t=I.data[r];C=Math.max(C,t),E[o]=t,t<=0&&(O[o]=1),o++}const P=new Ri({gradient:e.gradient});Hi.colorize(I.data,P.getImageData(),e),T=null,S=null;const k=yi(g,m,v-1,x-1),R=k.getIndex().array,N=k.attributes.position.array,D=new Float32Array(N.length),F=new Uint32Array(6*N.length),L=new i["Color"];let z=0;for(let r=0,i=N.length,o=0,c=R.length,U=0,j=I.data.length,V=0;r<Math.max(i,c,j);r+=3){if(r<i){const t=E[V];t>0&&(N[r+2]=t/C)}if(o<c){const t=R[o],e=R[o+1],n=R[o+2];O[t]&&O[e]&&O[n]||(F[z]=t,F[z+1]=e,F[z+2]=n,z+=3)}if(U<j){const t=I.data[U],e=I.data[U+1],n=I.data[U+2],r=`rgb(${t},${e},${n})`;L.setStyle(r),D[o]=L.r,D[o+1]=L.g,D[o+2]=L.b}o+=3,U+=4,V++}const B=new Uint32Array(z);for(let r=0;r<z;r++)B[r]=F[r];k.setIndex(new i["BufferAttribute"](B,1)),o(k,"color",new i["BufferAttribute"](D,3,!0)),n.vertexColors=c(),super(),this._initOptions(e),this._createMesh(k,n);const H=s.altitudeToVector3(p,p).x;this.getObject3d().position.copy(new i["Vector3"]((a+h)/2,(l+u)/2,H)),this.type="HeatMap"}}var Gi=Vi;const qi=new i["Color"];let Wi=1;class Xi{constructor(t){this.object3ds=[],this.layer=t,this.camera=t.getCamera(),this.renderer=t.getThreeRenderer(),this.pickingTexture=new i["WebGLRenderTarget"](1,1),this.pickingScene=new i["Scene"]}getColor(){return qi.setHex(Wi),Wi++,qi}add(t){if(t){const e=t["_colorIndex"];e&&(this.object3ds[e]=t,this.pickingScene.add(t))}return this}remove(t){if(t){const e=t["_colorIndex"];e&&(this.object3ds[e]=null,this.pickingScene.remove(t))}return this}isEmpty(){if(0===this.pickingScene.children.length)return!0;for(let t=0,e=this.pickingScene.children.length;t<e;t++){const e=this.pickingScene.children[t];if(e){const t=e["__parent"];if(t&&!0===t.getOptions().interactive)return!1}}return!0}pick(t){if(!t)return;if(this.isEmpty())return;const{camera:e,renderer:n,pickingTexture:r,pickingScene:i,object3ds:s,layer:o}=this,a=this.pickingScene.children.length;for(let b=0;b<a;b++){const t=this.pickingScene.children[b];t&&t["__parent"]&&(t["__parent"].picked=!1)}const{width:l,height:h}=o._getRenderer().canvas,c=r.width,u=r.height;l===c&&h===u||r.setSize(l,h),n.setRenderTarget(r),n.clear(),e&&e.layers&&this.camera.layers.set(0),n.render(i,e);const f=new Uint8Array(4),{x:d,y:p}=t;let A=window.devicePixelRatio;const g=o.getMap();g&&(A=g.getDevicePixelRatio?g.getDevicePixelRatio():g.options.devicePixelRatio);const m=d*A,y=r.height-p*A;n.readRenderTargetPixels(r,Math.round(m),Math.round(y),1,1,f);const v=f[0]<<16|f[1]<<8|f[2],x=s[v];if(x)x["__parent"]&&(s[v]["__parent"].picked=!0);else for(let b=0;b<a;b++){const t=this.pickingScene.children[b];if(t&&t["__parent"]){const e=t["__parent"];if(e._colorMap&&null!=e._colorMap[v]){e.picked=!0,e.index=e._colorMap[v];break}}}n.setRenderTarget(null)}}var Qi=Xi;const Yi={bottomHeight:0,altitude:0};class Zi extends I{constructor(t,e,n,i){e=r["I"].extend({},Yi,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{asynchronous:s}=e,{lineStrings:o,center:a}=ze(t),l=new b;let h;if(s){const e=r["I"].GUID();this.getOptions().id=e,this.getOptions().center=a,Mn.push({id:e,data:o,lineString:t,center:a,layer:i,baseObject:this})}else{const t=[],n={};for(let r=0,s=o.length;r<s;r++){const s=Re(o[r],i,a,!1).positions;pe(s,e.bottomHeight,i,n),t.push(Be(s))}h=He(t),l.setPositions(h)}this._setMaterialRes(i,n),this._createLine2(l,n);const{altitude:c}=e,u=i.altitudeToVector3(c,c).x,f=i.coordinateToVector3(a,u);this.getObject3d().position.copy(f),s||(this._setPickObject3d(h,n.linewidth),this._init()),this.type="FatLine"}_init(){const t=this.getLayer().getPick();this.on("add",()=>{t.add(this.pickObject3d)}),this.on("remove",()=>{t.remove(this.pickObject3d)})}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const r=n.getSize(),i=r.width,s=r.height;e.resolution.set(i,s)}_setPickObject3d(t,e){const n=new b;n.setPositions(t);const r=this.getLayer().getPick(),i=r.getColor(),s=[];for(let h=0,c=t.length/3;h<c;h++)s.push(i.r,i.g,i.b);n.setColors(s);const o=new m({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),o);const a=i.getHex(),l=new _(n,o);l.position.copy(this.getObject3d().position),l._colorIndex=a,this.setPickObject3d(l)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof i["Material"]){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,r=e.height;t.resolution.set(n,r),this.getObject3d().material=t}return this}_workerLoad(t){const e=new Float32Array(t.position),n=this.getObject3d();if(n.geometry.setPositions(e),n.computeLineDistances(),this._setPickObject3d(e,n.material.linewidth),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;const e=this.getObject3d(),n=this.getPickObject3d();[e,n].forEach(e=>{e&&this._setMaterialRes(t,e.material)})}}var Ki=Zi;const Ji={altitude:0,colors:null};class $i extends(Mr(I)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let r=0;r<a;r++){const e=t[r],n=ze(e);s.push(n.center),o.push(n.lineStrings)}const l=de(s);e=r["I"].extend({},Ji,e,{layer:i,lineStrings:t,coordinate:l}),super(),this._initOptions(e);const{asynchronous:h}=e,c=new b,u=[],f={};let d,p,A=0,g=[],m=0,y=[];if(h)Tn.push({id:r["I"].GUID(),data:o,key:e.key,center:l,layer:i,baseObject:this,lineStrings:t,option:e});else{for(let t=0;t<a;t++){const n=o[t];let s=0;for(let t=0,o=n.length;t<o;t++){const o=xe(n[t]),a=r["I"].extend({},e,o),{positions:h}=Re(n[t],i,l,!1);pe(h,a.bottomHeight,i,f),s+=h.length/3*2-2,y.push(Be(h))}const a=s;A+=a,g[t]={position:{count:s,start:m,end:m+3*s},instanceStart:{count:s,start:m,end:m+3*s},instanceEnd:{count:s,start:m,end:m+3*s},hide:!1},m+=3*s}d=He(y),c.setPositions(d)}this._setMaterialRes(i,n),this._createLine2(c,n);const{altitude:v}=e,x=i.altitudeToVector3(v,v).x,w=i.coordinateToVector3(l,x);this.getObject3d().position.copy(w),this._baseObjects=u,this._datas=t,this._geometriesAttributes=g,this.faceIndex=null,this.index=null,this._geometryCache=new b,h||(p=new Float32Array(d),this._geometryCache.setPositions(p)),this._colorMap={},this.isHide=!1,this._initBaseObjectsEvent(u),h||(this._setPickObject3d(p,n.linewidth),this._init()),this.type="FatLines"}_setMaterialRes(t,e){const n=t.getMap();if(!n)return this;const r=n.getSize(),i=r.width,s=r.height;e.resolution.set(i,s)}_setPickObject3d(t,e){if(!this._colorMap)return;const n=this._geometryCache||new b;n.setPositions(t);const r=this.getLayer().getPick(),{_geometriesAttributes:i}=this,s=Ae(i);let o=0;for(let c=0,f=i.length;c<f;c++){const t=r.getColor(),e=t.getHex();this._colorMap[e]=c;const{count:n}=i[c].position;this._datas[c].colorIndex=e;for(let r=0;r<n;r++)s[o]=t.r,s[o+1]=t.g,s[o+2]=t.b,o+=3}n.setColors(s);const a=new m({color:"#fff",linewidth:e,vertexColors:c()});this._setMaterialRes(this.getLayer(),a);const l=r.getColor(),h=l.getHex(),u=new _(n,a);u.position.copy(this.getObject3d().position),u._colorIndex=h,this.setPickObject3d(u)}identify(t){return this.picked}setSymbol(t){if(t&&t instanceof i["Material"]){t.needsUpdate=!0;const e=this.getMap().getSize(),n=e.width,r=e.height;t.resolution.set(n,r),this.getObject3d().material=t}return this}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=r["I"].extend({},this.getOptions(),{index:t},k(e)?e.properties:e.getProperties());this._baseObjects[t]=new Ki(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}_updateAttribute(t,e){const{indexs:n}=this._getHideGeometryIndex(e),r=this._geometryCache.attributes[e].array,i=r.length;for(let o=0;o<i;o++)t.array[o]=r[o];let s=-1e5;for(let o=0;o<n.length;o++){const r=n[o],{start:i,end:a}=this._geometriesAttributes[r][e];for(let e=i;e<a;e++)t.array[e]=s}return this}_showGeometry(t,e){let n;if(t&&(n=t.getOptions().index),null!=n){const t=this._geometriesAttributes[n],{hide:r}=t;if(r===e)return this;t.hide=e;const i=this.getObject3d().geometry;this._updateAttribute(i.attributes.instanceStart,"instanceStart"),this._updateAttribute(i.attributes.instanceEnd,"instanceEnd"),i.attributes.instanceStart.data.needsUpdate=!0,i.attributes.instanceEnd.data.needsUpdate=!0,this.isHide=e}return this}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=this.getObject3d(),r=new Float32Array(t.position),i=new Float32Array(r);if(n.geometry.setPositions(new Float32Array(r)),this._geometryCache.setPositions(i),this._setPickObject3d(i,n.material.linewidth),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}_animation(){const t=this.getLayer();if(!t)return this;const e=this.getObject3d(),n=this.getPickObject3d();[e,n].forEach(e=>{e&&this._setMaterialRes(t,e.material)})}}var ts=$i;const es={radius:10,height:100,altitude:0,topColor:"",bottomColor:"#2d2f61",heightEnable:!0};class ns extends I{constructor(t,e,n,i){e=r["I"].extend({},es,e,{layer:i,coordinate:t}),super(),this._initOptions(e);const{height:s,radius:o,topColor:a,bottomColor:l,altitude:h}=e,u=i.altitudeToVector3(s,s).x,f=i.distanceToVector3(o,o).x,d=qn().clone();d.scale(2*f,2*f,u),a&&(Vn(d,l,a,"z",u/2),n.vertexColors=c()),this._createMesh(d,n);const p=i.altitudeToVector3(h,h).x,A=i.coordinateToVector3(t,p);this.getObject3d().position.copy(A),this.type="Box"}}var rs=ns;class is extends(Mr(I)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=t.length,o=de(t),a=i.coordinateToVector3(o),l=[],h=[],u=[];let f=0,d=0,p=0,A=0;e=r["I"].extend({},{altitude:0,layer:i,points:t},e);const g={},m={};for(let w=0;w<s;w++){const s=r["I"].extend({index:w},e,t[w]),{radius:o,altitude:y,topColor:v,bottomColor:x,height:b,coordinate:_}=s,M=ue(o,i,g),T=fe(b,i,m),S=fe(y,i,m),I=qn().clone();I.scale(2*M,2*M,T),v&&(Vn(I,x,v,"z",T/2),n.vertexColors=c());const C=i.coordinateToVector3(_).sub(a),O=I.attributes.position.array;for(let t=0,e=O.length;t<e;t+=3)O[t+2]+=S,O[t]+=C.x,O[t+1]+=C.y,O[t+2]+=C.z;l.push(I);const E=new rs(_,s,n,i);h.push(E);const P=I.index.count/3;f+=P;const k=I.attributes.position.count,R=I.attributes.normal.count,N=I.attributes.uv.count;u[w]={position:{count:k,start:d,end:d+3*k},hide:!1},d+=3*k,p+=3*R,A+=2*N}super(),this._initOptions(e);const y=Gn(l);this._createMesh(y,n);const v=e.altitude,x=i.altitudeToVector3(v,v).x,b=a.clone();b.z=x,this.getObject3d().position.copy(b),this._baseObjects=h,this._datas=t,this._geometriesAttributes=u,this.faceIndex=null,this._geometryCache=Dn(y),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(h),this._setPickObject3d(),this._init(),this.type="Boxs"}identify(t){return this.picked}}var ss=is;n("5875");const os='(function(t){"use strict";\n/*!\n   * poly-extrude v0.3.0\n    */var n={exports:{}};function r(t,n,r){r=r||2;var e,o,a,h,u,v,f,x=n&&n.length,d=x?n[0]*r:t.length,y=i(t,0,d,r,!0),g=[];if(!y||y.next===y.prev)return g;if(x&&(y=function(t,n,r,e){var s,o,a,h=[];for(s=0,o=n.length;s<o;s++)(a=i(t,n[s]*e,s<o-1?n[s+1]*e:t.length,e,!1))===a.next&&(a.steiner=!0),h.push(p(a));for(h.sort(c),s=0;s<h.length;s++)r=l(h[s],r);return r}(t,n,y,r)),t.length>80*r){e=a=t[0],o=h=t[1];for(var m=r;m<d;m+=r)(u=t[m])<e&&(e=u),(v=t[m+1])<o&&(o=v),u>a&&(a=u),v>h&&(h=v);f=0!==(f=Math.max(a-e,h-o))?32767/f:0}return s(y,g,r,e,o,f,0),g}function i(t,n,r,i,e){var s,o;if(e===V(t,n,r,i)>0)for(s=n;s<r;s+=i)o=A(s,t[s],t[s+1],o);else for(s=r-i;s>=n;s-=i)o=A(s,t[s],t[s+1],o);return o&&g(o,o.next)&&(P(o),o=o.next),o}function e(t,n){if(!t)return t;n||(n=t);var r,i=t;do{if(r=!1,i.steiner||!g(i,i.next)&&0!==y(i.prev,i,i.next))i=i.next;else{if(P(i),(i=n=i.prev)===i.next)break;r=!0}}while(r||i!==n);return n}function s(t,n,r,i,c,l,v){if(t){!v&&l&&function(t,n,r,i){var e=t;do{0===e.z&&(e.z=f(e.x,e.y,n,r,i)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next}while(e!==t);e.prevZ.nextZ=null,e.prevZ=null,function(t){var n,r,i,e,s,o,a,h,u=1;do{for(r=t,t=null,s=null,o=0;r;){for(o++,i=r,a=0,n=0;n<u&&(a++,i=i.nextZ);n++);for(h=u;a>0||h>0&&i;)0!==a&&(0===h||!i||r.z<=i.z)?(e=r,r=r.nextZ,a--):(e=i,i=i.nextZ,h--),s?s.nextZ=e:t=e,e.prevZ=s,s=e;r=i}s.nextZ=null,u*=2}while(o>1)}(e)}(t,i,c,l);for(var p,x,d=t;t.prev!==t.next;)if(p=t.prev,x=t.next,l?a(t,i,c,l):o(t))n.push(p.i/r|0),n.push(t.i/r|0),n.push(x.i/r|0),P(t),t=x.next,d=x.next;else if((t=x)===d){v?1===v?s(t=h(e(t),n,r),n,r,i,c,l,2):2===v&&u(t,n,r,i,c,l):s(e(t),n,r,i,c,l,1);break}}}function o(t){var n=t.prev,r=t,i=t.next;if(y(n,r,i)>=0)return!1;for(var e=n.x,s=r.x,o=i.x,a=n.y,h=r.y,u=i.y,c=e<s?e<o?e:o:s<o?s:o,l=a<h?a<u?a:u:h<u?h:u,v=e>s?e>o?e:o:s>o?s:o,f=a>h?a>u?a:u:h>u?h:u,p=i.next;p!==n;){if(p.x>=c&&p.x<=v&&p.y>=l&&p.y<=f&&x(e,a,s,h,o,u,p.x,p.y)&&y(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function a(t,n,r,i){var e=t.prev,s=t,o=t.next;if(y(e,s,o)>=0)return!1;for(var a=e.x,h=s.x,u=o.x,c=e.y,l=s.y,v=o.y,p=a<h?a<u?a:u:h<u?h:u,d=c<l?c<v?c:v:l<v?l:v,g=a>h?a>u?a:u:h>u?h:u,m=c>l?c>v?c:v:l>v?l:v,z=f(p,d,n,r,i),w=f(g,m,n,r,i),M=t.prevZ,b=t.nextZ;M&&M.z>=z&&b&&b.z<=w;){if(M.x>=p&&M.x<=g&&M.y>=d&&M.y<=m&&M!==e&&M!==o&&x(a,c,h,l,u,v,M.x,M.y)&&y(M.prev,M,M.next)>=0)return!1;if(M=M.prevZ,b.x>=p&&b.x<=g&&b.y>=d&&b.y<=m&&b!==e&&b!==o&&x(a,c,h,l,u,v,b.x,b.y)&&y(b.prev,b,b.next)>=0)return!1;b=b.nextZ}for(;M&&M.z>=z;){if(M.x>=p&&M.x<=g&&M.y>=d&&M.y<=m&&M!==e&&M!==o&&x(a,c,h,l,u,v,M.x,M.y)&&y(M.prev,M,M.next)>=0)return!1;M=M.prevZ}for(;b&&b.z<=w;){if(b.x>=p&&b.x<=g&&b.y>=d&&b.y<=m&&b!==e&&b!==o&&x(a,c,h,l,u,v,b.x,b.y)&&y(b.prev,b,b.next)>=0)return!1;b=b.nextZ}return!0}function h(t,n,r){var i=t;do{var s=i.prev,o=i.next.next;!g(s,o)&&m(s,i,i.next,o)&&M(s,o)&&M(o,s)&&(n.push(s.i/r|0),n.push(i.i/r|0),n.push(o.i/r|0),P(i),P(i.next),i=t=o),i=i.next}while(i!==t);return e(i)}function u(t,n,r,i,o,a){var h=t;do{for(var u=h.next.next;u!==h.prev;){if(h.i!==u.i&&d(h,u)){var c=b(h,u);return h=e(h,h.next),c=e(c,c.next),s(h,n,r,i,o,a,0),void s(c,n,r,i,o,a,0)}u=u.next}h=h.next}while(h!==t)}function c(t,n){return t.x-n.x}function l(t,n){var r=function(t,n){var r,i=n,e=t.x,s=t.y,o=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var a=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(a<=e&&a>o&&(o=a,r=i.x<i.next.x?i:i.next,a===e))return r}i=i.next}while(i!==n);if(!r)return null;var h,u=r,c=r.x,l=r.y,f=1/0;i=r;do{e>=i.x&&i.x>=c&&e!==i.x&&x(s<l?e:o,s,c,l,s<l?o:e,s,i.x,i.y)&&(h=Math.abs(s-i.y)/(e-i.x),M(i,t)&&(h<f||h===f&&(i.x>r.x||i.x===r.x&&v(r,i)))&&(r=i,f=h)),i=i.next}while(i!==u);return r}(t,n);if(!r)return n;var i=b(r,t);return e(i,i.next),e(r,r.next)}function v(t,n){return y(t.prev,t,n.prev)<0&&y(n.next,t,t.next)<0}function f(t,n,r,i,e){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*e|0)|t<<8))|t<<4))|t<<2))|t<<1))|(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*e|0)|n<<8))|n<<4))|n<<2))|n<<1))<<1}function p(t){var n=t,r=t;do{(n.x<r.x||n.x===r.x&&n.y<r.y)&&(r=n),n=n.next}while(n!==t);return r}function x(t,n,r,i,e,s,o,a){return(e-o)*(n-a)>=(t-o)*(s-a)&&(t-o)*(i-a)>=(r-o)*(n-a)&&(r-o)*(s-a)>=(e-o)*(i-a)}function d(t,n){return t.next.i!==n.i&&t.prev.i!==n.i&&!function(t,n){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==n.i&&r.next.i!==n.i&&m(r,r.next,t,n))return!0;r=r.next}while(r!==t);return!1}(t,n)&&(M(t,n)&&M(n,t)&&function(t,n){var r=t,i=!1,e=(t.x+n.x)/2,s=(t.y+n.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&e<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==t);return i}(t,n)&&(y(t.prev,t,n.prev)||y(t,n.prev,n))||g(t,n)&&y(t.prev,t,t.next)>0&&y(n.prev,n,n.next)>0)}function y(t,n,r){return(n.y-t.y)*(r.x-n.x)-(n.x-t.x)*(r.y-n.y)}function g(t,n){return t.x===n.x&&t.y===n.y}function m(t,n,r,i){var e=w(y(t,n,r)),s=w(y(t,n,i)),o=w(y(r,i,t)),a=w(y(r,i,n));return e!==s&&o!==a||(!(0!==e||!z(t,r,n))||(!(0!==s||!z(t,i,n))||(!(0!==o||!z(r,t,i))||!(0!==a||!z(r,n,i)))))}function z(t,n,r){return n.x<=Math.max(t.x,r.x)&&n.x>=Math.min(t.x,r.x)&&n.y<=Math.max(t.y,r.y)&&n.y>=Math.min(t.y,r.y)}function w(t){return t>0?1:t<0?-1:0}function M(t,n){return y(t.prev,t,t.next)<0?y(t,n,t.next)>=0&&y(t,t.prev,n)>=0:y(t,n,t.prev)<0||y(t,t.next,n)<0}function b(t,n){var r=new S(t.i,t.x,t.y),i=new S(n.i,n.x,n.y),e=t.next,s=n.prev;return t.next=n,n.prev=t,r.next=e,e.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}function A(t,n,r,i){var e=new S(t,n,r);return i?(e.next=i.next,e.prev=i,i.next.prev=e,i.next=e):(e.prev=e,e.next=e),e}function P(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function S(t,n,r){this.i=t,this.x=n,this.y=r,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function V(t,n,r,i){for(var e=0,s=n,o=r-i;s<r;s+=i)e+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return e}n.exports=r,n.exports.default=r,r.deviation=function(t,n,r,i){var e=n&&n.length,s=e?n[0]*r:t.length,o=Math.abs(V(t,0,s,r));if(e)for(var a=0,h=n.length;a<h;a++){var u=n[a]*r,c=a<h-1?n[a+1]*r:t.length;o-=Math.abs(V(t,u,c,r))}var l=0;for(a=0;a<i.length;a+=3){var v=i[a]*r,f=i[a+1]*r,p=i[a+2]*r;l+=Math.abs((t[v]-t[p])*(t[f+1]-t[v+1])-(t[v]-t[f])*(t[p+1]-t[v+1]))}return 0===o&&0===l?0:Math.abs((l-o)/o)},r.flatten=function(t){for(var n=t[0][0].length,r={vertices:[],holes:[],dimensions:n},i=0,e=0;e<t.length;e++){for(var s=0;s<t[e].length;s++)for(var o=0;o<n;o++)r.vertices.push(t[e][s][o]);e>0&&(i+=t[e-1].length,r.holes.push(i))}return r};var Z=n.exports;function F(t){for(var n,r,i=0,e=1,s=t.length;e<s;)n=r||t[0],i+=((r=t[e])[0]-n[0])*(r[1]+n[1]),e++;return i>0}function L(t,n,r){return t[0]=n[0]-r[0],t[1]=n[1]-r[1],t[2]=n[2]-r[2],t}function _(t,n){var r=n[0],i=n[1],e=n[2],s=Math.sqrt(r*r+i*i+e*e)||1;return t[0]=r/s,t[1]=i/s,t[2]=e/s,t}function E(t,n){function r(t,n,r,i){t[0]=n,t[1]=r,t[2]=i}for(var i,e,s,o,a,h,u,c,l,v=[],f=[],p=[],x=[],d=[],y=[],g=t.length,m=new Float32Array(n.length),z=0;z<g;){var w=3*t[z],M=3*t[z+1],b=3*t[z+2];r(v,n[w],n[w+1],n[w+2]),r(f,n[M],n[M+1],n[M+2]),r(p,n[b],n[b+1],n[b+2]),L(d,p,f),L(x,v,f),i=y,s=x,o=void 0,a=void 0,h=void 0,u=void 0,c=void 0,l=void 0,o=(e=d)[0],a=e[1],h=e[2],u=s[0],c=s[1],l=s[2],i[0]=a*l-h*c,i[1]=h*u-o*l,i[2]=o*c-a*u;for(var A=0;A<3;A++)m[w+A]+=y[A],m[M+A]+=y[A],m[b+A]+=y[A];z+=3}for(var P=0,S=m.length;P<S;)r(y,m[P],m[P+1],m[P+2]),_(y,y),m[P]=y[0]||0,m[P+1]=y[1]||0,m[P+2]=y[2]||0,P+=3;return m}function I(t){if(1===t.length)return{position:t[0].position,normal:t[0].normal,uv:t[0].uv,indices:t[0].indices,results:t};for(var n=0,r=0,i=0,e=t.length;i<e;i++){var s=t[i],o=s.position,a=s.indices;n+=o.length,r+=a.length}for(var h={position:new Float32Array(n),normal:new Float32Array(n),uv:new Float32Array(n/3*2),indices:new Uint32Array(r),results:t},u=0,c=0,l=0,v=0,f=0,p=t.length;f<p;f++){var x=t[f],d=x.position,y=x.indices,g=x.normal,m=x.uv;h.position.set(d,u),h.normal.set(g,u),h.uv.set(m,v);for(var z=0,w=y.length;z<w;){var M=y[z]+c;h.indices[l]=M,l++,z++}v+=m.length,u+=d.length,c+=d.length/3}return h}function O(t){return 180*t/Math.PI}function U(t){return t/180*Math.PI}function q(t,n,r,i,e,s){var o=3*r,a=3*i,h=3*e,u=3*s,c=n[o],l=n[o+1],v=n[o+2],f=n[a],p=n[a+1],x=n[a+2],d=n[h],y=n[h+1],g=n[h+2],m=n[u],z=n[u+1],w=n[u+2];Math.abs(l-p)<Math.abs(c-f)?(t.push(c,1-v),t.push(f,1-x),t.push(d,1-g),t.push(m,1-w)):(t.push(l,1-v),t.push(p,1-x),t.push(y,1-g),t.push(z,1-w))}function R(t,n){n=Object.assign({},{depth:2},n);var r=t.map((function(t){for(var r=0,i=t.length;r<i;r++){var e=t[r];j(e),0===r?F(e)||(t[r]=e.reverse()):F(e)&&(t[r]=e.reverse()),B(e)&&e.splice(e.length-1,1)}var s=function(t,n){for(var r=function(t){var n=0,r=0,i=t.length;for(;r<i;)n+=t[r].length,r++;return n}(t),i=t.length,e=[],s=new Float32Array(2*r),o=[],a=[],h=3*r,u=2*r,c=n.depth,l=0,v=0,f=0,p=0;p<i;p++){var x=t[p];p>0&&e.push(l/2);for(var d=0,y=x.length;d<y;){var g=x[d],m=g[0],z=g[1];s[l++]=m,s[l++]=z,o[v]=m,o[v+1]=z,o[v+2]=c,o[h+v]=m,o[h+v+1]=z,o[h+v+2]=0,a[f]=m,a[f+1]=z,a[u+f]=m,a[u+f+1]=z,v+=3,f+=2,d++}}return{flatVertices:s,holes:e,points:o,count:r,uvs:a}}(t,n);return s.polygon=t,function(t,n){for(var r=[],i=t.count,e=0,s=n.length;e<s;e+=3){var o=n[e],a=n[e+1],h=n[e+2];r[e]=o,r[e+1]=a,r[e+2]=h;var u=s+e,c=i+o,l=i+a,v=i+h;r[u]=c,r[u+1]=l,r[u+2]=v}t.index=r}(s,Z(s.flatVertices,s.holes,2)),function(t,n){for(var r=t.points,i=t.index,e=t.polygon,s=t.uvs,o=n.depth,a=0,h=e.length;a<h;a++)for(var u=e[a],c=0,l=u.length;c<l;){var v=u[c],f=u[c+1];c===l-1&&(f=u[0]);var p=r.length/3,x=v[0],d=v[1],y=f[0],g=f[1];r.push(x,d,o,y,g,o,x,d,0,y,g,0);var m=p+2,z=p+3,w=p,M=p+1;i.push(m,w,z,w,M,z),q(s,r,m,z,w,M),c++}}(s,n),s.position=new Float32Array(s.points),s.indices=new Uint32Array(s.index),s.uv=new Float32Array(s.uvs),s.normal=E(s.indices,s.position),s})),i=I(r);return i.polygons=t,i}function j(t){B(t)||t.push(t[0])}function B(t){var n=t.length,r=t[0],i=r[0],e=r[1],s=t[n-1],o=s[0],a=s[1];return i===o&&e===a}function C(t,n){n=Object.assign({},{depth:2,lineWidth:1},n);var r=t.map((function(t){var r=function(t,n){var r=0,i=n.lineWidth/2,e=[],s=[],o=[],a=t.length,h=0;for(;h<a-1;){var u=t[h],c=t[h+1],l=c[1]-u[1],v=c[0]-u[0],f=0,p=O(Math.atan(l/v));if(r=p,0===h)f=p,f-=90;else{var x=t[h-1];k.x=x[0]-u[0],k.y=x[1]-u[1],H.x=c[0]-u[0],H.y=c[1]-u[1],f=p-T(k,H)/2}var d=N(U(f),i,u),y=d[0],g=d[1];e.push(y,g),W(y,u,c)?(s.push(y),o.push(g)):(s.push(g),o.push(y)),h++}var m=r,z=U(m-=90),w=t[a-2],M=t[a-1],b=N(z,i,M),A=b[0],P=b[1];e.push(A,P),W(A,w,M)?(s.push(A),o.push(P)):(s.push(P),o.push(A));return{offsetPoints:e,leftPoints:s,rightPoints:o}}(t,n);return r.line=t,function(t,n){var r=n.depth,i=[],e=[],s=[],o=t.leftPoints,a=t.rightPoints,h=0,u=o.length;for(;h<u;){var c=3*h,l=o[h],v=l[0],f=l[1],p=l[2];i[c]=v,i[c+1]=f,i[c+2]=r+p;var x=a[h],d=x[0],y=x[1],g=x[2],m=3*u+c;i[m]=d,i[m+1]=y,i[m+2]=r+g;var z=2*u*3+c;i[z]=v,i[z+1]=f,i[z+2]=p;var w=2*u*3+3*u+c;i[w]=d,i[w+1]=y,i[w+2]=g,h++}h=0,u=i.length;for(;h<u;){var M=i[h],b=i[h+1];s.push(M,b),h+=3}h=0,u=o.length;for(;h<u-1;){var A=h,P=h+1,S=A+u,V=P+u;e.push(A,S,P),e.push(S,V,P);var Z=h+2*u,F=Z+1,L=Z+u,_=F+u;e.push(Z,L,F),e.push(L,_,F),h++}t.index=e,t.points=i,t.uvs=s}(r,n),function(t,n){var r=t.points,i=t.index,e=t.leftPoints,s=t.rightPoints,o=t.uvs,a=n.depth,h=[e,s];function u(t,n){var e=r.length/3;r.push(t[0],t[1],a+t[2],n[0],n[1],a+n[2],t[0],t[1],t[2],n[0],n[1],n[2]);var s=e+2,h=e+3,u=e,c=e+1;i.push(s,u,h,u,c,h),q(o,r,s,h,u,c)}for(var c=0,l=h.length;c<l;c++){var v=h[c];c>0&&(v=(v=v.map((function(t){return t}))).reverse());for(var f=0,p=v.length-1;f<p;){u(v[f],v[f+1]),f++}}for(var x=e.length,d=[s[0],e[0],e[x-1],s[x-1]],y=0;y<d.length;y+=2){u(d[y],d[y+1])}}(r,n),r.position=new Float32Array(r.points),r.indices=new Uint32Array(r.index),r.uv=new Float32Array(r.uvs),r.normal=E(r.indices,r.position),r})),i=I(r);return i.lines=t,i}var k={x:0,y:0},H={x:0,y:0};function N(t,n,r){var i=r[0],e=r[1],s=r[2]||0,o=[i+Math.cos(t)*n,e+Math.sin(t)*n,s],a=t+=Math.PI;return[o,[i+Math.cos(a)*n,e+Math.sin(a)*n,s]]}var T=function(t,n){var r=t.x,i=t.y,e=n.x,s=n.y,o=r*e+i*s,a=r*s-i*e;return(Math.atan2(a,o)/Math.PI*180+360)%360};function W(t,n,r){var i=n[0],e=n[1],s=r[0],o=r[1];return(e-o)*t[0]+(s-i)*t[1]+i*o-s*e>0}function D(t,n){void 0===n&&(n={}),n=Object.assign({},{radius:1,height:2,radialSegments:6},n);for(var r=Math.round(Math.max(4,n.radialSegments)),i=n,e=i.radius,s=i.height,o=360/r/360*Math.PI*2,a=r+1,h=new Float32Array(3*a*2),u=t[0],c=t[1],l=0,v=0,f=3*a,p=2*a,x=[],d=[],y=-1;y<r;y++){var g=o*y,m=Math.cos(g)*e+u,z=Math.sin(g)*e+c;h[l]=m,h[l+1]=z,h[l+2]=0,h[l+f]=m,h[l+1+f]=z,h[l+2+f]=s;var w,M;w=.5+m/e/2,M=.5+z/e/2,d[v]=w,d[v+1]=M,d[v+p]=w,d[v+1+p]=M,l+=3,v+=2,y>1&&x.push(0,y-1,y)}h[l-=3]=h[0],h[l+1]=h[1],h[l+2]=h[2];var b=h.length;h[b-3]=h[0],h[b-2]=h[1],h[b-1]=s;for(var A=x.length,P=0;P<A;P++){var S=x[P];x.push(S+a)}var V=new Float32Array(2*(3*a*2-6)),Z=-1;l=2*a,v=0;for(var F=0,L=h.length/2;F<L-3;F+=3){var _=h[F],I=h[F+1],O=h[F+3],U=h[F+4];V[++Z]=_,V[++Z]=I,V[++Z]=s,V[++Z]=O,V[++Z]=U,V[++Z]=s,V[++Z]=_,V[++Z]=I,V[++Z]=0,V[++Z]=O,V[++Z]=U,V[++Z]=0;var q=l+2,R=l+3,j=l,B=l+1;x.push(j,q,B,q,R,B),l+=4;var C=v/a,k=(v+1)/a;d.push(C,s/e/2,k,s/e/2,C,0,k,0),v++}var H=new Float32Array(h.length+V.length);H.set(h,0),H.set(V,h.length);var N=E(x,H);return{points:h,indices:new Uint32Array(x),position:H,normal:N,uv:new Float32Array(d)}}var Q=function(){function t(t,n,r){void 0===t&&(t=0),void 0===n&&(n=0),void 0===r&&(r=0),this.x=t,this.y=n,this.z=r}var n=t.prototype;return n.set=function(t,n,r){return void 0===r&&(r=this.z),this.x=t,this.y=n,this.z=r,this},n.clone=function(){return new this.constructor(this.x,this.y,this.z)},n.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},n.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},n.addScalar=function(t){return this.x+=t,this.y+=t,this.z+=t,this},n.addVectors=function(t,n){return this.x=t.x+n.x,this.y=t.y+n.y,this.z=t.z+n.z,this},n.addScaledVector=function(t,n){return this.x+=t.x*n,this.y+=t.y*n,this.z+=t.z*n,this},n.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},n.subScalar=function(t){return this.x-=t,this.y-=t,this.z-=t,this},n.subVectors=function(t,n){return this.x=t.x-n.x,this.y=t.y-n.y,this.z=t.z-n.z,this},n.multiply=function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},n.multiplyScalar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},n.multiplyVectors=function(t,n){return this.x=t.x*n.x,this.y=t.y*n.y,this.z=t.z*n.z,this},n.applyMatrix4=function(t){var n=this.x,r=this.y,i=this.z,e=t.elements,s=1/(e[3]*n+e[7]*r+e[11]*i+e[15]);return this.x=(e[0]*n+e[4]*r+e[8]*i+e[12])*s,this.y=(e[1]*n+e[5]*r+e[9]*i+e[13])*s,this.z=(e[2]*n+e[6]*r+e[10]*i+e[14])*s,this},n.divide=function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},n.divideScalar=function(t){return this.multiplyScalar(1/t)},n.min=function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},n.max=function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},n.clamp=function(t,n){return this.x=Math.max(t.x,Math.min(n.x,this.x)),this.y=Math.max(t.y,Math.min(n.y,this.y)),this.z=Math.max(t.z,Math.min(n.z,this.z)),this},n.clampScalar=function(t,n){return this.x=Math.max(t,Math.min(n,this.x)),this.y=Math.max(t,Math.min(n,this.y)),this.z=Math.max(t,Math.min(n,this.z)),this},n.clampLength=function(t,n){var r=this.length();return this.divideScalar(r||1).multiplyScalar(Math.max(t,Math.min(n,r)))},n.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},n.lengthSq=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.normalize=function(){return this.divideScalar(this.length()||1)},n.setLength=function(t){return this.normalize().multiplyScalar(t)},n.lerp=function(t,n){return this.x+=(t.x-this.x)*n,this.y+=(t.y-this.y)*n,this.z+=(t.z-this.z)*n,this},n.lerpVectors=function(t,n,r){return this.x=t.x+(n.x-t.x)*r,this.y=t.y+(n.y-t.y)*r,this.z=t.z+(n.z-t.z)*r,this},n.cross=function(t){return this.crossVectors(this,t)},n.crossVectors=function(t,n){var r=t.x,i=t.y,e=t.z,s=n.x,o=n.y,a=n.z;return this.x=i*a-e*o,this.y=e*s-r*a,this.z=r*o-i*s,this},n.distanceTo=function(t){return Math.sqrt(this.distanceToSquared(t))},n.equals=function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},n.fromArray=function(t,n){return void 0===n&&(n=0),this.x=t[n],this.y=t[n+1],this.z=t[n+2],this},n.random=function(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this},t}(),X=function(){function t(){this.pos=new Q,this.dir=new Q,this.right=new Q,this.up=new Q,this.dist=0,this.widthScale=1,this.sharp=!1}var n=t.prototype;return n.lerpPathPoints=function(t,n,r){this.pos.lerpVectors(t.pos,n.pos,r),this.dir.lerpVectors(t.dir,n.dir,r),this.up.lerpVectors(t.up,n.up,r),this.right.lerpVectors(t.right,n.right,r),this.dist=(n.dist-t.dist)*r+t.dist,this.widthScale=(n.widthScale-t.widthScale)*r+t.widthScale},n.copy=function(t){this.pos.copy(t.pos),this.dir.copy(t.dir),this.up.copy(t.up),this.right.copy(t.right),this.dist=t.dist,this.widthScale=t.widthScale},t}(),G=function(){function t(t,n,r,i,e,s,o,a,h,u,c,l,v,f,p,x){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,n,r,i,e,s,o,a,h,u,c,l,v,f,p,x)}var n=t.prototype;return n.set=function(t,n,r,i,e,s,o,a,h,u,c,l,v,f,p,x){var d=this.elements;return d[0]=t,d[4]=n,d[8]=r,d[12]=i,d[1]=e,d[5]=s,d[9]=o,d[13]=a,d[2]=h,d[6]=u,d[10]=c,d[14]=l,d[3]=v,d[7]=f,d[11]=p,d[15]=x,this},n.multiply=function(t){return this.multiplyMatrices(this,t)},n.makeRotationAxis=function(t,n){var r=Math.cos(n),i=Math.sin(n),e=1-r,s=t.x,o=t.y,a=t.z,h=e*s,u=e*o;return this.set(h*s+r,h*o-i*a,h*a+i*o,0,h*o+i*a,u*o+r,u*a-i*s,0,h*a-i*o,u*a+i*s,e*a*a+r,0,0,0,0,1),this},n.equals=function(t){for(var n=this.elements,r=t.elements,i=0;i<16;i++)if(n[i]!==r[i])return!1;return!0},t}();function J(t,n){return J=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,n){return t.__proto__=n,t},J(t,n)}function K(t,n,r,i){return function(t,n){var r=1-t;return r*r*n}(t,n)+function(t,n){return 2*(1-t)*t*n}(t,r)+function(t,n){return t*t*n}(t,i)}var Y=function(t){var n,r;function i(n,r,i){var e;return void 0===n&&(n=new Q),void 0===r&&(r=new Q),void 0===i&&(i=new Q),(e=t.call(this)||this).isQuadraticBezierCurve3=!0,e.type="QuadraticBezierCurve3",e.v0=n,e.v1=r,e.v2=i,e}return r=t,(n=i).prototype=Object.create(r.prototype),n.prototype.constructor=n,J(n,r),i.prototype.getPoint=function(t,n){void 0===n&&(n=new Q);var r=n,i=this.v0,e=this.v1,s=this.v2;return r.set(K(t,i.x,e.x,s.x),K(t,i.y,e.y,s.y),K(t,i.z,e.z,s.z)),r},i}(function(){function t(){this.type="Curve",this.arcLengthDivisions=200}var n=t.prototype;return n.getPoint=function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},n.getPointAt=function(t,n){var r=this.getUtoTmapping(t);return this.getPoint(r,n)},n.getPoints=function(t){void 0===t&&(t=5);for(var n=[],r=0;r<=t;r++)n.push(this.getPoint(r/t));return n},n.getLength=function(){var t=this.getLengths();return t[t.length-1]},n.getLengths=function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var n,r=[],i=this.getPoint(0),e=0;r.push(0);for(var s=1;s<=t;s++)e+=(n=this.getPoint(s/t)).distanceTo(i),r.push(e),i=n;return this.cacheArcLengths=r,r},n.getUtoTmapping=function(t,n){var r,i=this.getLengths(),e=0,s=i.length;r=n||t*i[s-1];for(var o,a=0,h=s-1;a<=h;)if((o=i[e=Math.floor(a+(h-a)/2)]-r)<0)a=e+1;else{if(!(o>0)){h=e;break}h=e-1}if(i[e=h]===r)return e/(s-1);var u=i[e];return(e+(r-u)/(i[e+1]-u))/(s-1)},t}()),$=new Q,tt=new Q,nt=new Q,rt=new G,it=new Y;var et=function(){function t(){this.array=[],this.count=0}var n=t.prototype;return n.set=function(t,n,r,i,e){if(void 0===n&&(n=.1),void 0===r&&(r=10),void 0===i&&(i=null),void 0===e&&(e=!1),(t=t.slice(0)).length<2)return console.warn("PathPointList: points length less than 2."),void(this.count=0);e&&!t[0].equals(t[t.length-1])&&t.push((new Q).copy(t[0]));for(var s=0,o=t.length;s<o;s++)if(0===s)this._start(t[s],t[s+1],i);else if(s===o-1)if(e){this._corner(t[s],t[1],n,r,i);var a=this.array[0].dist;this.array[0].copy(this.array[this.count-1]),this.array[0].dist=a}else this._end(t[s]);else this._corner(t[s],t[s+1],n,r,i)},n.distance=function(){return this.count>0?this.array[this.count-1].dist:0},n._getByIndex=function(t){return this.array[t]||(this.array[t]=new X),this.array[t]},n._start=function(t,n,r){this.count=0;var i=this._getByIndex(this.count);if(i.pos.copy(t),i.dir.subVectors(n,t),r)i.up.copy(r);else{var e=Number.MAX_VALUE,s=Math.abs(i.dir.x),o=Math.abs(i.dir.y),a=Math.abs(i.dir.z);s<e&&(e=s,i.up.set(1,0,0)),o<e&&(e=o,i.up.set(0,1,0)),a<e&&i.up.set(0,0,1)}i.right.crossVectors(i.dir,i.up).normalize(),i.up.crossVectors(i.right,i.dir).normalize(),i.dist=0,i.widthScale=1,i.sharp=!1,i.dir.normalize(),this.count++},n._end=function(t){var n=this.array[this.count-1],r=this._getByIndex(this.count);r.pos.copy(t),r.dir.subVectors(t,n.pos);var i=r.dir.length();r.dir.normalize(),r.up.copy(n.up);var e=$.crossVectors(n.dir,r.dir);if(e.length()>Number.EPSILON){e.normalize();var s=Math.acos(Math.min(Math.max(n.dir.dot(r.dir),-1),1));r.up.applyMatrix4(rt.makeRotationAxis(e,s))}r.right.crossVectors(r.dir,r.up).normalize(),r.dist=n.dist+i,r.widthScale=1,r.sharp=!1,this.count++},n._corner=function(t,n,r,i,e){if(r>0&&i>0){for(var s=function(t,n,r,i,e,s){var o=$.subVectors(n,t),a=tt.subVectors(r,n),h=o.length(),u=a.length();o.normalize(),a.normalize();var c=Math.min(.999999*(e?h/2:h),i);s.v0.copy(n).sub(o.multiplyScalar(c)),s.v1.copy(n);var l=Math.min(u/2*.999999,i);return s.v2.copy(n).add(a.multiplyScalar(l)),s}(this.array[this.count-1].pos,t,n,r,this.count-1==0,it),o=s.getPoints(i),a=0;a<i;a++)this._sharpCorner(o[a],o[a+1],e,0===a?1:0);o[i].equals(n)||this._sharpCorner(o[i],n,e,2)}else this._sharpCorner(t,n,e,0,!0)},n._sharpCorner=function(t,n,r,i,e){void 0===i&&(i=0),void 0===e&&(e=!1);var s=this.array[this.count-1],o=this._getByIndex(this.count),a=$.subVectors(t,s.pos),h=tt.subVectors(n,t),u=a.length();if(a.normalize(),h.normalize(),o.pos.copy(t),1===i?o.dir.copy(a):2===i?o.dir.copy(h):(o.dir.addVectors(a,h),o.dir.normalize()),r)1===o.dir.dot(r)?o.right.crossVectors(h,r).normalize():o.right.crossVectors(o.dir,r).normalize(),o.up.crossVectors(o.right,o.dir).normalize();else{o.up.copy(s.up);var c=nt.crossVectors(s.dir,o.dir);if(c.length()>Number.EPSILON){c.normalize();var l=Math.acos(Math.min(Math.max(s.dir.dot(o.dir),-1),1));o.up.applyMatrix4(rt.makeRotationAxis(c,l))}o.right.crossVectors(o.dir,o.up).normalize()}o.dist=s.dist+u;var v=a.dot(h);o.widthScale=Math.min(1/Math.sqrt((1+v)/2),1.415)||1,o.sharp=Math.abs(v-1)>.05&&e,this.count++},t}(),st=new Q(0,0,1);function ot(t,n){n=Object.assign({},{lineWidth:1,cornerRadius:0,cornerSplit:10},n);var r=t.map((function(t){var r=t.map((function(t){var n=t[0],r=t[1],i=t[2];return new Q(n,r,i||0)})),i=new et;i.set(r,n.cornerRadius,n.cornerSplit,st);var e=function(t,n){var r=n.lineWidth||.1,i=1,e=r/2,s=r,o=t.distance(),a=i*o;if(0===o)return null;var h,u=e/s,c=0,l=[],v=[],f=[],p=[],x=0,d=new Q,y=new Q,g=new Q,m=new Q,z=new Q,w=new Q;function M(t){var n=0===l.length,r=t.sharp&&!n,i=t.dist/s,o=t.dir,a=t.up,h=t.right;if(d.copy(h).multiplyScalar(e*t.widthScale),y.copy(h).multiplyScalar(-e*t.widthScale),d.add(t.pos),y.add(t.pos),r){g.fromArray(l,l.length-6).sub(y),m.fromArray(l,l.length-3).sub(d);var M,b,A=g.length()-m.length();A>0?(M=g,b=y):(M=m,b=d),z.copy(M).setLength(Math.abs(A)).add(b);var P=w.copy(b).sub(z).normalize().dot(o)*w.copy(b).sub(z).length()*2;w.copy(o).setLength(P).add(z),A>0?(l.push(z.x,z.y,z.z,d.x,d.y,d.z,y.x,y.y,y.z,d.x,d.y,d.z,w.x,w.y,w.z,d.x,d.y,d.z),x+=6,p.push(x-6,x-8,x-7,x-6,x-7,x-5,x-4,x-6,x-5,x-2,x-4,x-1),c+=12):(l.push(y.x,y.y,y.z,z.x,z.y,z.z,y.x,y.y,y.z,d.x,d.y,d.z,y.x,y.y,y.z,w.x,w.y,w.z),x+=6,p.push(x-6,x-8,x-7,x-6,x-7,x-5,x-6,x-5,x-3,x-2,x-3,x-1),c+=12),v.push(a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z,a.x,a.y,a.z),f.push(i-u,0,i-u,1,i,0,i,1,i+u,0,i+u,1)}else l.push(y.x,y.y,y.z,d.x,d.y,d.z),v.push(a.x,a.y,a.z,a.x,a.y,a.z),f.push(i,0,i,1),x+=2,n||(p.push(x-2,x-4,x-3,x-2,x-3,x-1),c+=6)}if(a>0)for(var b=0;b<t.count;b++){var A=t.array[b];if(A.dist>a){var P=t.array[b-1];h=new X;var S=(a-P.dist)/(A.dist-P.dist);h.lerpPathPoints(P,A,S),M(h);break}M(A)}else h=t.array[0];return{points:l,normal:v,uvs:f,index:p,count:c}}(i,n);return e.line=t,e.position=new Float32Array(e.points),e.indices=new Uint32Array(e.index),e.uv=new Float32Array(e.uvs),e.normal=new Float32Array(e.normal),e})),i=I(r);return i.lines=t,i}var at={x:0,y:0},ht={x:0,y:0};function ut(t,n,r,i){for(var e=t.length,s=0;s<e;s++){var o=t[s].data;n=t[s].center||n;for(var a=0,h=o.length;a<h;a++)for(var u=o[a],c=0,l=u.length;c<l;c++)t[s].data[a][c]=ct(u[c],n,r,i)}}function ct(t,n,r,i,e){for(var s,o=[],a=e?3:2,h=0,u=(s=r?new Float64Array(t):new Float32Array(t)).length;h<u;h+=a){var c=s[h],l=s[h+1],v=s[h+2];if(n&&r&&i){at.x=c,at.y=l;var f=wt(at,ht);at.x=f.x,at.y=f.y,c=(f=Mt(i,at,r,ht)).x,l=f.y,c-=n[0],l-=n[1]}e?o.push([c,l,v]):o.push([c,l])}return o}function lt(t,n){void 0===n&&(n=1);for(var r=t.length,i=[],e=[],s=0,o=0;o<r;o++){var a=void 0;1===n?a=vt(t[o]):2===n?a=ft(t[o]):3===n&&(a=pt(t[o]));var h=t[o].bottomHeight||0,u=a.position;e.push(a);var c=u.length/3;i[o]={position:{middleZ:h+(t[o].height||0)/2,count:c,start:s,end:s+3*c},hide:!1},s+=3*c}var l=dt(e),v=l.position,f=l.normal,p=l.uv,x=l.indices;return{position:v.buffer,normal:f.buffer,uv:p.buffer,indices:x.buffer,geometriesAttributes:i}}function vt(t){var n=t.data,r=t.height,i=t.bottomHeight,e=R(n,{depth:r}),s=e.position,o=e.normal,a=e.uv,h=e.indices;return yt(s,i),{position:s,normal:o,uv:a,indices:h}}function ft(t){var n=t.data,r=t.height,i=t.width,e=t.bottomHeight,s=C(n,{lineWidth:i,depth:r}),o=s.position,a=s.normal,h=s.uv,u=s.indices;return yt(o,e),{position:o,normal:a,uv:h,indices:u}}function pt(t){var n=t.data,r=t.cornerRadius,i=t.width,e=t.bottomHeight,s=ot(n,{lineWidth:i,cornerRadius:r}),o=s.position,a=s.normal,h=s.uv,u=s.indices;return yt(o,e),{position:o,normal:a,uv:h,indices:u}}function xt(t,n){for(var r=new Float32Array(n),i=0,e=0;e<t.length;++e)r.set(t[e],i),i+=t[e].length;return r}function dt(t){for(var n={},r={},i=0;i<t.length;++i){var e=t[i];for(var s in e)void 0===n[s]&&(n[s]=[],r[s]=0),n[s].push(e[s]),r[s]+=e[s].length}var o={},a=0,h=[];for(var u in n)if("indices"===u)for(var c=n[u],l=0,v=c.length;l<v;l++){for(var f=c[l],p=0,x=f.length;p<x;p++)h.push(f[p]+a);a+=n.position[l].length/3}else{var d=xt(n[u],r[u]);if(!d)return null;o[u]=d}return o.indices=new Uint32Array(h),o}function yt(t,n){if(void 0!==n&&"number"==typeof n&&0!==n)for(var r=0,i=t.length;r<i;r+=3)t[r+2]+=n}function gt(t){for(var n=[],r=0,i=t.length;r<i;r+=7){var e=t[r],s=t[r+1],o=t[r+2],a=t[r+3],h=t[r+4],u=t[r+5];n.push({radialSegments:o,radius:a,height:h,altitude:u,center:[e,s]})}for(var c=n.length,l=[],v=[],f=0,p=0;p<c;p++){var x=D(n[p].center||[0,0],n[p]),d=x.position;if(n[p].altitude)for(var y=n[p].altitude,g=0,m=d.length;g<m;g+=3)x[g+2]+=y;v.push(x);var z=d.length/3;l[p]={position:{middleZ:n[p].height/2,count:z,start:f,end:f+3*z},hide:!1},f+=3*z}var w=dt(v),M=w.position,b=w.normal,A=w.uv,P=w.indices;return{position:M.buffer,normal:b.buffer,uv:A.buffer,indices:P.buffer,geometriesAttributes:l}}var mt=Math.PI/180,zt=6378137*Math.PI/180;function wt(t,n){var r,i=85.0511287798,e=t.x,s=Math.max(Math.min(i,t.y),-i);r=0===s?0:Math.log(Math.tan((90+s)*mt/2))/mt;var o=e*zt,a=r*zt;return n?(n.x=o,n.y=a,n):{x:o,y:a}}function Mt(t,n,r,i){var e=t[0]*(n.x-t[2])/r,s=-t[1]*(n.y-t[3])/r;return i?(i.x=e,i.y=s,i):{x:e,y:s}}function bt(t){void 0===t&&(t=[]);for(var n=t.length,r=new Float32Array(3*n),i=0;i<n;i++){var e=t[i],s=3*i;r[s]=e[0],r[s+1]=e[1],r[s+2]=e[2]}return r}function At(t){for(var n=new Float32Array(2*t.length-6),r=0,i=0,e=t.length/3;i<e;i++){var s=t[3*i],o=t[3*i+1],a=t[3*i+2];if(i>0&&i<e-1){var h=3*r;n[h]=s,n[h+1]=o,n[h+2]=a,r++}var u=3*r;n[u]=s,n[u+1]=o,n[u+2]=a,r++}return n}function Pt(t){var n=0,r=t.length;if(1===r)return t[0];for(var i=0;i<r;i++)n+=t[i].length;for(var e=new Float32Array(n),s=0,o=0;o<r;o++)e.set(t[o],s),s+=t[o].length;return e}t.initialize=function(){},t.onmessage=function(t,n){var r=t.data,i=r.type,e=r.datas,s=r.glRes,o=r.matrix,a=r.center;if("ExtrudePolygons"===i){ut(e,a,s,o);var h=lt(e);n(null,h,[h.position,h.normal,h.uv,h.indices])}else if("ExtrudeLines"===i||"Paths"===i){for(var u=0,c=e.length;u<c;u++)for(var l=0,v=e[u].data.length;l<v;l++)e[u].data[l]=ct(e[u].data[l],e[u].center||a,s,o,!0);var f=lt(e,"ExtrudeLines"===i?2:3);n(null,f,[f.position,f.normal,f.uv,f.indices])}else if("ExtrudePolygon"===i){var p=[],x=[];e.forEach((function(t){var n=[t];ut(n,a,s,o);var r=lt(n),i=r.position,e=r.normal,h=r.uv,u=r.indices;p.push({id:t.id,position:i,normal:e,uv:h,indices:u}),x.push(i,e,h,u)})),n(null,p,x)}else if("Line"===i||"FatLine"===i){for(var d=[],y=[],g=0,m=e.length;g<m;g++){for(var z=[],w=0,M=e[g].data.length;w<M;w++){e[g].data[w]=ct(e[g].data[w],e[g].center||a,s,o,!0);var b=bt(e[g].data[w]);z.push(At(b))}var A=Pt(z);yt(A,e[g].bottomHeight),d.push({id:e[g].id,position:A.buffer}),y.push(A.buffer)}n(null,d,y)}else if("Lines"===i||"FatLines"===i){for(var P=0,S=[],V=[],Z=0,F=[],L=0,_=e.length;L<_;L++){for(var E=0,I=0,O=e[L].data.length;I<O;I++){e[L].data[I]=ct(e[L].data[I],e[L].center||a,s,o,!0);var U=bt(e[L].data[I]);yt(U,e[L].bottomHeight),E+=U.length/3*2-2,F.push(At(U))}var q=E;S[L]=[P,P+q],P+=q,V[L]={position:{count:E,start:Z,end:Z+3*E},hide:!1},"FatLines"===i&&(V[L].instanceStart={count:E,start:Z,end:Z+3*E},V[L].instanceEnd={count:E,start:Z,end:Z+3*E}),Z+=3*E}var R=Pt(F);n(null,{id:e.id,position:R.buffer,geometriesAttributes:V,faceMap:S},[R.buffer])}else if("ExtrudeLine"===i||"Path"===i){for(var j=0,B=e.length;j<B;j++)for(var C=0,k=e[j].data.length;C<k;C++)e[j].data[C]=ct(e[j].data[C],e[j].center||a,s,o,!0);var H=[],N=[];e.forEach((function(t){var n=lt([t],"ExtrudeLine"===i?2:3),r=n.position,e=n.normal,s=n.uv,o=n.indices;H.push({id:t.id,position:r,normal:e,uv:s,indices:o}),N.push(r,e,s,o)})),n(null,H,N)}else if("Bar"===i){for(var T=[],W=[],D=(e=new Float32Array(e)).length/7,Q=0;Q<D;){var X=e.slice(7*Q,7*(Q+1)),G=gt(X),J=G.position,K=G.normal,Y=G.uv,$=G.indices;T.push({id:parseInt(X[6]),position:J,normal:K,uv:Y,indices:$}),W.push(J,K,Y,$),Q++}n(null,T,W)}else if("Bars"===i){var tt=gt(e=new Float32Array(e));n(null,tt,[tt.position,tt.normal,tt.uv,tt.indices])}else console.error("No processing logic found for type:"+i)},Object.defineProperty(t,"__esModule",{value:!0})})',as="__maptalks.three__";function ls(){return as}function hs(){return os}const cs="__maptalks.three.fetchdata__";function us(t){const e=[],n=[],r=5;function i(t){t.abort?(n.splice(n.indexOf(t),1),e.length&&(n.push(e[0]),e.splice(0,1),s(n[n.length-1]))):n.length<r?(n.push(t),s(t)):e.push(t)}function s(t){fetch(t.url).then(t=>t.text()).then(e=>{const n=new Blob([e],{type:"application/json"});n.arrayBuffer().then(e=>{t.postResponse(null,e,[e]),t.abort=!0,i(t)})}).catch(e=>{console.error(e),t.abort=!0,i(t)})}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data,r={url:n,postResponse:e,abort:!1};i(r)}}const fs={bottomHeight:0,width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61",heightEnable:!0};class ds extends I{constructor(t,e,n,i){e=r["I"].extend({},fs,e,{layer:i,lineString:t}),super(),this._initOptions(e);const{width:s,cornerRadius:o,bottomHeight:a,altitude:l,asynchronous:h}=e,c=i.distanceToVector3(o,o).x,u=i.distanceToVector3(s,s).x,{lineStrings:f,center:d}=ze(t);let p;if(h){p=Ln();const e=r["I"].GUID();this.getOptions().id=e,this.getOptions().center=d,Cn.push({id:e,data:f,layer:i,center:d,lineString:t,baseObject:this})}else{const t=[];let e=0;const n={};for(let r=0,s=f.length;r<s;r++){const s=Le(f[r],u,c,i,d);e=pe(s,a,i,n),t.push(s)}p=Pn(t)}this._createMesh(p,n);const A=i.altitudeToVector3(l,l).x,g=i.coordinateToVector3(d,A);this.getObject3d().position.copy(g),this.type="Path"}_workerLoad(t){const e=Nn(t),n=this.getObject3d();n.geometry=e,this._fire("workerload",{target:this})}}var ps=ds;const As={width:3,cornerRadius:0,altitude:0,topColor:null,bottomColor:"#2d2f61"};class gs extends(Mr(I)){constructor(t,e,n,i){Array.isArray(t)||(t=[t]);const s=[],o=[],a=t.length;for(let r=0;r<a;r++){const e=t[r],n=ze(e);s.push(n.center),o.push(n.lineStrings)}const l=de(s);e=r["I"].extend({},As,e,{layer:i,lineStrings:t,coordinate:l});const{altitude:h,asynchronous:c}=e;let u;const f=[],d=[];if(super(),c)u=Ln(),On.push({id:r["I"].GUID(),layer:i,key:e.key,center:l,data:o,lineStrings:t,baseObject:this,option:e});else{const n=[];let s=0,h=0,c=0;const f={},p={};for(let u=0;u<a;u++){const a=t[u],A=r["I"].extend({},e,xe(a),{index:u}),{cornerRadius:g,width:m,bottomHeight:y}=A,v=ue(m,i,f),x=ue(g,i,p),b=o[u],w=[];let _=0;for(let t=0,e=b.length;t<e;t++){const e=Le(b[t],v,x,i,l);_=pe(e,y,i,f),w.push(e)}const M=kn(w);n.push(M);const{position:T,normal:S,indices:I}=M,C=I.length/3;s+=C;const O=T.length/3,E=S.length/3;d[u]={position:{middleZ:_,count:O,start:h,end:h+3*O},hide:!1},h+=3*O,c+=3*E}u=Pn(n)}this._initOptions(e),this._createMesh(u,n);const p=i.altitudeToVector3(h,h).x,A=i.coordinateToVector3(l,p);this.getObject3d().position.copy(A),this._baseObjects=f,this._datas=t,this._geometriesAttributes=d,this.faceIndex=null,this._geometryCache=Dn(u),this.isHide=!1,this._colorMap={},this._initBaseObjectsEvent(f),c||(this._setPickObject3d(),this._init()),this.type="Paths"}getSelectMesh(){const t=this._getIndex();if(null!=t){if(!this._baseObjects[t]){const e=this._datas[t],n=Object.assign({},this.options,k(e)?e.properties:e.getProperties(),{index:t});this._baseObjects[t]=new ps(e,n,this.getObject3d().material,this.getLayer()),this._proxyEvent(this._baseObjects[t])}return{data:this._datas[t],baseObject:this._baseObjects[t]}}}identify(t){return this.picked}_workerLoad(t){const{geometriesAttributes:e}=t;this._geometriesAttributes=e;const n=Nn(t);if(this._geometryCache=Dn(n),this.getObject3d().geometry=n,this._setPickObject3d(),this._init(),this.isAdd){const t=this.getLayer().getPick();t.add(this.pickObject3d)}this._fire("workerload",{target:this})}}var ms=gs;const ys={renderer:"gl",doubleBuffer:!1,glOptions:null,geometryEvents:!0,identifyCountOnEvent:0,forceRenderOnZooming:!0,loopRenderCount:50},vs=Math.PI/180,xs=[[4e3,220],[2e3,100],[1e3,30],[500,15],[100,5],[50,2],[10,1],[5,.7],[2,.1],[1,.05],[.5,.02],[.4,.01],[.1,.005],[.05,.002],[.01,.001]],bs=["mouseout","mousemove","click","mousedown","mouseup","dblclick","contextmenu","touchstart","touchmove","touchend"],ws=new r["f"](0,0),_s=new r["A"](0,0),Ms=new i["Vector3"],Ts=new Map,Ss="__webglFramebuffer",Is=new i["Vector4"];class Cs extends r["c"]{constructor(t,e){super(t,e),this._animationBaseObjectMap={},this._needsUpdate=!0,this._mousemoveTimeOut=0,this._mousedownTime=0,this._baseObjects=[],this._delayMeshes=[],this._meshes=[],this.type="ThreeLayer"}isMercator(){const t=this.getMap();if(!t)return!1;const e=t.getSpatialReference(),n=e._projection,r=e._resolutions;return!!(n&&"EPSG:3857"===n.code&&r&&r.length&&156543===Math.floor(r[0])&&t.getGLRes)}isRendering(){const t=this.getMap();return!!t&&(t.isInteracting()||t.isAnimating())}prepareToDraw(...t){}draw(t,e,n,r,i,s){this.renderScene(s,this)}drawOnInteracting(t,e,n,r,i,s,o){this.renderScene(o,this)}_transformHeight(t,e){if(!t)return 0;if(e=e||0,0===e)return 0;const n=this.altitudeToVector3(e,e,null,Ms);return n.x}coordinateToVector3(t,e=0,n){const s=this.getMap();if(!s)return null;const o=Array.isArray(t);o?(ws.x=t[0],ws.y=t[1]):t instanceof r["f"]||(t=new r["f"](t));const a=ks(s),l=Rs(s,o?ws:t,a,_s);return n&&(n.x=l.x,n.y=l.y,n.z=e),new i["Vector3"](l.x,l.y,e)}coordinatiesToGLFloatArray(t,e,n){const i=this.getMap();if(!i)return null;const s=ks(i),o=t.length,a=new Float32Array(2*o),l=new Float32Array(3*o);Ts.clear();for(let h=0;h<o;h++){let o=t[h];const c=Array.isArray(o);c?(ws.x=o[0],ws.y=o[1]):o instanceof r["f"]||(o=new r["f"](o));const u=Rs(i,c?ws:o,s,_s);u.x-=e.x,u.y-=e.y;const f=2*h;a[f]=u.x,a[f+1]=u.y;const d=o;let p=d.z||d[2]||0;if(n&&!Ts.has(p)){const t=this._transformHeight(n,p);Ts.set(p,t)}let A=0;n&&(A=Ts.get(p)||0);const g=3*h;l[g]=u.x,l[g+1]=u.y,l[g+2]=A}return{positions:l,positons2d:a}}coordinatiesToGLArray(t,e){const n=this.getMap();if(!n)return null;const i=ks(n),s=t.length,o=new Array(s);for(let a=0;a<s;a++){let s=t[a];const l=Array.isArray(s);l?(ws.x=s[0],ws.y=s[1]):s instanceof r["f"]||(s=new r["f"](s));const h=Rs(n,l?ws:s,i,_s);h.x-=e.x,h.y-=e.y,o[a]=[h.x,h.y]}return o}distanceToVector3(t,e,n){if(0===t&&0===e||!r["I"].isNumber(t)||!r["I"].isNumber(e))return new i["Vector3"](0,0,0);const s=this.getMap(),o=ks(s);let a=n||s.getCenter();a instanceof r["f"]||(a=new r["f"](a));const l=s.locate(a,t,e),h=Rs(s,a,o),c=Rs(s,l,o),u=Math.abs(c.x-h.x)*r["I"].sign(t),f=Math.abs(c.y-h.y)*r["I"].sign(e);return new i["Vector3"](u,f,0)}altitudeToVector3(t,e,n,s){if(0===t||!r["I"].isNumber(t))return new i["Vector3"](0,0,0);const o=this.getMap();if(o.altitudeToPoint){const e=ks(o);let n=o.altitudeToPoint(t,e);return t<0&&n>0&&(n=-n),s?(s.x=n,s.y=n,s.z=0,s):new i["Vector3"](n,n,0)}return this.distanceToVector3(t,t,n)}toShape(t){if(!t)return null;if(t instanceof r["x"])return t.getGeometries().map(t=>this.toShape(t));const e=t.getCenter(),n=this.coordinateToVector3(e),s=t.getShell(),o=s.map(t=>{const e=this.coordinateToVector3(t).sub(n);return new i["Vector2"](e.x,e.y)}),a=new i["Shape"](o),l=t.getHoles();return l&&l.length>0&&(a.holes=l.map(t=>{const e=t.map(t=>{const e=this.coordinateToVector3(t).sub(n);return new i["Vector2"](e.x,e.y)});return new i["Shape"](e)})),a}toExtrudeMesh(t,e,n,s){if(!t)return null;if(t instanceof r["x"])return t.getGeometries().map(t=>this.toExtrudeMesh(t,e,n,s));const o=t.getCoordinates();o.forEach(t=>{const e=t.length;for(let n=e-1;n>=1;n--)t[n].equals(t[n-1])&&t.splice(n,1)}),t.setCoordinates(o);const a=this.toShape(t),l=this.coordinateToVector3(t.getCenter());s=r["I"].isNumber(s)?s:e,s=this.altitudeToVector3(s,s).x;const h=this.altitudeToVector3(e,e).x,c={bevelEnabled:!1,bevelSize:1},u=parseInt(i["REVISION"])>=93?"depth":"amount";c[u]=s;const f=new i["ExtrudeGeometry"](a,c);let d=f;i["BufferGeometry"].prototype.fromGeometry&&(d=new i["BufferGeometry"],d.fromGeometry(f));const p=new i["Mesh"](d,n);return p.position.set(l.x,l.y,h-s),p}toExtrudePolygon(t,e,n){return new ir(t,e,n,this)}toBar(t,e,n){return new Qn(t,e,n,this)}toLine(t,e,n){return new Jn(t,e,n,this)}toExtrudeLine(t,e,n){return new er(t,e,n,this)}toModel(t,e){return new ar(t,e,this)}toExtrudeLineTrail(t,e,n){return new xr(t,e,n,this)}toExtrudePolygons(t,e,n){return new Cr(t,e,n,this)}toPoint(t,e,n){return new Rr(t,e,n,this)}toPoints(t,e,n){return new Vr(t,e,n,this)}toBars(t,e,n){return new Wr(t,e,n,this)}toExtrudeLines(t,e,n){return new Yr(t,e,n,this)}toLines(t,e,n){return new Jr(t,e,n,this)}toThreeVectorTileLayer(t,e,n){return new gi(t,e,n,this)}toTerrain(t,e,n){return new Ci(t,e,n,this)}toTerrainVectorTileLayer(t,e,n){return new Pi(t,e,n,this)}toHeatMap(t,e,n){return new Gi(t,e,n,this)}toFatLine(t,e,n){return new Ki(t,e,n,this)}toFatLines(t,e,n){return new ts(t,e,n,this)}toBox(t,e,n){return new rs(t,e,n,this)}toBoxs(t,e,n){return new ss(t,e,n,this)}toPath(t,e,n){return new ps(t,e,n,this)}toPaths(t,e,n){return new ms(t,e,n,this)}getBaseObjects(){return this.getMeshes().filter(t=>t instanceof I)}getMeshes(){const t=this.getScene();if(!t)return[];const e=[];for(let n=0,r=t.children.length;n<r;n++){const r=t.children[n];r instanceof i["Object3D"]&&!(r instanceof i["Camera"])&&e.push(r["__parent"]||r)}return e}clear(){return this.clearMesh()}clearBaseObjects(){return this.removeMesh(this.getBaseObjects())}clearMesh(){const t=this.getScene();if(!t)return this;for(let e=t.children.length-1;e>=0;e--){const n=t.children[e];if(n instanceof i["Object3D"]&&!(n instanceof i["Camera"])){t.remove(n);const e=n["__parent"];e&&e instanceof I&&(e.isAdd=!1,e.options.layer=null,e._fire("remove",{target:e}),delete this._animationBaseObjectMap[n.uuid],e._hideUI())}}return this._meshes=[],this}lookAt(t){const e=this._getRenderer();return e&&e.context.lookAt(t),this}getCamera(){const t=this._getRenderer();return t?t.camera:null}getScene(){const t=this._getRenderer();return t?t.scene:null}renderScene(t,e){const n=this._getRenderer();return n&&(n.clearCanvas(),n.renderScene(t),e||n.setToRedraw()),this}loop(t=!1){const e=this._delayMeshes;if(!e.length)return;const n=this.getMap();if(!n||n.isAnimating()||n.isInteracting())return;const r=this.options.loopRenderCount||50,i=e.slice(0,r);i&&this.addMesh(i,t),e.splice(0,r)}renderPickScene(){const t=this._getRenderer();if(t){const e=t.pick;e&&e.pick(this._containerPoint)}return this}getThreeRenderer(){const t=this._getRenderer();return t?t.context:null}getPick(){const t=this._getRenderer();return t?t.pick:null}delayAddMesh(t){if(!t)return this;Array.isArray(t)||(t=[t]);for(let e=0,n=t.length;e<n;e++)this._delayMeshes.push(t[e]);return this}addMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach(t=>{t instanceof I?(n.add(t.getObject3d()),t.isAdd||(t.isAdd=!0,t.options.layer=this,t._fire("add",{target:t})),t._animation&&r["I"].isFunction(t._animation)&&(this._animationBaseObjectMap[t.getObject3d().uuid]=t)):t instanceof i["Object3D"]&&n.add(t);const e=this._meshes.indexOf(t);-1===e&&this._meshes.push(t)}),this._zoomend(),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}removeMesh(t,e=!0){if(!t)return this;Array.isArray(t)||(t=[t]);const n=this.getScene();if(t.forEach(t=>{if(t instanceof I){n.remove(t.getObject3d()),t.isAdd&&(t.isAdd=!1,t.options.layer=null,t._fire("remove",{target:t}),t._hideUI()),t._animation&&r["I"].isFunction(t._animation)&&delete this._animationBaseObjectMap[t.getObject3d().uuid];const e=this._delayMeshes;if(e.length)for(let n=0,r=e.length;n<r;n++)if(e[n]===t){e.splice(n,1);break}}else t instanceof i["Object3D"]&&n.remove(t);for(let e=0,n=this._meshes.length;e<n;e++){const n=this._meshes[e];n&&(n===t&&this._meshes.splice(e,1))}}),e){const t=this._getRenderer();t&&t.setToRedraw()}return this}_initRaycaster(){return this._raycaster||(this._raycaster=new i["Raycaster"],this._mouse=new i["Vector2"]),this}getRaycaster(){return this._raycaster}identify(t,e){if(!t)return console.error("coordinate is null,it should be Coordinate"),[];if(Array.isArray(t)&&(t=new r["f"](t)),!(t instanceof r["f"]))return console.error("coordinate type is error,it should be Coordinate"),[];const n=this.getMap().coordToContainerPoint(t);this._containerPoint=n;const{x:s,y:o}=n;this._initRaycaster(),this.fire("identify",{coordinate:t,options:e});const l=this._raycaster,h=this._mouse,c=this.getCamera(),u=this.getScene(),f=this.getMap().getSize();if(!u)return[];const d=f.width,p=f.height;h.x=s/d*2-1,h.y=-o/p*2+1,l.setFromCamera(h,c),l.layers&&l.layers.enableAll&&l.layers.enableAll(),a(l,this._getLinePrecision(this.getMap().getResolution()));const A=[],g=[];u.children.forEach(t=>{const e=t["__parent"];if(e&&e.getOptions){const n=e,i=n.getOptions().interactive;i&&n.isVisible()&&(n.identify&&r["I"].isFunction(n.identify)?g.push(n):A.push(t))}else(t instanceof i["Mesh"]||t instanceof i["Group"])&&A.push(t)});let m=[];const y=l.intersectObjects(A,!0);y&&Array.isArray(y)&&y.length&&(m=y.map(t=>{let e=t.object;const n=t.instanceId;e=this._recursionMesh(e)||{};const i=e["__parent"]||e;return i.faceIndex=t.faceIndex,i.index=t.index,i.intersect=t,r["I"].isNumber(n)&&(i.instanceId=n),i})),this.renderPickScene(),g.length&&g.forEach(e=>{e.identify(t)&&m.push(e)});const v=m.length;for(let r=0;r<v;r++)if(m[r])for(let t=r+1;t<v;t++)m[r]===m[t]&&m.splice(t,1);let x=m.filter(t=>t instanceof I);x=x.sort((t,e)=>t["options"].pickWeight-e["options"].pickWeight),m.forEach(t=>{t instanceof I||x.push(t)}),e=r["I"].extend({},e);const b=e["count"];return r["I"].isNumber(b)&&b>0?x.slice(0,b):m}identifyAtPoint(t,e={}){const n=this.getMap();if(!n)return[];const r=n.containerPointToCoordinate(t);return this.identify(r,e)}_recursionMesh(t){while(t&&t.parent!==this.getScene())t=t.parent;return t}_getLinePrecision(t=10){for(let e=0,n=xs.length;e<n;e++){const[n,r]=xs[e];if(t>n)return r}return.01}fireGeoEvent(t,e,n){if(!(t instanceof I))return this;n=n||e.type;const r=this._getEventParams(e),{coordinate:i}=r,s=this.getMap();function o(t,e){e=e||n;const r=t.getInfoWindow();r&&!r._owner&&r.addTo(t);const o=r?r.options:{},a=o["autoOpenOn"]||"click";a===e&&(s.options.supportPluginEvent||t.openInfoWindow(i),t.fire("showinfowindow",{infoWindow:r}))}if("mousemove"===n){t.fire(n,Object.assign({},r,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(i),o(t)}else"mouseover"===n?t._mouseover||(t.fire("mouseover",Object.assign({},r,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,o(t,"mouseover")):"mouseout"===n?t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},r,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},r,{target:t,type:"mouseout"})),t.closeToolTip()):(t.fire(n,Object.assign({},r,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),o(t))}_emptyIdentify(t={}){const e=t.domEvent,n=this.getScene();if(!n)return this;const r=this.map||this.getMap();if(!r)return this;const i=r._getEventParams?r._getEventParams(e):this._getEventParams(e);for(let s=0,o=n.children.length;s<o;s++){const t=n.children[s]||{},e=t["__parent"];e&&e.fire("empty",Object.assign({},i,{target:e}))}}_identifyBaseObjectEvents(t){if(!this.options.geometryEvents)return this;const e=this.map||this.getMap();if(e.isInteracting()||!e.options.geometryEvents||e._ignoreEvent(t))return this;const n=t.type,i=e._getEventParams?e._getEventParams(t):this._getEventParams(t);i.type=n;const{type:s,coordinate:o}=i,a=r["I"].now();if(this._mousemoveTimeOut&&"mousemove"===s&&a-this._mousemoveTimeOut<64)return this;this._mousemoveTimeOut=a,"mousedown"!==s&&"touchstart"!==s||(this._mousedownTime=r["I"].now());let l=!1;if("click"===s||"touchend"===s){const t=e.options.clickTimeThreshold||280;l=r["I"].now()-this._mousedownTime<t}if("click"===s&&!l)return this;const h=this.options["identifyCountOnEvent"];let c=Math.max(0,r["I"].isNumber(h)?h:0);0===c&&(c=1/0);const u=t=>{const e=[];this._baseObjects&&this._baseObjects.forEach(n=>{let r=!0;t.forEach(t=>{n===t&&(r=!1)}),r&&e.push(n)}),e.forEach(t=>{t&&t instanceof I&&(t.getSelectMesh?t.isHide||(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout",selectMesh:null})),t.closeToolTip()):(t._mouseover=!1,t.fire("mouseout",Object.assign({},i,{target:t,type:"mouseout"})),t.closeToolTip()))})};if("mouseout"===s)return u([]),this._baseObjects=[],this;const f=this.identify(o,{count:c}),d=this.getScene();if(0===f.length&&d)for(let r=0,A=d.children.length;r<A;r++){const t=d.children[r]||{},e=t["__parent"];e&&e.fire("empty",Object.assign({},i,{target:e}))}function p(t,e){e=e||s;const n=t.getInfoWindow();n&&!n._owner&&n.addTo(t);const r=n?n.options:{},i=r["autoOpenOn"]||"click";i===e&&(t.openInfoWindow(o),t.fire("showinfowindow",{infoWindow:n}))}if("mousemove"===s?(u(f),f.forEach(t=>{if(t instanceof I){t._mouseover||(t.fire("mouseover",Object.assign({},i,{target:t,type:"mouseover",selectMesh:t.getSelectMesh?t.getSelectMesh():null})),t._mouseover=!0,p(t,"mouseover")),t.fire(s,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null}));const e=t.getToolTip();e&&!e._owner&&e.addTo(t),t.openToolTip(o),p(t)}}),this._baseObjects=f):f.forEach(t=>{t instanceof I&&(t.fire(s,Object.assign({},i,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t))}),"touchend"===s&&l){const e=r["I"].extend({},i,{domEvent:t});f.forEach(t=>{t instanceof I&&(t.fire("click",Object.assign({},e,{target:t,selectMesh:t.getSelectMesh?t.getSelectMesh():null})),p(t,"click"))})}return this}_getEventParams(t){const e=this.getMap(),n={domEvent:t};if(!e)return n;const i=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(i){const t=r["g"].getEventContainerPoint,s=t(i,e._containerDOM);n["coordinate"]=e.containerPointToCoordinate(s),n["containerPoint"]=s,n["viewPoint"]=e.containerPointToViewPoint(s),n["pont2d"]=e._containerPointToPoint(s)}return n}_zoomend(){const t=this.getScene();if(!t)return;const e=this.getMap().getZoom();t.children.forEach(t=>{const n=t["__parent"];if(n&&n.getOptions){const t=n;t.zoomChange&&r["I"].isFunction(t.zoomChange)&&t.zoomChange(e);const i=t.getMinZoom(),s=t.getMaxZoom();e<i||e>s?(t.isVisible()&&(t.getObject3d().visible=!1),t._zoomVisible=!1):i<=e&&e<=s&&(t._visible&&(t.getObject3d().visible=!0),t._zoomVisible=!0)}})}_getGeometryEventMapPanel(){const t=this.map||this.getMap(),e=t._panels.allLayers||t._containerDOM;return e}onAdd(){super.onAdd();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return this._identifyBaseObjectEventsThis||(this._identifyBaseObjectEventsThis=this._identifyBaseObjectEvents.bind(this)),this._zoomendThis||(this._zoomendThis=this._zoomend.bind(this)),this._emptyIdentifyThis||(this._emptyIdentifyThis=this._emptyIdentify.bind(this)),t.options.supportPluginEvent?this.on("identifyempty",this._emptyIdentifyThis):r["g"].on(e,bs.join(" "),this._identifyBaseObjectEventsThis,this),this._needsUpdate=!0,this._animationBaseObjectMap||(this._animationBaseObjectMap={}),t.on("zooming zoomend",this._zoomendThis,this),this}onRemove(){super.onRemove();const t=this.map||this.getMap();if(!t)return this;const e=this._getGeometryEventMapPanel();return t.options.supportPluginEvent?this.off("identifyempty",this._emptyIdentifyThis):r["g"].off(e,bs.join(" "),this._identifyBaseObjectEventsThis,this),t.off("zooming zoomend",this._zoomendThis,this),this}_addBaseObjectsWhenInit(){return this.addMesh(this._meshes),this}_callbackBaseObjectAnimation(){const t=this;if(t._animationBaseObjectMap)for(const e in t._animationBaseObjectMap){const n=t._animationBaseObjectMap[e];n._animation()}return this}_getFovRatio(){const t=this.getMap(),e=t.getFov();return Math.tan(e/2*vs)}}Cs.mergeOptions(ys);const Os={bloom:!0};class Es extends r["P"].CanvasLayerRenderer{constructor(){super(...arguments),this._renderTime=0,this._renderTarget=null}getPrepareParams(){return[this.scene,this.camera]}getDrawParams(){return[this.scene,this.camera]}_drawLayer(){super._drawLayer.apply(this,arguments)}hitDetect(){return!1}createCanvas(){super.createCanvas(),this.createContext()}createContext(){if(this.canvas.gl&&this.canvas.gl.wrap)this.gl=this.canvas.gl.wrap();else{const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1};e.preserveDrawingBuffer=!0,this.gl=this.gl||this._createGLContext(this.canvas,e)}this._initThreeRenderer(),this.layer.onCanvasCreate(this.context,this.scene,this.camera)}_initThreeRenderer(){this.matrix4=new i["Matrix4"];const t=new i["WebGLRenderer"]({context:this.gl,alpha:!0});t.autoClear=!1,t.setClearColor(new i["Color"](1,1,1),0),t.setSize(this.canvas.width,this.canvas.height),t.clear(),this.context=t;const e=this.scene=new i["Scene"],n=this.layer.getMap(),r=n.getFov()*Math.PI/180,s=this.camera=new i["PerspectiveCamera"](r,n.width/n.height,n.cameraNear,n.cameraFar);s.matrixAutoUpdate=!1,this._syncCamera(),e.add(s),this.pick=new Qi(this.layer),En.star(),this.layer._addBaseObjectsWhenInit()}onCanvasCreate(){super.onCanvasCreate()}resizeCanvas(t){if(!this.canvas)return;let e,n=this.getMap();e=t||n.getSize();const i=n.getDevicePixelRatio?n.getDevicePixelRatio():r["b"].retina?2:1,s=this.canvas,{width:o,height:a,cssWidth:l,cssHeight:h}=r["I"].calCanvasSize(e,i);if(!this.layer._canvas||s.style.width===l&&s.style.height===h||(s.style.width=l,s.style.height=h),s.width===o&&s.height===a)return this;s.width=o,s.height=a,this.context.setSize(s.width,s.height)}clearCanvas(){this.canvas&&this.context.clear()}prepareCanvas(){return this.canvas?this.clearCanvas():this.createCanvas(),this.layer.fire("renderstart",{context:this.context}),null}renderScene(t){if(this.layer._callbackBaseObjectAnimation(),this._syncCamera(),t&&t.renderTarget){const{width:e,height:n}=t.renderTarget.fbo;this._renderTarget?(this._renderTarget.viewport.set(0,0,e,n),this._renderTarget.scissor.set(0,0,e,n)):(this._renderTarget=new i["WebGLRenderTarget"](e,n,{depthBuffer:!1}),this.context.setRenderTarget(this._renderTarget),this.context.render(this.scene,this.camera));const r=this.context.properties.get(this._renderTarget),s=r[Ss];r[Ss]=t.renderTarget.getFramebuffer(t.renderTarget.fbo),this.context.setRenderTarget(this._renderTarget);const o=1===t.bloom&&t.sceneFilter,a=this.scene.children||[];let l=!1;if(o){const e=t.sceneFilter;l=e(Os);for(let t=0,n=a.length;t<n;t++){if(!a[t]||!a[t].layers)continue;const n=a[t]["__parent"];a[t]["bloom"]=!1,n&&(a[t]["bloom"]=n.bloom);let r=0;(a[t]&&e(a[t])||!n)&&l&&(r=1),a[t].__layer!==r&&(Ps(a[t],r),a[t].__layer=r)}}else for(let t=0,i=a.length;t<i;t++)a[t]&&a[t].layers&&0!==a[t].__layer&&(Ps(a[t],0),a[t].__layer=0);this.camera.layers.set(l?1:0),this.context.render(this.scene,this.camera),r[Ss]=s}else{const{width:t,height:e}=this.canvas,n=this.context.getViewport(Is);n.width===t&&n.height===e||this.context.setViewport(0,0,t,e),this.context.render(this.scene,this.camera)}this.context.setRenderTarget(null),this.completeRender()}remove(){delete this._drawContext,this._renderTarget&&(this._renderTarget.dispose(),delete this._renderTarget),super.remove()}_syncCamera(){const t=this.getMap(),e=this.camera;e.matrix.elements=t.cameraWorldMatrix,e.projectionMatrix.elements=t.projMatrix,this.matrix4.invert?e.projectionMatrixInverse.elements=this.matrix4.copy(e.projectionMatrix).invert().elements:e.projectionMatrixInverse&&(e.projectionMatrixInverse.elements=this.matrix4.getInverse(e.projectionMatrix).elements)}_createGLContext(t,e){const n=["webgl2","webgl","experimental-webgl"];let r=null;for(let s=0;s<n.length;++s){try{r=t.getContext(n[s],e)}catch(i){}if(r)break}return r}}function Ps(t,e){if(!t)return;t.layers&&t.layers.set(e);const n=t.children;if(n&&n.length)for(let r=0,i=n.length;r<i;r++)Ps(n[r],e)}function ks(t){return t.getGLRes?t.getGLRes():t.getGLZoom()}function Rs(t,e,n,r){return t.coordToPointAtRes?t.coordToPointAtRes(e,n,r):t.coordinateToPoint(e,n,r)}Cs.registerRenderer("gl",Es),r["O"]&&(r["O"](ls(),hs()),r["O"](cs,us))},5875:function(t,e,n){"use strict";function r(t,e,n){n=n||2;var r,s,a,l,h,c,f,d=e&&e.length,p=d?e[0]*n:t.length,A=i(t,0,p,n,!0),g=[];if(!A||A.next===A.prev)return g;if(d&&(A=u(t,e,A,n)),t.length>80*n){r=a=t[0],s=l=t[1];for(var m=n;m<p;m+=n)h=t[m],c=t[m+1],h<r&&(r=h),c<s&&(s=c),h>a&&(a=h),c>l&&(l=c);f=Math.max(a-r,l-s),f=0!==f?32767/f:0}return o(A,g,n,r,s,f,0),g}function i(t,e,n,r,i){var s,o;if(i===N(t,e,n,r)>0)for(s=e;s<n;s+=r)o=P(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=P(s,t[s],t[s+1],o);return o&&_(o,o.next)&&(k(o),o=o.next),o}function s(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!_(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(k(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function o(t,e,n,r,i,u,f){if(t){!f&&u&&g(t,r,i,u);var d,p,A=t;while(t.prev!==t.next)if(d=t.prev,p=t.next,u?l(t,r,i,u):a(t))e.push(d.i/n|0),e.push(t.i/n|0),e.push(p.i/n|0),k(t),t=p.next,A=p.next;else if(t=p,t===A){f?1===f?(t=h(s(t),e,n),o(t,e,n,r,i,u,2)):2===f&&c(t,e,n,r,i,u):o(s(t),e,n,r,i,u,1);break}}}function a(t){var e=t.prev,n=t,r=t.next;if(w(e,n,r)>=0)return!1;var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;while(p!==e){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&x(i,a,s,l,o,h,p.x,p.y)&&w(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function l(t,e,n,r){var i=t.prev,s=t,o=t.next;if(w(i,s,o)>=0)return!1;var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=y(d,p,e,n,r),v=y(A,g,e,n,r),b=t.prevZ,_=t.nextZ;while(b&&b.z>=m&&_&&_.z<=v){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}while(b&&b.z>=m){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;b=b.prevZ}while(_&&_.z<=v){if(_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function h(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!_(i,o)&&M(i,r,r.next,o)&&C(i,o)&&C(o,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(o.i/n|0),k(r),k(r.next),r=t=o),r=r.next}while(r!==t);return s(r)}function c(t,e,n,r,i,a){var l=t;do{var h=l.next.next;while(h!==l.prev){if(l.i!==h.i&&b(l,h)){var c=E(l,h);return l=s(l,l.next),c=s(c,c.next),o(l,e,n,r,i,a,0),void o(c,e,n,r,i,a,0)}h=h.next}l=l.next}while(l!==t)}function u(t,e,n,r){var s,o,a,l,h,c=[];for(s=0,o=e.length;s<o;s++)a=e[s]*r,l=s<o-1?e[s+1]*r:t.length,h=i(t,a,l,r,!1),h===h.next&&(h.steiner=!0),c.push(v(h));for(c.sort(f),s=0;s<c.length;s++)n=d(c[s],n);return n}function f(t,e){return t.x-e.x}function d(t,e){var n=p(t,e);if(!n)return e;var r=E(n,t);return s(r,r.next),s(n,n.next)}function p(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&x(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),C(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&A(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}function A(t,e){return w(t.prev,t,e.prev)<0&&w(e.next,t,t.next)<0}function g(t,e,n,r){var i=t;do{0===i.z&&(i.z=y(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,m(i)}function m(t){var e,n,r,i,s,o,a,l,h=1;do{n=t,t=null,s=null,o=0;while(n){for(o++,r=n,a=0,e=0;e<h;e++)if(a++,r=r.nextZ,!r)break;l=h;while(a>0||l>0&&r)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1);return t}function y(t,e,n,r,i){return t=(t-n)*i|0,e=(e-r)*i|0,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function v(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function x(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!I(t,e)&&(C(t,e)&&C(e,t)&&O(t,e)&&(w(t.prev,t,e.prev)||w(t,e.prev,e))||_(t,e)&&w(t.prev,t,t.next)>0&&w(e.prev,e,e.next)>0)}function w(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function _(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){var i=S(w(t,e,n)),s=S(w(t,e,r)),o=S(w(n,r,t)),a=S(w(n,r,e));return i!==s&&o!==a||(!(0!==i||!T(t,n,e))||(!(0!==s||!T(t,r,e))||(!(0!==o||!T(n,t,r))||!(0!==a||!T(n,e,r)))))}function T(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function S(t){return t>0?1:t<0?-1:0}function I(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function C(t,e){return w(t.prev,t,t.next)<0?w(t,e,t.next)>=0&&w(t,t.prev,e)>=0:w(t,e,t.prev)<0||w(t,t.next,e)<0}function O(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!==n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}function E(t,e){var n=new R(t.i,t.x,t.y),r=new R(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function P(t,e,n,r){var i=new R(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function R(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function N(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}t.exports=r,t.exports.default=r,r.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(N(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(N(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},r.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n}},"66b4":function(t,e,n){"use strict";function r(t,e,n){n=n||2;var r,s,a,l,h,c,f,d=e&&e.length,p=d?e[0]*n:t.length,A=i(t,0,p,n,!0),g=[];if(!A||A.next===A.prev)return g;if(d&&(A=u(t,e,A,n)),t.length>80*n){r=a=t[0],s=l=t[1];for(var m=n;m<p;m+=n)h=t[m],c=t[m+1],h<r&&(r=h),c<s&&(s=c),h>a&&(a=h),c>l&&(l=c);f=Math.max(a-r,l-s),f=0!==f?32767/f:0}return o(A,g,n,r,s,f,0),g}function i(t,e,n,r,i){var s,o;if(i===N(t,e,n,r)>0)for(s=e;s<n;s+=r)o=P(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=P(s,t[s],t[s+1],o);return o&&_(o,o.next)&&(k(o),o=o.next),o}function s(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!_(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(k(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function o(t,e,n,r,i,u,f){if(t){!f&&u&&g(t,r,i,u);var d,p,A=t;while(t.prev!==t.next)if(d=t.prev,p=t.next,u?l(t,r,i,u):a(t))e.push(d.i/n|0),e.push(t.i/n|0),e.push(p.i/n|0),k(t),t=p.next,A=p.next;else if(t=p,t===A){f?1===f?(t=h(s(t),e,n),o(t,e,n,r,i,u,2)):2===f&&c(t,e,n,r,i,u):o(s(t),e,n,r,i,u,1);break}}}function a(t){var e=t.prev,n=t,r=t.next;if(w(e,n,r)>=0)return!1;var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;while(p!==e){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&x(i,a,s,l,o,h,p.x,p.y)&&w(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function l(t,e,n,r){var i=t.prev,s=t,o=t.next;if(w(i,s,o)>=0)return!1;var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=y(d,p,e,n,r),v=y(A,g,e,n,r),b=t.prevZ,_=t.nextZ;while(b&&b.z>=m&&_&&_.z<=v){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}while(b&&b.z>=m){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;b=b.prevZ}while(_&&_.z<=v){if(_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function h(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!_(i,o)&&M(i,r,r.next,o)&&C(i,o)&&C(o,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(o.i/n|0),k(r),k(r.next),r=t=o),r=r.next}while(r!==t);return s(r)}function c(t,e,n,r,i,a){var l=t;do{var h=l.next.next;while(h!==l.prev){if(l.i!==h.i&&b(l,h)){var c=E(l,h);return l=s(l,l.next),c=s(c,c.next),o(l,e,n,r,i,a,0),void o(c,e,n,r,i,a,0)}h=h.next}l=l.next}while(l!==t)}function u(t,e,n,r){var s,o,a,l,h,c=[];for(s=0,o=e.length;s<o;s++)a=e[s]*r,l=s<o-1?e[s+1]*r:t.length,h=i(t,a,l,r,!1),h===h.next&&(h.steiner=!0),c.push(v(h));for(c.sort(f),s=0;s<c.length;s++)n=d(c[s],n);return n}function f(t,e){return t.x-e.x}function d(t,e){var n=p(t,e);if(!n)return e;var r=E(n,t);return s(r,r.next),s(n,n.next)}function p(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&x(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),C(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&A(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}function A(t,e){return w(t.prev,t,e.prev)<0&&w(e.next,t,t.next)<0}function g(t,e,n,r){var i=t;do{0===i.z&&(i.z=y(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,m(i)}function m(t){var e,n,r,i,s,o,a,l,h=1;do{n=t,t=null,s=null,o=0;while(n){for(o++,r=n,a=0,e=0;e<h;e++)if(a++,r=r.nextZ,!r)break;l=h;while(a>0||l>0&&r)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1);return t}function y(t,e,n,r,i){return t=(t-n)*i|0,e=(e-r)*i|0,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function v(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function x(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!I(t,e)&&(C(t,e)&&C(e,t)&&O(t,e)&&(w(t.prev,t,e.prev)||w(t,e.prev,e))||_(t,e)&&w(t.prev,t,t.next)>0&&w(e.prev,e,e.next)>0)}function w(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function _(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){var i=S(w(t,e,n)),s=S(w(t,e,r)),o=S(w(n,r,t)),a=S(w(n,r,e));return i!==s&&o!==a||(!(0!==i||!T(t,n,e))||(!(0!==s||!T(t,r,e))||(!(0!==o||!T(n,t,r))||!(0!==a||!T(n,e,r)))))}function T(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function S(t){return t>0?1:t<0?-1:0}function I(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function C(t,e){return w(t.prev,t,t.next)<0?w(t,e,t.next)>=0&&w(t,t.prev,e)>=0:w(t,e,t.prev)<0||w(t,t.next,e)<0}function O(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!==n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}function E(t,e){var n=new R(t.i,t.x,t.y),r=new R(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function P(t,e,n,r){var i=new R(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function R(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function N(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}t.exports=r,t.exports.default=r,r.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(N(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(N(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},r.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n}},6929:function(t,e,n){"use strict";var r=n("1ab9"),i=n("bb15"),s=[].slice,o=["keyword","gray","hex"],a={};Object.keys(i).forEach((function(t){a[s.call(i[t].labels).sort().join("")]=t}));var l={};function h(t,e){if(!(this instanceof h))return new h(t,e);if(e&&e in o&&(e=null),e&&!(e in i))throw new Error("Unknown model: "+e);var n,c;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof h)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"===typeof t){var u=r.get(t);if(null===u)throw new Error("Unable to parse color from string: "+t);this.model=u.model,c=i[this.model].channels,this.color=u.value.slice(0,c),this.valpha="number"===typeof u.value[c]?u.value[c]:1}else if(t.length){this.model=e||"rgb",c=i[this.model].channels;var f=s.call(t,0,c);this.color=A(f,c),this.valpha="number"===typeof t[c]?t[c]:1}else if("number"===typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var d=Object.keys(t);"alpha"in t&&(d.splice(d.indexOf("alpha"),1),this.valpha="number"===typeof t.alpha?t.alpha:0);var p=d.sort().join("");if(!(p in a))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=a[p];var g=i[this.model].labels,m=[];for(n=0;n<g.length;n++)m.push(t[g[n]]);this.color=A(m)}if(l[this.model])for(c=i[this.model].channels,n=0;n<c;n++){var y=l[this.model][n];y&&(this.color[n]=y(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function c(t,e){return Number(t.toFixed(e))}function u(t){return function(e){return c(e,t)}}function f(t,e,n){return t=Array.isArray(t)?t:[t],t.forEach((function(t){(l[t]||(l[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),i=this[t](),i.color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function d(t){return function(e){return Math.max(0,Math.min(t,e))}}function p(t){return Array.isArray(t)?t:[t]}function A(t,e){for(var n=0;n<e;n++)"number"!==typeof t[n]&&(t[n]=0);return t}h.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in r.to?this:this.rgb();e=e.round("number"===typeof t?t:1);var n=1===e.valpha?e.color:e.color.concat(this.valpha);return r.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"===typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return r.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=i[this.model].channels,n=i[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new h(this.color.map(u(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new h(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:f("rgb",0,d(255)),green:f("rgb",1,d(255)),blue:f("rgb",2,d(255)),hue:f(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:f("hsl",1,d(100)),lightness:f("hsl",2,d(100)),saturationv:f("hsv",1,d(100)),value:f("hsv",2,d(100)),chroma:f("hcg",1,d(100)),gray:f("hcg",2,d(100)),white:f("hwb",1,d(100)),wblack:f("hwb",2,d(100)),cyan:f("cmyk",0,d(100)),magenta:f("cmyk",1,d(100)),yellow:f("cmyk",2,d(100)),black:f("cmyk",3,d(100)),x:f("xyz",0,d(100)),y:f("xyz",1,d(100)),z:f("xyz",2,d(100)),l:f("lab",0,d(100)),a:f("lab",1),b:f("lab",2),keyword:function(t){return arguments.length?new h(t):i[this.model].keyword(this.color)},hex:function(t){return arguments.length?new h(t):r.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color,e=(299*t[0]+587*t[1]+114*t[2])/1e3;return e<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return h.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n+t)%360,n=n<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,s=2*i-1,o=n.alpha()-r.alpha(),a=((s*o===-1?s:(s+o)/(1+s*o))+1)/2,l=1-a;return h.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(i).forEach((function(t){if(-1===o.indexOf(t)){var e=i[t].channels;h.prototype[t]=function(){if(this.model===t)return new h(this);if(arguments.length)return new h(arguments,t);var n="number"===typeof arguments[e]?e:this.valpha;return new h(p(i[this.model][t].raw(this.color)).concat(n),t)},h[t]=function(n){return"number"===typeof n&&(n=A(s.call(arguments),e)),new h(n,t)}}})),t.exports=h},"694b":function(t,e,n){"use strict";var r=Array.isArray,i=Object.keys,s=Object.prototype.hasOwnProperty;t.exports=function t(e,n){if(e===n)return!0;if(e&&n&&"object"==typeof e&&"object"==typeof n){var o,a,l,h=r(e),c=r(n);if(h&&c){if(a=e.length,a!=n.length)return!1;for(o=a;0!==o--;)if(!t(e[o],n[o]))return!1;return!0}if(h!=c)return!1;var u=e instanceof Date,f=n instanceof Date;if(u!=f)return!1;if(u&&f)return e.getTime()==n.getTime();var d=e instanceof RegExp,p=n instanceof RegExp;if(d!=p)return!1;if(d&&p)return e.toString()==n.toString();var A=i(e);if(a=A.length,a!==i(n).length)return!1;for(o=a;0!==o--;)if(!s.call(n,A[o]))return!1;for(o=a;0!==o--;)if(l=A[o],!t(e[l],n[l]))return!1;return!0}return e!==e&&n!==n}},"70f3":function(t,e,n){"use strict";n.d(e,"b",(function(){return s})),n.d(e,"c",(function(){return o})),n.d(e,"a",(function(){return y}));
/*!
    Feature Filter by

    (c) mapbox 2016 and maptalks 2018
    www.mapbox.com | www.maptalks.org
    License: MIT, header required.
*/
const r=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function i(t){return"object"===typeof t&&!!t}function s(t){return new Function("f","var p = (f && f.properties || {}); return "+a(t))}function o(t){if(!0===t||!1===t)return!0;if(!Array.isArray(t)||0===t.length)return!1;switch(t[0]){case"has":case"!has":return 2===t.length&&("string"===typeof t[1]||t[1].property&&t[1].op);case"in":case"!in":return t.length>=2&&("string"===typeof t[1]||t[1].property&&t[1].op);case"==":case"!=":case">":case">=":case"<":case"<=":return 3===t.length&&("string"===typeof t[1]||t[1].property&&t[1].op);case"none":case"any":case"all":for(const e of t.slice(1))if(!o(e)&&"boolean"!==typeof e)return!1;return!0;case"contains":return!0;default:return!1}}function a(t){if(!t)return"true";const e=t[0];if(t.length<=1)return"any"===e?"false":"true";const n="=="===e?u(t[1],t[2],"===",!1):"!="===e?u(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?u(t[1],t[2],e,!0):"any"===e?d(t.slice(1),"||"):"all"===e?d(t.slice(1),"&&"):"none"===e?g(d(t.slice(1),"||")):"in"===e?p(t[1],t.slice(2)):"!in"===e?g(p(t[1],t.slice(2))):"has"===e?A(t[1]):"!has"===e?g(A(t[1])):"contains"===e?h(t[1],t[2],t[3]):"true";return`(${n})`}function l(t,e,n,r){const i=t.property,s=t.op;let o=c(i);return"length"!==s?(console.error(`not support ${s} op`),"false"):(o=`((${o}+='').length)`,f(o,i,e,n,r))}function h(t,e,n){const r=c(t);return void 0!==n?`(${r} + '').indexOf("${e}") === ${n}`:`(${r} + '').indexOf("${e}") >= 0`}function c(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function u(t,e,n,r){if(i(t)&&t.op)return l(t,e,n,r);const s=c(t);return f(s,t,e,n,r)}function f(t,e,n,i,s){const o="$type"===e?r.indexOf(n):JSON.stringify(n);return(s?`typeof ${t}=== typeof ${o}&&`:"")+t+i+o}function d(t,e){return t.map(a).join(e)}function p(t,e){"$type"===t&&(e=e.map(t=>r.indexOf(t)));const n=JSON.stringify(e.sort(m)),i=c(t);return e.length<=200?`${n}.indexOf(${i}) !== -1`:`function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }(${i}, ${n},0,${e.length-1})`}function A(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function g(t){return`!(${t})`}function m(t,e){return t<e?-1:t>e?1:0}function y(t){if(!Array.isArray(t))return y([t]);const e=[];for(let n=0;n<t.length;n++){let r;r=!0===t[n]["filter"]?function(){return!0}:s(t[n]["filter"]),e.push(v({},t[n],{filter:r}))}return e}function v(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}},7555:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return kr})),n.d(e,"b",(function(){return ho})),n.d(e,"c",(function(){return Sr})),n.d(e,"d",(function(){return lo})),n.d(e,"e",(function(){return to})),n.d(e,"f",(function(){return Ws})),n.d(e,"g",(function(){return no})),n.d(e,"h",(function(){return ks})),n.d(e,"i",(function(){return io})),n.d(e,"j",(function(){return Ts})),n.d(e,"k",(function(){return Xs})),n.d(e,"l",(function(){return fo})),n.d(e,"m",(function(){return uo})),n.d(e,"n",(function(){return lt})),n.d(e,"o",(function(){return as})),n.d(e,"p",(function(){return ht})),n.d(e,"q",(function(){return Qr})),n.d(e,"r",(function(){return Hr}));var r=n("c674"),i=n.n(r),s=n("3dd5"),o=n("f139"),a=n("6929"),l=n.n(a),h=n("70f3"),c=n("61ca"),u=n.n(c),f=n("fa35"),d=(n("8cfe"),n("66b4")),p=n.n(d),A=n("c3b8"),g=n("18b7");
/*!
 * @maptalks/vector-packer v0.95.0
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */
const m={Point:1,LineString:2,Polygon:3,MultiPoint:4,MultiLineString:5,MultiPolygon:6};function y(t,e={}){var n=[];if("FeatureCollection"===t.type)for(var r=0;r<t.features.length;r++)v(n,t.features[r],e,r);else v(n,"Feature"===t.type?t:{geometry:t},e);return n}function v(t,e,n,r){if(e.geometry&&e.geometry.geometry){var i=e.geometry.coordinates,s=e.geometry.type,o=[],a=e.id;if(n.promoteId?a=e.properties[n.promoteId]:n.generateId&&(a=r||0),"Point"===s)x(i,o);else if("MultiPoint"===s)for(var l=0;l<i.length;l++)x(i[l],o);else if("LineString"===s)w([i],o);else if("MultiLineString"===s){if(n.lineMetrics){for(l=0;l<i.length;l++)b(i[l],o=[]),t.push(_(a,"LineString",o,e.properties));return}w(i,o)}else if("Polygon"===s)w(i,o);else{if("MultiPolygon"!==s){if("GeometryCollection"===s){for(l=0;l<e.geometry.geometries.length;l++)v(t,{id:a,geometry:e.geometry.geometries[l],properties:e.properties},n,r);return}return void console.warn(`Input data type(${s}) is not a valid GeoJSON geometry type.`)}for(l=0;l<i.length;l++){var h=[];w(i[l],h),o.push(h)}}t.push(_(a,s,o,e.properties))}}function x(t,e){const n=new i.a(t[0],t[1]);n.z=100*(t[2]||0),e.push([n])}function b(t,e){for(let n=0;n<t.length;n++){const r=new i.a(t[n][0],t[n][1]);r.z=100*(t[n][2]||0),e.push(r)}}function w(t,e,n,r){for(var i=0;i<t.length;i++){var s=[];b(t[i],s),e.push(s)}}function _(t,e,n,r){return{id:void 0===t?null:t,type:m[e],geometry:n,properties:r}}
/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 */function M(t,{width:e,height:n},r,i){if(i){if(i.length!==e*n*r)throw new RangeError("mismatched image size")}else i=new Uint8Array(e*n*r);return t.width=e,t.height=n,t.data=i,t}function T(t,{width:e,height:n},r){if(e===t.width&&n===t.height)return;const i=M({},{width:e,height:n},r);S(t,i,{x:0,y:0},{x:0,y:0},{width:Math.min(t.width,e),height:Math.min(t.height,n)},r),t.width=e,t.height=n,t.data=i.data}function S(t,e,n,r,i,s){if(0===i.width||0===i.height)return e;if(i.width>t.width||i.height>t.height||n.x>t.width-i.width||n.y>t.height-i.height)throw new RangeError("out of range source coordinates for image copy");if(i.width>e.width||i.height>e.height||r.x>e.width-i.width||r.y>e.height-i.height)throw new RangeError("out of range destination coordinates for image copy");const o=t.data,a=e.data;if(o===a)return e;for(let l=0;l<i.height;l++){const h=((n.y+l)*t.width+n.x)*s,c=((r.y+l)*e.width+r.x)*s;for(let t=0;t<i.width*s;t++)a[c+t]=o[h+t]}return e}class I{constructor(t,e){M(this,t,1,e)}resize(t){T(this,t,1)}clone(){return new I({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,r,i){S(t,e,n,r,i,1)}}class C{constructor(t,e){M(this,t,4,e)}resize(t){T(this,t,4)}clone(){return new C({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(t,e,n,r,i){S(t,e,n,r,i,4)}}function O(t){let e=0;for(let n,r,i=0,s=t.length,o=s-1;i<s;o=i++)if(n=t[i],r=t[o],void 0!==n.x){if(n.z||r.z)return 1;e+=(r.x-n.x)*(n.y+r.y)}else{if(n[2]||r[2])return 1;e+=(r[0]-n[0])*(n[1]+r[1])}return e}function E(t,e,n){let r=n;return e&&t&&(r=+t[e]),isNaN(r)&&(r=n||0),100*r}function P(t,e,n,r,i,s,o){e||0===e||(e=1);const a=E(t.properties,n,r),l=a*e;let h=(s?100*s:0)||a;return i?h=E(t.properties,i,s):o&&(h=a-E(t.properties,o,s)),h*=e,{altitude:l,height:h}}function k(t,e){return e<1/0&&(t.x<0||t.x>e||t.y<0||t.y>e)}function R(t){return null==t}function N(t,e,n){if(t===n||t===e)return t;const r=n-e;return((t-e)%r+r)%r+e}function D(t,e){if(!e)return null;const n=new Map;for(let r=0;r<e.length;r++){const i=e[r],s=t[i];let o=n.get(s);o||(o=[],n.set(s,o)),o.push(i)}return n}function F(t){return 0==(t&t-1)&&0!==t}
/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 */class L{constructor(t,e,{pixelRatio:n}){this.paddedRect=t,this.pixelRatio=n||1,this.padding=e}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.pixelRatio,(this.paddedRect.h-2*this.padding)/this.pixelRatio]}}class z{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e=Object.keys(t).length,n={},r=new s["a"](0,0,{autoResize:!0}),i=[],o=e>1?1:0;for(const s in t){const e=t[s],r={x:0,y:0,w:e.data.width+2*o,h:e.data.height+2*o};i.push(r),n[s]=new L(r,o,e)}if(r.pack(i,{inPlace:!0}),!F(r.w)||!F(r.h)){const t=B(r.w),e=B(r.h);r.resize(t,e)}const a=new C({width:r.w,height:r.h});for(const s in t){const e=t[s],r=n[s].paddedRect;C.copy(e.data,a,{x:0,y:0},{x:r.x+o,y:r.y+o},e.data)}this.image=a,this.positions=n}}function B(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))}
/*!
 * Codes from mapbox-gl-js
 * github.com/mapbox/mapbox-gl-js
 * MIT License
 * TODO potpack
 */class H{constructor(t){this.glyphMap=t,this.build()}build(){const t=this.glyphMap,e={},n=new s["a"](0,0,{autoResize:!0}),r=[];for(const s in t){const n=t[s],i=e[s]={};for(const t in n){const e=n[+t];if(!e||0===e.bitmap.width||0===e.bitmap.height)continue;const s={x:0,y:0,w:e.bitmap.width+2,h:e.bitmap.height+2};r.push(s),i[t]={rect:s,metrics:e.metrics}}}n.pack(r,{inPlace:!0});const i=new I({width:n.w,height:n.h});for(const s in t){const n=t[s];for(const t in n){const r=n[+t];if(!r||0===r.bitmap.width||0===r.bitmap.height)continue;const o=e[s][t].rect;I.copy(r.bitmap,i,{x:0,y:0},{x:o.x+1,y:o.y+1},r.bitmap)}}this.image=i,this.positions=e}}function U(t){return t<65536?Uint16Array:Uint32Array}function j(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:(Math.pow(2,24),Float32Array)}function V(t){return t<256?Uint8Array:t<65536?Uint16Array:Float32Array}function G(t,e){const n=t.length;t=t._origin||t;const r=new e(n);for(let i=0;i<n;i++)r[i]=t[i];return r}function q(t){const e=t.type,n=[];if(1===e||4===e)for(let r=0;r<t.geometry.length;r++)x(t.geometry[r],n);else if(2===e)w(t.geometry,n);else if(3===e)w(t.geometry,n);else if(5===e)w(t.geometry,n);else if(6===e)for(let r=0;r<t.geometry.length;r++){const e=[];w(t.geometry[r],e),n.push(e)}return t.geometry=n,t}function W(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function X(t){return null==t}function Q(t){return"number"==typeof t&&!isNaN(t)}function Y(t){return"object"==typeof t&&!!t}function Z(t){return!X(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function K(t){return!X(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const J=Object.prototype.hasOwnProperty;function $(t,e){return J.call(t,e)}const tt=Math.PI/180;function et(t){return t&&Object(o["c"])(t)&&t.property}function nt(t){const{verticalCentimeterToPoint:e,tileRatio:n}=t;return e*n}function rt(t){return"centimeter"===t||"cm"===t?1:"millimeter"===t||"mm"===t?.1:100}const it={};function st(t,e){if(!Array.isArray(e)){if(e&&void 0!==e.r&&void 0!==e.g&&void 0!==e.b)return t[0]=255*e.r,t[1]=255*e.g,t[2]=255*e.b,t[3]=void 0!==e.a?255*e.a:255,t;e=it[e]=it[e]||l()(e).unitArray()}for(let n=0;n<e.length;n++)t[n]=255*e[n];return 3===e.length&&(t[3]=255),t}const ot={textFill:1,textSize:1,textOpacity:1,textDx:1,textDy:1,markerWidth:1,markerHeight:1,markerOpacity:1,markerDx:1,markerDy:1,lineWidth:1,lineColor:1,lineOpacity:1,polygonFill:1,polygonOpacity:1,polygonPatternFileWidth:1,polygonPatternFileOrigin:1},at={textName:1,markerTextFitPadding:1,markerTextFit:1,lineGradientProperty:1};var lt=Object.freeze({__proto__:null,now:function(){return Date.now()},extend:W,isNil:X,isNumber:Q,isInteger:function(t){return(0|t)===t},isObject:Y,isString:Z,isFunction:K,hasOwn:$,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},toRadian:function(t){return t*tt},toDegree:function(t){return t/tt},evaluate:function(t,e,n){return K(t)?t(void 0!==n?n:null,e):t},isFnTypeSymbol:et,getAltitudeToLocal:nt,getTubeSizeScale:rt,normalizeColor:st,checkIfIdentityZoomDependent:function(t,e,n){if(Array.isArray(n)||(n=Object.values(n)),!n||!n.length)return!1;if(!ot[t])return!1;for(let r=0;r<n.length;r++){const t=n[r]&&(n[r].feature||n[r]);if(!t)continue;const i=t.properties&&t.properties[e];if(i&&Object(o["c"])(i)&&!Object(o["b"])(i).isZoomConstant)return!0}return!1},checkIfZoomFnTypeSymbol:function(t){return!!ot[t]||!!at[t]}});class ht{constructor(t,e,n,r){this.feature=t,this.symbol=e,this.fnTypes=n,this.options=r}getPolygonResource(){let t=this.symbol.polygonPatternFile;const{polygonPatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}getLineResource(){let t=this.symbol.linePatternFile;const{linePatternFileFn:e}=this.fnTypes;return this._getResource(t,e)}_getResource(t,e){return e&&(t=e(this.options.zoom,this.feature.properties)),t}}function ct(t,e,n,r){const i=Math.abs(r)>>15,s=i>>1,o=i%2;let a=r%Math.pow(2,15);const l=e+(s<<14)*Math.sign(e),h=n+(o<<14)*Math.sign(n);return t[0]=l,t[1]=h,a=Math.round(a),t[2]=0===a?r<0?-1:0:a,t}const ut=Math.pow(2,14),ft=Math.pow(2,15);
/*!
 * a compact version of mapbox-gl-style-spec
 * based on mapbox-gl-style-spec@13.28.0
 * https://github.com/mapbox/mapbox-gl-js/tree/main/src/style-spec
 * LICENSE : ISC
 */var dt,pt,At="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof t?t:"undefined"!=typeof self?self:{},gt={exports:{}};function mt(t,...e){for(const n of e)for(const e in n)t[e]=n[e];return t}
/*! https://mths.be/punycode v1.3.2 by @mathias */dt=gt,pt=gt.exports,function(t){var e=pt&&!pt.nodeType&&pt,n=dt&&!dt.nodeType&&dt,r="object"==typeof At&&At;r.global!==r&&r.window!==r&&r.self!==r||(t=r);var i,s,o=2147483647,a=/^xn--/,l=/[^\x20-\x7E]/,h=/[\x2E\u3002\uFF0E\uFF61]/g,c={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},u=Math.floor,f=String.fromCharCode;function d(t){throw RangeError(c[t])}function p(t,e){for(var n=t.length,r=[];n--;)r[n]=e(t[n]);return r}function A(t,e){var n=t.split("@"),r="";return n.length>1&&(r=n[0]+"@",t=n[1]),r+p((t=t.replace(h,".")).split("."),e).join(".")}function g(t){for(var e,n,r=[],i=0,s=t.length;i<s;)(e=t.charCodeAt(i++))>=55296&&e<=56319&&i<s?56320==(64512&(n=t.charCodeAt(i++)))?r.push(((1023&e)<<10)+(1023&n)+65536):(r.push(e),i--):r.push(e);return r}function m(t){return p(t,(function(t){var e="";return t>65535&&(e+=f((t-=65536)>>>10&1023|55296),t=56320|1023&t),e+f(t)})).join("")}function y(t,e){return t+22+75*(t<26)-((0!=e)<<5)}function v(t,e,n){var r=0;for(t=n?u(t/700):t>>1,t+=u(t/e);t>455;r+=36)t=u(t/35);return u(r+36*t/(t+38))}function x(t){var e,n,r,i,s,a,l,h,c,f,p,A=[],g=t.length,y=0,x=128,b=72;for((n=t.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)t.charCodeAt(r)>=128&&d("not-basic"),A.push(t.charCodeAt(r));for(i=n>0?n+1:0;i<g;){for(s=y,a=1,l=36;i>=g&&d("invalid-input"),((h=(p=t.charCodeAt(i++))-48<10?p-22:p-65<26?p-65:p-97<26?p-97:36)>=36||h>u((o-y)/a))&&d("overflow"),y+=h*a,!(h<(c=l<=b?1:l>=b+26?26:l-b));l+=36)a>u(o/(f=36-c))&&d("overflow"),a*=f;b=v(y-s,e=A.length+1,0==s),u(y/e)>o-x&&d("overflow"),x+=u(y/e),y%=e,A.splice(y++,0,x)}return m(A)}function b(t){var e,n,r,i,s,a,l,h,c,p,A,m,x,b,w,_=[];for(m=(t=g(t)).length,e=128,n=0,s=72,a=0;a<m;++a)(A=t[a])<128&&_.push(f(A));for(r=i=_.length,i&&_.push("-");r<m;){for(l=o,a=0;a<m;++a)(A=t[a])>=e&&A<l&&(l=A);for(l-e>u((o-n)/(x=r+1))&&d("overflow"),n+=(l-e)*x,e=l,a=0;a<m;++a)if((A=t[a])<e&&++n>o&&d("overflow"),A==e){for(h=n,c=36;!(h<(p=c<=s?1:c>=s+26?26:c-s));c+=36)_.push(f(y(p+(w=h-p)%(b=36-p),0))),h=u(w/b);_.push(f(y(h,0))),s=v(n,x,r==i),n=0,++r}++n,++e}return _.join("")}if(i={version:"1.3.2",ucs2:{decode:g,encode:m},decode:x,encode:b,toASCII:function(t){return A(t,(function(t){return l.test(t)?"xn--"+b(t):t}))},toUnicode:function(t){return A(t,(function(t){return a.test(t)?x(t.slice(4).toLowerCase()):t}))}},e&&n)if(dt.exports==e)n.exports=i;else for(s in i)i.hasOwnProperty(s)&&(e[s]=i[s]);else t.punycode=i}(At);class yt extends Error{constructor(t,e){super(e),this.message=e,this.key=t}}var vt=yt;class xt{constructor(t,e=[]){this.parent=t,this.bindings={};for(const[n,r]of e)this.bindings[n]=r}concat(t){return new xt(this,t)}get(t){if(this.bindings[t])return this.bindings[t];if(this.parent)return this.parent.get(t);throw new Error(t+" not found in scope.")}has(t){return!!this.bindings[t]||!!this.parent&&this.parent.has(t)}}var bt=xt;const wt={kind:"null"},_t={kind:"number"},Mt={kind:"string"},Tt={kind:"boolean"},St={kind:"color"},It={kind:"object"},Ct={kind:"value"},Ot={kind:"collator"},Et={kind:"formatted"},Pt={kind:"resolvedImage"};function kt(t,e){return{kind:"array",itemType:t,N:e}}function Rt(t){if("array"===t.kind){const e=Rt(t.itemType);return"number"==typeof t.N?`array<${e}, ${t.N}>`:"value"===t.itemType.kind?"array":`array<${e}>`}return t.kind}const Nt=[wt,_t,Mt,Tt,St,Et,It,kt(Ct),Pt];function Dt(t,e){if("error"===e.kind)return null;if("array"===t.kind){if("array"===e.kind&&(0===e.N&&"value"===e.itemType.kind||!Dt(t.itemType,e.itemType))&&("number"!=typeof t.N||t.N===e.N))return null}else{if(t.kind===e.kind)return null;if("value"===t.kind)for(const t of Nt)if(!Dt(t,e))return null}return`Expected ${Rt(t)} but found ${Rt(e)} instead.`}function Ft(t,e){return e.some(e=>e.kind===t.kind)}function Lt(t,e){return e.some(e=>"null"===e?null===t:"array"===e?Array.isArray(t):"object"===e?t&&!Array.isArray(t)&&"object"==typeof t:e===typeof t)}var zt,Bt={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function Ht(t){return(t=Math.round(t))<0?0:t>255?255:t}function Ut(t){return t<0?0:t>1?1:t}function jt(t){return Ht("%"===t[t.length-1]?parseFloat(t)/100*255:parseInt(t))}function Vt(t){return Ut("%"===t[t.length-1]?parseFloat(t)/100:parseFloat(t))}function Gt(t,e,n){return n<0?n+=1:n>1&&(n-=1),6*n<1?t+(e-t)*n*6:2*n<1?e:3*n<2?t+(e-t)*(2/3-n)*6:t}try{zt={}.parseCSSColor=function(t){var e,n=t.replace(/ /g,"").toLowerCase();if(n in Bt)return Bt[n].slice();if("#"===n[0])return 4===n.length?(e=parseInt(n.substr(1),16))>=0&&e<=4095?[(3840&e)>>4|(3840&e)>>8,240&e|(240&e)>>4,15&e|(15&e)<<4,1]:null:7===n.length&&(e=parseInt(n.substr(1),16))>=0&&e<=16777215?[(16711680&e)>>16,(65280&e)>>8,255&e,1]:null;var r=n.indexOf("("),i=n.indexOf(")");if(-1!==r&&i+1===n.length){var s=n.substr(0,r),o=n.substr(r+1,i-(r+1)).split(","),a=1;switch(s){case"rgba":if(4!==o.length)return null;a=Vt(o.pop());case"rgb":return 3!==o.length?null:[jt(o[0]),jt(o[1]),jt(o[2]),a];case"hsla":if(4!==o.length)return null;a=Vt(o.pop());case"hsl":if(3!==o.length)return null;var l=(parseFloat(o[0])%360+360)%360/360,h=Vt(o[1]),c=Vt(o[2]),u=c<=.5?c*(h+1):c+h-c*h,f=2*c-u;return[Ht(255*Gt(f,u,l+1/3)),Ht(255*Gt(f,u,l)),Ht(255*Gt(f,u,l-1/3)),a];default:return null}}return null}}catch(po){}class qt{constructor(t,e,n,r=1){this.r=t,this.g=e,this.b=n,this.a=r}static parse(t){if(!t)return;if(t instanceof qt)return t;if("string"!=typeof t)return;const e=zt(t);return e?new qt(e[0]/255*e[3],e[1]/255*e[3],e[2]/255*e[3],e[3]):void 0}toString(){const[t,e,n,r]=this.toArray();return`rgba(${Math.round(t)},${Math.round(e)},${Math.round(n)},${r})`}toArray(){const{r:t,g:e,b:n,a:r}=this;return 0===r?[0,0,0,0]:[255*t/r,255*e/r,255*n/r,r]}toArray01(){const{r:t,g:e,b:n,a:r}=this;return 0===r?[0,0,0,0]:[t/r,e/r,n/r,r]}toArray01PremultipliedAlpha(){const{r:t,g:e,b:n,a:r}=this;return[t,e,n,r]}}qt.black=new qt(0,0,0,1),qt.white=new qt(1,1,1,1),qt.transparent=new qt(0,0,0,0),qt.red=new qt(1,0,0,1),qt.blue=new qt(0,0,1,1);var Wt=qt;class Xt{constructor(t,e,n){this.sensitivity=t?e?"variant":"case":e?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(t,e){return this.collator.compare(t,e)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class Qt{constructor(t,e,n,r,i){this.text=t.normalize?t.normalize():t,this.image=e,this.scale=n,this.fontStack=r,this.textColor=i}}class Yt{constructor(t){this.sections=t}static fromString(t){return new Yt([new Qt(t,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some(t=>0!==t.text.length||t.image&&0!==t.image.name.length)}static factory(t){return t instanceof Yt?t:Yt.fromString(t)}toString(){return 0===this.sections.length?"":this.sections.map(t=>t.text).join("")}serialize(){const t=["format"];for(const e of this.sections){if(e.image){t.push(["image",e.image.name]);continue}t.push(e.text);const n={};e.fontStack&&(n["text-font"]=["literal",e.fontStack.split(",")]),e.scale&&(n["font-scale"]=e.scale),e.textColor&&(n["text-color"]=["rgba"].concat(e.textColor.toArray())),t.push(n)}return t}}class Zt{constructor(t){this.name=t.name,this.available=t.available}toString(){return this.name}static fromString(t){return t?new Zt({name:t,available:!1}):null}serialize(){return["image",this.name]}}function Kt(t,e,n,r){return"number"==typeof t&&t>=0&&t<=255&&"number"==typeof e&&e>=0&&e<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[t,e,n,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[t,e,n,r]:[t,e,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Jt(t){if(null===t)return!0;if("string"==typeof t)return!0;if("boolean"==typeof t)return!0;if("number"==typeof t)return!0;if(t instanceof Wt)return!0;if(t instanceof Xt)return!0;if(t instanceof Yt)return!0;if(t instanceof Zt)return!0;if(Array.isArray(t)){for(const e of t)if(!Jt(e))return!1;return!0}if("object"==typeof t){for(const e in t)if(!Jt(t[e]))return!1;return!0}return!1}function $t(t){if(null===t)return wt;if("string"==typeof t)return Mt;if("boolean"==typeof t)return Tt;if("number"==typeof t)return _t;if(t instanceof Wt)return St;if(t instanceof Xt)return Ot;if(t instanceof Yt)return Et;if(t instanceof Zt)return Pt;if(Array.isArray(t)){const e=t.length;let n;for(const r of t){const t=$t(r);if(n){if(n===t)continue;n=Ct;break}n=t}return kt(n||Ct,e)}return It}function te(t){const e=typeof t;return null===t?"":"string"===e||"number"===e||"boolean"===e?String(t):t instanceof Wt||t instanceof Yt||t instanceof Zt?t.toString():JSON.stringify(t)}class ee{constructor(t,e){this.type=t,this.value=e}static parse(t,e){if(2!==t.length)return e.error(`'literal' expression requires exactly one argument, but found ${t.length-1} instead.`);if(!Jt(t[1]))return e.error("invalid value");const n=t[1];let r=$t(n);const i=e.expectedType;return"array"!==r.kind||0!==r.N||!i||"array"!==i.kind||"number"==typeof i.N&&0!==i.N||(r=i),new ee(r,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return"array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Wt?["rgba"].concat(this.value.toArray()):this.value instanceof Yt?this.value.serialize():this.value}}var ne=ee,re=class{constructor(t){this.name="ExpressionEvaluationError",this.message=t}toJSON(){return this.message}};const ie={string:Mt,number:_t,boolean:Tt,object:It};class se{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");let n,r=1;const i=t[0];if("array"===i){let i,s;if(t.length>2){const n=t[1];if("string"!=typeof n||!(n in ie)||"object"===n)return e.error('The item type argument of "array" must be one of string, number, boolean',1);i=ie[n],r++}else i=Ct;if(t.length>3){if(null!==t[2]&&("number"!=typeof t[2]||t[2]<0||t[2]!==Math.floor(t[2])))return e.error('The length argument to "array" must be a positive integer literal',2);s=t[2],r++}n=kt(i,s)}else n=ie[i];const s=[];for(;r<t.length;r++){const n=e.parse(t[r],r,Ct);if(!n)return null;s.push(n)}return new se(n,s)}evaluate(t){for(let e=0;e<this.args.length;e++){const n=this.args[e].evaluate(t);if(!Dt(this.type,$t(n)))return n;if(e===this.args.length-1)throw new re(`Expected value to be of type ${Rt(this.type)}, but found ${Rt($t(n))} instead.`)}return null}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=this.type,e=[t.kind];if("array"===t.kind){const n=t.itemType;if("string"===n.kind||"number"===n.kind||"boolean"===n.kind){e.push(n.kind);const r=t.N;("number"==typeof r||this.args.length>1)&&e.push(r)}}return e.concat(this.args.map(t=>t.serialize()))}}var oe=se;class ae{constructor(t){this.type=Et,this.sections=t}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[1];if(!Array.isArray(n)&&"object"==typeof n)return e.error("First argument must be an image or text section.");const r=[];let i=!1;for(let s=1;s<=t.length-1;++s){const n=t[s];if(i&&"object"==typeof n&&!Array.isArray(n)){i=!1;let t=null;if(n["font-scale"]&&(t=e.parse(n["font-scale"],1,_t),!t))return null;let s=null;if(n["text-font"]&&(s=e.parse(n["text-font"],1,kt(Mt)),!s))return null;let o=null;if(n["text-color"]&&(o=e.parse(n["text-color"],1,St),!o))return null;const a=r[r.length-1];a.scale=t,a.font=s,a.textColor=o}else{const n=e.parse(t[s],1,Ct);if(!n)return null;const o=n.type.kind;if("string"!==o&&"value"!==o&&"null"!==o&&"resolvedImage"!==o)return e.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");i=!0,r.push({content:n,scale:null,font:null,textColor:null})}}return new ae(r)}evaluate(t){return new Yt(this.sections.map(e=>{const n=e.content.evaluate(t);return $t(n)===Pt?new Qt("",n,null,null,null):new Qt(te(n),null,e.scale?e.scale.evaluate(t):null,e.font?e.font.evaluate(t).join(","):null,e.textColor?e.textColor.evaluate(t):null)}))}eachChild(t){for(const e of this.sections)t(e.content),e.scale&&t(e.scale),e.font&&t(e.font),e.textColor&&t(e.textColor)}outputDefined(){return!1}serialize(){const t=["format"];for(const e of this.sections){t.push(e.content.serialize());const n={};e.scale&&(n["font-scale"]=e.scale.serialize()),e.font&&(n["text-font"]=e.font.serialize()),e.textColor&&(n["text-color"]=e.textColor.serialize()),t.push(n)}return t}}class le{constructor(t){this.type=Pt,this.input=t}static parse(t,e){if(2!==t.length)return e.error("Expected two arguments.");const n=e.parse(t[1],1,Mt);return n?new le(n):e.error("No image name provided.")}evaluate(t){const e=this.input.evaluate(t),n=Zt.fromString(e);return n&&t.availableImages&&(n.available=t.availableImages.indexOf(e)>-1),n}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){return["image",this.input.serialize()]}}const he={"to-boolean":Tt,"to-color":St,"to-number":_t,"to-string":Mt};class ce{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expected at least one argument.");const n=t[0];if(("to-boolean"===n||"to-string"===n)&&2!==t.length)return e.error("Expected one argument.");const r=he[n],i=[];for(let s=1;s<t.length;s++){const n=e.parse(t[s],s,Ct);if(!n)return null;i.push(n)}return new ce(r,i)}evaluate(t){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(t));if("color"===this.type.kind){let e,n;for(const r of this.args){if(e=r.evaluate(t),n=null,e instanceof Wt)return e;if("string"==typeof e){const n=t.parseColor(e);if(n)return n}else if(Array.isArray(e)&&(n=e.length<3||e.length>4?`Invalid rbga value ${JSON.stringify(e)}: expected an array containing either three or four numeric values.`:Kt(e[0],e[1],e[2],e[3]),!n))return new Wt(e[0]/255,e[1]/255,e[2]/255,e[3])}throw new re(n||`Could not parse color from value '${"string"==typeof e?e:String(JSON.stringify(e))}'`)}if("number"===this.type.kind){let e=null;for(const n of this.args){if(e=n.evaluate(t),null===e)return 0;const r=Number(e);if(!isNaN(r))return r}throw new re(`Could not convert ${JSON.stringify(e)} to number.`)}return"formatted"===this.type.kind?Yt.fromString(te(this.args[0].evaluate(t))):"resolvedImage"===this.type.kind?Zt.fromString(te(this.args[0].evaluate(t))):te(this.args[0].evaluate(t))}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){if("formatted"===this.type.kind)return new ae([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new le(this.args[0]).serialize();const t=["to-"+this.type.kind];return this.eachChild(e=>{t.push(e.serialize())}),t}}var ue=ce;const fe=["Unknown","Point","LineString","Polygon"];var de=class{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null}id(){return this.feature&&void 0!==this.feature.id?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?fe[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const t=this.featureDistanceData.center,e=this.featureDistanceData.scale,{x:n,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(n*e-t[0])+this.featureDistanceData.bearing[1]*(r*e-t[1])}return 0}parseColor(t){let e=this._parseColorCache[t];return e||(e=this._parseColorCache[t]=Wt.parse(t)),e}};class pe{constructor(t,e,n,r){this.name=t,this.type=e,this._evaluate=n,this.args=r}evaluate(t){return this._evaluate(t,this.args)}eachChild(t){this.args.forEach(t)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map(t=>t.serialize()))}static parse(t,e){const n=t[0],r=pe.definitions[n];if(!r)return e.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const i=Array.isArray(r)?r[0]:r.type,s=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,o=s.filter(([e])=>!Array.isArray(e)||e.length===t.length-1);let a=null;for(const[l,h]of o){a=new He(e.registry,e.path,null,e.scope);const r=[];let s=!1;for(let e=1;e<t.length;e++){const n=t[e],i=Array.isArray(l)?l[e-1]:l.type,o=a.parse(n,1+r.length,i);if(!o){s=!0;break}r.push(o)}if(!s)if(Array.isArray(l)&&l.length!==r.length)a.error(`Expected ${l.length} arguments, but found ${r.length} instead.`);else{for(let t=0;t<r.length;t++){const e=Array.isArray(l)?l[t]:l.type,n=r[t];a.concat(t+1).checkSubtype(e,n.type)}if(0===a.errors.length)return new pe(n,i,h,r)}}if(1===o.length)e.errors.push(...a.errors);else{const n=(o.length?o:s).map(([t])=>{return e=t,Array.isArray(e)?`(${e.map(Rt).join(", ")})`:`(${Rt(e.type)}...)`;var e}).join(" | "),r=[];for(let i=1;i<t.length;i++){const n=e.parse(t[i],1+r.length);if(!n)return null;r.push(Rt(n.type))}e.error(`Expected arguments of type ${n}, but found (${r.join(", ")}) instead.`)}return null}static register(t,e){pe.definitions=e;for(const n in e)t[n]=pe}}var Ae=pe;class ge{constructor(t,e,n){this.type=Ot,this.locale=n,this.caseSensitive=t,this.diacriticSensitive=e}static parse(t,e){if(2!==t.length)return e.error("Expected one argument.");const n=t[1];if("object"!=typeof n||Array.isArray(n))return e.error("Collator options argument must be an object.");const r=e.parse(void 0!==n["case-sensitive"]&&n["case-sensitive"],1,Tt);if(!r)return null;const i=e.parse(void 0!==n["diacritic-sensitive"]&&n["diacritic-sensitive"],1,Tt);if(!i)return null;let s=null;return n.locale&&(s=e.parse(n.locale,1,Mt),!s)?null:new ge(r,i,s)}evaluate(t){return new Xt(this.caseSensitive.evaluate(t),this.diacriticSensitive.evaluate(t),this.locale?this.locale.evaluate(t):null)}eachChild(t){t(this.caseSensitive),t(this.diacriticSensitive),this.locale&&t(this.locale)}outputDefined(){return!1}serialize(){const t={};return t["case-sensitive"]=this.caseSensitive.serialize(),t["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(t.locale=this.locale.serialize()),["collator",t]}}function me(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.max(t[2],e[0]),t[3]=Math.max(t[3],e[1])}function ye(t,e){return!(t[0]<=e[0])&&!(t[2]>=e[2])&&!(t[1]<=e[1])&&!(t[3]>=e[3])}function ve(t,e){const n=(180+t[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+t[1]*Math.PI/360)))/360,i=Math.pow(2,e.z);return[Math.round(n*i*8192),Math.round(r*i*8192)]}function xe(t,e,n){const r=t[0]-e[0],i=t[1]-e[1],s=t[0]-n[0],o=t[1]-n[1];return r*o-s*i==0&&r*s<=0&&i*o<=0}function be(t,e){let n=!1;for(let o=0,a=e.length;o<a;o++){const a=e[o];for(let e=0,o=a.length;e<o-1;e++){if(xe(t,a[e],a[e+1]))return!1;(i=a[e])[1]>(r=t)[1]!=(s=a[e+1])[1]>r[1]&&r[0]<(s[0]-i[0])*(r[1]-i[1])/(s[1]-i[1])+i[0]&&(n=!n)}}var r,i,s;return n}function we(t,e){for(let n=0;n<e.length;n++)if(be(t,e[n]))return!0;return!1}function _e(t,e,n,r){const i=r[0]-n[0],s=r[1]-n[1],o=(t[0]-n[0])*s-i*(t[1]-n[1]),a=(e[0]-n[0])*s-i*(e[1]-n[1]);return o>0&&a<0||o<0&&a>0}function Me(t,e,n){for(const h of n)for(let n=0;n<h.length-1;++n)if(a=void 0,l=void 0,0!=(a=[(o=h[n+1])[0]-(s=h[n])[0],o[1]-s[1]])[0]*(l=[(i=e)[0]-(r=t)[0],i[1]-r[1]])[1]-a[1]*l[0]&&_e(r,i,s,o)&&_e(s,o,r,i))return!0;var r,i,s,o,a,l;return!1}function Te(t,e){for(let n=0;n<t.length;++n)if(!be(t[n],e))return!1;for(let n=0;n<t.length-1;++n)if(Me(t[n],t[n+1],e))return!1;return!0}function Se(t,e){for(let n=0;n<e.length;n++)if(Te(t,e[n]))return!0;return!1}function Ie(t,e,n){const r=[];for(let i=0;i<t.length;i++){const s=[];for(let r=0;r<t[i].length;r++){const o=ve(t[i][r],n);me(e,o),s.push(o)}r.push(s)}return r}function Ce(t,e,n){const r=[];for(let i=0;i<t.length;i++){const s=Ie(t[i],e,n);r.push(s)}return r}function Oe(t,e,n,r){if(t[0]<n[0]||t[0]>n[2]){const e=.5*r;let i=t[0]-n[0]>e?-r:n[0]-t[0]>e?r:0;0===i&&(i=t[0]-n[2]>e?-r:n[2]-t[0]>e?r:0),t[0]+=i}me(e,t)}function Ee(t,e,n,r){const i=8192*Math.pow(2,r.z),s=[8192*r.x,8192*r.y],o=[];if(!t)return o;for(const a of t)for(const t of a){const r=[t.x+s[0],t.y+s[1]];Oe(r,e,n,i),o.push(r)}return o}function Pe(t,e,n,r){const i=8192*Math.pow(2,r.z),s=[8192*r.x,8192*r.y],o=[];if(!t)return o;for(const l of t){const t=[];for(const n of l){const r=[n.x+s[0],n.y+s[1]];me(e,r),t.push(r)}o.push(t)}if(e[2]-e[0]<=i/2){(a=e)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const t of o)for(const r of t)Oe(r,e,n,i)}var a;return o}class ke{constructor(t,e){this.type=Tt,this.geojson=t,this.geometries=e}static parse(t,e){if(2!==t.length)return e.error(`'within' expression requires exactly one argument, but found ${t.length-1} instead.`);if(Jt(t[1])){const e=t[1];if("FeatureCollection"===e.type)for(let t=0;t<e.features.length;++t){const n=e.features[t].geometry.type;if("Polygon"===n||"MultiPolygon"===n)return new ke(e,e.features[t].geometry)}else if("Feature"===e.type){const t=e.geometry.type;if("Polygon"===t||"MultiPolygon"===t)return new ke(e,e.geometry)}else if("Polygon"===e.type||"MultiPolygon"===e.type)return new ke(e,e)}return e.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(t){if(null!=t.geometry()&&null!=t.canonicalID()){if("Point"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===e.type){const s=Ie(e.coordinates,r,i),o=Ee(t.geometry(),n,r,i);if(!ye(n,r))return!1;for(const t of o)if(!be(t,s))return!1}if("MultiPolygon"===e.type){const s=Ce(e.coordinates,r,i),o=Ee(t.geometry(),n,r,i);if(!ye(n,r))return!1;for(const t of o)if(!we(t,s))return!1}return!0}(t,this.geometries);if("LineString"===t.geometryType())return function(t,e){const n=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],i=t.canonicalID();if(!i)return!1;if("Polygon"===e.type){const s=Ie(e.coordinates,r,i),o=Pe(t.geometry(),n,r,i);if(!ye(n,r))return!1;for(const t of o)if(!Te(t,s))return!1}if("MultiPolygon"===e.type){const s=Ce(e.coordinates,r,i),o=Pe(t.geometry(),n,r,i);if(!ye(n,r))return!1;for(const t of o)if(!Se(t,s))return!1}return!0}(t,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}var Re=ke;function Ne(t){if(t instanceof Ae){if("get"===t.name&&1===t.args.length)return!1;if("feature-state"===t.name)return!1;if("has"===t.name&&1===t.args.length)return!1;if("properties"===t.name||"geometry-type"===t.name||"id"===t.name)return!1;if(/^filter-/.test(t.name))return!1}if(t instanceof Re)return!1;let e=!0;return t.eachChild(t=>{e&&!Ne(t)&&(e=!1)}),e}function De(t){if(t instanceof Ae&&"feature-state"===t.name)return!1;let e=!0;return t.eachChild(t=>{e&&!De(t)&&(e=!1)}),e}function Fe(t,e){if(t instanceof Ae&&e.indexOf(t.name)>=0)return!1;let n=!0;return t.eachChild(t=>{n&&!Fe(t,e)&&(n=!1)}),n}class Le{constructor(t,e){this.type=e.type,this.name=t,this.boundExpression=e}static parse(t,e){if(2!==t.length||"string"!=typeof t[1])return e.error("'var' expression requires exactly one string literal argument.");const n=t[1];return e.scope.has(n)?new Le(n,e.scope.get(n)):e.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(t){return this.boundExpression.evaluate(t)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}var ze=Le;class Be{constructor(t,e=[],n,r=new bt,i=[]){this.registry=t,this.path=e,this.key=e.map(t=>`[${t}]`).join(""),this.scope=r,this.errors=i,this.expectedType=n}parse(t,e,n,r,i={}){return e?this.concat(e,n,r)._parse(t,i):this._parse(t,i)}_parse(t,e){function n(t,e,n){return"assert"===n?new oe(e,[t]):"coerce"===n?new ue(e,[t]):t}if(null!==t&&"string"!=typeof t&&"boolean"!=typeof t&&"number"!=typeof t||(t=["literal",t]),Array.isArray(t)){if(0===t.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const r=t[0];if("string"!=typeof r)return this.error(`Expression name must be a string, but found ${typeof r} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const i=this.registry[r];if(i){let r=i.parse(t,this);if(!r)return null;if(this.expectedType){const t=this.expectedType,i=r.type;if("string"!==t.kind&&"number"!==t.kind&&"boolean"!==t.kind&&"object"!==t.kind&&"array"!==t.kind||"value"!==i.kind)if("color"!==t.kind&&"formatted"!==t.kind&&"resolvedImage"!==t.kind||"value"!==i.kind&&"string"!==i.kind){if(this.checkSubtype(t,i))return null}else r=n(r,t,e.typeAnnotation||"coerce");else r=n(r,t,e.typeAnnotation||"assert")}if(!(r instanceof ne)&&"resolvedImage"!==r.type.kind&&function t(e){if(e instanceof ze)return t(e.boundExpression);if(e instanceof Ae&&"error"===e.name)return!1;if(e instanceof ge)return!1;if(e instanceof Re)return!1;const n=e instanceof ue||e instanceof oe;let r=!0;return e.eachChild(e=>{r=n?r&&t(e):r&&e instanceof ne}),!!r&&(Ne(e)&&Fe(e,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"]))}(r)){const e=new de;try{r=new ne(r.type,r.evaluate(e))}catch(t){return this.error(t.message),null}}return r}return this.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===t?"'undefined' value invalid. Use null instead.":"object"==typeof t?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof t} instead.`)}concat(t,e,n){const r="number"==typeof t?this.path.concat(t):this.path,i=n?this.scope.concat(n):this.scope;return new Be(this.registry,r,e||null,i,this.errors)}error(t,...e){const n=`${this.key}${e.map(t=>`[${t}]`).join("")}`;this.errors.push(new vt(n,t))}checkSubtype(t,e){const n=Dt(t,e);return n&&this.error(n),n}}var He=Be;function Ue(t,e){const n=t.length-1;let r,i,s=0,o=n,a=0;for(;s<=o;)if(a=Math.floor((s+o)/2),r=t[a],i=t[a+1],r<=e){if(a===n||e<i)return a;s=a+1}else{if(!(r>e))throw new re("Input is not a number.");o=a-1}return 0}class je{constructor(t,e,n){this.type=t,this.input=e,this.labels=[],this.outputs=[];for(const[r,i]of n)this.labels.push(r),this.outputs.push(i)}static parse(t,e){if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");const n=e.parse(t[1],1,_t);if(!n)return null;const r=[];let i=null;e.expectedType&&"value"!==e.expectedType.kind&&(i=e.expectedType);for(let s=1;s<t.length;s+=2){const n=1===s?-1/0:t[s],o=t[s+1],a=s,l=s+1;if("number"!=typeof n)return e.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(r.length&&r[r.length-1][0]>=n)return e.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const h=e.parse(o,l,i);if(!h)return null;i=i||h.type,r.push([n,h])}return new je(i,n,r)}evaluate(t){const e=this.labels,n=this.outputs;if(1===e.length)return n[0].evaluate(t);const r=this.input.evaluate(t);if(r<=e[0])return n[0].evaluate(t);const i=e.length;return r>=e[i-1]?n[i-1].evaluate(t):n[Ue(e,r)].evaluate(t)}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){const t=["step",this.input.serialize()];for(let e=0;e<this.labels.length;e++)e>0&&t.push(this.labels[e]),t.push(this.outputs[e].serialize());return t}}var Ve=je,Ge=qe;function qe(t,e,n,r){this.cx=3*t,this.bx=3*(n-t)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*e,this.by=3*(r-e)-this.cy,this.ay=1-this.cy-this.by,this.p1x=t,this.p1y=e,this.p2x=n,this.p2y=r}function We(t,e,n){return t*(1-n)+e*n}qe.prototype={sampleCurveX:function(t){return((this.ax*t+this.bx)*t+this.cx)*t},sampleCurveY:function(t){return((this.ay*t+this.by)*t+this.cy)*t},sampleCurveDerivativeX:function(t){return(3*this.ax*t+2*this.bx)*t+this.cx},solveCurveX:function(t,e){if(void 0===e&&(e=1e-6),t<0)return 0;if(t>1)return 1;for(var n=t,r=0;r<8;r++){var i=this.sampleCurveX(n)-t;if(Math.abs(i)<e)return n;var s=this.sampleCurveDerivativeX(n);if(Math.abs(s)<1e-6)break;n-=i/s}var o=0,a=1;for(n=t,r=0;r<20&&(i=this.sampleCurveX(n),!(Math.abs(i-t)<e));r++)t>i?o=n:a=n,n=.5*(a-o)+o;return n},solve:function(t,e){return this.sampleCurveY(this.solveCurveX(t,e))}};var Xe=Object.freeze({__proto__:null,number:We,color:function(t,e,n){return new Wt(We(t.r,e.r,n),We(t.g,e.g,n),We(t.b,e.b,n),We(t.a,e.a,n))},array:function(t,e,n){return t.map((t,r)=>We(t,e[r],n))}});const Qe=6/29,Ye=3*Qe*Qe,Ze=Math.PI/180,Ke=180/Math.PI;function Je(t){return t>.008856451679035631?Math.pow(t,1/3):t/Ye+4/29}function $e(t){return t>Qe?t*t*t:Ye*(t-4/29)}function tn(t){return 255*(t<=.0031308?12.92*t:1.055*Math.pow(t,1/2.4)-.055)}function en(t){return(t/=255)<=.04045?t/12.92:Math.pow((t+.055)/1.055,2.4)}function nn(t){const e=en(t.r),n=en(t.g),r=en(t.b),i=Je((.4124564*e+.3575761*n+.1804375*r)/.95047),s=Je((.2126729*e+.7151522*n+.072175*r)/1);return{l:116*s-16,a:500*(i-s),b:200*(s-Je((.0193339*e+.119192*n+.9503041*r)/1.08883)),alpha:t.a}}function rn(t){let e=(t.l+16)/116,n=isNaN(t.a)?e:e+t.a/500,r=isNaN(t.b)?e:e-t.b/200;return e=1*$e(e),n=.95047*$e(n),r=1.08883*$e(r),new Wt(tn(3.2404542*n-1.5371385*e-.4985314*r),tn(-.969266*n+1.8760108*e+.041556*r),tn(.0556434*n-.2040259*e+1.0572252*r),t.alpha)}function sn(t,e,n){const r=e-t;return t+n*(r>180||r<-180?r-360*Math.round(r/360):r)}const on={forward:nn,reverse:rn,interpolate:function(t,e,n){return{l:We(t.l,e.l,n),a:We(t.a,e.a,n),b:We(t.b,e.b,n),alpha:We(t.alpha,e.alpha,n)}}},an={forward:function(t){const{l:e,a:n,b:r}=nn(t),i=Math.atan2(r,n)*Ke;return{h:i<0?i+360:i,c:Math.sqrt(n*n+r*r),l:e,alpha:t.a}},reverse:function(t){const e=t.h*Ze,n=t.c;return rn({l:t.l,a:Math.cos(e)*n,b:Math.sin(e)*n,alpha:t.alpha})},interpolate:function(t,e,n){return{h:sn(t.h,e.h,n),c:We(t.c,e.c,n),l:We(t.l,e.l,n),alpha:We(t.alpha,e.alpha,n)}}};var ln=Object.freeze({__proto__:null,lab:on,hcl:an});class hn{constructor(t,e,n,r,i){this.type=t,this.operator=e,this.interpolation=n,this.input=r,this.labels=[],this.outputs=[];for(const[s,o]of i)this.labels.push(s),this.outputs.push(o)}static interpolationFactor(t,e,n,r){let i=0;if("exponential"===t.name)i=cn(e,t.base,n,r);else if("linear"===t.name)i=cn(e,1,n,r);else if("cubic-bezier"===t.name){const s=t.controlPoints;i=new Ge(s[0],s[1],s[2],s[3]).solve(cn(e,1,n,r))}return i}static parse(t,e){let[n,r,i,...s]=t;if(!Array.isArray(r)||0===r.length)return e.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){const t=r[1];if("number"!=typeof t)return e.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:t}}else{if("cubic-bezier"!==r[0])return e.error("Unknown interpolation type "+String(r[0]),1,0);{const t=r.slice(1);if(4!==t.length||t.some(t=>"number"!=typeof t||t<0||t>1))return e.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:t}}}if(t.length-1<4)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if((t.length-1)%2!=0)return e.error("Expected an even number of arguments.");if(i=e.parse(i,2,_t),!i)return null;const o=[];let a=null;"interpolate-hcl"===n||"interpolate-lab"===n?a=St:e.expectedType&&"value"!==e.expectedType.kind&&(a=e.expectedType);for(let l=0;l<s.length;l+=2){const t=s[l],n=s[l+1],r=l+3,i=l+4;if("number"!=typeof t)return e.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',r);if(o.length&&o[o.length-1][0]>=t)return e.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',r);const h=e.parse(n,i,a);if(!h)return null;a=a||h.type,o.push([t,h])}return"number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new hn(a,n,r,i,o):e.error(`Type ${Rt(a)} is not interpolatable.`)}evaluate(t){const e=this.labels,n=this.outputs;if(1===e.length)return n[0].evaluate(t);const r=this.input.evaluate(t);if(r<=e[0])return n[0].evaluate(t);const i=e.length;if(r>=e[i-1])return n[i-1].evaluate(t);const s=Ue(e,r),o=hn.interpolationFactor(this.interpolation,r,e[s],e[s+1]),a=n[s].evaluate(t),l=n[s+1].evaluate(t);return"interpolate"===this.operator?Xe[this.type.kind.toLowerCase()](a,l,o):"interpolate-hcl"===this.operator?an.reverse(an.interpolate(an.forward(a),an.forward(l),o)):on.reverse(on.interpolate(on.forward(a),on.forward(l),o))}eachChild(t){t(this.input);for(const e of this.outputs)t(e)}outputDefined(){return this.outputs.every(t=>t.outputDefined())}serialize(){let t;t="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const e=[this.operator,t,this.input.serialize()];for(let n=0;n<this.labels.length;n++)e.push(this.labels[n],this.outputs[n].serialize());return e}}function cn(t,e,n,r){const i=r-n,s=t-n;return 0===i?0:1===e?s/i:(Math.pow(e,s)-1)/(Math.pow(e,i)-1)}var un=hn;class fn{constructor(t,e){this.type=t,this.args=e}static parse(t,e){if(t.length<2)return e.error("Expectected at least one argument.");let n=null;const r=e.expectedType;r&&"value"!==r.kind&&(n=r);const i=[];for(const o of t.slice(1)){const t=e.parse(o,1+i.length,n,void 0,{typeAnnotation:"omit"});if(!t)return null;n=n||t.type,i.push(t)}const s=r&&i.some(t=>Dt(r,t.type));return new fn(s?Ct:n,i)}evaluate(t){let e,n=null,r=0;for(const i of this.args){if(r++,n=i.evaluate(t),n&&n instanceof Zt&&!n.available&&(e||(e=n),n=null,r===this.args.length))return e;if(null!==n)break}return n}eachChild(t){this.args.forEach(t)}outputDefined(){return this.args.every(t=>t.outputDefined())}serialize(){const t=["coalesce"];return this.eachChild(e=>{t.push(e.serialize())}),t}}var dn=fn;class pn{constructor(t,e){this.type=e.type,this.bindings=[].concat(t),this.result=e}evaluate(t){return this.result.evaluate(t)}eachChild(t){for(const e of this.bindings)t(e[1]);t(this.result)}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found ${t.length-1} instead.`);const n=[];for(let i=1;i<t.length-1;i+=2){const r=t[i];if("string"!=typeof r)return e.error(`Expected string, but found ${typeof r} instead.`,i);if(/[^a-zA-Z0-9_]/.test(r))return e.error("Variable names must contain only alphanumeric characters or '_'.",i);const s=e.parse(t[i+1],i+1);if(!s)return null;n.push([r,s])}const r=e.parse(t[t.length-1],t.length-1,e.expectedType,n);return r?new pn(n,r):null}outputDefined(){return this.result.outputDefined()}serialize(){const t=["let"];for(const[e,n]of this.bindings)t.push(e,n.serialize());return t.push(this.result.serialize()),t}}var An=pn;class gn{constructor(t,e,n){this.type=t,this.index=e,this.input=n}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,_t),r=e.parse(t[2],2,kt(e.expectedType||Ct));return n&&r?new gn(r.type.itemType,n,r):null}evaluate(t){const e=this.index.evaluate(t),n=this.input.evaluate(t);if(e<0)throw new re(`Array index out of bounds: ${e} < 0.`);if(e>=n.length)throw new re(`Array index out of bounds: ${e} > ${n.length-1}.`);if(e!==Math.floor(e))throw new re(`Array index must be an integer, but found ${e} instead.`);return n[e]}eachChild(t){t(this.index),t(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}var mn=gn;class yn{constructor(t,e){this.type=Tt,this.needle=t,this.haystack=e}static parse(t,e){if(3!==t.length)return e.error(`Expected 2 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ct),r=e.parse(t[2],2,Ct);return n&&r?Ft(n.type,[Tt,Mt,_t,wt,Ct])?new yn(n,r):e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Rt(n.type)} instead`):null}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(null==n)return!1;if(!Lt(e,["boolean","string","number","null"]))throw new re(`Expected first argument to be of type boolean, string, number or null, but found ${Rt($t(e))} instead.`);if(!Lt(n,["string","array"]))throw new re(`Expected second argument to be of type array or string, but found ${Rt($t(n))} instead.`);return n.indexOf(e)>=0}eachChild(t){t(this.needle),t(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}var vn=yn;class xn{constructor(t,e,n){this.type=_t,this.needle=t,this.haystack=e,this.fromIndex=n}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ct),r=e.parse(t[2],2,Ct);if(!n||!r)return null;if(!Ft(n.type,[Tt,Mt,_t,wt,Ct]))return e.error(`Expected first argument to be of type boolean, string, number or null, but found ${Rt(n.type)} instead`);if(4===t.length){const i=e.parse(t[3],3,_t);return i?new xn(n,r,i):null}return new xn(n,r)}evaluate(t){const e=this.needle.evaluate(t),n=this.haystack.evaluate(t);if(!Lt(e,["boolean","string","number","null"]))throw new re(`Expected first argument to be of type boolean, string, number or null, but found ${Rt($t(e))} instead.`);if(!Lt(n,["string","array"]))throw new re(`Expected second argument to be of type array or string, but found ${Rt($t(n))} instead.`);if(this.fromIndex){const r=this.fromIndex.evaluate(t);return n.indexOf(e,r)}return n.indexOf(e)}eachChild(t){t(this.needle),t(this.haystack),this.fromIndex&&t(this.fromIndex)}outputDefined(){return!1}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const t=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),t]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}var bn=xn;class wn{constructor(t,e,n,r,i,s){this.inputType=t,this.type=e,this.input=n,this.cases=r,this.outputs=i,this.otherwise=s}static parse(t,e){if(t.length<5)return e.error(`Expected at least 4 arguments, but found only ${t.length-1}.`);if(t.length%2!=1)return e.error("Expected an even number of arguments.");let n,r;e.expectedType&&"value"!==e.expectedType.kind&&(r=e.expectedType);const i={},s=[];for(let l=2;l<t.length-1;l+=2){let o=t[l];const a=t[l+1];Array.isArray(o)||(o=[o]);const h=e.concat(l);if(0===o.length)return h.error("Expected at least one branch label.");for(const t of o){if("number"!=typeof t&&"string"!=typeof t)return h.error("Branch labels must be numbers or strings.");if("number"==typeof t&&Math.abs(t)>Number.MAX_SAFE_INTEGER)return h.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof t&&Math.floor(t)!==t)return h.error("Numeric branch labels must be integer values.");if(n){if(h.checkSubtype(n,$t(t)))return null}else n=$t(t);if(void 0!==i[String(t)])return h.error("Branch labels must be unique.");i[String(t)]=s.length}const c=e.parse(a,l,r);if(!c)return null;r=r||c.type,s.push(c)}const o=e.parse(t[1],1,Ct);if(!o)return null;const a=e.parse(t[t.length-1],t.length-1,r);return a?"value"!==o.type.kind&&e.concat(1).checkSubtype(n,o.type)?null:new wn(n,r,o,i,s,a):null}evaluate(t){const e=this.input.evaluate(t);return($t(e)===this.inputType&&this.outputs[this.cases[e]]||this.otherwise).evaluate(t)}eachChild(t){t(this.input),this.outputs.forEach(t),t(this.otherwise)}outputDefined(){return this.outputs.every(t=>t.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["match",this.input.serialize()],e=Object.keys(this.cases).sort(),n=[],r={};for(const s of e){const t=r[this.cases[s]];void 0===t?(r[this.cases[s]]=n.length,n.push([this.cases[s],[s]])):n[t][1].push(s)}const i=t=>"number"===this.inputType.kind?Number(t):t;for(const[s,o]of n)t.push(1===o.length?i(o[0]):o.map(i)),t.push(this.outputs[s].serialize());return t.push(this.otherwise.serialize()),t}}var _n=wn;class Mn{constructor(t,e,n){this.type=t,this.branches=e,this.otherwise=n}static parse(t,e){if(t.length<4)return e.error(`Expected at least 3 arguments, but found only ${t.length-1}.`);if(t.length%2!=0)return e.error("Expected an odd number of arguments.");let n;e.expectedType&&"value"!==e.expectedType.kind&&(n=e.expectedType);const r=[];for(let s=1;s<t.length-1;s+=2){const i=e.parse(t[s],s,Tt);if(!i)return null;const o=e.parse(t[s+1],s+1,n);if(!o)return null;r.push([i,o]),n=n||o.type}const i=e.parse(t[t.length-1],t.length-1,n);return i?new Mn(n,r,i):null}evaluate(t){for(const[e,n]of this.branches)if(e.evaluate(t))return n.evaluate(t);return this.otherwise.evaluate(t)}eachChild(t){for(const[e,n]of this.branches)t(e),t(n);t(this.otherwise)}outputDefined(){return this.branches.every(([t,e])=>e.outputDefined())&&this.otherwise.outputDefined()}serialize(){const t=["case"];return this.eachChild(e=>{t.push(e.serialize())}),t}}var Tn=Mn;class Sn{constructor(t,e,n,r){this.type=t,this.input=e,this.beginIndex=n,this.endIndex=r}static parse(t,e){if(t.length<=2||t.length>=5)return e.error(`Expected 3 or 4 arguments, but found ${t.length-1} instead.`);const n=e.parse(t[1],1,Ct),r=e.parse(t[2],2,_t);if(!n||!r)return null;if(!Ft(n.type,[kt(Ct),Mt,Ct]))return e.error(`Expected first argument to be of type array or string, but found ${Rt(n.type)} instead`);if(4===t.length){const i=e.parse(t[3],3,_t);return i?new Sn(n.type,n,r,i):null}return new Sn(n.type,n,r)}evaluate(t){const e=this.input.evaluate(t),n=this.beginIndex.evaluate(t);if(!Lt(e,["string","array"]))throw new re(`Expected first argument to be of type array or string, but found ${Rt($t(e))} instead.`);if(this.endIndex){const r=this.endIndex.evaluate(t);return e.slice(n,r)}return e.slice(n)}eachChild(t){t(this.input),t(this.beginIndex),this.endIndex&&t(this.endIndex)}outputDefined(){return!1}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const t=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),t]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}var In=Sn;function Cn(t,e){return"=="===t||"!="===t?"boolean"===e.kind||"string"===e.kind||"number"===e.kind||"null"===e.kind||"value"===e.kind:"string"===e.kind||"number"===e.kind||"value"===e.kind}function On(t,e,n,r){return 0===r.compare(e,n)}function En(t,e,n){const r="=="!==t&&"!="!==t;return class{constructor(t,e,n){this.type=Tt,this.lhs=t,this.rhs=e,this.collator=n,this.hasUntypedArgument="value"===t.type.kind||"value"===e.type.kind}static parse(t,e){if(3!==t.length&&4!==t.length)return e.error("Expected two or three arguments.");const n=t[0];let i=e.parse(t[1],1,Ct);if(!i)return null;if(!Cn(n,i.type))return e.concat(1).error(`"${n}" comparisons are not supported for type '${Rt(i.type)}'.`);let s=e.parse(t[2],2,Ct);if(!s)return null;if(!Cn(n,s.type))return e.concat(2).error(`"${n}" comparisons are not supported for type '${Rt(s.type)}'.`);if(i.type.kind!==s.type.kind&&"value"!==i.type.kind&&"value"!==s.type.kind)return e.error(`Cannot compare types '${Rt(i.type)}' and '${Rt(s.type)}'.`);r&&("value"===i.type.kind&&"value"!==s.type.kind?i=new oe(s.type,[i]):"value"!==i.type.kind&&"value"===s.type.kind&&(s=new oe(i.type,[s])));let a=null;if(4===t.length){if("string"!==i.type.kind&&"string"!==s.type.kind&&"value"!==i.type.kind&&"value"!==s.type.kind)return e.error("Cannot use collator to compare non-string types.");if(a=e.parse(t[3],3,Ot),!a)return null}return new o["e"](i,s,a)}evaluate(i){const s=this.lhs.evaluate(i),o=this.rhs.evaluate(i);if(r&&this.hasUntypedArgument){const e=$t(s),n=$t(o);if(e.kind!==n.kind||"string"!==e.kind&&"number"!==e.kind)throw new re(`Expected arguments for "${t}" to be (string, string) or (number, number), but found (${e.kind}, ${n.kind}) instead.`)}if(this.collator&&!r&&this.hasUntypedArgument){const t=$t(s),n=$t(o);if("string"!==t.kind||"string"!==n.kind)return e(i,s,o)}return this.collator?n(i,s,o,this.collator.evaluate(i)):e(i,s,o)}eachChild(t){t(this.lhs),t(this.rhs),this.collator&&t(this.collator)}outputDefined(){return!0}serialize(){const e=[t];return this.eachChild(t=>{e.push(t.serialize())}),e}}}const Pn=En("==",(function(t,e,n){return e===n}),On),kn=En("!=",(function(t,e,n){return e!==n}),(function(t,e,n,r){return!On(0,e,n,r)})),Rn=En("<",(function(t,e,n){return e<n}),(function(t,e,n,r){return r.compare(e,n)<0})),Nn=En(">",(function(t,e,n){return e>n}),(function(t,e,n,r){return r.compare(e,n)>0})),Dn=En("<=",(function(t,e,n){return e<=n}),(function(t,e,n,r){return r.compare(e,n)<=0})),Fn=En(">=",(function(t,e,n){return e>=n}),(function(t,e,n,r){return r.compare(e,n)>=0}));class Ln{constructor(t,e,n,r,i,s){this.type=Mt,this.number=t,this.locale=e,this.currency=n,this.unit=r,this.minFractionDigits=i,this.maxFractionDigits=s}static parse(t,e){if(3!==t.length)return e.error("Expected two arguments.");const n=e.parse(t[1],1,_t);if(!n)return null;const r=t[2];if("object"!=typeof r||Array.isArray(r))return e.error("NumberFormat options argument must be an object.");let i=null;if(r.locale&&(i=e.parse(r.locale,1,Mt),!i))return null;let s=null;if(r.currency&&(s=e.parse(r.currency,1,Mt),!s))return null;let o=null;if(r.unit&&(o=e.parse(r.unit,1,Mt),!o))return null;let a=null;if(r["min-fraction-digits"]&&(a=e.parse(r["min-fraction-digits"],1,_t),!a))return null;let l=null;return r["max-fraction-digits"]&&(l=e.parse(r["max-fraction-digits"],1,_t),!l)?null:new Ln(n,i,s,o,a,l)}evaluate(t){return new Intl.NumberFormat(this.locale?this.locale.evaluate(t):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(t):void 0,unit:this.unit?this.unit.evaluate(t):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(t):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(t):void 0}).format(this.number.evaluate(t))}eachChild(t){t(this.number),this.locale&&t(this.locale),this.currency&&t(this.currency),this.unit&&t(this.unit),this.minFractionDigits&&t(this.minFractionDigits),this.maxFractionDigits&&t(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const t={};return this.locale&&(t.locale=this.locale.serialize()),this.currency&&(t.currency=this.currency.serialize()),this.unit&&(t.unit=this.unit.serialize()),this.minFractionDigits&&(t["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(t["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),t]}}class zn{constructor(t){this.type=_t,this.input=t}static parse(t,e){if(2!==t.length)return e.error(`Expected 1 argument, but found ${t.length-1} instead.`);const n=e.parse(t[1],1);return n?"array"!==n.type.kind&&"string"!==n.type.kind&&"value"!==n.type.kind?e.error(`Expected argument of type string or array, but found ${Rt(n.type)} instead.`):new zn(n):null}evaluate(t){const e=this.input.evaluate(t);if("string"==typeof e)return e.length;if(Array.isArray(e))return e.length;throw new re(`Expected value to be of type string or array, but found ${Rt($t(e))} instead.`)}eachChild(t){t(this.input)}outputDefined(){return!1}serialize(){const t=["length"];return this.eachChild(e=>{t.push(e.serialize())}),t}}const Bn={"==":Pn,"!=":kn,">":Nn,"<":Rn,">=":Fn,"<=":Dn,array:oe,at:mn,boolean:oe,case:Tn,coalesce:dn,collator:ge,format:ae,image:le,in:vn,"index-of":bn,interpolate:un,"interpolate-hcl":un,"interpolate-lab":un,length:zn,let:An,literal:ne,match:_n,number:oe,"number-format":Ln,object:oe,slice:In,step:Ve,string:oe,"to-boolean":ue,"to-color":ue,"to-number":ue,"to-string":ue,var:ze,within:Re};function Hn(t,[e,n,r,i]){e=e.evaluate(t),n=n.evaluate(t),r=r.evaluate(t);const s=i?i.evaluate(t):1,o=Kt(e,n,r,s);if(o)throw new re(o);return new Wt(e/255*s,n/255*s,r/255*s,s)}function Un(t,e){return t in e}function jn(t,e){const n=e[t];return void 0===n?null:n}function Vn(t){return{type:t}}Ae.register(Bn,{error:[{kind:"error"},[Mt],(t,[e])=>{throw new re(e.evaluate(t))}],typeof:[Mt,[Ct],(t,[e])=>Rt($t(e.evaluate(t)))],"to-rgba":[kt(_t,4),[St],(t,[e])=>e.evaluate(t).toArray()],rgb:[St,[_t,_t,_t],Hn],rgba:[St,[_t,_t,_t,_t],Hn],has:{type:Tt,overloads:[[[Mt],(t,[e])=>Un(e.evaluate(t),t.properties())],[[Mt,It],(t,[e,n])=>Un(e.evaluate(t),n.evaluate(t))]]},get:{type:Ct,overloads:[[[Mt],(t,[e])=>jn(e.evaluate(t),t.properties())],[[Mt,It],(t,[e,n])=>jn(e.evaluate(t),n.evaluate(t))]]},"feature-state":[Ct,[Mt],(t,[e])=>jn(e.evaluate(t),t.featureState||{})],properties:[It,[],t=>t.properties()],"geometry-type":[Mt,[],t=>t.geometryType()],id:[Ct,[],t=>t.id()],zoom:[_t,[],t=>t.globals.zoom],pitch:[_t,[],t=>t.globals.pitch||0],"distance-from-center":[_t,[],t=>t.distanceFromCenter()],"heatmap-density":[_t,[],t=>t.globals.heatmapDensity||0],"line-progress":[_t,[],t=>t.globals.lineProgress||0],"sky-radial-progress":[_t,[],t=>t.globals.skyRadialProgress||0],accumulated:[Ct,[],t=>void 0===t.globals.accumulated?null:t.globals.accumulated],"+":[_t,Vn(_t),(t,e)=>{let n=0;for(const r of e)n+=r.evaluate(t);return n}],"*":[_t,Vn(_t),(t,e)=>{let n=1;for(const r of e)n*=r.evaluate(t);return n}],"-":{type:_t,overloads:[[[_t,_t],(t,[e,n])=>e.evaluate(t)-n.evaluate(t)],[[_t],(t,[e])=>-e.evaluate(t)]]},"/":[_t,[_t,_t],(t,[e,n])=>e.evaluate(t)/n.evaluate(t)],"%":[_t,[_t,_t],(t,[e,n])=>e.evaluate(t)%n.evaluate(t)],ln2:[_t,[],()=>Math.LN2],pi:[_t,[],()=>Math.PI],e:[_t,[],()=>Math.E],"^":[_t,[_t,_t],(t,[e,n])=>Math.pow(e.evaluate(t),n.evaluate(t))],sqrt:[_t,[_t],(t,[e])=>Math.sqrt(e.evaluate(t))],log10:[_t,[_t],(t,[e])=>Math.log(e.evaluate(t))/Math.LN10],ln:[_t,[_t],(t,[e])=>Math.log(e.evaluate(t))],log2:[_t,[_t],(t,[e])=>Math.log(e.evaluate(t))/Math.LN2],sin:[_t,[_t],(t,[e])=>Math.sin(e.evaluate(t))],cos:[_t,[_t],(t,[e])=>Math.cos(e.evaluate(t))],tan:[_t,[_t],(t,[e])=>Math.tan(e.evaluate(t))],asin:[_t,[_t],(t,[e])=>Math.asin(e.evaluate(t))],acos:[_t,[_t],(t,[e])=>Math.acos(e.evaluate(t))],atan:[_t,[_t],(t,[e])=>Math.atan(e.evaluate(t))],min:[_t,Vn(_t),(t,e)=>Math.min(...e.map(e=>e.evaluate(t)))],max:[_t,Vn(_t),(t,e)=>Math.max(...e.map(e=>e.evaluate(t)))],abs:[_t,[_t],(t,[e])=>Math.abs(e.evaluate(t))],round:[_t,[_t],(t,[e])=>{const n=e.evaluate(t);return n<0?-Math.round(-n):Math.round(n)}],floor:[_t,[_t],(t,[e])=>Math.floor(e.evaluate(t))],ceil:[_t,[_t],(t,[e])=>Math.ceil(e.evaluate(t))],"filter-==":[Tt,[Mt,Ct],(t,[e,n])=>t.properties()[e.value]===n.value],"filter-id-==":[Tt,[Ct],(t,[e])=>t.id()===e.value],"filter-type-==":[Tt,[Mt],(t,[e])=>t.geometryType()===e.value],"filter-<":[Tt,[Mt,Ct],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r<i}],"filter-id-<":[Tt,[Ct],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n<r}],"filter->":[Tt,[Mt,Ct],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r>i}],"filter-id->":[Tt,[Ct],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n>r}],"filter-<=":[Tt,[Mt,Ct],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r<=i}],"filter-id-<=":[Tt,[Ct],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n<=r}],"filter->=":[Tt,[Mt,Ct],(t,[e,n])=>{const r=t.properties()[e.value],i=n.value;return typeof r==typeof i&&r>=i}],"filter-id->=":[Tt,[Ct],(t,[e])=>{const n=t.id(),r=e.value;return typeof n==typeof r&&n>=r}],"filter-has":[Tt,[Ct],(t,[e])=>e.value in t.properties()],"filter-has-id":[Tt,[],t=>null!==t.id()&&void 0!==t.id()],"filter-type-in":[Tt,[kt(Mt)],(t,[e])=>e.value.indexOf(t.geometryType())>=0],"filter-id-in":[Tt,[kt(Ct)],(t,[e])=>e.value.indexOf(t.id())>=0],"filter-in-small":[Tt,[Mt,kt(Ct)],(t,[e,n])=>n.value.indexOf(t.properties()[e.value])>=0],"filter-in-large":[Tt,[Mt,kt(Ct)],(t,[e,n])=>function(t,e,n,r){for(;n<=r;){const i=n+r>>1;if(e[i]===t)return!0;e[i]>t?r=i-1:n=i+1}return!1}(t.properties()[e.value],n.value,0,n.value.length-1)],all:{type:Tt,overloads:[[[Tt,Tt],(t,[e,n])=>e.evaluate(t)&&n.evaluate(t)],[Vn(Tt),(t,e)=>{for(const n of e)if(!n.evaluate(t))return!1;return!0}]]},any:{type:Tt,overloads:[[[Tt,Tt],(t,[e,n])=>e.evaluate(t)||n.evaluate(t)],[Vn(Tt),(t,e)=>{for(const n of e)if(n.evaluate(t))return!0;return!1}]]},"!":[Tt,[Tt],(t,[e])=>!e.evaluate(t)],"is-supported-script":[Tt,[Mt],(t,[e])=>{const n=t.globals&&t.globals.isSupportedScript;return!n||n(e.evaluate(t))}],upcase:[Mt,[Mt],(t,[e])=>e.evaluate(t).toUpperCase()],downcase:[Mt,[Mt],(t,[e])=>e.evaluate(t).toLowerCase()],concat:[Mt,Vn(Ct),(t,e)=>e.map(e=>te(e.evaluate(t))).join("")],"resolved-locale":[Mt,[Ot],(t,[e])=>e.evaluate(t).resolvedLocale()]});var Gn=Bn;function qn(t){return{result:"success",value:t}}function Wn(t){return{result:"error",value:t}}function Xn(t){return!!t.expression&&t.expression.interpolated}function Qn(t){return t instanceof Number?"number":t instanceof String?"string":t instanceof Boolean?"boolean":Array.isArray(t)?"array":null===t?"null":typeof t}function Yn(t){return"object"==typeof t&&null!==t&&!Array.isArray(t)}function Zn(t){return t}function Kn(t,e,n){return void 0!==t?t:void 0!==e?e:void 0!==n?n:void 0}function Jn(t,e,n,r,i){return Kn(typeof n===i?r[n]:void 0,t.default,e.default)}function $n(t,e,n){if("number"!==Qn(n))return Kn(t.default,e.default);const r=t.stops.length;if(1===r)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[r-1][0])return t.stops[r-1][1];const i=Ue(t.stops.map(t=>t[0]),n);return t.stops[i][1]}function tr(t,e,n){const r=void 0!==t.base?t.base:1;if("number"!==Qn(n))return Kn(t.default,e.default);const i=t.stops.length;if(1===i)return t.stops[0][1];if(n<=t.stops[0][0])return t.stops[0][1];if(n>=t.stops[i-1][0])return t.stops[i-1][1];const s=Ue(t.stops.map(t=>t[0]),n),o=function(t,e,n,r){const i=r-n,s=t-n;return 0===i?0:1===e?s/i:(Math.pow(e,s)-1)/(Math.pow(e,i)-1)}(n,r,t.stops[s][0],t.stops[s+1][0]),a=t.stops[s][1],l=t.stops[s+1][1];let h=Xe[e.type]||Zn;if(t.colorSpace&&"rgb"!==t.colorSpace){const e=ln[t.colorSpace];h=(t,n)=>e.reverse(e.interpolate(e.forward(t),e.forward(n),o))}return"function"==typeof a.evaluate?{evaluate(...t){const e=a.evaluate.apply(void 0,t),n=l.evaluate.apply(void 0,t);if(void 0!==e&&void 0!==n)return h(e,n,o)}}:h(a,l,o)}function er(t,e,n){return"color"===e.type?n=Wt.parse(n):"formatted"===e.type?n=Yt.fromString(n.toString()):"resolvedImage"===e.type?n=Zt.fromString(n.toString()):Qn(n)===e.type||"enum"===e.type&&e.values[n]||(n=void 0),Kn(n,t.default,e.default)}class nr{constructor(t,e){this.expression=t,this._warningHistory={},this._evaluator=new de,this._defaultValue=e?function(t){return"color"===t.type&&(Yn(t.default)||Array.isArray(t.default))?new Wt(0,0,0,0):"color"===t.type?Wt.parse(t.default)||null:void 0===t.default?null:t.default}(e):null,this._enumValues=e&&"enum"===e.type?e.values:null}evaluateWithoutErrorHandling(t,e,n,r,i,s,o,a){return this._evaluator.globals=t,this._evaluator.feature=e,this._evaluator.featureState=n,this._evaluator.canonical=r||null,this._evaluator.availableImages=i||null,this._evaluator.formattedSection=s,this._evaluator.featureTileCoord=o||null,this._evaluator.featureDistanceData=a||null,this.expression.evaluate(this._evaluator)}evaluate(t,e,n,r,i,s,o,a){this._evaluator.globals=t,this._evaluator.feature=e||null,this._evaluator.featureState=n||null,this._evaluator.canonical=r||null,this._evaluator.availableImages=i||null,this._evaluator.formattedSection=s||null,this._evaluator.featureTileCoord=o||null,this._evaluator.featureDistanceData=a||null;try{const t=this.expression.evaluate(this._evaluator);if(null==t||"number"==typeof t&&t!=t)return this._defaultValue;if(this._enumValues&&!(t in this._enumValues))throw new re(`Expected value to be one of ${Object.keys(this._enumValues).map(t=>JSON.stringify(t)).join(", ")}, but found ${JSON.stringify(t)} instead.`);return t}catch(t){return this._warningHistory[t.message]||(this._warningHistory[t.message]=!0,"undefined"!=typeof console&&console.warn(t.message)),this._defaultValue}}}function rr(t){return Array.isArray(t)&&t.length>0&&"string"==typeof t[0]&&t[0]in Gn}function ir(t,e){const n=new He(Gn,[],e?function(t){const e={color:St,string:Mt,number:_t,enum:Mt,boolean:Tt,formatted:Et,resolvedImage:Pt};return"array"===t.type?kt(e[t.value]||Ct,t.length):e[t.type]}(e):void 0),r=n.parse(t,void 0,void 0,void 0,e&&"string"===e.type?{typeAnnotation:"coerce"}:void 0);return r?qn(new nr(r,e)):Wn(n.errors)}class sr{constructor(t,e){this.kind=t,this._styleExpression=e,this.isStateDependent="constant"!==t&&!De(e.expression)}evaluateWithoutErrorHandling(t,e,n,r,i,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,r,i,s)}evaluate(t,e,n,r,i,s){return this._styleExpression.evaluate(t,e,n,r,i,s)}}class or{constructor(t,e,n,r){this.kind=t,this.zoomStops=n,this._styleExpression=e,this.isStateDependent="camera"!==t&&!De(e.expression),this.interpolationType=r}evaluateWithoutErrorHandling(t,e,n,r,i,s){return this._styleExpression.evaluateWithoutErrorHandling(t,e,n,r,i,s)}evaluate(t,e,n,r,i,s){return this._styleExpression.evaluate(t,e,n,r,i,s)}interpolationFactor(t,e,n){return this.interpolationType?un.interpolationFactor(this.interpolationType,t,e,n):0}}function ar(t,e){if("error"===(t=ir(t,e)).result)return t;const n=t.value.expression,r=Ne(n);if(!r&&!function(t){return"data-driven"===t["property-type"]}(e))return Wn([new vt("","data expressions not supported")]);const i=Fe(n,["zoom","pitch","distance-from-center"]);if(!i&&!function(t){return!!t.expression&&t.expression.parameters.indexOf("zoom")>-1}(e))return Wn([new vt("","zoom expressions not supported")]);const s=function t(e){let n=null;if(e instanceof An)n=t(e.result);else if(e instanceof dn){for(const r of e.args)if(n=t(r),n)break}else(e instanceof Ve||e instanceof un)&&e.input instanceof Ae&&"zoom"===e.input.name&&(n=e);return n instanceof vt||e.eachChild(e=>{const r=t(e);r instanceof vt?n=r:!n&&r?n=new vt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):n&&r&&n!==r&&(n=new vt("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))}),n}(n);if(!s&&!i)return Wn([new vt("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(s instanceof vt)return Wn([s]);if(s instanceof un&&!Xn(e))return Wn([new vt("",'"interpolate" expressions cannot be used with this property')]);if(!s)return qn(new sr(r?"constant":"source",t.value));const o=s instanceof un?s.interpolation:void 0;return qn(new or(r?"camera":"composite",t.value,s.labels,o))}class lr{constructor(t,e){this._parameters=t,this._specification=e,mt(this,function t(e,n){const r="color"===n.type,i=e.stops&&"object"==typeof e.stops[0][0],s=i||!(i||void 0!==e.property),o=e.type||(Xn(n)?"exponential":"interval");if(r&&((e=mt({},e)).stops&&(e.stops=e.stops.map(t=>[t[0],Wt.parse(t[1])])),e.default=Wt.parse(e.default?e.default:n.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!ln[e.colorSpace])throw new Error("Unknown color space: "+e.colorSpace);let a,l,h;if("exponential"===o)a=tr;else if("interval"===o)a=$n;else if("categorical"===o){a=Jn,l=Object.create(null);for(const t of e.stops)l[t[0]]=t[1];h=typeof e.stops[0][0]}else{if("identity"!==o)throw new Error(`Unknown function type "${o}"`);a=er}if(i){const r={},i=[];for(let t=0;t<e.stops.length;t++){const n=e.stops[t],s=n[0].zoom;void 0===r[s]&&(r[s]={zoom:s,type:e.type,property:e.property,default:e.default,stops:[]},i.push(s)),r[s].stops.push([n[0].value,n[1]])}const s=[];for(const e of i)s.push([r[e].zoom,t(r[e],n)]);const o={name:"linear"};return{kind:"composite",interpolationType:o,interpolationFactor:un.interpolationFactor.bind(void 0,o),zoomStops:s.map(t=>t[0]),evaluate:({zoom:t},r)=>tr({stops:s,base:e.base},n,t).evaluate(t,r)}}if(s){const t="exponential"===o?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return{kind:"camera",interpolationType:t,interpolationFactor:un.interpolationFactor.bind(void 0,t),zoomStops:e.stops.map(t=>t[0]),evaluate:({zoom:t})=>a(e,n,t,l,h)}}return{kind:"source",evaluate(t,r){const i=r&&r.properties?r.properties[e.property]:void 0;return void 0===i?Kn(e.default,n.default):a(e,n,i,l,h)}}}(this._parameters,this._specification))}static deserialize(t){return new lr(t._parameters,t._specification)}static serialize(t){return{_parameters:t._parameters,_specification:t._specification}}}function hr(t){if(Array.isArray(t))return t.map(hr);if(t instanceof Object&&!(t instanceof Number||t instanceof String||t instanceof Boolean)){const e={};for(const n in t)e[n]=hr(t[n]);return e}return function(t){return t instanceof Number||t instanceof String||t instanceof Boolean?t.valueOf():t}(t)}function cr(t,e="fill"){if(null==t)return{filter:()=>!0,needGeometry:!1,needFeature:!1};const n=t;let r=!0;try{r=function(t){if(!ur(t))return t;let e=hr(t);return function t(e){let n=!1;const r=[];if("case"===e[0]){for(let t=1;t<e.length-1;t+=2)n=n||ur(e[t]),r.push(e[t+1]);r.push(e[e.length-1])}else if("match"===e[0]){n=n||ur(e[1]);for(let t=2;t<e.length-1;t+=2)r.push(e[t+1]);r.push(e[e.length-1])}else if("step"===e[0]){n=n||ur(e[1]);for(let t=1;t<e.length-1;t+=2)r.push(e[t+1])}n&&(e.length=0,e.push("any",...r));for(let i=1;i<e.length;i++)t(e[i])}(e),e=function t(e){if(!Array.isArray(e))return e;const n=function(t){if(fr.has(t[0]))for(let e=1;e<t.length;e++)if(ur(t[e]))return!0;return t}(e);return!0===n?n:n.map(e=>t(e))}(e),e}(n)}catch(t){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(n,null,2)}\n        `)}const i=ir(r,null);let s=null;if("error"===i.result)throw new Error(i.value.map(t=>`${t.key}: ${t.message}`).join(", "));s=(t,e,n)=>i.value.evaluate(t,e,{},n);let o=null,a=null;if(r!==n){const t=ir(n,null);if("error"===t.result)throw new Error(t.value.map(t=>`${t.key}: ${t.message}`).join(", "));o=(e,n,r,i,s)=>t.value.evaluate(e,n,{},r,void 0,void 0,i,s),a=!Ne(t.value.expression)}return s=s,{filter:s,dynamicFilter:o||void 0,needGeometry:function t(e){if(!Array.isArray(e))return!1;if("within"===e[0])return!0;for(let n=1;n<e.length;n++)if(t(e[n]))return!0;return!1}(r),needFeature:!!a}}function ur(t){if(!Array.isArray(t))return!1;if(function(t){return"pitch"===t||"distance-from-center"===t}(t[0]))return!0;for(let e=1;e<t.length;e++)if(ur(t[e]))return!0;return!1}const fr=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]),dr={StyleExpression:nr,isExpression:rr,isExpressionFilter:function t(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const n of e.slice(1))if(!t(n)&&"boolean"!=typeof n)return!1;return!0;default:return!0}},createExpression:ir,createPropertyExpression:ar,normalizePropertyExpression:function(t,e){if(Yn(t))return new lr(t,e);if(rr(t)){const n=ar(t,e);if("error"===n.result)throw new Error(n.value.map(t=>`${t.key}: ${t.message}`).join(", "));return n.value}{let n=t;return"string"==typeof t&&"color"===e.type&&(n=Wt.parse(t)),{kind:"constant",evaluate:()=>n}}},ZoomConstantExpression:sr,ZoomDependentExpression:or,StylePropertyFunction:lr},{isExpression:pr,createExpression:Ar}=dr,gr={};function mr(t){if(!0===t)return function(){return!0};if(t&&t.condition){if("any"===t.type){const e=t.condition,n=[];for(let t=0;t<e.length;t++)n.push(mr(e[t]));return(t,e)=>{for(let r=0;r<n.length;r++)if(n[r](t,e))return!0;return!1}}const e=mr(t.condition);if(X(t.layer))return e;const n=e=>e.layer===t.layer;return(t,r)=>n(t)&&e(t,r)}if(Object(h["c"])(t))return Object(h["b"])(t);{let e=cr(t);return e=e&&e.filter,(t,n)=>(gr.zoom=n,e&&e(gr,t))}}const yr={type:"number","property-type":"data-driven",expression:{parameters:["zoom","feature"]}};function vr(t,e){yr.type=e||"number";const n=Ar(t,yr);if("success"!==n.result)throw new Error(`Invalid maplibre spec expression: ${JSON.stringify(t)} (${n.value})`);return n.value}function xr(t){return pr(t)}const br={lineWidth:1,lineStrokeWidth:1,lineDx:1,lineDy:1,lineOpacity:1,linePatternAnimSpeed:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerSpacing:1,markerOpacity:1,markerRotation:1,textWrapWidth:1,textSpacing:1,textSize:1,textHaloRadius:1,textHaloOpacity:1,textDx:1,textDy:1,textOpacity:1,textRotation:1,polygonOpacity:1};function wr(t){return br[t]}const _r={markerPlacement:1,markerFile:1,mergeOnProperty:1,markerTextFit:1,markerType:1,markerHorizontalAlignment:1,markerVerticalAlignment:1,markerRotationAlignment:1,markerPitchAlignment:1,markerFillPatternFile:1,markerLinePatternFile:1,textName:1,textPlacement:1,textFaceName:1,textStyle:1,textHorizontalAlignment:1,textVerticalAlignment:1,textRotationAlignment:1,textPitchAlignment:1,lineJoin:1,lineCap:1,linePatternFile:1,polygonPatternFile:1},Mr={lineDasharray:1,markerLineDasharray:1,uvScale:1,uvOffset:1};function Tr(t){return _r[t]?"string":wr(t)?"number":Mr[t]?"array":"color"}var Sr=Object.freeze({__proto__:null,compileStyle:function(t=[]){return function t(e){if(!Array.isArray(e))return t([e]);const n=[];for(let r=0;r<e.length;r++){let t;t=!0===e[r].filter?function(){return!0}:mr(e[r].filter),n.push(W({},e[r],{filter:t}))}return n}(t=t.map(t=>{const e=W({},t);return e.filter&&e.filter.value&&(e.filter=e.filter.value),e}))},compileFilter:mr,createExpression:vr,isExpression:xr,isInterpolated:wr,getExpressionType:Tr});const Ir="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope;class Cr extends Array{pushIn(...t){const e=t.length;for(let n=0;n<e;n++)this[this._index++]=t[n]}fill(t,e,n){super.fill(t,e,n),n>this._index&&(this._index=n)}set(t,e){t>=this._index&&(this._index=t+1),this[t]=e}getLength(){return this._index}setLength(t){this._index=t,super.length<t&&(super.length=t)}trySetLength(t){t>this._index&&this.setLength(t)}reset(){this._index=0}}const Or={get:function(t,e){return"length"===e?t.getLength():t[e]}};class Er extends Array{setLength(t){super.length=t}trySetLength(t){super.length=t}getLength(){return super.length}}let Pr;class kr{static createTypedArray(t,e){return G(t,e)}static getInstance(){return Pr}static getArray(){const t=new Cr,e=new Proxy(t,Or);return e.push=(...e)=>{t.pushIn(...e)},e._origin=t,e}constructor(){this._arrays=[],this._index=0}get(){if(!Ir)return new Er;const t=this._arrays[this._index]=this._arrays[this._index]||kr.getArray();return t.reset(),this._index++,t}reset(){this._index=0}}Pr=new kr;const Rr=[],Nr={},Dr={},Fr={},Lr=[],zr=kr.getInstance(),Br=Math.pow(2,17);class Hr{static isAtlasLoaded(t,e={}){const{iconAtlas:n}=e;return!!(!t||n&&n.positions[t])}static genFnTypes(t){const e={};for(const n in t)if(xr(t[n])){const r=(n+"_Fn_0").trim(),i=(n+"Fn").trim(),s=Tr(n);e[r]=vr(t[n],s),e[i]=(t,n)=>{let i;Nr.zoom=t,Dr.properties=n;try{i=e[r].evaluateWithoutErrorHandling(Nr,Dr,Fr,null,Lr)}catch(t){return null}return i}}else if(et(t[n])){const r=(n+"_Fn_0").trim(),i=(n+"Fn").trim();wr(n)?(e[r]=Object(o["b"])(t[n]),e[i]=(t,n)=>{const i=e[r](t,n);return et(i)?Object(o["b"])(i)(t,n):i}):(e[r]=Object(o["e"])(t[n]),e[i]=(t,n)=>{const i=e[r](t,n);return et(i)?Object(o["e"])(i)(t,n):i})}return e}constructor(t,e,n){this.options=n;const r=[];this.symbolDef=e,this.symbol=Object(o["d"])(e,()=>(r[0]=n.zoom,r)),this.styledVectors=[],this.properties={},this._fnTypes=n.fnTypes||Hr.genFnTypes(this.symbolDef),et(this.symbolDef.visible)&&(this._visibleFn=Object(o["b"])(this.symbolDef.visible)),n.atlas&&(this.iconAtlas=n.atlas.iconAtlas,this.glyphAtlas=n.atlas.glyphAtlas),this.features=this._check(t)}needAltitudeAttribute(){return this.options.forceAltitudeAttribute||this.maxPosZ>=Br||this.options.positionType===Float32Array}getPositionFormat(){return this.needAltitudeAttribute()?[{type:Int16Array,width:2,name:"aPosition"},{type:Float32Array,width:1,name:"aAltitude"}]:[{type:Int16Array,width:3,name:"aPosition"}]}fillPosition(t,e,n,r){e<this._minX&&(this._minX=e),e>this._maxX&&(this._maxX=e),n<this._minY&&(this._minY=n),n>this._maxY&&(this._maxY=n),this.needAltitudeAttribute()?(t.aPosition.push(e,n),t.aAltitude.push(r)):(ct(Rr,e,n,r),t.aPosition.push(Rr[0],Rr[1],Rr[2]))}_check(t){if(!t.length)return t;const e="__fea_idx".trim();let n,r=0,s=t[r];for(;!s.geometry;)r++,s=t[r];if(Array.isArray(s.geometry)&&s.properties){let e=s.geometry[0];for(;Array.isArray(e);)e=e[0];e instanceof i.a&&(n=t)}if(!n)if(n=[],Array.isArray(s.geometry))for(let i=0;i<t.length;i++){const e=W({},t[i]);n.push(q(e))}else for(let i=0;i<t.length;i++){const r=t[i],s=y(r);for(let t=0;t<s.length;t++){const i=s[t];i[e]=r[e],n.push(i)}}if(this.maxPosZ=0,!this.options.forceAltitudeAttribute){const t="line"===this.symbolDef.textPlacement;let e=0,r=!1;const{textPitchAlignmentFn:i}=this._fnTypes;!i&&t&&"map"===this.symbolDef.textPitchAlignment&&(r=!0);for(let s=0;s<n.length;s++){const o=jr(n[s]&&n[s].geometry);if(o>e&&(e=o),t&&!r&&i&&n[s].properties){const t=i(null,n[s].properties);"map"===t&&(r=t)}}this.hasMapPitchAlign=r,this.maxPosZ=e}const o=this.options.order;if(o){const t=[];for(let e=0;e<o.length;e++)o[e]&&t.push(mr(o[e]));n=n.sort((e,n)=>{const r=t.length;let i=-1,s=-1;for(let o=0;o<r&&(t[o](e)&&(i=o),t[o](n)&&(s=o),!(i>=0&&i<r&&s>=0&&s<r));o++);return i-s})}return n}load(t=1){const e="__fea_idx".trim(),n="_debug_info".trim(),r=this._fnTypes,i=this.styledVectors;this.count=0;const s=this.features;if(!s||!s.length)return Promise.resolve(null);const a={},l={},h={zoom:this.options.zoom,isVector3D:!!this.options.center},c=[],u=Object(o["d"])(this.symbolDef,()=>(c[0]=h.zoom,c));let f=0,d=s.length;const p=this.options.debugIndex;try{for(;f<d;f++){const t=s[f];if(!t||!t.geometry)continue;if(Q(p)&&t[n].index!==p)continue;t.properties||(t.properties={}),t.properties.$layer=t.layer,t.properties.$type=t.type;const o=this.createStyledVector(t,u,r,h,a,l);o&&o.feature.geometry&&(o.featureIdx=void 0===t[e]?f:t[e],this.count++,i.push(o))}}catch(t){return Promise.reject(t)}return this.options.atlas?Promise.resolve(this.pack(t)):this.loadAtlas(a,l).then(()=>this.pack(t))}loadAtlas(t,e){return new Promise((n,r)=>{this.fetchAtlas(t,e,(t,e)=>{if(t)r(t);else{if(e){const{icons:t,glyphs:n}=e;if(t&&Object.keys(t).length){for(const e in t){const n=t[e],{width:r,height:i,data:s}=n.data;n.data=new C({width:r,height:i},s)}this.iconAtlas=new z(t)}if(n&&Object.keys(n).length){for(const t in n){const e=n[t];for(const t in e){const n=e[t],{width:r,height:i,data:s}=n.bitmap;n.bitmap=new I({width:r,height:i},s)}}this.glyphAtlas=new H(n)}}n({glyphAtlas:this.glyphAtlas,iconAtlas:this.iconAtlas})}})})}fetchAtlas(t,e,n){Object.keys(t).length>0||Object.keys(e).length>0?this.options.requestor(t,e,n):n()}pack(t){if(!this.count)return null;if(null==t)throw new Error("layout scale is undefined");const e=this.createDataPack(this.styledVectors,t);if(!e)return null;e.properties=this.properties,this.empty&&(e.empty=!0);const n=e.buffers;delete e.buffers;const r={data:e,buffers:n};if(this.iconAtlas){const t=r.data.iconAtlas=Ur(this.iconAtlas);if(t.glyphMap)for(const e in t.glyphMap)n.push(t.glyphMap[e].data.data.buffer);n.push(r.data.iconAtlas.image.data.buffer)}return this.glyphAtlas&&(r.data.glyphAtlas=Ur(this.glyphAtlas),n.push(r.data.glyphAtlas.image.data.buffer)),r}createStyledVector(t,e,n,r){return new ht(t,e,n,r)}createDataPack(t,e){if(!t||!t.length)return null;this.maxIndex=0,this.maxPos=0,this._minX=this._minY=1/0,this._maxX=this._maxY=-1/0,this.maxAltitude=0,this.dynamicAttrs={};const n=this.data={};this._arrayPool=zr,zr.reset();let r=this.elements=zr.get();const i=this.getFormat(Array.isArray(t[0])?t[0][0].symbol:t[0].symbol),s=this.needAltitudeAttribute()?2:3;for(let v=0;v<i.length;v++)n[i[v].name]=zr.get();let o=zr.get(),a=0;const l=zr.get();let h=0,c=!1,u=!0;const f=new Set;for(let v=0,x=t.length;v<x;v++){if(!t[v].feature.geometry)continue;const r=Array.isArray(t[v])?t[v][0].feature.id:t[v].feature.id;u&&(void 0!==Dr.id?f&&(f.has(Dr.id)?u=!1:f.add(Dr.id)):u=!1),Q(r)&&(Math.abs(r)>h&&(h=Math.abs(r)),r<0&&(c=!0));const i=this.data.aPosition.length;if(Array.isArray(t[v]))for(let n=0;n<t[v].length;n++)this._placeVector(t[v][n],e);else this._placeVector(t[v],e);const d=(n.aPosition.length-i)/s;for(let e=0;e<d;e++)o.push(t[v].featureIdx),Q(r)&&l.push(r);a=Math.max(a,t[v].featureIdx)}if(this.countOutOfAngle>0&&console.warn("text anchor along line is ignored as anchor's line angle is bigger than textMaxAngle."),this.hasElements()&&!r.length)return null;const d=this.options.center?Float32Array:V(a);o=kr.createTypedArray(o,d),i[0].type=this.options.positionType?this.options.positionType:j(this.maxPos);const p=this.options.center;if(p&&(p[0]||p[1])){const t=n.aPosition;for(let e=0;e<t.length;e+=s)t[e]-=p[0],t[e+1]-=p[1]}const A=function(t,e){const n={};for(let r=0;r<t.length;r++){const i=t[r],s=i.type,o=i.name;n[o]=s===Array?e[o]:G(e[o],s)}return n}(i,n);A.aPickingId=o;const g=[];for(const v in A)g.push(A[v].buffer);const m=U(this.maxIndex);r=kr.createTypedArray(r,m),g.push(r.buffer);const y={data:A,isIdUnique:u,is2D:0===this.maxPosZ,indices:this.hasElements()?r:null,positionSize:s,positionBounding:[this._minX,this._minY,this._maxX,this._maxY],buffers:g,symbolIndex:this.symbolDef.index||{index:0},dynamicAttributes:this.dynamicAttrs};if(this._packMarkerPlacement&&(y.markerPlacement=this._packMarkerPlacement),this._packTextPlacement&&(y.textPlacement=this._packTextPlacement),l.length){const t=c?j(h):V(h);y.featureIds=kr.createTypedArray(l,t),g.push(y.featureIds.buffer)}else y.featureIds=[];return y.pickingIdIndiceMap=D(o,y.indices),y}_placeVector(t,e){this._visibleFn&&!this._visibleFn(this.options.zoom,t.feature.properties)||this.placeVector(t,e,this.formatWidth)}addElements(...t){this.maxIndex=Math.max(this.maxIndex,...t),this.elements.push(...t)}hasElements(){return!0}getAltitude(t){const{altitudeProperty:e,defaultAltitude:n,altitudeScale:r}=this.options;let i=E(t,e,n);return r&&(i*=r),this.maxAltitude=Math.max(this.maxAltitude,Math.abs(i)),i}getIconAtlasMaxValue(){const t=this.iconAtlas.positions;let e=0;for(const n in t)if($(t,n)){const{tl:r,displaySize:i}=t[n],s=Math.max(r[0],r[1],i[0]-1,i[1]-1);s>e&&(e=s)}return e}}function Ur(t){let e=t.positions,n=t.image&&t.image.format||"alpha";if(t instanceof z){e={};for(const n in t.positions){const r=t.positions[n];e[n]={paddedRect:r.paddedRect,pixelRatio:r.pixelRatio,tl:r.tl,br:r.br,displaySize:r.displaySize}}n="rgba"}const r=t.image;return{image:{width:r.width,height:r.height,data:r.data,format:n},glyphMap:t.glyphMap,positions:e}}function jr(t){if(!t)return 0;let e=0;if(Array.isArray(t))for(let n=0;n<t.length;n++)if(Array.isArray(t[n])){const r=jr(t[n]);r>e&&(e=r)}else{const r=Math.abs(t[n].z||0);r>e&&(e=r)}else{const n=Math.abs(t.z||0);n>e&&(e=n)}return e}function Vr(t,e,n,r){const i="__fn_textSize".trim();let s=t.textSize;if(X(e.textSize))return[16,16];t[i]&&(s=t[i]);const a=[];if(a[0]=K(s)?s(r,n):s,Object(o["c"])(a[0])){const e=a[0].__fn_key=a[0].__fn_key||JSON.stringify(a[0]);t.___fn_in_stops||(t.___fn_in_stops={}),t.___fn_in_stops[e]||(t.___fn_in_stops[e]=Object(o["b"])(a[0])),a[0]=(0,t.___fn_in_stops[e])(r,n)}return a[1]=a[0],a}function Gr(t){const e=t.stops;let n=-1/0;for(let r=0;r<e.length;r++){let t=e[r][1];Y(e[r][1])&&(t=Gr(e[r][1])),t>n&&(n=t)}return n}function qr(t,e,n){return[e||"normal",n||"normal","24px",t||"Open Sans Regular"].join(" ")}const Wr=/\{[\w-]+(?:\|[\w-]+)*\}/g;function Xr(t,e){return Z(t)?t.replace(Wr,(function(t){if(!e)return"";if((t=t.substring(1,t.length-1)).indexOf("|")>0){const n=t.split("|");for(let t=0;t<n.length;t++){const r=e[n[t]];if(!X(r))return r}return""}const n=e[t];return X(n)?"":Array.isArray(n)?n.join():n})):t}var Qr=Object.freeze({__proto__:null,getSDFFont:qr,resolveText:Xr,resolveVarNames:function(t){return t.match(Wr)},resolveExpVarNames:function t(e,n){if(2!==n.length||"get"!==n[0])for(let r=0;r<n.length;r++)2===n[r].length&&"get"===n[r][0]?e.push(n[r][1]):Array.isArray(n[r])&&t(e,n[r]);else e.push(n[1])}});const Yr=t=>t>=128&&t<=255,Zr=t=>t>=1536&&t<=1791,Kr=t=>t>=1872&&t<=1919,Jr=t=>t>=2208&&t<=2303,$r=t=>t>=4352&&t<=4607,ti=t=>t>=5120&&t<=5759,ei=t=>t>=6320&&t<=6399,ni=t=>t>=8192&&t<=8303,ri=t=>t>=8448&&t<=8527,ii=t=>t>=8528&&t<=8591,si=t=>t>=8960&&t<=9215,oi=t=>t>=9216&&t<=9279,ai=t=>t>=9280&&t<=9311,li=t=>t>=9312&&t<=9471,hi=t=>t>=9632&&t<=9727,ci=t=>t>=9728&&t<=9983,ui=t=>t>=11008&&t<=11263,fi=t=>t>=11904&&t<=12031,di=t=>t>=12032&&t<=12255,pi=t=>t>=12272&&t<=12287,Ai=t=>t>=12288&&t<=12351,gi=t=>t>=12352&&t<=12447,mi=t=>t>=12448&&t<=12543,yi=t=>t>=12544&&t<=12591,vi=t=>t>=12592&&t<=12687,xi=t=>t>=12688&&t<=12703,bi=t=>t>=12704&&t<=12735,wi=t=>t>=12736&&t<=12783,_i=t=>t>=12784&&t<=12799,Mi=t=>t>=12800&&t<=13055,Ti=t=>t>=13056&&t<=13311,Si=t=>t>=13312&&t<=19903,Ii=t=>t>=19904&&t<=19967,Ci=t=>t>=19968&&t<=40959,Oi=t=>t>=40960&&t<=42127,Ei=t=>t>=42128&&t<=42191,Pi=t=>t>=43360&&t<=43391,ki=t=>t>=44032&&t<=55215,Ri=t=>t>=55216&&t<=55295,Ni=t=>t>=57344&&t<=63743,Di=t=>t>=63744&&t<=64255,Fi=t=>t>=64336&&t<=65023,Li=t=>t>=65040&&t<=65055,zi=t=>t>=65072&&t<=65103,Bi=t=>t>=65104&&t<=65135,Hi=t=>t>=65136&&t<=65279,Ui=t=>t>=65280&&t<=65519;function ji(t){return!Zr(t)&&!Kr(t)&&!Jr(t)&&!Fi(t)&&!Hi(t)}function Vi(t){return 746===t||747===t||!(t<4352)&&(!!bi(t)||!!yi(t)||!(!zi(t)||t>=65097&&t<=65103)||!!Di(t)||!!Ti(t)||!!fi(t)||!!wi(t)||!(!Ai(t)||t>=12296&&t<=12305||t>=12308&&t<=12319||12336===t)||!!Si(t)||!!Ci(t)||!!Mi(t)||!!vi(t)||!!Pi(t)||!!Ri(t)||!!$r(t)||!!ki(t)||!!gi(t)||!!pi(t)||!!xi(t)||!!di(t)||!!_i(t)||!(!mi(t)||12540===t)||!(!Ui(t)||65288===t||65289===t||65293===t||t>=65306&&t<=65310||65339===t||65341===t||65343===t||t>=65371&&t<=65503||65507===t||t>=65512&&t<=65519)||!(!Bi(t)||t>=65112&&t<=65118||t>=65123&&t<=65126)||!!ti(t)||!!ei(t)||!!Li(t)||!!Ii(t)||!!Oi(t)||!!Ei(t))}function Gi(t){return!(Vi(t)||function(t){return!(!Yr(t)||167!==t&&169!==t&&174!==t&&177!==t&&188!==t&&189!==t&&190!==t&&215!==t&&247!==t)||!(!ni(t)||8214!==t&&8224!==t&&8225!==t&&8240!==t&&8241!==t&&8251!==t&&8252!==t&&8258!==t&&8263!==t&&8264!==t&&8265!==t&&8273!==t)||!!ri(t)||!!ii(t)||!(!si(t)||!(t>=8960&&t<=8967||t>=8972&&t<=8991||t>=8996&&t<=9e3||9003===t||t>=9085&&t<=9114||t>=9150&&t<=9165||9167===t||t>=9169&&t<=9179||t>=9186&&t<=9215))||!(!oi(t)||9251===t)||!!ai(t)||!!li(t)||!!hi(t)||!(!ci(t)||t>=9754&&t<=9759)||!(!ui(t)||!(t>=11026&&t<=11055||t>=11088&&t<=11097||t>=11192&&t<=11243))||!!Ai(t)||!!mi(t)||!!Ni(t)||!!zi(t)||!!Bi(t)||!!Ui(t)||8734===t||8756===t||8757===t||t>=9984&&t<=10087||t>=10102&&t<=10131||65532===t||65533===t}(t))}function qi(t){return t>=1424&&t<=2303||Fi(t)||Hi(t)}const Wi=[[9,9],[32,32],[5760,5760],[8192,8198],[8200,8202],[8287,12288],[6158,6158],[8203,8205]];function Xi(t){for(const e of Wi)if(t>=e[0]&&t<=e[1])return!0;return!1}const Qi={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""},Yi=1,Zi=2;function Ki(t,e,n,r,i,s,o,a,l,h){let c=t.trim();h===Zi&&(c=function(t){let e="";const n=Array.from(t);for(let r=0;r<n.length;r++){const t=n[r+1].codePointAt(0)||null,i=n[r-1].codePointAt(0)||null;e+=t&&Gi(t)&&!Qi[n[r+1]]||i&&Gi(i)&&!Qi[n[r-1]]||!Qi[n[r]]?n[r]:Qi[n[r]]}return e}(c));const u=[],f={positionedGlyphs:u,text:c,top:a[1],bottom:a[1],left:a[0],right:a[0],writingMode:h};let d;return d=function(t,e){const n=[];let r=0;for(let i=0;i<e.length;i++){const s=e[i];n.push(t.substring(r,s)),r=s}return r<t.length&&n.push(t.substring(r,t.length)),n}(c,function(t,e,n,r){if(!n)return[];if(!t)return[];const i=[],s=function(t,e,n,r){let i=0;for(let o=0;o<t.length;o++){const n=r[t.codePointAt(o)];n&&(i+=n.metrics.advance+e)}const s=Math.max(1,Math.ceil(i/n));return i/s}(t,e,n,r);let o=0;for(let l=0;l<t.length;l++){const n=t.codePointAt(l),h=r[n];h&&(h&&!Ji[n]&&(o+=h.metrics.advance+e),l<t.length-1&&($i[n]||!((a=n)<11904)&&(bi(a)||yi(a)||zi(a)||Di(a)||Ti(a)||fi(a)||wi(a)||Ai(a)||Si(a)||Ci(a)||Mi(a)||Ui(a)||gi(a)||pi(a)||di(a)||_i(a)||mi(a)||Li(a)||Ei(a)||Oi(a)))&&i.push(ns(l+1,o,s,i,es(n,t.codePointAt(l+1)),!1)))}var a;return function t(e){return e?t(e.priorBreak).concat(e.index):[]}(ns(t.length,o,s,i,0,!0))}(c,o,n,e)),function(t,e,n,r,i,s,o,a,l,h){let c=0,u=0,f=0;const d=t.positionedGlyphs,p="right"===s?1:"left"===s?0:.5;for(let y=0;y<n.length;y++){let t=n[y];if(t=t.trim(),!t.length){u-=r;continue}const i=d.length;for(let n=0;n<t.length;n++){const r=t.codePointAt(n),i=e[r];i&&(Vi(r)&&o!==Yi?(32!==r&&d.push({glyph:r,x:c,y:0,vertical:!0}),c+=l+a):(32!==r&&d.push({glyph:r,x:c,y:u,vertical:!1}),c+=i.metrics.advance+a))}d.length!==i&&(f=Math.max(c-a,f),is(d,e,i,d.length-1,p)),c=0,u-=r}const{horizontalAlign:A,verticalAlign:g}=rs(i,h);!function(t,e,n,r,i,s,o){const a=(e-n)*i,l=-(-r*o+.5)*s;if(a||l)for(let h=0;h<t.length;h++)t[h].x+=a,t[h].y+=l}(d,p,A,g,f,r,n.length);const m=n.length*r;t.top+=-g*m,t.bottom=t.top+m,t.left+=-A*f,t.right=t.left+f}(f,e,d,r,i,s,h,o,l),!!u.length&&f}const Ji={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},$i={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function ts(t,e,n,r){const i=Math.pow(t-e,2);return r?t<e?i/2:2*i:i+Math.abs(n)*n}function es(t,e){let n=0;return 10===t&&(n-=1e4),40!==t&&65288!==t||(n+=50),41!==e&&65289!==e||(n+=50),n}function ns(t,e,n,r,i,s){let o=null,a=ts(e,n,i,s);for(let l=0;l<r.length;l++){const t=r[l],h=ts(e-t.x,n,i,s)+t.badness;h<=a&&(o=t,a=h)}return{index:t,x:e,priorBreak:o,badness:a}}function rs(t,e){let n=.5,r=.5;switch(t){case"right":case"top-right":case"bottom-right":n=e?1:0;break;case"left":case"top-left":case"bottom-left":n=e?0:1}switch(t){case"bottom":case"bottom-right":case"bottom-left":r=e?1:0;break;case"top":case"top-right":case"top-left":r=e?0:1}return{horizontalAlign:n,verticalAlign:r}}function is(t,e,n,r,i){if(!i)return;const s=e[t[r].glyph];if(s){const e=(t[r].x+s.metrics.advance)*i;if(!e)return;for(let i=n;i<=r;i++)t[i].x-=e}}function ss(t){if(!function(t){for(const e of t)if(qi(e.charCodeAt(0)))return!0;return!1}(t))return t;const e=[],n=[],r=[];let i=0,s=0,o=1,a=1;for(const l of t){const t=l.codePointAt(0);Xi(t)?(r.push(l),i++):(o=qi(t)?-1:1,a!==o?(s=i,n.length&&(a>0&&n.reverse(),e.push(...n)),r.length&&(e.splice(s,0,...r),r.length=0),a=o,n.length=0):r.length&&(n.push(...r),r.length=0),n.push(l),i++)}return r.length&&n.push(...r),n.length&&(a>0&&n.reverse(),e.push(...n)),e.reverse().join("")}const os=/\{ *([\w_]+) *\}/g;class as{constructor(t,e,n,r,i){this.feature=t,this.symbolDef=e,this.symbol=n,this.options=i,this._thisReplacer=this._replacer.bind(this),this._fnTypes=r}_replacer(t,e){return this.feature.properties[e]||""}getShape(t,e){if(this._shape)return this._shape;const{textHorizontalAlignmentFn:n,textVerticalAlignmentFn:r,markerHorizontalAlignmentFn:i,markerVerticalAlignmentFn:s,textWrapWidthFn:o}=this._fnTypes;let a;const l=this.symbol,h=this.getIconAndGlyph(),c=this.feature.properties;if(h&&h.glyph){const{font:t,text:i}=h.glyph;if(""===i)return null;const s=this.size[0]/24,u=24,f=l.textKeepUpright,d="map"===l.textRotationAlignment&&"line"===l.textPlacement&&!l.isIconText,p=e.glyphMap[t],A=ls(n?n(null,c):l.textHorizontalAlignment,r?r(null,c):l.textVerticalAlignment),g=1.2*u,m=function(t){for(let e=0;e<t.length;e++)if(!ji(t.charAt(e).charCodeAt(0)))return!1;return!0}(i),y=m&&l.textLetterSpacing/s||0,v=[l.textDx/s||0,l.textDy/s||0],x=((o?o(null,c):l.textWrapWidth)||10*u)/s;a={},a.horizontal=Ki(i,p,x,g,A,"center",y,v,u,Yi),m&&d&&f&&(a.vertical=Ki(i,p,x,g,A,"center",y,v,u,Zi))}else if(h&&h.icon){if(!t.positions[h.icon.url])return null;const e=ls(i?i(null,c):l.markerHorizontalAlignment,s?s(null,c):l.markerVerticalAlignment);a=function(t,e,n){let{horizontalAlign:r,verticalAlign:i}=rs(e,n);n?r=1-r:i=1-i;const s=-2048*r,o=-2048*i;return{image:t,top:o,bottom:o+2048,left:s,right:s+2048}}(t.positions[h.icon.url],e,this.options.isVector3D),this.size||(this.size=a.image.displaySize)}return this._shape=a,a}getIconAndGlyph(){if(this.iconGlyph)return this.iconGlyph;const{markerFileFn:t,markerTypeFn:e,markerPathFn:n,markerWidthFn:r,markerHeightFn:i,markerFillFn:s,markerFillPatternFileFn:a,markerFillOpacityFn:l,markerTextFitFn:h,markerTextFitPaddingFn:c,markerLineColorFn:u,markerLineWidthFn:f,markerLineOpacityFn:d,markerLineDasharrayFn:p,markerLinePatternFileFn:A,markerPathWidthFn:g,markerPathHeightFn:m,textNameFn:y,textFaceNameFn:v,textStyleFn:x,textWeightFn:b}=this._fnTypes,{zoom:w}=this.options,_={},M=this.symbol,T=this.feature.properties,S=t?t(null,T):M.markerFile,I=e?e(null,T):M.markerType,C=S||I||M.markerPath,O=!X(this.symbolDef.textName);let E;if(C){E=function(t,e,n,r,i,s){if(X(e.markerWidth)&&X(e.markerHeight))return null;const o="__fn_markerWidth".trim(),a="__fn_markerHeight".trim();let l=e.markerWidth||0,h=e.markerHeight||0;return Y(l)&&("identity"!==l.type?l=Gr(l):(l=t.markerWidth,t[o]&&(l=t[o](r,n)),Y(l)&&(l="identity"===l.type?i(r,n):Gr(l)))),Y(h)&&("identity"!==h.type?h=Gr(h):(h=t.markerHeight,t[a]&&(h=t[a](r,n)),Y(h)&&(h="identity"===h.type?s(r,n):Gr(h)))),[l,h]}(M,this.symbolDef,T,w,r,i)||[0,0];let t=M.markerTextFit;if(h&&(t=h(w,T)),t&&M.text&&"none"!==t){const e=M.text.textSize;let n=M.text.textName;Object(o["c"])(n)&&(n=Object(o["b"])(n)(w,T));const r=Xr(n,T);if(r){const n="__fn_textSize".trim(),i="__fn_textSize_0".trim();Object(o["c"])(e)&&!M.text[n]&&(M.text[i]=Object(o["b"])(e),M.text[n]=(t,e)=>{const n=M.text[i](t,e);return Object(o["c"])(n)?Object(o["b"])(n)(t,e):n});const s=Vr(M.text,M.text,T,w);if("width"!==t&&"both"!==t||(E[0]=s[0]*r.length),"height"!==t&&"both"!==t||(E[1]=s[1]),s[0]&&s[1]){let t=M.markerTextFitPadding||[0,0,0,0];c&&(t=c(w,T)),E[0]+=t[1]+t[3],E[1]+=t[0]+t[2]}}else E[0]=E[1]=-1}}if(O&&(E=Vr(M,this.symbolDef,T,w)),!E)return _;if(E[0]=Math.ceil(E[0]),E[1]=Math.ceil(E[1]),this.size=E,C&&E[0]>=0&&E[1]>=0){let t;if(I){const e={};if(e.markerType=I,"path"===I&&(e.markerPath=n?n(null,T):M.markerPath,e.markerPathWidth=g?g(null,T):M.markerPathWidth,e.markerPathHeight=m?m(null,T):M.markerPathHeight),r){const t=r(null,T);X(t)||(e.markerWidth=t)}else M.markerWidth>=0&&(e.markerWidth=M.markerWidth);if(i){const t=i(null,T);X(t)||(e.markerHeight=t)}else M.markerHeight>=0&&(e.markerHeight=M.markerHeight);if(s){const t=s(null,T);X(t)||(e.markerFill=t)}else M.markerFill&&(e.markerFill=M.markerFill);if(a){const t=a(null,T);X(t)||(e.markerFillPatternFile=t)}else M.markerFillPatternFile&&(e.markerFillPatternFile=M.markerFillPatternFile);if(l){const t=l(null,T);X(t)||(e.markerFillOpacity=t)}else M.markerFillOpacity>=0&&(e.markerFillOpacity=M.markerFillOpacity);if(u){const t=u(null,T);X(t)||(e.markerLineColor=t)}else M.markerLineColor&&(e.markerLineColor=M.markerLineColor);if(f){const t=f(null,T);X(t)||(e.markerLineWidth=t)}else M.markerLineWidth>=0&&(e.markerLineWidth=M.markerLineWidth);if(d){const t=d(null,T);X(t)||(e.markerLineOpacity=t)}else M.markerLineOpacity>=0&&(e.markerLineOpacity=M.markerLineOpacity);if(p){const t=p(null,T);X(t)||(e.markerLineDasharray=t)}else M.markerLineDasharray&&(e.markerLineDasharray=M.markerLineDasharray);if(A){const t=A(null,T);X(t)||(e.markerLinePatternFile=t)}else M.markerLinePatternFile&&(e.markerLinePatternFile=M.markerLinePatternFile);t="vector://"+JSON.stringify(e)}else t=S?S.replace(os,this._thisReplacer):M.markerPath?function(t,e,n){if(!t.markerPath)return null;let r=1;const i=function(t){const e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}(t);Q(t.markerOpacity)&&(r=t.markerOpacity),Q(t.opacity)&&(r*=t.opacity);const s={};if(i){for(const t in i.stroke)$(i.stroke,t)&&(X(i.stroke[t])||(s[t]=i.stroke[t]));for(const t in i.fill)$(i.fill,t)&&(X(i.fill[t])||(s[t]=i.fill[t]))}const o=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath];let a;const l=[];for(let c=0;c<o.length;c++)a=Z(o[c])?{path:o[c]}:o[c],a=W({},a,s),a.d=a.path,delete a.path,l.push(a);const h=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];r<1&&h.push('opacity="'+r+'"'),t.markerPathWidth&&t.markerPathHeight&&h.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),h.push('preserveAspectRatio="none"'),e&&h.push('width="'+e+'"'),n&&h.push('height="'+n+'"'),h.push("><defs></defs>");for(let c=0;c<l.length;c++){let t="<path ";for(const e in l[c])$(l[c],e)&&(t+=" "+e+'="'+l[c][e]+'"');t+="></path>",h.push(t)}return h.push("</svg>"),"data:image/svg+xml;base64,"+btoa(h.join(" "))}(M,E[0],E[1]):null;_.icon={url:t,size:E}}if(O){const t=y?y(this.options.zoom,T):M.textName;if(t||0===t){const e=qr(v?v(null,T):M.textFaceName,x?x(null,T):M.textStyle,b?b(null,T):M.textWeight);let n=Xr(t,T);n&&n.length&&(n=ss(n),_.glyph={font:e,text:n})}}return this.iconGlyph=_,_}}function ls(t,e){e&&"middle"!==e||(e="center"),t&&"middle"!==t||(t="center");let n="center"!==e?e:"";return n+="center"!==t?(n.length?"-":"")+t:"",n
/*!
 * From mapbox-gl-js
 * MIT License
 * https://github.com/mapbox/mapbox-gl-js
 */}function hs(t,e,n,r,s){const o=[];let a;for(let l=0;l<t.length;l++){const h=t[l];let c,u=!1;for(let t=0;t<h.length-1;t++){let l=h[t],f=h[t+1];l.x<e&&f.x<e||(l.x<e?(a=l,l=new i.a(e,l.y+(e-l.x)/(f.x-l.x)*(f.y-l.y))._round(),l.z=a.z+(e-a.x)/(f.x-a.x)*(f.z-a.z),u=!0):f.x<e&&(a=f,f=new i.a(e,l.y+(e-l.x)/(f.x-l.x)*(f.y-l.y))._round(),f.z=l.z+(e-l.x)/(a.x-l.x)*(a.z-l.z),u=!0),l.y<n&&f.y<n||(l.y<n?(a=l,l=new i.a(l.x+(n-l.y)/(f.y-l.y)*(f.x-l.x),n)._round(),l.z=a.z+(n-a.y)/(f.y-a.y)*(f.z-a.z),u=!0):f.y<n&&(a=f,f=new i.a(l.x+(n-l.y)/(f.y-l.y)*(f.x-l.x),n)._round(),f.z=l.z+(n-l.y)/(a.y-l.y)*(a.z-l.z),u=!0),l.x>=r&&f.x>=r||(l.x>=r?(a=l,l=new i.a(r,l.y+(r-l.x)/(f.x-l.x)*(f.y-l.y))._round(),l.z=a.z+(r-a.x)/(f.x-a.x)*(f.z-a.z),u=!0):f.x>=r&&(a=f,f=new i.a(r,l.y+(r-l.x)/(f.x-l.x)*(f.y-l.y))._round(),f.z=l.z+(r-l.x)/(a.x-l.x)*(a.z-l.z),u=!0),l.y>=s&&f.y>=s||(l.y>=s?(a=l,l=new i.a(l.x+(s-l.y)/(f.y-l.y)*(f.x-l.x),s)._round(),l.z=a.z+(s-a.y)/(f.y-a.y)*(f.z-a.z),u=!0):f.y>=s&&(a=f,f=new i.a(l.x+(s-l.y)/(f.y-l.y)*(f.x-l.x),s)._round(),f.z=l.z+(s-l.y)/(a.y-l.y)*(a.z-l.z),u=!0),c&&l.equals(c[c.length-1])||(c=[l],o.push(c)),u&&(c.clipped=!0),c.push(f)))))}}return o}class cs extends i.a{constructor(t,e,n,r){super(t,e),this.angle=n,void 0!==r&&(this.segment=r)}clone(){return new cs(this.x,this.y,this.angle,this.segment)}}
/*!
 * From mapbox-gl-js
 * MIT License
 * https://github.com/mapbox/mapbox-gl-js
 */function us(t,e,n,r,i){if(void 0===e.segment)return!0;let s=e,o=e.segment+1,a=0;for(;a>-n/2;){if(o--,o<0)return!1;a-=t[o].dist(s),s=t[o]}a+=t[o].dist(t[o+1]),o++;const l=[];let h=0;for(;a<n/2;){const e=t[o],n=t[o+1];if(!n)return!1;let s=t[o-1].angleTo(e)-e.angleTo(n);for(s=Math.abs((s+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:s}),h+=s;a-l[0].distance>r;)h-=l.shift().angleDelta;if(h>i)return!1;o++,a+=e.dist(n)}return!0}function fs(t,e,n,r,i,s,o,a,l,h,c){const u=function(t,e,n){return t?.6*e*n:0}(r,s,o),f=function(t,e){return Math.max(t?t.right-t.left:0,e?e.right-e.left:0)}(r,i),d=0===t[0].x||t[0].x===l||0===t[0].y||t[0].y===l;return e-f*o<e/4&&(e=f*o+e/4),function t(e,n,r,i,s,o,a,l,h,c,u){let f=0;const d=o/2,p=function(t){let e=0;for(let n=0;n<t.length-1;n++)e+=t[n].dist(t[n+1]);return e}(e);let A=0,g=n-r,m=[];for(let y=0;y<e.length-1;y++){const t=e[y],n=e[y+1],a=t.dist(n),l=n.angleTo(t);for(;g+r<A+a;){g+=r;const v=(g-A)/a,x=ds(t.x,n.x,v),b=ds(t.y,n.y,v),w=ds(t.z||0,n.z||0,v);if(x>=0&&x<h&&b>=0&&b<h&&g-d>=0&&g+d<=p){const n=new cs(x,b,l,y);n.z=w,c&&(n.axis=[t.y-b,x-t.x],n.angleR=w===(t.z||0)?0:Math.atan(.9*(w-(t.z||0))*u/t.dist(n))),n.line=e,n._round(),!i||us(e,n,o,i,s)?m.push(n):i&&f++}}A+=a}return l||m.length||a||(m=t(e,A/2,r,i,s,o,a,!0,h,c,u)),m.countOutOfAngle=f,m}(t,d?e/2*a%e:(f/2+2*s)*o*a%e,e,u,n,f*o,d,!1,l,h,c)}function ds(t,e,n){return t*(1-n)+e*n}function ps(t,e){const n=t.length;if(n<=1)return[t];const r=[];let i,s;for(let o=0;o<n;o++){const e=O(t[o]);0!==e&&(t[o].area=Math.abs(e),void 0===s&&(s=e<0),s===e<0?(i&&r.push(i),i=[t[o]]):i.push(t[o]))}if(i&&r.push(i),e>1)for(let o=0;o<r.length;o++)r[o].length<=e||(u()(r[o],e,1,r[o].length-1,As),r[o]=r[o].slice(0,e));return r}function As(t,e){return e.area-t.area}function gs(t,e,n){const r=e.distSqr(n);if(0===r)return t.distSqr(e);const i=((t.x-e.x)*(n.x-e.x)+(t.y-e.y)*(n.y-e.y))/r;return t.distSqr(i<0?e:i>1?n:n.sub(e)._mult(i)._add(e))}function ms(t,e=1,n=!1){let r=1/0,s=1/0,o=-1/0,a=-1/0;const l=t[0];for(let i=0;i<l.length;i++){const t=l[i];(!i||t.x<r)&&(r=t.x),(!i||t.y<s)&&(s=t.y),(!i||t.x>o)&&(o=t.x),(!i||t.y>a)&&(a=t.y)}const h=Math.min(o-r,a-s);let c=h/2;const u=new f["a"]([],ys);if(0===h)return new i.a(r,s);for(let i=r;i<o;i+=h)for(let e=s;e<a;e+=h)u.push(new vs(i+c,e+c,c,t));let d=function(t){let e=0,n=0,r=0;const i=t[0];for(let s=0,o=i.length,a=o-1;s<o;a=s++){const t=i[s],o=i[a],l=t.x*o.y-o.x*t.y;n+=(t.x+o.x)*l,r+=(t.y+o.y)*l,e+=3*l}return new vs(n/e,r/e,0,t)}(t),p=u.length;for(;u.length;){const r=u.pop();(r.d>d.d||!d.d)&&(d=r,n&&console.log("found best %d after %d probes",Math.round(1e4*r.d)/1e4,p)),r.max-d.d<=e||(c=r.h/2,u.push(new vs(r.p.x-c,r.p.y-c,c,t)),u.push(new vs(r.p.x+c,r.p.y-c,c,t)),u.push(new vs(r.p.x-c,r.p.y+c,c,t)),u.push(new vs(r.p.x+c,r.p.y+c,c,t)),p+=4)}return n&&(console.log("num probes: "+p),console.log("best distance: "+d.d)),d.p}function ys(t,e){return e.max-t.max}function vs(t,e,n,r){this.p=new i.a(t,e),this.h=n,this.d=function(t,e){let n=!1,r=1/0;for(let i=0;i<e.length;i++){const s=e[i];for(let e=0,i=s.length,o=i-1;e<i;o=e++){const i=s[e],a=s[o];i.y>t.y!=a.y>t.y&&t.x<(a.x-i.x)*(t.y-i.y)/(a.y-i.y)+i.x&&(n=!n),r=Math.min(r,gs(t,i,a))}}return(n?1:-1)*Math.sqrt(r)}(this.p,r),this.max=this.d+this.h*Math.SQRT2}function xs(t,e,n,r,i,s,o,a,l,h){const{feature:c,size:u,symbol:f}=t,d=u?24:0,p=i*(u?u[0]/d:1);if("line"===o){const t=[];t.countOutOfAngle=0;let i=c.geometry;s&&(i=hs(c.geometry,0,0,s,s));for(let o=0;o<i.length;o++){const c=fs(i[o],a,n,f.isIconText?null:r&&r.vertical||r&&r.horizontal||r,null,d,f.isIconText?1:p,1,s||1/0,l,h);if(f.textPlacement&&!f.isIconText)for(let t=0;t<c.length;t++)c[t].startIndex=e.length/3;if(t.push.apply(t,c),f.textPlacement&&!f.isIconText)for(let t=0;t<i[o].length;t++)e.push(i[o][t].x,i[o][t].y,i[o][t].z||0);t.countOutOfAngle+=c.countOutOfAngle||0}return t}return bs(c,o,s)}function bs(t,e,n,r,i){const s=[];if(3===t.type){const o=ps(t.geometry,0);for(let t=0;t<o.length;t++){const a=o[t];if("vertex"===e)for(let t=0;t<a.length;t++){const e=a[t];for(let o=0;o<e.length;o++)k(e[o],n)||(s.push(e[o]),r&&(0===o?ws(e[o],e[o],e[t+1],i):ws(e[o],e[o-1],e[o],i)))}else if("vertex-first"===e){const t=a[0];t&&t[0]&&!k(t[0],n)&&(s.push(t[0]),r&&ws(t[0],t[0],t[1],i))}else if("vertex-last"===e||"vertex-firstlast"===e){const t=a[0];if("vertex-firstlast"===e&&t&&t[0]&&!k(t[0],n)&&(s.push(t[0]),r&&ws(t[0],t[0],t[1],i)),t&&t[t.length-1]&&!k(t[t.length-1],n)){const e=t.length-1;s.push(t[e]),r&&ws(t[e],t[e-1],t[e],i)}}else{const t=ms(a,16);k(t,n)||s.push(t)}}}else if(2===t.type)for(let o=0;o<t.geometry.length;o++){const a=t.geometry[o];if("vertex"===e)for(let t=0;t<a.length;t++)k(a[t],n)||(s.push(a[t]),r&&(0===t?ws(a[t],a[t],a[t+1],i):ws(a[t],a[t-1],a[t],i)));else if("vertex-last"===e||"vertex-firstlast"===e){if("vertex-firstlast"!==e||k(a[0],n)||(s.push(a[0]),r&&ws(a[0],a[0],a[1],i)),a&&a[a.length-1]&&!k(a[a.length-1],n)){const t=a.length-1;s.push(a[t]),r&&ws(a[t],a[t-1],a[t],i)}}else k(a[0],n)||(s.push(a[0]),r&&ws(a[0],a[0],a[1],i))}else if(1===t.type)for(let o=0;o<t.geometry.length;o++){const e=t.geometry[o];for(let t=0;t<e.length;t++){const i=e[t];k(i,n)||(r&&(i.xRotation=0,i.yRotation=0,i.zRotation=0),s.push(i))}}return s}function ws(t,e,n,r){if(t.xRotation||t.yRotation||t.zRotation)return t;const i=n.x-e.x,s=e.y-n.y,o=(n.z-e.z)*r,a=Math.atan2(s,i);t.zRotation=a;const l=Math.atan2(o,Math.sqrt(i*i+s*s));return t.xyRotation=l,t}function _s(t,e){const n={},r={},i=[];let s=0;function o(e){i.push(t[e]),s++}function a(t,e,n){const s=r[t];return delete r[t],r[e]=s,i[s].geometry[0].pop(),i[s].geometry[0]=i[s].geometry[0].concat(n[0]),s}function l(t,e,r){const s=n[e];return delete n[e],n[t]=s,i[s].geometry[0].shift(),i[s].geometry[0]=r[0].concat(i[s].geometry[0]),s}function h(t,e,n){const r=n?e[0][e[0].length-1]:e[0][0];return`${t}:${r.x}:${r.y}`}for(let c=0;c<t.length;c++){const u=t[c],f=u.geometry;if(!f)continue;const d=u.properties[e]?u.properties[e].toString():null;if(!d){o(c);continue}const p=h(d,f),A=h(d,f,!0);if(p in r&&A in n&&r[p]!==n[A]){const t=l(p,A,f),e=a(p,A,i[t].geometry);delete n[p],delete r[A],r[h(d,i[e].geometry,!0)]=e,i[t].geometry=null}else p in r?a(p,A,f):A in n?l(p,A,f):(o(c),n[p]=s-1,r[A]=s-1)}return i.filter(t=>t.geometry)}const Ms=14;class Ts extends Hr{static needMerge(t,e,n){if(!t)return!1;let r="line"===t.textPlacement||"line"===t.markerPlacement;return r||(e.textPlacementFn&&(r="line"===e.textPlacementFn(n)),e.markerPlacementFn&&(r="line"===e.markerPlacementFn(n))),t.mergeOnProperty&&r}static mergeLineFeatures(t,e,n,r){const i="__index".trim();let s=e.textPlacement,o=e.markerPlacement;n.textPlacementFn&&(s=n.textPlacementFn(r)),n.markerPlacementFn&&(o=n.markerPlacementFn(r));const a=function(t,e,n,r,i){const s="__index".trim(),o=Hr.genFnTypes(e),{mergeOnPropertyFn:a}=o;if(!e.mergeOnProperty||"line"!==r&&"line"!==n)return[];if(l=e.mergeOnProperty,!(R(l)||"string"!=typeof l&&(null===l.constructor||l.constructor!==String)||"line"!==r&&"line"!==n))return[{features:t,property:e.mergeOnProperty}];var l;const h=[],c={},u=[];for(let f=0;f<t.length;f++){t[f][s]=f;const o=t[f].properties=t[f].properties||{};o.$layer=t[f].layer,o.$type=t[f].type;let l=n;"line"!==l&&(l=r);const d=a?a(i,o):e.mergeOnProperty;"line"!==l||R(d)?u.push(t[f]):(void 0===c[d]&&(c[d]=h.length,h.push({features:[],property:d})),h[c[d]].features.push(t[f]))}return u.length&&h.push({features:u}),h}(t,e,o,s,r);if(a.length){const e=[];for(let n=0;n<a.length;n++)e.push(a[n].property?_s(a[n].features,a[n].property):t);if(1===e.length)return e[0];{let t=[];for(let n=0;n<e.length;n++)t=t.concat(e[n]);return t.sort((t,e)=>t[i]-e[i]),t}}}static splitPointSymbol(t,e=0){const n=[];if(Array.isArray(t)){const e=t;for(let t=0;t<e.length;t++)e[t]&&n.push(...Ts.splitPointSymbol(e[t],t));return n}let r=null,i=null;for(const s in t)0===s.indexOf("marker")?(r=r||{},r[s]=t[s]):0===s.indexOf("text")&&(i=i||{},i[s]=t[s]);return r&&(r.isIconText=!0,t.mergeOnProperty&&(r.mergeOnProperty=t.mergeOnProperty),n.push(r)),i&&(r&&(i.textPlacement=r.markerPlacement,i.textSpacing=r.markerSpacing,i.isIconText=!0),t.mergeOnProperty&&(i.mergeOnProperty=t.mergeOnProperty),n.push(i)),void 0!==t.visible&&(r&&(r.visible=t.visible),i&&(i.visible=t.visible)),r&&(r.markerTextFit&&i&&(r.text={},r.text.textName=i.textName,r.text.textSize=i.textSize),r.index={index:e,type:0}),i&&(i.index={index:e,type:1}),n}static isAtlasLoaded(t,e){const{icon:n,glyph:r}=t,{iconAtlas:i,glyphAtlas:s}=e;if(n&&(!i||!i.positions[n.url]))return!1;if(r){if(!s||!s.positions[r.font])return!1;const t=s.positions[r.font],{text:e}=r;for(const n of e)if(!t[n.codePointAt(0)])return!1}return!0}constructor(t,e,n){super(t,e,n),this._textPlacement=e.textPlacement,this._fnTypes.textPlacementFn&&(this._textPlacement=this._fnTypes.textPlacementFn(this.options.zoom))}createStyledVector(t,e,n,r,i,s){const o=new as(t,this.symbolDef,e,n,r),a=o.getIconAndGlyph();if(a.icon&&!this.options.atlas){const{url:t,size:e}=a.icon;i[t]||(i[t]=a.icon.size),i[t][0]<e[0]&&(i[t][0]=e[0]),i[t][1]<e[1]&&(i[t][1]=e[1])}if(a.glyph&&!this.options.atlas){const{font:t,text:e}=a.glyph,n=s[t]=s[t]||{};for(const r of e)n[r.codePointAt(0)]=1;"line"===this._textPlacement&&(s.options={isCharsCompact:!1})}return this.options.allowEmptyPack||a.icon||a.glyph?o:null}getFormat(t){const e=void 0!==t.textName,n=e?this.getPackSDFFormat(t):this.getPackMarkerFormat();e?n.push(...this._getTextFnTypeFormats()):n.push(...this._getMarkerFnTypeFormats());const{markerOpacityFn:r,textOpacityFn:i,markerPitchAlignmentFn:s,textPitchAlignmentFn:o,markerRotationAlignmentFn:a,textRotationAlignmentFn:l,markerRotationFn:h,textRotationFn:c,markerAllowOverlapFn:u,textAllowOverlapFn:f,markerIgnorePlacementFn:d,textIgnorePlacementFn:p}=this._fnTypes;return(r||i)&&n.push({type:Uint8Array,width:1,name:"aColorOpacity"}),(s||o)&&n.push({type:Uint8Array,width:1,name:"aPitchAlign"}),(a||l)&&n.push({type:Uint8Array,width:1,name:"aRotationAlign"}),(h||c)&&n.push({type:Uint16Array,width:1,name:"aRotation"}),(u||f||d||p)&&n.push({type:Uint8Array,width:1,name:"aOverlap"}),n}_is3DPitchText(){return this.hasMapPitchAlign}_getTextFnTypeFormats(){const{textFillFn:t,textSizeFn:e,textHaloFillFn:n,textHaloRadiusFn:r,textHaloOpacityFn:i,textDxFn:s,textDyFn:o}=this._fnTypes,a=[];return t&&a.push({type:Uint8Array,width:4,name:"aTextFill"}),e&&a.push({type:Uint8Array,width:1,name:"aTextSize"}),n&&a.push({type:Uint8Array,width:4,name:"aTextHaloFill"}),r&&a.push({type:Uint8Array,width:1,name:"aTextHaloRadius"}),i&&a.push({type:Uint8Array,width:1,name:"aTextHaloOpacity"}),s&&a.push({type:Int8Array,width:1,name:"aTextDx"}),o&&a.push({type:Int8Array,width:1,name:"aTextDy"}),a}_getMarkerFnTypeFormats(){const{markerWidthFn:t,markerHeightFn:e,markerDxFn:n,markerDyFn:r}=this._fnTypes,i=[];return t&&i.push({type:this.options.markerWidthType||Uint8Array,width:1,name:"aMarkerWidth"}),e&&i.push({type:this.options.markerHeightType||Uint8Array,width:1,name:"aMarkerHeight"}),n&&i.push({type:Int8Array,width:1,name:"aMarkerDx"}),r&&i.push({type:Int8Array,width:1,name:"aMarkerDy"}),i}createDataPack(){if(!this.iconAtlas&&!this.glyphAtlas){if(!this.options.allowEmptyPack)return null;this.empty=!0}this.countOutOfAngle=0,this.lineVertex=[];const t=super.createDataPack.apply(this,arguments);return t?(t.lineVertex=new Int16Array(this.lineVertex),t.buffers.push(t.lineVertex.buffer),t):null}placeVector(t,e){const n=t.getShape(this.iconAtlas,this.glyphAtlas);if(!this.options.allowEmptyPack&&(!n||!n.image)&&(!n||!n.horizontal&&!n.vertical))return;const r=this._getAnchors(t,n,e);if(this.countOutOfAngle+=r.countOutOfAngle||0,0===r.length)return;const s=this.data,a=this.needAltitudeAttribute()?2:3;let l=this.data.aPosition.length/a;const h=t.symbol,c=t.feature.properties,u="line"===this._textPlacement&&!h.isIconText,f=void 0!==h.textName,d=f&&u&&function(t){let e=0;for(let n=0;n<t.length;n++)if(Vi(t.charAt(n).charCodeAt(0)))e=0;else if(e++,e>=1)return!1;return!0}(t.getIconAndGlyph().glyph.text)?1:0,{textFillFn:p,textSizeFn:A,textHaloFillFn:g,textHaloRadiusFn:m,textHaloOpacityFn:y,textDxFn:v,textDyFn:x,textPitchAlignmentFn:b,textRotationAlignmentFn:w,textRotationFn:_,textAllowOverlapFn:M,textIgnorePlacementFn:T,textOpacityFn:S,markerWidthFn:I,markerHeightFn:C,markerDxFn:O,markerDyFn:E,markerPitchAlignmentFn:D,markerRotationAlignmentFn:F,markerRotationFn:L,markerAllowOverlapFn:z,markerIgnorePlacementFn:B,markerOpacityFn:H}=this._fnTypes;let U,j,V,G,q,W,X,Q,Y,Z,K,J,$,tt,et,nt,rt;if(f){const e=t.getIconAndGlyph().glyph.font;U=function(t,e,n){const r=t.positionedGlyphs,s=[];for(let o=0;o<r.length;o++){const a=r[o],l=n[a.glyph];if(!l)continue;const h=l.rect;if(!h)continue;const c=4,u=l.metrics.advance/2,f=l.metrics.height/2,d=e?[a.x+u,0]:[0,0],p=e?[0,a.y-f]:[a.x+u,a.y-f],A=l.metrics.left-c-u+p[0],g=l.metrics.top-c+p[1],m=A+h.w,y=g+h.h,v=new i.a(A,g),x=new i.a(m,g),b=new i.a(A,y),w=new i.a(m,y);if(e&&a.vertical){const t=new i.a(-u,u),e=-Math.PI/2,n=new i.a(5,0);v._rotateAround(e,t)._add(n),x._rotateAround(e,t)._add(n),b._rotateAround(e,t)._add(n),w._rotateAround(e,t)._add(n)}s.push({tl:v,tr:x,bl:b,br:w,tex:h,writingMode:t.writingMode,glyphOffset:d})}return s}(n.horizontal,u,this.glyphAtlas.positions[e]),p&&(j=p(null,c),Object(o["c"])(j)?(this.dynamicAttrs.aTextFill=1,j=[0,0,0,0]):j=st([],j)),A&&(V=A(this.options.zoom,c),R(V)&&(V=Ms)),g&&(G=g(null,c),Object(o["c"])(G)?(this.dynamicAttrs.aTextHaloFill=1,G=[0,0,0,0]):G=st([],G)),m&&(q=m(null,c)),y&&(W=255*y(null,c)),v&&(X=v(null,c)||0),x&&(Q=x(null,c)||0),b&&($=+("map"===b(null,c))),w&&(tt=+("map"===w(null,c))),_&&(et=N(_(null,c),0,360)*Math.PI/180)}else U=n?function(t){const e=t.image,n=t.top-1/e.pixelRatio,r=t.left-1/e.pixelRatio,s=t.bottom+1/e.pixelRatio,o=t.right+1/e.pixelRatio;let a,l,h,c;return a=new i.a(r,n),l=new i.a(o,n),h=new i.a(o,s),c=new i.a(r,s),[{tl:a,tr:l,bl:c,br:h,tex:{x:e.tl[0],y:e.tl[1],w:e.displaySize[0],h:e.displaySize[1]},writingMode:void 0,glyphOffset:[0,0]}]}(n):function(){const t=new i.a(0,0),e=new i.a(0,0),n=new i.a(0,0);return[{tl:t,tr:e,bl:new i.a(0,0),br:n,tex:{x:0,y:0,w:0,h:0},writingMode:void 0,glyphOffset:[0,0]}]}(),I&&(Y=I(null,c)),R(Y)&&(Y=U[0].tex.w),C&&(Z=C(null,c)),R(Z)&&(Z=U[0].tex.h),O&&(K=O(null,c)),E&&(J=E(null,c)),D&&($=+("map"===D(null,c))),F&&(tt=+("map"===F(null,c))),L&&(et=N(L(null,c),0,360)*Math.PI/180);Object(o["c"])(V)&&(this.dynamicAttrs.aTextSize=1),Object(o["c"])(q)&&(this.dynamicAttrs.aTextHaloRadius=1),Object(o["c"])(W)&&(this.dynamicAttrs.aTextHaloOpacity=1),Object(o["c"])(X)&&(this.dynamicAttrs.aTextDx=1),Object(o["c"])(Q)&&(this.dynamicAttrs.aTextDy=1),Object(o["c"])(Y)&&(this.dynamicAttrs.aMarkerWidth=1),Object(o["c"])(Z)&&(this.dynamicAttrs.aMarkerHeight=1),Object(o["c"])(K)&&(this.dynamicAttrs.aMarkerDx=1),Object(o["c"])(J)&&(this.dynamicAttrs.aMarkerDy=1),Object(o["c"])($)&&(this.dynamicAttrs.aPitchAlign=1),Object(o["c"])(tt)&&(this.dynamicAttrs.aRotationAlign=1),Object(o["c"])(et)&&(this.dynamicAttrs.aRotation=1);const it=z||M;it&&(nt=it(null,c)||0);const ot=B||T;let at;ot&&(rt=ot(null,c)||0);const lt=S||H;lt&&(at=255*lt(this.options.zoom,c));const ht=this.options.EXTENT,ct=U.length,{altitudeScale:ut,altitudeProperty:ft,defaultAltitude:dt}=this.options,{altitude:pt}=P(t.feature,ut,ft,dt);for(let i=0;i<r.length;i++){const t=r[i],e=t.z||pt||0;if(ht!==1/0&&k(t,ht))continue;const n=t.x,o=t.y,a=U.length;for(let r=0;r<a;r++){const i=U[r],{tl:a,tr:h,bl:c,br:p,tex:A}=i;this._fillPos(s,n,o,e,10*a.x,10*a.y,A.x,A.y+A.h),f&&this._fillData(s,u,ct,i.glyphOffset,t,d,t.axis,t.angleR),this._fillFnTypeData(s,j,V,G,q,W,X,Q,Y,Z,K,J,at,$,tt,et,nt,rt),this._fillPos(s,n,o,e,10*h.x,10*h.y,A.x+A.w,A.y+A.h),f&&this._fillData(s,u,ct,i.glyphOffset,t,d,t.axis,t.angleR),this._fillFnTypeData(s,j,V,G,q,W,X,Q,Y,Z,K,J,at,$,tt,et,nt,rt),this._fillPos(s,n,o,e,10*c.x,10*c.y,A.x,A.y),f&&this._fillData(s,u,ct,i.glyphOffset,t,d,t.axis,t.angleR),this._fillFnTypeData(s,j,V,G,q,W,X,Q,Y,Z,K,J,at,$,tt,et,nt,rt),this._fillPos(s,n,o,e,10*p.x,10*p.y,A.x+A.w,A.y),f&&this._fillData(s,u,ct,i.glyphOffset,t,d,t.axis,t.angleR),this._fillFnTypeData(s,j,V,G,q,W,X,Q,Y,Z,K,J,at,$,tt,et,nt,rt),this.addElements(l,l+1,l+2),this.addElements(l+1,l+2,l+3),l+=4;const g=Math.max(Math.abs(n),Math.abs(o),Math.abs(e));g>this.maxPos&&(this.maxPos=g)}}}_fillPos(t,e,n,r,i,s,o,a){this.fillPosition(t,e,n,r),t.aShape.push(i,s),t.aTexCoord.push(o,a)}_fillData(t,e,n,r,i,s,o,a){if(t.aCount.push(n),e){t.aGlyphOffset.push(r[0],r[1]),this._is3DPitchText()&&t.aPitchRotation.push(o[0],o[1],a);const e=i.startIndex;t.aSegment.push(i.segment+e,e,i.line.length),t.aVertical.push(s)}}_fillFnTypeData(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A,g,m){const{textFillFn:y,textSizeFn:v,textHaloFillFn:x,textHaloRadiusFn:b,textHaloOpacityFn:w,textDxFn:_,textDyFn:M,textPitchAlignmentFn:T,textRotationAlignmentFn:S,textRotationFn:I,textAllowOverlapFn:C,textIgnorePlacementFn:O,textOpacityFn:E,markerWidthFn:P,markerHeightFn:k,markerDxFn:R,markerDyFn:N,markerPitchAlignmentFn:D,markerRotationAlignmentFn:F,markerRotationFn:L,markerAllowOverlapFn:z,markerIgnorePlacementFn:B,markerOpacityFn:H}=this._fnTypes;y&&t.aTextFill.push(...e),v&&t.aTextSize.push(n),x&&t.aTextHaloFill.push(...r),b&&t.aTextHaloRadius.push(i),w&&t.aTextHaloOpacity.push(s),_&&t.aTextDx.push(o),M&&t.aTextDy.push(a),P&&t.aMarkerWidth.push(l),k&&t.aMarkerHeight.push(h),R&&t.aMarkerDx.push(c),N&&t.aMarkerDy.push(u),(H||E)&&t.aColorOpacity.push(f),(T||D)&&t.aPitchAlign.push(d),(F||S)&&t.aRotationAlign.push(p),(L||I)&&t.aRotation.push(9362*A);const U=z||C,j=B||O;(U||j)&&t.aOverlap.push((U?8:0)+4*g+((j?2:0)+m)),i>0&&(this.properties.hasHalo=1)}_getAnchors(t,e,n){const{feature:r,symbol:i}=t,s=this._getPlacement(t,i),o=r.properties,{markerSpacingFn:a,textSpacingFn:l,textMaxAngleFn:h}=this._fnTypes,c=((a?a(null,o):i.markerSpacing)||(l?l(null,o):i.textSpacing)||250)*n;let u=h?h(this.options.zoom,o):i.textMaxAngle;R(u)&&(u=80),u*=Math.PI/180;const f=this.options.EXTENT,d=this.options.altitudeToTileScale,p=this._is3DPitchText();return xs(t,this.lineVertex,u,e,n,f,s,c,p,d)}_getPlacement(t,e){let n;return n=this._fnTypes.markerPlacementFn?this._fnTypes.markerPlacementFn(this.options.zoom,t.feature.properties):e.markerPlacement||this._textPlacement,this._packMarkerPlacement||!e.markerPlacement&&!e.isIconText||(this._packMarkerPlacement=n),!this._textPlacement||e.isIconText||this._packTextPlacement||(this._packTextPlacement=n),n}getPackSDFFormat(t){if("line"!==this._textPlacement||t.isIconText)return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"}];{const t=[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"},{type:Uint8Array,width:1,name:"aCount"},{type:Int16Array,width:2,name:"aGlyphOffset"},{type:Uint16Array,width:3,name:"aSegment"},{type:Uint8Array,width:1,name:"aVertical"}];return this._is3DPitchText()&&t.push({type:Float32Array,width:3,name:"aPitchRotation"}),t}}getPackMarkerFormat(){return[...this.getPositionFormat(),{type:Int16Array,width:2,name:"aShape"},{type:Uint16Array,width:2,name:"aTexCoord"}]}}class Ss{constructor(t){this.x=t.x,this.y=t.y,this.z=t.z||0}clone(){return new Ss(this)}_unit(){return this._div(this.mag()),this}_div(t){return this.x/=t,this.y/=t,this.z/=t,this}_perp(){var t=this.y;return this.y=this.x,this.x=-t,this}mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}add(t){return this.clone()._add(t)}sub(t){return this.clone()._sub(t)}_add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}_sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}equals(t){return this.x===t.x&&this.y===t.y&&this.z===t.z}mult(t){return this.clone()._mult(t)}_mult(t){return this.x*=t,this.y*=t,this.z*=t,this}dist(t){return Math.sqrt(this.distSqr(t))}distSqr(t){var e=t.x-this.x,n=t.y-this.y,r=t.z-this.z;return e*e+n*n+r*r}_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}angleTo(t){return Math.atan2(this.y-t.y,this.x-t.x)}}const Is=Math.cos(Math.PI/180*37.5),Cs=Math.pow(2,16)/1,Os=new i.a,Es=new i.a,Ps=new i.a;class ks extends Hr{constructor(t,e,n){super(t,e,n);let r=!1;const{lineDasharrayFn:i,lineDashColorFn:s}=this._fnTypes;this.hasGradient=this.symbol.lineGradientProperty,i&&(r=function(t,e,n){for(let r=0;r<t.length;r++)if(n(e,t[r].properties))return!0;return!1}(t,this.options.zoom,i),r&&(this.dasharrayFn=i)),this.hasDasharray=Ds(this.symbol.lineDasharray)||r,this.hasDasharray&&s&&(this.dashColorFn=s)}createStyledVector(t,e,n,r,i){const s=new ht(t,e,n,r),o=s.getLineResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const{lineWidthFn:t,lineStrokeWidthFn:e,lineStrokeColorFn:n,lineColorFn:r,lineOpacityFn:i,lineDxFn:s,lineDyFn:o,linePatternAnimSpeedFn:a,linePatternGapFn:l}=this._fnTypes,h=[...this.getPositionFormat()];if(h.push(this.iconAtlas||this.hasDasharray?{type:Int8Array,width:3,name:"aExtrude"}:{type:Int8Array,width:2,name:"aExtrude"}),h.push({type:this.options.positionType||Uint16Array,width:1,name:"aLinesofar"}),t&&h.push({type:Uint8Array,width:1,name:"aLineWidth"}),e&&h.push({type:Uint8Array,width:1,name:"aLineStrokeWidth"}),r&&h.push({type:Uint8Array,width:4,name:"aColor"}),n&&h.push({type:Uint8Array,width:4,name:"aStrokeColor"}),i&&h.push({type:Uint8Array,width:1,name:"aOpacity"}),this.dasharrayFn&&h.push({type:Uint8Array,width:4,name:"aDasharray"}),this.dashColorFn&&h.push({type:Uint8Array,width:4,name:"aDashColor"}),this.iconAtlas){const t=this.getIconAtlasMaxValue();h.push({type:t>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return(s||o)&&h.push({type:Int8Array,width:2,name:"aLineDxDy"}),(a||l)&&h.push({type:Int8Array,width:2,name:"aLinePattern"}),h}placeVector(t){const{lineJoinFn:e,lineCapFn:n,lineWidthFn:r,lineHeightFn:i,lineStrokeWidthFn:s,lineStrokeColorFn:a,lineColorFn:l,lineOpacityFn:h,lineDxFn:c,lineDyFn:u,linePatternAnimSpeedFn:f,linePatternGapFn:d}=this._fnTypes,p=this.symbol,A=t.feature,g=A.properties;let m=p.lineJoin||"miter",y=p.lineCap||"butt";if(e&&(m=e(this.options.zoom,g)||"miter"),n&&(y=n(this.options.zoom,g)||"butt"),r){let t=r(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLineWidth=1,t=4),X(t)&&(t=4),this.feaLineWidth=+t}else this.feaLineWidth=+p.lineWidth;if(i){let t=i(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLineHeight=1),X(t)&&(t=this.feaLineWidth),this.feaLineHeight=+t}else this.feaLineHeight=+p.lineHeight||this.feaLineWidth;if(s){let t=s(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLineStrokeWidth=1,t=0),X(t)&&(t=0),this.feaLineStrokeWidth=t}else this.feaLineStrokeWidth=p.lineStrokeWidth||0;if(l&&(this.feaColor=l(this.options.zoom,g)||[255,255,255,255],Object(o["c"])(this.feaColor)?(this.dynamicAttrs.aColor=1,this.feaColor=[0,0,0,0]):this.feaColor=st([],this.feaColor)),a&&(this.feaStrokeColor=a(this.options.zoom,g)||[0,0,0,255],Object(o["c"])(this.feaStrokeColor)?(this.dynamicAttrs.aStrokeColor=1,this.feaStrokeColor=[0,0,0,0]):this.feaStrokeColor=st([],this.feaStrokeColor)),h){let t=h(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aOpacity=1,t=1),X(t)&&(t=1),this.feaOpacity=255*t}if(this.dasharrayFn){let t=this.dasharrayFn(this.options.zoom,g)||[0,0,0,0];if(Object(o["c"])(t)&&(this.dynamicAttrs.aDasharray=1,t=[0,0,0,0]),t.length<4){const e=t;1===t.length?t=[e[0],e[0],e[0],e[0]]:2===t.length?t=[e[0],e[1],e[0],e[1]]:3===t.length&&(t=[e[0],e[1],e[2],e[2]])}this.feaDash=t}if(this.dashColorFn){let t=(this.dashColorFn?this.dashColorFn(this.options.zoom,g):this.symbol.lineDashColor)||[0,0,0,0];Object(o["c"])(t)&&(this.dynamicAttrs.aDashColor=1,t=[0,0,0,0]),t=st([],t),this.feaDashColor=t}if(this.iconAtlas){const e=t.getLineResource(),n=this.iconAtlas.glyphMap[e];if(this.feaTexInfo=this.feaTexInfo||[0,0,0,0],n){const{tl:t,displaySize:n}=this.iconAtlas.positions[e];this.feaTexInfo[0]=t[0]+1,this.feaTexInfo[1]=t[1]+1,this.feaTexInfo[2]=n[0]-3,this.feaTexInfo[3]=n[1]-3}else this.feaTexInfo[0]=this.feaTexInfo[1]=this.feaTexInfo[2]=this.feaTexInfo[3]=0}if(c){let t=c(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),X(t)&&(t=0),this.feaLineDx=t}if(u){let t=u(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLineDxDy=1,t=0),X(t)&&(t=0),this.feaLineDy=t}if(f){let t=f(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLinePatternAnimSpeed=1,t=0),X(t)&&(t=0),0!==t&&(this.properties.hasPatternAnim=1),this.feaPatternAnimSpeed=t}if(d){let t=d(this.options.zoom,g);Object(o["c"])(t)&&(this.dynamicAttrs.aLinePatternGap=1,t=0),X(t)&&(t=0),this.feaLinePatternGap=t}const v=this.options.EXTENT;let x=A.geometry;if(v!==1/0){x=[];const t=[];for(let e=0;e<A.geometry.length;e++){t[0]=A.geometry[e];const n=hs(t,-1,-1,v+1,v+1);if(3===A.type&&n.length>1){const t=n[0],e=n[n.length-1];Bs(t[0],e[e.length-1])&&(n[0]=e.concat(t.slice(1)),n.length=n.length-1)}x.push(...n)}}const b=this.needAltitudeAttribute()?2:3;for(let o=0;o<x.length;o++)this.offset=this.data.aPosition.length/b,this._addLine(x[o],A,m,y,2,1.05)}_hasPattern(){return this.iconAtlas&&this.feaTexInfo[2]&&this.feaTexInfo[3]}_addLine(t,e,n,r,i,s){const o=this._hasPattern()||Ds(this.feaDash)||Ds(this.symbol.lineDasharray),a=this.options.isTube;a&&(t=t.map(t=>new Ss(t))),this.overscaling=1;const l=this.options.EXTENT;if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.prevVertex=null,this.symbol.lineGradientProperty&&e.properties&&Q(e.properties.mapbox_clip_start)&&Q(e.properties.mapbox_clip_end)){this.clipStart=+e.properties.mapbox_clip_start,this.clipEnd=+e.properties.mapbox_clip_end;for(let e=0;e<t.length-1;e++)this.totalDistance+=t[e].dist(t[e+1]);this.updateScaledDistance()}const h=3===e.type&&!t.clipped;let c=t.length;for(;c>=2&&Bs(t[c-1],t[c-2]);)c--;let u=0;for(;u<c-1&&Bs(t[u],t[u+1]);)u++;if(c<(h?3:2))return;"bevel"===n&&(i=1.05);const f=this.overscaling<=16?15*l/(512*this.overscaling):0,d={vertexLength:0,primitiveLength:0,currentNormal:null};let p,A,g,m,y;this.e1=this.e2=-1,h&&(p=t[c-2],y=t[u].sub(p)._unit()._perp());for(let v=u;v<c;v++){if(g=v===c-1?h?t[u+1]:void 0:t[v+1],g&&Bs(t[v],g))continue;y&&(m=y),p&&(A=p),p=t[v],g&&p.x===g.x&&p.y===g.y&&(p.x+=1e-4),y=g?g.sub(p)._unit()._perp():m,d.dir=A?p.sub(A)._unit():g.sub(p)._unit(),m=m||y,d.currentNormal=m;let e=m.add(y);0===e.x&&0===e.y||e._unit();const l=m.x*y.x+m.y*y.y,x=e.x*y.x+e.y*y.y,b=0!==x?1/x:1/0,w=2*Math.sqrt(2-2*x),_=x<Is&&A&&g,M=m.x*y.y-m.y*y.x>0;if(!a&&_&&v>u){const t=p.dist(A);if(t>2*f){const e=p.sub(p.sub(A)._mult(f/t)._round());e.z=p.z,this.updateDistance(A,e),this.addCurrentVertex(e,m,0,0,d),A=e}}const T=A&&g;d.middleVertex=T;let S=T?n:h?"butt":r;if(T&&"round"===S&&(b<s?S="miter":b<=2&&(S="fakeround")),"miter"===S&&b>i&&!a&&(S="bevel"),"bevel"===S&&(b>2&&(S="flipbevel"),b<i&&(S="miter")),A&&this.updateDistance(A,p),"miter"===S)a?(this.addCurrentVertex(p,m,0,0,d),d.dir=g.sub(p)._unit(),this.addCurrentVertex(p,y,0,0,d)):(e._mult(b),this.addCurrentVertex(p,e,0,0,d),o&&(d.currentNormal=y,this.addCurrentVertex(p,e,0,0,d)));else if("flipbevel"===S){if(b>100)e=y.mult(-1);else{const t=b*m.add(y).mag()/m.sub(y).mag();e._perp()._mult(t*(M?-1:1))}this.addCurrentVertex(p,e,0,0,d),this.addCurrentVertex(p,e.mult(-1),0,0,d)}else if("bevel"===S||"fakeround"===S){const t=-Math.sqrt(b*b-1),e=M?t:0,n=M?0:t;if(A&&this.addCurrentVertex(p,m,e,n,d),"fakeround"===S){const t=Math.round(180*w/Math.PI/20);for(let e=1;e<t;e++){let n=e/t;if(.5!==n){const t=n-.5;n+=n*t*(n-1)*((1.0904+l*(l*(3.55645-1.43519*l)-3.2452))*t*t+(.848013+l*(.215638*l-1.06021)))}const r=y.sub(m)._mult(n)._add(m)._unit()._mult(M?-1:1);this.addHalfVertex(p,r.x,r.y,!1,M,0,d)}}g&&(d.currentNormal=y,this.addCurrentVertex(p,y,-e,-n,d))}else if("butt"===S)this.addCurrentVertex(p,e,0,0,d);else if("square"===S){const t=A?1:-1;this.addCurrentVertex(p,e,t,t,d)}else"round"===S&&(A&&(this.addCurrentVertex(p,m,0,0,d),this.addCurrentVertex(p,m,1,1,d,!0)),g&&(this.addCurrentVertex(p,y,-1,-1,d,!0),this.addCurrentVertex(p,y,0,0,d)));if(!a&&_&&v<c-1){const t=p.dist(g);if(t>2*f){const e=p.add(g.sub(p)._mult(f/t)._round());e.z=p.z,this.updateDistance(p,e),this.addCurrentVertex(e,y,0,0,d),p=e}}}}addCurrentVertex(t,e,n,r,i,s=!1){const o=e.x+e.y*n,a=e.y-e.x*n,l=e.y*r-e.x,h=-e.y-e.x*r;let c=0,u=0;if(i.middleVertex){Os.x=o,Os.y=a,Es.x=l,Es.y=h;const t=i.currentNormal;if(c=zs(t,Os),0===n&&0===r)u=-c;else{const e=Ps;e.x=t.x,e.y=t.y,e._mult(-1),u=zs(e,Es)}}this.addHalfVertex(t,o,a,s,!1,n,i,c),this.addHalfVertex(t,l,h,s,!0,-r,i,u),this.prevVertex&&Bs(t,this.prevVertex)||(this.prevVertex=t),this.distance>Cs/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(t,e,n,r,i,s))}addHalfVertex({x:t,y:e,z:n},r,i,s,o,a,l,h){this.fillData(this.data,t,e,n||0,r,i,s,o,1*this.scaledDistance,h);const c=l.vertexLength++;this.e1>=0&&this.e2>=0&&(this.addElements(this.e1,this.e2,c),l.primitiveLength++),o?this.e2=c:this.e1=c}fillData(t,e,n,r,i,s,o,a,l,h){const{lineWidthFn:c,lineStrokeWidthFn:u,lineStrokeColorFn:f,lineColorFn:d,lineOpacityFn:p,lineDxFn:A,lineDyFn:g,linePatternAnimSpeedFn:m,linePatternGapFn:y}=this._fnTypes;this.fillPosition(t,e,n,r);let v=63*i;v=(Math.sign(v)||1)*((Math.floor(Math.abs(v))>>1<<1)+ +o);let x=63*s;x=(Math.sign(x)||1)*((Math.floor(Math.abs(x))>>1<<1)+ +a),t.aExtrude.push(v,x),(this.iconAtlas||this.hasDasharray)&&t.aExtrude.push(63*h),t.aLinesofar.push(l),c&&t.aLineWidth.push(Math.round(2*this.feaLineWidth)),u&&t.aLineStrokeWidth.push(Math.round(2*this.feaLineStrokeWidth)),d&&t.aColor.push(...this.feaColor),f&&t.aStrokeColor.push(...this.feaStrokeColor),p&&t.aOpacity.push(this.feaOpacity),this.dasharrayFn&&t.aDasharray.push(...this.feaDash),this.dashColorFn&&t.aDashColor.push(...this.feaDashColor),this.iconAtlas&&t.aTexInfo.push(...this.feaTexInfo),(A||g)&&t.aLineDxDy.push(this.feaLineDx||0,this.feaLineDy||0),(m||y)&&t.aLinePattern.push(127*(this.feaPatternAnimSpeed||0),10*(this.feaLinePatternGap||0)),this.maxPos=Math.max(this.maxPos,Math.abs(e)+1,Math.abs(n)+1)}addElements(t,e,n){super.addElements(this.offset+t,this.offset+e,this.offset+n)}_filterPolygonEdges(t){const e=this.options.EXTENT,n=this.elements;for(let r=0;r<n.length;r+=3)e!==1/0&&(Ns(this.data.aPosition,n[r],n[r+1],3,e)||Ns(this.data.aPosition,n[r+1],n[r+2],3,e))||t.push(n[r],n[r+1],n[r+2])}_filterLine(t){if(t.length<=1)return t;const e=[],n=this.options.EXTENT;let r,i=!0;for(r=0;r<t.length-1;r++){const s=Rs(t[r],t[r+1],n);s&&i||(e.push(t[r]),i=s)}return i||e.push(t[r]),e}updateDistance(t,e){if(this.options.isTube){const n=t.dist(e),r=nt(this.options)*(e.z-t.z);this.distance+=Math.sqrt(n*n+r*r)}else this.distance+=t.dist(e);this.updateScaledDistance()}updateScaledDistance(){this.scaledDistance=this.totalDistance>0?(this.clipStart+(this.clipEnd-this.clipStart)*this.distance/this.totalDistance)*(Cs-1):this.distance}}function Rs(t,e,n){return n!==1/0&&(t.x<0&&e.x<0||t.x>n&&e.x>n||t.y<0&&e.y<0||t.y>n&&e.y>n)}function Ns(t,e,n,r,i){if(i===1/0)return!1;const s=Math.floor(.5*t[e*r]),o=Math.floor(.5*t[e*r+1]),a=Math.floor(.5*t[n*r]),l=Math.floor(.5*t[n*r+1]);return s===a&&(s<0||s>i)&&o!==l||o===l&&(o<0||o>i)&&s!==a}function Ds(t){if(!Array.isArray(t))return!1;for(let e=0;e<t.length;e++)if(t[e])return!0;return!1}const Fs=new i.a(0,0),Ls=new i.a(0,0);function zs(t,e){const n=t.mag(),r=e.mag();Fs.x=e.x,Fs.y=e.y;const i=t.angleTo(Ls),s=e.angleTo(Ls);return Math.sign(s-i)*Math.sqrt(r*r-n*n)}function Bs(t,e){return t.equals(e)&&t.z===e.z}Math.pow(2,16);Math.PI;
/*!
 * from @turf/bboxClip
 * https://github.com/Turfjs/turf
 * MIT LICENSE
 */
const Hs=[],Us=[];function js(t,e){var n,r,s,o,a,l,h;for(r=1;r<=8;r*=2){for(n=[],o=!(Gs(s=t[t.length-1],e)&r),a=0;a<t.length;a++){if((h=!(Gs(l=t[a],e)&r))!==o){const t=Vs(s,l,r,e);n.push(void 0!==l.x?new i.a(t[0],t[1]):t)}h&&n.push(l),s=l,o=h}if(!(t=n).length)break}return n}function Vs(t,e,n,r){return Hs[0]=void 0===t.x?t[0]:t.x,Hs[1]=void 0===t.y?t[1]:t.y,t=Hs,Us[0]=void 0===e.x?e[0]:e.x,Us[1]=void 0===e.y?e[1]:e.y,e=Us,8&n?[t[0]+(e[0]-t[0])*(r[3]-t[1])/(e[1]-t[1]),r[3]]:4&n?[t[0]+(e[0]-t[0])*(r[1]-t[1])/(e[1]-t[1]),r[1]]:2&n?[r[2],t[1]+(e[1]-t[1])*(r[2]-t[0])/(e[0]-t[0])]:1&n?[r[0],t[1]+(e[1]-t[1])*(r[0]-t[0])/(e[0]-t[0])]:null}function Gs(t,e){Hs[0]=void 0===t.x?t[0]:t.x,Hs[1]=void 0===t.y?t[1]:t.y;var n=0;return(t=Hs)[0]<e[0]?n|=1:t[0]>e[2]&&(n|=2),t[1]<e[1]?n|=4:t[1]>e[3]&&(n|=8),n}const qs=[0,0,0,0],Ws=-9999999;class Xs extends Hr{constructor(...t){super(...t),this.lineElements=[]}createStyledVector(t,e,n,r,i){const s=new ht(t,e,n,r),o=s.getPolygonResource();return!this.options.atlas&&o&&(i[o]=[0,0]),s}getFormat(){const t=[...this.getPositionFormat()],{polygonFillFn:e,polygonOpacityFn:n,uvScaleFn:r,uvOffsetFn:i,polygonPatternUVFn:s}=this._fnTypes;if(this.iconAtlas){const e=this.getIconAtlasMaxValue();t.push({type:e>255?Uint16Array:Uint8Array,width:4,name:"aTexInfo"})}return e&&t.push({type:Uint8Array,width:4,name:"aColor"}),n&&t.push({type:Uint8Array,width:1,name:"aOpacity"}),r&&t.push({type:Uint16Array,width:2,name:"aUVScale"}),i&&t.push({type:Uint8Array,width:2,name:"aUVOffset"}),s&&t.push({type:Float32Array,width:2,name:"aTexCoord"}),t}placeVector(t,e){const n=t.feature;this._addPolygon(n.geometry,n,e)}_addPolygon(t,e){let n,r,i,s;const{polygonFillFn:a,polygonOpacityFn:l,uvScaleFn:h,uvOffsetFn:c,uvOffsetInMeterFn:u,polygonPatternUVFn:f}=this._fnTypes,d=e.properties;a&&(n=a(this.options.zoom,d)||A["g"].set([],255,255,255,255),Object(o["c"])(n)?(this.dynamicAttrs.aColor=1,n=qs):n=st([],n)),l&&(r=l(this.options.zoom,d),Object(o["c"])(r)?(this.dynamicAttrs.aOpacity=1,r=255):(X(r)&&(r=1),r*=255)),h&&(i=h(this.options.zoom,d),Object(o["c"])(i)?(i=[255,255],this.dynamicAttrs.aUVScale=1):(X(i)&&(i=[1,1]),i=[255*i[0],255*i[1]])),c&&(u&&u(null,d)?s=[0,0]:(s=c(this.options.zoom,d),Object(o["c"])(s)?(s=[0,0],this.dynamicAttrs.aUVOffset=1):(X(s)&&(s=[0,0]),s=[255*s[0],255*s[1]])));const g=!!this.iconAtlas,m=ps(t,500),y=[0,0],v=[0,0];if(g){const{polygonPatternFileFn:t}=this._fnTypes,e=t?t(null,d):this.symbol.polygonPatternFile;if(this.iconAtlas.glyphMap[e]){const t=this.iconAtlas.positions[e],n=!F(t.displaySize[0])||!F(t.displaySize[1]);y[0]=t.tl[0]+(n?1:0),y[1]=t.tl[1]+(n?1:0),v[0]=t.displaySize[0]-1-(n?2:0),v[1]=t.displaySize[1]-1-(n?2:0)}}let x,b=0;f&&(x=f(this.options.zoom,d));const w=this.needAltitudeAttribute()?2:3,_=[-1,-1,e.extent+1,e.extent+1],M=this._flattened=this._flattened||this._arrayPool.get(),T=this._holeIndices=this._holeIndices||this._arrayPool.get();for(let o=0;o<m.length;o++){const t=m[o],e=this.data.aPosition.length/w;M.setLength(0),T.setLength(0);for(let o=0;o<t.length;o++){let e=t[o];if(this.options.EXTENT!==1/0&&0===this.maxPosZ&&(e=js(e,_)),0!==e.length){0!==o&&T.push(M.length/3);for(let t=0;t<e.length;t++){const o=e[t].x,a=e[t].y,l=e[t].z||0;if(this.fillPosition(this.data,o,a,l),g&&this.data.aTexInfo.push(y[0],y[1],v[0],v[1]),void 0!==n&&this.data.aColor.push(n[0],n[1],n[2],n[3]),void 0!==r&&this.data.aOpacity.push(r),void 0!==i&&this.data.aUVScale.push(i[0],i[1]),void 0!==s&&this.data.aUVOffset.push(s[0],s[1]),f){if(x){const t=X(x[2*b])?x[0]:x[2*b],e=X(x[2*b]+1)?x[1]:x[2*b+1];this.data.aTexCoord.push(t,e)}else this.data.aTexCoord.push(-9999999,-9999999);b++}const h=Math.abs(o),c=Math.abs(a);h>this.maxPos&&(this.maxPos=h),c>this.maxPos&&(this.maxPos=c),M.push(o,a,l)}}}let a=p()(M,T,3);if(M.length&&!a.length){const t=[];for(let e=0;e<M.length;e+=3)t[e]=M[e],t[e+1]=M[e+2],t[e+2]=M[e+1];if(a=p()(t,T,3),!a.length){for(let e=0;e<M.length;e+=3)t[e]=M[e+1],t[e+1]=M[e+2],t[e+2]=M[e];a=p()(t,T,3)}}for(let n=0;n<a.length;n+=3)this.addElements(e+a[n],e+a[n+1],e+a[n+2])}}}Int16Array;class Qs{constructor(t){this.max=t,this.reset()}reset(){return this.data={},this.order=[],this}clear(){this.reset()}add(t,e){return this.has(t)?(this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t)):(this.data[t]=e,this.order.push(t),this.order.length>this.max&&this.getAndRemove(this.order[0])),this}has(t){return t in this.data}keys(){return this.order}getAndRemove(t){if(!this.has(t))return null;const e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e}get(t){return this.has(t)?this.data[t]:null}remove(t){return this.has(t)?(delete this.data[t],this.order.splice(this.order.indexOf(t),1),this):this}setMaxSize(t){for(this.max=t;this.order.length>this.max;)this.getAndRemove(this.order[0]);return this}}
/*!
 * based on @mapbox/tiny-sdf
 * https://github.com/mapbox/tiny-sdf
 * @License BSD 2-Clause
 */var Ys=1e20;function Zs(t,e,n,r,i,s,o){this.fontSize=t||24,this.buffer=void 0===e?3:e,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=s||"normal",this.fontStyle=o||"normal",this.radius=n||8;var a=this.size=this.fontSize+2*this.buffer;this.canvas="undefined"==typeof document?new OffscreenCanvas(a,a):document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d",{willReadFrequently:!0}),this.ctx.font=this.fontStyle+" "+this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textBaseline="middle",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a),this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function Ks(t,e,n,r,i,s){for(var o=0;o<e;o++)Js(t,o,e,n,r,i,s);for(var a=0;a<n;a++)Js(t,a*e,1,e,r,i,s)}function Js(t,e,n,r,i,s,o){var a,l,h,c;for(s[0]=0,o[0]=-Ys,o[1]=Ys,a=0;a<r;a++)i[a]=t[e+a*n];for(a=1,l=0,h=0;a<r;a++){do{h=(i[a]-i[c=s[l]]+a*a-c*c)/(a-c)/2}while(h<=o[l]&&--l>-1);s[++l]=a,o[l]=h,o[l+1]=Ys}for(a=0,l=0;a<r;a++){for(;o[l+1]<a;)l++;t[e+a*n]=i[c=s[l]]+(a-c)*(a-c)}}Zs.prototype.draw=function(t,e,n){this.ctx.clearRect(0,0,this.size,this.size),this.ctx.textBaseline="top",this.ctx.fillText(t,this.buffer,this.buffer);for(var r=this.ctx.getImageData(0,0,e,n),i=new Uint8ClampedArray(e*n),s=0;s<e*n;s++){var o=r.data[4*s+3]/255;this.gridOuter[s]=1===o?0:0===o?Ys:Math.pow(Math.max(0,.5-o),2),this.gridInner[s]=1===o?Ys:0===o?0:Math.pow(Math.max(0,o-.5),2)}for(Ks(this.gridOuter,e,n,this.f,this.v,this.z),Ks(this.gridInner,e,n,this.f,this.v,this.z),s=0;s<e*n;s++){var a=Math.sqrt(this.gridOuter[s])-Math.sqrt(this.gridInner[s]);i[s]=Math.round(255-255*(a/this.radius+this.cutoff))}return i};let $s=0;class to{constructor(t,e=15,n){this.entries={},this._cachedFont={},this._cache=new Qs(2048,(function(){})),this._framer=t,this._limit=e,this._isCompactChars=n}getGlyphs(t,e){if(!t||!Object.keys(t).length)return void e(null,{glyphs:null});const n=this.entries,r=t.options;let i=!0;r&&(i=!1!==r.isCharsCompact),i=i||this._isCompactChars;const s=(r,s,a)=>{let l=0,h=0;for(const e in t)if("options"!==e){n[e]=n[e]||{},s[e]=s[e]||{};for(const c in t[e]){if(h++,h<=r)continue;const t=e.split(" "),u=i&&"normal"===t[0]&&!Vi(+c),f=e+":"+c+":"+u;let d;if(this._cache.has(f)?d=this._cache.get(f):(d=this._tinySDF(n[e],t,c,u),this._cache.add(f,d),l++),d=eo(d),s[e][c]=d,a.push(d.bitmap.data.buffer),this._framer&&l>this._limit)return void this._framer(o(h,s,a))}}e(null,{glyphs:s,buffers:a})};function o(t,e,n){return()=>{s(t,e,n)}}s(0,{},[])}_tinySDF(t,e,n,r){const i=e[0],s=e[1],o=e.slice(3).join(" ");let a=t.tinySDF,l="normal"!==i?5:2;const h=r?-1:2;if(!a){let e="400";/bolder/i.test(s)?e="1000":/bold/i.test(s)?e="900":/medium/i.test(s)?e="500":/light/i.test(s)&&(e="200"),a=t.tinySDF=new Zs(24,l,8,.25,o,e,i)}const c=String.fromCodePoint(n),u=a.ctx.measureText(c),f=Math.round(u.width),d=a.draw(c,f+2*l,24+2*l);if($s<4){const t="undefined"!=typeof document&&document.getElementById("sdf-debug-"+$s++);t&&(t.width=f+2*l,t.height=a.canvas.height,t.getContext("2d").drawImage(a.canvas,0,0))}return{charCode:n,bitmap:{width:f+2*l,height:24+2*l,data:d},metrics:{width:f,height:24,left:1,top:-l,advance:f+l+h}}}}function eo(t){const e={width:t.bitmap.width,height:t.bitmap.height,data:new Uint8ClampedArray(t.bitmap.data)};return{charCode:t.charCode,bitmap:e,metrics:W({},t.metrics)}}class no{constructor(t){this.options=t||{},this._requesting={},this._cache=new Qs(256,(function(){}));const e=document.createElement("canvas");this.ctx=e.getContext("2d",{willReadFrequently:!0})}getIcons(t,e){if(!t||!Object.keys(t).length)return void e(null,{icons:null});const n=Object.keys(t),r={},i=[];let s=0,o=0;const a=this;function l(t,n){r[t]=a._getCache(t,n),r[t]&&"error"!==r[t]?i.push(r[t].data.data.buffer):delete r[t],o++,o===s&&e(null,{icons:r,buffers:i})}function h(t){const e=a._requesting[t.url];for(let n=0;n<e.length;n++)e[n].call(t,t.url,t.size);delete a._requesting[t.url]}function c(){const t=a.ctx;let e,n;try{e=this.width,n=this.height,this.size[0]=e,this.size[1]=n,a._ensureMaxSize(null,this.size),e=this.size[0],n=this.size[1];const r=t.canvas;r.width=e,r.height=n,t.imageSmoothingEnabled=!1,t.drawImage(this,0,0,e,n);const i=t.getImageData(0,0,r.width,r.height).data;a._addCache(this.url,i,r.width,r.height)}catch(t){console.warn(t)}h(this)}function u(t){console.warn(`failed loading icon(${this.index}) at "${this.url}"`),console.warn(t),a.options.iconErrorUrl?this.src=a.options.iconErrorUrl:(a._addCache(this.url),h(this))}const f=this.options.urlModifier;let d,p=!1;for(let A=0;A<n.length;A++){const e=n[A],o=t[e];this._ensureMaxSize(e,o);const a=this._getCache(e,o);if(a&&"error"!==a){r[e]=this._getCache(e,o);continue}if("error"===a)continue;let h,m=e;if(0===e.indexOf("vector://")&&(h=JSON.parse(e.substring("vector://".length)),"path"===h.markerType&&(m=g["I"].getMarkerPathBase64(h,h.markerWidth,h.markerHeight))),0===e.indexOf("vector://")&&"path"!==h.markerType){d=d||new g["u"]([0,0]);const{markerFill:t,markerLineColor:n}=h;t&&Array.isArray(t)&&(h.markerFill=ro(t)),n&&Array.isArray(n)&&(h.markerLineColor=ro(n)),delete h.markerHorizontalAlignment,delete h.markerVerticalAlignment,delete h.markerDx,delete h.markerDy,delete h.markerPlacement,delete h.markerFile,h.markerWidth=o[0],h.markerHeight=o[1],d.setSymbol(h);const s=d["_getSprite".trim()]();if(s){const t=s.canvas,n=t.width,o=t.height,a=t.getContext("2d").getImageData(0,0,n,o).data;r[e]={data:{data:new Uint8ClampedArray(a),width:n,height:o},url:e},i.push(r[e].data.data.buffer),this._addCache(e,a,n,o)}}else{if(this._requesting[e]){p=!0,s++,this._requesting[e].push(l);continue}this._requesting[e]=[],this._requesting[e].push(l);const t=new Image;t.index=A,t.size=o,t.onload=c,t.onerror=u,t.onabort=u,t.url=e,t.crossOrigin="Anonymous",p=!0,s++,t.src=f&&f(m)||m}}p||e(null,{icons:r,buffers:i})}_hasCache(t,e,n){const r=this._cache.get(t);return r&&"error"!==r&&r.data.width>=e&&r.data.height>=n}_addCache(t,e,n,r){this._hasCache(t,n,r)||this._cache.add(t,e?{data:{data:e,width:n,height:r},url:t}:"error")}_getCache(t,e){if(!this._hasCache(t,e[0],e[1]))return null;const n=this._cache.get(t);return n?"error"===n?n:{data:{data:new Uint8ClampedArray(n.data.data),width:n.data.width,height:n.data.height},url:n.url}:null}_ensureMaxSize(t,e){if(!e[0]||!e[1])return;const n=this.options.maxSize||2048;let[r,i]=e;const s=r/i;if(t){const e=this._cache.get(t);if(e&&"error"!==e){const{width:t,height:n}=e.data;t>r&&(r=t),n>i&&(i=n)}}r>n&&(i=n/s,r=n),i>n&&(r=n*s,i=n),e[0]=Math.floor(r),e[1]=Math.floor(i)}}function ro(t){return 3===t.length&&t.push(1),t.reduce((t,e,n)=>t+(n<3?255*e+",":e+")"),"rgba(")}var io=Object.freeze({__proto__:null,clipPolygon:js,calculateSignedArea:O,getFeaAltitudeAndHeight:P,generatePickingIndiceIndex:D,convertRTLText:ss,packPosition:ct,unpackPosition:function(t,e,n,r){const i=(Math.sign(e)||1)*(Math.abs(e)%ut),s=(Math.sign(n)||1)*(Math.abs(n)%ut),o=Math.floor(Math.abs(e)/ut),a=Math.floor(Math.abs(n)/ut);return t[0]=i,t[1]=s,t[2]=Math.sign(r+1e-5)*(2*o+a)*ft+r,t},convertGeometry:q,getPosArrayType:j,getUnsignedArrayType:V,getIndexArrayType:U});const so={},oo={},ao=[];var lo=Object.freeze({__proto__:null,loadSymbolFnTypes:function t(e,n){if(!e)return null;var r=!1;if(Array.isArray(e)){var i,s=[];for(let o=0;o<e.length;o++)(i=t(e[o],n))?(s.push(i),r=!0):s.push(e[o]);return r?s:e}var a={__fn_types_loaded:!0};const l=[];for(const o in e)$(e,o)&&l.push(o);const h=function(t){Object.defineProperty(a,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=Object(o["b"])(this["_"+t])),this["__fn_"+t].apply(this,n())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},c={},u=function(t,e){Object.defineProperty(a,t,{get:function(){this["__fn_"+t]||(this["__fn_"+t]=vr(this["_"+t],e));const r=n()[0];c.zoom=r;try{return this["__fn_"+t].evaluateWithoutErrorHandling(c,so,oo,null,ao)}catch(t){return null}},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let f=0,d=l.length;f<d;f++){const t=l[f];if(Object(o["c"])(e[t]))r=!0,a["_"+t]=e[t],h(t);else if(xr(e[t])){r=!0;const n=Tr(t);a["_"+t]=e[t],u(t,n)}else a[t]=e[t]}return r?a:e}});const ho=23.25,co={polygonPatternFile:1,markerFile:1,markerPlacement:1,markerSpacing:1,textName:1,textStyle:1,textFaceName:1,textWeight:1,textPlacement:1,textSpacing:1,lineJoin:1,lineCap:1,linePatternFile:1},uo={visible:1,textHorizontalAlignment:1,textVerticalAlignment:1,textWrapWidth:1,markerHorizontalAlignment:1,markerVerticalAlignment:1},fo={lineDasharray:1,topPolygonFill:1,bottomPolygonFill:1};Object.assign(uo,co),Object.assign(fo,co)}).call(this,n("c8ba"))},8282:function(t,e,n){"use strict";(function(t){var e=n("18b7"),r=n("e470"),i=n("f980"),s=n("31d3"),o=n("c3b8");
/*!
 * @maptalks/3dtiles v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */
const a='function(t){var e="undefined"!=typeof Float32Array?Float32Array:Array;function n(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function r(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3],a=e[4],c=e[5],u=e[6],f=e[7],h=e[8],l=e[9],d=e[10],y=e[11],m=e[12],b=e[13],p=e[14],w=e[15],g=n[0],v=n[1],M=n[2],T=n[3];return t[0]=g*r+v*a+M*h+T*m,t[1]=g*s+v*c+M*l+T*b,t[2]=g*i+v*u+M*d+T*p,t[3]=g*o+v*f+M*y+T*w,g=n[4],v=n[5],M=n[6],T=n[7],t[4]=g*r+v*a+M*h+T*m,t[5]=g*s+v*c+M*l+T*b,t[6]=g*i+v*u+M*d+T*p,t[7]=g*o+v*f+M*y+T*w,g=n[8],v=n[9],M=n[10],T=n[11],t[8]=g*r+v*a+M*h+T*m,t[9]=g*s+v*c+M*l+T*b,t[10]=g*i+v*u+M*d+T*p,t[11]=g*o+v*f+M*y+T*w,g=n[12],v=n[13],M=n[14],T=n[15],t[12]=g*r+v*a+M*h+T*m,t[13]=g*s+v*c+M*l+T*b,t[14]=g*i+v*u+M*d+T*p,t[15]=g*o+v*f+M*y+T*w,t}function s(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function i(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function o(t,e){var n=e[0],r=e[1],s=e[2],i=e[3],o=n+n,a=r+r,c=s+s,u=n*o,f=r*o,h=r*a,l=s*o,d=s*a,y=s*c,m=i*o,b=i*a,p=i*c;return t[0]=1-h-y,t[1]=f+p,t[2]=l-b,t[3]=0,t[4]=f-p,t[5]=1-u-y,t[6]=d+m,t[7]=0,t[8]=l+b,t[9]=d-m,t[10]=1-u-h,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function a(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function c(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function u(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function f(t,n,r){var s=new e(3);return s[0]=t,s[1]=n,s[2]=r,s}function h(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function l(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function d(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function y(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function m(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function b(t,e){var n=e[0],r=e[1],s=e[2],i=n*n+r*r+s*s;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i),t}function p(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function w(t,e,n){var r=e[0],s=e[1],i=e[2],o=n[0],a=n[1],c=n[2];return t[0]=s*c-i*a,t[1]=i*o-r*c,t[2]=r*a-s*o,t}function g(t,e,n){var r=e[0],s=e[1],i=e[2],o=n[3]*r+n[7]*s+n[11]*i+n[15];return o=o||1,t[0]=(n[0]*r+n[4]*s+n[8]*i+n[12])/o,t[1]=(n[1]*r+n[5]*s+n[9]*i+n[13])/o,t[2]=(n[2]*r+n[6]*s+n[10]*i+n[14])/o,t}var v=function(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t},M=y,T=u;function A(t,e,n,r,s){return t[0]=e,t[1]=n,t[2]=r,t[3]=s,t}function _(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3];return t[0]=n[0]*r+n[4]*s+n[8]*i+n[12]*o,t[1]=n[1]*r+n[5]*s+n[9]*i+n[13]*o,t[2]=n[2]*r+n[6]*s+n[10]*i+n[14]*o,t[3]=n[3]*r+n[7]*s+n[11]*i+n[15]*o,t}function O(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function x(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function S(t,e,n,r){var s=e[0],i=e[1],o=e[2],a=e[3],c=n[0],u=n[1],f=n[2],h=n[3],l=void 0,d=void 0,y=void 0,m=void 0,b=void 0;return(d=s*c+i*u+o*f+a*h)<0&&(d=-d,c=-c,u=-u,f=-f,h=-h),1-d>1e-6?(l=Math.acos(d),y=Math.sin(l),m=Math.sin((1-r)*l)/y,b=Math.sin(r*l)/y):(m=1-r,b=r),t[0]=m*s+b*c,t[1]=m*i+b*u,t[2]=m*o+b*f,t[3]=m*a+b*h,t}c(),function(){var t,n=(t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var I,k=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};c(),f(1,0,0),f(0,1,0),O(),O(),I=new e(9),e!=Float32Array&&(I[1]=0,I[2]=0,I[3]=0,I[5]=0,I[6]=0,I[7]=0),I[0]=1,I[4]=1,I[8]=1;\n/*!\n   * @maptalks/gltf-loader v0.97.2\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.org\n   */\nlet E=0;function C(t){return null==t}function U(t){return!C(t)}function F(t){return!C(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function N(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function P(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView\'s component type: "+t)}function B(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function D(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=e.charCodeAt(t);return r.buffer}const R=[],L=[],j=[],z=[0,0,0],V=x([]),q=[1,1,1];function G(t,e,n,r,s,i,o){const a=P(o);if((0===s||s===r*a.BYTES_PER_ELEMENT)&&i%a.BYTES_PER_ELEMENT==0){const s=new a(e,i,n*r);return t.set(s),t}0===s&&(s=r*a.BYTES_PER_ELEMENT);const c=new Uint8Array(r*a.BYTES_PER_ELEMENT);for(let o=0;o<n;o++){let n=null;const u=new Uint8Array(e,s*o+i,r*a.BYTES_PER_ELEMENT);c.set(u),n=new a(c.buffer,0,r);for(let e=0;e<r;e++)t[o*r+e]=n[e]}return t}const $="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function X(t,e,n){const r=new Uint8Array(t,e,n);return $.decode(r)}const H={get:function(t,e={},n){e||(e={});const r=new AbortController,s=r.signal,i=N({},e);i.signal=s,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),n&&(t=n(t));const o=fetch(t,i).then(t=>{const n=this.t(t,e.responseType);return n.message?n:n.then(n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t})}).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t});return o.xhr=r,o},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",H.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?H.jsonp(t):((e=e||{}).responseType="json",H.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+E++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise(t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)})}};class J{constructor(t,e,n,r,s){this.s=t,this.decoders=e,this.i=n,this.images={},this.o={},this.u=r||{},this.h=s}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],s=this.m(e,r);return this.getImageByBuffer(s,n)}if(this.o[t.id])return this.o[t.id].then(()=>{const r=this.buffers[t.id],s=this.m(e,r);return this.getImageByBuffer(s,n)});if(B(t.uri)){const r=this.buffers[t.id]=D(t.uri),s=this.m(e,r);return this.getImageByBuffer(s,n)}let r;const s=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||s?t.uri:this.rootPath+"/"+t.uri,this.o[t.id]=H.getArrayBuffer(r,this.u,this.h).then(r=>{const s=this.buffers[t.id]=r.data,i=this.m(e,s);return this.getImageByBuffer(i,n)})}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this.i}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this.p(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.o[t.id]?this.o[t.id].then(()=>this.images[t.id]):this.o[t.id]=this.p(t.id,e)}p(t,e){return new Promise((n,r)=>{let s=e;this.h&&(s=this.h(e)),this.s(s,this.u,(s,i)=>{s?r(s):(URL.revokeObjectURL(e),this.images[t]=i,n(this.images[t]))})})}}const K=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],Y=[];class Q{constructor(t,e,n,r,s){this.rootPath=t,this.gltf=e,this.v=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.M(),this.u=r,this.h=s}T(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this.A(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const s=n.bufferViews[r.bufferView];return this._(s).then(n=>{const{buffer:s,byteOffset:i}=n;return this.accessors[r.id]=this.A(t,e,s,i)})}_(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then(()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})});if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(B(e.uri)){const t=this.buffers[e.id]=D(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=H.getArrayBuffer(t,this.u,!n&&this.h).then(r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0}))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}A(t,e,n,r=0){const s=this.gltf,i=s.accessors[e],o=void 0!==i.bufferView?s.bufferViews[i.bufferView]:{},a=(o.byteOffset||0)+r,c=this.O(i.type),u=P(i.componentType),f=o.byteStride||0,h={array:void 0,name:t,accessorName:e,byteLength:i.count*c*u.BYTES_PER_ELEMENT,componentType:i.componentType,count:i.count,type:i.type,itemSize:c,max:i.max,min:i.min,extensions:i.extensions};if(i.min&&(h.min=i.min),i.max&&(h.max=i.max),n)if(this.v)h.byteStride=f,h.byteOffset=a+(i.byteOffset||0),!f||f===c*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(h.array=this.S(n,i.count,c,a+(i.byteOffset||0),u),h.array.buffer.byteLength===h.byteLength&&(h.byteOffset=0)):h.array=new Uint8Array(n,a,o.byteLength);else if(i.interleaved){h.byteStride=0,h.byteOffset=0;const t=new u(i.count*c);if(h.array=G(t,n,i.count,c,f,a+(i.byteOffset||0),i.componentType),h.extensions&&h.extensions.WEB3D_quantized_attributes&&c>2){const t=new Float32Array(h.array.length),{decodeMatrix:e}=h.extensions.WEB3D_quantized_attributes;for(let n=0;n<h.array.length;n+=c){Y[0]=h.array[n],Y[1]=h.array[n+1],Y[2]=h.array[n+2],Y[3]=1;const r=_(Y,Y,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}h.componentType=5126,h.array=t}}else h.byteStride=0,h.array=this.S(n,i.count,c,a+(i.byteOffset||0),u),h.byteOffset=h.array.byteOffset;else{h.array=new u(i.count);const t=h.min||h.max;t&&(h.array[0]=t[0],h.array[1]=t[1],h.array[2]=t[2])}return h}M(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}S(t,e,n,r,s){return r%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*s.BYTES_PER_ELEMENT),r=0),new s(t,r,n*e)}O(t){const e=K.indexOf(t);return K[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map(t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this._(e).then(r=>{const{buffer:s,byteOffset:i}=r,o=X(s,i+(e.byteOffset||0),n);return t.content=o,t})}if(t.uri){if(B(t.uri)){const e=D(t.uri),n=X(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return H.get(e,this.u,this.h).then(e=>(t.content=e,t))}}return Promise.resolve(t)});return Promise.all(n).then(()=>t)}}class W extends J{constructor(t,e,n,r,s,i,o,a){super(r,s,i,o,a),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new Q(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const e in n)t(e,n[e],r++)}createNode(t){const e={};if(U(t.name)&&(e.name=t.name),U(t.children)&&(e.children=t.children),U(t.jointName)&&(e.jointName=t.jointName),U(t.matrix)&&(e.matrix=t.matrix),U(t.rotation)&&(e.rotation=t.rotation),U(t.scale)&&(e.scale=t.scale),U(t.translation)&&(e.translation=t.translation),U(t.extras)&&(e.extras=t.extras),U(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const n=s(R,e.translation||z),a=o(L,e.rotation||V),c=i(j,e.scale||q);return r(c,a,c),r(t,n,c)}return n(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}I(t){const e={};for(const n in t){const r=t[n];let s,i;r.instanceTechnique&&r.instanceTechnique.values?(s=r.instanceTechnique,i=s.values.diffuse):(s=r,i=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:i}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}k(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,s=n.byteLength,i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,s);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}C(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.k(n).then(t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}})}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const s=this.gltf.textures[r];if(!s)return null;const i=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:i,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}class Z extends J{constructor(t,e,n,r,s,i,o,a){super(r,s,i,o,a),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new Q(t,e,n,o,a)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return N(e,t),!U(t.weights)&&this.gltf.meshes&&U(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}C(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!U(n))return null;const r=this.gltf.images[n];return this.k(r).then(t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};N(n,e);const s=U(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return s&&(n.sampler=s,n.sampler.magFilter=s.magFilter||9729,n.sampler.minFilter=s.minFilter||9729,n.sampler.wrapS=s.wrapS||10497,n.sampler.wrapT=s.wrapT||10497),t.format&&(n.format=t.format),n})}k(t){if(!U(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.U(e,t)}return null}U(t,e){const n=this.m(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}m(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,s=t.byteLength;return new Uint8Array(e,r,s)}F(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach(t=>{e.push(this.getSamplers(t.samplers))}),Promise.all(e).then(e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t})}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(U(t[n].input)||U(t[n].output))&&(e.push(this.accessor.T("input",t[n].input)),e.push(this.accessor.T("output",t[n].output)));return Promise.all(e).then(e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t})}}const tt="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class et{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),s=r.getUint32(4,!0);if(1===s)return et.readV1(r,e);if(2===s)return et.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb\'s byte length.");const s=nt(t.buffer,20+e,r);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,s;const i=new DataView(t,e+12);let o=0;for(;o<i.byteLength;){const a=i.getUint32(o,!0);o+=4;const c=i.getUint32(o,!0);if(o+=4,1313821514===c)n=nt(t,e+12+o,a);else if(5130562===c){s=e+12+o,r=a;break}o+=a}return{json:JSON.parse(n),glbBuffer:{byteOffset:s,buffer:t,byteLength:r}}}}function nt(t,e,n){if(tt){const r=new Uint8Array(t,e,n);return tt.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let s=t[r++];if(128&s){let n=rt[s>>3&7];if(!(64&s)||!n||r+n>e)return null;for(s&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;s=s<<6|63&e}}n+=String.fromCharCode(s)}return n}(new Uint8Array(t,e,n))}const rt=[1,1,1,1,2,2,3,0],st=[0,0,0],it=[0,0,0,1],ot=[1,1,1],at={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},ct={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},ut={N(t,e,n,r,s,i,o,a){const c=U(t)?e.animations:[e.animations[0]],u={};for(let e=0;e<c.length;e++){const f=c[e],l=f.name||e;if(U(t)&&l!==t)continue;const d=f.channelsMap[n];if(d)for(let t=0;t<d.length;t++){const e=d[t];"translation"===e.target.path?(this.P(s,f.samplers[e.sampler],r,1),u.translation=h(st,s)):"rotation"===e.target.path?(this.B(i,f.samplers[e.sampler],r,1),u.rotation=k(it,i)):"scale"===e.target.path?(this.P(o,f.samplers[e.sampler],r,1),u.scale=h(ot,o)):"weights"===e.target.path&&a&&(this.P(a,f.samplers[e.sampler],r,a.length),u.weights=a)}}return u},P(t,e,n,r){switch(e.interpolation){case"LINEAR":{const s=this.D(ct,e,n,1*r);s&&(t=function(t,e,n,r){for(let s=0;s<t.length;s++)t[s]=e[s]+r*(n[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.D(ct,e,n,1*r);s&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.D(ct,e,n,3*r);s&&(t=this.R(t,s,e.input.array,3*r));break}}return t},B(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this.D(ct,e,n,1);r&&S(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this.D(ct,e,n,1);r&&(t=A(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this.D(ct,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this.R(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},L(t,e){const n=t.length;let r,s,i,o=0,a=n-1,c=Math.floor((o+a)/2);for(;o<=n-1&&a>=0;){if(o===a)return null;if(t[c]<=e&&e<=t[c+1]){const n=t[c];return r=c,s=c+1,i=(e-n)/(t[c+1]-n),{preIndx:r,nextIndex:s,interpolation:i}}e<t[c]?(a=c,c=Math.floor((o+a)/2)):t[c+1]<e&&(o=c,c=Math.floor((o+a)/2))}return null},D(t,e,n,r){const s=e.input.array,i=e.output.array,o=e.output.itemSize;(n<s[0]||n>s[s.length-1])&&(n=Math.max(s[0],Math.min(s[s.length-1],n))),n===s[s.length-1]&&(n=s[0]);const a=this.L(s,n);if(!a||!a.nextIndex)return null;const{preIndx:c,nextIndex:u,interpolation:f}=a;t.PREINDEX=c,t.NEXTINDEX=u,t.INTERPOLATION=f;const h=o*r;return t.PREVIOUS=i.subarray(t.PREINDEX*h,(t.PREINDEX+1)*h),t.NEXT=i.subarray(t.NEXTINDEX*h,(t.NEXTINDEX+1)*h),t},R(t,e,n,r){const s=e.INTERPOLATION,i=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let n=0;n<3;n++){const a=e.PREVIOUS[r+n],c=(o-i)*e.PREVIOUS[2*r+n],u=e.NEXT[3+n],f=(o-i)*e.NEXT[n],h=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*a+(Math.pow(s,3)-2*Math.pow(s,2)+s)*c+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*f;t[n]=h}return t},getAnimationClip(t,e,n,r){const s=t.nodes[e]&&t.nodes[e].weights;return l(st,...at.TRANSLATION),A(it,...at.ROTATION),l(ot,...at.SCALE),this.N(r,t,e,n,st,it,ot,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach((e,n)=>{let r=-1/0,s=1/0;const i=e.channels;for(let t=0;t<i.length;t++){const n=i[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:s}}),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?U(e)?n[e]:n[Object.keys(n)[0]]:null}};let ft=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(Qe){}t&&"undefined"!=typeof createImageBitmap&&(ft=!0)}const ht="undefined"==typeof document?null:document.createElement("canvas");class lt{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.u=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=et.read(e.buffer,e.byteOffset,e.byteLength);this.j(t,n,r)}else this.j(t,e);this.V=new Q(this.rootPath,this.gltf,this.glbBuffer,this.u,this.options.urlModifier),this.q()}q(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}G(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.V.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then(e=>(t.KHR_techniques_webgl=e,t)):Promise.resolve(t)}load(t){t=t||{};const e=this.$(t),n=this.X(),r=this.H(),s=this.G();return Promise.all([e,n,r,s]).then(t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0]))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,r){return ut.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return ut.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return P(t)}static readInterleavedArray(t,e,n,r,s,i,o){return G(t,e,n,r,s,i,o)}j(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=ft?wt.bind(this):this.options.requestImage||dt,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new Z(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="buffer_"+n},"buffers"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors")):(this.adapter=new W(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"))}J(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||F(t.children[0])))return t;const r=t.children.map(t=>{const n=e[t];return n.nodeIndex=t,this.J(n,e)});t.children=r}var n;return t}$(t){return this.K(t).then(t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.J(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate((r,s,i)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map(e=>t[e])),this.gltf.scene===r&&(n=i),e.push(o)},"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.I(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r})}K(t){return this.Y(t).then(()=>{const t=this.nodes={};return this.adapter.iterate((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r},"nodes"),t})}W(){this.skins=[];const t=[];return this.adapter.iterate((e,n,r)=>{t.push(this.Z(n).then(t=>{t.index=r,this.skins.push(t)}))},"skins"),t}Z(t){const e=t.inverseBindMatrices;return this.adapter.accessor.T("inverseBindMatrices",e).then(e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t))}X(){const t=this.gltf.animations;return U(t)?this.adapter.getAnimations(t):null}Y(t){this.meshes={};let e=[];return this.adapter.iterate((n,r,s)=>{e.push(this.tt(r,t).then(t=>{t.index=s,this.meshes[n]=t}))},"meshes"),e=e.concat(this.W()),Promise.all(e)}tt(t,e){const n=t.primitives.map(t=>this.et(t,e)).filter(t=>!!t);return Promise.all(n).then(e=>{const n={};return N(n,t),n.primitives=e,n})}H(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.C(n));return Promise.all(e).then(e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t].image.array;if(e[t]&&n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e})}et(t,e){let n;const r=[],s=t.extensions;if(U(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const s=this.adapter.accessor.T(`morphTargets_${t}_${e}`,n[t]);s&&r.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:i,attributes:o}=s.KHR_draco_mesh_compression,a=this.gltf.bufferViews[i],c=this.V._(a).then(n=>{const{buffer:r,byteOffset:s}=n;let{byteOffset:i}=a;const c=a.byteLength;i||(i=0);const u=new DataView(r,s+i,c),f={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,f).then(t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e})});r.push(c),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor.T(t,e[t]);n&&r.push(n)}if(U(t.indices)){const e=this.adapter.accessor.T("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then(e=>{if(s&&s.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const i={attributes:e.reduce((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:s}=e,i=s.length/r;for(let e=0;e<i;e++)for(let i=0;i<r;i++){const o=e*r+i;s[o]<t[i]&&(t[i]=s[o]),s[o]>n[i]&&(n[i]=s[o])}if(e.quantization){const r=e.quantization,s=r.range/(1<<r.quantizationBits),i=r.minValues;m(t,t,s),d(t,t,i),m(n,n,s),d(n,n,i)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t},{}),material:t.material};return n&&(i.indices=n),r&&(i.morphTargets=r),i.mode=U(t.mode)?t.mode:4,U(t.extras)&&(i.extras=t.extras),i})}}function dt(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!ht)return void n(new Error("There is no canvas to draw image!"));ht.width=r.width,ht.height=r.height;const t=ht.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),s={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,s)},r.onerror=function(t){n(t)},r.src=t}const yt=[],mt=[];let bt,pt;function wt(t,e,n){bt||(bt=new OffscreenCanvas(2,2),pt=bt.getContext("2d",{willReadFrequently:!0}));let r=null;if(F(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),yt.push([t,e,n,this]),function t(){if(!yt.length||mt.length>10)return;const e=yt.shift(),[n,r,s,i]=e;mt.push(e),fetch(n,r).then(t=>t.arrayBuffer()).then(t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)}).then(gt.bind(i)).then(n=>{s.call(i,null,n);const r=mt.indexOf(e);mt.splice(r,1),t()}).catch(n=>{console.warn(n),s.call(i,n);const r=mt.indexOf(e);mt.splice(r,1),t()})}();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(gt.bind(this)).then(t=>{n(null,t)}).catch(t=>{console.warn(t),n(t)})}}function gt(t){let{width:e,height:n}=t;vt(e)||(e=Mt(e)),vt(n)||(n=Mt(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),bt.width=e,bt.height=n,pt.drawImage(t,0,0,e,n),t.close();const s=pt.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(s.data)}}function vt(t){return 0==(t&t-1)&&0!==t}function Mt(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}var Tt={exports:{}},At={"aliceblue":[240,248,255],"antiquewhite":[250,235,215],"aqua":[0,255,255],"aquamarine":[127,255,212],"azure":[240,255,255],"beige":[245,245,220],"bisque":[255,228,196],"black":[0,0,0],"blanchedalmond":[255,235,205],"blue":[0,0,255],"blueviolet":[138,43,226],"brown":[165,42,42],"burlywood":[222,184,135],"cadetblue":[95,158,160],"chartreuse":[127,255,0],"chocolate":[210,105,30],"coral":[255,127,80],"cornflowerblue":[100,149,237],"cornsilk":[255,248,220],"crimson":[220,20,60],"cyan":[0,255,255],"darkblue":[0,0,139],"darkcyan":[0,139,139],"darkgoldenrod":[184,134,11],"darkgray":[169,169,169],"darkgreen":[0,100,0],"darkgrey":[169,169,169],"darkkhaki":[189,183,107],"darkmagenta":[139,0,139],"darkolivegreen":[85,107,47],"darkorange":[255,140,0],"darkorchid":[153,50,204],"darkred":[139,0,0],"darksalmon":[233,150,122],"darkseagreen":[143,188,143],"darkslateblue":[72,61,139],"darkslategray":[47,79,79],"darkslategrey":[47,79,79],"darkturquoise":[0,206,209],"darkviolet":[148,0,211],"deeppink":[255,20,147],"deepskyblue":[0,191,255],"dimgray":[105,105,105],"dimgrey":[105,105,105],"dodgerblue":[30,144,255],"firebrick":[178,34,34],"floralwhite":[255,250,240],"forestgreen":[34,139,34],"fuchsia":[255,0,255],"gainsboro":[220,220,220],"ghostwhite":[248,248,255],"gold":[255,215,0],"goldenrod":[218,165,32],"gray":[128,128,128],"green":[0,128,0],"greenyellow":[173,255,47],"grey":[128,128,128],"honeydew":[240,255,240],"hotpink":[255,105,180],"indianred":[205,92,92],"indigo":[75,0,130],"ivory":[255,255,240],"khaki":[240,230,140],"lavender":[230,230,250],"lavenderblush":[255,240,245],"lawngreen":[124,252,0],"lemonchiffon":[255,250,205],"lightblue":[173,216,230],"lightcoral":[240,128,128],"lightcyan":[224,255,255],"lightgoldenrodyellow":[250,250,210],"lightgray":[211,211,211],"lightgreen":[144,238,144],"lightgrey":[211,211,211],"lightpink":[255,182,193],"lightsalmon":[255,160,122],"lightseagreen":[32,178,170],"lightskyblue":[135,206,250],"lightslategray":[119,136,153],"lightslategrey":[119,136,153],"lightsteelblue":[176,196,222],"lightyellow":[255,255,224],"lime":[0,255,0],"limegreen":[50,205,50],"linen":[250,240,230],"magenta":[255,0,255],"maroon":[128,0,0],"mediumaquamarine":[102,205,170],"mediumblue":[0,0,205],"mediumorchid":[186,85,211],"mediumpurple":[147,112,219],"mediumseagreen":[60,179,113],"mediumslateblue":[123,104,238],"mediumspringgreen":[0,250,154],"mediumturquoise":[72,209,204],"mediumvioletred":[199,21,133],"midnightblue":[25,25,112],"mintcream":[245,255,250],"mistyrose":[255,228,225],"moccasin":[255,228,181],"navajowhite":[255,222,173],"navy":[0,0,128],"oldlace":[253,245,230],"olive":[128,128,0],"olivedrab":[107,142,35],"orange":[255,165,0],"orangered":[255,69,0],"orchid":[218,112,214],"palegoldenrod":[238,232,170],"palegreen":[152,251,152],"paleturquoise":[175,238,238],"palevioletred":[219,112,147],"papayawhip":[255,239,213],"peachpuff":[255,218,185],"peru":[205,133,63],"pink":[255,192,203],"plum":[221,160,221],"powderblue":[176,224,230],"purple":[128,0,128],"rebeccapurple":[102,51,153],"red":[255,0,0],"rosybrown":[188,143,143],"royalblue":[65,105,225],"saddlebrown":[139,69,19],"salmon":[250,128,114],"sandybrown":[244,164,96],"seagreen":[46,139,87],"seashell":[255,245,238],"sienna":[160,82,45],"silver":[192,192,192],"skyblue":[135,206,235],"slateblue":[106,90,205],"slategray":[112,128,144],"slategrey":[112,128,144],"snow":[255,250,250],"springgreen":[0,255,127],"steelblue":[70,130,180],"tan":[210,180,140],"teal":[0,128,128],"thistle":[216,191,216],"tomato":[255,99,71],"turquoise":[64,224,208],"violet":[238,130,238],"wheat":[245,222,179],"white":[255,255,255],"whitesmoke":[245,245,245],"yellow":[255,255,0],"yellowgreen":[154,205,50]},_t={exports:{}},Ot=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},xt=Array.prototype.concat,St=Array.prototype.slice,It=_t.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var s=t[n];Ot(s)?e=xt.call(e,St.call(s)):e.push(s)}return e};It.wrap=function(t){return function(){return t(It(arguments))}};var kt=At,Et=_t.exports,Ct=Object.hasOwnProperty,Ut=Object.create(null);for(var Ft in kt)Ct.call(kt,Ft)&&(Ut[kt[Ft]]=Ft);var Nt=Tt.exports={to:{},get:{}};function Pt(t,e,n){return Math.min(Math.max(e,t),n)}function Bt(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}Nt.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=Nt.get.hsl(t),n="hsl";break;case"hwb":e=Nt.get.hwb(t),n="hwb";break;default:e=Nt.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},Nt.get.rgb=function(t){if(!t)return null;var e,n,r,s=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var i=2*n;s[n]=parseInt(e.slice(i,i+2),16)}r&&(s[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)s[n]=parseInt(e[n]+e[n],16);r&&(s[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\\(\\s*([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)(?=[\\s,])\\s*(?:,\\s*)?([+-]?\\d+)\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)){for(n=0;n<3;n++)s[n]=parseInt(e[n+1],0);e[4]&&(e[5]?s[3]=.01*parseFloat(e[4]):s[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\\(\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*,?\\s*([+-]?[\\d\\.]+)\\%\\s*(?:[,|\\/]\\s*([+-]?[\\d\\.]+)(%?)\\s*)?\\)$/)))return(e=t.match(/^(\\w+)$/))?"transparent"===e[1]?[0,0,0,0]:Ct.call(kt,e[1])?((s=kt[e[1]])[3]=1,s):null:null;for(n=0;n<3;n++)s[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?s[3]=.01*parseFloat(e[4]):s[3]=parseFloat(e[4]))}for(n=0;n<3;n++)s[n]=Pt(s[n],0,255);return s[3]=Pt(s[3],0,1),s},Nt.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\\(\\s*([+-]?(?:\\d{0,3}\\.)?\\d+)(?:deg)?\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*,?\\s*([+-]?[\\d\\.]+)%\\s*(?:[,|\\/]\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,Pt(parseFloat(e[2]),0,100),Pt(parseFloat(e[3]),0,100),Pt(isNaN(n)?1:n,0,1)]}return null},Nt.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\\(\\s*([+-]?\\d{0,3}(?:\\.\\d+)?)(?:deg)?\\s*,\\s*([+-]?[\\d\\.]+)%\\s*,\\s*([+-]?[\\d\\.]+)%\\s*(?:,\\s*([+-]?(?=\\.\\d|\\d)(?:0|[1-9]\\d*)?(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)\\s*)?\\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,Pt(parseFloat(e[2]),0,100),Pt(parseFloat(e[3]),0,100),Pt(isNaN(n)?1:n,0,1)]}return null},Nt.to.hex=function(){var t=Et(arguments);return"#"+Bt(t[0])+Bt(t[1])+Bt(t[2])+(t[3]<1?Bt(Math.round(255*t[3])):"")},Nt.to.rgb=function(){var t=Et(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},Nt.to.rgb.percent=function(){var t=Et(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},Nt.to.hsl=function(){var t=Et(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},Nt.to.hwb=function(){var t=Et(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},Nt.to.keyword=function(t){return Ut[t.slice(0,3)]};var Dt={exports:{}},Rt=At,Lt={};for(var jt in Rt)Rt.hasOwnProperty(jt)&&(Lt[Rt[jt]]=jt);var zt=Dt.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var Vt in zt)if(zt.hasOwnProperty(Vt)){if(!("channels"in zt[Vt]))throw new Error("missing channels property: "+Vt);if(!("labels"in zt[Vt]))throw new Error("missing channel labels property: "+Vt);if(zt[Vt].labels.length!==zt[Vt].channels)throw new Error("channel and label counts mismatch: "+Vt);var qt=zt[Vt].channels,Gt=zt[Vt].labels;delete zt[Vt].channels,delete zt[Vt].labels,Object.defineProperty(zt[Vt],"channels",{value:qt}),Object.defineProperty(zt[Vt],"labels",{value:Gt})}function $t(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}zt.rgb.hsl=function(t){var e,n,r=t[0]/255,s=t[1]/255,i=t[2]/255,o=Math.min(r,s,i),a=Math.max(r,s,i),c=a-o;return a===o?e=0:r===a?e=(s-i)/c:s===a?e=2+(i-r)/c:i===a&&(e=4+(r-s)/c),(e=Math.min(60*e,360))<0&&(e+=360),n=(o+a)/2,[e,100*(a===o?0:n<=.5?c/(a+o):c/(2-a-o)),100*n]},zt.rgb.hsv=function(t){var e,n,r,s,i,o=t[0]/255,a=t[1]/255,c=t[2]/255,u=Math.max(o,a,c),f=u-Math.min(o,a,c),h=function(t){return(u-t)/6/f+.5};return 0===f?s=i=0:(i=f/u,e=h(o),n=h(a),r=h(c),o===u?s=r-n:a===u?s=1/3+e-r:c===u&&(s=2/3+n-e),s<0?s+=1:s>1&&(s-=1)),[360*s,100*i,100*u]},zt.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[zt.rgb.hsl(t)[0],100*(1/255*Math.min(e,Math.min(n,r))),100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},zt.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,s=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-s)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-s-e)/(1-e)||0),100*e]},zt.rgb.keyword=function(t){var e=Lt[t];if(e)return e;var n,r=1/0;for(var s in Rt)if(Rt.hasOwnProperty(s)){var i=$t(t,Rt[s]);i<r&&(r=i,n=s)}return n},zt.keyword.rgb=function(t){return Rt[t]},zt.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},zt.rgb.lab=function(t){var e=zt.rgb.xyz(t),n=e[0],r=e[1],s=e[2];return r/=100,s/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(s=s>.008856?Math.pow(s,1/3):7.787*s+16/116))]},zt.hsl.rgb=function(t){var e,n,r,s,i,o=t[0]/360,a=t[1]/100,c=t[2]/100;if(0===a)return[i=255*c,i,i];e=2*c-(n=c<.5?c*(1+a):c+a-c*a),s=[0,0,0];for(var u=0;u<3;u++)(r=o+1/3*-(u-1))<0&&r++,r>1&&r--,i=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,s[u]=255*i;return s},zt.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,s=n,i=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,s*=i<=1?i:2-i,[e,100*(0===r?2*s/(i+s):2*n/(r+n)),100*((r+n)/2)]},zt.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,s=Math.floor(e)%6,i=e-Math.floor(e),o=255*r*(1-n),a=255*r*(1-n*i),c=255*r*(1-n*(1-i));switch(r*=255,s){case 0:return[r,c,o];case 1:return[a,r,o];case 2:return[o,r,c];case 3:return[o,a,r];case 4:return[c,o,r];case 5:return[r,o,a]}},zt.hsv.hsl=function(t){var e,n,r,s=t[0],i=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-i)*o,n=i*a,[s,100*(n=(n/=(e=(2-i)*a)<=1?e:2-e)||0),100*(r/=2)]},zt.hwb.rgb=function(t){var e,n,r,s,i,o,a,c=t[0]/360,u=t[1]/100,f=t[2]/100,h=u+f;switch(h>1&&(u/=h,f/=h),r=6*c-(e=Math.floor(6*c)),0!=(1&e)&&(r=1-r),s=u+r*((n=1-f)-u),e){default:case 6:case 0:i=n,o=s,a=u;break;case 1:i=s,o=n,a=u;break;case 2:i=u,o=n,a=s;break;case 3:i=u,o=s,a=n;break;case 4:i=s,o=u,a=n;break;case 5:i=n,o=u,a=s}return[255*i,255*o,255*a]},zt.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,s=t[3]/100;return[255*(1-Math.min(1,e*(1-s)+s)),255*(1-Math.min(1,n*(1-s)+s)),255*(1-Math.min(1,r*(1-s)+s))]},zt.xyz.rgb=function(t){var e,n,r,s=t[0]/100,i=t[1]/100,o=t[2]/100;return n=-.9689*s+1.8758*i+.0415*o,r=.0557*s+-.204*i+1.057*o,e=(e=3.2406*s+-1.5372*i+-.4986*o)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},zt.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},zt.lab.xyz=function(t){var e,n,r,s=t[0];e=t[1]/500+(n=(s+16)/116),r=n-t[2]/200;var i=Math.pow(n,3),o=Math.pow(e,3),a=Math.pow(r,3);return n=i>.008856?i:(n-16/116)/7.787,e=o>.008856?o:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},zt.lab.lch=function(t){var e,n=t[0],r=t[1],s=t[2];return(e=360*Math.atan2(s,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+s*s),e]},zt.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},zt.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],s=1 in arguments?arguments[1]:zt.rgb.hsv(t)[2];if(0===(s=Math.round(s/50)))return 30;var i=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===s&&(i+=60),i},zt.hsv.ansi16=function(t){return zt.rgb.ansi16(zt.hsv.rgb(t),t[2])},zt.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},zt.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},zt.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},zt.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},zt.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},zt.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,s=t[2]/255,i=Math.max(Math.max(n,r),s),o=Math.min(Math.min(n,r),s),a=i-o;return e=a<=0?0:i===n?(r-s)/a%6:i===r?2+(s-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?o/(1-a):0)]},zt.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,s=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(s=(n-.5*r)/(1-r)),[t[0],100*r,100*s]},zt.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,s=0;return r<1&&(s=(n-r)/(1-r)),[t[0],100*r,100*s]},zt.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var s,i=[0,0,0],o=e%1*6,a=o%1,c=1-a;switch(Math.floor(o)){case 0:i[0]=1,i[1]=a,i[2]=0;break;case 1:i[0]=c,i[1]=1,i[2]=0;break;case 2:i[0]=0,i[1]=1,i[2]=a;break;case 3:i[0]=0,i[1]=c,i[2]=1;break;case 4:i[0]=a,i[1]=0,i[2]=1;break;default:i[0]=1,i[1]=0,i[2]=c}return s=(1-n)*r,[255*(n*i[0]+s),255*(n*i[1]+s),255*(n*i[2]+s)]},zt.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},zt.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},zt.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},zt.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,s=0;return r<1&&(s=(n-r)/(1-r)),[t[0],100*r,100*s]},zt.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},zt.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},zt.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},zt.gray.hsl=zt.gray.hsv=function(t){return[0,0,t[0]]},zt.gray.hwb=function(t){return[0,100,t[0]]},zt.gray.cmyk=function(t){return[0,0,0,t[0]]},zt.gray.lab=function(t){return[t[0],0,0]},zt.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},zt.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var Xt=Dt.exports;function Ht(t){var e=function(){for(var t={},e=Object.keys(Xt),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),s=Object.keys(Xt[r]),i=s.length,o=0;o<i;o++){var a=s[o],c=e[a];-1===c.distance&&(c.distance=e[r].distance+1,c.parent=r,n.unshift(a))}return e}function Jt(t,e){return function(n){return e(t(n))}}function Kt(t,e){for(var n=[e[t].parent,t],r=Xt[e[t].parent][t],s=e[t].parent;e[s].parent;)n.unshift(e[s].parent),r=Jt(Xt[e[s].parent][s],r),s=e[s].parent;return r.conversion=n,r}var Yt=Dt.exports,Qt=function(t){for(var e=Ht(t),n={},r=Object.keys(e),s=r.length,i=0;i<s;i++){var o=r[i];null!==e[o].parent&&(n[o]=Kt(o,e))}return n},Wt={};Object.keys(Yt).forEach((function(t){Wt[t]={},Object.defineProperty(Wt[t],"channels",{value:Yt[t].channels}),Object.defineProperty(Wt[t],"labels",{value:Yt[t].labels});var e=Qt(t);Object.keys(e).forEach((function(n){var r=e[n];Wt[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,s=0;s<r;s++)n[s]=Math.round(n[s]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),Wt[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var Zt=Wt,te=Tt.exports,ee=Zt,ne=[].slice,re=["keyword","gray","hex"],se={};Object.keys(ee).forEach((function(t){se[ne.call(ee[t].labels).sort().join("")]=t}));var ie={};function oe(t,e){if(!(this instanceof oe))return new oe(t,e);if(e&&e in re&&(e=null),e&&!(e in ee))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof oe)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var s=te.get(t);if(null===s)throw new Error("Unable to parse color from string: "+t);this.model=s.model,r=ee[this.model].channels,this.color=s.value.slice(0,r),this.valpha="number"==typeof s.value[r]?s.value[r]:1}else if(t.length){this.model=e||"rgb",r=ee[this.model].channels;var i=ne.call(t,0,r);this.color=fe(i,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in se))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=se[a];var c=ee[this.model].labels,u=[];for(n=0;n<c.length;n++)u.push(t[c[n]]);this.color=fe(u)}if(ie[this.model])for(r=ee[this.model].channels,n=0;n<r;n++){var f=ie[this.model][n];f&&(this.color[n]=f(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function ae(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(ie[t]||(ie[t]=[]))[e]=n})),t=t[0],function(r){var s;return arguments.length?(n&&(r=n(r)),(s=this[t]()).color[e]=r,s):(s=this[t]().color[e],n&&(s=n(s)),s)}}function ce(t){return function(e){return Math.max(0,Math.min(t,e))}}function ue(t){return Array.isArray(t)?t:[t]}function fe(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}function he(t){return null==t}function le(t){return"object"==typeof t&&!!t}function de(t){return t/Math.PI*180}function ye(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}oe.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in te.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return te.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return te.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=ee[this.model].channels,n=ee[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new oe(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new oe(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:ae("rgb",0,ce(255)),green:ae("rgb",1,ce(255)),blue:ae("rgb",2,ce(255)),hue:ae(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:ae("hsl",1,ce(100)),lightness:ae("hsl",2,ce(100)),saturationv:ae("hsv",1,ce(100)),value:ae("hsv",2,ce(100)),chroma:ae("hcg",1,ce(100)),gray:ae("hcg",2,ce(100)),white:ae("hwb",1,ce(100)),wblack:ae("hwb",2,ce(100)),cyan:ae("cmyk",0,ce(100)),magenta:ae("cmyk",1,ce(100)),yellow:ae("cmyk",2,ce(100)),black:ae("cmyk",3,ce(100)),x:ae("xyz",0,ce(100)),y:ae("xyz",1,ce(100)),z:ae("xyz",2,ce(100)),l:ae("lab",0,ce(100)),a:ae("lab",1),b:ae("lab",2),keyword:function(t){return arguments.length?new oe(t):ee[this.model].keyword(this.color)},hex:function(t){return arguments.length?new oe(t):te.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return oe.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error(\'Argument to "mix" was not a Color instance, but rather an instance of \'+typeof t);var n=t.rgb(),r=this.rgb(),s=void 0===e?.5:e,i=2*s-1,o=n.alpha()-r.alpha(),a=((i*o==-1?i:(i+o)/(1+i*o))+1)/2,c=1-a;return oe.rgb(a*n.red()+c*r.red(),a*n.green()+c*r.green(),a*n.blue()+c*r.blue(),n.alpha()*s+r.alpha()*(1-s))}},Object.keys(ee).forEach((function(t){if(-1===re.indexOf(t)){var e=ee[t].channels;oe.prototype[t]=function(){if(this.model===t)return new oe(this);if(arguments.length)return new oe(arguments,t);var n="number"==typeof arguments[e]?e:this.valpha;return new oe(ue(ee[this.model][t].raw(this.color)).concat(n),t)},oe[t]=function(n){return"number"==typeof n&&(n=fe(ne.call(arguments),e)),new oe(n,t)}}}));const me=[1,1,1,1,2,2,3,0];function be(t){const e=t.length;let n="";for(let r=0;r<e;){let s=t[r++];if(128&s){let n=me[s>>3&7];if(!(64&s)||!n||r+n>e)return null;for(s&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;s=s<<6|63&e}}n+=String.fromCharCode(s)}return n}new Array(3),new Array(3);const pe=[1/6378137,1/6378137,1/6356752.314245179],we=[1/40680631590769,1/40680631590769,1/40408299984661.445],ge=new Array(3),ve=new Array(3),Me=new Array(3);function Te(t,e){const n=we,r=function(t,e,n,r,s){const i=e[0],o=e[1],a=e[2],c=n[0],u=n[1],f=n[2],h=i*i*c*c,l=o*o*u*u,d=a*a*f*f,y=h+l+d,b=Math.sqrt(1/y),p=m(Ae,e,b);if(y<s)return isFinite(b)?p:void 0;const w=r[0],g=r[1],v=r[2],M=_e;M[0]=p[0]*w*2,M[1]=p[1]*g*2,M[2]=p[2]*v*2;let T,A,_,O,x,S,I,k,E,C,U,F=(1-b)*Oe(e)/(.5*Oe(M)),N=0;do{F-=N,_=1/(1+F*w),O=1/(1+F*g),x=1/(1+F*v),S=_*_,I=O*O,k=x*x,E=S*_,C=I*O,U=k*x,T=h*S+l*I+d*k-1,A=h*E*w+l*C*g+d*U*v;N=T/(-2*A)}while(Math.abs(T)>1e-12);return t[0]=i*_,t[1]=o*O,t[2]=a*x,t}(ge,e,pe,n,.1);let s=M(ve,r,n);s=function(t,e){const n=e[0],r=e[1],s=e[2];let i=n*n+r*r+s*s;i>0&&(i=Math.sqrt(i),t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i);return t}(s,s);const i=v(Me,e,r),o=Math.atan2(s[1],s[0]),a=Math.asin(s[2]),c=ye(p(i,e))*Oe(i);return t[0]=de(o),t[1]=de(a),t[2]=c,t}const Ae=new Array(3),_e=new Array(3);function Oe(t){return u(t)}function xe(t,e,n,r){n=n||0,r=r||n;const s=Math.abs(t-e);return s<=r||s<=n*Math.max(Math.abs(t),Math.abs(e))}function Se(t,e){let n="";for(let r=0;r<4;r++){const s=t.getUint8(e+r);n+=String.fromCharCode(s)}return n}const Ie="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function ke(t,e,n){const r=new Uint8Array(t,e,n);return Ie?JSON.parse(Ie.decode(r)):JSON.parse(be(r))}function Ee(t,e,n){const r=new Uint8Array(t,e,n);return Ie?JSON.parse(Ie.decode(r)):JSON.parse(be(r))}function Ce(t,e,n){return{offset:e,byteLength:n}}function Ue(t,e,n,r){const{byteOffset:s,componentType:i,type:o}=t,{ctor:a,type:c}=function(t){return Pe[t]}(i||"UNSIGNED_SHORT"),u=function(t){if(!t)return 1;return Ne[t]}(o);return{byteStride:0,byteOffset:s+n,itemSize:u,count:r*u,componentType:c,array:new a(e,n+s,r*u)}}function Fe(t,e,n,r){const s=Ue(t,e,n,r);return s.array.buffer.byteLength!==e.byteLength&&(s.array=s.array.slice()),s}const Ne={"SCALAR":1,"VEC2":2,"VEC3":3,"VEC4":4};const Pe={"BYTE":{ctor:Int8Array,type:5120,name:"Int8Array"},"UNSIGNED_BYTE":{ctor:Uint8Array,type:5121,name:"Uint8Array"},"SHORT":{ctor:Int16Array,type:5122,name:"Int16Array"},"UNSIGNED_SHORT":{ctor:Uint16Array,type:5123,name:"Uint16Array"},"INT":{ctor:Int32Array,type:5124,name:"Int32Array"},"UNSIGNED_INT":{ctor:Uint32Array,type:5125,name:"Uint32Array"},"FLOAT":{ctor:Float32Array,type:5126,name:"Float32Array"},"DOUBLE":{ctor:Float64Array,type:5126,name:"Float64Array"}};function Be(t){for(const e in Pe)if(t===Pe[e].ctor)return Pe[e].type;throw new Error("unrecognized ctor:"+t)}function De(t,e,n,r){const s=t,i=e.length/3;for(let t=0;t<i;t++)s[3*t]=e[3*t]/65535*r[0]+n[0],s[3*t+1]=e[3*t+1]/65535*r[1]+n[1],s[3*t+2]=e[3*t+2]/65535*r[2]+n[2];return s}function Re(t,e,n){const r=t.getUint32(12,!0),s=t.getUint32(16,!0),i=t.getUint32(20,!0),o=t.getUint32(24,!0),a=t.buffer;let c,u={},f={},h=null;r>0&&(u=ke(a,e,r),e+=r),s>0&&(c=function(t,e,n){return{offset:e,byteLength:n}}(0,e,s),e+=s),i>0&&(f=Ee(a,e,i),e+=i);const l=Ce(0,e,o);return h=a.slice(l.offset,l.offset+l.byteLength),n.push(h),{featureTable:u,featureTableBin:c,batchTable:f,batchTableBin:h}}const Le={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},je={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},ze={},Ve={east:[],north:[],up:[],west:[],south:[],down:[]};let qe=[],Ge=[],$e=[];const Xe=[0,0,0];!function(t,e){const n=Le[t][e];let r;const s=t+e;ze[s]?r=ze[s]:(r=function(r,s,i){if(function(t,e){var n=t[0],r=t[1],s=t[2],i=e[0],o=e[1],a=e[2];return Math.abs(n-i)<=1e-6*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(r-o)<=1e-6*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=1e-6*Math.max(1,Math.abs(s),Math.abs(a))}(r,Xe))h(qe,je[t]),h(Ge,je[e]),h($e,je[n]);else if(xe(r[0],0,1e-14)&&xe(r[1],0,1e-14)){const s=ye(r[2]);h(qe,je[t]),"east"!==t&&"west"!==t&&m(qe,qe,s),h(Ge,je[e]),"east"!==e&&"west"!==e&&m(Ge,Ge,s),h($e,je[n]),"east"!==n&&"west"!==n&&m($e,$e,s)}else{!function(t,e){y(e,t,we),b(e,e)}(r,Ve.up);const s=Ve.up,i=Ve.east;i[0]=-r[1],i[1]=r[0],i[2]=0,b(Ve.east,i),w(Ve.north,s,i),m(Ve.down,Ve.up,-1),m(Ve.west,Ve.east,-1),m(Ve.south,Ve.north,-1),qe=Ve[t],Ge=Ve[e],$e=Ve[n]}return i[0]=qe[0],i[1]=qe[1],i[2]=qe[2],i[3]=0,i[4]=Ge[0],i[5]=Ge[1],i[6]=Ge[2],i[7]=0,i[8]=$e[0],i[9]=$e[1],i[10]=$e[2],i[11]=0,i[12]=r[0],i[13]=r[1],i[14]=r[2],i[15]=1,i},ze[s]=r)}("east","north");const He={5120:Int8Array,5122:Int16Array,5124:Int32Array,5121:Uint8Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array};function Je(t){for(const e in He)if(t===He[e])return+e;throw new Error("unrecognized ctor:"+t)}\n/*!\n   * @maptalks/gl v0.97.4\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.com\n   */const Ke=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},Ye=Ke(),Qe=Ye.gl_trans__coders=Ye.gl_trans__coders||{};Qe.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),s=Ye.gl_trans__coders=Ye.gl_trans__coders||{};let i=`${r}\\n    const _____getGlobal = ${Ke.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(i+=\'tran_____scoders["\'+t+\'"] =\'+s[t].toString()+"\\n;");return i+="\\n"+e.substring(r.length),i},Qe.registerTranscoder=function(t,e){Qe[t]=e},Qe.getTranscoder=function(t){return Qe[t]};let We=null;function Ze(){return We||(We={"image/crn":Qe.crn&&Qe.crn(),"image/ktx2":Qe.ktx2&&Qe.ktx2(),"image/cttf":Qe.ktx2&&Qe.ktx2(),"draco":Qe.draco&&Qe.draco()}),We}class tn{constructor(t,e,n){this.s=t,this.nt=e||lt,this.i=n,this.rt=Ze()}static createEmptyB3DM(){return{featureTable:null,batchTable:null,gltf:{}}}load(t,e,n=0,r=0,s){return e?(r||(r=e.byteLength),this.st(t,e,n,r,s)):H.getArrayBuffer(t,{}).then(e=>{const s=e.data;return r||(r=s.byteLength),this.st(t,s,n,r)})}st(t,e,n,r,s){const i=s&&s.maxTextureSize,o=this.it(e,n,r,t);if(o.error)return Promise.resolve(o);const a=t.substring(0,t.lastIndexOf("/")),c=new this.nt(a,o.glb,{transferable:!0,requestImage:this.s,decoders:this.rt,supportedFormats:this.i,maxTextureSize:i});return c.load({skipAttributeTransform:!1}).then(e=>{e.url=`${t}-${n}-${r}`;const s=c.transferables;for(let t=0;t<o.transferables.length;t++)s.indexOf(o.transferables[t])<0&&s.push(o.transferables[t]);return{magic:"b3dm",count:o.count,transferables:s,featureTable:o.featureTable,batchTable:o.batchTable,batchTableBin:o.batchTableBin,gltf:e}})}it(t,e,n,r){const s=new DataView(t,e,n),i=s.getUint32(4,!0);if(1!==i){const t="Unsupported b3dm version: "+i+", url:"+r;return console.warn(t),{error:t}}if(s.getUint32(8,!0)!==s.byteLength){const t="Length in b3dm header is inconsistent with b3dm\'s byte length, url: "+r;return console.warn(t),{error:t}}let o,a=s.getUint32(12,!0),c=s.getUint32(16,!0),u=s.getUint32(20,!0),f=s.getUint32(24,!0),h=28+e;u>=570425344?(h-=8,o=a,u=c,f=0,a=0,c=0):f>=570425344&&(h-=4,o=u,u=a,f=c,a=0,c=0);const l=[t];let d,y,m;if(a>0?(d=ke(t,h,a),h+=a,o=d.BATCH_LENGTH):d={"BATCH_LENGTH":o},c>0&&(h+=c),u>0&&(y=Ee(t,h,u),h+=u,f>0)){const e=Ce(0,h,f);m=t.slice(e.offset,e.offset+e.byteLength),h+=f,l.push(m)}const b=d.BATCH_LENGTH,p={};if(d&&d.BATCH_ID){p.BATCH_ID=Fe(d.BATCH_ID,t,(void 0).offset,b);const e=p.BATCH_ID.array&&p.BATCH_ID.array.buffer;e&&l.indexOf(e)<0&&l.push(e)}return{count:o,transferables:l,featureTable:d,batchTable:y,batchTableBin:m,b3dm:p,glb:{buffer:t,byteOffset:h,byteLength:s.byteLength+s.byteOffset-h}}}ot(){return null}}class en{constructor(t,e,n,r){this.s=t,this.nt=e||lt,this.i=n,this.rt=Ze(),this.ct=r}load(t,e,n=0,r=0,s){return e?(r||(r=e.byteLength),this.st(t,e,n,r,s)):H.getArrayBuffer(t,{}).then(e=>{const s=e.data;return r||(r=s.byteLength),this.st(t,s,n,r)})}st(t,e,n,r,s){return this.ut(t,e,n,r,s).then(({gltf:s,transferables:i})=>{const o=this.ft(e,n,r,t);if(o.error)return Promise.resolve(o);for(let t=0;t<i.length;t++)-1===o.transferables.indexOf(i[t])&&o.transferables.push(i[t]);return delete s.transferables,Promise.resolve({magic:"i3dm",count:o.count,transferables:o.transferables,featureTable:o.featureTable,batchTable:o.batchTable,batchTableBin:o.batchTableBin,i3dm:o.i3dm,gltf:s})})}ut(t,e,n,r,s){const i=s&&s.maxTextureSize,o={transferable:!0,requestImage:this.s,decoders:this.rt,supportedFormats:this.i,maxTextureSize:i},a=new DataView(e,n,r),c=32+a.getUint32(12,!0)+a.getUint32(16,!0)+a.getUint32(20,!0)+a.getUint32(24,!0);if(0===a.getUint32(28,!0)){let r=be(new Uint8Array(e,c+n,a.byteLength-c));-1==r.indexOf("://")&&(r=t.substring(0,t.lastIndexOf("/"))+"/"+r);return r.indexOf(".glb")>0?H.getArrayBuffer(r,{}).then(t=>this.ht(r,{buffer:t.data,byteOffset:0},o)):H.getJSON(r,{}).then(t=>this.ht(r,t,o))}{const r={buffer:e,byteOffset:c+n,byteLength:a.byteLength-c};return this.ht(t,r,o)}}ht(t,e,n){const r=t.substring(0,t.lastIndexOf("/")),s=new this.nt(r,e,n);return s.load({skipAttributeTransform:!0}).then(n=>{let r=0,i=0;return e.buffer&&(r=e.byteOffset||0,i=e.byteLength||0),n.url=`${t}-${r}-${i}`,{transferables:s.transferables,gltf:n}})}ft(t,e,n,r){const s=new DataView(t,e,n),i=s.getUint32(4,!0);if(1!==i){const t="Unsupported pnts version: "+i+", url:"+r;return console.warn(t),{error:t}}if(s.getUint32(8,!0)!==s.byteLength){const t="Length in pnts header is inconsistent with pnts\'s byte length, url: "+r;return console.warn(t),{error:t}}const o=[t],{featureTable:a,featureTableBin:c,batchTable:u,batchTableBin:f}=Re(s,32+e,o),h={},l=a.INSTANCES_LENGTH;if(a.POSITION){const{byteOffset:e}=a.POSITION;h.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:new Float32Array(t,e+c.offset,3*l).slice()},o.push(h.POSITION.array.buffer)}else if(a.POSITION_QUANTIZED){const e=a.QUANTIZED_VOLUME_OFFSET,n=a.QUANTIZED_VOLUME_SCALE,{byteOffset:r}=a.POSITION_QUANTIZED;h.POSITION={byteStride:12,byteOffset:0,itemSize:3,count:l,componentType:5126,array:this.lt(new Uint16Array(t,r+c.offset,3*l),e,n)},o.push(h.POSITION.array.buffer)}if(a.BATCH_ID){h.BATCH_ID=Fe(a.BATCH_ID,t,c.offset,l);const e=h.BATCH_ID.array&&h.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}if(a.NORMAL_UP){let{byteOffset:e}=a.NORMAL_UP;h.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:new Float32Array(t,e+c.offset,3*l).slice()},o.push(h.NORMAL_UP.array.buffer),e=a.NORMAL_RIGHT.byteOffset,h.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:new Float32Array(t,e+c.offset,3*l).slice()},o.push(h.NORMAL_RIGHT.array.buffer)}else if(a.NORMAL_UP_OCT32P){let{byteOffset:e}=a.NORMAL_UP_OCT32P;h.NORMAL_UP={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:this.dt(new Uint16Array(t,e+c.offset,2*l))},o.push(h.NORMAL_UP.array.buffer),e=a.NORMAL_RIGHT_OCT32P.byteOffset,h.NORMAL_RIGHT={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:this.dt(new Uint16Array(t,e+c.offset,2*l))},o.push(h.NORMAL_RIGHT.array.buffer)}if(a.SCALE){const{byteOffset:e}=a.SCALE;h.SCALE={byteStride:0,byteOffset:0,itemSize:1,count:l,componentType:5126,array:new Float32Array(t,e+c.offset,l).slice()},o.push(h.SCALE.array.buffer)}else if(a.SCALE_NON_UNIFORM){const{byteOffset:e}=a.SCALE_NON_UNIFORM;h.SCALE_NON_UNIFORM={byteStride:0,byteOffset:0,itemSize:3,count:l,componentType:5126,array:new Float32Array(t,e+c.offset,3*l).slice()},o.push(h.SCALE_NON_UNIFORM.array.buffer)}return{count:l,batchTable:u,batchTableBin:f,featureTable:a,i3dm:h,transferables:o}}dt(t){const e=t.length/2,n=new Float32Array(3*e),r=[];for(let s=0;s<e;s++)nn(r,t[2*s],t[2*s+1],65535),n[3*s]=r[0],n[3*s+1]=r[1],n[3*s+2]=r[2];return n}lt(t,e,n){return De(new Float32Array(t.length),t,e,n)}ot(){return null}}function nn(t,e,n,r){if(t[0]=rn(e,r),t[1]=rn(n,r),t[2]=1-(Math.abs(t[0])+Math.abs(t[1])),t[2]<0){const e=t[0];t[0]=(1-Math.abs(t[1]))*sn(e),t[1]=(1-Math.abs(e))*sn(t[1])}return b(t,t)}function rn(t,e){return function(t,e,n){return t<e?e:t>n?n:t}(t,0,e=function(t,e){if(null!=t)return t;return e}(e,255))/e*2-1}function sn(t){return t<0?-1:1}class on{constructor(){}load(t,e,n=0,r=0){return e?(r||(r=e.byteLength),this.st(t,e,n,r)):H.getArrayBuffer(t,{}).then(e=>{const s=e.data;return r||(r=s.byteLength),this.st(t,s,n,r)})}st(t,e,n,r){return this.yt(e,n,r,t).then(t=>t.error?t:{magic:"pnts",count:t.count,transferables:t.transferables,featureTable:t.featureTable,batchTable:t.batchTable,batchTableBin:t.batchTableBin,pnts:t.pnts})}yt(t,e,n,r){const s=new DataView(t,e,n),i=s.getUint32(4,!0);if(1!==i){const t="Unsupported pnts version: "+i+", url:"+r;return console.warn(t),{error:t}}if(s.getUint32(8,!0)!==s.byteLength){const t="Length in pnts header is inconsistent with pnts\'s byte length, url: "+r;return console.warn(t),{error:t}}const o=[t],{featureTable:a,featureTableBin:c,batchTable:u,batchTableBin:f}=Re(s,e+28,o),h=a.QUANTIZED_VOLUME_OFFSET,l=a.QUANTIZED_VOLUME_SCALE,d=a.POINTS_LENGTH;let y,m={};if(a.extensions&&a.extensions["3DTILES_draco_point_compression"]){m=a.extensions["3DTILES_draco_point_compression"],y=new DataView(t,m.byteOffset+c.offset,m.byteLength);const e={attributes:m.properties,useUniqueIDs:!1};return this.bt||(this.bt=Ze().draco),this.bt(y,e).then(e=>{const n=e.attributes;!a.POSITION&&!a.POSITION_QUANTIZED||n.POSITION||n.POSITION_QUANTIZED||(n.POSITION=a.POSITION,n.POSITION_QUANTIZED=a.POSITION_QUANTIZED),!(a.RGB||a.RGBA||a.RGB565)||n.RGB||n.RGBA||n.RGB565||(n.RGB=a.RGB,n.RGBA=a.RGBA,n.RGB565=a.RGB565),!a.NORMAL&&!a.NORMAL_OCT16P||n.NORMAL||n.NORMAL_OCT16P||(n.NORMAL=a.NORMAL,n.NORMAL_OCT16P=a.NORMAL_OCT16P);const r=this.pt(t,e.attributes,c.offset,d,o,h,l);if(e.attributes.BATCH_ID){const t=e.attributes.BATCH_ID.array;r.BATCH_ID={byteStride:0,byteOffset:0,itemSize:1,count:t.length,componentType:Be(t.constructor),array:t},o.push(t.buffer)}else if(a.BATCH_ID||Object.keys(u).length){a.BATCH_ID?r.BATCH_ID=Fe(a.BATCH_ID,t,c.offset,d):r.BATCH_ID=an(d);const e=r.BATCH_ID.array&&r.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}return{count:d,batchTable:u,batchTableBin:f,featureTable:a,pnts:r,transferables:o}})}const b=this.pt(t,a,c.offset,d,o,h,l);if(a.BATCH_ID||Object.keys(u).length){a.BATCH_ID?b.BATCH_ID=Fe(a.BATCH_ID,t,c.offset,d):b.BATCH_ID=an(d);const e=b.BATCH_ID.array&&b.BATCH_ID.array.buffer;e&&o.indexOf(e)<0&&o.push(e)}return Promise.resolve({count:d,batchTable:u,batchTableBin:f,featureTable:a,pnts:b,transferables:o})}pt(t,e,n,r,s,i,o){const a={};if(e.POSITION){let{byteOffset:i,array:o}=e.POSITION;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+3*r*4);o=new Float32Array(e)}a.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:o},s.push(o.buffer)}else if(e.POSITION_QUANTIZED){let{byteOffset:c}=e.POSITION_QUANTIZED;const{array:u}=e.POSITION_QUANTIZED;c=c||0;const f=u?0:n;a.POSITION={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:this.lt(u||new Uint16Array(t,c+f,3*r),i,o)},s.push(a.POSITION.array.buffer)}if(e.RGBA){let{byteOffset:i,array:o}=e.RGBA;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+4*r);o=new Uint8Array(e)}a.RGBA={byteStride:0,byteOffset:0,itemSize:4,count:r,componentType:5121,array:o},s.push(o.buffer)}else if(e.RGB){let{byteOffset:i,array:o}=e.RGB;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+3*r);o=new Uint8Array(e)}a.RGB={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5121,array:o},s.push(o.buffer)}else if(e.RGB565){let{byteOffset:i,array:o}=e.RGB565;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+2*r);o=new Uint16Array(e)}a.RGB565={byteStride:0,byteOffset:0,itemSize:1,count:r,componentType:5123,array:o},s.push(o.buffer)}if(e.NORMAL){let{byteOffset:i,array:o}=e.NORMAL;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+3*r*4);o=new Float32Array(e)}a.NORMAL={byteStride:0,byteOffset:0,itemSize:3,count:r,componentType:5126,array:o},s.push(o.buffer)}else if(e.NORMAL_OCT16P){let{byteOffset:i,array:o}=e.NORMAL_OCT16P;i=i||0;const c=o?0:n;if(!o){const e=t.slice(i+c,i+c+2*r);o=new Uint8Array(e)}a.NORMAL_OCT16P={byteStride:0,byteOffset:0,itemSize:2,count:r,componentType:5121,array:o},s.push(o.buffer)}return a}lt(t,e,n){return De(new Float32Array(t.length),t,e,n)}ot(){return null}}function an(t){const e=(n=t)<256?Uint8Array:n<65536?Uint16Array:Uint32Array;var n;const r=new e(t);for(let e=0;e<t;e++)r[e]=e;return{byteStride:0,byteOffset:0,itemSize:1,count:t,componentType:Be(e),array:r}}class cn{constructor(t,e,n,r){this.i=n,this.s=t,this.nt=e||lt,this.ct=r}load(t,e,n=0,r=0,s){return e?this.st(t,e,n,r,s):H.getArrayBuffer(t,{}).then(e=>{const s=e.data;return this.st(t,s,n,r)})}st(t,e,n,r,s){r||(r=e.byteLength);const i=this.wt(e,t,n,r),o=[];for(let n=0;n<i.length;n++){let r;if("b3dm"===i[n].magic)r=new tn(this.s,this.nt,this.i);else if("i3dm"===i[n].magic)r=new en(this.s,this.nt,this.i,this.ct);else if("pnts"===i[n].magic)r=new on;else{if("cmpt"!==i[n].magic){console.warn("Unsupported magic in CMPT tile:",i[n].magic);continue}r=new cn(this.s,this.nt,this.i,this.ct)}o.push(r.load(t,e,i[n].offset,i[n].byteLength,s).then(t=>t))}return Promise.all(o).then(t=>({magic:"cmpt",tiles:t}))}wt(t,e,n,r){const s=new DataView(t,n,r),i=s.getUint32(4,!0);if(1!==i){const t="Unsupported cmpt version: "+i+", url:"+e;return console.warn(t),{error:t}}if(16===s.byteLength)return[];const o=[],a=s.getUint32(12,!0);let c=16;for(let e=0;e<a;e++){const e=Se(s,c),r=s.getUint32(c+8,!0);o.push({magic:e,buffer:t,offset:c+n,byteLength:r}),c+=r}return o}}function un(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,s=r.length;n<s;n++){const s=[];bn(r[n],s,t,e)}}}const fn=[],hn=[],ln=[],dn=[0,0,0],yn=x([]),mn=[1,1,1];function bn(t,e,n,a){const c=e.slice(0);if(t.matrix)c.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=s(fn,t.translation||dn),n=o(hn,t.rotation||yn),a=i(ln,t.scale||mn);r(a,n,a);const u=r([],e,a);c.push(u)}if(t.children&&t.children.length)for(let e=0,r=t.children.length;e<r;e++)bn(t.children[e],c,n,a);if(void 0!==t.mesh){const e=t.mesh,r=n.meshes[e];if(r){const t=c.slice(0),s=r.primitives;for(let r=0,i=s.length;r<i;r++){const i=s[r];i&&(i.matrices=t,a(i,e,r,n))}}}}function pn(t,e){let{byteOffset:n,byteStride:r,count:s}=t;const{componentType:i,itemSize:o}=t,a=t.array.buffer,c=i?lt.getTypedArrayCtor(i):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,s=s||t.array.length/o,(!r||r===o*c.BYTES_PER_ELEMENT)&&n%c.BYTES_PER_ELEMENT==0){const t=new c(a,n,s*o);for(let r=0;r<s*o;r+=o){e(new c(t.buffer,n+r*c.BYTES_PER_ELEMENT,o),r/o)}return}const u=new Uint8Array(o*c.BYTES_PER_ELEMENT);r||(r=o*c.BYTES_PER_ELEMENT);for(let t=0;t<s;t++){const s=new Uint8Array(a,r*t+n,o*c.BYTES_PER_ELEMENT);u.set(s);e(new c(u.buffer),t),s.set(u)}}var wn=An("DXT1"),gn=An("DXT3"),vn=An("DXT5"),Mn=An("DX10"),Tn=function(t){var e,n,r=new Int32Array(t,0,31);if(542327876!==r[0])throw new Error("Invalid magic number in DDS header");if(4&!r[20])throw new Error("Unsupported format, must contain a FourCC code");var s=r[21];switch(s){case wn:e=8,n="dxt1";break;case gn:e=16,n="dxt3";break;case vn:e=16,n="dxt5";break;case 116:n="rgba32f";break;case Mn:var i=new Uint32Array(t.slice(128,148));n=i[0];var o=i[1];if(i[2],i[3],i[4],3!==o||2!==n)throw new Error("Unsupported DX10 texture format "+n);n="rgba32f";break;default:throw new Error("Unsupported FourCC code: "+(a=s,String.fromCharCode(255&a,a>>8&255,a>>16&255,a>>24&255)))}var a;var c=r[2],u=1;131072&c&&(u=Math.max(1,r[7]));var f=!1;512&r[28]&&(f=!0);var h,l=r[4],d=r[3],y=r[1]+4,m=l,b=d,p=[];s===Mn&&(y+=20);if(f)for(var w=0;w<6;w++){if("rgba32f"!==n)throw new Error("Only RGBA32f cubemaps are supported");l=m,d=b;for(var g=Math.log(l)/Math.log(2)+1,v=0;v<g;v++)h=l*d*16,p.push({offset:y,length:h,shape:[l,d]}),v<u&&(y+=h),l=Math.floor(l/2),d=Math.floor(d/2)}else for(v=0;v<u;v++)h=Math.max(4,l)/4*Math.max(4,d)/4*e,p.push({offset:y,length:h,shape:[l,d]}),y+=h,l=Math.floor(l/2),d=Math.floor(d/2);return{shape:[m,b],images:p,format:n,flags:c,cubemap:f}};function An(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}var _n=Math.abs,On=Math.sin,xn=Math.cos,Sn=Math.tan,In=Math.atan,kn=Math.atan2,En=Math.sqrt,Cn=Math.log,Un=Math.hypot,Fn=Math.sinh,Nn=Math.cosh;function Pn(t){var e,n,r,s,i,o,a=[],c=[],u=[],f=[];function h(t,e){for(var n,r=2*xn(2*e),s=t.length-1,i=t[s],o=0;--s>=0;)n=r*i-o+t[s],o=i,i=n;return e+n*On(2*e)}function l(t,e,n){for(var r,s,i=On(e),o=xn(e),a=Fn(n),c=Nn(n),u=2*o*c,f=-2*i*a,h=t.length-1,l=t[h],d=0,y=0,m=0;--h>=0;)r=y,s=d,l=u*(y=l)-r-f*(d=m)+t[h],m=f*y-s+u*d;return[(u=i*c)*l-(f=o*a)*m,u*m+f*l]}t.es,i=s=(r=t.es/(1+En(1-t.es)))/(2-r),a[0]=s*(2+s*(-2/3+s*(s*(116/45+s*(26/45+s*(-2854/675)))-2))),c[0]=s*(s*(2/3+s*(4/3+s*(-82/45+s*(32/45+s*(4642/4725)))))-2),i*=s,a[1]=i*(7/3+s*(s*(-227/45+s*(2704/315+s*(2323/945)))-1.6)),c[1]=i*(5/3+s*(-16/15+s*(-13/9+s*(904/315+s*(-1522/945))))),i*=s,a[2]=i*(56/15+s*(-136/35+s*(-1262/105+s*(73814/2835)))),c[2]=i*(-26/15+s*(34/21+s*(1.6+s*(-12686/2835)))),i*=s,a[3]=i*(4279/630+s*(-332/35+s*(-399572/14175))),c[3]=i*(1237/630+s*(s*(-24832/14175)-2.4)),i*=s,a[4]=i*(4174/315+s*(-144838/6237)),c[4]=i*(-734/315+s*(109598/31185)),i*=s,a[5]=i*(601676/22275),c[5]=i*(444337/155925),i=s*s,e=t.k0/(1+s)*(1+i*(1/4+i*(1/64+i/256))),u[0]=s*(s*(2/3+s*(-37/96+s*(1/360+s*(81/512+s*(-96199/604800)))))-.5),f[0]=s*(.5+s*(-2/3+s*(5/16+s*(41/180+s*(-127/288+s*(7891/37800)))))),u[1]=i*(-1/48+s*(-1/15+s*(437/1440+s*(-46/105+s*(1118711/3870720))))),f[1]=i*(13/48+s*(s*(557/1440+s*(281/630+s*(-1983433/1935360)))-.6)),i*=s,u[2]=i*(-17/480+s*(37/840+s*(209/4480+s*(-5569/90720)))),f[2]=i*(61/240+s*(-103/140+s*(15061/26880+s*(167603/181440)))),i*=s,u[3]=i*(-4397/161280+s*(11/504+s*(830251/7257600))),f[3]=i*(49561/161280+s*(-179/168+s*(6601661/7257600))),i*=s,u[4]=i*(-4583/161280+s*(108847/3991680)),f[4]=i*(34729/80640+s*(-3418889/1995840)),i*=s,u[5]=i*(-20648693/638668800),f[5]=.6650675310896665*i,o=h(c,t.phi0),n=-e*(o+function(t,e){var n,r=2*xn(e),s=t.length-1,i=t[s],o=0;for(;--s>=0;)n=r*i-o+t[s],o=i,i=n;return On(e)*n}(f,2*o)),t.fwd=function(t,r){var s,i,o,a,u,d=t.phi,y=t.lam;d=h(c,d),s=On(d),i=xn(d),a=On(y),o=xn(y),d=kn(s,o*i),y=kn(a*i,Un(s,i*o)),y=function(t){var e=_n(t);return e=function(t){var e=1+t,n=e-1;return 0===n?t:t*Cn(e)/n}(e*(1+e/(Un(1,e)+1))),t<0?-e:e}(Sn(y)),u=l(f,2*d,2*y),d+=u[0],y+=u[1],_n(y)<=2.623395162778?(r.y=e*d+n,r.x=e*y):r.x=r.y=1/0},t.inv=function(t,r){var s,i,o,c,f,d=t.y,y=t.x;d=(d-n)/e,_n(y/=e)<=2.623395162778?(f=l(u,2*d,2*y),d+=f[0],y+=f[1],y=In(Fn(y)),s=On(d),i=xn(d),c=On(y),o=xn(y),y=kn(c,o*i),d=kn(s*o,Un(c,o*i)),r.phi=h(a,d),r.lam=y):r.phi=r.lam=1/0}}const Bn=Math.PI/180,Dn=6378137*Math.PI/180,Rn={};function Ln(t,e,n,r){if("EPSG:3857"===n)return function(t,e){const n=85.0511287798,r=e[0],s=Math.max(Math.min(n,e[1]),-n);let i;i=0===s?0:Math.log(Math.tan((90+s)*Bn/2))/Bn;return t[0]=r*Dn,t[1]=i*Dn,t}(t,e);if(!n||"EPSG:9807"!==n.code&&"Traverse_Mercator"!==n.code){if("EPSG:4326"===n||"EPSG:4490"===n||"identity"===n)return jn(t,e);if("baidu"===n)return jn(t,e);throw new Error("unsupported projection:"+n)}{if(!(!r||4326===r.wkid))return function(t,e){return t[0]=e[0],t[1]=e[1],t}(t,e);const s=JSON.stringify(n);let i=Rn[s];return i||(i=Rn[s]=function(t){const e={a:6378137,es:.0066943799901413165,x0:he(t.falseEasting)?5e5:t.falseEasting,y0:he(t.falseNorthing)?0:t.falseNorthing,k0:t.scaleFactor||.9996,lam0:(t.centralMeridian||0)*zn,phi0:(t.latitudeOfOrigin||0)*zn,originLam0:t.startLongtitude||0,originPhi0:t.startLatitude||0};Pn(e);const n={lam:0,phi:0},r={};let s=0,i=0;(e.originLam0||e.originPhi0)&&(n.lam=e.originLam0*zn-e.lam0,n.phi=e.originPhi0*zn,e.fwd(n,r),s=e.a*r.x+e.x0,i=e.a*r.y+e.y0);return{project:function(t,o){n.lam=t[0]*zn-e.lam0,n.phi=t[1]*zn,e.fwd(n,r);const a=e.a*r.x+e.x0-s,c=e.a*r.y+e.y0-i;return o[0]=a,o[1]=c,o}}}(n)),i.project(e,t)}}function jn(t,e){return t[0]=e[0],t[1]=e[1],t}const zn=.017453292519943295;const Vn=n([]),qn=Ze().draco,Gn=Ze().ktx2,$n={"pbrMetallicRoughness":{"baseColorFactor":[.5,.5,.5,1],"metallicFactor":0,"roughnessFactor":.5}},Xn={"position":{name:"POSITION",accessor:{"componentType":5126,"type":"VEC3"}},"normal":{name:"NORMAL",accessor:{"componentType":5126,"type":"VEC3"}},"uv0":{name:"TEXCOORD_0",accessor:{"componentType":5126,"type":"VEC2"}},"color":{name:"COLOR_0",accessor:{"componentType":5121,"type":"VEC4"}},"uv-region":{name:"uvRegion",accessor:{"componentType":5123,"type":"VEC4"}},"feature-index":{name:"_BATCHID",accessor:{"componentType":5125,"type":"SCALAR"}},"faceRange":{name:"faceRange",accessor:{"componentType":5125,"type":"VEC2"}}};function Hn(t,e,r,s,i,o){const a=[],c=[],u=[];for(let e=0;e<t.meshes.length;e++){const{geometry:n,material:r}=t.meshes[e],s=H.getArrayBuffer(n.url,o);s.xhr.url=n.url,u.push(s.xhr);const i=s.then(t=>({buffer:t}));a.push(i);const f=[];if(tr(r,f),f.length){const t=f.map(t=>{const e=H.getArrayBuffer(t.url,o);return e.xhr.url=t.url,u.push(e.xhr),e.then(e=>e&&e.status?null:{buffer:e,mimeType:t.mimeType,format:t.format})});a.push(...t)}c[e]=f.length}const f=Promise.all(a).then(o=>{for(let t=0;t<o.length;t++)if(!o[t]||!o[t].buffer)return Promise.resolve(null);const a=[];let u=0;for(let t=0;t<c.length;t++){const e=c[t];a.push({geoBuffer:{data:o[u].buffer.data},textureBuffers:o.slice(u+1,e+u+1).map(t=>({data:t.buffer.data,mimeType:t.mimeType,format:t.format}))}),u+=1+e}return function(t,e,r,s,i,o){const a={asset:{generator:"i3s",version:"2.0"},extensions:{},scene:0,scenes:[{nodes:[]}],nodes:{},meshes:{},materials:[],skins:[],animations:null,textures:[],transferables:[]},c=[];for(let u=0;u<t.meshes.length;u++){let{material:f}=t.meshes[u];const{geometry:h}=t.meshes[u];let l;const d=e[u].geoBuffer.data;if(!d)continue;const y=or(d);l=y?Kn(a,u,h,d,t.transform,t.center,i,o):Qn(a,u,h,d,t.transform,t.center,i,o),c.push(l),a.nodes[u]={mesh:u,nodeIndex:u,matrix:n([])},a.scenes[0].nodes[u]=a.nodes[u],f||(f=$n);const m=Zn(u,a,f,e[u].textureBuffers,r,s);c.push(m)}return Promise.all(c).then(()=>({gltf:a,featureTable:{BATCH_LENGTH:0},transferables:a.transferables}))}(t,a,e,i,r,s)});return f.xhr=u,f}const Jn={"magFilter":9728,"minFilter":9728,"wrapR":33071,"wrapS":33071,"wrapT":33071};function Kn(t,e,n,r,s,i,o,a){const c=n.info.compressedAttributes.attributes.reduce((t,e,n)=>{const r=Xn[e];if(!r)return t;return t[r.name||e]=n,t},{});return qn(r,{attributes:c,metadatas:{"POSITION":[{name:"i3s-scale_x",type:"double"},{name:"i3s-scale_y",type:"double"}]},useUniqueIDs:!1,skipAttributeTransform:!1}).then(n=>Wn(n,t,e,s,i,o,a))}const Yn={position:function(t,e,n){const r=3*t.vertexCount,s=new Float32Array(e,n,r);return t.position={array:s,componentType:5126,itemSize:3,count:r/3,meta:{"i3s-scale_x":1,"i3s-scale_y":1},type:"VEC3"},n+=4*r},normal:function(t,e,n){const r=3*t.vertexCount,s=new Float32Array(e,n,r);return t.normal={array:s,componentType:5126,itemSize:3,count:r/3,type:"VEC3"},n+=4*r},uv0:function(t,e,n){const r=2*t.vertexCount,s=new Float32Array(e,n,r);return t.uv0={array:s,componentType:5126,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},color:function(t,e,n){const r=4*t.vertexCount,s=new Uint8Array(e,n,r);return t.color={array:s,componentType:5121,itemSize:4,count:r/4,type:"VEC4"},n+=r},featureId:function(t,e,n){return n+=8*t.featureCount},id:function(t,e,n){return n+=8*t.featureCount},faceRange:function(t,e,n){const r=2*t.featureCount,s=new Uint32Array(e,n,r);return t.faceRange={array:s,componentType:5125,itemSize:2,count:r/2,type:"VEC2"},n+=4*r},uvRegion:function(t,e,n){const r=4*t.vertexCount,s=new Uint16Array(e,n,r);return t["uv-region"]={array:s,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r},region:function(t,e,n){const r=4*t.vertexCount,s=new Uint16Array(e,n,r);return t["uv-region"]={array:s,componentType:5123,itemSize:4,count:r/4,type:"VEC4"},n+=2*r}};function Qn(t,e,n,r,s,i,o,a){const c={vertexCount:0},u=new DataView(r);try{let t=0;c.vertexCount=u.getUint32(t,1),t+=4,c.featureCount=u.getUint32(t,1),t+=4;const e=n.info.ordering?null:n.info;if(e){const n=[];for(const t in e)"offset"!==t&&""!==t&&n.push(t);for(let e=0;e<n.length;e++)Yn[n[e]]?t=Yn[n[e]](c,r,t):console.error("Unknown decoder for",n[e])}else{const e=n.info;let s=e.ordering,i=e.featureAttributeOrder;const o=null;o&&o.geometryData&&o.geometryData[0]&&o.geometryData[0].params;for(let e=0;e<s.length;e++){const n=Yn[s[e]];n||console.log(s[e]),t=n(c,r,t)}for(let e=0;e<i.length;e++){const n=Yn[i[e]];n||console.log(i[e]),t=n(c,r,t)}}}catch(t){}c.scale_x=1,c.scale_y=1;const f={};for(const t in c){const e=Xn[t]&&Xn[t].name;e&&(f[e]=c[t])}if(c.faceRange){const t=c.faceRange.array,e=t.length/2,n=(h=e)<=255?Uint8Array:h<=65535?Uint16Array:Uint32Array,r=new n(f.POSITION.array.length/3);for(let e=0;e<t.length-1;e+=2){const n=e/2,s=t[e],i=t[e+1];for(let t=s;t<=i;t++)r[3*t]=n,r[3*t+1]=n,r[3*t+2]=n}f._BATCHID={componentType:Je(n),array:r,itemSize:1,count:r.length,type:"SCALAR"}}var h;return Wn({attributes:f},t,e,s,i,o,a)}function Wn(t,e,n,r,s,i,o){const c={attributes:t.attributes,material:n,indices:t.indices,mode:4};!function(t){const e=t.array,n=t.meta&&t.meta["i3s-scale_x"],r=t.meta&&t.meta["i3s-scale_y"];if(n&&r&&(1!==n||1!==r))for(let t=0;t<e.length;t+=3)e[t]*=n.value,e[t+1]*=r.value}(t.attributes.POSITION);const u=function(t,e,n,r,s){let i,o=[0,0,0,1];const c=[0,0],u=Ln([],n,r,s);u[2]=n[2];const f=e&&a(Vn,e);return pn(t,t=>(o[0]=t[0],o[1]=t[1],o[2]=t[2],f||(o=g(o,o,e)),n&&d(o,o,n),Ln(c,o,r,s),i=o[2],t[0]=c[0]-u[0],t[1]=c[1]-u[1],t[2]=i-u[2],t)),u}(t.attributes.POSITION,r,s,i,o);e.meshes[n]={primitives:[c],index:n},e.extensions.MAPTALKS_RTC={projCenter:u},e.extensions.CESIUM_RTC={rtcCoord:s};for(const n in t.attributes)ir(e.transferables,t.attributes[n].array.buffer);return t.indices&&ir(e.transferables,t.indices.array.buffer),c}function Zn(t,e,n,r,s,i){const o=r.map(t=>function(t,e,n,r,s){if("dds"===e){const e=Tn(t),r=e.images.map(e=>new Uint8Array(t,e.offset,e.length)),s="dxt1"===e.format?33777:33779;return Promise.resolve({image:{mipmap:r,width:e.shape[0],height:e.shape[1],mimeType:n},sampler:Jn,format:s})}if("png"===e||"jpg"===e)return function(t,e){er||(er=new OffscreenCanvas(2,2),nr=er.getContext("2d",{willReadFrequently:!0}));const n=new Blob([new Uint8Array(t)]);return createImageBitmap(n).then(t=>{let{width:n,height:r}=t;rr(n)||(n=sr(n)),rr(r)||(r=sr(r));const s=e;s&&(n=Math.min(s,n),r=Math.min(s,r)),er.width=n,er.height=r,nr.drawImage(t,0,0,n,r),t.close();const i=nr.getImageData(0,0,n,r);return{width:n,height:r,array:new Uint8Array(i.data)}}).catch(()=>({width:2,height:2,array:new Uint8Array(4)}))}(t,s).then(t=>{t.mimeType=n;return{image:t,sampler:Jn,format:6408}});if("ktx2"===e)return Gn(t,r).then(t=>(t.mimeType=n,{image:t,sampler:Jn,format:t.format}));return null}(t.data,t.format,t.mimeType,s,i).then(t=>{if(t.image)if(t.image.array)ir(e.transferables,t.image.array.buffer);else if(t.image.mipmap)for(let n=0;n<t.image.mipmap.length;n++)ir(e.transferables,t.image.mipmap[n].buffer);return t}));return Promise.all(o).then(r=>{!function t(e,n,r,s){const i=JSON.parse(JSON.stringify(r)),o=n.textures;s.ptr||(s.ptr=0);for(const e in r)r[e]&&r[e].url?(o.push(s[s.ptr++]),i[e]={index:o.length-1},void 0!==r[e].factor&&(i[e].scale=r[e].factor)):le(r[e])&&(i[e]=t(-1,n,r[e],s));e>=0&&(n.materials[e]=i);return i}(t,e,n,r)})}function tr(t,e){for(const n in t)t[n]&&t[n].url?e.push({url:t[n].url,mimeType:t[n].mimeType,format:t[n].format}):le(t[n])&&tr(t[n],e)}let er,nr;function rr(t){return 0==(t&t-1)&&0!==t}function sr(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function ir(t,e){e&&(t.indexOf(e)>=0||t.push(e))}function or(t){const e=new Uint8Array(t,0,5);return e[0]==="D".charCodeAt()&&e[1]==="R".charCodeAt()&&e[2]==="A".charCodeAt()&&e[3]==="C".charCodeAt()&&e[4]==="O".charCodeAt()}const ar=[];const cr=[],ur=[],fr=[],hr=[],lr=[],dr=[],yr=[];function mr(t,e,n,r,s,i){l(hr,t[3*e],t[3*e+1],t[3*e+2]),l(lr,t[3*n],t[3*n+1],t[3*n+2]),l(dr,t[3*r],t[3*r+1],t[3*r+2]);const o=v(cr,dr,lr),a=v(ur,hr,lr),c=w(fr,o,a);b(yr,c),s[3*e]=s[3*e]||0,s[3*n]=s[3*n]||0,s[3*r]=s[3*r]||0,s[3*e+1]=s[3*e+1]||0,s[3*n+1]=s[3*n+1]||0,s[3*r+1]=s[3*r+1]||0,s[3*e+2]=s[3*e+2]||0,s[3*n+2]=s[3*n+2]||0,s[3*r+2]=s[3*r+2]||0,s[3*e]+=yr[0],s[3*n]+=yr[0],s[3*r]+=yr[0],s[3*e+1]+=yr[1],s[3*n+1]+=yr[1],s[3*r+1]+=yr[1],s[3*e+2]+=yr[2],s[3*n+2]+=yr[2],s[3*r+2]+=yr[2],i[e]+=1,i[n]+=1,i[r]+=1}const br=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],pr=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],wr=2*Math.PI*6378137/360,gr="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;let vr,Mr=!1;if("undefined"!=typeof OffscreenCanvas){try{vr=new OffscreenCanvas(2,2).getContext("2d",{willReadFrequently:!0})}catch(t){}vr&&"undefined"!=typeof createImageBitmap&&(Mr=!0)}const Tr=n([]),Ar=[0,0,0],_r=[],Or=[],xr=[],Sr=[],Ir={"POSITION":1,"TEXCOORD_0":1,"TEXCOORD_1":1,"NORMAL":1,"TANGENT":1},kr={"TEXCOORD_0":1e-4,"TEXCOORD_1":1e-4};let Er;class Cr{constructor(t,e,n,r){this.id=t,this.options=e,this.gt=this.requestImage.bind(this),this.vt=n,this.Mt={},r(null,{},[])}Tt(t){this.At||(this.i=t,this._t=new on,this.At=new tn(this.gt,lt,t),this.Ot=new en(this.gt,lt,t))}requestImage(t,e){Mr?fetch(t).then(t=>t.arrayBuffer()).then(t=>{const e=new self.Blob([new Uint8Array(t)]);return createImageBitmap(e)}).then(t=>{(void 0).width=t.width,(void 0).height=t.height,vr.drawImage(t,0,0);const n=vr.getImageData(0,0,(void 0).width,(void 0).height);t.close(),e(null,{width:t.width,height:t.height,data:new Uint8Array(n.data)})}):this.vt("requestImage",{url:t},null,e)}loadTile(t,e){this.Tt(t.supportedFormats);const{service:n,url:r,arraybuffer:s}=t,i=n.fetchOptions||{};if(i.referrer=t.referrer,i.referrerPolicy=i.referrerPolicy||"origin",function(t){return t.indexOf("i3s:")>=0}(r)){const s=t.i3sInfo,o=n.maxTextureSize||1024,a=Hn(s,t.supportedFormats,this.options.projection,t.projection,o,i);return a.then(t=>{if(delete this.Mt[r],!t)return void e({status:404,url:r,i3sInfo:s});if(!Object.keys(t.gltf.meshes).length)return void e({status:404,url:r,i3sInfo:s});t.gltf.url=r;const{transferables:n}=t;t.magic="b3dm",this.xt(t.gltf),e(null,t,n)}),void(this.Mt[r]=a.xhr)}if(s){delete this.Mt[r];const n=Se(new DataView(s),0);if("{"===n[0]||" "===n[0]||"<"===n[0]){const n=function(t,e,n){if(gr){const r=new Uint8Array(t,e,n);return gr.decode(r)}return be(new Uint8Array(t,e,n))}(s,0,s.byteLength),i=JSON.parse(n);i.accessors?this.St(i,r,t,"gltf",e):this.It(t.rootIdx,i,s,r,e)}else this.St(s,r,t,n,e)}else{let s=n.urlParams;s&&(s=(r.indexOf("?")>0?"&":"?")+s);const o=r.replace(/\\+/g,"%2B");let a=H.getArrayBuffer(o+(s||""),i);const c=a.xhr;a=a.then(n=>{delete this.Mt[r],n&&n.status?e(n):(t.arraybuffer=n&&n.data,this.loadTile(t,e))}).catch(t=>{delete this.Mt[r],e(t)}),this.Mt[r]=c}}St(t,e,n,r,s){r=r&&r.toLowerCase();const{service:i}=n;if("b3dm"===r){this.At.load(e,t,0,0,{maxTextureSize:i.maxTextureSize||1024}).then(t=>{if(t.error)return void s(t);const{content:e,transferables:r}=this.kt(t,n);this.xt(e.gltf),s(null,e,r)}).catch(t=>{s(t)})}else if("pnts"===r){const r=n.transform||Tr;this._t.load(e,t).then(t=>{const{content:e,transferables:i}=this.Et(t,r,n.rootIdx);this.Ct(e),s(null,e,i)})}else if("i3dm"===r){const r=n.transform||Tr;this.Ot.load(e,t,0,0,{maxTextureSize:i.maxTextureSize||1024}).then(t=>{const{content:e,transferables:i}=this.Ut(t,r,n.rootIdx);this.xt(e.gltf),s(null,e,i)})}else if("cmpt"===r){new cn(this.gt,lt,this.i,i.maxTextureSize||1024).load(e,t,0,0,{maxTextureSize:i.maxTextureSize||1024}).then(t=>{const{content:e,transferables:r}=this.Ft(t,n);this.Nt(e),s(null,e,r)}).catch(t=>{s(t)})}else if("gltf"===r){this.rt||(this.rt=Ze());const r=e.substring(0,e.lastIndexOf("/")),o=t instanceof ArrayBuffer&&{buffer:t,byteOffset:0,byteLength:t.byteLength}||t,a=new lt(r,o,{transferable:!0,requestImage:this.gt,decoders:this.rt,supportedFormats:this.i,maxTextureSize:i.maxTextureSize||1024});a.load({skipAttributeTransform:!1}).then(t=>{t.url=e,this.Pt(t,null,n),this.xt(t),s(null,{magic:"gltf",gltf:t},a.transferables)})}else s(new Error("unsupported tile format: "+r))}Nt(t){t.content?t.content.forEach(t=>{this.Nt(t)}):this.xt(t.gltf)}Bt(t,e){if(this.Dt(t,e)&&!t.attributes.NORMAL){const e=t.attributes.POSITION.array,n=e.length,r=this.Rt()?Er.subarray(0,n):e,s=function(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const s=ar;s.length<t.length/3&&(s.length=t.length/3),s.fill(0,0,t.length/3);const i=void 0===e.length?e:e.length;for(let n=0;n<i/3;n++)void 0===e.length?mr(t,3*n,3*n+1,3*n+2,r,s):mr(t,e[3*n],e[3*n+1],e[3*n+2],r,s);for(let t=0;t<r.length;t+=3){const e=s[t/3];0!==e?(r[t]/=e,r[t+1]/=e,r[t+2]/=e):(r[t]=0,r[t+1]=0,r[t+2]=0)}return r}(r,t.indices.array,new Float32Array(r.length));t.attributes.NORMAL={array:s,byteLength:s.byteLength,byteOffset:0,byteStride:0,componentType:5126,count:s.length/3,itemSize:3,name:"NORMAL",type:"VEC3"}}}xt(t){if(!t||!t.meshes||t.extensionsUsed&&t.extensionsUsed.indexOf("KHR_techniques_webgl")>-1)return;if(t.asset&&t.asset.sharePosition)return;const e=t.meshes;for(const n in e){e[n].primitives.forEach(e=>{this.Bt(e,t),e.compressed_int16_params={};const n=e.attributes;for(const t in n)if(Ir[t]&&n[t].array&&n[t].array instanceof Float32Array){let r=1;this.Rt()&&"POSITION"===t&&(r=wr,e.compressed_int16_params.compressed_ratio=r);const s=Dr(n[t].array,r,n[t].min,n[t].max,t);if(!s)continue;const{array:i,range:o}=s;n[t].array=i,e.compressed_int16_params[t]=o}})}}Ct(t){if(!t||!t.pnts)return;const e=t.pnts;t.compressed_int16_params={};for(const n in e)if(Ir[n]&&e[n].array&&e[n].array instanceof Float32Array){let r=1;this.Rt()&&"POSITION"===n&&(r=wr,t.compressed_int16_params.compressed_ratio=r);const{array:s,range:i}=Dr(e[n].array,r,e[n].min,e[n].max,n);e[n].array=s,t.compressed_int16_params[n]=i}}Lt(t){const e=[];for(let n=0;n<t.length;n++){const r=t[n];if(!r.childTile)continue;const s={boundingVolume:{sphere:[r.boundingSphere.center.x,r.boundingSphere.center.y,r.boundingSphere.center.z,r.boundingSphere.radius]},content:{uri:r.childTile},geometricError:r.boundingSphere.radius/r.rangeList*16,refine:"REPLACE"};e.push(s)}return e}It(t,e,n,r,s){return e.capabilities,void s(null,e)}Ft(t,e){const{tiles:n}=t,r={magic:"cmpt",content:[]},s=[];for(let t=0;t<n.length;t++){const{magic:i}=n[t];if("b3dm"===i){const{content:i,transferables:o}=this.kt(n[t],e);Pr(s,o),r.content.push(i)}else if("i3dm"===i){const{transform:i,rootIdx:o}=e,{content:a,transferables:c}=this.Ut(n[t],i,o);Pr(s,c),r.content.push(a)}else if("pnts"===i){const{transform:i,rootIdx:o}=e,{content:a,transferables:c}=this.Et(n[t],i,o);Pr(s,c),r.content.push(a)}else if("cmpt"===i){const{content:i,transferables:o}=this.Ft(n[t],e);Pr(s,o),r.content.push(i)}}return{content:r,transferables:s}}kt(t,e){const{gltf:n,transferables:r,featureTable:s}=t;return this.Pt(n,s,e),delete t.transferables,{content:t,transferables:r}}Pt(t,e,n){const r=function(t){if(!t||!t.meshes)return!1;let e=1;const n=[];for(const r in t.meshes){const s=t.meshes[r],{primitives:i}=s;if(i)for(let t=0;t<i.length;t++){const r=i[t].attributes&&i[t].attributes.POSITION;if(!r||!r.array)continue;r.array.buffer.visited||(r.array.buffer.visited=e++);const s=e-1+"-"+(r.byteOffset||0);if(n.indexOf(s)>=0)return!0;n.push(s)}}return!1}(t);this.jt(t),t.asset||(t.asset={}),r?(t.asset.sharePosition=!0,this.zt(t,e,n.upAxis,n.transform)):this.Vt(t,e,n.upAxis,n.transform)}Ut(t,e,n){const{featureTable:r}=t,s=t.i3dm,i=r&&r.RTC_CENTER||[0,0,0],o=this.options.projection,c=e&&a(Tr,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Fr(s.POSITION.array,3,i,Tr,u);const f=Nr(u);e&&!c&&g(f,f,e);const d=this.qt(f),y=[];Ln(y,d,o),y[2]=d[2];const m=h([],f),b=[0,0,0],p=[0,0,0],w=[0,0],v=[1/0,1/0,1/0],M=[-1/0,-1/0,-1/0];pn(s.POSITION,t=>{b[0]=t[0]+i[0],b[1]=t[1]+i[1],b[2]=t[2]+i[2],e&&!c&&g(b,b,e),0===T(b)?l(p,0,0,-6378137):Te(p,b),Ln(w,p,o),t[0]=w[0]-y[0],t[1]=w[1]-y[1],t[2]=p[2]-y[2],t[0]<v[0]&&(v[0]=t[0]),t[1]<v[1]&&(v[1]=t[1]),t[2]<v[2]&&(v[2]=t[2]),t[0]>M[0]&&(M[0]=t[0]),t[1]>M[1]&&(M[1]=t[1]),t[2]>M[2]&&(M[2]=t[2])}),s.POSITION.min=v,s.POSITION.max=M,e&&g(f,f,e),t.rtcCenter=m,t.rtcCoord=d,t.projCenter=y,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}Et(t,e,n){const{featureTable:r}=t,s=t.pnts,i=r&&r.RTC_CENTER||[0,0,0],o=this.options.projection,c=e&&a(Tr,e),u={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};Fr(s.POSITION.array,3,i,e,u);const f=Nr(u),d=this.Gt(f),y=h([],f),m=[1/0,1/0,1/0],b=[-1/0,-1/0,-1/0];let p=[0,0,0,1];const w=[0,0,0],v=[0,0];pn(s.POSITION,t=>(p[0]=t[0]+i[0],p[1]=t[1]+i[1],p[2]=t[2]+i[2],e&&!c&&(p=g(p,p,e)),0===T(p)?l(w,0,0,-6378137):Te(w,p),Ln(v,w,o),t[0]=v[0]-d[0],t[1]=v[1]-d[1],t[2]=w[2]-d[2],t[0]<m[0]&&(m[0]=t[0]),t[1]<m[1]&&(m[1]=t[1]),t[2]<m[2]&&(m[2]=t[2]),t[0]>b[0]&&(b[0]=t[0]),t[1]>b[1]&&(b[1]=t[1]),t[2]>b[2]&&(b[2]=t[2]),t)),s.POSITION.min=m,s.POSITION.max=b,e&&g(f,f,e);const M=this.qt(f);t.rtcCenter=y,t.projCenter=d,t.rtcCoord=M,t.rootIdx=n;const A=t.transferables;return delete t.transferables,{content:t,transferables:A}}jt(t){if(!Array.isArray(t.textures))return;const e=t.textures;for(let t=0;t<e.length;t++){const n=e[t].image&&e[t].image.array;if(n&&n.length){const r=n[0],s=n[1],i=n[2],o=n[3];let a=!0;for(let t=4;t<n.length;t+=4)if(n[t]!==r||n[t+1]!==s||n[t+2]!==i||n[t+3]!==o){a=!1;break}a&&(e[t].image.color=[r/255,s/255,i/255,o/255],delete e[t].image.array)}}}abortTileLoading(t,e){const n=this.Mt[t.url];if(Array.isArray(n))for(let t=0;t<n.length;t++)n[t].abort();else n&&n.abort&&n.abort();delete this.Mt[t.url],e(null)}$t(t,e,s,i){const o=e&&e.RTC_CENTER||t.extensions&&t.extensions.CESIUM_RTC&&t.extensions.CESIUM_RTC.center;let a=br;"X"===(s=s&&s.toUpperCase())?a=pr:"Z"===s&&(a=Tr),t.extensions=t.extensions||{},t.extensions.CESIUM_RTC||(t.extensions.CESIUM_RTC={}),o&&(t.extensions.CESIUM_RTC.center=o),t.extensions.MAPTALKS_RTC={};const c={xmin:1/0,xmax:-1/0,ymin:1/0,ymax:-1/0,hmin:1/0,hmax:-1/0};un(t,t=>{if(!(t.attributes&&t.attributes.POSITION))return;const e=n(_r);t.matrices&&Br(e,t.matrices);const s=t.attributes.POSITION.array,u=t.attributes.POSITION.itemSize;r(e,a,e),i&&r(e,i,e),Fr(s,u,o||Ar,e,c,t.compressUniforms)});const u=Nr(c);return{rtcCenter:o,modelCenter:u,upAxisTransform:a}}zt(t,e,s,i){const{modelCenter:o,upAxisTransform:a,rtcCenter:c}=this.$t(t,e,s),u=this.Gt(o);t.extensions.MAPTALKS_RTC.projCenter=u,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.qt(o);const f=h([],o);i&&g(o,o,i),t.extensions.CESIUM_RTC.rtcCoord=this.qt(o),c||(un(t,t=>{if(t.attributes&&t.attributes.POSITION){const e=t.attributes.POSITION;if(e.array.buffer.projected&&e.array.buffer.projected[e.byteOffset])return;const s=n(_r);t.matrices&&Br(s,t.matrices),r(s,a,s);const i=function(t,e){var n=e[0],r=e[1],s=e[2],i=e[3],o=e[4],a=e[5],c=e[6],u=e[7],f=e[8],h=e[9],l=e[10],d=e[11],y=e[12],m=e[13],b=e[14],p=e[15],w=n*a-r*o,g=n*c-s*o,v=n*u-i*o,M=r*c-s*a,T=r*u-i*a,A=s*u-i*c,_=f*m-h*y,O=f*b-l*y,x=f*p-d*y,S=h*b-l*m,I=h*p-d*m,k=l*p-d*b,E=w*k-g*I+v*S+M*x-T*O+A*_;return E?(E=1/E,t[0]=(a*k-c*I+u*S)*E,t[1]=(s*I-r*k-i*S)*E,t[2]=(m*A-b*T+p*M)*E,t[3]=(l*T-h*A-d*M)*E,t[4]=(c*x-o*k-u*O)*E,t[5]=(n*k-s*x+i*O)*E,t[6]=(b*v-y*A-p*g)*E,t[7]=(f*A-l*v+d*g)*E,t[8]=(o*I-a*x+u*_)*E,t[9]=(r*x-n*I-i*_)*E,t[10]=(y*T-m*v+p*w)*E,t[11]=(h*v-f*T-d*w)*E,t[12]=(a*O-o*S-c*_)*E,t[13]=(n*S-r*O+s*_)*E,t[14]=(m*g-y*M-b*w)*E,t[15]=(f*M-h*g+l*w)*E,t):null}(Or,s),o=[1/0,1/0,1/0],c=[-1/0,-1/0,-1/0];pn(e,t=>{g(t,t,s),t[0]=t[0]-f[0],t[1]=t[1]-f[1],t[2]=t[2]-f[2],g(t,t,i),t[0]<o[0]&&(o[0]=t[0]),t[1]<o[1]&&(o[1]=t[1]),t[2]<o[2]&&(o[2]=t[2]),t[0]>c[0]&&(c[0]=t[0]),t[1]>c[1]&&(c[1]=t[1]),t[2]>c[2]&&(c[2]=t[2])}),e.min=o,e.max=c,e.array.buffer.projected||(e.array.buffer.projected={}),e.array.buffer.projected[e.byteOffset]=1}}),t.extensions.CESIUM_RTC.center=f)}Vt(t,e,n,r){const{modelCenter:s,rtcCenter:i}=this.$t(t,e,n,r),o=this.Gt(s);t.extensions.MAPTALKS_RTC.projCenter=o,t.extensions.MAPTALKS_RTC.rtcCoord=t.extensions.CESIUM_RTC.rtcCoord=this.qt(s),un(t,e=>{if(e.attributes&&e.attributes.POSITION){const s=this.Dt(e,t);if(s){const t=e.attributes.POSITION.array.length;(!Er||Er.length<t)&&(Er=new Float32Array(t))}e.attributes.NORMAL&&this.Xt(e.attributes.NORMAL,e.matrices,n),e.attributes.TANGENT&&this.Xt(e.attributes.TANGENT,e.matrices,n);const{newPositions:o}=this.Ht(e.attributes.POSITION,e.matrices,i,t.extensions.MAPTALKS_RTC,n,r,e.compressUniforms,s),{componentType:a}=e.attributes.POSITION;5126!==a&&(e.attributes.POSITION.array=new Float32Array(o))}});for(const e in t.nodes){t.nodes[e].matrix=Tr}}Gt(t){0===T(t)?l(xr,0,0,-6378137):Te(xr,t);const e=this.options.projection;Ln(Sr,xr,e);const n=xr[2],r=[];return r[0]=Sr[0],r[1]=Sr[1],r[2]=n,r}Xt(t,e,n){let r;r="Y"===n?br:"X"===n?pr:Tr;const s=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}([],r);if(Br(s,e),a(s,Tr))return;const i=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}([],s),o=[];pn(t,t=>(function(t,e,n){var r=e[0],s=e[1],i=e[2];t[0]=r*n[0]+s*n[3]+i*n[6],t[1]=r*n[1]+s*n[4]+i*n[7],t[2]=r*n[2]+s*n[5]+i*n[8]}(o,t,i),b(o,o),h(t,o),o))}Ht(t,e,r,s,i,o,c,u){if(t.array.buffer.projected&&t.array.buffer.projected[t.byteOffset])return null;const f=n([]);Br(f,e);const h=this.options.projection;i=i&&i.toUpperCase();const y=r;let m=null;"Y"===i?m=br:"X"===i&&(m=pr);let b=[0,0,0,1];const p=[0,0,0],w=[0,0],v=s.projCenter,M=Ln([],s.rtcCoord,"EPSG:3857"),A=o&&a(Tr,o),_=t.min=t.min||[],O=t.max=t.max||[];l(_,1/0,1/0,1/0),l(O,-1/0,-1/0,-1/0);const x=c||{},{decode_position_min:S,decode_position_normConstant:I}=x;let k=[0,0,0,0],E=1;S&&(k=S),I&&(E=I);const C=[];return pn(t,(e,n)=>{if(b[0]=e[0]*E+k[0],b[1]=e[1]*E+k[1],b[2]=e[2]*E+k[2],b=g(b,b,f),m&&(b=g(b,b,m)),y&&d(b,b,y),o&&!A&&(b=g(b,b,o)),0===T(b)?l(p,0,0,-6378137):Te(p,b),u){const t=Er;Ln(w,p,h),t[3*n]=w[0]-M[0],t[3*n+1]=w[0]-M[1],t[3*n+2]=w[0]-M[2]}if(Ln(w,p,h),e instanceof Float32Array)e[0]=w[0]-v[0],e[1]=w[1]-v[1],e[2]=p[2]-v[2];else{const n=w[0]-v[0],r=w[1]-v[1],s=p[2]-v[2];5126!==t.componentType&&(C.push(n),C.push(r),C.push(s),C.push(e[3]))}return e[0]<_[0]&&(_[0]=e[0]),e[1]<_[1]&&(_[1]=e[1]),e[2]<_[2]&&(_[2]=e[2]),e[0]>O[0]&&(O[0]=e[0]),e[1]>O[1]&&(O[1]=e[1]),e[2]>O[2]&&(O[2]=e[2]),e}),t.array.buffer.projected||(t.array.buffer.projected={}),t.array.buffer.projected[t.byteOffset]=1,{projCenter:v,newPositions:C}}qt(t){return 0===T(t)?l([],0,0,-6378137):Te([],t)}onRemove(){}Rt(){return"EPSG:4326"===this.options.projection||"EPSG:4490"===this.options.projection}Dt(t,e){if(!t.attributes.POSITION||function(t,e){const n=e.materials[t.material];return n&&n.extensions&&n.extensions.KHR_materials_unlit}(t,e))return!1;if(t.attributes.TANGENT)return!1;return!!t.attributes.TEXCOORD_0}}const Ur=[];function Fr(t,e,n,r,s,i){const o=i||{},{decode_position_min:a,decode_position_normConstant:c}=o;let u=[0,0,0,0],f=1;a&&(u=a),c&&(f=c);for(let i=0,o=t.length;i<o;i+=e){const{xmin:o,ymin:a,xmax:c,ymax:h,hmin:y,hmax:m}=s;l(Ur,t[i]*f+u[0],t[i+1]*f+u[1],t[i+2]*f+u[2]),g(Ur,Ur,r);const b=d(Ur,n,Ur);b[0]<o&&(s.xmin=b[0]),b[0]>c&&(s.xmax=b[0]),b[1]<a&&(s.ymin=b[1]),b[1]>h&&(s.ymax=b[1]),e>2&&(b[2]<y&&(s.hmin=b[2]),b[2]>m&&(s.hmax=b[2]))}}function Nr(t){const{xmax:e,ymax:n,xmin:r,ymin:s,hmin:i,hmax:o}=t,a=[(r+e)/2,(s+n)/2,(i+o)/2];return e===-1/0&&(a[0]=0),n===-1/0&&(a[1]=0),o===-1/0&&(a[2]=0),isNaN(a[2])&&(a[2]=0),a}function Pr(t,e){for(let n=0;n<e.length;n++)t.indexOf(e[n])<0&&t.push(e[n])}function Br(t,e){const n=t;for(let t=e.length-1;t>=0;t--)r(n,e[t],n);return n}function Dr(t,e,n,r,s){if(e&&e>1)for(let n=0;n<t.length;n++)(n+1)%3!=0&&(t[n]*=e);let i,o;if(n&&r&&1===e)i=Math.min(...n),o=Math.max(...r);else{const{min:e,max:n}=function(t){let e=1/0,n=-1/0;for(let r=0;r<t.length;r++)t[r]>n&&(n=t[r]),t[r]<e&&(e=t[r]);return{min:e,max:n}}(t);i=e,o=n}return!function(t,e,n,r){for(let s=0;s<t.length;s++){const i=Rr(Lr(t[s],e,n),e,n);if(Math.abs(i-t[s])>kr[r])return!1}return!0}(t,i,o,s)&&kr[s]?null:function(t,e,n){const r=new Int16Array(t.length);for(let s=0;s<t.length;s++)r[s]=Lr(t[s],e,n);return{array:r,range:[e,n]}}(t,i,o)}function Rr(t,e,n){return((t>=32768?-(65536-t)/32768:t/32767)+1)*(n-e)/2+e}function Lr(t,e,n){const r=2*(t-e)/(n-e)-1,s=Math.max(-1,Math.min(1,r));return s<0?32768*s:32767*s}let jr=0;class zr{constructor(t){this.workerId=t,this.workers={},this.Jt={}}addLayer({actorId:t,mapId:e,layerId:n,params:r},s){if(this.Kt(e,n))return;const i=this.Yt(e,n),o=r.options,a=this.send.bind(this,t);this.workers[i]=new Cr(n,o,a,s)}removeLayer({mapId:t,layerId:e},n){const r=this.Kt(t,e),s=this.Yt(t,e);delete this.workers[s],r&&r.onRemove(n)}loadTile({mapId:t,layerId:e,params:n},r){const s=this.Kt(t,e);s&&s.loadTile(n,r)}abortTileLoading({mapId:t,layerId:e,params:n},r){const s=this.Kt(t,e);s&&s.abortTileLoading(n,r)}receive(t){const e=t.callback,n=this.Jt[e];delete this.Jt[e],n&&t.error?n(new Error(t.error)):n&&n(null,t.data)}send(t,e,n,r,s){const i=s?`${t}-${jr++}`:null;s&&(this.Jt[i]=s),postMessage({type:"<request>",workerId:this.workerId,actorId:t,command:e,params:n,callback:String(i)},r||[])}Yt(t,e){return`${t}-${e}`}Kt(t,e){const n=this.Yt(t,e);return this.workers[n]}}t.initialize=function(){},t.onmessage=function(t,e){const n=t.data;this.dispatcher||(this.dispatcher=new zr(t.workerId)),"<response>"===t.type?this.dispatcher.workerId===t.workerId&&this.dispatcher.receive(t):this.dispatcher[n.command]({actorId:n.actorId,mapId:n.mapId,layerId:n.layerId,params:n.params},(t,n,r)=>{t&&console.error(t),t instanceof Error&&(t={message:t.message}),e(t,n,r)})},Object.defineProperty(t,"Qt",{value:!0})}';var l={exports:{}},h={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},c={exports:{}},u=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},f=Array.prototype.concat,d=Array.prototype.slice,p=c.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];u(i)?e=f.call(e,d.call(i)):e.push(i)}return e};p.wrap=function(t){return function(){return t(p(arguments))}};var A=h,g=c.exports,m=Object.hasOwnProperty,y=Object.create(null);for(var v in A)m.call(A,v)&&(y[A[v]]=v);var x=l.exports={to:{},get:{}};function b(t,e,n){return Math.min(Math.max(e,t),n)}function w(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}x.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=x.get.hsl(t),n="hsl";break;case"hwb":e=x.get.hwb(t),n="hwb";break;default:e=x.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},x.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var s=2*n;i[n]=parseInt(e.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:m.call(A,e[1])?((i=A[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=b(i[n],0,255);return i[3]=b(i[3],0,1),i},x.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,b(parseFloat(e[2]),0,100),b(parseFloat(e[3]),0,100),b(isNaN(n)?1:n,0,1)]}return null},x.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,b(parseFloat(e[2]),0,100),b(parseFloat(e[3]),0,100),b(isNaN(n)?1:n,0,1)]}return null},x.to.hex=function(){var t=g(arguments);return"#"+w(t[0])+w(t[1])+w(t[2])+(t[3]<1?w(Math.round(255*t[3])):"")},x.to.rgb=function(){var t=g(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},x.to.rgb.percent=function(){var t=g(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},x.to.hsl=function(){var t=g(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},x.to.hwb=function(){var t=g(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},x.to.keyword=function(t){return y[t.slice(0,3)]};var _={exports:{}},M=h,T={};for(var S in M)M.hasOwnProperty(S)&&(T[M[S]]=S);var I=_.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var C in I)if(I.hasOwnProperty(C)){if(!("channels"in I[C]))throw new Error("missing channels property: "+C);if(!("labels"in I[C]))throw new Error("missing channel labels property: "+C);if(I[C].labels.length!==I[C].channels)throw new Error("channel and label counts mismatch: "+C);var O=I[C].channels,E=I[C].labels;delete I[C].channels,delete I[C].labels,Object.defineProperty(I[C],"channels",{value:O}),Object.defineProperty(I[C],"labels",{value:E})}I.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),l=a-o;return a===o?e=0:r===a?e=(i-s)/l:i===a?e=2+(s-r)/l:s===a&&(e=4+(r-i)/l),(e=Math.min(60*e,360))<0&&(e+=360),n=(o+a)/2,[e,100*(a===o?0:n<=.5?l/(a+o):l/(2-a-o)),100*n]},I.rgb.hsv=function(t){var e,n,r,i,s,o=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(o,a,l),c=h-Math.min(o,a,l),u=function(t){return(h-t)/6/c+.5};return 0===c?i=s=0:(s=c/h,e=u(o),n=u(a),r=u(l),o===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*h]},I.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[I.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,r))*100,100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},I.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},I.rgb.keyword=function(t){var e=T[t];if(e)return e;var n,r,i,s=1/0;for(var o in M)if(M.hasOwnProperty(o)){var a=M[o],l=(r=t,i=a,Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));l<s&&(s=l,n=o)}return n},I.keyword.rgb=function(t){return M[t]},I.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},I.rgb.lab=function(t){var e=I.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},I.hsl.rgb=function(t){var e,n,r,i,s,o=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return[s=255*l,s,s];e=2*l-(n=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(r=o+1/3*-(h-1))<0&&r++,r>1&&r--,s=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*s;return i},I.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,s=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[e,100*(0===r?2*i/(s+i):2*n/(r+n)),(r+n)/2*100]},I.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,s=e-Math.floor(e),o=255*r*(1-n),a=255*r*(1-n*s),l=255*r*(1-n*(1-s));switch(r*=255,i){case 0:return[r,l,o];case 1:return[a,r,o];case 2:return[o,r,l];case 3:return[o,a,r];case 4:return[l,o,r];case 5:return[r,o,a]}},I.hsv.hsl=function(t){var e,n,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,n=s*a,[i,100*(n=(n/=(e=(2-s)*a)<=1?e:2-e)||0),100*(r/=2)]},I.hwb.rgb=function(t){var e,n,r,i,s,o,a,l=t[0]/360,h=t[1]/100,c=t[2]/100,u=h+c;switch(u>1&&(h/=u,c/=u),r=6*l-(e=Math.floor(6*l)),0!=(1&e)&&(r=1-r),i=h+r*((n=1-c)-h),e){default:case 6:case 0:s=n,o=i,a=h;break;case 1:s=i,o=n,a=h;break;case 2:s=h,o=n,a=i;break;case 3:s=h,o=i,a=n;break;case 4:s=i,o=h,a=n;break;case 5:s=n,o=h,a=i}return[255*s,255*o,255*a]},I.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},I.xyz.rgb=function(t){var e,n,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return n=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,e=(e=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},I.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},I.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var s=Math.pow(n,3),o=Math.pow(e,3),a=Math.pow(r,3);return n=s>.008856?s:(n-16/116)/7.787,e=o>.008856?o:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},I.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},I.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},I.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:I.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(s+=60),s},I.hsv.ansi16=function(t){return I.rgb.ansi16(I.hsv.rgb(t),t[2])},I.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},I.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},I.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},I.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},I.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},I.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),a=s-o;return e=a<=0?0:s===n?(r-i)/a%6:s===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?o/(1-a):0)]},I.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},I.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},I.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,s=[0,0,0],o=e%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return i=(1-n)*r,[255*(n*s[0]+i),255*(n*s[1]+i),255*(n*s[2]+i)]},I.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},I.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},I.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},I.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},I.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},I.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},I.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},I.gray.hsl=I.gray.hsv=function(t){return[0,0,t[0]]},I.gray.hwb=function(t){return[0,100,t[0]]},I.gray.cmyk=function(t){return[0,0,0,t[0]]},I.gray.lab=function(t){return[t[0],0,0]},I.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},I.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var P=_.exports;function k(t){var e=function(){for(var t={},e=Object.keys(P),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(P[r]),s=i.length,o=0;o<s;o++){var a=i[o],l=e[a];-1===l.distance&&(l.distance=e[r].distance+1,l.parent=r,n.unshift(a))}return e}function R(t,e){return function(n){return e(t(n))}}function N(t,e){for(var n=[e[t].parent,t],r=P[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=R(P[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var D=_.exports,F=function(t){for(var e=k(t),n={},r=Object.keys(e),i=r.length,s=0;s<i;s++){var o=r[s];null!==e[o].parent&&(n[o]=N(o,e))}return n},L={};Object.keys(D).forEach((function(t){L[t]={},Object.defineProperty(L[t],"channels",{value:D[t].channels}),Object.defineProperty(L[t],"labels",{value:D[t].labels});var e=F(t);Object.keys(e).forEach((function(n){var r=e[n];L[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),L[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var z=L,B=l.exports,H=z,U=[].slice,j=["keyword","gray","hex"],V={};Object.keys(H).forEach((function(t){V[U.call(H[t].labels).sort().join("")]=t}));var G={};function q(t,e){if(!(this instanceof q))return new q(t,e);if(e&&e in j&&(e=null),e&&!(e in H))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof q)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=B.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=H[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=H[this.model].channels;var s=U.call(t,0,r);this.color=Y(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in V))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=V[a];var l=H[this.model].labels,h=[];for(n=0;n<l.length;n++)h.push(t[l[n]]);this.color=Y(h)}if(G[this.model])for(r=H[this.model].channels,n=0;n<r;n++){var c=G[this.model][n];c&&(this.color[n]=c(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function W(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(G[t]||(G[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function X(t){return function(e){return Math.max(0,Math.min(t,e))}}function Q(t){return Array.isArray(t)?t:[t]}function Y(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}q.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in B.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return B.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return B.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=H[this.model].channels,n=H[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new q(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new q(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:W("rgb",0,X(255)),green:W("rgb",1,X(255)),blue:W("rgb",2,X(255)),hue:W(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:W("hsl",1,X(100)),lightness:W("hsl",2,X(100)),saturationv:W("hsv",1,X(100)),value:W("hsv",2,X(100)),chroma:W("hcg",1,X(100)),gray:W("hcg",2,X(100)),white:W("hwb",1,X(100)),wblack:W("hwb",2,X(100)),cyan:W("cmyk",0,X(100)),magenta:W("cmyk",1,X(100)),yellow:W("cmyk",2,X(100)),black:W("cmyk",3,X(100)),x:W("xyz",0,X(100)),y:W("xyz",1,X(100)),z:W("xyz",2,X(100)),l:W("lab",0,X(100)),a:W("lab",1),b:W("lab",2),keyword:function(t){return arguments.length?new q(t):H[this.model].keyword(this.color)},hex:function(t){return arguments.length?new q(t):B.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return q.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,s=2*i-1,o=n.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,l=1-a;return q.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(H).forEach((function(t){if(-1===j.indexOf(t)){var e=H[t].channels;q.prototype[t]=function(){if(this.model===t)return new q(this);if(arguments.length)return new q(arguments,t);var n="number"==typeof arguments[e]?e:this.valpha;return new q(Q(H[this.model][t].raw(this.color)).concat(n),t)},q[t]=function(n){return"number"==typeof n&&(n=Y(U.call(arguments),e)),new q(n,t)}}}));var Z=q;function K(t){return null==t}function J(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function $(t){return null!=t&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}function tt(t){return"object"==typeof t&&!!t}function et(t){return"number"==typeof t&&!isNaN(t)}function nt(t){return t*Math.PI/180}function rt(t){return t/Math.PI*180}function it(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}function st(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}const ot=[1,1,1,1,2,2,3,0];function at(t){const e=t.length;let n="";for(let r=0;r<e;){let i=t[r++];if(128&i){let n=ot[i>>3&7];if(!(64&i)||!n||r+n>e)return null;for(i&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;i=i<<6|63&e}}n+=String.fromCharCode(i)}return n}function lt(t,e,n){return t[3*n]=e[0],t[3*n+1]=e[1],t[3*n+2]=e[2],t}function ht(t){return t.flat?t.flat(1/0):t.reduce((t,e)=>t.concat(e),[])}function ct(t){return t<256?Uint8Array:t<65536?Uint16Array:Uint32Array}function ut(t){return 0===t.indexOf("data:")}function ft(t){const e=t.indexOf("base64,"),n=t.substring(e+7),r=window.atob(n),i=r.length,s=new Uint8Array(i);for(let o=0;o<i;o++)s[o]=r.charCodeAt(o);return s.buffer}function dt(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}const pt={};function At(t,e){if(!Array.isArray(e)){const t=e;e=pt[t]=pt[t]||Z(e).array().map(t=>t/255)}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}Object.freeze({__proto__:null,isNil:K,extend:J,isFunction:$,isObject:tt,isNumber:et,toRadian:nt,toDegree:rt,getAbsoluteURL:it,sign:st,stringFromUTF8Array:at,setColumn3:lt,flatArr:ht,getBatchIdArrayType:ct,isBase64:ut,base64URLToArrayBuffer:ft,pushIn:dt,normalizeColor:At});function gt(t){return-1===t.indexOf("http://")&&-1===t.indexOf("https://")&&-1===t.indexOf("file://")}function mt(t){return(t=t||{}).referrerPolicy=t.referrerPolicy||"origin",t.referrer=window&&window.location.href,t}const yt="undefined"==typeof document?null:document.createElement("canvas");class vt extends e["R"].Actor{constructor(t,e){super(t),this.mapId=e}initialize(t){t(null)}loadTile(t,e,n){let r=null;e&&e.arraybuffer&&(r=[e.arraybuffer]);const i={mapId:this.mapId,layerId:t,command:"loadTile",params:e};this.send(i,r,n)}abortTileLoading(t,e,n){const r={mapId:this.mapId,layerId:t,command:"abortTileLoading",params:{url:e}};this.broadcast(r,null,n)}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(r,null,n)}removeLayer(t,e){const n={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(n,null,e)}requestImage({url:t},e){const n=new Image;n.onload=()=>{if(!this.isActive())return;if(!yt)return void e(new Error("There is no canvas to draw image!"));const t=function(t){if(xt(t.width)&&xt(t.height))return t;let e=t.width,n=t.height;xt(e)||(e=bt(e)),xt(n)||(n=bt(n));const r=document.createElement("canvas");r.width=e,r.height=n,r.getContext("2d").drawImage(t,0,0,e,n);const i=t.src,s=i.lastIndexOf("/")+1,o=i.substring(s);return console.warn(`Texture(${o})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),r}(n);yt.width=t.width,yt.height=t.height;const r=yt.getContext("2d",{willReadFrequently:!0});r.drawImage(t,0,0,t.width,t.height);const i=r.getImageData(0,0,t.width,t.height),s={width:t.width,height:t.height,data:new Uint8Array(i.data)};e(null,s,[s.data.buffer])},n.onerror=function(t){e(t)},n.src=t}}function xt(t){return 0==(t&t-1)&&0!==t}function bt(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function wt(t,e){if(t.scenes&&t.scenes.length)for(let n=0,r=t.scenes.length;n<r;n++){const r=t.scenes[n].nodes;for(let n=0,i=r.length;n<i;n++){const i=[];Ot(r[n],i,t,e)}}}const _t=[],Mt=[],Tt=[],St=[0,0,0],It=o["d"].identity([]),Ct=[1,1,1];function Ot(t,e,n,r){const i=e.slice(0);if(t.matrix)i.push(t.matrix);else if(t.rotation||t.translation||t.scale){const e=o["c"].fromTranslation(_t,t.translation||St),n=o["c"].fromQuat(Mt,t.rotation||It),r=o["c"].fromScaling(Tt,t.scale||Ct);o["c"].multiply(r,n,r);const s=o["c"].multiply([],e,r);i.push(s)}if(t.children&&t.children.length)for(let s=0,o=t.children.length;s<o;s++)Ot(t.children[s],i,n,r);if(void 0!==t.mesh){const e=t.mesh,s=n.meshes[e];if(s){const t=i.slice(0),o=s.primitives;for(let i=0,s=o.length;i<s;i++){const s=o[i];s&&(s.matrices=t,r(s,e,i,n))}}}}function Et(t,e,n){let{byteOffset:r,byteStride:i}=e;const{componentType:o,itemSize:a}=e,l=e.array.buffer,h=o?s["b"].getTypedArrayCtor(o):e.array.constructor;if(r=void 0===r?e.array.byteOffset:r,i=i||0,!i||i===a*h.BYTES_PER_ELEMENT&&r%h.BYTES_PER_ELEMENT==0){const e=new h(l,r+n*a*h.BYTES_PER_ELEMENT,a);return t.set(e),t}i||(i=a*h.BYTES_PER_ELEMENT);const c=new Uint8Array(l,i*n+r,a*h.BYTES_PER_ELEMENT);return new Uint8Array(t.buffer).set(c),t}function Pt(t,e,n,r){t[4*e]=n[r],t[4*e+1]=n[r+4],t[4*e+2]=n[r+8],t[4*e+3]=n[r+12]}var kt="#include <gl2_vert>\n\nconst float SHIFT_RIGHT_11 = 1.0 / 2048.0;\n\nconst float SHIFT_RIGHT_5 = 1.0 / 32.0;\n\nconst float SHIFT_LEFT_11 = 2048.0;\n\nconst float SHIFT_LEFT_5 = 32.0;\n\nconst float NORMALIZE_6 = 1.0 / 64.0;\n\nconst float NORMALIZE_5 = 1.0 / 32.0;\n\n\n\n#ifdef HAS_POSITION\n\n    attribute vec3 POSITION;\n\n#endif\n\n\n\n#if defined(HAS_RGB)\n\n    attribute vec3 RGB;\n\n#elif defined(HAS_RGBA)\n\n    attribute vec4 RGBA;\n\n#elif defined(HAS_RGB565)\n\n    attribute float RGB565;\n\n#endif\n\n\n\nuniform vec4 pointColor;\n\nuniform float pointSize;\n\n\n\nuniform mat4 projViewModelMatrix;\n\nuniform float pointOpacity;\n\n\n\nvarying vec4 vColor;\n\n\n\n#ifdef HAS_NORMAL\n\n    #ifdef HAS_NORMAL_OCT16P\n\n        attribute vec2 NORMAL_OCT16P;\n\n        float signNotZero(float value) {\n\n            return value >= 0.0 ? 1.0 : -1.0;\n\n        }\n\n        vec2 signNotZero(vec2 value) {\n\n            return vec2(signNotZero(value.x), signNotZero(value.y));\n\n        }\n\n        vec3 octDecode(vec2 encoded, float range) {\n\n            if (encoded.x == 0.0 && encoded.y == 0.0) {\n\n                return vec3(0.0, 0.0, 0.0);\n\n            }\n\n            encoded = encoded / range * 2.0 - 1.0;\n\n            vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n\n            if (v.z < 0.0) {\n\n                v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\n\n            }\n\n            return normalize(v);\n\n        }\n\n        vec3 octDecode(vec2 encoded) {\n\n            return octDecode(encoded, 255.0);\n\n        }\n\n    #else\n\n        attribute vec3 NORMAL;\n\n    #endif\n\n    uniform vec3 lightDir;\n\n    uniform mat3 modelNormalMatrix;\n\n    uniform mat4 positionMatrix;\n\n    float getLambertDiffuse(vec3 lightDir, vec3 normal) {\n\n        return max(dot(-lightDir, normal), 0.0);\n\n    }\n\n#endif\n\n#ifdef PICKING_MODE\n\n    #include <fbo_picking_vert>\n\n#endif\n\n#include <draco_decode_vert>\n\nvoid main() {\n\n    #ifdef HAS_POSITION\n\n        vec3 localPos = decode_getPosition(POSITION);\n\n    #endif\n\n    gl_Position = projViewModelMatrix * vec4(localPos, 1.0);\n\n    gl_PointSize = pointSize;\n\n\n\n    #ifdef PICKING_MODE\n\n        fbo_picking_setData(gl_Position.w, true);\n\n    #else\n\n        #if defined(HAS_RGB)\n\n            vColor = vec4(RGB / 255.0, 1.0) * pointOpacity;\n\n        #elif defined(HAS_RGBA)\n\n            vColor = RGBA / 255.0 * pointOpacity;\n\n        #elif defined(HAS_RGB565)\n\n            float compressed = RGB565;\n\n            float r = floor(compressed * SHIFT_RIGHT_11);\n\n            compressed -= r * SHIFT_LEFT_11;\n\n            float g = floor(compressed * SHIFT_RIGHT_5);\n\n            compressed -= g * SHIFT_LEFT_5;\n\n            float b = compressed;\n\n            vec3 rgb = vec3(r * NORMALIZE_5, g * NORMALIZE_6, b * NORMALIZE_5);\n\n            vColor = vec4(rgb, 1.0);\n\n        #else\n\n            vColor = pointColor;\n\n        #endif\n\n\n\n        #ifdef HAS_NORMAL\n\n            mat3 positionNormalMatrix = mat3(positionMatrix);\n\n            mat3 normalMatrix = modelNormalMatrix * positionNormalMatrix;\n\n            #ifdef HAS_NORMAL_OCT16P\n\n                vec3 localNormal = octDecode(NORMAL_OCT16P);\n\n            #else\n\n                vec3 localNormal = NORMAL;\n\n            #endif\n\n            vec3 normal = normalize(normalMatrix * localNormal);\n\n            float colorStrength = getLambertDiffuse(lightDir, normal);\n\n            colorStrength = max(colorStrength, 0.5);\n\n            vColor *= colorStrength;\n\n        #endif\n\n    #endif\n\n\n\n\n\n\n\n\n\n}\n\n";const Rt=new Array(3),Nt=new Array(3),Dt=[40680631590769,40680631590769,40408299984661.445];function Ft(t,e,n,r){const i=Dt,s=Math.cos(n);Rt[0]=s*Math.cos(e),Rt[1]=s*Math.sin(e),Rt[2]=Math.sin(n),Wt(Rt,Rt),o["f"].multiply(Nt,i,Rt);const a=Math.sqrt(o["f"].dot(Rt,Nt));var l,h,c;return h=Nt,c=a,(l=Nt)[0]=h[0]/c,l[1]=h[1]/c,l[2]=h[2]/c,o["f"].scale(Rt,Rt,r),o["f"].add(t,Nt,Rt)}const Lt=[1/6378137,1/6378137,1/6356752.314245179],zt=[1/40680631590769,1/40680631590769,1/40408299984661.445],Bt=new Array(3),Ht=new Array(3),Ut=new Array(3);function jt(t,e){const n=zt,r=function(t,e,n,r,i){const s=e[0],a=e[1],l=e[2],h=n[0],c=n[1],u=n[2],f=s*s*h*h,d=a*a*c*c,p=l*l*u*u,A=f+d+p,g=Math.sqrt(1/A),m=o["f"].scale(Vt,e,g);if(A<i)return isFinite(g)?m:void 0;const y=r[0],v=r[1],x=r[2],b=Gt;b[0]=m[0]*y*2,b[1]=m[1]*v*2,b[2]=m[2]*x*2;let w,_,M,T,S,I,C,O,E,P,k,R=(1-g)*qt(e)/(.5*qt(b)),N=0;do{R-=N,M=1/(1+R*y),T=1/(1+R*v),S=1/(1+R*x),I=M*M,C=T*T,O=S*S,E=I*M,P=C*T,k=O*S,w=f*I+d*C+p*O-1,_=f*E*y+d*P*v+p*k*x,N=w/(-2*_)}while(Math.abs(w)>1e-12);return t[0]=s*M,t[1]=a*T,t[2]=l*S,t}(Bt,e,Lt,n,.1);let i=o["f"].mul(Ht,r,n);i=Wt(i,i);const s=o["f"].sub(Ut,e,r),a=Math.atan2(i[1],i[0]),l=Math.asin(i[2]),h=st(o["f"].dot(s,e))*qt(s);return t[0]=rt(a),t[1]=rt(l),t[2]=h,t}const Vt=new Array(3),Gt=new Array(3);function qt(t){return o["f"].length(t)}function Wt(t,e){const n=e[0],r=e[1],i=e[2];let s=n*n+r*r+i*i;return s>0&&(s=Math.sqrt(s),t[0]=e[0]/s,t[1]=e[1]/s,t[2]=e[2]/s),t}function Xt(t,e){return o["f"].multiply(e,t,zt),o["f"].normalize(e,e)}function Qt(t,e){const n=t[0],r=t[1],i=Math.cos(r),s=i*Math.cos(n),a=i*Math.sin(n),l=Math.sin(r);return e.x=s,e.y=a,e.z=l,o["f"].normalize(e,e)}Object.freeze({__proto__:null,radianToCartesian3:Ft,cartesian3ToDegree:jt,normalizeCartesian:Wt,geodeticSurfaceNormal:Xt,geodeticSurfaceNormalCartographic:Qt});function Yt(t,e,n,r){n=n||0,r=r||n;const i=Math.abs(t-e);return i<=r||i<=n*Math.max(Math.abs(t),Math.abs(e))}"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");function Zt(t,e,n,r){const{byteOffset:i,componentType:s,type:o}=t,{ctor:a,type:l}=ee(s||"UNSIGNED_SHORT"),h=$t(o);return{byteStride:0,byteOffset:i+n,itemSize:h,count:r*h,componentType:l,array:new a(e,n+i,r*h)}}function Kt(t,e,n,r){const{byteOffset:i,componentType:s,type:o}=t,{ctor:a}=ee(s||"UNSIGNED_SHORT"),l=$t(o),h=new a(e,i,n*l);return 1===l?h[r]:h.subarray(r*l,r*l+l)}const Jt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4};function $t(t){return t?Jt[t]:1}const te={BYTE:{ctor:Int8Array,type:5120,name:"Int8Array"},UNSIGNED_BYTE:{ctor:Uint8Array,type:5121,name:"Uint8Array"},SHORT:{ctor:Int16Array,type:5122,name:"Int16Array"},UNSIGNED_SHORT:{ctor:Uint16Array,type:5123,name:"Uint16Array"},INT:{ctor:Int32Array,type:5124,name:"Int32Array"},UNSIGNED_INT:{ctor:Uint32Array,type:5125,name:"Uint32Array"},FLOAT:{ctor:Float32Array,type:5126,name:"Float32Array"},DOUBLE:{ctor:Float64Array,type:5126,name:"Float64Array"}};function ee(t){return te[t]}const ne={up:{south:"east",north:"west",west:"south",east:"north"},down:{south:"west",north:"east",west:"north",east:"south"},south:{up:"west",down:"east",west:"down",east:"up"},north:{up:"east",down:"west",west:"up",east:"down"},west:{up:"north",down:"south",north:"down",south:"up"},east:{up:"south",down:"north",north:"up",south:"down"}},re={north:[-1,0,0],east:[0,1,0],up:[0,0,1],south:[1,0,0],west:[0,-1,0],down:[0,0,-1]},ie={},se={east:[],north:[],up:[],west:[],south:[],down:[]};let oe=[],ae=[],le=[];const he=[0,0,0];function ce(t,e,n){return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=t[3],n[4]=t[4],n[5]=t[5],n[6]=t[6],n[7]=t[7],n[8]=t[8],n[9]=t[9],n[10]=t[10],n[11]=t[11],n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=t[15],n}const ue=function(t,e){const n=ne[t][e];let r;const i=t+e;return ie[i]?r=ie[i]:(r=function(r,i,s){if(o["f"].equals(r,he))o["f"].copy(oe,re[t]),o["f"].copy(ae,re[e]),o["f"].copy(le,re[n]);else if(Yt(r[0],0,1e-14)&&Yt(r[1],0,1e-14)){const i=st(r[2]);o["f"].copy(oe,re[t]),"east"!==t&&"west"!==t&&o["f"].scale(oe,oe,i),o["f"].copy(ae,re[e]),"east"!==e&&"west"!==e&&o["f"].scale(ae,ae,i),o["f"].copy(le,re[n]),"east"!==n&&"west"!==n&&o["f"].scale(le,le,i)}else{Xt(r,se.up);const i=se.up,s=se.east;s[0]=-r[1],s[1]=r[0],s[2]=0,o["f"].normalize(se.east,s),o["f"].cross(se.north,i,s),o["f"].scale(se.down,se.up,-1),o["f"].scale(se.west,se.east,-1),o["f"].scale(se.south,se.north,-1),oe=se[t],ae=se[e],le=se[n]}return s[0]=oe[0],s[1]=oe[1],s[2]=oe[2],s[3]=0,s[4]=ae[0],s[5]=ae[1],s[6]=ae[2],s[7]=0,s[8]=le[0],s[9]=le[1],s[10]=le[2],s[11]=0,s[12]=r[0],s[13]=r[1],s[14]=r[2],s[15]=1,s},ie[i]=r),r}("east","north"),fe=[],de=[],pe=[],Ae=[],ge=[],me=[],ye=[],ve={x:0,y:0},xe={x:0,y:0},be=Math.PI/180;let we;const _e={width:100,height:10};function Me(){if(!we){const{width:t,height:e}=_e;OffscreenCanvas?we=new OffscreenCanvas(t,e):(we=document.createElement("canvas"),we.width=t,we.height=e)}return we}class Te{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,s=t.length;i<s;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},_e,e),this.t()}getImageData(){return this.imgData}t(){const t=Me(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:s,valueOffset:o}=this;for(let a=0,l=s.length;a<l;a++){const[t,e]=s[a],n=(t-this.min)/o;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t);const e=((t=Math.min(t,this.max))-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n;return[this.imgData.data[r],this.imgData.data[r+1],this.imgData.data[r+2],this.imgData.data[r+3]]}}var Se;function Ie(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function Ce(t,e){for(var n=0;n<t.stops.length&&!(e<t.stops[n][0]);n++);return t.stops[Math.max(n-1,0)][1]}function Oe(t,e){for(var n=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:function t(e,n,r,i,s,o){return"function"==typeof s?function(){var a=s.apply(void 0,arguments),l=o.apply(void 0,arguments);return t(e,n,r,i,a,l)}:s.length?function(t,e,n,r,i,s){var o=[];for(let a=0;a<i.length;a++)o[a]=Re(t,e,n,r,i[a],s[a]);return o}(e,n,r,i,s,o):Re(e,n,r,i,s,o)}(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}"function"==typeof Map&&(Se=new Map);const Ee={width:100,height:1};function Pe(t,e){const n=t.stops;if(n&&n.length>1){let t;if(Se){const e=JSON.stringify(n);if(!Se.has(e)){const t=new Te(n,Ee);Se.set(e,t)}t=Se.get(e)}else t=new Te(n,Ee);const[r,i,s,o]=t.getColor(e);return[r/255,i/255,s/255,o/255]}return n&&1===n.length?n[0][1]:null}function ke(t,e){return n=e,r=t.default,void 0!==n?n:void 0!==r?r:void 0!==i?i:null;var n,r,i}function Re(t,e,n,r,i,s){var o,a=r-n,l=t-n;return i*(1-(o=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1)))+s*o}function Ne(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function De(t){return function t(e,n){if(!Ne(e))return function(){return e};e=JSON.parse(JSON.stringify(e));let r=!0,i=!0;const s=e.stops;if(s)for(let a=0;a<s.length;a++)if(Ne(s[a][1])){const e=t(s[a][1],n);r=r&&e.isZoomConstant,i=i&&e.isFeatureConstant,s[a]=[s[a][0],e]}const o=function t(e,n){var r,i,s;if(Ne(e)){var o,a=e.stops&&"object"==typeof e.stops[0][0],l=a||void 0!==e.property,h=a||!l,c=e.type||n||"exponential";if("exponential"===c)o=Oe;else if("interval"===c)o=Ce;else if("categorical"===c)o=Ie;else if("identity"===c)o=ke;else{if("color-interpolate"!==c)throw new Error('Unknown function type "'+c+'"');o=Pe}if(a){var u={},f=[];for(let t=0;t<e.stops.length;t++){var d=e.stops[t];void 0===u[d[0].zoom]&&(u[d[0].zoom]={zoom:d[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[d[0].zoom].stops.push([d[0].value,d[1]])}for(let e in u)f.push([u[e].zoom,t(u[e])]);r=function(t,n){const r=Oe({stops:f,base:e.base},t)(t,n);return"function"==typeof r?r(t,n):r},i=!1,s=!1}else h?(r=function(t){const n=o(e,t);return"function"==typeof n?n(t):n},i=!0,s=!1):(r=function(t,n){const r=o(e,n?n[e.property]:null);return"function"==typeof r?r(t,n):r},i=!1,s=!0)}else r=function(){return e},i=!0,s=!0;return r.isZoomConstant=s,r.isFeatureConstant=i,r}(e,n);return o.isZoomConstant=r&&o.isZoomConstant,o.isFeatureConstant=i&&o.isFeatureConstant,o}(t,"exponential")}const{getTextureMagFilter:Fe,getTextureMinFilter:Le,getTextureWrap:ze,getMaterialType:Be,getMaterialFormat:He,getPrimitive:Ue,getUniqueREGLBuffer:je}=r["m"].REGLHelper,Ve=[1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1],Ge=[0,0,1,0,0,1,0,0,-1,0,0,0,0,0,0,1],{loginIBLResOnCanvas:qe,logoutIBLResOnCanvas:We,getIBLResOnCanvas:Xe,getPBRUniforms:Qe}=r["m"].pbr.PBRUtils,Ye={factor:0,units:0},Ze=[1,1,1,1],Ke=[0,0,0],Je={specularStrength:0,materialShininess:1},$e=[1,1,1],tn=r["k"].identity([]),en=[0,0,0],nn=[0,0],rn=t=>t.material instanceof r["m"].PhongMaterial,sn=t=>t.material instanceof r["m"].pbr.StandardMaterial,on=[],an=new e["f"](0,0),ln=new e["A"](0,0),hn=new e["A"](0,0),cn=new e["A"](0,0),un=[],fn=[],dn=[],pn=[],An=[],gn=[],mn=[],yn=[],vn=[],xn=[],bn=[],wn=[],_n=[],Mn=[],Tn={POSITION:"POSITION",NORMAL:"NORMAL",TEXCOORD_0:"TEXCOORD_0",TEXCOORD_1:"TEXCOORD_1",COLOR_0:"COLOR_0",TANGENT:"TANGENT",_BATCHID:"_BATCHID"},Sn=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],In=function(t,e){const n=2*Math.PI/t,r=[],i=[];for(let o=0;o<=t;o++){const t=Math.cos(n*o)*e,i=Math.sin(n*o)*e,s=0;r[3*o]=t,r[3*o+1]=i,r[3*o+2]=s}for(let o=t;o<=2*t;o++){const t=Math.cos(n*o)*e,i=Math.sin(n*o)*e,s=0;r[3*o]=s,r[3*o+1]=t,r[3*o+2]=i}for(let o=2*t;o<=3*t;o++){const t=Math.cos(n*o)*e,i=Math.sin(n*o)*e,s=0;r[3*o]=t,r[3*o+1]=s,r[3*o+2]=i}const s=r.length/3-1;for(let o=0;o<s;o++)o!==t-1&&o!==2*t-1&&(i[2*o]=o,i[2*o+1]=o+1);return r.push(0,0,0),r.push(e,0,0),r.push(0,e,0),r.push(0,0,e),i.push(s+1,s+2),i.push(s+1,s+3),i.push(s+1,s+4),{vertices:r,indices:i}}
/*!
 * @maptalks/gl v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */(100,1),Cn=[0,0,0,1],On=[1,1,1];class En{constructor(t,n){this.s=n,this.i=n.getRenderer().canvas,this.pickingFBO=n.getRenderer().pickingFBO,this.o=new e["G"],this.h=t,this.u=new r["m"].Renderer(t),this.m={},this.p={},this.v={},this.T={},this._={},this.M={},this.O=new r["m"].Scene,this.A=new r["m"].Scene,this.I=new r["m"].Scene,this.S=new r["m"].Scene,this.N=new r["m"].ResourceLoader(t.texture(2)),this.C=this.P.bind(this),this.R(),this.L=new r["m"].KHRTechniquesWebglManager(this.h,this.k(),this.N);const i=this.getMap();this.U=i.altitudeToPoint(100,i.getGLRes())/100}getI3DMMeshes(){return this.T}getPNTSMeshes(){return this.v}getB3DMMeshes(){return this.p}getPaintedMeshes(){return this.B}getMap(){return this.s.getMap()}paint(t,e,n,s){const o=s&&s.renderTarget,a=s&&s.sceneFilter,l=this.getMap();if(!t.length||!l)return null;const h=this.D(),c=l.projViewMatrix,u=[],f=[],d=[],p=[],A=[],g=this.F(t);for(let x=0,b=t.length;x<b;x++){const n=t[x].data.node;let o=this.j(n);if(!o)continue;const a=this.s.V(n.H),l=a.debugNodes,h=a.heightOffset||0,m=a.coordOffset||nn;this._[n.id]&&(o=this._[n.id],o=ht(o));let y=a.polygonOffset||Ye;$(y)&&(y=y()),Array.isArray(o)||(u[0]=o,o=u);for(let t=0,u=o.length;t<u;t++){const a=o[t].properties.magic;if(o[t].properties.heightOffset===h&&o[t].properties.coordOffset[0]===m[0]&&o[t].properties.coordOffset[1]===m[1]||(this.G(o[t]),o[t].q=r["k"].copy([],o[t].localTransform)),o[t].$=n,"b3dm"===a){if(o[t].getBoundingBox&&!Object(i["a"])(c,o[t].getBoundingBox()))continue;const{batchIdData:e,batchIdMap:n}=o[t].geometry.properties;if(e&&n){const e=o[t].properties.node.H;this.X&&this.X[e]?r["d"].highlightMesh(this.h,o[t],this.X[e],this.K,n):this.X&&this.X[e]||r["d"].highlightMesh(this.h,o[t],null,this.K,n),r["d"].showOnly(this.h,o[t],this.Y&&this.Y[e],this.J,n)}if(l&&l.length&&l.indexOf(o[t].$.id)<0)continue;s&&s.bloom&&o[t].properties.hlBloomMesh&&(o[t].properties.hlBloomMesh.properties.depthFunc="always",o[t].properties.hlBloomMesh.properties.polygonOffset=y,d.push(o[t].properties.hlBloomMesh)),d.push(o[t])}else"pnts"===a?p.push(o[t]):"i3dm"===a&&A.push(o[t]);o[t].properties.isLeaf=!!e[n.id],o[t].properties.level=g.get(n.Z),o[t].properties.polygonOffset=y,e[n.id]||f.push(o[t]),this.W(o[t]),this.tt(o[t],n)}}let m=0;const y=this.L.getExcludeFilter();m+=this.et(this.nt,h,[a,rn,y],o,f,d,A),m+=this.et(this.rt,h,[a,sn,y],o,f,d,A),this.L.forEachShader((t,e,n)=>{const r=this.D(n);m+=this.et(t,r,[a,e],o,f,d,A)}),this.A.setMeshes(p);const v=this.st();return m+=this.u.render(this.it,v,this.A,o&&o.fbo),this.B={pntsMeshes:p,i3dmMeshes:A,b3dmMeshes:d},this.S.setMeshes(n),this.u.render(this.ot,h,this.S,o&&o.fbo),m}et(t,e,n,r,i,s,o){t.filter=n.filter(t=>!!t),e.debug=!1,e.debug=!1;let a=0;return this.O.setMeshes(s),a+=this.u.render(t,e,this.O,r&&r.fbo),this.I.setMeshes(o),a+=this.u.render(t,e,this.I,r&&r.fbo),a}ct(t,e){return e.$.ht-t.$.ht}deleteTile(t){const e=t.node;e.ut&&(e.ut.geometry.dispose(),e.ut.dispose(),delete e.ut);const n=e.id;this.lt(n)}lt(t){const e=this.p[t]||this.v[t]||this.T[t]||this._[t]||this.m[t];this._[t]?this.ft(t):e&&(this.dt(e),delete this.p[t],delete this.v[t],delete this.T[t],delete this.m[t])}ft(t){let e=this._[t];e=ht(e);for(let n=0;n<e.length;n++){const{id:t}=e[n].properties;this.lt(t)}delete this._[t]}dt(t){if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)this.dt(t[e]);else{r["d"].showOnly(this.h,t),r["d"].highlightMesh(this.h,t);const e=t.geometry.properties.url;if(e){const n=this.M[e];n&&n.refMeshes&&(n.refMeshes.delete(t.uuid),n.refMeshes.size||(n.geometry.dispose(),n.material.dispose(),delete this.M[e]))}else t.geometry.dispose(),t.material&&t.material.dispose();t.dispose()}}remove(){const t=this.s;We(t.getRenderer().canvas,t.getMap());for(const e in this._)this.ft(e);this._={};for(const e in this.p)this.lt(e);this.p={};for(const e in this.v)this.lt(e);this.v={};for(const e in this.T)this.lt(e);this.T={};for(const e in this.m)this.lt(e);this.m={},this.nt&&(this.nt.dispose(),delete this.nt),this.rt&&(this.rt.dispose(),delete this.rt),this.it&&(this.it.dispose(),delete this.it),this.ot&&(this.ot.dispose(),delete this.ot),this.L.dispose(),this.picking&&this.picking.dispose()}j(t){return this.p[t.id]||this.v[t.id]||this.T[t.id]||this._[t.id]}has(t){return this.j(t)||this.m[t.id]}G(t){const e=t.properties.magic;"b3dm"===e?this.pt(t):"i3dm"===e?this.bt(t):"pnts"===e&&this.gt(t)}createPntsMesh(t,e,n,i){if(this.v[e]){const t=this.v[e];return console.warn(`pnts mesh with id(${e}) was already created.`),i(null,{id:e,mesh:t}),t}const{pnts:s,featureTable:o,rootIdx:a,compressed_int16_params:l}=t,h=o.POINTS_LENGTH;s.BATCH_ID||(s.BATCH_ID=new Uint8Array(h),s.BATCH_ID.fill(0));const c=new r["m"].Geometry(s,null,h,{static:!0,primitive:"points",positionAttribute:"POSITION",pickingIdAttribute:"BATCH_ID"});c.generateBuffers(this.h);const u={};s.POSITION?u.HAS_POSITION=1:s.POSITION_QUANTIZED&&(u.HAS_POSITION_QUANTIZED=1),s.RGB?u.HAS_RGB=1:s.RGBA?u.HAS_RGBA=1:s.RGB565&&(u.HAS_RGB565=1),(s.NORMAL||s.NORMAL_OCT16P)&&(u.HAS_NORMAL=1,s.NORMAL_OCT16P&&(u.HAS_NORMAL_OCT16P=1)),this.yt(u,l),t.featureTable.CONSTANT_RGBA&&(t.featureTable.CONSTANT_RGBA=t.featureTable.CONSTANT_RGBA.map(t=>t/255));const{rtcCenter:f,rtcCoord:d,projCenter:p}=t,A=this.s.V(a),g=new r["m"].Mesh(c);g.properties.magic="pnts",g.properties.id=e,g.properties.node=n,g.properties.count=h,g.properties.batchTable=t.batchTable,g.properties.batchTableBin=t.batchTableBin,g.properties.serviceIndex=a,g.properties.rtcCoord=d,g.properties.rtcCenter=f,g.properties.projCenter=p,g.setDefines(u),Object.defineProperty(g.uniforms,"pointColor",{enumerable:!0,get:function(){return t.featureTable.CONSTANT_RGBA?t.featureTable.CONSTANT_RGBA:A&&A.pointColor||[1,1,1,1]}});const m=this.getMap();let y=null,v=null;Object.defineProperty(g.uniforms,"pointSize",{enumerable:!0,get:function(){if(!A)return 2;if(Ne(A.pointSize)){const t=JSON.stringify(A.pointSize);return t!==y&&(v=De(A.pointSize),y=t),v(m.getZoom())}return A.pointSize||2}});let x=null,b=null;return Object.defineProperty(g.uniforms,"pointOpacity",{enumerable:!0,get:function(){if(!A)return 1;if(Ne(A.pointOpacity)){const t=JSON.stringify(A.pointOpacity);return t!==x&&(b=De(A.pointOpacity),x=t),b(m.getZoom())}return A.pointOpacity||1}}),this.wt(g,l),this.gt(g),g.q=r["k"].copy([],g.localTransform),this.v[e]=g,i(null,{id:e,mesh:[g]}),[g]}gt(t){const e=t.localTransform||[],{rtcCoord:n,node:r,projCenter:i}=t.properties;this.vt(e,n,i,r.H),t.setLocalTransform(e)}createI3DMMesh(t,e,n,i){if(this.T[e]){const t=this.T[e];return console.warn(`i3dm mesh with id(${e}) was already created.`),this.m[e]||i(null,{id:e,mesh:t}),t}const o=this.s.V(n.H),a=this.Tt(n._t),{i3dm:l,featureTable:h,gltf:c,batchTable:u,batchTableBin:f,count:d}=t,p=h.INSTANCES_LENGTH,{rtcCenter:A,rtcCoord:g,projCenter:m}=t,y=this.Mt(pn,n,A,g);ce(y,en,y);const v=r["k"].getRotation(An,y);r["l"].normalize(v,v);const x=r["k"].getScaling(gn,y),b=r["k"].fromScaling(mn,x),w=this.Ot(yn,m,n),_=this.xt(bn),M=this.At(wn,g),T=r["p"].div(_n,M,_),S=r["k"].fromScaling(Mn,T),{POSITION:I,NORMAL_UP:C,NORMAL_RIGHT:O,SCALE:E,SCALE_NON_UNIFORM:P}=l,k={instance_vectorA:new Float32Array(4*p),instance_vectorB:new Float32Array(4*p),instance_vectorC:new Float32Array(4*p),aPickingId:new Uint16Array(p)};for(let r=0;r<p;r++)k.aPickingId[r]=r;const R=new Float32Array(3),N=new Float32Array(3),D=[],F=new Float32Array(1),L=new Float32Array(3),z=[],B=[],H=[],U=[];!function(t,e){let{byteOffset:n,byteStride:r,count:i}=t;const{componentType:o,itemSize:a}=t,l=t.array.buffer,h=o?s["b"].getTypedArrayCtor(o):t.array.constructor;if(n=void 0===n?t.array.byteOffset:n,r=r||0,i=i||t.array.length/a,(!r||r===a*h.BYTES_PER_ELEMENT)&&n%h.BYTES_PER_ELEMENT==0){const t=new h(l,n,i*a);for(let r=0;r<i*a;r+=a)e(new h(t.buffer,n+r*h.BYTES_PER_ELEMENT,a),r/a);return}const c=new Uint8Array(a*h.BYTES_PER_ELEMENT);r||(r=a*h.BYTES_PER_ELEMENT);for(let s=0;s<i;s++){const t=new Uint8Array(l,r*s+n,a*h.BYTES_PER_ELEMENT);c.set(t),e(new h(c.buffer),s),t.set(c)}}(I,(t,e)=>{C?(Et(N,O,e),Et(R,C,e),r["p"].cross(D,N,R),r["p"].normalize(D,D),lt(z,N,0),lt(z,R,1),lt(z,D,2),r["l"].fromMat3(B,z),r["l"].normalize(B,B),r["l"].multiply(B,v,B)):r["l"].identity(B),E?(Et(F,E,e),r["p"].set(H,F[0],F[0],F[0])):P?(Et(L,P,e),r["p"].set(H,...L)):r["p"].set(H,1,1,1),r["k"].fromRotationTranslationScale(U,B,t,H),Pt(k.instance_vectorA,e,U,0),Pt(k.instance_vectorB,e,U,1),Pt(k.instance_vectorC,e,U,2)});const j={};for(const r in k)j[r]={buffer:this.h.buffer({dimension:k[r].length/p,data:k[r]}),divisor:1};const V=o.shader||"pbr";let G=0,q=!0;const W=[],X=[];return wt(c,(t,i,s,o)=>{const l=this.It(t,i,s,o,n,!0,V,X),{geometry:c,material:v}=l;v&&!v.isReady()&&(q=!1,G++);const x=new r["m"].InstancedMesh(j,p,c,v);l.refMeshes||(l.refMeshes=new Set,l.refMeshes.add(x.uuid)),x.properties.magic="i3dm",x.properties.id=e,x.properties.count=d,x.properties.batchTable=u,x.properties.batchTableBin=f,x.properties.serviceIndex=n.H,x.properties.rtcCoord=g,x.properties.rtcCenter=A,x.properties.projCenter=m,x.properties.node=n;const _=this.St(t,c,v,n.H,o);t.compressed_int16_params&&this.wt(x,t.compressed_int16_params),this.Et(x,t.attributes);const M=r["k"].identity([]);if(t.matrices&&t.matrices.length)for(let e=0;e<t.matrices.length;e++)r["k"].multiply(M,M,t.matrices[e]);r["k"].multiply(M,a,M),r["k"].multiply(M,S,M),h.EAST_NORTH_UP||C?r["k"].multiply(M,b,M):r["k"].multiply(M,y,M),x.setPositionMatrix(M),this.bt(x,w),x.setDefines(_),x.properties.polygonOffset={offset:0,factor:0},W.push(x),delete t.attributes,x.q=r["k"].copy([],x.localTransform)}),Pn(X),q?(this.T[e]=W,i(null,{id:e,mesh:W})):(this.m[e]={meshes:W,count:G},W.Nt=i),W}bt(t,e){const{rtcCoord:n,node:i,projCenter:s}=t.properties;e||(e=this.Ot(yn,s,i));const o=this.s.V(i.H),a=t.localTransform||[];if(o.coordOffset){const t=this.Ct(pn,i.H,n);r["k"].multiply(a,t,e)}else r["k"].copy(a,e);t.setLocalTransform(a),t.properties.heightOffset=o.heightOffset||0,t.properties.coordOffset=o.coordOffset&&o.coordOffset.slice(0)||nn}Ot(t,e,n){r["k"].fromScaling(t,this.xt(bn));const i=this.Pt(fn,e,n.H);return r["k"].multiply(t,r["k"].fromTranslation(vn,i),t),t}createB3DMMesh(t,n,i,s){if(t.gltf&&(t.gltf.transferables=null),this.p[n]||this.m[n]){const t=this.p[n];return console.warn(`mesh with id(${n}) was already created.`),this.m[n]||s(null,{id:n,mesh:t}),t}let o;if(i.maxExtent){const t=new e["k"](i.maxExtent).convertTo(t=>this._pointToPrj(t));o=[t.xmin,t.ymin,t.xmax,t.ymax]}const a=t.gltf,{projCenter:l}=a.extensions.MAPTALKS_RTC,{rtcCoord:h,center:c}=a.extensions.CESIUM_RTC,u=a.asset.sharePosition,f=this.Tt(i._t),d=this.Rt(yn,u,h,c,l,i),p=this.s.V(i.H);let A=p.shader||"pbr";if(p.unlit)A="phong";else if(a.materials)for(let e=0;e<a.materials.length;e++)if(a.materials[e]&&a.materials[e].extensions&&a.materials[e].extensions.KHR_materials_unlit){A="phong";break}const g=[],m=[];let y=0,v=!0;return wt(a,(e,s,a,x)=>{const b=this.It(e,s,a,x,i,!1,A,g),{geometry:w,material:_}=b;_&&!_.isReady()&&(v=!1,y++);const M=new r["m"].Mesh(w,_);b.refMeshes||(b.refMeshes=new Set,b.refMeshes.add(M.uuid)),M.properties.magic="b3dm",M.properties.id=n,M.properties.node=i,t.batchTable&&(M.properties.batchTable=t.batchTable,M.properties.batchTableBin=t.batchTableBin),M.properties.count=t.featureTable&&t.featureTable.BATCH_LENGTH||0,M.properties.serviceIndex=i.H;const T=this.St(e,w,_,i.H,x);M.setDefines(T);const S=e.compressUniforms;if(S)for(const t in S)M.setUniform(t,S[t]);e.compressed_int16_params&&this.wt(M,e.compressed_int16_params),this.Et(M,e.attributes),o&&(T.USE_MAX_EXTENT=1,M.setUniform("maxPrjExtent",o)),Object.prototype.hasOwnProperty.call(M.uniforms,"polygonOpacity")||Object.defineProperty(M.uniforms,"polygonOpacity",{enumerable:!0,get:function(){return et(p.opacity)?p.opacity:1}}),Object.prototype.hasOwnProperty.call(M.uniforms,"polygonFill")||Object.defineProperty(M.uniforms,"polygonFill",{enumerable:!0,get:function(){return At([],p.polygonFill||Ze)}}),Object.prototype.hasOwnProperty.call(M.material.uniforms,"hsv")||Object.defineProperty(M.material.uniforms,"hsv",{enumerable:!0,get:function(){return p.hsv||Ke}});const I=r["k"].identity([]);if(u&&e.matrices&&e.matrices.length)for(let t=0;t<e.matrices.length;t++)r["k"].multiply(I,I,e.matrices[t]);u&&r["k"].multiply(I,f,I),M.properties.node=i,M.properties.projCenter=l,M.properties.nodeMatrix=I,M.properties.isSharedPosition=u,M.properties.rtcCoord=h,M.properties.rtcCenter=c,this.pt(M,d),m.push(M),delete e.attributes,M.q=r["k"].copy([],M.localTransform)}),Pn(g),v?(this.p[n]=m,s(null,{id:n,mesh:m})):(this.m[n]={meshes:m,count:y},m.Nt=s),m}Lt(t){const e=this.s.kt[t.id];if(!e||t.ut)return;let n,i,s,o;if(e.length){if(2===e.length){const t=e[0],r=e[1];n=In.vertices,i=In.indices,s=t,o=[r,r,r]}}else n=e.boxPosition,i=Sn,s=e.boxCenter,o=On;const a=new r["m"].Geometry({POSITION:n},i,0,{primitive:"lines",positionAttribute:"POSITION"}),l=new r["m"].Mesh(a,new r["m"].Material({lineColor:[.8,.8,.1,1],lineOpacity:1})),h=[];r["k"].fromRotationTranslationScale(h,Cn,s,o),l.localTransform=h,l.q=r["k"].copy([],h),l.properties.node=t,t.ut=l}Ut(t){t.ut&&(t.ut.geometry.dispose(),t.ut.dispose(),delete t.ut)}wt(t,e){e.POSITION&&t.setUniform("compressedPositionRange",e.POSITION),e.TEXCOORD_0&&t.setUniform("compressedTexcoordRange_0",e.TEXCOORD_0),e.TEXCOORD_1&&t.setUniform("compressedTexcoordRange_1",e.TEXCOORD_0),e.NORMAL&&t.setUniform("compressedNormalRange",e.NORMAL),e.TANGENT&&t.setUniform("compressedTangentRange",e.TANGENT),e.compressed_ratio&&t.setUniform("compressed_ratio",e.compressed_ratio)}pt(t,e){const{isSharedPosition:n,rtcCoord:i,rtcCenter:s,projCenter:o,nodeMatrix:a,node:l}=t.properties;e||(e=this.Rt(e||yn,n,i,s,o,l));const h=t.localTransform||r["k"].identity([]);r["k"].multiply(h,e,a);const c=this.s.V(l.H);if(c.coordOffset){const t=this.Ct(pn,l.H,i);r["k"].multiply(h,t,h)}t.setLocalTransform(h),t.properties.heightOffset=c.heightOffset||0,t.properties.coordOffset=c.coordOffset&&c.coordOffset.slice(0)||nn}Rt(t,e,n,i,s,o){if(e){const e=this.At(wn,n),s=r["k"].fromScaling(dn,e),a=this.Mt(pn,o,i,n);r["k"].multiply(t,a,s)}else this.vt(t,n,s,o.H);return t}Et(t,e){if(e&&e.TEXCOORD_0&&e.TEXCOORD_0.extensions&&e.TEXCOORD_0.extensions.WEB3D_quantized_attributes){const n=e.TEXCOORD_0.extensions.WEB3D_quantized_attributes.decodeMatrix;t.setUniform("decodeMatrix",n)}}Mt(t,e,n,i){const s=this.getMap(),a=this.s.V(e.H).heightOffset||0,l=e.matrix?r["k"].copy(t,e.matrix):r["k"].identity(t);n&&ce(l,r["p"].transformMat4(on,n,l),l);const h=function(t,e,n,r,i,s,a){e=o["f"].copy(fe,e);const l=Ft(fe,e[0]*be,e[1]*be,e[2]),h=o["c"].getTranslation(de,n),c=r.ellipsoid;let u;u=0===o["f"].len(h)?o["f"].set(pe,0,0,-6378137):jt(pe,h),ve.x=u[0],ve.y=u[1];const f=r.project(ve,xe);Ae[0]=f.x/i,Ae[1]=f.y/i,Ae[2]=(u[2]+a)*s;const d=ue(l,c,ge);return ce(function(t,e,n){const r=t[0],i=t[1],s=t[2],o=t[4],a=t[5],l=t[6],h=t[8],c=t[9],u=t[10],f=e[0],d=e[1],p=e[2],A=e[3],g=e[4],m=e[5],y=e[6],v=e[7],x=e[8],b=r*f+o*d+h*p,w=i*f+a*d+c*p,_=s*f+l*d+u*p,M=r*A+o*g+h*m,T=i*A+a*g+c*m,S=s*A+l*g+u*m,I=r*y+o*v+h*x,C=i*y+a*v+c*x,O=s*y+l*v+u*x;return n[0]=b,n[1]=w,n[2]=_,n[3]=0,n[4]=M,n[5]=T,n[6]=S,n[7]=0,n[8]=I,n[9]=C,n[10]=O,n[11]=0,n[12]=t[12],n[13]=t[13],n[14]=t[14],n[15]=t[15],n}(o["c"].invert(me,d),o["b"].fromMat4(ye,n),t),Ae,t),t}(l,i,l,s.getProjection(),s.getGLRes(),this.U,a),c=function(t,e){return o["f"].set(t,e[12],e[13],e[14]),t}(fn,h);let u=this.s.options.offset;if($(u)){const t=this.s.Bt(e.id).center;u=u.call(this.s,t)}return r["p"].set(un,u[0],u[1],0),r["p"].sub(c,c,un),ce(h,c,h),h}Ct(t,e,n){const i=this.s.V(e);if(!i.coordOffset)return null;const s=this.getMap(),o=s.getGLRes();an.set(n[0],n[1]);const a=s.coordToPointAtRes(an,o,hn),l=i.coordOffset,h=an.set(n[0]+l[0],n[1]+l[1]),c=s.coordToPointAtRes(h,o,cn),u=c.x-a.x,f=c.y-a.y,d=this.U,p=r["p"].set(un,u,f,(l[2]||0)*d);return r["k"].fromTranslation(t,p)}createCMPTMesh(t,e,n,r){if(this._[e]){const t=this._[e];return console.warn(`mesh with id(${e}) was already created.`),r(null,{id:e,mesh:t}),t}const{content:i}=t,s=[];for(let o=0;o<i.length;o++){const{magic:t}=i[o],r=e+"."+o;"b3dm"===t?this.createB3DMMesh(i[o],r,n,(t,{mesh:e})=>{s.push(e)}):"i3dm"===t?this.createI3DMMesh(i[o],r,n,(t,{mesh:e})=>{s.push(e)}):"pnts"===t?this.createPntsMesh(i[o],r,n,(t,{mesh:e})=>{s.push(e)}):"cmpt"===t&&this.createCMPTMesh(i[o],r,n,(t,{mesh:e})=>{s.push(e)})}return this._[e]=s,r(null,{id:e,mesh:s}),s}St(t,e,n,r,i){const s=("phong"===(this.s.V(r).shader||"pbr")?this.nt:this.rt).getGeometryDefines(e);return i.asset&&"S3M"===i.asset.generator&&this.Dt(s,e),e.data.uvRegion&&(s.HAS_I3S_UVREGION=1),e.data[e.desc.normalAttribute]&&(s.VertexNormal=1),e.data[e.desc.color0Attribute]&&(s.VertexColor=1),e.data[e.desc.uv0Attribute]&&(s.TexCoord=1),e.data[e.desc.textureCoordMatrixAttribute]&&(s.HAS_TextureCoordMatrix=1),n.get("uTexture")&&(s.COMPUTE_TEXCOORD=1),n.get("uTexture2")&&(s.TexCoord2=1),"MESHOPT"===this.s.zt&&(s.MeshOPT_Compress=1),this.hasIBL()&&(s.HAS_IBL_LIGHTING=1),t.attributes&&t.attributes.TEXCOORD_0&&"WEB3D_quantized_attributes"===t.attributes.TEXCOORD_0.extensions&&(s.HAS_WEB3D_quantized_attributes_TEXCOORD=1),s.HAS_MIN_ALTITUDE=1,s.HAS_LAYER_OPACITY=1,this.yt(s,t.compressed_int16_params),J(s,t.compressDefines),s}yt(t,e){e&&Object.keys(e).length>0&&(t.HAS_COMPRESSED_INT16=1,e.POSITION&&(t.HAS_COMPRESSED_INT16_POSITION=1),e.TEXCOORD_0&&(t.HAS_COMPRESSED_INT16_TEXCOORD_0=1),e.TEXCOORD_1&&(t.HAS_COMPRESSED_INT16_TEXCOORD_1=1),e.NORMAL&&(t.HAS_COMPRESSED_INT16_NORMAL=1),e.TANGENT&&(t.HAS_COMPRESSED_INT16_TANGENT=1),e.compressed_ratio&&(t.HAS_COMPRESSED_INT16_RATIO=1))}W(t){const e=this.s.getRenderer();e&&e.updateMaskDefines(t)}Dt(t,e){e.data.aNormal&&(t.VertexNormal=1),e.data.instanceId&&(t.Instance=1),e.data.aTexCoord0&&(t.TexCoord=1),e.data.aColor&&(t.VertexColor=1),e.data.aTexCoord1&&(t.TexCoord2=1),e.data.uv2&&(t.InstanceBim=1)}It(t,e,n,i,s,o,a,l){let h=!1;i.asset&&"S3M"===i.asset.generator&&(h=!0,i.extensions=i.extensions||{});const c=i.url+"-"+e+"-"+n;if(this.M[c])return this.M[c];let u,f;l.push(t);const d=i.materials&&i.materials[t.material],p=i.extensions&&i.extensions.KHR_techniques_webgl,A=this.s.V(s.H);if(p&&d.extensions&&d.extensions.KHR_techniques_webgl){const e=this.Ft(t,i,o,h);u=e.material,f=e.geometry,A.fillEmptyDataInMissingAttribute&&(f.desc.fillEmptyDataInMissingAttribute=!0)}else{f=this.jt(t,o,Tn);const e=A.ambientLight;let n=A.environmentExposure;const r=A.material,s=this.getMap().getLightManager(),h=s&&s.getAmbientLight();if(e&&(!h||h.color)&&void 0===n){const t=h&&h.color?h.color[0]:.2;n=e[0]/t}u=this.Vt(t.material,i,a,r||Je,n||1,l,A)}u&&Object.defineProperty(u.uniforms,"alphaTest",{enumerable:!0,get:function(){const t=A.alphaTest;return K(t)?.1:t}}),u&&!u.isReady()?u.Ht=s.id:u||(u=new r["m"].PhongMaterial({baseColorFactor:[1,1,1,1]}));const g={geometry:f,material:u};return f.properties.url=c,this.M[c]=g,g}Ft(t,e,n,r){const{geometry:i,material:s}=this.L.createMesh(t,e,n,r);return{geometry:i,material:s}}jt(t,e,n){const i=t.attributes;let s=i._BATCHID&&i._BATCHID.array;if(s&&s.byteOffset&&(s=new s.constructor(s)),i.COLOR_0){const t=i.COLOR_0.array||i.COLOR_0;if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);i.COLOR_0.array?(i.COLOR_0.array=e,i.COLOR_0.componentType=5121):i.COLOR_0=e}}const o={};for(const r in i){const t=je(this.h,i[r],{dimension:i[r].itemSize}),e=n[r]||r;o[e]={buffer:t},i[r].quantization&&(o[e].quantization=i[r].quantization),e===n.POSITION&&(o[e].array=i[r].array,o[e].min=i[r].min,o[e].max=i[r].max)}const a=t.indices?t.indices.array?t.indices.array.slice():t.indices:null,l=new r["m"].Geometry(o,a,0,{static:!0,positionAttribute:n.POSITION,normalAttribute:n.NORMAL,uv0Attribute:n.TEXCOORD_0,uv1Attribute:n.TEXCOORD_1,color0Attribute:n.COLOR_0,tangentAttribute:n.TANGENT,pickingIdAttribute:n._BATCHID,primitive:void 0===t.mode?"triangles":Ue(t.mode)});return s&&a&&(l.properties.batchIdData=s,l.properties.batchIdMap=function(t,e){if(!e)return null;const n=new Map;for(let r=0;r<e.length;r++){const i=e[r],s=t[i];let o=n.get(s);o||(o=[],n.set(s,o)),o.push(i)}return n}(s,a)),l.generateBuffers(this.h,{excludeElementsInVAO:e}),l}vt(t,e,n,i){const s=r["k"].identity(t),o=this.xt($e);return this.Pt(fn,n,i),r["k"].translate(s,s,fn),r["k"].scale(s,s,o),s}Pt(t,e,n){const i=this.U;an.x=e[0],an.y=e[1];const s=this._prjToPoint(an);let o=this.s.options.offset;$(o)&&(o=o.call(this.s,an));const a=this.s.V(n).heightOffset||0;return r["p"].set(t,s.x-o[0],s.y-o[1],i*e[2]+i*a),t}tt(t,e){const n=this.s.Gt(xn,e);t.localTransform=r["k"].multiply(t.localTransform,n,t.q)}At(t,e){const n=this.getMap();an.x=e[0],an.y=e[1];const i=n.distanceToPointAtRes(100,100,n.getGLRes(),an),s=this.U;return r["p"].set(t,i.x/100,i.y/100,s),t}R(){const t={x:0,y:0,width:()=>this.i?this.i.width:1,height:()=>this.i?this.i.height:1},e=[],n=[];this.it=new r["m"].MeshShader({vert:kt,frag:"#define SHADER_NAME PNTS\n\nprecision mediump float;\n\n\n\nvarying vec4 vColor;\n\n\n\nvoid main() {\n\n    vec2 circCoord = 2.0 * gl_PointCoord - 1.0;\n\n    if (dot(circCoord, circCoord) > 1.0) {\n\n        discard;\n\n    } else {\n\n        gl_FragColor = vColor;\n\n    }\n\n}\n\n",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>r["k"].multiply(n,e.projViewMatrix,e.modelMatrix)},{name:"modelNormalMatrix",type:"function",fn:(t,n)=>r["j"].fromMat4(e,n.modelMatrix)}],extraCommandProps:{viewport:t,blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},depth:{enable:!0,range:[0,1],func:"<"}}});const i=this.k();this.nt=new r["m"].PhongShader({extraCommandProps:i}),this.rt=new r["m"].pbr.StandardShader({extraCommandProps:i}),this.ot=new r["m"].EdgeShader({extraCommandProps:{viewport:{x:0,y:0,width:()=>this.i?this.i.width:1,height:()=>this.i?this.i.height:1},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}});const s=this.s;qe(s.getRenderer().canvas,this.h,s.getMap()),this.picking=new r["m"].FBORayPicking(this.u,{vert:this.rt.vert,extraCommandProps:i,uniforms:this.rt.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap()),this.qt=new r["m"].FBORayPicking(this.u,{vert:kt,extraCommandProps:i,uniforms:this.it.uniforms,defines:{PICKING_MODE:1,ENABLE_PICKING:1,HAS_PICKING_ID:1}},this.pickingFBO,this.getMap())}k(){return{viewport:{x:0,y:0,width:()=>this.i?this.i.width:1,height:()=>this.i?this.i.height:1},cull:{enable:!0},stencil:{enable:!0,func:{cmp:(t,e)=>e.meshProperties.isLeaf?"always":">=",ref:(t,e)=>e.meshProperties.level},opFront:{fail:"keep",zfail:"keep",zpass:"replace"},opBack:{fail:"keep",zfail:"keep",zpass:"replace"}},depth:{enable:!0,range:[0,1],func:(t,e)=>e.meshProperties.depthFunc||"<"},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:(t,e)=>e.meshProperties.polygonOffset}}}st(t){const e=this.getMap(),n=e.getLightManager(),i=(n&&n.getDirectionalLight()||{}).direction||[1,1,-1],s=t&&t.pointOpacity||1;return{projViewMatrix:e.projViewMatrix,pointOpacity:s,lightDir:r["p"].normalize(i,i)}}D(){const t=this.getMap(),e=this.s,n=e.getRenderer().canvas,{iblTexes:r,dfgLUT:i}=Xe(n),s=Qe(t,r,i),o=this.s.getRenderer(),a=o.getMaskUniforms();s.minAltitude=e.options.altitude||0;const l=o.canvas.gl&&o.canvas.gl.wrap?e.options.opacity||0:1;return s.layerOpacity=l,J(s,{czm_lightDirectionEC:s.light0_viewDirection,lightSpecular:[1,1,1],viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[n.width,n.height],polygonFill:[1,1,1,1],polygonOpacity:1}),J(s,a),s}Vt(t,e,n,i,s,o,a){const l=e.materials&&e.materials[t];if(!l||!l.baseColorTexture&&!l.pbrMetallicRoughness)return null;const h=J({},i);if(l.baseColorTexture){const t=e.textures[l.baseColorTexture.index];let n;t&&!t.image.color&&(n=this.$t(t,o)),h.baseColorFactor=t&&t.image.color||l.baseColorFactor||[1,1,1,1],n&&(h.baseColorTexture=n)}else{if(l.normalTexture){const t=this.$t(e.textures[l.normalTexture.index],o);if(t){const e=l.normalTexture.scale||1;h.normalTexture=t,h.normalMapFactor=e}}if(l.occlusionTexture){const t=this.$t(e.textures[l.occlusionTexture.index],o);if(t){const e=l.occlusionTexture.strength||1;h.occlusionTexture=t,h.occlusionFactor=e}}if(l.emissiveTexture){const t=this.$t(e.textures[l.emissiveTexture.index],o);t&&(h.emissiveTexture=t)}l.emissiveFactor&&(h.emissiveFactor=l.emissiveFactor);const t=l.pbrMetallicRoughness;if(t){if(t.baseColorFactor&&(h.baseColorFactor=t.baseColorFactor),t.baseColorTexture&&void 0!==t.baseColorTexture.index){const n=e.textures[t.baseColorTexture.index];if(n.image&&n.image.color)h.baseColorFactor=h.baseColorFactor?r["q"].multiply(h.baseColorFactor,h.baseColorFactor,n.image.color):n.image.color;else{const t=this.$t(n,o);t&&(h.baseColorTexture=t,h.baseColorTexture.getREGLTexture(this.h))}}if(K(t.metallicFactor)||(h.metallicFactor=t.metallicFactor),K(t.roughnessFactor)||(h.roughnessFactor=t.roughnessFactor),l.metallicRoughnessTexture){const t=this.$t(e.textures[l.metallicRoughnessTexture.index],o);t&&(h.metallicRoughnessTexture=t)}}}if(l.s3mMaterial)return new r["m"].Material(h);if(h.environmentExposure=s,h.alphaTest=.1,a.unlit||l.extensions&&l.extensions.KHR_materials_unlit)return h.ambientColor=[1,1,1],h.light0_diffuse=[0,0,0,0],h.lightSpecular=[0,0,0],new r["m"].PhongMaterial(h);let c=new r["m"].pbr.StandardMaterial(h);"phong"===n&&(c=r["m"].PhongMaterial.convertFrom(c));const u=l.pbrMetallicRoughness,f=u&&u.baseColorTexture&&u.baseColorTexture.extensions;return f&&f.KHR_texture_transform&&(c.set("khr_offset",f.KHR_texture_transform.offset||[0,0]),c.set("khr_rotation",f.KHR_texture_transform.rotation||0),c.set("khr_scale",f.KHR_texture_transform.scale||[1,1])),c.doubleSided=!(!a.doubleSided&&!l.doubleSided),c.once("complete",this.C),c}$t(t,e){const n={type:t.type?Be(t.type):"uint8",format:t.format?He(t.format):"rgba",flipY:!!t.flipY},i=t.image;if(e.push(i),i.array?n.data=i.array:i.mipmap&&(n.mipmap=i.mipmap),!n.data&&!n.mipmap)return null;if(n.width=i.width,n.height=i.height,n.mipmap&&(n.width<4||n.height<4))return null;const s=t.sampler||t.texture&&t.texture.sampler;return s&&(s.magFilter&&(n.mag=Fe(s.magFilter)),s.minFilter&&(n.min=Le(s.minFilter)),s.wrapS&&(n.wrapS=ze(s.wrapS)),s.wrapT&&(n.wrapT=ze(s.wrapT))),new r["m"].Texture2D(n,this.N)}P({target:t}){const e=t.Ht,n=this.m[e];if(n.count--,!n.count){const t=n.meshes;this.p[e]=t,delete this.m[e];const r=t.Nt;delete t.Nt,r(null,{mesh:n.meshes,id:e})}}xt(t){const e=1/this.getMap().getGLRes(),n=this.U;return t[0]=t[1]=e,t[2]=n,t}Xt(t){return this.s.Xt(t)}_pointToPrj(t){const e=this.getMap();return e.getGLZoom?e._pointToPrj(t,e.getGLZoom()):e._pointToPrjAtRes(t,e.getGLRes())}_prjToPoint(t){const e=this.getMap();return e.getGLZoom?e._prjToPoint(t,e.getGLZoom()):e._prjToPointAtRes(t,e.getGLRes(),ln)}Tt(t){return"Y"===t?Ve:"X"===t?Ge:tn}pick(t,e,n=3){const r=this.s;if(!r||!r.options.picking)return[];if(!this.pickingFBO||!this.picking)return[];const i=[],s=this.D(),o=this.Kt(this.picking,s,this.O,t,e,n);o&&i.push(o);const a=this.Kt(this.picking,s,this.I,t,e,n);a&&i.push(a);const l=this.st(),h=this.Kt(this.qt,l,this.A,t,e,n);return h&&i.push(h),i}Kt(t,e,n,r,i,s){if(!n.getMeshes().length)return null;const o=this.s,a=this.getMap();t.render(n.getMeshes().filter(t=>!t.bloom),e,!0);let l={};t.getRenderedMeshes().length&&(l=t.pick(r,i,s,e,{viewMatrix:a.viewMatrix,projMatrix:a.projMatrix,returnPoint:o.options.pickingPoint}));const{meshId:h,pickingId:c,point:u,coordinate:f}=l,d=(0===h||h)&&t.getMeshAt(h);if(!d||!d.geometry)return null;const p=d.properties;u&&u.length&&(u[0]=Math.round(1e5*u[0])/1e5,u[1]=Math.round(1e5*u[1])/1e5,u[2]=Math.round(1e5*u[2])/1e5);const A={batchId:c},g=o.options.services,m=g&&g[d.properties.serviceIndex];if(m&&m.debug&&(A.debugInfo=p),p&&p.batchTable){const{batchTable:t,batchTableBin:e,count:n}=p,r=c;for(const i in t)void 0!==t[i].byteOffset?A[i]=Kt(t[i],e,n,r):A[i]=t[i][r]}return{service:d.properties.serviceIndex,data:A,point:u,coordinate:f}}F(t){let e=new Set;for(let i=0,s=t.length;i<s;i++){const n=t[i].data.node;this.j(n)&&e.add(n.Z)}e=Array.from(e),e.sort();const n=new Map,r=e.length;for(let i=0;i<r;i++)n.set(e[i],i);return n}highlight(t){this.X=t;const e=this.s.getRenderer();this.K=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelAllHighlight(){this.X=null;const t=this.s.getRenderer();this.K=t.getFrameTimestamp(),t.setToRedraw(!0)}showOnly(t){this.Y=t;const e=this.s.getRenderer();this.J=e.getFrameTimestamp(),e.setToRedraw(!0)}cancelShowOnly(){this.Y=null;const t=this.s.getRenderer();this.J=t.getFrameTimestamp(),t.setToRedraw(!0)}Yt(){if(!this.B)return[];const t={},e=[];for(const n in this.B){const r=this.B[n];if(r)for(let n=0;n<r.length;n++){const i=r[n],s=i&&i.geometry;if(!i||!s)continue;const o=i.properties.serviceIndex;t[o]||(t[o]=new Set);const a=s.properties.batchIdData;if(a)for(let n=0;n<a.length;n++)t[o].has(a[n])||(e.push({id:a[n],service:o}),t[o].add(a[n]))}}return e}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}}function Pn(t){for(let e=0;e<t.length;e++)t[e]&&(t[e].array&&(t[e].array=null),t[e].mipmap&&(t[e].mipmap=null),t[e].indices&&(t[e].indices=null))}const kn=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof t)return t;throw new Error("unable to locate global object")},Rn=kn(),Nn=Rn.gl_trans__coders=Rn.gl_trans__coders||{};function Dn(t,e){if(e)for(let n=0;n<e.length;n++)t[e[n].id||e[n].index]=e[n]}Nn.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=Rn.gl_trans__coders=Rn.gl_trans__coders||{};let s=`${r}\n    const _____getGlobal = ${kn.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const o in i)"inject"!==o&&"getTranscoder"!==o&&"registerTranscoder"!==o&&(s+='tran_____scoders["'+o+'"] ='+i[o].toString()+"\n;");return s+="\n"+e.substring(r.length),s},Nn.registerTranscoder=function(t,e){Nn[t]=e},Nn.getTranscoder=function(t){return Nn[t]};const Fn=[];class Ln{constructor(t,e,n,r,i){this.s=r,this.Jt=t,this.H=e,this.Qt=i,this.Zt=n.version,t.indexOf("i3s:tileset:")<0?(this.Zt<=1.6?this.Wt="root":this.Wt=0,n.version=this.Zt):(this.Wt=t.substring("i3s:tileset:".length),this.Zt>1.6&&(this.Wt=parseInt(this.Wt))),this.Jt=t,this.te=n}load(){const t=this.te,e=t.layerScene.baseUrl;if(this.Zt<=1.6)return t[this.Wt]&&t[this.Wt].lodSelection?(this.ee=t[this.Wt],this.ne()):new Promise(n=>{let r=e+"/nodes/"+this.Wt;t.layerScene.eslpk&&(r+="/3dNodeIndexDocument.json"),this.Qt(this.H,r,()=>{this.ee=t[this.Wt],n(this.ne())})});if(this.Zt>=1.7){if(t[this.Wt])return this.ee=t[this.Wt],this.ne();const n=Math.floor(this.Wt/t.nodesPerPage);return new Promise(r=>{let i=e+"/nodepages/"+n;t.layerScene.eslpk&&(i+=".json"),this.Qt(this.H,i,()=>{this.ee=t[this.Wt],r(this.ne())})})}return null}getTileset(){return this.re}getChildrenURL(){return this.se}ne(){const t=this.te,e=t.layerScene.baseUrl,n=this.ee.children,r=[],i={};if(n)for(let s=0;s<n.length;s++)if(this.Zt<=1.6){const o=n[s].id;if(t[o])continue;const a=o;i[a]||(i[a]=new Promise(n=>{let r=e+"/nodes/"+a;t.layerScene.eslpk&&(r+="/3dNodeIndexDocument.json"),this.Qt(this.H,r,()=>{n()})}),r.push(i[a]))}else{const o=n[s];if(t[o])continue;const a=Math.floor(o/t.nodesPerPage);i[a]||(i[a]=new Promise(n=>{let r=e+"/nodepages/"+a;t.layerScene.eslpk&&(r+=".json"),this.Qt(this.H,r,()=>{n()})}),r.push(i[a]))}return r.length?Promise.all(r).then(()=>this.ie()):this.ie()}ie(){return Promise.resolve(this.oe())}ae(t){Dn(this.te,t)}oe(){return{asset:{i3s:!0,version:"1.0",gltfUpAxis:"Z"},geometricError:Number.MAX_VALUE,root:this.ce(this.ee,!0)}}ce(t){const e=this.s.getRenderer(),n=this.te.projection,r=!n||n&&4326===n.wkid,i=this.Zt,s=this.te,a=t,l=a.obb,h=a.mbs,c={};let u;if(h)u=o["f"].set([],h[0],h[1],h[2]),r||(u=e.he(u,u)),u=zn([],u[0],u[1],u[2]),c.sphere=[...u,h[3]];else if(l){u=o["f"].set([],l.center[0],l.center[1],l.center[2]),r||(u=e.he(u,u)),u=zn([],u[0],u[1],u[2]);const t=function(t,e,n){const r=o["b"].fromQuat([],n);return r[0]=r[0]*e[0],r[1]=r[1]*e[0],r[2]=r[2]*e[0],r[3]=r[3]*e[1],r[4]=r[4]*e[1],r[5]=r[5]*e[1],r[6]=r[6]*e[2],r[7]=r[7]*e[2],r[8]=r[8]*e[2],[...t,...r]}(u,l.halfSize,l.quaternion),n=t[3]+t[6]+t[9],i=t[4]+t[7]+t[10],s=t[5]+t[8]+t[11];o["f"].set(Fn,n,i,s);const a=o["f"].len(Fn);c.sphere=[...u,a]}let f=1/0,d=0;if(a.mbs?d=a.mbs[3]:a.obb&&(d=Math.max(Math.max(a.obb.halfSize[0],a.obb.halfSize[1]),a.obb.halfSize[2])),void 0!==a.lodThreshold)"maxScreenThresholdSQ"===s.lodSelectionMetricType?f=d/(Math.sqrt(a.lodThreshold)/(.25*Math.PI)):console.error("Unsupported lodSelectionMetricType in Layer");else if(void 0!==a.lodSelection)for(let o=0;o<a.lodSelection.length;o++)"maxScreenThreshold"===a.lodSelection[o].metricType&&(f=d/a.lodSelection[o].maxError);(f===1/0||isNaN(f))&&(f=1e5);const p=16*f,A=o["c"].identity([]),g=a.children;let m;if(g){m=[];const t=this.te;for(let e=0;e<g.length;e++){const n=i<=1.6?g[e].id:g[e];if(!t[n]){m=null;break}m.push(this.ce(t[n]))}}const y={refine:"REPLACE",boundingVolume:c,transform:A,geometricError:p};return i<=1.6?t.lodSelection?t.geometryData&&(y.content={uri:"i3s:mesh:"+(t.id||t.index)}):y.content={uri:"i3s:tileset:"+(t.id||t.index)}:g&&g.length&&!m?y.content={uri:"i3s:tileset:"+(t.id||t.index)}:a.mesh&&(y.content={uri:"i3s:mesh:"+(t.id||t.index)}),m&&m.length&&(y.children=m),y}getJSON(){return this.ee}}function zn(t,e,n,r){return Ft(t,nt(e),nt(n),r)}const Bn=!!Nn.ktx2,Hn=r["k"].identity([]),Un=(()=>{try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1})();function jn(t){return t.indexOf("i3s:mesh")>=0}const Vn="i3s:mesh:".length;function Gn(t,e,n,r,i){const s=e.layerScene.eslpk,o=function(t,e){const n=e.substring(Vn);return t>=1.7?parseInt(n):n}(e.version,t),a=e[o],l=e.layerScene.baseUrl,h=[];let c=!1;const u=Hn;let f,d;if(e.version<=1.6){if(!a.geometryData)return null;const t=a.geometryData.length;if(!t)return null;let n=l+`/nodes/${a.id}/`+a.geometryData[t-1].href;s&&(n+=".bin");const r={geometry:{url:n,info:e.layerScene.store.defaultGeometrySchema}};let i=a.textureData&&a.textureData[0]&&a.textureData[0].href;if(i){const t=e.layerScene.store.textureEncoding[0];let n;n="image/jpeg"===t?"jpg":"png",s&&(i+="."+n);const o={pbrMetallicRoughness:{baseColorTexture:{url:l+`/nodes/${a.id}/`+i,factor:1,format:n,mimeType:t},metallicFactor:0}};r.material=o}h.push(r)}else{f=a.mesh.geometry,d=a.mesh.material;const t=e.layerScene.geometryDefinitions[f.definition],{geometryBuffers:o}=t;c=r&&2===o.length;const u=Nn.draco&&c?o[1]:o[0],p=Nn.draco&&c?1:0;let A=l+`/nodes/${f.resource}/geometries/`+p;s&&(A+=".bin");const g={geometry:{url:A,info:u}};if(i&&Un&&c&&!Nn.draco)throw new Error("Must import @maptalks/transcoder.draco to load i3s draco compressed geometry");const m=e.layerScene.materialDefinitions,y=e.layerScene.textureSetDefinitions;let v,x=0;d&&(x=m[d.definition]),v=m?function(t,e,n,r,i,s){const o=JSON.parse(JSON.stringify(t));return function t(e,n,r,i,s,o){for(const a in e)if(e[a]&&e[a].textureSetDefinitionId>=0){const t=n[e[a].textureSetDefinitionId],l="images/"+t.formats[0].format,h=qn(t.formats,s),c={url:r+`/nodes/${i}/textures/${h.name}`,factor:void 0===e[a].factor?1:e[a].factor,format:h.format,mimeType:l};if(o){let t="";switch(h.format){case"dds":t="bin.dds";break;case"jpg":case"png":t=h.format}c.url+="."+t}e[a]=c}else tt(e[a])&&t(e[a],n,r,i,s,o)}(o,e,n,r,i,s),o}(x,y,l,d.resource,n,e.layerScene.eslpk):{pbrMetallicRoughness:{metallicFactor:0}},g.material=v,h.push(g)}return{dracoCompression:c,meshes:h,nodeIndex:o,center:a.obb&&a.obb.center||a.mbs&&[a.mbs[0],a.mbs[1],a.mbs[2]],transform:u}}function qn(t,e){for(let n=0;n<=t.length;n++){const r=t[n].format;if("dds"===r&&e.hasExtension("WEBGL_compressed_texture_s3tc"))return t[n];if("jpg"===r||"png"===r)return t[n];if("ktx2"===r&&Bn)return t[n]}return null}const Wn=new e["f"](0,0),Xn=new e["f"](0,0),Qn=new Set,Yn=[],Zn=new class{constructor(t,e){this.max=t,this.currentSize=0,this.data=new Map,this.onRemove=e}reset(t){if(this.data){const e=this.data.keys();for(const n of e){const e=this.data.get(n);t&&t!==e.renderer||this.ue(n,e)}}return t||(this.data=new Map,this.currentSize=0),this}clear(t){this.reset(t)}add(t,e){if(!e)return this;if(e.node&&e.node.memorySize&&(this.currentSize+=e.node.memorySize),this.has(t)){const n=this.data.get(t);n&&n.node&&n.node.memorySize&&(this.currentSize-=n.node.memorySize),this.data.delete(t),this.data.set(t,e)}else this.data.set(t,e);return this}shrink(){if(this.currentSize>this.max){let t=!1;const e=this.data.keys();let n=e.next();for(;this.currentSize>this.max&&void 0!==n.value;){!t&&this.data.get(n.value).current&&(t=!0,console.warn(`current maxGPUMemory(${this.max/1024/1024}) for Geo3DTilesLayer is not enough, one or more current tiles will be discarded.`));const r=this.getAndRemove(n.value);r&&this.onRemove(r),n=e.next()}}}has(t){return this.data.has(t)}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const r of n)t[e++]=r;return t}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),e}get(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),this.data.set(t,e),e}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.ue(t,e),this}ue(t,e){e.node&&e.node.memorySize&&(this.currentSize-=e.node.memorySize),this.data.delete(t),this.onRemove(e)}setMaxSize(t){return this.max=t,this.shrink(),this}getMemorySize(){let t=0;const e=this.data.values();for(const n of e){const e=n&&n.node;e&&e.memorySize&&(t+=e.memorySize)}return t}markAll(t,e){const n=this.data.values();for(const r of n)t&&r.renderer!==t||(r.current=e)}}(1024*(e["b"].mobile?32:1024)*1024,t=>{const e=t.renderer;delete t.renderer,e.deleteTile(t)});let Kn=0;class Jn extends(Object(r["f"])(e["P"].CanvasRenderer)){constructor(t){super(t);const e=1024*t.options.maxGPUMemory*1024;e>Zn.max&&Zn.setMaxSize(e),this.tileCache=Zn,Kn++,this.prepareWorker(),this.tilesLoading={},this.le={},this.fe=[],this.Qt=this.de.bind(this)}getAnalysisMeshes(){if(!this.painter)return Yn;const t=this.painter.getPaintedMeshes();if(!t)return Yn;const e=[],{b3dmMeshes:n,pntsMeshes:r,i3dmMeshes:i}=t;return n.length&&dt(e,n),r.length&&dt(e,r),i.length&&dt(e,i),e}needToRedraw(){return!!this.getMap().isInteracting()||!!this.fe.length||super.needToRedraw()}getFrameTimestamp(){return this.me}drawOnInteracting(t,e,n){this.draw(e,n)}draw(t,e){this.me=t;const n=this.prepareCanvas();if(n&&!n.intersects(this.canvasExtent2D))return void this.completeRender();const{root:r,tiles:i}=this.layer.getTiles(),s=i.length;if(!i||!s)return void this.completeRender();this.pe(),this.be();const{selectedTiles:o,leaves:a,requests:l}=this.ge(r,i);l.length&&this.loadTiles(l),this.ye(o,a,e),this.we(),l.length||this.completeRender()}ge(t,e){let n=[];this.ve();let r=0;const i=this.Te(),s={};let o=!1,a=!1;for(let c=0;c<e.length;c++){const t=e[c],i=t.node;if(s[i.id])continue;s[i.id]=1;let l=!1;const h=this.getCachedTile(i.id);(this._e(i.id)?(r++,l=a=!0,this.tilesLoading[i.id].current=!0):h?(this.getTileOpacity(h)<1&&(l=a=!0),o=!0,t.selected=!0,t.data=h):this.painter.has(i)||(l=a=!0,n.push(i)),l)&&((this.Me(t)||this.Oe(t).length)&&(o=!0))}let l=[],h={};if(o&&({selectedTiles:l,leaves:h}=this.xe(t)),n.length>1&&(n.sort($n),i)){const t=i-r;n=t>0?n.slice(0,t):[]}return{loading:a,requests:n,selectedTiles:l,leaves:h}}xe(t){const e=[],n={};let r;const i=[t],s=[];for(;i.length>0||s.length>0;){if(s.length>0){const t=s[s.length-1];if(t.Ae===i.length){s.pop(),t===r&&(t.leave=!0,n[t.node.id]=1),e.push(t);continue}}const t=i.pop(),o=t.children;if(t.selected)if("add"===t.node.refine)n[t.node.id]=1,t.selectionDepth=s.length,e.push(t);else{if(t.selectionDepth=s.length,r=t,0===o.length){t.leave=!0,n[t.node.id]=1,e.push(t);continue}s.push(t),t.Ae=i.length}for(let e=0;e<o.length;e++)i.push(o[e])}return{selectedTiles:e,leaves:n}}Me(t){if(!t.parent)return null;let e=t.parent;for(;e&&e.level>=0;){const t=e.node.id;if(this.tileCache.has(t))return e.selected=!0,e.data=this.tileCache.get(t),e;e=e.parent}return null}Oe(t){const e=[];if(!t.node.children||!t.node.children.length)return e;const n=t.Z+1,r=[t.node];for(;r.length>0;){const i=r.pop().children;for(let s=0,o=i.length;s<o;s++){if((!i[s].content||!i[s].content.url)&&i[s].children&&i[s].children.length){r.push(i[s]);continue}const o=i[s].id;if(this.tileCache.has(o)){const n=this.layer.Ie(i[s],t);n.selected=!0,n.data=this.tileCache.get(o),t.children.push(n),e.push(n)}else i[s].Z<=n&&r.push(i[s])}}return e}ye(t,e,n){this.tileCache.markAll(this,!1);const r=[];for(let a=0,l=t.length;a<l;a++){const e=t[a].data;e.current=!0,e.renderer=this,this.tileCache.add(t[a].node.id,e);const n=e.node,i=this.layer.V(n.H);n.ut&&i.debug&&!Array.isArray(i.debug)&&r.push(n.ut)}this.tileCache.shrink();const i=this.layer.options.services;for(let a=0;a<i.length;a++){const t=i[a],e=Array.isArray(t.debug)&&t.debug;if(e)for(const n of e){const t=this.layer.kt[n],e=t&&t.node;e&&e.ut&&r.push(e.ut)}}const s={tiles:t,leaves:e};this.onDrawTileStart(s);const o=this.painter.paint(t,e,r,n);this.onDrawTileEnd(s),o&&this.layer.fire("canvasisdirty",{renderCount:o})}onDrawTileStart(){}onDrawTileEnd(){}loadTiles(t){for(let e=0,n=t.length;e<n;e++){const n=t[e];this.tilesLoading[n.id]={current:!0,node:n},this.loadTile(n)}}loadTile(t){let e=t.content.url;if(ut(e)){const n=ft(e);return this.Se(e,n,t),null}if(function(t){return t.indexOf("i3s:tileset")>=0}(e)){const n=t.H,r=this.Ee[n];return new Ln(e,n,r,this.layer,this.Qt).load().then(n=>{this.onTilesetLoad(n,t,e)})}return t&&gt(e)&&!jn(e)&&(e=t.baseUrl+e),this.Se(e,null,t),null}Se(t,e,n){let i=this.Ne;i||(i=r["m"].Util.getSupportedFormats(this.gl.gl||this.gl),this.Ne=i);const s=this.layer.V(n.H);s.isSuperMapiServer&&(t=function(t,e){const n=t.substring(e.length).split("/"),r=[];for(let i=0;i<n.length;i++)r.push(encodeURIComponent(n[i]));return e+r.join("/")}(t,n.baseUrl));const o={url:this.layer.getTileUrl(t,n.baseUrl,this.layer.Ce[n.H]),arraybuffer:e,rootIdx:n.H,upAxis:n._t,transform:n.matrix,supportedFormats:i};if(jn(t)){const e=this.Ee[n.H];if(o.projection=e.projection,o.i3sInfo=Gn(t,e,this.regl,this.layer.options.enableI3SCompressedGeometry,this.layer.options.forceI3SCompressedGeometry),!o.i3sInfo)return void this.onTileError({status:404},n,t)}o.service=J({},s),s.offset&&delete o.service.offset,o.referrer=window&&window.location.href,this.workerConn.loadTile(this.layer.getId(),o,(e,r)=>{if(e)return void this.onTileError(e,n,t);const{magic:i}=r;"b3dm"===i||"pnts"===i||"i3dm"===i||"cmpt"===i||"gltf"===i?this.fe.push({data:r,tile:n}):this.onTilesetLoad(r,n,t)})}Lt(t){this.painter&&this.painter.Lt(t)}Ut(t){this.painter&&this.painter.Ut(t)}be(){const t=this.getMap(),e=this.layer.options.meshLimitPerFrame;let n=0;for(;this.fe.length&&(n<e||!t.isInteracting());){const{data:t,tile:e}=this.fe.shift(),{magic:r}=t;"b3dm"===r||"gltf"===r?this.painter.createB3DMMesh(t,e.id,e,(n,{mesh:r})=>{this.Pe(t,e,n,r)}):"pnts"===r?this.painter.createPntsMesh(t,e.id,e,(n,{mesh:r})=>{this.Pe(t,e,n,r)}):"i3dm"===r?this.painter.createI3DMMesh(t,e.id,e,(n,{mesh:r})=>{this.Pe(t,e,n,r)}):"cmpt"===r&&this.painter.createCMPTMesh(t,e.id,e,(n,{mesh:r})=>{this.Pe(t,e,n,r)}),n++}}Pe(t,e,n,r){if(n)this.onTileError(n,e);else{const n=this.Re(r);e.memorySize=n,this.onTileLoad(t,e)}}Re(t){let e=0;if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]&&(e+=this.Re(t[n]));else t&&(e+=t.getMemorySize());return e}onTileLoad(t,e){this.layer&&(delete this.tilesLoading[e.id],this.layer.onTileLoad(t,e),this.Le(e),this.setToRedraw(),this.layer.fire("tileload",{node:e}))}onTilesetLoad(t,e,n){this.layer&&(this.layer.zt=t.extensions&&t.extensions["s3m:VertexCompressionType"],t.capabilities||t.layers&&t.layers[0]&&t.layers[0].capabilities?this.ke(t,e,n):(delete this.tilesLoading[e.id],this.layer.onTilesetLoad(t,e,n)))}onTileError(t,e,n){if(!this.layer)return;const r=n||e.content.url,i=t&&t.message||t;Qn.has(i)||(console.warn("failed to load 3d tile: "+r),console.warn(t),Qn.add(i)),delete this.tilesLoading[e.id],this.Ue(e,t),this.setToRedraw(),this.layer.fire("tileerror",{node:e,error:t})}getCachedTile(t){return this.tileCache.get(t)}Ue(t,n){const r={loadTime:e["I"].now(),current:!0,error:n,node:t};r.renderer=this,this.tileCache.add(t.id,r)}Le(t){const n={loadTime:e["I"].now(),current:!0,node:t};n.renderer=this,this.tileCache.add(t.id,n)}abortTileLoading(t){if(!t||!this.workerConn)return;const e=t.node.content.url;this.workerConn.abortTileLoading(this.layer.getId(),e),delete this.le[e]}ve(){if(this.tilesLoading)for(const t in this.tilesLoading)this.tilesLoading[t].current=!1}deleteTile(t){this.painter.deleteTile(t)}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:t.options.antialias},n=this.canvas.gl&&this.canvas.gl.wrap;n?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):(this.glOptions=e,this.gl=this.Be(this.canvas,e)),this.regl=this.regl||Object(r["h"])({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.optionalExtensions||[]}),n&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.painter=new En(this.regl,t),this.layer.De(),this.layer.fire("contextcreate",{regl:this.regl})}prepareWorker(){const t=this.getMap();this.workerConn||(this.workerConn=new vt("@maptalks/3dtiles",t.id));const e=this.workerConn;if(!e.isActive())return;let n=this.layer.options||{};n=J({},n),delete n.offset;const r=t.options.spatialReference;n.projection=r&&r.coordType||r&&r.projection||t.getSpatialReference().getProjection().code;const i=this.layer.getId();e.addLayer(i,n,t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))})}onRemove(){this.painter&&this.painter.remove(),this.pickingFBO&&(this.canvas.pickingFBO||this.pickingFBO.destroy(),delete this.pickingFBO),this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),t=>{if(t)throw t}),this.workerConn.remove(),delete this.workerConn),Kn--,Kn||Zn.reset(),this.clear(),delete this.tileCache,super.onRemove()}clear(){this.we(!0),this.tileCache.reset(this),this.tilesLoading={},super.clear()}clearCanvas(){this.regl&&this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas()}getTileOpacity(){return 1}getStencilValue(){return 0}we(t){this.ze||(this.ze=Date.now());const e=Date.now();if(!t&&e-this.ze<this.layer.options.retireInterval)return;this.ze=e;const n=[];for(const r in this.tilesLoading){const e=this.tilesLoading[r];!t&&e.current||(n.push(r),this.abortTileLoading(e))}for(let r=0;r<n.length;r++)delete this.tilesLoading[n[r]]}Te(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:this.layer.options.loadingLimit}Be(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}_e(t){return!!this.tilesLoading[t]}getI3DMMeshes(){return this.painter.getI3DMMeshes()}getPNTSMeshes(){return this.painter.getPNTSMeshes()}getB3DMMeshes(){return this.painter.getB3DMMeshes()}readBatchData(t,e,n){return Zt(t,e,0,n)}pe(){if(!this.Fe)return;const t=this.layer.options.i3sNodepageLimitPerFrame||Number.MAX_VALUE;let e=0;const n=[];for(const r in this.Fe){const i=this.Fe[r];if("pending"===i.status)continue;i.status="pending";const o=i.rootIdx,a=mt(this.layer.V(o).fetchOptions);if(n.push(s["a"].getJSON(r,a).then(t=>{delete this.Fe[r];const e=this.Ee[o];if(e){t.nodes?Dn(e,t.nodes):(e[t.id]=t,Dn(e,t.children));for(let t=0;t<i.length;t++)i[t]();this.setToRedraw()}else this.setToRedraw()})),e++,e>=t)break}n.length&&Promise.all(n)}de(t,e,n){this.Fe||(this.Fe={}),this.Fe[e]=this.Fe[e]||[],this.Fe[e].rootIdx=t,this.Fe[e].push(n),this.setToRedraw()}ke(t,e,n){this.Ee||(this.Ee=[]);const r=e.H;this.Ee[r]||(this.Ee[r]={});const i=this.Ee[r],s=this.layer.V(r);t.layers&&(t=t.layers[0],"/"!==n[n.length-1]&&(n+="/"),n+="layers/0"),i.version=+(s.i3sVersion||t.store.version),!t.spatialReference||t.spatialReference.wkid&&4326===t.spatialReference.wkid||console.warn("i3s has a spatialReference other than 4326.",t.spatialReference),i.projection=t.spatialReference,function(t,e,n,r,i,s,o){if(!s.layerScene){s.layerScene=e,s.nodesPerPage=e.nodePages&&e.nodePages.nodesPerPage||64,s.lodSelectionMetricType=e.nodePages&&e.nodePages.lodSelectionMetricType;let t=i;if(s.layerScene.eslpk=t.indexOf("3dSceneLayer.json")>=0,t.endsWith(".json")){const e=i.lastIndexOf("/");t=e<0?"./":i.substring(0,e)}s.layerScene.baseUrl=function(t){return t.split("?")[0]}(t)}return new Ln(i,n,s,t,o).load()}(this.layer,t,r,0,n,i,this.Qt).then(t=>{this.onTilesetLoad(t,e,n)})}pick(t,e,n){if(!this.painter)return[];const r=this.pickingFBO,{width:i,height:s}=this.canvas;return!this.pickingFBO||r.width===i&&r.height===s||r.resize(i,s),this.painter.pick(t,e,n&&n.tolerance)}highlight(t){if(this.X||(this.X=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let r=this.X[n];r||(r=this.X[n]=new Map),r.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.X[e];n||(n=this.X[e]=new Map),n.set(t.id,t)}this.painter.highlight(this.X)}cancelHighlight(t,e){if(!this.X)return;const n=this.X[t];if(n){if(Array.isArray(e))for(let t=0;t<e.length;t++)n.delete(e[t]);else n.delete(e);n.size||(this.X[t]=null),this.painter.highlight(this.X)}}cancelAllHighlight(){delete this.X,this.painter.cancelAllHighlight()}showOnly(t){if(this.Y||(this.Y=[]),Array.isArray(t))for(let e=0;e<t.length;e++){const n=t[e].service||0;let r=this.Y[n];r||(r=this.Y[n]=new Map),r.set(t[e].id,t[e])}else{const e=t.service||0;let n=this.Y[e];n||(n=this.Y[e]=new Map),n.set(t.id,t)}this.painter.showOnly(this.Y)}cancelShowOnly(){delete this.Y,this.painter.cancelShowOnly()}Yt(){return this.painter?this.painter.Yt():[]}he(t,e){const n=this.getMap();if("identity"===n.getProjection().code.toLowerCase()){const n=this.je();return Wn.set(e[0],e[1]),n.unproject(Wn,Xn),t[0]=Xn.x,t[1]=Xn.y,t}return Wn.set(e[0],e[1]),n.getProjection().unproject(Wn,Xn),t[0]=Xn.x,t[1]=Xn.y,t}Ve(t,e){const n=this.je();return Wn.set(e[0],e[1]),n.project(Wn,Xn),t[0]=Xn.x,t[1]=Xn.y,t}He(t,e){const n=this.je();return Wn.set(e[0],e[1]),n.unproject(Wn,Xn),t[0]=Xn.x,t[1]=Xn.y,t}je(){const t=this.getMap().options.spatialReference.coordType;if(!t)throw new Error("Missing coordType in map spatialReference.");return this.Ge||(this.Ge=e["G"].getProjectionInstance(t)),this.Ge}}function $n(t,e){return t.ht-e.ht}function tr(t,e,n){return t[0]=e[n],t[1]=e[n+3],t[2]=e[n+6],t}function er(t,e,n){return Math.sqrt(function(t,e,n){const r=o["f"].subtract(nr,n,t),i=tr(rr,e,0),s=tr(ir,e,1),a=tr(sr,e,2),l=o["f"].len(i),h=o["f"].len(s),c=o["f"].len(a);o["f"].normalize(i,i),o["f"].normalize(s,s),o["f"].normalize(a,a);const u=or;u[0]=o["f"].dot(r,i),u[1]=o["f"].dot(r,s),u[2]=o["f"].dot(r,a);let f,d=0;return u[0]<-l?(f=u[0]+l,d+=f*f):u[0]>l&&(f=u[0]-l,d+=f*f),u[1]<-h?(f=u[1]+h,d+=f*f):u[1]>h&&(f=u[1]-h,d+=f*f),u[2]<-c?(f=u[2]+c,d+=f*f):u[2]>c&&(f=u[2]-c,d+=f*f),d}(t,e,n))}const nr=[],rr=[],ir=[],sr=[],or=[],ar=2*Math.PI;class lr{constructor(t,e,n,r){this.west=t,this.south=e,this.east=n,this.north=r}static contains(t,e){let n=e[0];const r=e[1],i=t.west;let s=t.east;return s<i&&(s+=ar,n<0&&(n+=ar)),(n>i||Yt(n,i,1e-14))&&(n<s||Yt(n,s,1e-14))&&r>=t.south&&r<=t.north}static southwest(t,e){return e[0]=t.west,e[1]=t.south,e[2]=0,e}static northeast(t,e){return e[0]=t.east,e[1]=t.north,e[2]=0,e}static southeast(t,e){return e[0]=t.east,e[1]=t.south,e[2]=0,e}static northwest(t,e){return e[0]=t.west,e[1]=t.north,e[2]=0,e}}const hr=[0,0,1];function cr(t,e){return Ft(e,t[0],t[1],t[2])}class ur{constructor(t,e){this.normal=r["p"].copy([],t),this.distance=e}static fromPointNormal(t,e,n){const i=-r["p"].dot(e,t);return r["p"].copy(n.normal,e),n.distance=i,n}}const fr=[],dr=[],pr=[],Ar=[],gr=[],mr=[],yr=[],vr=[],xr=[],br=[],wr=new ur([1,0,0],0),_r=[];class Mr{constructor(t){this.southwestCornerCartesian=[],this.northeastCornerCartesian=[],this.westNormal=[],this.eastNormal=[],this.southNormal=[],this.northNormal=[],this.rectangle=new lr(...t),this.minimumHeight=t[4],this.maximumHeight=t[5],this.computeBox(this.rectangle)}distanceToCamera(t,e){let n=0;if(!lr.contains(this.rectangle,e)){const e=this.southwestCornerCartesian,i=this.northeastCornerCartesian,s=this.westNormal,o=this.southNormal,a=this.eastNormal,l=this.northNormal,h=r["p"].subtract(_r,t,e),c=r["p"].dot(h,s),u=r["p"].dot(h,o),f=r["p"].subtract(_r,t,i),d=r["p"].dot(f,a),p=r["p"].dot(f,l);c>0?n+=c*c:d>0&&(n+=d*d),u>0?n+=u*u:p>0&&(n+=p*p)}const i=e[2],s=this.minimumHeight,o=this.maximumHeight;if(i>o){const t=i-o;n+=t*t}else if(i<s){const t=s-i;n+=t*t}return Math.sqrt(n)}computeBox(t){const e=this;cr(lr.southwest(t,dr),e.southwestCornerCartesian),cr(lr.northeast(t,dr),e.northeastCornerCartesian),fr[0]=t.west,fr[1]=.5*(t.south+t.north),fr[2]=0;const n=cr(fr,pr),i=r["p"].cross(gr,n,hr);r["p"].normalize(e.westNormal,i),fr[0]=t.east;const s=cr(fr,vr),o=r["p"].cross(gr,hr,s);r["p"].normalize(e.eastNormal,o);const a=r["p"].subtract(gr,n,s),l=r["p"].normalize(Ar,a),h=t.south;let c;if(h>0){fr[0]=.5*(t.west+t.east),fr[1]=h;const n=cr(fr,xr);r["p"].copy(br,l);const i=ur.fromPointNormal(e.southwestCornerCartesian,e.westNormal,wr);Tr(xr,br,i,e.southwestCornerCartesian),c=Xt(n,mr)}else c=Qt(lr.southeast(t,dr),mr);const u=r["p"].cross(yr,c,a);r["p"].normalize(e.southNormal,u);const f=t.north;let d;if(f<0){fr[0]=.5*(t.west+t.east),fr[1]=f;const n=cr(fr,xr);r["p"].scale(br,l,-1);const i=ur.fromPointNormal(e.northeastCornerCartesian,e.eastNormal,wr);Tr(xr,br,i,e.northeastCornerCartesian),d=Xt(n,mr)}else d=Qt(lr.northwest(t,dr),mr);const p=r["p"].cross(yr,a,d);r["p"].normalize(e.northNormal,p)}}function Tr(t,e,n,i){const s=t,o=e,a=n.normal,l=r["p"].dot(a,o);if(Math.abs(l)<1e-15)return;const h=(-n.distance-r["p"].dot(a,s))/l;return h<0?void 0:(i=r["p"].scale(i,o,h),r["p"].add(i,s,i))}const Sr={maxGPUMemory:e["b"].mobile?32:1536,retireInterval:2e3,loadingLimitOnInteracting:5,loadingLimit:10,renderer:"gl",forceRenderOnZooming:!0,forceRenderOnRotating:!0,forceRenderOnMoving:!0,debug:!1,meshLimitPerFrame:1,i3sNodepageLimitPerFrame:1,enableI3SCompressedGeometry:!0,forceI3SCompressedGeometry:!0,picking:!0,pickingPoint:!0,geometryEvents:!1,alwaysShowTopTiles:!0,antialias:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],offset:[0,0]},Ir=[],Cr=[],Or=[],Er=[],Pr=[],kr=[],Rr=[],Nr=[],Dr=[],Fr=[],Lr=new e["f"](0,0),zr=new e["A"](0,0),Br=[],Hr=[],Ur=[],jr=[],Vr=new e["f"](0,0),Gr=r["k"].identity([]),qr=[0,0],Wr=[0,0,0],Xr=[1,1,1],Qr=[0,0,0],Yr=[0,0,0],Zr=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1];class Kr extends(Object(r["e"])(e["r"])){static fromJSON(t){return t&&"Geo3DTilesLayer"===t.type?new Kr(t.id,t.options):null}constructor(t,e){super(t,e),this.qe(),this.le={},this.kt=[]}qe(){const t=this.options.services.map(t=>t.url);this.$e=this.$e||{},this.Ce=this.Ce||[];for(let e=0;e<t.length;e++){const n=t[e];let r=this.$e[n];void 0===r&&(r=this.$e[n]=this.Ce.length),this.Ce[r]=ti(n,r,this.options.services[e])}this.fire("rootready",{roots:this.Ce.slice(0)})}showService(t){return this.updateService(t,{visible:1}),this}hideService(t){return this.updateService(t,{visible:0}),this}setToRedraw(){const t=this.getRenderer();t&&t.setToRedraw()}addService(t){this.options.services=this.options.services||[],this.options.services.push(t),this.qe();const e=this.getRenderer();return e&&e.setToRedraw(),this}updateService(t,e){if(!e)return this;const n=this.options.services;let r=!1;n&&n[t]&&(r=!(ri(n[t].coordOffset,e.coordOffset)&&ri(n[t].heightOffset,e.heightOffset)&&ri(n[t].scale,e.scale)&&ri(n[t].rotation,e.rotation)),J(n[t],e));const i=n[t].url,s=this.$e[i];this.Ce&&this.Ce[s]&&(K(e.visible)||(this.Ce[s].visible=e.visible),r&&this.Ce[s].version++);const o=this.getRenderer();return o&&o.setToRedraw(),this}removeService(t){const e=this.options.services;if(e&&e[t]){const n=e[t].url,r=this.$e[n];this.Ce[r]&&(this.Ce[r]=null),delete this.$e[n],e.splice(t,1)}const n=this.getRenderer();return n&&n.setToRedraw(),this}getTileUrl(t,e,n){const r=n&&n.service&&n.service.subdomains;if(r&&n.domainKey){const e=r.length;if(e){const i=[...t].reduce((t,e)=>t+e.charCodeAt(),0)%e;return t.replace(n.domainKey,r[i])}}return t}getExtent(t){if(!t&&0!==t){const t=new e["k"];for(let e=0;e<this.Ce.length;e++)if(this.Ce[e].boundingVolume){const n=this.boundingVolumeToExtent(this.Ce[e]);t._combine(n)}return t}return this.Ce[t]&&this.Ce[t].boundingVolume?this.boundingVolumeToExtent(this.Ce[t]):null}boundingVolumeToExtent(t){const n=t.boundingVolume.Xe?Gr:t.matrix,i=this.getMap(),s="identity"===i.getProjection().code.toLowerCase(),o=this.getRenderer();if(t.boundingVolume.region){const n=t.boundingVolume.region;return new e["k"](rt(n[0]),rt(n[1]),rt(n[2]),rt(n[3]))}if(t.boundingVolume.sphere){const a=t.boundingVolume.sphere,l=jt([],r["p"].transformMat4([],a,n));s&&o.Ve(l,l);const h=a[3],c=i.locate(l,-h,h),u=i.locate(l,h,-h);return new e["k"](c,u)}if(t.boundingVolume.box){const a=t.boundingVolume.box,l=r["p"].transformMat4([],a,n),h=new e["f"](jt([],l));s&&o.Ve(h,h);const c=a.slice(3);r["j"].multiply(c,r["j"].fromMat4([],t.matrix),c);const u=r["p"].length(c.slice(0,3)),f=r["p"].length(c.slice(3,6)),d=r["p"].length(c.slice(6,9)),p=Math.max(u,f,d),A=i.locate(h,-p,p),g=i.locate(h,p,-p);return new e["k"](A,g)}return null}getRootTiles(){return this.Ce}getTiles(){const t=this.getRenderer();if(!t.ready)return this.Ke(),{tiles:Fr};const e=this.getMap(),n=e.cameraPosition,i=e.pointAtResToDistance(n[2],0,e.getGLRes()),s=this.Ye(n);this.Je=this.Je||[],r["p"].set(this.Je,nt(s.x),nt(s.y),i),this.Qe=Ft(this.Qe||[],this.Je[0],this.Je[1],this.Je[2]),this.Ze=2*Math.tan(.5*nt(e.getFov()));const o=e.projViewMatrix,a={children:[],level:-1};let l=a;const h=[];for(let r=0;r<this.Ce.length;r++){const e=this.Ce[r];if(!e||!e.visible)continue;const n=[e],i=this.We(r);for(;n.length>0;){const e=n.pop();for(e.id||this.tn(e);l.level>=e.Z;)l=l.parent;const r=this.nn(e,i,o);if(r<1&&(r<0||!this.options.alwaysShowTopTiles||!ni(e))){let t=l;for(;t&&!t.content;)t=t.parent;0===r&&t&&t.content&&this.rn(h,t);continue}e.ht<1/0&&this.sn(e);const s=this.Ie(e,l);l.children.push(s);const a=e.children,c=a&&a.length,u=s.content;if(!c&&u&&this.rn(h,s),c){u&&"add"===e.refine&&this.rn(h,s),l=s;const r=a[0].parent;let i=!1;for(let s=0,o=a.length;s<o;s++){if(r){const e=t.getCachedTile(a[s].id);if(e&&e.error&&404!==e.error.status)continue;i=!0}else{i=!0,a[s].parent=e,a[s]._t=e._t,a[s].baseUrl=e.baseUrl;const t=a[s].content&&(a[s].content.url||a[s].content.uri);t&&(ut(t)||t.indexOf("i3s:")>=0?a[s].baseUrl=e.baseUrl:gt(t)?a[s].content.url=e.baseUrl+t:a[s].baseUrl=t.substring(0,t.lastIndexOf("/")+1))}n.push(a[s])}!i&&u&&this.rn(h,s)}}}return{root:a,tiles:h}}rn(t,e){const{viewerRequestVolume:n}=e.node;n&&!function(t,e,n){if(n.region){const e=n.region;if(t[0]>=e[0]&&t[0]<=e[2]&&t[1]>=e[1]&&t[1]<=e[3])return!0}else{if(n.sphere)return Jr(n,e);if(n.box)return 0===$r(n,e)}return!1}(this.Je,this.Qe,n)||t.push(e)}Ie(t,e){return{id:t.id,node:t,children:[],level:t.Z,parent:e,content:t.content&&t.content.url}}tn(t){const n=this.getId();t.id=n+":"+e["I"].GUID(),t.matrix=t.transform||r["k"].identity([]),t.in=this.an(t),t.parent&&(function(t){return t.content&&t.content.uri&&t.content.uri.indexOf("i3s:")>=0}(t)||(t.matrix=r["k"].multiply(t.matrix,t.parent.matrix,t.matrix)),t.H=t.parent.H,void 0===t.Z&&(t.Z=t.parent.Z+1),t.maxExtent=t.parent.maxExtent),t.refine=t.refine&&t.refine.toLowerCase()||"replace",t.content&&!t.content.url&&t.content.uri&&(t.content.url=t.content.uri)}V(t){return this.Ce[t].service}cn(t){const e=t.boundingVolume;if(!e||e.Xe&&!this.hn(t))return;const n=this.V(t.H),i=n.heightOffset||0,s=this.options.offset,o=$(s)||s[0]||s[1],a=n.coordOffset||qr;if(!Array.isArray(a))throw new Error("service.coordOffset must be an array");if(!e.Xe&&(!t.boundingVolume||!i&&r["k"].exactEquals(t.matrix,Gr)&&!o&&a===qr))return;e.box&&e.region&&delete e.region;const{region:l,box:h,sphere:c}=e;if(e.coordOffset=[a[0],a[1]],e.heightOffset=i,l){e.originalVolume||(e.originalVolume=l.slice(0));const t=e.originalVolume,n=this.un([rt(t[0]),rt(t[1])]);l[0]=nt(n.x+a[0]),l[1]=nt(n.y+a[1]);const r=this.un([rt(t[2]),rt(t[3])]);l[2]=nt(r.x+a[0]),l[3]=nt(r.y+a[1]),l[4]=t[4]+i+(a[2]||0),l[5]=t[5]+i+(a[2]||0)}else if(h||c){e.originalVolume||(e.originalVolume=(h||c).slice(0));const n=h||c,s=e.originalVolume,o=r["p"].transformMat4(Ir,s,t.matrix),l=jt(Cr,o),u=this.un([l[0]+a[0],l[1]+a[1]]);l[0]=u.x,l[1]=u.y,l[2]+=i+(a[2]||0),Ft(n,nt(l[0]),nt(l[1]),l[2])}e.Xe=!0}hn(t){const e=t.boundingVolume,n=this.V(t.H),r=n.heightOffset||0,i=n.coordOffset||qr;return e.coordOffset[0]!==i[0]||e.coordOffset[1]!==i[1]||e.heightOffset!==r}an(t){return void 0===t.geometricError||!t.boundingVolume}sn(t){let e=t.parent;for(;e&&e.in&&!(e.ht<=t.ht);)e.ht=t.ht,e=t.parent}onTileLoad(t,e){if(t.children&&(!e.children||!e.children.length)){e.children=t.children;const n=e.content.url;e.baseUrl=n.substring(0,n.lastIndexOf("/")+1);const r=this.getRenderer();r&&r.setToRedraw()}}onTilesetLoad(t,e,n){if(!t)return void console.warn("invalid tileset at : "+n);const i=this.V(e.H),s=(t.asset&&t.asset.gltfUpAxis||e&&e._t||i.upAxis||"Y").toUpperCase();t.root.baseUrl=n.substring(0,n.lastIndexOf("/")+1);const o=n.indexOf("realspace/")>-1;0===e.Z&&(t.asset&&t.asset.s3mType&&o||i.isSuperMapiServer)&&(t.root.baseUrl+="data/path/");const a=t.asset.i3s,l=!!t.asset.s3mType;if(t.root._t=s,e){const n=e.H,i=this.Ce[n];l&&!i.isS3M&&(i.isS3M=l);const s=e.boundingVolume;J(e,t.root),e.refine=e.refine&&e.refine.toLowerCase()||"replace",s&&(e.boundingVolume=s);const o=t.root.transform;o&&(e.parent?a||(e.matrix=r["k"].multiply([],e.parent.matrix,o)):e.matrix=o),e.ln=e.content,delete e.content,t.root.content&&(e.content=t.root.content),e.in=this.an(e);const h=e.content&&(e.content.url||e.content.uri);h&&e.content.uri&&(e.content.url=e.content.uri,delete e.content.uri),!a&&h&&!ut(h)&&gt(h)&&(e.content.url=e.baseUrl+h),t.root&&!e.parent&&this.dn(e)}this.Ke(),this.fire("loadtileset",{tileset:t,index:e&&e.H,url:n})}nn(t,e,n){if(t.ht=1/0,0===t.Z||t.in)return this.dn(t),1;if(this.cn(t),!this.mn(t,e,n))return-1;if(0===t.geometricError)return 1;let r=this.V(t.H).maximumScreenSpaceError;null==r&&(r=16);let i=this.pn(t);return 0===i&&t.parent&&(i=.5*(t.parent.bn||0)),i>=r?1:0}Xt(t,n){n||(n=new e["A"](0,0));const r=this.getMap();return r.getGLZoom?r.coordToPoint(t,r.getGLZoom(),n):r.coordToPointAtRes(t,r.getGLRes(),n)}mn(t,n,r){const s=t.id;let o=this.kt[s];const{boundingVolume:a}=t,l=a.region,h=a.box,c=a.sphere,u=this.gn(t.H);if(!o||o.version!==u.version){if(l)o=this.kt[s]=this.yn(t);else if(h)o=this.kt[s]=this.wn(t);else if(c){o=this.kt[s]=this.vn(t);const n=jt(Ir,c),r=new e["f"](n);o.center=r}o.version=u.version,t.ut&&(this.getRenderer().Ut(t.ut),delete t.ut)}return this.V(t.H).debug&&(this.kt[s].node=t,this.getRenderer().Lt(t)),o.obbox?Object(i["b"])(r,o.obbox):!!c&&Object(i["c"])(r,o)}yn(t){const n=this.getMap(),i=n.getGLRes(),s=t.boundingVolume.region;let{ws:o,en:a}=function(t){const e=t[0],n=t[1],r=t[2],i=t[3],s=t[4],o=t[5],a=Ft([],e,n,s),l=Ft([],r,i,o),h=jt(a,a),c=jt(l,l);return{ws:h,en:c}}(s);o=new e["f"](o),a=new e["f"](a);const l=n.coordToPointAtRes(o,i);l.z=n.altitudeToPoint(o.z,i);const h=n.coordToPointAtRes(a,i);h.z=n.altitudeToPoint(a.z,i);const c=[h.x,l.y,h.z,h.x,h.y,h.z,l.x,h.y,h.z,l.x,l.y,h.z,h.x,l.y,l.z,h.x,h.y,l.z,l.x,h.y,l.z,l.x,l.y,l.z],u=[(c[0]+c[18])/2,(c[1]+c[19])/2,(c[2]+c[20])/2],f=this.gn(t.H);t!==f||f.Tn||(f.Tn=u);const d=this.Gt([],t),p=r["k"].exactEquals(Gr,d);if(!p){r["p"].transformMat4(u,u,d);const t=Ir;for(let e=0;e<c.length;e+=3){let n=r["p"].set(t,c[e],c[e+1],c[e+2]);p||(n=r["p"].transformMat4(n,n,d)),c[e]=n[0],c[e+1]=n[1],c[e+2]=n[2]}}const A=n.pointAtResToCoord(new e["A"](u),i);A.z=(o.z+a.z)/2;const g=this._n(c,u);for(let e=0;e<c.length;e++)c[e]-=u[e%3];return{obbox:g,boxPosition:c,boxCenter:u,center:A}}wn(t){const e=this.getRenderer(),n=this.getMap(),i="identity"===n.getProjection().code.toLowerCase(),s=n.getGLRes(),{boxCenter:o,boxCoord:a}=this.Mn(t),l=t.boundingVolume.box,h=this.On(l,t.matrix),c=(f=l,function(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A,g){return t[0]=e||0,t[1]=s||0,t[2]=h||0,t[3]=d||0,t[4]=n||0,t[5]=o||0,t[6]=c||0,t[7]=p||0,t[8]=r||0,t[9]=a||0,t[10]=u||0,t[11]=A||0,t[12]=i||0,t[13]=l||0,t[14]=f||0,t[15]=g||0,t}([],(u=h)[0],u[3],u[6],f[0],u[1],u[4],u[7],f[1],u[2],u[5],u[8],f[2],0,0,0,1));var u,f;const d=this.Gt([],t),p=r["k"].exactEquals(Gr,d);p||r["p"].transformMat4(o,o,d);const A=[],g=Ir;for(let y=0;y<Zr.length;y+=3){g[0]=Zr[y],g[1]=Zr[y+1],g[2]=Zr[y+2],r["p"].transformMat4(g,g,c),jt(g,g),i&&e.Ve(g,g);const t=Lr.set(...g);let o=n.coordToPointAtRes(t,s,zr);o=r["p"].set(g,o.x,o.y,n.altitudeToPoint(t.z,s)),p||(o=r["p"].transformMat4(o,o,d)),A[y]=o[0],A[y+1]=o[1],A[y+2]=o[2]}const m=this._n(A,o);for(let r=0;r<A.length;r++)A[r]-=o[r%3];return{obbox:m,boxPosition:A,boxCenter:o,center:a}}vn(t){const n=this.getMap(),r=this.getRenderer(),i="identity"===n.getProjection().code.toLowerCase(),s=t.boundingVolume.sphere,o=s;let a=Ir;0===o[0]&&0===o[1]&&0===o[2]?a=[0,0,-6378137]:jt(a,o),i&&r.Ve(a,a);const l=new e["f"](a),h=this.Xt(l,zr).toArray();h[2]=n.altitudeToPoint(l.z,n.getGLRes());const c=this.xn(l);return[h,s[3]*c[2]]}_n(t,e){const n=ei(Pr,t,0,1,4,5),i=ei(kr,t,0,3,4,7),s=ei(Rr,t,0,1,2,3);return[...e,...r["p"].sub(Ir,n,e),...r["p"].sub(Cr,i,e),...r["p"].sub(Or,s,e)]}Mn(t){const n=this.getMap(),r=this.getRenderer(),i="identity"===n.getProjection().code.toLowerCase(),s=n.getGLRes(),o=t.boundingVolume.box.slice(0,3);jt(o,o),i&&r.Ve(o,o);const a=new e["f"](o),l=n.coordToPointAtRes(a,s);return{boxCenter:[l.x,l.y,n.altitudeToPoint(a.z,s)],boxCoord:a}}Gt(t,e){const n=this.gn(e.H),i=this.V(e.H),s=n.Tn,o=r["k"].fromTranslation(Hr,r["p"].set(Ir,-s[0],-s[1],-s[2])),a=r["k"].fromTranslation(Ur,s),l=i.rotation||Wr,h=r["l"].fromEuler(Dr,...l),c=i.scale,u=c&&r["p"].set(Qr,c,c,c)||Xr,f=r["k"].fromRotationTranslationScale(jr,h,Yr,u);return t=r["k"].multiply(t,f,o),r["k"].multiply(t,a,t)}dn(t){const e=this.V(t.H);if(!t.boundingVolume||this.An(t,e))return;const n=t.boundingVolume.box,r=t.boundingVolume.region,i=t.boundingVolume.sphere;let s=null;n?s=this.In(t).boxCenter:r?s=this.Sn(t).boxCenter:i&&(s=this.vn(t)[0]);const o=e.heightOffset||0,a=e.coordOffset||[0,0];t.En=[a[0]||0,a[1]||0],t.Nn=o,t.Tn=s}An(t,e){if(!t.En)return!1;const n=e.coordOffset||qr;return t.En[0]===n[0]&&t.En[1]===n[1]&&t.Nn===(e.heightOffset||0)}Sn(t){return t.boundingVolume?(this.cn(t),this.yn(t)):null}In(t){return t.boundingVolume?(this.cn(t),this.Mn(t)):null}On(t,e){let n=t.slice(3,12);const i=r["j"].fromMat4(Br,e);return n=r["j"].multiply(n,i,n),n}xn(t){const e=this.getMap(),n=e.distanceToPointAtRes(100,100,e.getGLRes(),t);let i;return i=e.altitudeToPoint?e.altitudeToPoint(100,e.getGLRes())/100:n.y/100,r["p"].set(Nr,n.x/100*1.01,n.y/100*1.01,i),Nr}un(t){Array.isArray(t)&&(t=new e["f"](t));let n=this.options.offset;if($(n)&&(n=n.call(this,Array.isArray(t)?new e["f"](t):t)),n[0]||n[1]){const e=this.getMap(),r=e.getGLRes(),i=e.coordToPointAtRes(t,r);return i._sub(n),e.pointAtResToCoord(i,r)}return t}gn(t){return this.Ce[t]}We(t){const n=this.V(t).maxExtent;if(!n)return null;const r=this.Ce[t];return r.maxExtent||(r.maxExtent=new e["k"](n).convertTo(t=>this.Xt(t))),r.maxExtent}pn(t){const e=this.Ze,n=t.geometricError;if(0===n)return t.bn=0,0;const r=this.V(t.H).scale||1,i=this.getMap();let s;t.boundingVolume.region?s=function(t,e,n){return t.Cn||(t.Cn=new Mr(t.boundingVolume.region)),t.Cn.distanceToCamera(e,n)}(t,this.Qe,this.Je):t.boundingVolume.sphere?s=Jr(t.boundingVolume,this.Qe):t.boundingVolume.box&&(s=$r(t.boundingVolume,this.Qe));const o=Math.max(Math.abs(s),1e-7),a=n*r*i.height/(o*e);return t.ht=s,t.bn=a,a}Ke(){const t=this.getRenderer();t&&t.setToRedraw()}Bt(t){return this.kt[t]}identify(t,n={}){const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const s=r.coordToContainerPoint(new e["f"](t));return this.identifyAtPoint(s,n)}identifyAtPoint(t,e={}){const n=[];if(!e.excludeMasks){const r=this.identifyMask(t,e);r&&r.length&&dt(n,r)}const r=this.getMap(),i=this.getRenderer();if(!r||!i)return[];const s=r.getDevicePixelRatio();return dt(n,i.pick(t.x*s,t.y*s,e)),n}getCurrentBatchIDs(){const t=this.getMap(),e=this.getRenderer();return t&&e?e.Yt():[]}highlight(t){const e=this.getRenderer();return e?(e.highlight(t),this):(this.X||(this.X=[]),this.X.push(t),this)}De(){if(this.X){for(let t=0;t<this.X.length;t++)this.highlight(this.X[t]);delete this.X}}cancelHighlight(t,e){const n=this.getRenderer();return n?(n.cancelHighlight(t,e),this):this}cancelAllHighlight(){const t=this.getRenderer();return t?(t.cancelAllHighlight(),this):this}showOnly(t){const e=this.getRenderer();return e?(e.showOnly(t),this):(this.Y||(this.Y=[]),this.Y.push(t),this)}Pn(){if(this.Y){for(let t=0;t<this.Y.length;t++)this.showOnly(this.Y[t]);delete this.Y}}cancelShowOnly(t){const e=this.getRenderer();return e?(e.cancelShowOnly(t),this):this}setServiceOpacity(t,e){const n=this.options.services[t];n&&(n.opacity=e);const r=this.getRenderer();return r?(r.setToRedraw(),this):this}setServiceDebugBoundingVolume(t,e){const n=this.options.services[t];n&&(n.debug=e);const r=this.getRenderer();return r?(r.setToRedraw(),this):this}Ye(t){const e=this.getMap(),n=e.getGLRes();Vr.set(t[0],t[1]);const r=e.pointAtResToCoord(Vr,n);return"identity"===e.getProjection().code.toLowerCase()?(Cr[0]=r.x,Cr[1]=r.y,this.getRenderer().He(Ir,Cr),r.set(Ir[0],Ir[1]),r):r}toJSON(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}}}function Jr(t,e){const n=t.sphere,i=r["p"].dist(n,e),s=t.sphere[3];return i<s?0:i-s}function $r(t,e){const n=t.box;return er(r["p"].set(Ir,n[0],n[1],n[2]),r["j"].set(Br,n[3],n[4],n[5],n[6],n[7],n[8],n[9],n[10],n[11]),e)}function ti(t,e,n){const i=(t=it(t)).indexOf("{s}")>=0?"{s}":t.indexOf("%7Bs%7D")>=0?"%7Bs%7D":null;return{version:0,service:n,visible:K(n.visible)?1:n.visible,baseUrl:t.substring(0,t.lastIndexOf("/"))+"/",content:{url:t},refine:"replace",matrix:r["k"].identity([]),H:e,Z:0,domainKey:i}}function ei(t,e,n,i,s,o){return n=r["p"].set(Ir,e[3*n],e[3*n+1],e[3*n+2]),i=r["p"].set(Cr,e[3*i],e[3*i+1],e[3*i+2]),s=r["p"].set(Or,e[3*s],e[3*s+1],e[3*s+2]),o=r["p"].set(Er,e[3*o],e[3*o+1],e[3*o+2]),t[0]=(n[0]+i[0]+s[0]+o[0])/4,t[1]=(n[1]+i[1]+s[1]+o[1])/4,t[2]=(n[2]+i[2]+s[2]+o[2])/4,t}function ni(t){if(!t.content||t.hasParentContent)return!1;let e=t.parent;if(e.content||e.hasParentContent)return t.hasParentContent||(t.hasParentContent=!0),!1;for(;e;){if(e.content||e.hasParentContent)return t.hasParentContent||(t.hasParentContent=!0),!1;e=e.parent}return!0}function ri(t,e){return Array.isArray(t)&&Array.isArray(e)?2===t.length?r["o"].exactEquals(t,e):r["p"].exactEquals(t,e):t===e}Kr.mergeOptions(Sr),Kr.registerRenderer("gl",Jn),Kr.registerJSONType("Geo3DTilesLayer");if(r["n"]){const t=e["t"].VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){const t=r["n"].inject(a);e["O"]("@maptalks/3dtiles",t)}else e["O"]("@maptalks/3dtiles",(function(){return r["n"].inject(a)}))}else e["O"]("@maptalks/3dtiles",a);"undefined"!=typeof console&&console.log("@maptalks/3dtiles v0.97.4")}).call(this,n("c8ba"))},"85cc":function(t,e,n){"use strict";function r(t,e,n){n=n||2;var r,s,a,l,h,c,f,d=e&&e.length,p=d?e[0]*n:t.length,A=i(t,0,p,n,!0),g=[];if(!A||A.next===A.prev)return g;if(d&&(A=u(t,e,A,n)),t.length>80*n){r=a=t[0],s=l=t[1];for(var m=n;m<p;m+=n)h=t[m],c=t[m+1],h<r&&(r=h),c<s&&(s=c),h>a&&(a=h),c>l&&(l=c);f=Math.max(a-r,l-s),f=0!==f?32767/f:0}return o(A,g,n,r,s,f,0),g}function i(t,e,n,r,i){var s,o;if(i===N(t,e,n,r)>0)for(s=e;s<n;s+=r)o=P(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=P(s,t[s],t[s+1],o);return o&&_(o,o.next)&&(k(o),o=o.next),o}function s(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!_(r,r.next)&&0!==w(r.prev,r,r.next))r=r.next;else{if(k(r),r=e=r.prev,r===r.next)break;n=!0}}while(n||r!==e);return e}function o(t,e,n,r,i,u,f){if(t){!f&&u&&g(t,r,i,u);var d,p,A=t;while(t.prev!==t.next)if(d=t.prev,p=t.next,u?l(t,r,i,u):a(t))e.push(d.i/n|0),e.push(t.i/n|0),e.push(p.i/n|0),k(t),t=p.next,A=p.next;else if(t=p,t===A){f?1===f?(t=h(s(t),e,n),o(t,e,n,r,i,u,2)):2===f&&c(t,e,n,r,i,u):o(s(t),e,n,r,i,u,1);break}}}function a(t){var e=t.prev,n=t,r=t.next;if(w(e,n,r)>=0)return!1;var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;while(p!==e){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&x(i,a,s,l,o,h,p.x,p.y)&&w(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function l(t,e,n,r){var i=t.prev,s=t,o=t.next;if(w(i,s,o)>=0)return!1;var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=y(d,p,e,n,r),v=y(A,g,e,n,r),b=t.prevZ,_=t.nextZ;while(b&&b.z>=m&&_&&_.z<=v){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;if(b=b.prevZ,_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}while(b&&b.z>=m){if(b.x>=d&&b.x<=A&&b.y>=p&&b.y<=g&&b!==i&&b!==o&&x(a,c,l,u,h,f,b.x,b.y)&&w(b.prev,b,b.next)>=0)return!1;b=b.prevZ}while(_&&_.z<=v){if(_.x>=d&&_.x<=A&&_.y>=p&&_.y<=g&&_!==i&&_!==o&&x(a,c,l,u,h,f,_.x,_.y)&&w(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function h(t,e,n){var r=t;do{var i=r.prev,o=r.next.next;!_(i,o)&&M(i,r,r.next,o)&&C(i,o)&&C(o,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(o.i/n|0),k(r),k(r.next),r=t=o),r=r.next}while(r!==t);return s(r)}function c(t,e,n,r,i,a){var l=t;do{var h=l.next.next;while(h!==l.prev){if(l.i!==h.i&&b(l,h)){var c=E(l,h);return l=s(l,l.next),c=s(c,c.next),o(l,e,n,r,i,a,0),void o(c,e,n,r,i,a,0)}h=h.next}l=l.next}while(l!==t)}function u(t,e,n,r){var s,o,a,l,h,c=[];for(s=0,o=e.length;s<o;s++)a=e[s]*r,l=s<o-1?e[s+1]*r:t.length,h=i(t,a,l,r,!1),h===h.next&&(h.steiner=!0),c.push(v(h));for(c.sort(f),s=0;s<c.length;s++)n=d(c[s],n);return n}function f(t,e){return t.x-e.x}function d(t,e){var n=p(t,e);if(!n)return e;var r=E(n,t);return s(r,r.next),s(n,n.next)}function p(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&x(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),C(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&A(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}function A(t,e){return w(t.prev,t,e.prev)<0&&w(e.next,t,t.next)<0}function g(t,e,n,r){var i=t;do{0===i.z&&(i.z=y(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,m(i)}function m(t){var e,n,r,i,s,o,a,l,h=1;do{n=t,t=null,s=null,o=0;while(n){for(o++,r=n,a=0,e=0;e<h;e++)if(a++,r=r.nextZ,!r)break;l=h;while(a>0||l>0&&r)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1);return t}function y(t,e,n,r,i){return t=(t-n)*i|0,e=(e-r)*i|0,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1}function v(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function x(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function b(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!I(t,e)&&(C(t,e)&&C(e,t)&&O(t,e)&&(w(t.prev,t,e.prev)||w(t,e.prev,e))||_(t,e)&&w(t.prev,t,t.next)>0&&w(e.prev,e,e.next)>0)}function w(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function _(t,e){return t.x===e.x&&t.y===e.y}function M(t,e,n,r){var i=S(w(t,e,n)),s=S(w(t,e,r)),o=S(w(n,r,t)),a=S(w(n,r,e));return i!==s&&o!==a||(!(0!==i||!T(t,n,e))||(!(0!==s||!T(t,r,e))||(!(0!==o||!T(n,t,r))||!(0!==a||!T(n,e,r)))))}function T(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function S(t){return t>0?1:t<0?-1:0}function I(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&M(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}function C(t,e){return w(t.prev,t,t.next)<0?w(t,e,t.next)>=0&&w(t,t.prev,e)>=0:w(t,e,t.prev)<0||w(t,t.next,e)<0}function O(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!==n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}function E(t,e){var n=new R(t.i,t.x,t.y),r=new R(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function P(t,e,n,r){var i=new R(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function k(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function R(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function N(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}t.exports=r,t.exports.default=r,r.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(N(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(N(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},r.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n}},"8cfe":function(t,e,n){"use strict";n.d(e,"c",(function(){return h})),n.d(e,"a",(function(){return d})),n.d(e,"b",(function(){return w}));var r=n("c3b8");
/*!
 * Contains code from google filament
 * https://github.com/google/filament/
 * License Apache-2.0
 */const i=8,s=[],o=[],a=[],l=[];function h(t,e,n){const h=r["f"].cross(o,e,n),f=c(s,n[0],n[1],n[2],...h,...e);t=r["d"].fromMat3(t,f),t=r["d"].normalize(t,t),t=u(t);const d=2,p=1/((1<<d*i-1)-1);if(t[3]<p){t[3]=p;const e=Math.sqrt(1-p*p);t[0]*=e,t[1]*=e,t[2]*=e}const A=n[3]>0?r["f"].cross(a,n,e):r["f"].cross(a,e,n),g=r["f"].cross(l,n,e);return r["f"].dot(g,A)<0&&r["d"].scale(t,t,-1),t}function c(t,e,n,r,i,s,o,a,l,h){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=l,t[8]=h,t}function u(t){return t[3]<0?r["d"].scale(t,t,-1):t}const f=[];function d(t,e,n){const r=n||[];r.setLength&&r.setLength(t.length);const i=f;i.length<t.length/3&&(i.length=t.length/3),i.fill(0,0,t.length/3);const s=void 0===e.length?e:e.length;for(let o=0;o<s/3;o++)void 0===e.length?b(t,3*o,3*o+1,3*o+2,r,i):b(t,e[3*o],e[3*o+1],e[3*o+2],r,i);for(let o=0;o<r.length;o+=3){const t=i[o/3];0!==t?(r[o]/=t,r[o+1]/=t,r[o+2]/=t):(r[o]=0,r[o+1]=0,r[o+2]=0)}return r}const p=[],A=[],g=[],m=[],y=[],v=[],x=[];function b(t,e,n,i,s,o){r["f"].set(m,t[3*e],t[3*e+1],t[3*e+2]),r["f"].set(y,t[3*n],t[3*n+1],t[3*n+2]),r["f"].set(v,t[3*i],t[3*i+1],t[3*i+2]);const a=r["f"].sub(p,v,y),l=r["f"].sub(A,m,y),h=r["f"].cross(g,a,l);r["f"].normalize(x,h),s[3*e]=s[3*e]||0,s[3*n]=s[3*n]||0,s[3*i]=s[3*i]||0,s[3*e+1]=s[3*e+1]||0,s[3*n+1]=s[3*n+1]||0,s[3*i+1]=s[3*i+1]||0,s[3*e+2]=s[3*e+2]||0,s[3*n+2]=s[3*n+2]||0,s[3*i+2]=s[3*i+2]||0,s[3*e]+=x[0],s[3*n]+=x[0],s[3*i]+=x[0],s[3*e+1]+=x[1],s[3*n+1]+=x[1],s[3*i+1]+=x[1],s[3*e+2]+=x[2],s[3*n+2]+=x[2],s[3*i+2]+=x[2],o[e]+=1,o[n]+=1,o[i]+=1}
/*!
 * Contains code from THREE.JS
 * https://github.com/mrdoob/three.js/
 * License MIT
 * 
 * Generate tangents per vertex.
 */function w(t,e,n,i,s){const o=t.length/3,a=s||new Array(4*o),l=[],h=[];for(let r=0;r<o;r++)l[r]=[0,0,0],h[r]=[0,0,0];const c=[0,0,0],u=[0,0,0],f=[0,0,0],d=[0,0],p=[0,0],A=[0,0],g=[0,0,0],m=[0,0,0];function y(e,i,s){_(c,t,3*e),_(u,t,3*i),_(f,t,3*s),M(d,n,2*e),M(p,n,2*i),M(A,n,2*s);const o=u[0]-c[0],a=f[0]-c[0],y=u[1]-c[1],v=f[1]-c[1],x=u[2]-c[2],b=f[2]-c[2],w=p[0]-d[0],T=A[0]-d[0],S=p[1]-d[1],I=A[1]-d[1],C=1/(w*I-T*S);r["f"].set(g,(I*o-S*a)*C,(I*y-S*v)*C,(I*x-S*b)*C),r["f"].set(m,(w*a-T*o)*C,(w*v-T*y)*C,(w*b-T*x)*C),r["f"].add(l[e],l[e],g),r["f"].add(l[i],l[i],g),r["f"].add(l[s],l[s],g),r["f"].add(h[e],h[e],m),r["f"].add(h[i],h[i],m),r["f"].add(h[s],h[s],m)}for(let r=0,_=i.length;r<_;r+=3)y(i[r+0],i[r+1],i[r+2]);const v=[],x=[],b=[],w=[];let T,S,I;function C(t){_(b,e,3*t),r["f"].copy(w,b),S=l[t],r["f"].copy(v,S),r["f"].sub(v,v,r["f"].scale(b,b,r["f"].dot(b,S))),r["f"].normalize(v,v),r["f"].cross(x,w,S),I=r["f"].dot(x,h[t]),T=I<0?-1:1,a[4*t]=v[0],a[4*t+1]=v[1],a[4*t+2]=v[2],a[4*t+3]=T}for(let r=0,_=i.length;r<_;r+=3)C(i[r+0]),C(i[r+1]),C(i[r+2]);return a}function _(t,e,n){return t[0]=e[n],t[1]=e[n+1],t[2]=e[n+2],t}function M(t,e,n){return t[0]=e[n],t[1]=e[n+1],t}},a279:function(t,e,n){var r=n("b753");function i(){for(var t={},e=Object.keys(r),n=e.length,i=0;i<n;i++)t[e[i]]={distance:-1,parent:null};return t}function s(t){var e=i(),n=[t];e[t].distance=0;while(n.length)for(var s=n.pop(),o=Object.keys(r[s]),a=o.length,l=0;l<a;l++){var h=o[l],c=e[h];-1===c.distance&&(c.distance=e[s].distance+1,c.parent=s,n.unshift(h))}return e}function o(t,e){return function(n){return e(t(n))}}function a(t,e){var n=[e[t].parent,t],i=r[e[t].parent][t],s=e[t].parent;while(e[s].parent)n.unshift(e[s].parent),i=o(r[e[s].parent][s],i),s=e[s].parent;return i.conversion=n,i}t.exports=function(t){for(var e=s(t),n={},r=Object.keys(e),i=r.length,o=0;o<i;o++){var l=r[o],h=e[l];null!==h.parent&&(n[l]=a(l,e))}return n}},a4c2:function(t,e,n){"use strict";n.d(e,"a",(function(){return d}));var r=n("694b"),i=n.n(r);
/*!
 * @maptalks/fusiongl v0.6.13
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */
function s(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function o(t,...e){for(let n=0;n<e.length;n++)s(t,e[n])}class a{constructor(t){this.context=t,this.COLOR_ATTACHMENT0_WEBGL=36064,this.COLOR_ATTACHMENT1_WEBGL=36065,this.COLOR_ATTACHMENT2_WEBGL=36066,this.COLOR_ATTACHMENT3_WEBGL=36067,this.COLOR_ATTACHMENT4_WEBGL=36068,this.COLOR_ATTACHMENT5_WEBGL=36069,this.COLOR_ATTACHMENT6_WEBGL=36070,this.COLOR_ATTACHMENT7_WEBGL=36071,this.COLOR_ATTACHMENT8_WEBGL=36072,this.COLOR_ATTACHMENT9_WEBGL=36073,this.COLOR_ATTACHMENT10_WEBGL=577040,this.COLOR_ATTACHMENT11_WEBGL=577041,this.COLOR_ATTACHMENT12_WEBGL=577042,this.COLOR_ATTACHMENT13_WEBGL=577043,this.COLOR_ATTACHMENT14_WEBGL=577044,this.COLOR_ATTACHMENT15_WEBGL=577045,this.DRAW_BUFFER0_WEBGL=34853,this.DRAW_BUFFER1_WEBGL=34854,this.DRAW_BUFFER2_WEBGL=34855,this.DRAW_BUFFER3_WEBGL=34856,this.DRAW_BUFFER4_WEBGL=34857,this.DRAW_BUFFER5_WEBGL=34858,this.DRAW_BUFFER6_WEBGL=34859,this.DRAW_BUFFER7_WEBGL=34860,this.DRAW_BUFFER8_WEBGL=34861,this.DRAW_BUFFER9_WEBGL=34862,this.DRAW_BUFFER10_WEBGL=34863,this.DRAW_BUFFER11_WEBGL=34864,this.DRAW_BUFFER12_WEBGL=34865,this.DRAW_BUFFER13_WEBGL=34866,this.DRAW_BUFFER14_WEBGL=34867,this.DRAW_BUFFER15_WEBGL=34868,this.MAX_COLOR_ATTACHMENTS_WEBGL=36063,this.MAX_DRAW_BUFFERS_WEBGL=2178}drawBuffersWEBGL(){return this.context.drawBuffers.apply(this.context,arguments)}}class l{constructor(t){this.context=t,this.VERTEX_ARRAY_BINDING_OES=34229}createVertexArrayOES(){return this.context.createVertexArray()}deleteVertexArrayOES(){return this.context.deleteVertexArray.apply(this.context,arguments)}isVertexArrayOES(){return this.context.isVertexArray.apply(this.context,arguments)}bindVertexArrayOES(){return this.context.bindVertexArray.apply(this.context,arguments)}}class h{constructor(t){this.context=t,this.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070}drawArraysInstancedANGLE(){return this.context.drawArraysInstanced.apply(this.context,arguments)}drawElementsInstancedANGLE(){return this.context.drawElementsInstanced.apply(this.context,arguments)}vertexAttribDivisorANGLE(){return this.context.vertexAttribDivisor.apply(this.context,arguments)}}const c={webgl_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},oes_element_index_uint:{},oes_texture_float:{},oes_texture_half_float:{HALF_FLOAT_OES:36193},ext_color_buffer_float:{},oes_standard_derivatives:{},ext_frag_depth:{},ext_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},ext_shader_texture_lod:{}},u={has(t,e){const n=t.t,r=t.i;return!(!n&&!r.getExtension(e))&&(e=e.toLowerCase(),n&&c[e]||"webgl_draw_buffers"===e||"oes_vertex_array_object"===e||"angle_instanced_arrays"===e)},mock:(t,e)=>(e=e.toLowerCase(),c[e]?t.t?("oes_texture_float"!==e&&"oes_texture_half_float"!==e||t.i.getExtension("EXT_color_buffer_float"),c[e]):t.i.getExtension(e):"webgl_draw_buffers"===e?new a(t):"oes_vertex_array_object"===e?new l(t):"angle_instanced_arrays"===e?new h(t):null),getInternalFormat:(t,e,n)=>6402===e?33190:34041===e?35056:36193===n&&e===t.RGBA?34842:36193===n&&e===t.RGB?34843:n===t.FLOAT&&e===t.RGBA?34836:n===t.FLOAT&&e===t.RGB?34837:e,getTextureType:(t,e)=>36193===e?t.HALF_FLOAT:e};let f=1;class d{constructor(t){this.uid=f++,this.states=function(t){return{scissor:[0,0,t.canvas.width,t.canvas.height],viewport:[0,0,t.canvas.width,t.canvas.height],blendColor:[0,0,0,0],blendEquationSeparate:[t.FUNC_ADD,t.FUNC_ADD],blendFuncSeparate:[t.ONE,t.ZERO,t.ONE,t.ZERO],clearColor:[0,0,0,0],clearDepth:[1],clearStencil:[0],colorMask:[!0,!0,!0,!0],cullFace:[t.BACK],depthFunc:[t.LESS],depthMask:[!0],depthRange:[0,1],capabilities:{3042:!1,2884:!1,2929:!1,3024:!1,32823:!1,32926:!1,32928:!1,3089:!1,2960:!1},frontFace:[t.CCW],hint:{33170:[t.DONT_CARE],35723:[t.DONT_CARE]},lineWidth:[1],pixelStorei:{3333:[4],3317:[4],37440:[!1],37441:[!1],37443:[t.BROWSER_DEFAULT_WEBGL]},polygonOffset:[0,0],sampleCoverage:[1,!1],stencilFuncSeparate:{1028:[t.ALWAYS,0,4294967295],1029:[t.ALWAYS,0,4294967295]},stencilMaskSeparate:{1028:[4294967295],1029:[4294967295]},stencilOpSeparate:{1028:[t.KEEP,t.KEEP,t.KEEP],1029:[t.KEEP,t.KEEP,t.KEEP]},program:null,framebuffer:{36160:null,36008:null,36009:null},renderbuffer:{36161:null},textures:{active:-1,units:function(){const e=[],n=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS);for(let t=0;t<n;t++)e.push({3553:null,34067:null});return e[-1]={3553:null,34067:null},e}()},attributes:{},arrayBuffer:null,elementArrayBuffer:null}}(t),this.i=t,this.i._fusiongl_drawCalls=0,this.t=void 0!==window.WebGL2RenderingContext&&this.i instanceof window.WebGL2RenderingContext;const e=Object.getPrototypeOf(this);this.t?Object.setPrototypeOf(e,window.WebGL2RenderingContext.prototype):Object.setPrototypeOf(e,WebGLRenderingContext.prototype),this.s=t.getParameter(t.MAX_VERTEX_ATTRIBS)}get canvas(){return this.i.canvas}get drawingBufferWidth(){return this.i.drawingBufferWidth}get drawingBufferHeight(){return this.i.drawingBufferHeight}get gl(){return this.i}get buffersOES(){return this.h||(this.h=this.i.getExtension("WEBGL_draw_buffers")),this.h}get vaoOES(){return this.u||(this.u=this.i.getExtension("OES_vertex_array_object")),this.u}get angleOES(){return this.o||(this.o=this.i.getExtension("ANGLE_instanced_arrays")),this.o}get standOES(){return this.l||(this.l=this.i.getExtension("OES_standard_derivatives")),this.l}attachShader(t,e){return this.i.attachShader(t,e)}shaderSource(t,e){return this.i.shaderSource(t,e)}compileShader(t){return this.i.compileShader(t)}createShader(t){return this.i.createShader(t)}createProgram(){return this.i.createProgram()}deleteProgram(t){return this.states.program===t&&(this.states.program=null),this.i.deleteProgram(t)}deleteShader(t){return this.i.deleteShader(t)}detachShader(t,e){return this.i.detachShader(t,e)}getAttachedShaders(t){return this.i.getAttachedShaders(t)}linkProgram(t){return this.i.linkProgram(t)}makeXRCompatible(){return this.i.makeXRCompatible()}getShaderParameter(t,e){return this.i.getShaderParameter(t,e)}getShaderPrecisionFormat(t,e){return this.i.getShaderPrecisionFormat(t,e)}getShaderInfoLog(t){return this.i.getShaderInfoLog(t)}getShaderSource(t){return this.i.getShaderSource(t)}getProgramInfoLog(t){return this.i.getProgramInfoLog(t)}getProgramParameter(t,e){return this.i.getProgramParameter(t,e)}getError(){return this.i.getError()}getContextAttributes(){return this.i.getContextAttributes()}getExtension(t){return u.has(this,t)?u.mock(this,t):this.i.getExtension(t)}getSupportedExtensions(){return this.i.getSupportedExtensions()}getParameter(t){return this.i.getParameter(t)}isEnabled(t){return this.i.isEnabled(t)}isProgram(t){return this.i.isProgram(t)}isShader(t){return this.i.isShader(t)}validateProgram(t){return this.i.validateProgram(t)}clear(t){return this.m(),this.i.clear(t)}drawArrays(t,e,n){return this.m(),this.g(),this.i.drawArrays(t,e,n)}drawElements(t,e,n,r){return this.m(),this.g(),this.i.drawElements(t,e,n,r)}drawBuffers(t){return this.m(),this.g(),this.t?this.i.drawBuffers(t):this.buffersOES.drawBuffersWEBGL(t)}g(){this.i._fusiongl_drawCalls++}resetDrawCalls(){this.i._fusiongl_drawCalls=0}getDrawCalls(){return this.i._fusiongl_drawCalls}v(){const t=this.i,e=t.getParameter(t.CURRENT_PROGRAM),n=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),r=[];for(let i=0;i<n;i++)r.push(t.getVertexAttrib(i,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING));this._={buffers:r,elements:t.getParameter(t.ELEMENT_ARRAY_BUFFER_BINDING),framebuffer:t.getParameter(t.FRAMEBUFFER_BINDING)},window.DEBUGGING&&(console.log(this.uid,this._),console.log(this.uid,this.states.attributes),console.log(this.states.attributes[0].buffer===this._.buffers[0]),console.log(this.states.attributes[1].buffer===this._.buffers[1]),console.log(this.states.attributes[2].buffer===this._.buffers[2]))}finish(){return this.i.finish()}flush(){return this.m(),this.i.flush()}commit(){return this.m(),this.i.commit()}isContextLost(){return this.i.isContextLost()}getFragDataLocation(t,e){return this.i.getFragDataLocation(t,e)}createSampler(){return this.i.createSampler()}deleteSampler(){return this.i.deleteSampler()}bindSampler(){return this.i.bindSampler()}isSampler(){return this.i.isSampler()}getSamplerParameter(){return this.i.getSamplerParameter()}isQuery(t){return this.i.beginQuery(t)}beginQuery(t,e){return this.i.beginQuery(t,e)}deleteQuery(t){return this.i.query(t)}isTransformFeedback(t){return this.i.isTransformFeedback(t)}beginTransformFeedback(t){return this.i.beginTransformFeedback(t)}deleteTransformFeedback(t){return this.i.deleteTransformFeedback(t)}pauseTransformFeedback(){return this.i.pauseTransformFeedback()}resumeTransformFeedback(){return this.i.resumeTransformFeedback()}transformFeedbackVaryings(t,e,n){return this.i.transformFeedbackVaryings(t,e,n)}bindBufferBase(t,e,n){return this.i.bbindBufferBase(t,e,n)}bindBufferRange(t,e,n,r,i){return this.i.bindBufferRange(t,e,n,r,i)}bindTransformFeedback(t,e){return this.i.bindTransformFeedback(t,e)}fenceSync(t,e){return this.i.fenceSync(t,e)}isSync(t){return this.i.isSync(t)}deleteSync(t){return this.i.deleteSync(t)}clientWaitSync(t,e,n){return this.i.clientWaitSync(t,e,n)}waitSync(t,e,n){return this.i.waitSync(t,e,n)}getSyncParameter(t,e){return this.i.getSyncParameter(t,e)}getIndexedParameter(t,e){return this.i.getIndexedParameter(t,e)}}function p(t,e){const n=e.length;for(let r=0;r<n;r++)t[r]=e[r];return t}o(d.prototype,{bufferData(...t){return this.m(),this.i.bufferData(...t)},bufferSubData(...t){return this.m(),this.i.bufferSubData(...t)},createBuffer(){return this.i.createBuffer()},deleteBuffer(t){const e=this.states;e.arrayBuffer===t?e.arrayBuffer=null:e.elementArrayBuffer===t&&(e.elementArrayBuffer=null);const n=e.attributes;for(const r in n)n[r].buffer===t&&(n[r].buffer=null);return this.i.deleteBuffer(t)},getBufferParameter(t,e){return this.m(),this.i.getBufferParameter(t,e)},isBuffer(t){return this.i.isBuffer(t)},copyBufferSubData(t,e,n,r,i){return this.i.isBuffer(t,e,n,r,i)},readBuffer(t){return this.i.readBuffer(t)}}),o(d.prototype,{checkFramebufferStatus(t){return this.i.checkFramebufferStatus(t)},createFramebuffer(){return this.i.createFramebuffer()},deleteFramebuffer(t){const e=this.states.framebuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteFramebuffer(t)},framebufferRenderbuffer(t,e,n,r){return this.m(),this.i.framebufferRenderbuffer(t,e,n,r)},framebufferTexture2D(t,e,n,r,i){return this.m(),this.i.framebufferTexture2D(t,e,n,r,i)},getFramebufferAttachmentParameter(t,e,n){return this.m(),this.i.getFramebufferAttachmentParameter(t,e,n)},isFramebuffer(t){return this.i.isFramebuffer(t)},readPixels(t,e,n,r,i,s,o){return this.m(),this.i.readPixels(t,e,n,r,i,s,o)},blitFramebuffer(t,e,n,r,i,s,o,a,l,h){return this.m(),this.i.blitFramebuffer(t,e,n,r,i,s,o,a,l,h)}}),o(d.prototype,{createRenderbuffer(){return this.i.createRenderbuffer()},deleteRenderbuffer(t){const e=this.states.renderbuffer;for(const n in e)e[n]===t&&(e[n]=null);return this.i.deleteRenderbuffer(t)},getRenderbufferParameter(t,e){return this.m(),this.i.getRenderbufferParameter(t,e)},isRenderbuffer(t){return this.i.isRenderbuffer(t)},renderbufferStorage(t,e,n,r){return this.m(),this.i.renderbufferStorage(t,e,n,r)},renderbufferStorageMultisample(t,e,n,r,i){return this.m(),this.i.renderbufferStorageMultisample(t,e,n,r,i)}}),o(d.prototype,{scissor(t,e,n,r){this.m();const i=this.states.scissor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.scissor(t,e,n,r))},viewport(t,e,n,r){this.m();const i=this.states.viewport;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.viewport(t,e,n,r))},blendColor(t,e,n,r){this.m();const i=this.states.blendColor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.blendColor(t,e,n,r))},blendEquation(t){this.m();const e=this.states.blendEquationSeparate;e[0]===t&&e[1]===t||(e[0]=t,e[1]=t,this.i.blendEquation(t))},blendEquationSeparate(t,e){this.m();const n=this.states.blendEquationSeparate;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.blendEquationSeparate(t,e))},blendFunc(t,e){this.m();const n=this.states.blendFuncSeparate;n[0]===t&&n[2]===t&&n[1]===e&&n[3]===e||(n[0]=t,n[1]=e,n[2]=t,n[3]=e,this.i.blendFunc(t,e))},blendFuncSeparate(t,e,n,r){this.m();const i=this.states.blendFuncSeparate;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.blendFuncSeparate(t,e,n,r))},clearColor(t,e,n,r){this.m();const i=this.states.clearColor;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.clearColor(t,e,n,r))},clearDepth(t){this.m();const e=this.states.clearDepth;e[0]!==t&&(e[0]=t,this.i.clearDepth(t))},clearStencil(t){this.m();const e=this.states.clearStencil;e[0]!==t&&(e[0]=t,this.i.clearStencil(t))},colorMask(t,e,n,r){this.m();const i=this.states.colorMask;i[0]===t&&i[1]===e&&i[2]===n&&i[3]===r||(i[0]=t,i[1]=e,i[2]=n,i[3]=r,this.i.colorMask(t,e,n,r))},cullFace(t){this.m();const e=this.states.cullFace;e[0]!==t&&(e[0]=t,this.i.cullFace(t))},depthFunc(t){this.m();const e=this.states.depthFunc;e[0]!==t&&(e[0]=t,this.i.depthFunc(t))},depthMask(t){this.m();const e=this.states.depthMask;e[0]!==t&&(e[0]=t,this.i.depthMask(t))},depthRange(t,e){this.m();const n=this.states.depthRange;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.depthRange(t,e))},disable(t){this.m();const e=this.states.capabilities;e[t]&&(e[t]=!1,this.i.disable(t))},enable(t){this.m();const e=this.states.capabilities;e[t]||(e[t]=!0,this.i.enable(t))},frontFace(t){this.m();const e=this.states.frontFace;e[0]!==t&&(e[0]=t,this.i.frontFace(t))},hint(t,e){this.m();const n=this.states.hint;n[t][0]!==e&&(n[t][0]=e,this.i.hint(t,e))},lineWidth(t){this.m();const e=this.states.lineWidth;e[0]!==t&&(e[0]=t,this.i.lineWidth(t))},pixelStorei(t,e){this.m();const n=this.states.pixelStorei;n[t]!==e&&(n[t]&&(n[t][0]=e),this.i.pixelStorei(t,e))},polygonOffset(t,e){this.m();const n=this.states.polygonOffset;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.polygonOffset(t,e))},sampleCoverage(t,e){this.m();const n=this.states.sampleCoverage;n[0]===t&&n[1]===e||(n[0]=t,n[1]=e,this.i.sampleCoverage(t,e))},stencilFunc(t,e,n){this.m();const r=this.states.stencilFuncSeparate,i=this.i;r[i.FRONT][0]===t&&r[i.FRONT][1]===e&&r[i.FRONT][2]===n&&r[i.BACK][0]===t&&r[i.BACK][1]===e&&r[i.BACK][2]===n||(r[i.FRONT][0]=r[i.BACK][0]=t,r[i.FRONT][1]=r[i.BACK][1]=e,r[i.FRONT][2]=r[i.BACK][2]=n,this.i.stencilFunc(t,e,n))},stencilFuncSeparate(t,e,n,r){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilFunc(e,n,r);const i=this.states.stencilFuncSeparate;i[t][0]===e&&i[t][1]===n&&i[t][2]===r||(i[t][0]=e,i[t][1]=n,i[t][2]=r,this.i.stencilFuncSeparate(t,e,n,r))},stencilMask(t){this.m();const e=this.i,n=this.states.stencilMaskSeparate;n[e.FRONT][0]===t&&n[e.BACK][0]===t||(n[e.FRONT][0]=t,n[e.BACK][0]=t,this.i.stencilMask(t))},stencilMaskSeparate(t,e){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilMask(e);const n=this.states.stencilMaskSeparate;n[t][0]!==e&&(n[t][0]=e,this.i.stencilMaskSeparate(t,e))},stencilOp(t,e,n){this.m();const r=this.states.stencilOpSeparate,i=this.i;r[i.FRONT][0]===t&&r[i.FRONT][1]===e&&r[i.FRONT][2]===n&&r[i.BACK][0]===t&&r[i.BACK][1]===e&&r[i.BACK][2]===n||(r[i.FRONT][0]=r[i.BACK][0]=t,r[i.FRONT][1]=r[i.BACK][1]=e,r[i.FRONT][2]=r[i.BACK][2]=n,this.i.stencilOp(t,e,n))},stencilOpSeparate(t,e,n,r){if(this.m(),t===this.i.FRONT_AND_BACK)return void this.stencilOp(e,n,r);const i=this.states.stencilOpSeparate;i[t][0]===e&&i[t][1]===n&&i[t][2]===r||(i[t][0]=e,i[t][1]=n,i[t][2]=r,this.i.stencilOpSeparate(t,e,n,r))},bindFramebuffer(t,e){this.m();const n=this.states.framebuffer;n[t]!==e&&(n[t]=e,this.i.bindFramebuffer(t,e))},bindRenderbuffer(t,e){this.m();const n=this.states.renderbuffer;n[t]!==e&&(n[t]=e,this.i.bindRenderbuffer(t,e))},bindTexture(t,e){this.m();const n=this.states.textures,r=-1!==n.active?n.active-33984:-1;n.units[r][t]=e,this.i.bindTexture(t,e)},activeTexture(t){this.m();const e=this.i,n=this.states.textures,r=n.active;n.active=t,this.activeUnit!==t&&(e.activeTexture(t),this.activeUnit=t),-1===r&&(n.units[t-33984][e.TEXTURE_2D]=n.units[-1][e.TEXTURE_2D],n.units[t-33984][e.TEXTURE_CUBE_MAP]=n.units[-1][e.TEXTURE_CUBE_MAP],n.units[-1][e.TEXTURE_2D]=null,n.units[-1][e.TEXTURE_CUBE_MAP]=null)},useProgram(t){this.m();const e=this.states;e.program!==t&&(this.states.activeAttribType=0,e.program=t,void 0===t.fid&&(t.fid=0),this.S(),this.i.useProgram(t))},S(){const t=this.states.program;if(!t)return;const e=t.cachedUniforms=t.cachedUniforms||{};for(const n in e)Array.isArray(e[n])?e[n].fill(null):e[n]=null},bindBuffer(t,e){this.m();const n=this.i,r=this.states;t===n.ELEMENT_ARRAY_BUFFER?r.elementArrayBuffer=e:r.arrayBuffer=e,n.bindBuffer(t,e)},bindVertexArray(t){this.m(),this.states.activeAttribType=1;const e=this.i,n=this.states;n.vao!==t&&(n.vao=t,this.t?e.bindVertexArray(t):this.vaoOES.bindVertexArrayOES(t))},vertexAttribPointer(t,e,n,r,i,s){this.m(),this.states.attributes[t]||(this.states.attributes[t]={enable:!0});const o=this.states.attributes[t];return o.buffer=this.states.arrayBuffer,o.args?(o.args[0]=t,o.args[1]=e,o.args[2]=n,o.args[3]=r,o.args[4]=i,o.args[5]=s):o.args=[t,e,n,r,i,s],this.i.vertexAttribPointer(t,e,n,r,i,s)},vertexAttribDivisor(t,e){return this.m(),this.states.attributes[t].divisor=e,this.t?this.i.vertexAttribDivisor(t,e):this.angleOES.vertexAttribDivisorANGLE(t,e)}},{m(){const t=this.i;if(t.A!==this)if(t.A){const e=t.A;this.p(e.states),t.A=this}else t.A=this},p(t){if(!t)return;delete this.activeUnit;const e=this.states,n=this.i;let r=0;for(const u in e)if("capabilities"!==u&&"textures"!==u&&"attributes"!==u&&"arrayBuffer"!==u&&"elementArrayBuffer"!==u&&"vao"!==u)if("program"===u)e.program!==t.program&&(n.useProgram(e.program),e.program&&(r=n.getProgramParameter(e.program,n.ACTIVE_ATTRIBUTES)));else if("framebuffer"===u)for(const r in e[u])e[u][r]!==t[u][r]&&n.bindFramebuffer(+r,e[u][r]);else if("renderbuffer"===u)for(const r in e[u])e[u][r]!==t[u][r]&&n.bindRenderbuffer(+r,e[u][r]);else if(!i()(e[u],t[u]))if(Array.isArray(t[u]))n[u](...e[u]);else if(t[u])for(const r in e[u])i()(e[u][r],t[u][r])||n[u](+r,...e[u][r]);this.S();for(const i in e.capabilities)e.capabilities[i]!==t.capabilities[i]&&n[e.capabilities[i]?"enable":"disable"](+i);const s=e.textures,o=t.textures,a=s.units,l=o.units,h=s.active-n.TEXTURE0;for(let i=0;i<a.length;i++)i===h||a[i][n.TEXTURE_2D]===l[i][n.TEXTURE_2D]&&a[i][n.TEXTURE_CUBE_MAP]===l[i][n.TEXTURE_CUBE_MAP]||(n.activeTexture(n.TEXTURE0+i),n.bindTexture(n.TEXTURE_2D,a[i][n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,a[i][n.TEXTURE_CUBE_MAP]));if(s.active>-1){const t=a[h];t[n.TEXTURE_2D]===l[h][n.TEXTURE_2D]&&t[n.TEXTURE_CUBE_MAP]===l[h][n.TEXTURE_CUBE_MAP]||(n.activeTexture(s.active),n.bindTexture(n.TEXTURE_2D,t[n.TEXTURE_2D]),n.bindTexture(n.TEXTURE_CUBE_MAP,t[n.TEXTURE_CUBE_MAP]))}this.t?n.bindVertexArray(null):this.u&&this.u.bindVertexArrayOES(null);const c=this.s;if(this.t||this.angleOES)for(let i=0;i<c;i++)this.t?n.vertexAttribDivisor(i,0):this.angleOES.vertexAttribDivisorANGLE(i,0);n.bindBuffer(n.ARRAY_BUFFER,e.arrayBuffer),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,e.elementArrayBuffer),1===e.activeAttribType?this.F(e,n):this.L(e,n,r)},F(t,e){const n=t.vao;n&&(this.t?e.bindVertexArray(n||null):this.u&&this.u.bindVertexArrayOES(n||null))},L(t,e,n){const r=this.s,i=t.attributes;let s=0;for(let o=0;o<r;o++){const t=i[o];if(s<n&&t){if(t.buffer){if(e.bindBuffer(e.ARRAY_BUFFER,t.buffer),e.vertexAttribPointer(...t.args),t.divisor&&(this.t?e.vertexAttribDivisor(o,t.divisor):this.angleOES.vertexAttribDivisorANGLE(o,t.divisor)),t.enable){e.enableVertexAttribArray(o),s++;continue}e.disableVertexAttribArray(o)}e.disableVertexAttribArray(o)}else e.disableVertexAttribArray(o)}}}),o(d.prototype,{compressedTexImage2D(t,e,n,r,i,s,o){return this.m(),this.i.compressedTexImage2D(t,e,n,r,i,s,o)},copyTexImage2D(t,e,n,r,i,s,o,a){return this.m(),this.i.copyTexImage2D(t,e,n,r,i,s,o,a)},copyTexSubImage2D(t,e,n,r,i,s,o,a){return this.m(),this.i.copyTexSubImage2D(t,e,n,r,i,s,o,a)},createTexture(){return this.i.createTexture()},deleteTexture(t){const e=this.states.textures.units;for(let n=0;n<e.length;n++)for(const r in e[n])e[n][r]===t&&(e[n][r]=null);return this.i.deleteTexture(t)},generateMipmap(t){return this.m(),this.i.generateMipmap(t)},getTexParameter(t,e){return this.m(),this.i.getTexParameter(t,e)},isTexture(t){return this.i.isTexture(t)},texImage2D(...t){if(this.m(),this.t){const e=t[t.length-2],n=u.getInternalFormat(this.i,t[2],e);n!==t[2]&&(t[2]=n);const r=u.getTextureType(this.i,e);r!==e&&(t[t.length-2]=r)}return this.i.texImage2D(...t)},texSubImage2D(...t){if(this.m(),this.t){const e=t[t.length-2],n=u.getTextureType(this.i,e);n!==e&&(t[t.length-2]=n)}return this.i.texSubImage2D(...t)},texParameterf(t,e,n){return this.m(),this.i.texParameterf(t,e,n)},texParameteri(t,e,n){return this.m(),this.i.texParameteri(t,e,n)},texStorage2D(t,e,n,r,i){return this.m(),this.i.texStorage2D(t,e,n,r,i)},texImage3D(t,e,n,r,i,s,o,a,l,h){return this.m(),this.i.texImage3D(t,e,n,r,i,s,o,a,l,h)},texStorage3D(t,e,n,r,i,s){return this.m(),this.i.texStorage3D(t,e,n,r,i,s)},texSubImage3D(t,e,n,r,i,s,o,a,l,h,c){return this.m(),this.i.texSubImage3D(t,e,n,r,i,s,o,a,l,h,c)},copyTexSubImage3D(t,e,n,r,i,s,o,a,l){return this.m(),this.i.copyTexSubImage3D(t,e,n,r,i,s,o,a,l)},compressedTexSubImage3D(t,e,n,r,i,s,o,a,l,h,c){return this.m(),this.i.compressedTexSubImage3D(t,e,n,r,i,s,o,a,l,h,c)}}),o(d.prototype,{bindAttribLocation(t,e,n){return this.i.bindAttribLocation(t,e,n)},enableVertexAttribArray(t){return this.m(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!0,this.i.enableVertexAttribArray(t)},disableVertexAttribArray(t){return this.m(),this.states.attributes[t]||(this.states.attributes[t]={}),this.states.attributes[t].enable=!1,this.i.disableVertexAttribArray(t)},getActiveAttrib(t,e){return this.i.getActiveAttrib(t,e)},getActiveUniform(t,e){return this.i.getActiveUniform(t,e)},getAttribLocation(t,e){return this.i.getAttribLocation(t,e)},getUniformLocation(t,e){return this.i.getUniformLocation(t,e)},getVertexAttrib(t,e){return this.m(),this.i.getVertexAttrib(t,e)},getVertexAttribOffset(t,e){return this.m(),this.i.getVertexAttribOffset(t,e)},uniformBlockBinding(t,e,n){return this.m(),this.i.uniformBlockBinding(t,e,n)},D(t,...e){const n=this.states.program;if(!n)return!1;let r=t.fid;void 0===r&&(r=t.fid=n.fid++);const i=n.cachedUniforms[r];return!!function(t,e){if(!t)return!1;const n=e.length;for(let r=0;r<n;r++)if(t[r]&&void 0!==t[r].length){const n=t[r].length;for(let i=0;i<n;i++)if(t[r][i]!==e[r][i])return!1}else if(t[r]!==e[r])return!1;return!0}(i,e)||(n.cachedUniforms[r]=function(t,e){t=t||new Array(e.length);const n=e.length;for(let r=0;r<n;r++)t[r]=void 0!==e[r].length?p(t[r]||[],e[r]):e[r];return t}(i,e),!1)},uniformMatrix2fv(t,e,n){this.D(t,e,n)||(this.m(),this.i.uniformMatrix2fv(t,e,n))},uniformMatrix3fv(t,e,n){this.D(t,e,n)||(this.m(),this.i.uniformMatrix3fv(t,e,n))},uniformMatrix4fv(t,e,n){this.D(t,e,n)||this.i.uniformMatrix4fv(t,e,n)},uniform1f(t,e){return this.m(),this.i.uniform1f(t,e)},uniform1i(t,e){return this.m(),this.i.uniform1i(t,e)},uniform2f(t,e,n){return this.m(),this.i.uniform2f(t,e,n)},uniform2i(t,e,n){return this.m(),this.i.uniform2i(t,e,n)},uniform3f(t,e,n,r){return this.m(),this.i.uniform3f(t,e,n,r)},uniform3i(t,e,n,r){return this.m(),this.i.uniform3i(t,e,n,r)},uniform4f(t,e,n,r,i){return this.m(),this.i.uniform4f(t,e,n,r,i)},uniform4i(t,e,n,r,i){return this.m(),this.i.uniform4i(t,e,n,r,i)},uniform1ui(t,e){return this.m(),this.i.uniform1ui(t,e)},uniform2ui(t,e,n){return this.m(),this.i.uniform2ui(t,e,n)},uniform3ui(t,e,n,r){return this.m(),this.i.uniform3ui(t,e,n,r)},uniform4ui(t,e,n,r,i){return this.m(),this.i.uniform4ui(t,e,n,r,i)},uniform1fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1fv(t,e,n,r):void 0!==n?this.i.uniform1fv(t,e,n):this.i.uniform1fv(t,e)},uniform2fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2fv(t,e,n,r):void 0!==n?this.i.uniform2fv(t,e,n):this.i.uniform2fv(t,e)},uniform3fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3fv(t,e,n,r):void 0!==n?this.i.uniform3fv(t,e,n):this.i.uniform3fv(t,e)},uniform4fv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4fv(t,e,n,r):void 0!==n?this.i.uniform4fv(t,e,n):this.i.uniform4fv(t,e)},uniform1iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1iv(t,e,n,r):void 0!==n?this.i.uniform1iv(t,e,n):this.i.uniform1iv(t,e)},uniform2iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2iv(t,e,n,r):void 0!==n?this.i.uniform2iv(t,e,n):this.i.uniform2iv(t,e)},uniform3iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3iv(t,e,n,r):void 0!==n?this.i.uniform3iv(t,e,n):this.i.uniform3iv(t,e)},uniform4iv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4iv(t,e,n,r):void 0!==n?this.i.uniform4iv(t,e,n):this.i.uniform4iv(t,e)},uniform1uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform1uiv(t,e,n,r):void 0!==n?this.i.uniform1uiv(t,e,n):this.i.uniform1uiv(t,e)},uniform2uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform2uiv(t,e,n,r):void 0!==n?this.i.uniform2uiv(t,e,n):this.i.uniform2uiv(t,e)},uniform3uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform3uiv(t,e,n,r):void 0!==n?this.i.uniform3uiv(t,e,n):this.i.uniform3uiv(t,e)},uniform4uiv(t,e,n,r){this.m(),void 0!==r?this.i.uniform4uiv(t,e,n,r):void 0!==n?this.i.uniform4uiv(t,e,n):this.i.uniform4uiv(t,e)},vertexAttrib1f(t,e){return this.m(),this.i.vertexAttrib1f(t,e)},vertexAttrib2f(t,e,n){return this.m(),this.i.vertexAttrib2f(t,e,n)},vertexAttrib3f(t,e,n,r){return this.m(),this.i.vertexAttrib3f(t,e,n,r)},vertexAttrib4f(t,e,n,r,i){return this.m(),this.i.vertexAttrib4f(t,e,n,r,i)},vertexAttrib1fv(t,e){return this.m(),this.i.vertexAttrib1fv(t,e)},vertexAttrib2fv(t,e){return this.m(),this.i.vertexAttrib2fv(t,e)},vertexAttrib3fv(t,e){return this.m(),this.i.vertexAttrib3fv(t,e)},vertexAttrib4fv(t,e){return this.m(),this.i.vertexAttrib4fv(t,e)},vertexAttribI4i(t,e,n,r,i){return this.m(),this.i.vertexAttribI4i(t,e,n,r,i)},vertexAttribI4ui(t,e,n,r,i){return this.m(),this.i.vertexAttribI4ui(t,e,n,r,i)},vertexAttribI4iv(t,e){return this.m(),this.i.vertexAttribI4iv(t,e)},vertexAttribI4uiv(t,e){return this.m(),this.i.vertexAttribI4uiv(t,e)}}),o(d.prototype,{createVertexArray(){return this.t?this.i.createVertexArray():this.vaoOES.createVertexArrayOES()},deleteVertexArray(t){const e=this.states;return e.vao===t&&(e.vao=null),this.t?this.i.deleteVertexArray(t):this.vaoOES.deleteVertexArrayOES(t)},isVertexArray(t){return this.t?this.i.isVertexArray(t):this.vaoOES.isVertexArrayOES(t)}}),o(d.prototype,{drawArraysInstanced(t,e,n,r){return this.m(),this.g(),this.t?this.i.drawArraysInstanced(t,e,n,r):this.angleOES.drawArraysInstancedANGLE(t,e,n,r)},drawElementsInstanced(t,e,n,r,i){return this.m(),this.g(),this.t?this.i.drawElementsInstanced(t,e,n,r,i):this.angleOES.drawElementsInstancedANGLE(t,e,n,r,i)}})},b753:function(t,e,n){var r=n("4f4d"),i={};for(var s in r)r.hasOwnProperty(s)&&(i[r[s]]=s);var o=t.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var a in o)if(o.hasOwnProperty(a)){if(!("channels"in o[a]))throw new Error("missing channels property: "+a);if(!("labels"in o[a]))throw new Error("missing channel labels property: "+a);if(o[a].labels.length!==o[a].channels)throw new Error("channel and label counts mismatch: "+a);var l=o[a].channels,h=o[a].labels;delete o[a].channels,delete o[a].labels,Object.defineProperty(o[a],"channels",{value:l}),Object.defineProperty(o[a],"labels",{value:h})}function c(t,e){return Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2)}o.rgb.hsl=function(t){var e,n,r,i=t[0]/255,s=t[1]/255,o=t[2]/255,a=Math.min(i,s,o),l=Math.max(i,s,o),h=l-a;return l===a?e=0:i===l?e=(s-o)/h:s===l?e=2+(o-i)/h:o===l&&(e=4+(i-s)/h),e=Math.min(60*e,360),e<0&&(e+=360),r=(a+l)/2,n=l===a?0:r<=.5?h/(l+a):h/(2-l-a),[e,100*n,100*r]},o.rgb.hsv=function(t){var e,n,r,i,s,o=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(o,a,l),c=h-Math.min(o,a,l),u=function(t){return(h-t)/6/c+.5};return 0===c?i=s=0:(s=c/h,e=u(o),n=u(a),r=u(l),o===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*h]},o.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2],i=o.rgb.hsl(t)[0],s=1/255*Math.min(e,Math.min(n,r));return r=1-1/255*Math.max(e,Math.max(n,r)),[i,100*s,100*r]},o.rgb.cmyk=function(t){var e,n,r,i,s=t[0]/255,o=t[1]/255,a=t[2]/255;return i=Math.min(1-s,1-o,1-a),e=(1-s-i)/(1-i)||0,n=(1-o-i)/(1-i)||0,r=(1-a-i)/(1-i)||0,[100*e,100*n,100*r,100*i]},o.rgb.keyword=function(t){var e=i[t];if(e)return e;var n,s=1/0;for(var o in r)if(r.hasOwnProperty(o)){var a=r[o],l=c(t,a);l<s&&(s=l,n=o)}return n},o.keyword.rgb=function(t){return r[t]},o.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92,n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92;var i=.4124*e+.3576*n+.1805*r,s=.2126*e+.7152*n+.0722*r,o=.0193*e+.1192*n+.9505*r;return[100*i,100*s,100*o]},o.rgb.lab=function(t){var e,n,r,i=o.rgb.xyz(t),s=i[0],a=i[1],l=i[2];return s/=95.047,a/=100,l/=108.883,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,a=a>.008856?Math.pow(a,1/3):7.787*a+16/116,l=l>.008856?Math.pow(l,1/3):7.787*l+16/116,e=116*a-16,n=500*(s-a),r=200*(a-l),[e,n,r]},o.hsl.rgb=function(t){var e,n,r,i,s,o=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return s=255*l,[s,s,s];n=l<.5?l*(1+a):l+a-l*a,e=2*l-n,i=[0,0,0];for(var h=0;h<3;h++)r=o+1/3*-(h-1),r<0&&r++,r>1&&r--,s=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*s;return i},o.hsl.hsv=function(t){var e,n,r=t[0],i=t[1]/100,s=t[2]/100,o=i,a=Math.max(s,.01);return s*=2,i*=s<=1?s:2-s,o*=a<=1?a:2-a,n=(s+i)/2,e=0===s?2*o/(a+o):2*i/(s+i),[r,100*e,100*n]},o.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,s=e-Math.floor(e),o=255*r*(1-n),a=255*r*(1-n*s),l=255*r*(1-n*(1-s));switch(r*=255,i){case 0:return[r,l,o];case 1:return[a,r,o];case 2:return[o,r,l];case 3:return[o,a,r];case 4:return[l,o,r];case 5:return[r,o,a]}},o.hsv.hsl=function(t){var e,n,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,e=(2-s)*a,n=s*a,n/=e<=1?e:2-e,n=n||0,r/=2,[i,100*n,100*r]},o.hwb.rgb=function(t){var e,n,r,i,s,o,a,l=t[0]/360,h=t[1]/100,c=t[2]/100,u=h+c;switch(u>1&&(h/=u,c/=u),e=Math.floor(6*l),n=1-c,r=6*l-e,0!==(1&e)&&(r=1-r),i=h+r*(n-h),e){default:case 6:case 0:s=n,o=i,a=h;break;case 1:s=i,o=n,a=h;break;case 2:s=h,o=n,a=i;break;case 3:s=h,o=i,a=n;break;case 4:s=i,o=h,a=n;break;case 5:s=n,o=h,a=i;break}return[255*s,255*o,255*a]},o.cmyk.rgb=function(t){var e,n,r,i=t[0]/100,s=t[1]/100,o=t[2]/100,a=t[3]/100;return e=1-Math.min(1,i*(1-a)+a),n=1-Math.min(1,s*(1-a)+a),r=1-Math.min(1,o*(1-a)+a),[255*e,255*n,255*r]},o.xyz.rgb=function(t){var e,n,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return e=3.2406*i+-1.5372*s+-.4986*o,n=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,e=e>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,e=Math.min(Math.max(0,e),1),n=Math.min(Math.max(0,n),1),r=Math.min(Math.max(0,r),1),[255*e,255*n,255*r]},o.xyz.lab=function(t){var e,n,r,i=t[0],s=t[1],o=t[2];return i/=95.047,s/=100,o/=108.883,i=i>.008856?Math.pow(i,1/3):7.787*i+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,o=o>.008856?Math.pow(o,1/3):7.787*o+16/116,e=116*s-16,n=500*(i-s),r=200*(s-o),[e,n,r]},o.lab.xyz=function(t){var e,n,r,i=t[0],s=t[1],o=t[2];n=(i+16)/116,e=s/500+n,r=n-o/200;var a=Math.pow(n,3),l=Math.pow(e,3),h=Math.pow(r,3);return n=a>.008856?a:(n-16/116)/7.787,e=l>.008856?l:(e-16/116)/7.787,r=h>.008856?h:(r-16/116)/7.787,e*=95.047,n*=100,r*=108.883,[e,n,r]},o.lab.lch=function(t){var e,n,r,i=t[0],s=t[1],o=t[2];return e=Math.atan2(o,s),n=360*e/2/Math.PI,n<0&&(n+=360),r=Math.sqrt(s*s+o*o),[i,r,n]},o.lch.lab=function(t){var e,n,r,i=t[0],s=t[1],o=t[2];return r=o/360*2*Math.PI,e=s*Math.cos(r),n=s*Math.sin(r),[i,e,n]},o.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:o.rgb.hsv(t)[2];if(i=Math.round(i/50),0===i)return 30;var s=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(s+=60),s},o.hsv.ansi16=function(t){return o.rgb.ansi16(o.hsv.rgb(t),t[2])},o.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];if(e===n&&n===r)return e<8?16:e>248?231:Math.round((e-8)/247*24)+232;var i=16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5);return i},o.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),e=e/10.5*255,[e,e,e];var n=.5*(1+~~(t>50)),r=(1&e)*n*255,i=(e>>1&1)*n*255,s=(e>>2&1)*n*255;return[r,i,s]},o.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;t-=16;var r=Math.floor(t/36)/5*255,i=Math.floor((n=t%36)/6)/5*255,s=n%6/5*255;return[r,i,s]},o.rgb.hex=function(t){var e=((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2])),n=e.toString(16).toUpperCase();return"000000".substring(n.length)+n},o.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16),i=r>>16&255,s=r>>8&255,o=255&r;return[i,s,o]},o.rgb.hcg=function(t){var e,n,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.max(Math.max(r,i),s),a=Math.min(Math.min(r,i),s),l=o-a;return e=l<1?a/(1-l):0,n=l<=0?0:o===r?(i-s)/l%6:o===i?2+(s-r)/l:4+(r-i)/l+4,n/=6,n%=1,[360*n,100*l,100*e]},o.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return r=n<.5?2*e*n:2*e*(1-n),r<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},o.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},o.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i=[0,0,0],s=e%1*6,o=s%1,a=1-o,l=0;switch(Math.floor(s)){case 0:i[0]=1,i[1]=o,i[2]=0;break;case 1:i[0]=a,i[1]=1,i[2]=0;break;case 2:i[0]=0,i[1]=1,i[2]=o;break;case 3:i[0]=0,i[1]=a,i[2]=1;break;case 4:i[0]=o,i[1]=0,i[2]=1;break;default:i[0]=1,i[1]=0,i[2]=a}return l=(1-n)*r,[255*(n*i[0]+l),255*(n*i[1]+l),255*(n*i[2]+l)]},o.hcg.hsv=function(t){var e=t[1]/100,n=t[2]/100,r=e+n*(1-e),i=0;return r>0&&(i=e/r),[t[0],100*i,100*r]},o.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100,r=n*(1-e)+.5*e,i=0;return r>0&&r<.5?i=e/(2*r):r>=.5&&r<1&&(i=e/(2*(1-r))),[t[0],100*i,100*r]},o.hcg.hwb=function(t){var e=t[1]/100,n=t[2]/100,r=e+n*(1-e);return[t[0],100*(r-e),100*(1-r)]},o.hwb.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1-n,i=r-e,s=0;return i<1&&(s=(r-i)/(1-i)),[t[0],100*i,100*s]},o.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},o.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},o.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},o.gray.hsl=o.gray.hsv=function(t){return[0,0,t[0]]},o.gray.hwb=function(t){return[0,100,t[0]]},o.gray.cmyk=function(t){return[0,0,0,t[0]]},o.gray.lab=function(t){return[t[0],0,0]},o.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=(e<<16)+(e<<8)+e,r=n.toString(16).toUpperCase();return"000000".substring(r.length)+r},o.rgb.gray=function(t){var e=(t[0]+t[1]+t[2])/3;return[e/255*100]}},b8fa:function(t,e){t.exports=function(t){return!(!t||"string"===typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))}},bb15:function(t,e,n){var r=n("b753"),i=n("a279"),s={},o=Object.keys(r);function a(t){var e=function(e){return void 0===e||null===e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}function l(t){var e=function(e){if(void 0===e||null===e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"===typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}o.forEach((function(t){s[t]={},Object.defineProperty(s[t],"channels",{value:r[t].channels}),Object.defineProperty(s[t],"labels",{value:r[t].labels});var e=i(t),n=Object.keys(e);n.forEach((function(n){var r=e[n];s[t][n]=l(r),s[t][n].raw=a(r)}))})),t.exports=s},c19a:function(t,e,n){"use strict";n.r(e),n.d(e,"AbstractTexture",(function(){return N})),n.d(e,"BloomPass",(function(){return Le})),n.d(e,"BoundingBox",(function(){return U})),n.d(e,"BoxBlurShader",(function(){return we})),n.d(e,"Constants",(function(){return R})),n.d(e,"CopyShader",(function(){return We})),n.d(e,"DeferredRenderer",(function(){return L})),n.d(e,"EdgeGeometry",(function(){return xt})),n.d(e,"EdgeShader",(function(){return Xe})),n.d(e,"ExtentPass",(function(){return cn})),n.d(e,"FBORayPicking",(function(){return wr})),n.d(e,"FogPass",(function(){return Je})),n.d(e,"FogShader",(function(){return $e})),n.d(e,"FxaaShader",(function(){return be})),n.d(e,"GLTFHelper",(function(){return Cn})),n.d(e,"GLTFManager",(function(){return Fn})),n.d(e,"Geometry",(function(){return Q})),n.d(e,"HDR",(function(){return si})),n.d(e,"HeatmapDisplayShader",(function(){return Ge})),n.d(e,"HeatmapShader",(function(){return He})),n.d(e,"InstancedMesh",(function(){return Lt})),n.d(e,"Jitter",(function(){return De})),n.d(e,"KHRTechniquesWebglManager",(function(){return Er})),n.d(e,"Material",(function(){return wt})),n.d(e,"Mesh",(function(){return Ft})),n.d(e,"MeshShader",(function(){return ce})),n.d(e,"PhongMaterial",(function(){return St})),n.d(e,"PhongShader",(function(){return pe})),n.d(e,"PhongSpecularGlossinessMaterial",(function(){return Rt})),n.d(e,"Plane",(function(){return Jt})),n.d(e,"PointLineShader",(function(){return Ae})),n.d(e,"PostProcessShader",(function(){return Ce})),n.d(e,"QuadShader",(function(){return xe})),n.d(e,"REGLHelper",(function(){return ft})),n.d(e,"RainRipplesPass",(function(){return an})),n.d(e,"Renderer",(function(){return F})),n.d(e,"ResourceLoader",(function(){return Bt})),n.d(e,"Scene",(function(){return Vt})),n.d(e,"Shader",(function(){return le})),n.d(e,"ShaderLib",(function(){return te})),n.d(e,"ShadowDisplayShader",(function(){return ur})),n.d(e,"ShadowMapShader",(function(){return or})),n.d(e,"ShadowPass",(function(){return cr})),n.d(e,"SkyboxShader",(function(){return Ve})),n.d(e,"SsaoPass",(function(){return Ie})),n.d(e,"SsrPass",(function(){return Be})),n.d(e,"StandardLiteMaterial",(function(){return Et})),n.d(e,"StandardLiteShader",(function(){return Ze})),n.d(e,"TaaPass",(function(){return Pe})),n.d(e,"Texture2D",(function(){return Zt})),n.d(e,"TextureCube",(function(){return Kt})),n.d(e,"ToonMaterial",(function(){return Ct})),n.d(e,"ToonShader",(function(){return ge})),n.d(e,"Util",(function(){return E})),n.d(e,"WaterShader",(function(){return qe})),n.d(e,"WireFrameMaterial",(function(){return Mt})),n.d(e,"WireframeShader",(function(){return ue})),n.d(e,"earcut",(function(){return ii})),n.d(e,"pbr",(function(){return oi}));var r=n("31d3"),i=n("c3b8"),s=n("8cfe");
/*!
 * @maptalks/reshader.gl v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */
function o(t){return!a(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function a(t){return null==t}function l(t){return!a(t)}function h(t){return!a(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}const c="function"==typeof Object.assign;function u(t){if(c)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function f(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)null!=n[e]&&(t[e]=n[e])}return t}function d(t){return"number"==typeof t&&!isNaN(t)}function p(t,e,n){return t*(1-n)+e*n}function A(t){return Array.isArray(t)||t instanceof Uint8Array||t instanceof Int8Array||t instanceof Uint16Array||t instanceof Int16Array||t instanceof Uint32Array||t instanceof Int32Array||t instanceof Uint8ClampedArray||t instanceof Float32Array||t instanceof Float64Array}function g(t){return(t=Math.abs(t))<128?Int8Array:t<32768?Int16Array:Float32Array}function m(t,e,n){return Math.min(n,Math.max(e,t))}function y(t){return t&&t.hasExtension("oes_vertex_array_object")}function v(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function x(t){if(t.data){if(t.data.BYTES_PER_ELEMENT)return t.data.length*t.data.BYTES_PER_ELEMENT;if(t.data.length)return 4*t.data.length}else{if(t.BYTES_PER_ELEMENT)return t.length*t.BYTES_PER_ELEMENT;if(t.length)return 4*t.length;if(t.buffer&&t.buffer.destroy)return t.buffer._buffer.byteLength}return 0}function b(t){return t.width*t.height*_(t.format)*w(t.type)*("textureCube"===t._reglType?6:1)}function w(t){return"uint8"===t?1:"uint16"===t||"float16"===t||"half float"===t?2:"uint32"===t||"float"===t||"float32"===t?4:0}function _(t){return"depth"===t||"alpha"===t||"luminance"===t?1:"luminance alpha"===t||"depth stencil"===t?2:"srgba"===t||"rgb5 a1"===t||"rgba"===t.substring(0,4)?4:"srgb"===t||"rgb"===t.substring(0,3)?3:1}function M(t){if(!t.componentType)return!1;const e=r["b"].getTypedArrayCtor(t.componentType);return t.byteStride>0&&t.byteStride!==t.itemSize*e.BYTES_PER_ELEMENT}function T(t){return t&&(t.stride>0||M(t))}function S(t){let e=0;const n=t&&t.length||0;if(!n)return e;let r;for(let i=0;i<n;i++)r=t.charCodeAt(i),e=(e<<5)-e+r,e&=e;return e}function I(t){return 0==(t&t-1)&&0!==t}function C(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}function O(t,e,n){if(A(t))return I(t.width)&&I(t.height)?t:function(t,e,n){let r=e,i=n;I(e)||(r=C(e)),I(n)||(i=C(n));const s=new ImageData(new Uint8ClampedArray(t),e,n),o=document.createElement("canvas");o.width=e,o.height=n,o.getContext("2d").putImageData(s,0,0);const a=document.createElement("canvas");a.width=r,a.height=i,a.getContext("2d").drawImage(o,0,0,e,n,0,0,i,i),console.warn(`Texture's size is not power of two, resize from (${e}, ${n}) to (${r}, ${i})`);let l=document.getElementById("_debug_resize_canvas");return l||(l=document.createElement("canvas"),l.id="_debug_resize_canvas",document.body.appendChild(l)),l.width=r,l.height=i,l.getContext("2d").drawImage(a,0,0),a}(t,e,n);if(I(t.width)&&I(t.height))return t;n=t.height,I(e=t.width)||(e=C(e)),I(n)||(n=C(n));const r=document.createElement("canvas");r.width=e,r.height=n,r.getContext("2d").drawImage(t,0,0,e,n);const i=t.src,s=i.lastIndexOf("/")+1,o=i.substring(s);return console.warn(`Texture(${o})'s size is not power of two, resize from (${t.width}, ${t.height}) to (${e}, ${n})`),r}var E=Object.freeze({__proto__:null,isString:o,isNil:a,defined:l,isFunction:h,extend:u,extend1:f,extend2:function(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)void 0===t[e]&&(t[e]=n[e])}return t},isNumber:d,log2:function(t){if(Math.log2)return Math.log2(t);const e=Math.log(t)*Math.LOG2E,n=Math.round(e);return Math.abs(n-e)<1e-14?n:e},normalize:function(t,e){let n=0;for(let r=0,i=e.length;r<i;r++)n+=e[r];for(let r=0,i=e.length;r<i;r++)t[r]=e[r]/n;return t},interpolate:p,isArray:A,lerp:function(t,e,n,r){for(let i=0;i<t.length;i++)t[i]=e[i]+r*(n[i]-e[i]);return t},set:function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t},getPosArrayType:g,clamp:m,isSupportVAO:y,hasOwn:v,getBufferSize:x,getTexMemorySize:b,getTextureByteWidth:w,getTextureChannels:_,isInStride:M,isInterleaved:T,getSupportedFormats:function(t){return{etc:!!t.getExtension("WEBGL_compressed_texture_etc"),etc1:!!t.getExtension("WEBGL_compressed_texture_etc1"),s3tc:!!t.getExtension("WEBGL_compressed_texture_s3tc"),pvrtc:!!t.getExtension("WEBGL_compressed_texture_pvrtc"),astc:!!t.getExtension("WEBGL_compressed_texture_astc"),bc7:!!t.getExtension("EXT_texture_compression_bptc")}},hashCode:S,isPowerOfTwo:I,resizeToPowerOfTwo:O});const P=t=>class extends t{on(t,e){return this._events||(this._events={type:[e]}),this._events[t]=this._events[t]||[],this._events[t].push(e),this}once(t,e){return this.on(t,this._wrapOnce(t,e))}off(t,e){return this._events&&this._events[t]?(this._events[t].splice(this._events[t].indexOf(e),1),this):this}fire(t,e={}){if(!this._events||!this._events[t])return this;e.target||(e.target=this);const n=this._events[t].slice(0);for(const r of n)r(e);return this}_wrapOnce(t,e){const n=this;let r=!1;return function i(s){r||(r=!0,e(s),n.off(t,i))}}},k="__reshader_disposed";var R=Object.freeze({__proto__:null,KEY_DISPOSED:k,WEBGL_EXTENSIONS:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives"],WEBGL_OPTIONAL_EXTENSIONS:["OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_texture_filter_anisotropic"]}),N=P(class{constructor(t,e){if(h(t)){this._texture=t,t=this.config={};for(const e in this._texture)v(this._texture,e)&&(h(this._texture[e])||(t[e]=this._texture[e]))}else if(this.config=t||{},this.resLoader=e,!t.url&&!t.promise||t.data)t.data&&this._needPowerOf2()&&(t.data instanceof Image?t.data=O(t.data):t.hdr||!A(t.data)||I(t.width)&&I(t.height)||(t.data=O(t.data,t.width,t.height)));else{this._loading=!0;const n=this;let r;if(t.promise)r=t.promise;else{let n;n=t.arrayBuffer?e.getArrayBuffer:e.get,r=n.call(e,t.url)}t.data=e.getDefaultTexture(t.url),this.promise=r,r.then(t=>(delete this.promise,n._loading=!1,n.config?(t.data instanceof Image&&this._needPowerOf2()&&(t.data=O(t.data)),n.onLoad(t),Array.isArray(t)||(t=[t]),n.fire("complete",{target:this,resources:t}),t):t)).catch(t=>{console.error("error when loading texture image.",t),n.fire("error",{target:this,error:t})})}}isReady(){return!this._loading}set(t,e){return this.config[t]=e,this.dirty=!0,this}get(t){return this.config[t]}getREGLTexture(t){return this._texture||(this._texture=this.createREGLTexture(t),this.config.persistent||(this.config.data&&(this.config.data instanceof ImageBitmap||(this.config.data=[])),this.config.faces&&(this.config.faces=[]),this.config.image&&(this.config.image.array=[]),this.config.mipmap&&delete this.config.mipmap)),this.dirty&&this._updateREGL(),this._texture}getMemorySize(){if(!this.config)return 0;const{width:t,height:e,type:n,format:r}=this.config,i=w(n||"uint8"),s=_(r||"rgba");return this.config.faces?t*e*i*s*6:t*e*i*s}_updateREGL(){this._texture&&!this._texture[k]&&this._texture(this.config),this.dirty=!1}dispose(){this.config&&this.config.url&&(URL.revokeObjectURL(this.config.url),this.resLoader.disposeRes(this.config.url)),this.config&&this.config.data instanceof ImageBitmap&&(this.config.data.close(),this.config.data=[]),this._texture&&!this._texture[k]&&(this._texture._reshader_refCount&&this._texture._reshader_refCount--,this._texture._reshader_refCount||(this._texture.destroy(),this._texture[k]=!0,delete this._texture)),delete this.resLoader;const t=this.config&&this.config.url;delete this.config,t&&this.fire("disposed",{target:this,url:t})}_needPowerOf2(){const t=this.config;return t.wrap&&"clamp"!==t.wrap||t.wrapS&&"clamp"!==t.wrapS||t.wrapT&&"clamp"!==t.wrapT||t.min&&"nearest"!==t.min&&"linear"!==t.min}});const D={};class F{constructor(t){this.regl=t}render(t,e,n,r){t.setUniforms(e||D),t.setFramebuffer(r);let i=0;if(n){const{opaques:e,transparents:r}=n.getSortedMeshes();i+=t.draw(this.regl,e),i+=t.draw(this.regl,r)}else i+=t.draw(this.regl);return i}clear(t){this.regl.clear(t)}}class L extends F{}const z=[],B=i["c"].identity([]),H={min:[],max:[]};class U{constructor(t,e){this.min=t||[1/0,1/0,1/0],this.max=e||[-1/0,-1/0,-1/0],this.updateVertex()}static copy(t,e){i["f"].copy(t.min,e.min),i["f"].copy(t.max,e.max);for(let n=0;n<e.vertex.length;n++)i["f"].copy(t.vertex[n],e.vertex[n]);return t}combine(t){return t?(Array.isArray(t)&&(i["f"].copy(H.min,t[0]),i["f"].copy(H.max,t[1]),t=H),t.min[0]<this.min[0]&&(this.min[0]=t.min[0],this._dirty=!0),t.min[1]<this.min[1]&&(this.min[1]=t.min[1],this._dirty=!0),t.min[2]<this.min[2]&&(this.min[2]=t.min[2],this._dirty=!0),t.max[0]>this.max[0]&&(this.max[0]=t.max[0],this._dirty=!0),t.max[1]>this.max[1]&&(this.max[1]=t.max[1],this._dirty=!0),t.max[2]>this.max[2]&&(this.max[2]=t.max[2],this._dirty=!0),this):this}dirty(){return this._dirty=!0,this}getCenter(){return this.center||(this.center=[],this._dirty=!0),this._dirty&&(i["f"].add(this.center,this.min,this.max),i["f"].scale(this.center,this.center,.5)),this._dirty=!1,this.center}containPoint(t){const e=this.min,n=this.max;return e[0]<=t[0]&&e[1]<=t[1]&&e[2]<=t[2]&&n[0]>=t[0]&&n[1]>=t[1]&&n[2]>=t[2]}isFinite(){const t=this.min,e=this.max;return isFinite(t[0])&&isFinite(t[1])&&isFinite(t[2])&&isFinite(e[0])&&isFinite(e[1])&&isFinite(e[2])}updateVertex(){if(!this.vertex){this.vertex=[];for(let t=0;t<8;t++)this.vertex.push([])}return this.vertex[0][0]=this.min[0],this.vertex[0][1]=this.min[1],this.vertex[0][2]=this.min[2],this.vertex[1][0]=this.min[0],this.vertex[1][1]=this.min[1],this.vertex[1][2]=this.max[2],this.vertex[2][0]=this.min[0],this.vertex[2][1]=this.max[1],this.vertex[2][2]=this.max[2],this.vertex[3][0]=this.min[0],this.vertex[3][1]=this.max[1],this.vertex[3][2]=this.min[2],this.vertex[4][0]=this.max[0],this.vertex[4][1]=this.min[1],this.vertex[4][2]=this.min[2],this.vertex[5][0]=this.max[0],this.vertex[5][1]=this.min[1],this.vertex[5][2]=this.max[2],this.vertex[6][0]=this.max[0],this.vertex[6][1]=this.max[1],this.vertex[6][2]=this.max[2],this.vertex[7][0]=this.max[0],this.vertex[7][1]=this.max[1],this.vertex[7][2]=this.min[2],this.vertex}copy(t){return t?U.copy(t,this):new U(this.min.slice(),this.max.slice())}equals(t){if(!i["f"].equals(this.min,t.min)||!i["f"].equals(this.max,t.max))return!1;const e=t.vertex;for(let n=0;n<this.vertex.length;n++)if(!i["f"].equals(e[n],this.vertex[n]))return!1;return!0}transform(t,e){if(t=t||B,(e=e||B)[1]||e[2]||e[4]||e[6]||e[8]||e[9]){const n=this.vertex,r=i["c"].multiply(z,e,t);for(let t=0;t<n.length;t++)i["f"].transformMat4(this.vertex[t],this.vertex[t],r);const s=this.vertex.map(t=>t[0]),o=this.vertex.map(t=>t[1]),a=this.vertex.map(t=>t[2]),l=Math.min(...s),h=Math.max(...s),c=Math.min(...o),u=Math.max(...o),f=Math.min(...a),d=Math.max(...a);i["f"].set(this.min,l,c,f),i["f"].set(this.max,h,u,d)}else{const n=i["c"].multiply(z,e,t);i["f"].transformMat4(this.min,this.min,n),i["f"].transformMat4(this.max,this.max,n)}return this}}const j=[],V={5120:"int8",5122:"int16",5124:"int32",5121:"uint8",5123:"uint16",5125:"uint32",5126:"float"},G={5120:1,5122:2,5124:4,5121:1,5123:2,5125:4,5126:4},q={positionSize:3,primitive:"triangles",positionAttribute:"aPosition",normalAttribute:"aNormal",uv0Attribute:"aTexCoord",uv1Attribute:"aTexCoord1",color0Attribute:"aColor0",tangentAttribute:"aTangent",pickingIdAttribute:"aPickingId",textureCoordMatrixAttribute:"aTextureCoordMatrix"};let W=1;const X="_reshader_refCount";class Q{constructor(t,e,n,r){this._version=0,this.data=t,this.elements=e,this.desc=u({},q,r);const i=this._getPosAttritute();this.data[this.desc.positionAttribute]=i,n||(this.elements?n=Y(this.elements):i&&i.length?n=i.length/this.desc.positionSize:i&&i.interleavedArray?n=i.interleavedArray.length/this.desc.positionSize:i&&i.array&&(n=i.array.length/this.desc.positionSize)),this.count=n,this.elements||(this.elements=n),this.properties={},this._buffers={},this._vao={},this.getVertexCount(),this._prepareData(!0),this.updateBoundingBox()}set version(t){throw new Error("Geometry.version is read only.")}get version(){return this._version}_getPosAttritute(){return this.data[this.desc.positionAttribute]}_prepareData(t){if(!this.data)return;const e=this._buffers||{};for(const r in this.data){const n=this.data[r];if(n)if(n.buffer&&n.buffer.destroy){const e=n.buffer;e[X]||(e[X]=0),t&&e[X]++}else if(n&&n.array)if(M(n)){let t=n.array.buffer.__id;t||(t=n.array.buffer.__id=W++),this.data[r]={buffer:t,offset:n.byteOffset,stride:n.byteStride,type:V[n.componentType],size:n.itemSize,count:n.count,componentType:n.componentType},e[t]||(e[t]={data:n.array.buffer})}else this.data[r]=n.array}this._buffers=e;const n=this.elements;n&&n.array&&(this.elements=this.elements.array)}getAttrData(t){const e=t.key,n=!this._reglData||!this._reglData[e];if(this._reglData||(this._reglData={}),n){const t=this._reglData[e]={},n=this.data,{positionAttribute:r,normalAttribute:i,uv0Attribute:s,uv1Attribute:o,tangentAttribute:a,color0Attribute:l,pickingIdAttribute:h,textureCoordMatrixAttribute:c}=this.desc;u(t,this.data),t.aPosition=n[r],n[i]&&(t.aNormal=n[i]),n[s]&&(t.aTexCoord=n[s]),n[o]&&(t.aTexCoord1=n[o]),n[a]&&(t.aTangent=n[a]),n[l]&&(t.aColor0=n[l]),n[h]&&(t.aPickingId=n[h]),n[c]&&(t.aTextureCoordMatrix=n[c])}return this._reglData[e]}getREGLData(t,e,n){this.getAttrData(e);const r=!this._reglData||!this._reglData[e.key];if(y(t)&&!n){const n=e&&e.key||"default";if(!this._vao[n]||r||this._vao[n].dirty){const r=this._reglData[e.key],i=this._vertexCount,s=[];for(let t=0;t<e.length;t++){const n=e[t].name,o=r[n]&&r[n].buffer;if(o&&o.destroy)s.push(void 0!==r[n].stride?r[n]:o);else{const t=r[n];if(!t){s.push(this.desc.fillEmptyDataInMissingAttribute?new Uint8Array(4*i):j);continue}const e=(t.data&&A(t.data)?t.data.length:t.length)/i;t.data?(t.dimension=e,s.push(t)):s.push({data:t,dimension:e})}}const o={attributes:s,primitive:this.getPrimitive()};if(this.elements&&!d(this.elements))if(this.elements.destroy)o.elements=this.elements;else{o.elements={primitive:this.getPrimitive(),data:this.elements};const t=this.getElementsType(this.elements);t&&(o.elements.type=t)}this._vao[n]?this._vao[n].vao(o):this._vao[n]={vao:t.vao(o)}}return delete this._vao[n].dirty,this._vao[n]}return this._reglData[e.key]}_isAttrChanged(t){if(t===this._activeAttributes)return!1;if(t.length!==this._activeAttributes.length)return!0;for(let e=0;e<t.length;e++)if(t[e]!==this._activeAttributes[e])return!0;return!1}generateBuffers(t){const e=this._buffers;for(const a in e)e[a].buffer||(e[a].buffer=t.buffer(e[a].data)),delete e[a].data;const n=this.desc.positionAttribute,r=this.desc.altitudeAttribute,i=this.data,s=this._vertexCount,o={};for(const a in i)if(i[a]){if(void 0===i[a].buffer||i[a].buffer instanceof ArrayBuffer){const e=i[a].data?i[a]:{data:i[a]};e.dimension=(i[a].data?i[a].data:i[a]).length/s;const l=t.buffer(e);l[X]=1,o[a]={buffer:l},a!==n&&a!==r||(o[a].array=i[a])}else i[a].buffer.destroy?o[a]=i[a]:e[i[a].buffer]&&(o[a]=u({},i[a]),o[a].buffer=e[i[a].buffer].buffer);(this.desc.static||a!==n)&&delete i[a].array}if(this.data=o,delete this._reglData,this.elements&&!d(this.elements)){const e={primitive:this.getPrimitive(),data:this.elements},n=this.getElementsType(this.elements);if(n&&(e.type=n),!this.desc.static&&!this.elements.destroy){this.indices=new Uint16Array(this.elements.length);for(let t=0;t<this.elements.length;t++)this.indices[t]=this.elements[t]}this.elements=this.elements.destroy?this.elements:t.elements(e);const r=this.elements;r[X]||(r[X]=0),r[X]++}}getVertexCount(){const{positionAttribute:t,positionSize:e,color0Attribute:n}=this.desc;let r=this.data[t];r.data&&(r=r.data),r.array&&(r=r.array),A(r)?this._vertexCount=Math.ceil(r.length/e):r&&void 0!==r.count&&(this._vertexCount=r.count);const i=n;if(this.data[i]){const t=this.data[i].data||this.data[i].array||this.data[i];Array.isArray(t)?this._color0Size=t.length/this._vertexCount:t&&t.count?this._color0Size=t.count/this._vertexCount:this.data[i].buffer&&this.data[i].buffer.destroy&&(this._color0Size=this.data[i].buffer._buffer.dimension)}return this._vertexCount}getColor0Size(){return this._color0Size||0}addBuffer(t,e){return this._buffers[t]={data:e},delete this._reglData,this._deleteVAO(),this}updateBuffer(t,e){if(!this._buffers[t])throw new Error(`invalid buffer ${t} in geometry`);return this._buffers[t].buffer?this._buffers[t].buffer.subdata(e):this._buffers[t].data=e,delete this._reglData,this._deleteVAO(),this}deleteData(t){const e=this.data[t];return e?(this._incrVersion(),e.buffer&&e.buffer.destroy&&e.buffer.destroy(),delete this.data[t],delete this._reglData,this._markVAODirty(),this):this}updateData(t,e){const n=this.data[t];if(!n)return this;let r;return this._incrVersion(),this.data[t]=e,n.buffer&&n.buffer.destroy&&(r=n),t===this.desc.positionAttribute&&this.updateBoundingBox(),this.getVertexCount(),r&&(r.buffer(e),this.data[t]=r),this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}updateSubData(t,e,n){const r=this.data[t];if(!r)return this;let i;if(this._incrVersion(),r.buffer&&r.buffer.destroy&&(i=r),t===this.desc.positionAttribute&&this._updateSubBoundingBox(e),i){const t=G[i.buffer._buffer.dtype];e.BYTES_PER_ELEMENT!==t&&(e=new(function(t,e){return t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array||t instanceof Uint8ClampedArray?1===e?Uint8Array:2===e?Uint16Array:Uint32Array:t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array?1===e?Int8Array:2===e?Int16Array:Int32Array:t instanceof Float32Array||t instanceof Float64Array?4===e?Float32Array:Float64Array:null}(e,t))(e)),i.buffer.subdata(e,n*t)}else{const r=this.data[t].data?this.data[t].data:this.data[t];for(let t=0;t<e.length;t++)r[n+t]=e[t]}return this._prepareData(!1),this.desc.positionAttribute===t&&(this._posDirty=!0),delete this._reglData,this}getPrimitive(){return this.desc.primitive}getElements(){return this.elements}setElements(t,e){if(!t)throw new Error("elements data is invalid");this._incrVersion();const n=this.elements;return this.count=void 0===e?Y(t):e,this.elements=t&&t.destroy?t:n.destroy?n(t):t,this._markVAODirty(!0),this}deleteElements(){return this.elements&&0!==this.elements.length?(this._incrVersion(),this.elements&&this.elements.destroy&&!this.elements[k]&&(this.elements.destroy(),this.elements[k]=1),this.elements=[],this._markVAODirty(!0),this):this}_markVAODirty(t){if(this._vao){for(const e in this._vao)t?this._vao[e].vao.destroy():this._vao[e].dirty=!0;t&&(this._vao={})}}setDrawCount(t){return this._incrVersion(),this.count1=t,this}getDrawCount(){return this.count1>=0?this.count1:this.count}setDrawOffset(t){return this._incrVersion(),this.offset=t,this}getDrawOffset(){return this.offset||0}dispose(){if(this._deleteVAO(),this._forEachBuffer(t=>{if(!t[k]){let e=t[X];e&&e--,e<=0?(t[k]=!0,t.destroy()):t[X]=e}}),this.properties){const t=this.properties.oldElementsBeforeHighlight;t&&!t[k]&&t.destroy&&(t.destroy(),t[k]=!0),delete this.properties.oldElementsBeforeHighlight,delete this.properties.hasInvisible}this.data={},this._buffers={},delete this._reglData,delete this._attributes,this.count=0,this.elements=[],delete this._tempPosArray,this._disposed=!0}isDisposed(){return!!this._disposed}updateBoundingBox(){let t=this.boundingBox;t||(t=this.boundingBox=new U);let e,n,r=this.data[this.desc.positionAttribute];if(A(r)||(r.data?r=r.data:T(r)?r=this._getAttributeData(this.desc.positionAttribute):r.array&&(e=r.min,n=r.max,r=r.array)),r&&r.length){const s=t.min,o=t.max;if(e&&n)i["f"].set(s,...e),i["f"].set(o,...n);else{i["f"].set(s,r[0],r[1],r[2]),i["f"].set(o,r[0],r[1],r[2]);for(let t=3;t<r.length;){const e=r[t++],n=r[t++],i=r[t++];e<s[0]&&(s[0]=e),n<s[1]&&(s[1]=n),i<s[2]&&(s[2]=i),e>o[0]&&(o[0]=e),n>o[1]&&(o[1]=n),i>o[2]&&(o[2]=i)}}t.updateVertex(),t.dirty()}}_updateSubBoundingBox(t){const e=this.boundingBox,n=e.min,r=e.max,i=this.desc.positionSize;for(let s=0;s<t.length;){const e=t[s++],o=t[s++];let a=0;3===i&&(a=t[s++]),e<n[0]&&(n[0]=e),o<n[1]&&(n[1]=o),a<n[2]&&(n[2]=a),e>r[0]&&(r[0]=e),o>r[1]&&(r[1]=o),a>r[2]&&(r[2]=a)}e.updateVertex(),e.dirty()}_getAttributeData(t){const e=this.data[t]&&this.data[t].array?this.data[t].array:this.data[t],n=e.buffer;if(T(e)){const i=this._buffers[n]?this._buffers[n].data:e.array,{count:s,size:o,stride:a,offset:l,componentType:h}=e,c=r["b"].getTypedArrayCtor(h);if((0===a||a===o*c.BYTES_PER_ELEMENT)&&l%c.BYTES_PER_ELEMENT==0)return new c(i,l,s*o);if(t===this.desc.positionAttribute)return!this._tempPosArray||this._tempPosArray&&this._tempPosArray.length<o*s?(this._tempPosArray=new c(o*s),r["b"].readInterleavedArray(this._tempPosArray,i,s,o,a,l,h)):this._posDirty?(this._posDirty=!1,r["b"].readInterleavedArray(this._tempPosArray,i,s,o,a,l,h)):this._tempPosArray;{const t=new c(o*s);return r["b"].readInterleavedArray(t,i,s,o,a,l,h)}}return e}createTangent(t="aTangent"){this._incrVersion();const{normalAttribute:e,positionAttribute:n,uv0Attribute:r}=this.desc,o=this._getAttributeData(e),a=this._getAttributeData(n),l=Object(s["b"])(a,o,this.data[r],this.elements),h=this.data[t]=new Float32Array(l.length),c=[],u=[],f=[];for(let d=0;d<l.length;d+=4){const t=d/4*3;i["f"].set(u,o[t],o[t+1],o[t+2]),i["g"].set(c,l[d],l[d+1],l[d+2],l[d+3]),Object(s["c"])(f,u,c),i["g"].copy(h.subarray(d,d+4),f)}delete this._reglData}createNormal(t="aNormal"){this._incrVersion();const e=this._getAttributeData(this.desc.positionAttribute);this.data[t]=Object(s["a"])(e.array||e,this.elements),delete this._reglData}createBarycentric(t="aBarycentric"){if("triangles"!==this.desc.primitive)throw new Error("Primitive must be triangles to create bary centric data");this._incrVersion();const e=new Uint8Array(3*this._vertexCount);for(let n=0,r=this.elements.length;n<r;)for(let t=0;t<3;t++)e[3*this.elements[n++]+t]=1;this.data[t]=e,delete this._reglData}buildUniqueVertex(){this._incrVersion();const t=this.data,e=this.elements;if(!A(e))throw new Error("elements must be array to build unique vertex.");const n=Object.keys(t),r={};let i=t[this.desc.positionAttribute];if(i=i.length?i:i.array,!A(i))throw new Error(this.desc.positionAttribute+" must be array to build unique vertex.");const s=this._vertexCount,o=e.length;for(let l=0;l<n.length;l++){const e=n[l],i=A(t[e])?t[e]:t[e].array,a=i.length/s;if(!A(i))throw new Error(e+" must be array to build unique vertex.");r[e]=i,t[e]=new i.constructor(o*a)}let a=0;for(let l=0;l<o;l++){const i=e[l];for(let e=0;e<n.length;e++){const o=n[e],l=t[o],h=r[o].length/s;for(let t=0;t<h;t++)l[a*h+t]=r[o][i*h+t]}e[l]=a++}i=this.data[this.desc.positionAttribute],this._vertexCount=Math.ceil(i.length/this.desc.positionSize),delete this._reglData}getMemorySize(){let t=0;for(const e in this.data)v(this.data,e)&&(t+=x(this.data[e]));if(this.elements){const e=this.elements;e.destroy?t+=e._elements.buffer.byteLength:e.BYTES_PER_ELEMENT?t+=e.length*e.BYTES_PER_ELEMENT:e.length&&(t+=4*e.length)}return t}_deleteVAO(){for(const t in this._vao)this._vao[t].vao.destroy();this._vao={}}_forEachBuffer(t){this.elements&&this.elements.destroy&&t(this.elements);for(const e in this.data)v(this.data,e)&&this.data[e]&&this.data[e].buffer&&this.data[e].buffer.destroy&&t(this.data[e].buffer);for(const e in this._buffers)v(this._buffers,e)&&this._buffers[e]&&this._buffers[e].buffer&&this._buffers[e].buffer.destroy&&t(this._buffers[e].buffer)}getElementsType(t){return t instanceof Uint8Array?"uint8":t instanceof Uint16Array?"uint16":t instanceof Uint32Array?"uint32":void 0}_incrVersion(){this._version++}}function Y(t){if(d(t))return t;if(void 0!==t.count)return t.count;if(t.destroy)return t._elements.vertCount;if(void 0!==t.length)return t.length;if(t.data)return t.data.length;throw new Error("invalid elements length")}const Z=["points","lines","line strip","line loop","triangles","triangle strip","triangle fan"];function K(t){return Z[t]}const J={5121:"uint8",5123:"uint16",5125:"uint32",5126:"float",36193:"half float"};function $(t){return J[t]}const tt={6406:"alpha",6407:"rgb",6408:"rgba",6409:"luminance",6410:"luminance alpha",33776:"rgb s3tc dxt1",33777:"rgba s3tc dxt1",33778:"rgba s3tc dxt3",33779:"rgba s3tc dxt5",35840:"rgb pvrtc 4bppv1",35841:"rgb pvrtc 2bppv1",35842:"rgba pvrtc 4bppv1",35843:"rgba pvrtc 2bppv1",35986:"rgb atc",35987:"rgba atc explicit alpha",34798:"rgba atc interpolated alpha",36196:"rgb etc1"};function et(t){return tt[t]}const nt={9729:"linear",9728:"nearest"};function rt(t){return nt[t]}const it={9729:"linear",9728:"nearest",9984:"nearest mipmap nearest",9985:"linear mipmap nearest",9986:"nearest mipmap linear",9987:"linear mipmap linear"};function st(t){return it[t]}const ot={10497:"repeat",33071:"clamp",33648:"mirror"};function at(t){return ot[t]}const lt="__reshader_webgl_buffer",ht="__reshader_webgl_tex";function ct(t,e,n){let r;if(A(e)?e.buffer&&void 0!==e.byteOffset&&(r=e):e.array&&e.array.buffer&&void 0!==e.array.byteOffset&&(r=e.array),!r)return null;const i=r.buffer,s=r.byteOffset;i[lt]||(i[lt]={});let o=i[lt][s];if(!o){const e={};n&&u(e,n),e.data=r,o=t.buffer(e),i[lt][s]=o}return o}function ut(t,e){const n=e.data;if(!n||!n.buffer)return t.texture(e);const r=n.buffer,i=n.byteOffset;r[ht]||(r[ht]={});let s=r[ht][i];return s||(s=t.texture(e),r[ht][i]=s),s}var ft=Object.freeze({__proto__:null,getPrimitive:K,getMaterialType:$,getMaterialFormat:et,getTextureMagFilter:rt,getTextureMinFilter:st,getTextureWrap:at,getUniqueREGLBuffer:ct,getUniqueTexture:ut});const dt=[],pt=[],At=[],gt=[],mt=[],yt=[],vt=["a","b","c"];class xt extends Q{constructor(t,e,n,r){super(t,e,n,{primitive:K(1),positionAttribute:r.positionAttribute})}_getPosAttritute(){const t=this.data[this.desc.positionAttribute];if(!t)return null;const e=Math.pow(10,4),n=Math.cos(Math.PI/180*.8),r=this.elements,i=t.length?t:t.array,s=r.length?r?r.length:i.length/3:r,o=[0,0,0],a=new Array(3),l={},h=[],c=new bt;for(let u=0;u<s;u+=3){r.length?(o[0]=r[u],o[1]=r[u+1],o[2]=r[u+2]):(o[0]=u,o[1]=u+1,o[2]=u+2),c.a=this._getPos(gt,i,o[0]),c.b=this._getPos(mt,i,o[1]),c.c=this._getPos(yt,i,o[2]);const t=c.getNormal(),s=c.a,f=c.b,d=c.c;if(a[0]=`${Math.round(s[0]*e)},${Math.round(s[1]*e)},${Math.round(s[2]*e)}`,a[1]=`${Math.round(f[0]*e)},${Math.round(f[1]*e)},${Math.round(f[2]*e)}`,a[2]=`${Math.round(d[0]*e)},${Math.round(d[1]*e)},${Math.round(d[2]*e)}`,a[0]!==a[1]&&a[1]!==a[2]&&a[2]!==a[0])for(let e=0;e<3;e++)this._calEdgeData(e,o,c,l,a,n,t,h)}for(const u in l)if(l[u]){const{index0:t,index1:e}=l[u];h.push(i[3*t],i[3*t+1],i[3*t+2]),h.push(i[3*e],i[3*e+1],i[3*e+2])}return this.elements=this._createElements(h),h}_getPos(t,e,n){return i["f"].set(t,e[3*n],e[3*n+1],e[3*n+2])}_calEdgeData(t,e,n,r,s,o,a,l){const h=(t+1)%3,c=s[t],u=s[h],f=n[vt[t]],d=n[vt[h]],p=`${c}_${u}`,A=`${u}_${c}`;A in r&&r[A]?(i["f"].dot(a,r[A].normal)<=o&&(l.push(f[0],f[1],f[2]),l.push(d[0],d[1],d[2])),r[A]=null):p in r||(r[p]={index0:e[t],index1:e[h],normal:i["f"].copy([],a)})}_createElements(t){const e=[],n=t.length/3;for(let r=0;r<n;r++)e.push(r);return e}}class bt{constructor(t=[0,0,0],e=[0,0,0],n=[0,0,0]){this.a=t,this.b=e,this.c=n}getNormal(){const t=i["f"].sub(dt,this.a,this.b),e=i["f"].sub(pt,this.a,this.c);i["f"].cross(At,t,e);const n=i["f"].length(At);return i["f"].set(At,At[0]/n,At[1]/n,At[2]/n)}}var wt=P(class{constructor(t={},e){this._version=0,this.uniforms=f({},e||{},t);for(const n in t){const e=Object.getOwnPropertyDescriptor(t,n).get;e&&Object.defineProperty(this.uniforms,n,{get:e})}this._reglUniforms={},this.refCount=0,this._bindedOnTextureComplete=this._onTextureComplete.bind(this),this._genUniformKeys(),this._checkTextures()}set version(t){throw new Error("Material.version is read only.")}get version(){return this._version}set doubleSided(t){this._doubleSided=t}get doubleSided(){return this._doubleSided}isReady(){return this._loadingCount<=0}set(t,e){const n=a(this.uniforms[t])&&!a(e)||!a(this.uniforms[t])&&a(e);if(this.uniforms[t]&&this.isTexture(t)&&this.uniforms[t].dispose(),a(e))a(this.uniforms[t])||delete this.uniforms[t];else if(this.uniforms[t]=e,this._reglUniforms){const n=Object.getOwnPropertyDescriptor(this._reglUniforms,t);n&&!n.get&&(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(t),this._reglUniforms[t]=e)}return this.isTexture(t)&&this._checkTextures(),n&&(this._genUniformKeys(),this._incrVersion()),this}_getDirtyProps(){return this._dirtyProps}_clearDirtyProps(){this._dirtyProps=null}get(t){return this.uniforms[t]}isDirty(){return this._uniformVer!==this.version}appendDefines(t){const e=this.uniforms;return e?(e.jointTexture&&(t.HAS_SKIN=1),e.morphWeights1&&(t.HAS_MORPH=1),(e.khr_offset||e.khr_rotation||e.khr_scale)&&(t.HAS_KHR_TEXTURE_TRANSFORM=1),t):t}hasSkinAnimation(){return this.uniforms&&this.uniforms.jointTexture&&this.uniforms.skinAnimation}getUniforms(t){if(this._reglUniforms&&!this.isDirty())return this._reglUniforms;const e=this.uniforms,n={};for(const r in e)this.isTexture(r)?Object.defineProperty(n,r,{enumerable:!0,configurable:!0,get:function(){return e[r].getREGLTexture(t)}}):Object.getOwnPropertyDescriptor(e,r).get?Object.defineProperty(n,r,{enumerable:!0,configurable:!0,get:function(){return e[r]}}):n[r]=e[r];return this._reglUniforms=n,this._uniformVer=this.version,n}isTexture(t){return this.uniforms[t]instanceof N}dispose(){for(const t in this.uniforms){const e=this.uniforms[t];e&&(e.dispose?e.dispose():e.destroy&&!e[k]&&(e.destroy(),e[k]=!0))}delete this.uniforms,delete this._reglUniforms,this._disposed=!0}isDisposed(){return!!this._disposed}_checkTextures(){this._loadingCount=0;for(const t in this.uniforms)if(this.isTexture(t)){const e=this.uniforms[t];e.isReady()||(this._loadingCount++,e.on("complete",this._bindedOnTextureComplete))}}_onTextureComplete(){this._loadingCount--,this._incrVersion(),this._loadingCount<=0&&(this._disposed||this.fire("complete"))}getUniformKeys(){return this._uniformKeys}_genUniformKeys(){const t=[];for(const e in this.uniforms)v(this.uniforms,e)&&!a(this.uniforms[e])&&t.push(e);this._uniformKeys=t.join()}_incrVersion(){this._version++}getMemorySize(){const t=this.uniforms;let e=0;for(const n in t)this.isTexture(n)?e+=t[n].getMemorySize():this.uniforms[n].destroy&&(e+=b(this.uniforms[n]));return e}});const _t={time:0,seeThrough:!0,thickness:.03,fill:[1,.5137254902,.98,1],stroke:[.7019607843,.9333333333,.2274509804,1],dashEnabled:!1,dashAnimate:!1,dashRepeats:1,dashLength:.8,dashOverlap:!0,insideAltColor:!1,squeeze:!1,squeezeMin:.5,squeezeMax:1,dualStroke:!1,secondThickness:.05,opacity:1,noiseEnable:!1};class Mt extends wt{constructor(t){super(t,_t)}}const Tt={baseColorFactor:[1,1,1,1],materialShininess:32,environmentExposure:1,specularStrength:32,opacity:1,extrusionOpacity:0,extrusionOpacityRange:[0,1.8],baseColorTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null,uvScale:[1,1],uvOffset:[0,0],alphaTest:0};class St extends wt{constructor(t){super(t,Tt)}static convertFrom(t){const e={};for(const n in Tt)e[n]=t.get(n);return new St(e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t):t}}const It={toons:4,specularToons:2};class Ct extends St{constructor(t){super(t,It)}}const Ot={baseColorFactor:[1,1,1,1],uvScale:[1,1],uvOffset:[0,0],opacity:1,envMapExposure:128,emissiveFactor:[.1,.1,.1],specularFactor:[0,0,0],envRotationSin:0,envRotationCos:1,reflectivity:.01,themingColor:[0,0,0,0],exposureBias:.6};class Et extends wt{constructor(t){super(t,Ot)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.extrusionOpacity&&(t.HAS_EXTRUSION_OPACITY=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_BASECOLOR_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),(t.HAS_BASECOLOR_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP)&&(t.HAS_MAP=1),t.ALPHATEST=.01,t.GAMMA_INPUT=1,t.GAMMA_FACTOR=1,t.TONEMAP_OUTPUT=1,t.ENVMAP_MODE_REFLECTION=1,t.ENV_RGBM=1,t.IRR_RGBM=1,t):t}}const Pt={diffuseFactor:[1,1,1,1],specularFactor:[1,1,1],glossinessFactor:1,diffuseTexture:null,specularGlossinessTexture:null,normalTexture:null,emissiveTexture:null,occlusionTexture:null},kt=t=>class extends t{constructor(t){super(t=u({},Pt,t||{}))}appendDefines(t,e){if(super.appendDefines(t,e),t.SHADING_MODEL_SPECULAR_GLOSSINESS=1,!e.data[e.desc.uv0Attribute])return t;const n=this.uniforms;return n.diffuseTexture&&(t.HAS_DIFFUSE_MAP=1),n.specularGlossinessTexture&&(t.HAS_SPECULARGLOSSINESS_MAP=1),(t.HAS_SPECULARGLOSSINESS_MAP||t.HAS_DIFFUSE_MAP)&&(t.HAS_MAP=1),t}};class Rt extends(kt(St)){}const Nt=[];let Dt=0;class Ft{constructor(t,e,n={}){this._version=0,this._geometry=t,this._material=e,this.transparent=!!n.transparent,this.bloom=!!n.bloom,this.ssr=!!n.ssr,this.castShadow=a(n.castShadow)||n.castShadow,this.picking=!!n.picking,this.disableVAO=!!n.disableVAO,this.uniforms={},this._localTransform=i["c"].identity(new Array(16)),this._positionMatrix=i["c"].identity(new Array(16)),this.properties={},this._dirtyUniforms=!0,this._dirtyGeometry=!0,Object.defineProperty(this,"uuid",{value:Dt++}),Dt>Number.MAX_VALUE-10&&(Dt=0)}set material(t){this._material!==t&&this.setMaterial(t)}get material(){return this._material}set version(t){throw new Error("Mesh.version is read only.")}get version(){return this._version}get geometry(){return this._geometry}set geometry(t){this._geometry!==t&&(this._incrVersion(),this._dirtyGeometry=!0),this._geometry=t}set localTransform(t){this._prevTMat||(this._prevTMat=[]),Array.isArray(t)&&!i["c"].exactEquals(this._prevTMat,t)&&(this._incrVersion(),this._prevTMat=i["c"].copy(this._prevTMat,t)),this._localTransform=t}get localTransform(){return this._localTransform}set positionMatrix(t){this._prevPMat||(this._prevPMat=[]),Array.isArray(t)&&!i["c"].exactEquals(this._prevPMat,t)&&(this._incrVersion(),this._prevPMat=i["c"].copy(this._prevPMat,t)),this._positionMatrix=t}get positionMatrix(){return this._positionMatrix}get config(){return this._cfg||(this._cfg={}),this._cfg.transparent=this.transparent,this._cfg.castShadow=this.castShadow,this._cfg.bloom=this.bloom,this._cfg.ssr=this.ssr,this._cfg.picking=this.picking,this._cfg}get defines(){return this._getDefines()}set defines(t){this.setDefines(t)}setMaterial(t){return this._material=t,this._dirtyUniforms=!0,delete this._materialVer,this.dirtyDefines=!0,this}setParent(t){return this.parent=t,this}setLocalTransform(t){return this.localTransform=t,this}setPositionMatrix(t){this.positionMatrix=t}setUniform(t,e){return void 0===this.uniforms[t]?this._dirtyUniforms=!0:(this._dirtyProps=this._dirtyProps||[],this._dirtyProps.push(t)),this.uniforms[t]=e,this}getUniform(t){return this.uniforms[t]}getDefines(){const t={};return u(t,this._getDefines()),this._material&&this._geometry&&this._material.appendDefines(t,this._geometry),t}_getDefines(){this._defines||(this._defines={});const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],r=t.data[t.desc.normalAttribute];return e&&e.quantization&&(this._defines.HAS_DRACO_POSITION=1),n&&n.quantization&&(this._defines.HAS_DRACO_TEXCOORD=1),r&&r.quantization&&(this._defines.HAS_DRACO_NORMAL=1),this._defines}setDefines(t){const e=this._bakDefines;return this._defines=t,this.dirtyDefines=this.dirtyDefines||!!e!=!!t||!function(t,e){if(!t&&!e)return!0;const n=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(e);if(n.length!==r.length)return!1;for(let i=0;i<n.length;i++)if(t[n[i]]!==e[n[i]])return!1;return!0}(e,t),this.dirtyDefines&&(this._bakDefines=u({},t)),this}hasSkinAnimation(){return this._material&&this._material.hasSkinAnimation()}_getDefinesKey(){return this.dirtyDefines=!1,this._createDefinesKey(this.getDefines())}getCommandKey(){if(!this._commandKey||this.dirtyDefines||this._material&&this._materialKeys!==this._material.getUniformKeys()){let t=this._getDefinesKey();t+="_"+(d(this.getElements())?"count":"elements"),t+="_"+ +!!this.disableVAO,this._material&&(t+="_"+ +!!this._material.doubleSided),this._commandKey=t,this._material&&(this._materialKeys=this._material.getUniformKeys())}return this._commandKey}getUniforms(t){if(this._dirtyUniforms||this._dirtyGeometry||this._material&&this._materialVer!==this._material.version){this._realUniforms={},this._getUniformsForDraco();const e=this.uniforms;for(const t in this.uniforms)v(this.uniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}}):this._realUniforms[t]=e[t]);if(this._material){const e=this._material.getUniforms(t);for(const t in e)v(e,t)&&!v(this._realUniforms,t)&&(Object.getOwnPropertyDescriptor(e,t).get?Object.defineProperty(this._realUniforms,t,{enumerable:!0,configurable:!0,get:function(){return e[t]}}):void 0===this._realUniforms[t]&&(this._realUniforms[t]=e[t]))}this._dirtyUniforms=!1,this._dirtyGeometry=!1,this._materialVer=this._material&&this._material.version,this._material&&this._material._clearDirtyProps(),this._dirtyProps=null}else if(this._dirtyProps||this._material&&this._material._getDirtyProps()){if(this._dirtyProps)for(const t of this._dirtyProps)this._realUniforms[t]=this.uniforms[t];const e=this._material&&this._material._getDirtyProps();if(e){const n=this._material.getUniforms(t);for(const t of e)this._realUniforms[t]=n[t];this._material._clearDirtyProps()}this._dirtyProps=null}return this._realUniforms.modelMatrix=h(this._localTransform)?this._localTransform():this._localTransform,this._realUniforms.positionMatrix=h(this._positionMatrix)?this._positionMatrix():this._positionMatrix,this._realUniforms}_getUniformsForDraco(){const t=this._geometry,e=t.data[t.desc.positionAttribute],n=t.data[t.desc.uv0Attribute],r=t.data[t.desc.normalAttribute];if(e&&e.quantization){const t=e.quantization,n=t.range/(1<<t.quantizationBits);this._realUniforms.minValues_pos=t.minValues,this._realUniforms.gltf_u_dec_position_normConstant=n}if(n&&n.quantization){const t=n.quantization;this._realUniforms.minValues_tex=t.minValues,this._realUniforms.gltf_u_dec_texcoord_0_normConstant=t.range/(1<<t.quantizationBits)}r&&r.quantization&&(this._realUniforms.gltf_u_dec_normal_rangeConstant=(1<<r.quantization.quantizationBits)-1)}getMaterial(){return this._material}getElements(){return this._geometry.getElements()}_getREGLAttrData(t,e){return this._geometry.getREGLData(t,e,this.disableVAO)}getREGLProps(t,e){const n=this.getUniforms(t);return u(n,this._getREGLAttrData(t,e)),y(t)&&!this.disableVAO||(n.elements=this._geometry.getElements()),n.meshProperties=this.properties,n.meshConfig=this.config,n.count=this._geometry.getDrawCount(),n.offset=this._geometry.getDrawOffset(),n.primitive=this._geometry.getPrimitive(),n}dispose(){return delete this._geometry,delete this._material,this.uniforms={},this}isValid(){return this._geometry&&!this._geometry.isDisposed()&&(!this._material||!this._material.isDisposed())}getBoundingBox(){return this._bbox||this.updateBoundingBox(),i["c"].multiply(Nt,this._localTransform,this._positionMatrix),i["c"].exactEquals(Nt,this._currentTransform)&&this._geometry.boundingBox.equals(this._geoBox)||this.updateBoundingBox(),this._bboxArr}updateBoundingBox(){const t=this._geometry.boundingBox;this._bbox||(this._bbox=new U),this._bboxArr||(this._bboxArr=[[],[]]),this._geoBox||(this._geoBox=new U),U.copy(this._bbox,t),this._bbox.updateVertex(),"InstancedMesh"===this.constructor.name?(this._bbox.transform(this._localTransform,this._positionMatrix),this._currentTransform=i["c"].multiply(this._currentTransform||[],this._positionMatrix,this._localTransform)):(this._bbox.transform(this._positionMatrix,this._localTransform),this._currentTransform=i["c"].multiply(this._currentTransform||[],this._localTransform,this._positionMatrix)),U.copy(this._geoBox,t),i["f"].copy(this._bboxArr[0],this._bbox.min),i["f"].copy(this._bboxArr[1],this._bbox.max)}_createDefinesKey(t){const e=[];for(const n in t)e.push(n,t[n]);return e.join(",")}_incrVersion(){this._version++}getMemorySize(){return(this.geometry&&this.geometry.getMemorySize()||0)+(this.material&&this.material.getMemorySize()||0)}}Ft.prototype.getWorldTransform=function(){const t=[];return function(){const e=this.parent;return e?i["c"].multiply(t,e.getWorldTransform(),this._localTransform):this._localTransform}}();class Lt extends Ft{constructor(t,e,n,r,i={}){super(n,r,i),this._instanceCount=e,this.instancedData=t||{},this._checkInstancedProp(),this._vao={}}get instanceCount(){return this._instanceCount}set instanceCount(t){this._incrVersion(),this._instanceCount=t}getMemorySize(){return super.getMemorySize()+this._getInstanceMemorySize()}_getInstanceMemorySize(){let t=0;for(const e in this.instancedData)v(this.instancedData,e)&&(t+=x(this.instancedData[e]));return t}_checkInstancedProp(){for(const t in this.instancedData)if(this.geometry.data[t])throw new Error(`Duplicate attribute ${t} defined in geometry and instanced data`)}_getREGLAttrData(t,e){const n=this.geometry.getAttrData(e);if(y(t)){const r=e.key;if(!this._vao[r]||this._vao[r].dirty){const i=e.map(t=>t.name),s=[];for(let t=0;t<i.length;t++){const e=n[i[t]];s.push(e&&e.buffer||this.instancedData[i[t]])}const o={attributes:s,primitive:this.geometry.getPrimitive()};this._vao[r]?this._vao[r].vao(o):this._vao[r]={vao:t.vao(o)},delete this._vao[r].dirty}return this._vao[r]}return n}getDefines(){const t=super.getDefines();return t.HAS_INSTANCE=1,t}getCommandKey(t){return"i_"+super.getCommandKey(t)}updateInstancedData(t,e){const n=this.instancedData[t];if(!n)return this;if(this._incrVersion(),this.instancedData[t]=e,n.buffer&&n.buffer.destroy&&n.buffer.destroy(),this._vao)for(const r in this._vao)this._vao[r].dirty=!0;return this}generateInstancedBuffers(t){const e=this.instancedData,n={};for(const r in e)e[r]&&(void 0!==e[r].buffer&&e[r].buffer.destroy?(n[r]=e[r],n[r].divisor&&(n[r].divisor=1)):n[r]=e[r].destroy?{buffer:e[r],divisor:1}:{buffer:t.buffer({data:e[r],dimension:e[r].length/this._instanceCount}),divisor:1});return this.instancedData=n,this}getREGLProps(t,e){const n=super.getREGLProps(t,e);return y(t)||u(n,this.instancedData),n.elements=this.geometry.getElements(),n.instances=this._instanceCount,n}disposeInstanceData(){const t=this.instancedData;if(t)for(const e in t)t[e]&&t[e].destroy&&!t[e][k]&&(t[e][k]=1,t[e].destroy());this.instancedData={};for(const e in this._vao)this._vao[e].vao.destroy();this._vao={}}_getBytesPerElement(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4}throw new Error("unsupported data type: "+t)}}const zt={getArrayBuffer:(t,e)=>zt.get(t,{responseType:"arraybuffer"},e),get:function(t,e,n){const r=zt._getClient(n);if(r.open("GET",t,!0),e){for(const t in e.headers)r.setRequestHeader(t,e.headers[t]);r.withCredentials="include"===e.credentials,e.responseType&&(r.responseType=e.responseType)}return r.send(null),r},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){let e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=zt._wrapCallback(e,t),e}};var Bt=P(class{constructor(t,e){this.defaultTexture=t,this.defaultCubeTexture=new Array(6),this.urlModifier=e,this.resources={}}setURLModifier(t){this.urlModifier=t}get(t){return Array.isArray(t)?this._loadImages(t):this._loadImage(t)}getArrayBuffer(t){if(Array.isArray(t)){const e=t.map(t=>this.getArrayBuffer(t));return Promise.all(e)}return new Promise((e,n)=>{let r=t;this.urlModifier&&(r=this.urlModifier(t)),zt.getArrayBuffer(r,(r,i)=>{r?n(r):e({url:t,data:i})})})}disposeRes(t){return Array.isArray(t)?t.forEach(t=>this._disposeOne(t)):this._disposeOne(t),this}isLoading(){return this._count&&this._count>0}getDefaultTexture(t){return Array.isArray(t)?this._getBlankTextures(t.length):this.defaultTexture}_disposeOne(t){const e=this.resources;e[t]&&(e[t].count--,e[t].count<=0&&delete e[t])}_loadImage(t){const e=this.resources;return e[t]?Promise.resolve({url:t,data:e[t].image}):new Promise((n,r)=>{const i=new Image;i.crossOrigin="anonymous",i.onload=function(){e[t]={image:i,count:1},n({url:t,data:i})},i.onerror=function(t){r(t)},i.onabort=function(){r(`image(${t}) loading aborted.`)},i.src=this.urlModifier?this.urlModifier(t):t})}_loadImages(t){const e=t.map(t=>this._loadImage(t,!0));return Promise.all(e)}_getBlankTextures(t){const e=new Array(t);for(let n=0;n<6;n++)e.push(this.defaultTexture);return e}});const Ht=[],Ut=[];let jt=0;class Vt{constructor(t){this._id=jt++,this.sortedMeshes={},this.setMeshes(t),this._compareBinded=this._compare.bind(this),this.dirty()}setMeshes(t){if(this.clear(),!t||Array.isArray(t)&&!t.length||t===this.meshes)return this;t=Array.isArray(t)?t:[t],this.meshes=[];for(let e=0;e<t.length;e++){const n=t[e];n&&(n._scenes=n._scenes||{},n._scenes[this._id]=1,this.meshes.push(n))}return this.dirty(),this}addMesh(t){return!t||Array.isArray(t)&&!t.length||(Array.isArray(t)?t.forEach(t=>{t._scenes=t._scenes||{},t._scenes[this._id]||(t._scenes[this._id]=1,this.meshes.push(t),this.dirty())}):(t._scenes=t._scenes||{},t._scenes[this._id]||(t._scenes[this._id]=1,this.meshes.push(t),this.dirty()))),this}removeMesh(t){if(!t||Array.isArray(t)&&!t.length)return this;if(Array.isArray(t)){let e=!1;for(let n=0;n<t.length;n++)t[n]._scenes&&t[n]._scenes[this._id]&&(e=!0,this.dirty(),delete t[n]._scenes[this._id]);e&&(this.meshes=this.meshes.filter(e=>t.indexOf(e)<0))}else{if(!t._scenes||!t._scenes[this._id])return this;const e=this.meshes.indexOf(t);e>=0&&this.meshes.splice(e,1),delete t._scenes[this._id],this.dirty()}return this}getMeshes(){return this.meshes||[]}clear(){if(this.meshes)for(let t=0;t<this.meshes.length;t++)delete this.meshes[t]._scenes[this._id];return this.meshes=[],this.sortedMeshes.opaques=[],this.sortedMeshes.transparents=[],this}dirty(){return this._dirty=!0,this}sortMeshes(t){const e=this.meshes;this.sortFunction&&e.sort(this.sortFunction);let n=this.sortedMeshes.transparents;if(this._dirty){const t=this.sortedMeshes.opaques=[];n=this.sortedMeshes.transparents=[];for(let r=0,i=e.length;r<i;r++)e[r].transparent?n.push(e[r]):t.push(e[r])}t&&n.length>1&&(this._cameraPosition=t,n.sort(this._compareBinded),delete this._cameraPosition),this._dirty=!1}getSortedMeshes(){return this._dirty&&this.sortMeshes(),this.sortedMeshes||[]}_compare(t,e){return i["f"].transformMat4(Ht,t.geometry.boundingBox.getCenter(),t.localTransform),i["f"].transformMat4(Ut,e.geometry.boundingBox.getCenter(),e.localTransform),i["f"].dist(Ut,this._cameraPosition)-i["f"].dist(Ht,this._cameraPosition)}}const Gt=String.fromCharCode;function qt(t,e,n,r){if(t[3]>0){const i=Math.pow(2,t[3]-128-8+r);e[n+0]=t[0]*i,e[n+1]=t[1]*i,e[n+2]=t[2]*i}else e[n+0]=0,e[n+1]=0,e[n+2]=0;return e[n+3]=1,e}function Wt(t,e,n){const r=t[e]/n,i=t[e+1]/n,s=t[e+2]/n;let o=m(Math.max(Math.max(r,i),Math.max(s,1e-6)),0,1);o=Math.ceil(255*o)/255,t[e]=Math.min(255,r/o*255),t[e+1]=Math.min(255,i/o*255),t[e+2]=Math.min(255,s/o*255),t[e+3]=Math.min(255,255*o)}function Xt(t,e,n,r){let i=0,s=0,o=r;for(;o>0;)if(t[s][0]=e[n++],t[s][1]=e[n++],t[s][2]=e[n++],t[s][3]=e[n++],1===t[s][0]&&1===t[s][1]&&1===t[s][2]){for(let e=t[s][3]<<i>>>0;e>0;e--)(l=t[s])[0]=(a=t[s-1])[0],l[1]=a[1],l[2]=a[2],l[3]=a[3],s++,o--;i+=8}else s++,o--,i=0;var a,l;return n}function Qt(t,e,n,r){if(r<8|r>32767)return Xt(t,e,n,r);let i=e[n++];if(2!==i)return Xt(t,e,n-1,r);if(t[0][1]=e[n++],t[0][2]=e[n++],i=e[n++],(t[0][2]<<8>>>0|i)>>>0!==r)return null;for(let s=0;s<4;s++)for(let i=0;i<r;){let r=e[n++];if(r>128){r=(127&r)>>>0;const o=e[n++];for(;r--;)t[i++][s]=o}else for(;r--;)t[i++][s]=e[n++]}return n}function Yt(t,e=0,n=9){const r=new Uint8Array(t),i=r.length;if("#?"!==function(t,e,n){let r="";for(let i=e;i<n;i++)r+=Gt(t[i]);return r}(r,0,2))return null;for(var s=2;s<i&&("\n"!==Gt(r[s])||"\n"!==Gt(r[s+1]));s++);if(s>=i)return null;s+=2;let o="";for(;s<i;s++){const t=Gt(r[s]);if("\n"===t)break;o+=t}const a=o.split(" "),l=parseInt(a[1]),h=parseInt(a[3]);if(!h||!l)return null;let c=s+1;const u=[];for(let A=0;A<h;A++){u[A]=[];for(let t=0;t<4;t++)u[A][t]=0}let f=0;const d=new Array(h*l*4);let p=0;for(let A=0;A<l;A++){if(c=Qt(u,r,c,h),!c)return null;for(let t=0;t<h;t++)qt(u[t],d,p,e),f=Math.max(f,d[p],d[p+1],d[p+2],d[p+3]),p+=4}f=Math.min(f,n),p=0;for(let A=0;A<l;A++)for(let t=0;t<h;t++)Wt(d,p,f),p+=4;return{width:h,height:l,pixels:d,rgbmRange:f}}class Zt extends N{onLoad({data:t}){const e=this.config;if(e){if(e.hdr){if(!(t=Yt(t.data,0,e.maxRange)))throw new Error("Invalid hdr data"+(e.url?":"+e.url:""));this.rgbmRange=t.rgbmRange,e.data=t.pixels}else e.data=t;e.width=e.width||t.width,e.height=e.height||t.height,this._updateREGL()}}createREGLTexture(t){if(A(this.config.data)||A(this.config.mipmap)){const e=ut(t,this.config);return e._reshader_refCount||(e._reshader_refCount=0),e._reshader_refCount++,e}return t.texture(this.config)}}class Kt extends N{onLoad(t){const e=this.config;if(!e)return;const n=this._createFaces(t);e.faces=n.map(t=>t.data),this._updateREGL()}createREGLTexture(t){return t.cube(this.config)}_createFaces(){return[]}}class Jt extends Q{constructor(t){super({aPosition:new(g(t=t||0))([-1,-1,t,1,-1,t,-1,1,t,1,1,t]),aNormal:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1])},new Uint16Array([0,1,3,3,2,0]))}}const $t={vsm_shadow_vert:"\nuniform mat4 shadow_lightProjViewModelMatrix;\nvarying vec4 shadow_vLightSpacePos;\nvoid shadow_computeShadowPars(vec4 position) {\n    shadow_vLightSpacePos = shadow_lightProjViewModelMatrix * position;\n}",vsm_shadow_frag:"\nuniform sampler2D shadow_shadowMap;\nuniform float shadow_opacity;\nuniform vec3 shadow_color;\n#if defined(USE_ESM)\n    uniform float esm_shadow_threshold;\n#endif\nvarying vec4 shadow_vLightSpacePos;\n#ifdef PACK_FLOAT\n    #include <common_pack_float>\n#endif\n#if defined(USE_ESM)\nfloat esm(vec3 projCoords, vec4 shadowTexel) {\n    float compare = projCoords.z;\n    float c = 120.0;\n    #ifdef PACK_FLOAT\n        float depth = common_decodeDepth(shadowTexel);\n        if (depth >= 1.0 - 1E-6 || compare <= depth) {\n            return 1.0;\n        }\n    #else\n        float depth = shadowTexel.r;\n    #endif\n    depth = exp(-c * min(compare - depth, 0.05));\n    return clamp(depth, esm_shadow_threshold, 1.0);\n}\n#endif\n#if defined(USE_VSM)\nfloat vsm_shadow_chebyshevUpperBound(vec3 projCoords, vec4 shadowTexel){\n    vec2 moments = shadowTexel.rg;\n    float distance = projCoords.z;\n    if (distance >= 1.0 || distance <= moments.x)\n        return 1.0 ;\n    float variance = moments.y - (moments.x * moments.x);\n    variance = max(variance, 0.00002);\n    float d = distance - moments.x;\n    float p_max = variance / (variance + d * d);\n    return p_max;\n}\n#endif\nfloat shadow_computeShadow_coeff(sampler2D shadowMap, vec3 projCoords) {\n    vec2 uv = projCoords.xy;\n    vec4 shadowTexel = texture2D(shadowMap, uv);\n    #if defined(USE_ESM)\n        float esm_coeff = esm(projCoords, shadowTexel);\n        float coeff = esm_coeff * esm_coeff;\n    #endif\n    #if defined(USE_VSM)\n        float vsm_coeff = vsm_shadow_chebyshevUpperBound(projCoords, shadowTexel);\n        float coeff = vsm_coeff;\n    #endif\n    return 1.0 - (1.0 - coeff) * shadow_opacity;\n}\nfloat shadow_computeShadow() {\n    vec3 projCoords = shadow_vLightSpacePos.xyz / shadow_vLightSpacePos.w;\n    projCoords = projCoords * 0.5 + 0.5;\n    if(projCoords.z >= 1.0 || projCoords.x < 0.0 || projCoords.x > 1.0 || projCoords.y < 0.0 || projCoords.y > 1.0) return 1.0;\n    return shadow_computeShadow_coeff(shadow_shadowMap, projCoords);\n}\nvec3 shadow_blend(vec3 color, float coeff) {\n    color = color * coeff + shadow_color * shadow_opacity * (1.0 - coeff);\n    return color;\n}",fbo_picking_vert:"\n#ifdef ENABLE_PICKING\n#if HAS_PICKING_ID == 1\nattribute float aPickingId;\n#elif HAS_PICKING_ID == 2\nuniform float uPickingId;\n#endif\nvarying float vPickingId;\nvarying float vFbo_picking_viewZ;\nvarying float vFbo_picking_visible;\n#endif\nvarying float vFbo_picking_fragDepth;\nvoid fbo_picking_setData(float viewPosZ, bool visible) {\n    #ifdef ENABLE_PICKING\n    #if HAS_PICKING_ID == 1\n       vPickingId = aPickingId;\n    #elif HAS_PICKING_ID == 2\n        vPickingId = uPickingId;\n    #endif\n        vFbo_picking_viewZ = viewPosZ;\n    #endif\n    vFbo_picking_visible = visible ? 1.0 : 0.0;\n    vFbo_picking_fragDepth = viewPosZ + 1.0;\n}",common_pack_float:"const float COMMON_FLOAT_MAX =  1.70141184e38;\nconst float COMMON_FLOAT_MIN = 1.17549435e-38;\nfloat common_packFloat(vec4 val){\n    vec4 scl = floor(255.0 * val + 0.5);\n    float sgn = (scl.a < 128.0) ? 1.0 : -1.0;\n    float exn = mod(scl.a * 2.0, 256.0) + floor(scl.b / 128.0) - 127.0;\n    float man = 1.0 +\n        (scl.r / 8388608.0) +\n        (scl.g / 32768.0) +\n        mod(scl.b, 128.0) / 128.0;\n    return sgn * man * pow(2.0, exn);\n}\nvec4 common_unpackFloat(highp float v) {\n    highp float av = abs(v);\n    if(av < COMMON_FLOAT_MIN) {\n        return vec4(0.0, 0.0, 0.0, 0.0);\n    } else if(v > COMMON_FLOAT_MAX) {\n        return vec4(127.0, 128.0, 0.0, 0.0) / 255.0;\n    } else if(v < -COMMON_FLOAT_MAX) {\n        return vec4(255.0, 128.0, 0.0, 0.0) / 255.0;\n    }\n    highp vec4 c = vec4(0,0,0,0);\n    highp float e = floor(log2(av));\n    highp float m = av * pow(2.0, -e) - 1.0;\n    c[1] = floor(128.0 * m);\n    m -= c[1] / 128.0;\n    c[2] = floor(32768.0 * m);\n    m -= c[2] / 32768.0;\n    c[3] = floor(8388608.0 * m);\n    highp float ebias = e + 127.0;\n    c[0] = floor(ebias / 2.0);\n    ebias -= c[0] * 2.0;\n    c[1] += floor(ebias) * 128.0;\n    c[0] += 128.0 * step(0.0, -v);\n    return c / 255.0;\n}\nvec4 common_encodeDepth(const in float depth) {\n    float alpha = 1.0;\n    vec4 pack = vec4(0.0);\n    pack.a = alpha;\n    const vec3 code = vec3(1.0, 255.0, 65025.0);\n    pack.rgb = vec3(code * depth);\n    pack.gb = fract(pack.gb);\n    pack.rg -= pack.gb * (1.0 / 256.0);\n    pack.b -= mod(pack.b, 4.0 / 255.0);\n    return pack;\n}\nfloat common_decodeDepth(const in vec4 pack) {\n    return pack.r + pack.g / 255.0;\n}",invert_matrix:"mat4 invert_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return inverse(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a00 = vector1.x, a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a10 = vector2.x, a11 = vector2.y, a12 = vector2.z, a13 = vector2.w;\n        float a20 = vector3.x, a21 = vector3.y, a22 = vector3.z, a23 = vector3.w;\n        float a30 = vector4.x, a31 = vector4.y, a32 = vector4.z, a33 = vector4.w;\n        float b00 = a00 * a11 - a01 * a10;\n        float b01 = a00 * a12 - a02 * a10;\n        float b02 = a00 * a13 - a03 * a10;\n        float b03 = a01 * a12 - a02 * a11;\n        float b04 = a01 * a13 - a03 * a11;\n        float b05 = a02 * a13 - a03 * a12;\n        float b06 = a20 * a31 - a21 * a30;\n        float b07 = a20 * a32 - a22 * a30;\n        float b08 = a20 * a33 - a23 * a30;\n        float b09 = a21 * a32 - a22 * a31;\n        float b10 = a21 * a33 - a23 * a31;\n        float b11 = a22 * a33 - a23 * a32;\n        float det = b00 * b11 - b01 * b10 + b02 * b09 + b03 * b08 - b04 * b07 + b05 * b06;\n        det = 1.0 / det;\n        mat4 m = mat4(\n            (a11 * b11 - a12 * b10 + a13 * b09) * det,\n            (a02 * b10 - a01 * b11 - a03 * b09) * det,\n            (a31 * b05 - a32 * b04 + a33 * b03) * det,\n            (a22 * b04 - a21 * b05 - a23 * b03) * det,\n            (a12 * b08 - a10 * b11 - a13 * b07) * det,\n            (a00 * b11 - a02 * b08 + a03 * b07) * det,\n            (a32 * b02 - a30 * b05 - a33 * b01) * det,\n            (a20 * b05 - a22 * b02 + a23 * b01) * det,\n            (a10 * b10 - a11 * b08 + a13 * b06) * det,\n            (a01 * b08 - a00 * b10 - a03 * b06) * det,\n            (a30 * b04 - a31 * b02 + a33 * b00) * det,\n            (a21 * b02 - a20 * b04 - a23 * b00) * det,\n            (a11 * b07 - a10 * b09 - a12 * b06) * det,\n            (a00 * b09 - a01 * b07 + a02 * b06) * det,\n            (a31 * b01 - a30 * b03 - a32 * b00) * det,\n            (a20 * b03 - a21 * b01 + a22 * b00) * det\n        );\n        return m;\n    #endif\n}\nmat4 transpose_matrix(mat4 matrix) {\n    #if __VERSION__ == 300\n        return transpose(matrix);\n    #else\n        vec4 vector1 = matrix[0], vector2 = matrix[1], vector3 = matrix[2], vector4 = matrix[3];\n        float a01 = vector1.y, a02 = vector1.z, a03 = vector1.w;\n        float a12 = vector2.z, a13 = vector2.w;\n        float a23 = vector3.w;\n        mat4 m = mat4(\n            vector1.x,\n            vector2.x,\n            vector3.x,\n            vector4.x,\n            a01,\n            vector2.y,\n            vector3.y,\n            vector4.y,\n            a02,\n            a12,\n            vector3.z,\n            vector4.z,\n            a03,\n            a13,\n            a23,\n            vector4.w\n        );\n        return m;\n    #endif\n}",get_output:"#include <invert_matrix>\n#include <draco_decode_vert>\n#ifdef HAS_INSTANCE\n    #include <instance_vert>\n    #ifdef HAS_INSTANCE_COLOR\n        varying vec4 vInstanceColor;\n    #endif\n#endif\n#ifdef HAS_SKIN\n    uniform int skinAnimation;\n    #include <skin_vert>\n#endif\n#include <mask_vert>\n#ifdef HAS_MORPH\n    attribute vec3 POSITION0;\n    attribute vec3 POSITION1;\n    attribute vec3 POSITION2;\n    attribute vec3 POSITION3;\n    attribute vec3 POSITION4;\n    attribute vec3 POSITION5;\n    attribute vec3 POSITION6;\n    attribute vec3 POSITION7;\n    #ifdef HAS_MORPHNORMALS\n        attribute vec3 NORMAL0;\n        attribute vec3 NORMAL1;\n        attribute vec3 NORMAL2;\n        attribute vec3 NORMAL3;\n    #endif\n    uniform vec4 morphWeights1;\n    uniform vec4 morphWeights2;\n#endif\n#ifdef HAS_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\n#endif\nmat4 getPositionMatrix() {\n    mat4 worldMatrix;\n    #ifdef HAS_INSTANCE\n        #ifdef HAS_INSTANCE_COLOR\n            vInstanceColor = instance_getInstanceColor();\n        #endif\n        mat4 attributeMatrix = instance_getAttributeMatrix();\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = attributeMatrix * positionMatrix * skin_getSkinMatrix();\n            } else {\n                worldMatrix = attributeMatrix * positionMatrix;\n            }\n        #else\n            worldMatrix = attributeMatrix * positionMatrix;\n        #endif\n    #else\n        #ifdef HAS_SKIN\n            if (skinAnimation == 1) {\n                worldMatrix = skin_getSkinMatrix() * positionMatrix;\n            } else {\n                worldMatrix = positionMatrix;\n            }\n        #else\n            worldMatrix = positionMatrix;\n        #endif\n    #endif\n    return worldMatrix;\n}\n#ifdef HAS_MIN_ALTITUDE\nuniform float minAltitude;\n#endif\nvec4 getPosition(vec3 aPosition) {\n    vec3 position = decode_getPosition(aPosition);\n    #ifdef HAS_MORPH\n        vec4 POSITION = vec4(position + morphWeights1[0] * POSITION0 + morphWeights1[1] * POSITION1 + morphWeights1[2] * POSITION2 + morphWeights1[3] * POSITION3\n        + morphWeights2[0] * POSITION4 + morphWeights2[1] * POSITION5 + morphWeights2[2] * POSITION6 + morphWeights2[3] * POSITION7\n        , 1.0);\n    #else\n        vec4 POSITION = vec4(position, 1.0);\n    #endif\n    #ifdef HAS_TERRAIN_ALTITUDE\n        POSITION.z += aTerrainAltitude * 100.0;\n    #endif\n    #ifdef HAS_MIN_ALTITUDE\n        POSITION.z += minAltitude * 100.0;\n    #endif\n    return POSITION;\n}\nvec3 appendMorphNormal(vec3 NORMAL) {\n    #ifdef HAS_MORPHNORMALS\n        vec3 normal = NORMAL + morphWeights1[0] * NORMAL0 + morphWeights1[1] * NORMAL1 + morphWeights1[2] * NORMAL2 + morphWeights1[3] * NORMAL3;\n    #else\n        vec3 normal = NORMAL;\n    #endif\n    return normal;\n}",instance_vert:"attribute vec4 instance_vectorA;\nattribute vec4 instance_vectorB;\nattribute vec4 instance_vectorC;\n#ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\nattribute float aTerrainAltitude;\nuniform float terrainAltitudeScale;\n#endif\nmat4 instance_getAttributeMatrix() {\n    mat4 mat =  mat4(\n        instance_vectorA.x, instance_vectorB.x, instance_vectorC.x, 0.0,\n        instance_vectorA.y, instance_vectorB.y, instance_vectorC.y, 0.0,\n        instance_vectorA.z, instance_vectorB.z, instance_vectorC.z, 0.0,\n        instance_vectorA.w, instance_vectorB.w, instance_vectorC.w, 1.0\n    );\n    #ifdef HAS_INSTANCE_TERRAIN_ALTITUDE\n        mat4 terrainMat = mat4(\n            1., 0., 0., 0.,\n            0., 1., 0., 0.,\n            0., 0., 1., 0.,\n            0., 0., aTerrainAltitude * terrainAltitudeScale, 1.\n        );\n        mat = terrainMat * mat;\n    #endif\n    return mat;\n}\n#ifdef HAS_INSTANCE_COLOR\n    attribute vec4 instance_color;\n    vec4 instance_getInstanceColor() {\n        return instance_color;\n    }\n#endif",skin_vert:"attribute vec4 WEIGHTS_0;\nattribute vec4 JOINTS_0;\nuniform sampler2D jointTexture;\nuniform vec2 jointTextureSize;\nuniform float numJoints;\n#define ROW0_U ((0.5 + 0.0) / 4.)\n#define ROW1_U ((0.5 + 1.0) / 4.)\n#define ROW2_U ((0.5 + 2.0) / 4.)\n#define ROW3_U ((0.5 + 3.0) / 4.)\nmat4 skin_getBoneMatrix(float jointNdx) {\n    float v = (jointNdx + 0.5) / numJoints;\n    return mat4(\n        texture2D(jointTexture, vec2(ROW0_U, v)),\n        texture2D(jointTexture, vec2(ROW1_U, v)),\n        texture2D(jointTexture, vec2(ROW2_U, v)),\n        texture2D(jointTexture, vec2(ROW3_U, v)));\n}\nmat4 skin_getSkinMatrix() {\n        mat4 skinMatrix = skin_getBoneMatrix(JOINTS_0[0]) * WEIGHTS_0[0] +\n                        skin_getBoneMatrix(JOINTS_0[1]) * WEIGHTS_0[1] +\n                        skin_getBoneMatrix(JOINTS_0[2]) * WEIGHTS_0[2] +\n                        skin_getBoneMatrix(JOINTS_0[3]) * WEIGHTS_0[3];\n        return skinMatrix;\n}",heatmap_render_vert:"#ifdef HAS_HEATMAP\nvarying vec2 heatmap_vTexCoord;\nvoid heatmap_compute(mat4 matrix, vec3 position) {\n    vec4 pos = matrix * vec4(position.xy, 0., 1.);\n    heatmap_vTexCoord = (1. + pos.xy / pos.w) / 2.;\n}\n#endif",heatmap_render_frag:"#ifdef HAS_HEATMAP\nuniform sampler2D heatmap_inputTexture;\nuniform sampler2D heatmap_colorRamp;\nuniform float heatmap_heatmapOpacity;\nvarying vec2 heatmap_vTexCoord;\nvec4 heatmap_getColor(vec4 color) {\n    float t = texture2D(heatmap_inputTexture, heatmap_vTexCoord).r;\n    vec4 heatmapColor = texture2D(heatmap_colorRamp, vec2(t, 0.5)) * heatmap_heatmapOpacity;\n    return color * (1.0 - heatmapColor.a) + heatmapColor * heatmapColor.a;\n}\n#endif",line_extrusion_vert:"#ifdef IS_LINE_EXTRUSION\n    #define ALTITUDE_SCALE 32767.0;\n    #define EXTRUDE_SCALE 63.0;\n    attribute vec2 aExtrude;\n    #ifdef HAS_LINE_WIDTH\n        attribute float aLineWidth;\n    #else\n        uniform float lineWidth;\n    #endif\n    #ifdef HAS_LINE_HEIGHT\n        attribute float aLineHeight;\n    #else\n        uniform float lineHeight;\n    #endif\n    uniform float linePixelScale;\n    vec3 getLineExtrudePosition(vec3 position) {\n        #ifdef HAS_LINE_WIDTH\n            float lineWidth = aLineWidth / 2.0;\n        #endif\n        #ifdef HAS_LINE_HEIGHT\n            float lineHeight = aLineHeight / 10.0;\n        #endif\n        float halfwidth = lineWidth / 2.0;\n        float outset = halfwidth;\n        vec2 dist = outset * aExtrude / EXTRUDE_SCALE;\n        position.z *= lineHeight / ALTITUDE_SCALE;\n        return position + vec3(dist, 0.0) * linePixelScale;\n    }\n#endif",gl2_vert:"#if __VERSION__ == 300\n    #define texture2D texture\n    #define varying out\n    #define attribute in\n#endif",gl2_frag:"#if __VERSION__ == 300\n    #define varying in\n    #define gl_FragDepthEXT gl_FragDepth\n    #define texture2D texture\n    #define textureCube texture\n    #define texture2DProj textureProj\n    #define texture2DLodEXT textureLod\n    #define texture2DProjLodEXT textureProjLod\n    #define textureCubeLodEXT textureLod\n    #define texture2DGradEXT textureGrad\n    #define texture2DProjGradEXT textureProjGrad\n    #define textureCubeGradEXT textureGrad\n    #define texture2D texture\n    out vec4 glFragColor;\n#else\n    vec4 glFragColor;\n#endif",hsv_frag:"\nconst mediump vec4 HSV_K0 = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);\nconst mediump vec4 HSV_K1 = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\nconst mediump float HSV_E = 1.0e-10;\nvec3 hsv_rgb2hsv(vec3 c) {\n    vec4 K = HSV_K0;\n    vec4 p = mix(vec4(c.bg, K.wz), vec4(c.gb, K.xy), step(c.b, c.g));\n    vec4 q = mix(vec4(p.xyw, c.r), vec4(c.r, p.yzx), step(p.x, c.r));\n    float d = q.x - min(q.w, q.y);\n    float e = HSV_E;\n    return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), d / (q.x + e), q.x);\n}\nvec3 hsv_hsv2rgb(vec3 c) {\n    vec4 K = HSV_K1;\n    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n}\nvec4 hsv_apply(vec4 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return vec4(hsv_hsv2rgb(hsv), c.a);\n}\nvec3 hsv_apply(vec3 c, vec3 hsvOffset) {\n    vec3 hsv = hsv_rgb2hsv(c.rgb);\n    hsv += hsv * hsvOffset;\n    hsv = clamp(hsv, 0.0, 1.0);\n    return hsv_hsv2rgb(hsv);\n}\nmat4 contrastMatrix(float contrast)\n{\n    float t = (1.0 - contrast) / 2.0;\n    return mat4(\n        contrast, 0., 0., 0.,\n        0., contrast, 0., 0.,\n        0., 0., contrast, 0.,\n        t, t, t, 1\n    );\n}",snow_frag:"#ifdef HAS_SNOW\n    float lerp(float a, float b, float w) {\n        return a + w * (b - a);\n    }\n    vec3 snow(vec4 sceneColor, vec3 normalColor, float height) {\n        float snowIntense = normalColor.b;\n        vec3 fixedC = vec3(1.0, 1.0, 1.0);\n        if (height < 1.0) {\n            float r = lerp(0.5, fixedC.x, snowIntense);\n            float g = lerp(0.5, fixedC.y, snowIntense);\n            float b = lerp(0.5, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        } else {\n            float r = lerp(sceneColor.r, fixedC.x, snowIntense);\n            float g = lerp(sceneColor.g, fixedC.y, snowIntense);\n            float b = lerp(sceneColor.b, fixedC.z, snowIntense);\n            return vec3(r, g, b);\n        }\n    }\n#endif",draco_decode_vert:"#if defined(HAS_TANGENT)\n    attribute vec4 aTangent;\n#elif defined(HAS_NORMAL)\n    #ifdef HAS_DRACO_NORMAL\n        attribute vec2 aNormal;\n        uniform float gltf_u_dec_normal_rangeConstant;\n    #else\n        attribute vec3 aNormal;\n    #endif\n#endif\n#ifdef HAS_DRACO_POSITION\n    uniform float gltf_u_dec_position_normConstant;\n    uniform vec3 minValues_pos;\n    vec3 decodeDracoPosition(vec3 aPosition) {\n        return minValues_pos + aPosition * gltf_u_dec_position_normConstant;\n    }\n#endif\n#ifdef HAS_DRACO_TEXCOORD\n    uniform vec2 minValues_tex;\n    uniform float gltf_u_dec_texcoord_0_normConstant;\n    vec2 decodeDracoTexcoord(vec2 aTexCoord) {\n        return minValues_tex + aTexCoord * gltf_u_dec_texcoord_0_normConstant;\n    }\n#endif\n#ifdef HAS_WEB3D_quantized_attributes_TEXCOORD\n    uniform mat3 decodeMatrix;\n#endif\n#ifdef HAS_DRACO_NORMAL\n    float czm_signNotZero(float value) {\n        return value >= 0.0 ? 1.0 : -1.0;\n    }\n    vec2 czm_signNotZero(vec2 value) {\n        return vec2(czm_signNotZero(value.x), czm_signNotZero(value.y));\n    }\n    vec3 decodeDracoNormal(vec2 encoded, float range)\n    {\n        if (encoded.x == 0.0 && encoded.y == 0.0) {\n            return vec3(0.0, 0.0, 0.0);\n        }\n        encoded = encoded / range * 2.0 - 1.0;\n        vec3 v = vec3(encoded.x, encoded.y, 1.0 - abs(encoded.x) - abs(encoded.y));\n        if (v.z < 0.0) {\n            v.xy = (1.0 - abs(v.yx)) * czm_signNotZero(v.xy);\n        }\n        return normalize(v);\n    }\n    vec3 decode_getNormal(vec2 aNormal) {\n        return decodeDracoNormal(aNormal, gltf_u_dec_normal_rangeConstant).zxy;\n    }\n#endif\n#ifdef HAS_COMPRESSED_INT16\n    #ifdef HAS_COMPRESSED_INT16_POSITION\n      uniform vec2 compressedPositionRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_0\n      uniform vec2 compressedTexcoordRange_0;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_TEXCOORD_1\n      uniform vec2 compressedTexcoordRange_1;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n      uniform vec2 compressedNormalRange;\n    #endif\n    #ifdef HAS_COMPRESSED_INT16_RATIO\n      uniform float compressed_ratio;\n    #endif\n    float int16ToFloat32(float value, vec2 range) {\n        float v = (value >= 32768.0) ? -(65536.0 - value) / 32768.0 : value / 32767.0;\n        return (v + 1.0) * (range.y - range.x) / 2.0 + range.x;\n    }\n#endif\nvec3 decode_getPosition(vec3 aPosition) {\n    vec3 position = aPosition;\n    #if defined(HAS_COMPRESSED_INT16) && defined(HAS_COMPRESSED_INT16_POSITION)\n        float x = int16ToFloat32(aPosition.x, compressedPositionRange);\n        float y = int16ToFloat32(aPosition.y, compressedPositionRange);\n        float z = int16ToFloat32(aPosition.z, compressedPositionRange);\n        #ifdef HAS_COMPRESSED_INT16_RATIO\n          position = vec3(x / compressed_ratio, y / compressed_ratio, z);\n        #else\n          position = vec3(x, y, z);\n        #endif\n    #endif\n    #ifdef HAS_DRACO_POSITION\n        return decodeDracoPosition(position);\n    #else\n        return position;\n    #endif\n}\nvec2 decode_getTexcoord(vec2 aTexCoord) {\n    vec2 texcoord = aTexCoord;\n    #if defined(HAS_COMPRESSED_INT16) && (defined(HAS_COMPRESSED_INT16_TEXCOORD_0) || defined(HAS_COMPRESSED_INT16_TEXCOORD_1))\n        float x = int16ToFloat32(aTexCoord.x, compressedTexcoordRange_0);\n        float y = int16ToFloat32(aTexCoord.y, compressedTexcoordRange_0);\n        texcoord = vec2(x, y);\n    #endif\n    #ifdef HAS_DRACO_TEXCOORD\n        return decodeDracoTexcoord(texcoord);\n    #elif defined(HAS_WEB3D_quantized_attributes_TEXCOORD)\n        vec3 web3dTexcoord = decodeMatrix * vec3(texcoord, 1.0);\n        return vec2(web3dTexcoord.x, web3dTexcoord.y);\n    #else\n        return texcoord;\n    #endif\n}\nvec3 decode_getNormal(vec3 aNormal) {\n    #ifdef HAS_COMPRESSED_INT16_NORMAL\n        aNormal.x = int16ToFloat32(aNormal.x, compressedNormalRange);\n        aNormal.y = int16ToFloat32(aNormal.y, compressedNormalRange);\n        aNormal.z = int16ToFloat32(aNormal.z, compressedNormalRange);\n    #endif\n    return aNormal;\n}",highlight_vert:"#if defined(HAS_HIGHLIGHT_COLOR)\n    attribute vec4 aHighlightColor;\n    varying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    attribute float aHighlightOpacity;\n    varying float vHighlightOpacity;\n#endif\nvoid highlight_setVarying() {\n    #if defined(HAS_HIGHLIGHT_COLOR)\n        vHighlightColor = aHighlightColor / 255.0;\n    #endif\n    #if defined(HAS_HIGHLIGHT_OPACITY)\n        vHighlightOpacity = aHighlightOpacity / 255.0;\n    #endif\n}",highlight_frag:"#if defined(HAS_HIGHLIGHT_COLOR)\n\tvarying vec4 vHighlightColor;\n#endif\n#if defined(HAS_HIGHLIGHT_OPACITY)\n    varying float vHighlightOpacity;\n#endif\nvec4 highlight_blendColor(vec4 color) {\n\tvec4 outColor;\n\t#if defined(HAS_HIGHLIGHT_COLOR)\n\t\tcolor.rgb = color.rgb * (1.0 - vHighlightColor.a) + vHighlightColor.rgb * vHighlightColor.a;\n\t\t#ifndef HAS_HIGHLIGHT_COLOR_POINT\n        \tcolor.a = color.a * (1.0 - vHighlightColor.a) + vHighlightColor.a;\n        #endif\n        outColor = color;\n\t#else\n\t\toutColor = color;\n\t#endif\n\t#if defined(HAS_HIGHLIGHT_OPACITY)\n\t\toutColor *= vHighlightOpacity;\n\t#endif\n\treturn outColor;\n}",mask_vert:"#ifdef HAS_MASK_EXTENT\n    uniform vec4 mask_extent;\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_maskMode;\n    uniform float mask_hasFlatOut;\n    uniform mat4 viewMatrix;\n    uniform float mask_heightRatio;\n    uniform float mask_heightOffset;\n    varying vec4 vWorldPosition;\n    varying vec2 vUVInExtent;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    const float CLIPINSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float ELEVATE_MODE = 0.7;\n    float random (vec2 st) {\n        return fract(sin(dot(st.xy,vec2(12.9898,78.233)))*43758.5453123) * 0.1;\n    }\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    float getFlatHeight(float maskMode, float flatHeight, float height) {\n      if (maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n          return flatHeight + height;\n      } else {\n        return flatHeight;\n      }\n    }\n    vec4 getNoErrorPosition(vec4 position, vec4 wPosition) {\n      vec4 realPos = modelViewMatrix * position;      vec4 pos = viewMatrix * wPosition;      vec4 tempPos = viewMatrix * modelMatrix * position;      float deltaX = realPos.x - tempPos.x;\n      float deltaY = realPos.y - tempPos.y;\n      float deltaZ = realPos.z - tempPos.z;\n      pos.x = pos.x + deltaX;\n      pos.y = pos.y + deltaY;\n      pos.z = pos.z + deltaZ;\n      return pos;\n    }\n    vec4 getMaskPosition(vec4 position, mat4 modelMatrix) {\n        vWorldPosition = modelMatrix * position;\n        float w = mask_extent.z - mask_extent.x;\n        float h = mask_extent.y - mask_extent.w;\n        vec2 uvInExtent = vec2((vWorldPosition.x - mask_extent.x) / abs(w), 1.0 - (vWorldPosition.y - mask_extent.w) / h);\n        vec4 extentColor = texture2D(mask_colorExtent, uvInExtent);\n        vec3 maskOptionColor = texture2D(mask_modeExtent, uvInExtent).rgb;\n        float maskMode = maskOptionColor.r;\n        float flatHeight = maskOptionColor.g / mask_heightRatio + mask_heightOffset;\n        float height = getFlatHeight(maskMode, flatHeight, vWorldPosition.z);\n        vec4 wPosition = vec4(vWorldPosition.x, vWorldPosition.y, height, vWorldPosition.w);\n        vUVInExtent = uvInExtent;\n        vHeightRatio = mask_heightRatio;\n        vHeightOffset = mask_heightOffset;\n        if (maskMode <= FLATOUTSIDE_MODE && maskMode > FLATINSIDE_MODE) {\n            return modelViewMatrix * position;;\n        } else if (mask_hasFlatOut == 1.0) {\n            return getNoErrorPosition(position, wPosition);\n        }\n        if (isInExtent(extentColor) == true && maskMode <= FLATINSIDE_MODE && maskMode > CLIPINSIDE_MODE) {\n            return getNoErrorPosition(position, wPosition);\n        } if (isInExtent(extentColor) == true && maskMode <= ELEVATE_MODE && maskMode > 0.6) {\n            return getNoErrorPosition(position, wPosition);\n        } else {\n            return modelViewMatrix * position;\n        }\n    }\n#endif",mask_frag:"#ifdef HAS_MASK_EXTENT\n    uniform sampler2D mask_colorExtent;\n    uniform sampler2D mask_modeExtent;\n    uniform float mask_hasClipOut;\n    varying float vHeightRatio;\n    varying float vHeightOffset;\n    varying vec2 vUVInExtent;\n    varying vec4 vWorldPosition;\n    const float CLIPINSIDE_MODE = 0.1;\n    const float CLIPOUTSIDE_MODE = 0.2;\n    const float FLATINSIDE_MODE = 0.3;\n    const float FLATOUTSIDE_MODE = 0.4;\n    const float COLOR_MODE = 0.5;\n    const float VIDEO_MODE = 0.6;\n    bool isInExtent(vec4 color) {\n        return length(color.rgb) > 0.0;\n    }\n    vec4 setMask(vec4 glFragColor) {\n        vec4 extentColor = texture2D(mask_colorExtent, vUVInExtent);\n        vec4 modeColor = texture2D(mask_modeExtent, vUVInExtent);\n        float maskMode = modeColor.r;\n        float minHeight = modeColor.b / vHeightRatio + vHeightOffset;\n        float maxHeight = modeColor.a / vHeightRatio + vHeightOffset;\n        if (maskMode > CLIPINSIDE_MODE && maskMode <= CLIPOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                return glFragColor;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                return glFragColor;\n            } else {\n              discard;\n            }\n        } else if (mask_hasClipOut == 1.0) {\n            discard;\n        }\n        if (isInExtent(extentColor) == true && maskMode <= CLIPINSIDE_MODE && maskMode > 0.0) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                discard;\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                discard;\n            } else {\n              return glFragColor;\n            }\n        } else if (isInExtent(extentColor) == true && maskMode <= VIDEO_MODE && maskMode > FLATOUTSIDE_MODE) {\n            if (minHeight == 0.0 && maxHeight == 0.0) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            } else if (vWorldPosition.z >= minHeight && vWorldPosition.z <= maxHeight) {\n                glFragColor = vec4(mix(extentColor.rgb, glFragColor.rgb, 1.0 - extentColor.a), glFragColor.a);\n            }\n        }\n        return glFragColor;\n    }\n#endif",computeTexcoord_frag:"#ifdef HAS_KHR_TEXTURE_TRANSFORM\n    uniform vec2 khr_offset;\n    uniform float khr_rotation;\n    uniform vec2 khr_scale;\n    vec2 khr_tex_transformTexCoord(vec2 texCoords, vec2 offset, float rotation, vec2 scale) {\n        rotation = -rotation;\n        mat3 transform = mat3(\n        cos(rotation) * scale.x, sin(rotation) * scale.x, 0.0, -sin(rotation) * scale.y, cos(rotation) * scale.y, 0.0, offset.x, offset.y, 1.0);\n        vec2 transformedTexCoords = (transform * vec3(fract(texCoords), 1.0)).xy;\n        return transformedTexCoords;\n    }\n#endif\nvarying highp vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\n    varying vec4 vUvRegion;\n#endif\nvec2 computeTexCoord(vec2 texCoord) {\n    #ifdef HAS_I3S_UVREGION\n        vec2 atlasScale = vUvRegion.zw - vUvRegion.xy;\n        vec2 uvAtlas = fract(texCoord) * atlasScale + vUvRegion.xy;\n        return uvAtlas;\n    #elif defined(HAS_KHR_TEXTURE_TRANSFORM)\n        return khr_tex_transformTexCoord(texCoord, khr_offset, khr_rotation, khr_scale);\n    #else\n        return texCoord;\n    #endif\n}",terrain_normal_frag:"#ifdef HAS_TERRAIN_NORMAL\n    uniform sampler2D terrainHeightTexture;\n    uniform vec2 terrainHeightMapResolution;\n    uniform vec2 terrainResolution;\n    uniform float terrainHeightScale;\n    uniform float terrainTileResolution;\n    uniform vec4 terrainUnpackFactors;\n    float getHeight(vec2 uv) {\n        vec4 color = texture2D(terrainHeightTexture, uv) * 255.0;\n        color.a = -1.0;\n        return dot(color, terrainUnpackFactors) / 4.0;\n    }\n    vec3 convertTerrainHeightToNormalMap(vec2 uv) {\n        uv.y = 1.0 - uv.y;\n        vec2 epsilon = 1.0 / terrainHeightMapResolution;\n        float a = getHeight(uv + vec2(-epsilon.x, -epsilon.y));\n        float b = getHeight(uv + vec2(0, -epsilon.y));\n        float c = getHeight(uv + vec2(epsilon.x, -epsilon.y));\n        float d = getHeight(uv + vec2(-epsilon.x, 0));\n        float e = getHeight(uv + vec2(epsilon.x, 0));\n        float f = getHeight(uv + vec2(-epsilon.x, epsilon.y));\n        float g = getHeight(uv + vec2(0, epsilon.y));\n        float h = getHeight(uv + vec2(epsilon.x, epsilon.y));\n        vec2 dxy = vec2(\n            (c + e + e + h) - (a + d + d + f),\n            (f + g + g + h) - (a + b + b + c)\n        );\n        return normalize(vec3(dxy / epsilon, terrainResolution ));\n    }\n#endif",vertex_color_vert:"#ifdef HAS_VERTEX_COLOR\nattribute float aVertexColorType;\nuniform vec4 vertexColorsOfType[VERTEX_TYPES_COUNT];\nvarying vec4 vertexColor_color;\nvoid vertexColor_update() {\n    vertexColor_color = vertexColorsOfType[int(aVertexColorType)];\n}\n#endif",vertex_color_frag:"#ifdef HAS_VERTEX_COLOR\nvarying vec4 vertexColor_color;\nvec4 vertexColor_get() {\n\treturn vertexColor_color;\n}\n#endif",excavate_vert:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform vec4 excavateExtent;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  float getWorldHeight() {\n    vec4 wPosition = modelMatrix * getPosition(aPosition);\n    return wPosition.z;\n  }\n  vec2 getCoordinateTexcoord() {\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 wPosition = modelMatrix * localPositionMatrix * getPosition(aPosition);\n    float x = (wPosition.x - excavateExtent.x) / (excavateExtent.z - excavateExtent.x);\n    float y = (wPosition.y - excavateExtent.y) / (excavateExtent.w - excavateExtent.y);\n    return vec2(x, y);\n  }\n#endif",excavate_frag:"#ifdef HAS_EXCAVATE_ANALYSIS\n  uniform sampler2D heightmap;\n  uniform float excavateHeight;\n  varying vec2 vCoordinateTexcoord;\n  varying float vHeight;\n  const vec2 range = vec2(-100.0, 1000.0);\n  float decodeHeight(const in vec4 pack) {\n      return pack.r + pack.g / 255.0;\n  }\n  vec4 excavateColor(vec4 fragColor) {\n      float samplerHeight = decodeHeight(texture2D(heightmap, vCoordinateTexcoord));\n      float realHeight = samplerHeight * (range.y - range.x) + range.x;\n      if(realHeight < range.x || realHeight > range.y) {\n          realHeight = 0.0;\n      }\n      if(vHeight > realHeight) {\n          discard;\n      }\n      return fragColor;\n  }\n#endif"};var te={register(t,e){if($t[t])throw new Error(`Key of ${t} is already registered in ShaderLib.`);$t[t]=e},compile:t=>ne(t)};const ee=/^[ \t]*#include +<([\w\d.]+)>/gm;function ne(t){return t.replace(ee,re)}function re(t,e){const n=$t[e];if(!n)throw new Error("Can not resolve #include <"+e+">");return ne(n)}const ie="function",se="array";let oe=0;const ae={};class le{constructor({vert:t,frag:e,uniforms:n,defines:r,extraCommandProps:i}){this.vert=t,this.frag=e;const s=oe++;Object.defineProperty(this,"uid",{enumerable:!0,configurable:!1,get:()=>s}),this.shaderDefines=r&&u({},r)||{},n=this.uniforms=(n||[]).slice(),this.contextDesc={};for(let a=0,l=n.length;a<l;a++){const t=n[a];if(o(t))if(t.indexOf("[")>0){const{name:e,len:n}=he(t);this.contextDesc[e]={name:e,type:"array",length:n}}else this.contextDesc[t]=null;else if(t.name.indexOf("[")>0){const{name:e,len:n}=he(t.name);this.contextDesc[e]={name:e,type:"array",length:n,fn:t.fn}}else this.contextDesc[t.name]=t}this.extraCommandProps=i&&u({},i)||{},this.commands={},this._compileSource()}set shaderDefines(t){this._shaderDefines=t,this.dkey=Object.keys(this._shaderDefines).join()}get shaderDefines(){return this._shaderDefines||{}}setDefines(t){this.shaderDefines=t}setFramebuffer(t){return this.context.framebuffer=t,this}appendDescUniforms(t,e){const n=e,r=this.contextDesc;for(const i in r)if(r[i])if("array"===r[i].type){const s=i,o=r[i].length;let a=e[i];if(r[i].fn&&(a=r[i].fn(null,e)),!a)continue;if(a.length!==o)throw new Error(`${s} uniform's length is not ${o}`);n[s]=n[s]||{};for(let e=0;e<o;e++)n[s][""+e]=a[e].getREGLTexture?a[e].getREGLTexture(t):a[e]}else"function"===r[i].type&&(Object.getOwnPropertyDescriptor(n,i)||Object.defineProperty(n,i,{configurable:!1,enumerable:!0,get:function(){return r[i].fn(null,e)}}));return n}setUniforms(t){if(t.modelMatrix||t.positionMatrix)throw new Error("modelMatrix or positionMatrix is reserved uniform name for Mesh, please change to another name");return this.contextKeys=t?Object.keys(t).join():null,this.context=t,this}getVersion(t,e){return"#version"===e.substring(0,8)?"":0===t.limits.version.indexOf("WebGL 2.0")&&300===this.version?"#version 300 es\n":"#version 100\n"}getActiveVars(t,e,n,r){const i=r;if(ae[i])return ae[i];const s=t._gl,o=s.createProgram(),a=s.createShader(35633);s.shaderSource(a,e),s.compileShader(a);const l=s.createShader(35632);s.shaderSource(l,n),s.compileShader(l),s.attachShader(o,l),s.attachShader(o,a),s.linkProgram(o);const h=s.getProgramParameter(o,35721),c=[];for(let d=0;d<h;++d){const t=s.getActiveAttrib(o,d);t&&c.push({name:t.name,type:t.type})}const u=s.getProgramParameter(o,35718),f=[];for(let d=0;d<u;++d){const t=s.getActiveUniform(o,d);let e=t.name;t.name.indexOf("[")>0&&(e=e.replace("[0]","")),f.push(e)}return s.deleteProgram(o),s.deleteShader(a),s.deleteShader(l),ae[i]={activeUniforms:f,activeAttributes:c},ae[i]}createREGLCommand(t,e,n,r,i,s={}){const o=y(t)&&!i,a=u({},this.shaderDefines||{},e||{}),l=this._insertDefines(this.vert,a),h=this.getVersion(t,l)+l,c=this._insertDefines(this.frag,a),f=this.getVersion(t,c)+c,p=S(h)+"_"+S(f),{activeAttributes:A,activeUniforms:g}=this.getActiveVars(t,h,f,p),m={};A.forEach((e,n)=>{const r=e.name;m[r]=o?n:t.prop(r)});const v={};g.forEach(e=>{v[e]=t.prop(e)});const x=this.contextDesc;for(const u in x)if(x[u]&&x[u].type===ie)v[u]=x[u].fn;else if(x[u]&&x[u].type===se){const e=x[u].name,n=x[u].length;for(let r=0;r<n;r++){const n=`${e}[${r}]`;v[n]=t.prop(n)}}else v[u]=t.prop(u);const b={vert:h,frag:f,uniforms:v,attributes:m};o&&(b.vao=t.prop("vao")),o&&!r||!n||d(n)||(b.elements=t.prop("elements")),b.count=t.prop("count"),b.offset=t.prop("offset"),b.primitive=t.prop("primitive"),b.framebuffer=t.prop("framebuffer"),r&&(b.instances=t.prop("instances")),u(b,this.extraCommandProps,s);const w=t(b);return A.key=A.map(t=>t.name).join(),w.activeAttributes=A,w}dispose(){for(const t in this.commands){const e=this.commands[t];e&&e.destroy&&!e[k]&&(e[k]=!0,e.destroy())}this.commands={},delete this.vert,delete this.frag}_insertDefines(t,e){const n=[];for(const r in e)v(e,r)&&!h(e[r])&&n.push(`#define ${r} ${e[r]}\n`);return n.join("")+t}_compileSource(){this.vert=te.compile(this.vert),this.frag=te.compile(this.frag)}}function he(t){const e=t.indexOf("["),n=t.indexOf("]");return{name:t.substring(0,e),len:+t.substring(e+1,n)}}class ce extends le{draw(t,e){if(!e||!e.length)return 0;const n=[];let r,i=0;for(let s=0,o=e.length;s<o;s++){if(!e[s].isValid()){s===o-1&&r&&n.length&&r(n);continue}if(!e[s].geometry.getDrawCount()||!this._runFilter(e[s])){s===o-1&&r&&n.length&&r(n);continue}const a=this.getMeshCommand(t,e[s]);n.length&&r!==a&&(r(n),n.length=0);const l=e[s].getREGLProps(t,a.activeAttributes);this._ensureContextDefines(l),l.shaderContext=this.context,this.appendDescUniforms(t,l),n.push(l),i++,s<o-1?r=a:s===o-1&&a(n)}return i}_ensureContextDefines(t){if(this.context&&(t.contextKeys||(t.contextKeys={}),t.contextKeys[this.uid]!==this.contextKeys)){for(const e in this.context)"framebuffer"===e||Object.getOwnPropertyDescriptor(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:function(){return this.shaderContext[e]}});Object.getOwnPropertyDescriptor(t,"framebuffer")||Object.defineProperty(t,"framebuffer",{configurable:!1,enumerable:!0,get:function(){return this.targetFramebuffer||this.shaderContext&&this.shaderContext.framebuffer}}),t.contextKeys[this.uid]=this.contextKeys}}_runFilter(t){const e=this.filter;if(!e)return!0;if(Array.isArray(e)){for(let n=0;n<e.length;n++)if(!e[n](t))return!1;return!0}return e(t)}getMeshCommand(t,e){this._cmdKeys||(this._cmdKeys={});const n=this.dkey||"default";let r=this._cmdKeys[n];r||(r=this._cmdKeys[n]={});const i=e.getCommandKey(t);r[i]||(r[i]=n+"_"+e.getCommandKey(t));const s=r[i];let o=this.commands[s];if(!o){const n=e.getDefines(),r=e.getMaterial(),i={};r&&r.doubleSided&&this.extraCommandProps&&this.extraCommandProps.cull&&(i.cull={enable:!1}),o=this.commands[s]=this.createREGLCommand(t,n,e.getElements(),e instanceof Lt,e.disableVAO,i)}return o}}class ue extends ce{constructor(t={}){let e=t.extraCommandProps||{};const n=[];e=u({},e,{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},sample:{alpha:!0}}),super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aBarycentric;\nvarying vec3 vBarycentric;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nvarying vec3 vPosition;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = getPosition(aPosition);\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(c * d, modelMatrix);\n#else\ngl_Position = projMatrix * modelViewMatrix * c * d;\n#endif\nvBarycentric = aBarycentric;\n  vPosition = aPosition;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec3 vBarycentric;\nuniform float time;\nuniform float thickness;\nuniform float secondThickness;\nuniform float dashRepeats;\nuniform float dashLength;\nuniform bool dashOverlap;\nuniform bool dashEnabled;\nuniform bool dashAnimate;\nuniform bool seeThrough;\nuniform bool insideAltColor;\nuniform bool dualStroke;\nuniform bool squeeze;\nuniform float squeezeMin;\nuniform float squeezeMax;\nuniform vec4 stroke;\nuniform vec4 fill;\nuniform float opacity;\nuniform bool noiseEnable;\nvarying vec3 vPosition;\n#ifdef HAS_INSTANCE\nvarying vec4 vInstanceColor;\n#endif\n#include <mask_frag>\n#define F4 0.309016994374947451\n#define halfDist 0.5\nvec4 c(vec4 x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nfloat c(float x) {\n  return x - floor(x * (1. / 289.)) * 289.;\n}\nvec4 d(vec4 x) {\n  return c((x * 34. + 1.) * x);\n}\nfloat d(float x) {\n  return c((x * 34. + 1.) * x);\n}\nvec4 e(vec4 r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nfloat e(float r) {\n  return 1.79284291400159 - .85373472095314 * r;\n}\nvec4 f(float h, vec4 i) {\n  const vec4 k = vec4(1., 1., 1., -1.);\n  vec4 p, s;\n  p.xyz = floor(fract(vec3(h) * i.xyz) * 7.) * i.z - 1.;\n  p.w = 1.5 - dot(abs(p.xyz), k.xyz);\n  s = vec4(lessThan(p, vec4(.0)));\n  p.xyz = p.xyz + (s.xyz * 2. - 1.) * s.www;\n  return p;\n}\nfloat l(vec4 m) {\n  const vec4 n = vec4(.138196601125011, .276393202250021, .414589803375032, -.447213595499958);\n  vec4 o = floor(m + dot(m, vec4(F4)));\n  vec4 u = m - o + dot(o, n.xxxx);\n  vec4 A;\n  vec3 B = step(u.yzw, u.xxx);\n  vec3 D = step(u.zww, u.yyz);\n  A.x = B.x + B.y + B.z;\n  A.yzw = 1. - B;\n  A.y += D.x + D.y;\n  A.zw += 1. - D.xy;\n  A.z += D.z;\n  A.w += 1. - D.z;\n  vec4 E = clamp(A, .0, 1.);\n  vec4 F = clamp(A - 1., .0, 1.);\n  vec4 G = clamp(A - 2., .0, 1.);\n  vec4 H = u - G + n.xxxx;\n  vec4 I = u - F + n.yyyy;\n  vec4 J = u - E + n.zzzz;\n  vec4 K = u + n.wwww;\n  o = c(o);\n  float L = d(d(d(d(o.w) + o.z) + o.y) + o.x);\n  vec4 M = d(d(d(d(o.w + vec4(G.w, F.w, E.w, 1.)) + o.z + vec4(G.z, F.z, E.z, 1.)) + o.y + vec4(G.y, F.y, E.y, 1.)) + o.x + vec4(G.x, F.x, E.x, 1.));\n  vec4 i = vec4(1. / 294., 1. / 49., 1. / 7., .0);\n  vec4 N = f(L, i);\n  vec4 O = f(M.x, i);\n  vec4 P = f(M.y, i);\n  vec4 Q = f(M.z, i);\n  vec4 R = f(M.w, i);\n  vec4 S = e(vec4(dot(N, N), dot(O, O), dot(P, P), dot(Q, Q)));\n  N *= S.x;\n  O *= S.y;\n  P *= S.z;\n  Q *= S.w;\n  R *= e(dot(R, R));\n  vec3 T = max(.6 - vec3(dot(u, u), dot(H, H), dot(I, I)), .0);\n  vec2 U = max(.6 - vec2(dot(J, J), dot(K, K)), .0);\n  T = T * T;\n  U = U * U;\n  return 49. * (dot(T * T, vec3(dot(N, u), dot(O, H), dot(P, I))) + dot(U * U, vec2(dot(Q, J), dot(R, K))));\n}\nconst float V = 3.14159265359;\nfloat W(float X, float Y) {\n  float Z = fwidth(Y) * halfDist;\n  return smoothstep(X - Z, X + Z, Y);\n}\nvec4 ba(vec3 bb) {\n  float bc = min(min(bb.x, bb.y), bb.z);\n  float bd = .0;\n  if(noiseEnable)\n    bd += l(vec4(vPosition.xyz * 80.0, time * halfDist)) * .12;\n  bc += bd;\n  float be = max(bb.x, bb.y);\n  if(bb.y < bb.x && bb.y < bb.z) {\n    be = 1. - be;\n  }\n  float bf = thickness;\n  if(squeeze) {\n    bf *= mix(squeezeMin, squeezeMax, (1. - sin(be * V)));\n  }\n  if(dashEnabled) {\n    float bg = 1. / dashRepeats * dashLength / 2.;\n    if(!dashOverlap) {\n      bg += 1. / dashRepeats / 2.;\n    }\n    if(dashAnimate) {\n      bg += time * .22;\n    }\n    float bh = fract((be + bg) * dashRepeats);\n    bf *= 1. - W(dashLength, bh);\n  }\n  float bi = 1. - W(bf, bc);\n#ifdef HAS_INSTANCE\nvec4 bj = vInstanceColor;\n#else\nvec4 bj = stroke;\n#endif\nvec4 bk = vec4(.0);\n  if(seeThrough) {\n    bk = vec4(bj.xyz, bi);\n    if(insideAltColor && !gl_FrontFacing) {\n      bk.rgb = fill.xyz;\n    }\n  } else {\n    vec3 bl = mix(fill.xyz, bj.xyz, bi);\n    bk.a = fill.a;\n    if(dualStroke) {\n      float bm = 1. - W(secondThickness, bc);\n      vec3 bn = mix(fill.xyz, stroke.xyz, abs(bm - bi));\n      bk.rgb = bn;\n    } else {\n      bk.rgb = bl;\n    }\n  }\n  return bk;\n}\nvoid main() {\n  glFragColor = ba(vBarycentric);\n  glFragColor *= halfDist + opacity;\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>i["c"].multiply(n,e.viewMatrix,e.modelMatrix)}],extraCommandProps:e}),this.version=300}}var fe="precision mediump float;\n#include <gl2_frag>\nuniform vec4 baseColorFactor;\nuniform float materialShininess;\nuniform float environmentExposure;\nuniform float specularStrength;\nuniform vec3 light0_viewDirection;\nuniform vec3 ambientColor;\nuniform vec4 light0_diffuse;\nuniform vec3 lightSpecular;\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#ifdef HAS_TOON\nuniform float toons;\nuniform float specularToons;\n#endif\n#ifdef HAS_TANGENT\nvarying vec4 vTangent;\n#endif\n#ifdef HAS_MAP\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vNormal;\nvarying vec3 vFragPos;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nuniform vec2 extrusionOpacityRange;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_AO_MAP\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#include <heatmap_render_frag>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#include <highlight_frag>\n#include <mask_frag>\nvec3 c() {\n  \n#if defined(HAS_NORMAL_MAP)\nvec3 d = normalize(vNormal);\n  vec3 e = texture2D(normalTexture, computeTexCoord(vTexCoord)).xyz * 2. - 1.;\n#if defined(HAS_TANGENT)\nvec3 t = normalize(vTangent.xyz);\n  vec3 b = normalize(cross(d, t) * sign(vTangent.w));\n  mat3 f = mat3(t, b, d);\n  return normalize(f * e);\n#else\nreturn normalize(e);\n#endif\n#else\nreturn normalize(vNormal);\n#endif\n}\nvec4 h(const in vec4 i) {\n  return vec4(i.r < .0031308 ? i.r * 12.92 : 1.055 * pow(i.r, 1. / 2.4) - .055, i.g < .0031308 ? i.g * 12.92 : 1.055 * pow(i.g, 1. / 2.4) - .055, i.b < .0031308 ? i.b * 12.92 : 1.055 * pow(i.b, 1. / 2.4) - .055, i.a);\n}\nvec4 j() {\n  \n#if defined(HAS_BASECOLOR_MAP)\nreturn texture2D(baseColorTexture, computeTexCoord(vTexCoord));\n#elif defined(HAS_DIFFUSE_MAP)\nreturn texture2D(diffuseTexture, computeTexCoord(vTexCoord));\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn diffuseFactor;\n#else\nreturn baseColorFactor;\n#endif\n}\nvec3 k() {\n  \n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#elif defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn specularFactor;\n#else\nreturn vec3(1.);\n#endif\n}\nvoid main() {\n  vec4 l = j();\n  vec3 m = environmentExposure * ambientColor * l.rgb;\n#ifdef HAS_INSTANCE_COLOR\nm *= vInstanceColor.rgb;\n#endif\nvec3 o = c();\n  vec3 u = normalize(-light0_viewDirection);\n  float v = max(dot(o, u), .0);\n#ifdef HAS_TOON\nfloat A = floor(v * toons);\n  v = A / toons;\n#endif\nvec3 B = light0_diffuse.rgb * v * l.rgb;\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvec3 i = vColor.rgb;\n#elif defined(IS_LINE_EXTRUSION)\nvec3 i = lineColor.rgb;\n#else\nvec3 i = polygonFill.rgb;\n#endif\n#ifdef HAS_INSTANCE_COLOR\ni *= vInstanceColor.rgb;\n#endif\nm *= i.rgb;\n  B *= i.rgb;\n  vec3 C = normalize(cameraPosition - vFragPos);\n  vec3 D = normalize(u + C);\n  float E = pow(max(dot(o, D), .0), materialShininess);\n#ifdef HAS_TOON\nfloat F = floor(E * specularToons);\n  E = F / specularToons;\n#endif\nvec3 G = specularStrength * lightSpecular * E * k();\n#ifdef HAS_OCCLUSION_MAP\nfloat H = texture2D(occlusionTexture, computeTexCoord(vTexCoord1)).r;\n  m *= H;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat I = shadow_computeShadow();\n  B = shadow_blend(B, I).rgb;\n  G = shadow_blend(G, I).rgb;\n#endif\nvec3 J = m + B + G;\n#ifdef HAS_EMISSIVE_MAP\nvec3 K = texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n  J += K;\n#endif\n#ifdef IS_LINE_EXTRUSION\nglFragColor = vec4(J, lineOpacity * l.a);\n#else\nglFragColor = vec4(J, polygonOpacity * l.a);\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nfloat L = vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nfloat L = lineColor.a;\n#else\nfloat L = polygonFill.a;\n#endif\nglFragColor *= L;\n#ifdef HAS_EXTRUSION_OPACITY\nfloat M = extrusionOpacityRange.x;\n  float N = extrusionOpacityRange.y;\n  float O = M + vExtrusionOpacity * (N - M);\n  O = clamp(O, .0, 1.);\n  glFragColor *= O;\n#endif\nif(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",de="#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nvarying vec3 vFragPos;\nvarying vec3 vNormal;\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <highlight_vert>\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nattribute float aExtrusionOpacity;\nvarying float vExtrusionOpacity;\n#endif\n#if defined(HAS_TANGENT)\nvarying vec4 vTangent;\n#endif\nvoid c(const highp vec4 q, out highp vec3 d) {\n  d = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid c(const highp vec4 q, out highp vec3 d, out highp vec3 t) {\n  c(q, d);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 e = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 e = getPosition(aPosition);\n#endif\nmat4 f = getPositionMatrix();\n  vFragPos = vec3(modelMatrix * f * e);\n#if defined(HAS_NORMAL) || defined(HAS_TANGENT)\nmat3 h = modelNormalMatrix * mat3(f);\n  vec3 i;\n#if defined(HAS_TANGENT)\nvec3 t;\n  c(aTangent, i, t);\n  vTangent = vec4(h * t, aTangent.w);\n#else\ni = decode_getNormal(aNormal);\n#endif\nvec3 j = appendMorphNormal(i);\n  vNormal = normalize(h * j);\n#else\nvNormal = vec3(.0);\n#endif\nmat4 k = projMatrix;\n  k[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = k * getMaskPosition(f * e, modelMatrix);\n#else\ngl_Position = k * modelViewMatrix * f * e;\n#endif\n#ifdef HAS_MAP\nvec2 l = decode_getTexcoord(aTexCoord);\n  vTexCoord = l * uvScale + uvOffset;\n#endif\n#ifdef HAS_AO_MAP\nvec2 m = decode_getTexcoord(aTexCoord1);\n  vTexCoord1 = m * uvScale + uvOffset;\n#endif\n#ifdef HAS_EXTRUSION_OPACITY\nvExtrusionOpacity = aExtrusionOpacity;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(f * e);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * f, e);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\nhighlight_setVarying();\n}";class pe extends ce{constructor(t={}){const e=[],n=[],r=t.uniforms,s=[{name:"modelNormalMatrix",type:"function",fn:function(t,n){return i["b"].fromMat4(e,n.modelMatrix)}},{name:"modelViewMatrix",type:"function",fn:function(t,e){return i["c"].multiply(n,e.viewMatrix,e.modelMatrix)}}];r&&s.push(...r),super({vert:t.vert||de,frag:t.frag||fe,uniforms:s,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),e}}class Ae extends ce{constructor(t={}){const e=[];super({vert:"attribute vec3 aPosition;\n#ifdef HAS_COLOR0\nattribute vec4 aColor0;\nvarying vec4 vColor;\n#endif\nuniform mat4 modelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\nuniform float pointSize;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#endif\n#include <get_output>\n#include <heatmap_render_vert>\n#ifdef HAS_FLOODANALYSE\nvarying float vHeight;\n#endif\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_PointSize = pointSize;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = projViewModelMatrix * d * c;\n#endif\n#ifdef HAS_COLOR0\nvColor = aColor0 / 255.;\n#endif\n#ifdef HAS_MAP\nvTexCoord = aTexCoord;\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * d, c);\n#endif\n}",frag:"precision mediump float;\n#include <gl2_frag>\n#if defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#include <heatmap_render_frag>\nuniform vec4 baseColorFactor;\n#if defined(HAS_MAP)\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\nvarying vec2 vTexCoord;\n#endif\n#include <mask_frag>\nvoid main() {\n  \n#ifdef HAS_COLOR0\nglFragColor = vColor * baseColorFactor;\n#else\nglFragColor = vec4(1.) * baseColorFactor;\n#endif\n#ifdef HAS_MAP\n#ifdef HAS_ALBEDO_MAP\nglFragColor *= texture2D(baseColorTexture, vTexCoord);\n#endif\n#ifdef HAS_DIFFUSE_MAP\nglFragColor *= texture2D(diffuseTexture, vTexCoord);\n#endif\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:(t,n)=>i["c"].multiply(e,n.projViewMatrix,n.modelMatrix)}],defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}class ge extends pe{constructor(t={}){super({vert:de,frag:fe,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}var me="#if __VERSION__ == 300\n#define attribute in\n#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}";const ye=new Int8Array([-1,1,-1,-1,1,1,1,1,-1,-1,1,-1]),ve=new Uint8Array([0,1,0,0,1,1,1,1,0,0,1,0]);class xe extends ce{constructor(t){t.vert=t.vert||me,t.extraCommandProps=t.extraCommandProps||{},t.extraCommandProps.depth||(t.extraCommandProps.depth={enable:!1,mask:!1}),t.extraCommandProps.stencil||(t.extraCommandProps.stencil={enable:!1}),super(t)}draw(t){return this._quadMesh||this._createQuadMesh(t),super.draw(t,this._quadMesh)}getMeshCommand(t){const e=this.dkey||"";return this.commands[e+"_quad"]||(this.commands[e+"_quad"]=this.createREGLCommand(t,null,this._quadMesh[0].getElements())),this.commands[e+"_quad"]}_createQuadMesh(t){const e=new Q({aPosition:ye,aTexCoord:ve},null,ye.length/2,{positionSize:2,primitive:"triangles"});e.generateBuffers(t),this._quadMesh=[new Ft(e)]}dispose(){if(this._quadMesh){const t=this._quadMesh[0];t.geometry.dispose(),t.dispose()}return delete this._quadMesh,super.dispose()}}class be extends xe{constructor(){super({vert:me,frag:"#define SHADER_NAME FXAA\n#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision mediump float;\nvarying vec2 vTexCoord;\nuniform float enableFXAA;\nuniform float enableToneMapping;\nuniform float enableSharpen;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\n#ifdef HAS_TAA_TEX\nuniform sampler2D taaTextureSource;\n#ifdef HAS_FXAA_TEX\nuniform sampler2D fxaaTextureSource;\n#endif\n#endif\nuniform float pixelRatio;\nuniform float sharpFactor;\n#ifdef HAS_OUTLINE_TEX\nuniform sampler2D textureOutline;\nuniform float enableOutline;\nuniform float highlightFactor;\nuniform float outlineFactor;\nuniform float outlineWidth;\nuniform vec3 outlineColor;\n#endif\nvec2 c;\nvec4 d(vec2 e) {\n  \n#ifdef HAS_TAA_TEX\nvec4 f = texture2D(textureSource, e);\n  vec4 taa = texture2D(taaTextureSource, e);\n#ifdef HAS_FXAA_TEX\nvec4 h = texture2D(fxaaTextureSource, e);\n#else\nvec4 h = vec4(.0);\n#endif\nvec4 i = taa + f * (1. - taa.a);\n  return h + i * (1. - h.a);\n#else\nreturn texture2D(textureSource, e);\n#endif\n}\nvec4 j(vec2 k) {\n  vec4 l;\n  mediump vec2 m = vec2(1. / resolution.x, 1. / resolution.y);\n  vec3 n = d((k + vec2(-1., -1.)) * m).xyz;\n  vec3 o = d((k + vec2(1., -1.)) * m).xyz;\n  vec3 u = d((k + vec2(-1., 1.)) * m).xyz;\n  vec3 v = d((k + vec2(1.)) * m).xyz;\n  vec4 A = d(k * m);\n  vec3 B = A.xyz;\n  vec3 C = vec3(.299, .587, .114);\n  float D = dot(n, C);\n  float E = dot(o, C);\n  float F = dot(u, C);\n  float G = dot(v, C);\n  float H = dot(B, C);\n  float I = min(H, min(min(D, E), min(F, G)));\n  float J = max(H, max(max(D, E), max(F, G)));\n  mediump vec2 K;\n  K.x = -((D + E) - (F + G));\n  K.y = (D + F) - (E + G);\n  float L = max((D + E + F + G) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float M = 1. / (min(abs(K.x), abs(K.y)) + L);\n  K = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), K * M)) * m;\n  vec4 N = .5 * (d(k * m + K * (1. / 3. - .5)) + d(k * m + K * (2. / 3. - .5)));\n  vec4 O = N * .5 + .25 * (d(k * m + K * -.5) + d(k * m + K * .5));\n  float P = dot(O.xyz, C);\n  if(P < I || P > J)\n    l = N;\n  else\n    l = O;\n  return l;\n}\nvec3 Q(const in vec3 l, const float R) {\n  vec2 S = pixelRatio / resolution.xy;\n  float T = .0;\n  vec4 n = texture2D(textureSource, c + S * vec2(-1., -1.));\n  n.rgb = mix(vec3(.0), n.rgb, sign(n.a));\n  T += mix(.0, 1., sign(n.a));\n  vec4 v = texture2D(textureSource, c + S * vec2(1.));\n  v.rgb = mix(vec3(.0), v.rgb, sign(v.a));\n  T += mix(.0, 1., sign(v.a));\n  vec4 o = texture2D(textureSource, c + S * vec2(1., -1.));\n  o.rgb = mix(vec3(.0), o.rgb, sign(o.a));\n  T += mix(.0, 1., sign(o.a));\n  vec4 u = texture2D(textureSource, c + S * vec2(-1., 1.));\n  u.rgb = mix(vec3(.0), u.rgb, sign(u.a));\n  T += mix(.0, 1., sign(u.a));\n  return l + R * (T * l - n.rgb - o.rgb - u.rgb - v.rgb);\n}\nvec4 U(const in vec4 l) {\n  return vec4(Q(l.rgb, sharpFactor), l.a);\n}\nvec3 V(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float W = 2.43;\n  const float X = .59;\n  const float Y = .14;\n  return (x * (a * x + b)) / (x * (W * x + X) + Y);\n}\nvec3 Z(vec3 l) {\n  l = l / (l + vec3(1.));\n  return l = pow(l, vec3(1. / 2.2));\n}\n#ifdef HAS_OUTLINE_TEX\nvec4 ba() {\n  float bb = 2.;\n  float bc = 1.;\n  float bd = pixelRatio / resolution[0] * outlineWidth;\n  float be = pixelRatio / resolution[1] * outlineWidth;\n  vec4 bf = (texture2D(textureOutline, c + vec2(bd, be)));\n  vec4 bg = (texture2D(textureOutline, c + vec2(bd, .0)));\n  vec4 bh = (texture2D(textureOutline, c + vec2(bd, -be)));\n  vec4 bi = (texture2D(textureOutline, c + vec2(.0, -be)));\n  vec4 bj = (texture2D(textureOutline, c + vec2(-bd, -be)));\n  vec4 bk = (texture2D(textureOutline, c + vec2(-bd, .0)));\n  vec4 bl = (texture2D(textureOutline, c + vec2(-bd, be)));\n  vec4 bm = (texture2D(textureOutline, c + vec2(.0, be)));\n  vec4 bn = -bb * bk + bb * bg + -bc * bl + bc * bf + -bc * bj + bc * bh;\n  vec4 bo = -bb * bi + bb * bm + -bc * bj + bc * bl + -bc * bh + bc * bf;\n  float bp = sqrt(dot(bo, bo) + dot(bn, bn));\n  bool bq = bp < 1. / 65025.;\n  vec3 br = (texture2D(textureOutline, c)).r * outlineColor;\n  if(br == vec3(.0) || (highlightFactor == .0 && bq)) {\n    return vec4(.0);\n  }\n  float bs = bq ? highlightFactor : min(1., sqrt(bp) * outlineFactor);\n  return bs * vec4(br, 1.);\n}\nvec4 bt(const in vec4 l) {\n  vec4 ba = ba();\n  return ba + vec4(l) * (1. - ba.a);\n}\n#endif\nvoid main() {\n  c = vTexCoord;\n  vec4 l;\n  if(enableFXAA == 1.) {\n    l = j(c * resolution);\n  } else {\n    l = d(vTexCoord);\n  }\n  if(enableSharpen == 1.) {\n    l = U(l);\n  }\n#if defined(HAS_NOAA_TEX) || defined(HAS_POINT_TEX)\nvec4 bu = vec4(.0);\n  vec4 bv = vec4(.0);\n#ifdef HAS_POINT_TEX\nbu = texture2D(pointTextureSource, vTexCoord);\n#endif\n#ifdef HAS_NOAA_TEX\nbv = texture2D(noAaTextureSource, vTexCoord);\n#endif\nvec4 bw = bu + bv * (1. - bu.a);\n  l = bw + l * (1. - bw.a);\n#endif\nif(enableToneMapping == 1.) {\n    l.rgb = Z(l.rgb);\n  }\n#ifdef HAS_OUTLINE_TEX\nl = bt(l);\n#endif\ngl_FragColor = l;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){const n=this.dkey||"";return this.commands[n+"_fxaa"]||(this.commands[n+"_fxaa"]=this.createREGLCommand(t,null,e.getElements())),this.commands[n+"_fxaa"]}}class we extends xe{constructor({blurOffset:t}){super({vert:me,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\nuniform float ignoreTransparent;\nvoid main() {\n  vec4 c = vec4(.0);\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      vec4 f = texture2D(textureSource, e);\n      float h;\n      if(ignoreTransparent == 1.) {\n        h = sign(f.a);\n      } else {\n        h = 1.;\n      }\n      d += h;\n      c += h * f;\n    }\n  gl_FragColor = c / max(d, 1.) * clamp(sign(d - 1.), .0, 1.);\n}",defines:{BOXBLUR_OFFSET:t||2},extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}}class _e extends xe{constructor(){super({vert:me,frag:"precision mediump float;\n#define SHADER_NAME SSAO_BLUR\nstruct MaterialParams {\n  float farPlaneOverEdgeDistance;\n  vec2 axis;\n  vec2 resolution;\n};\nuniform sampler2D materialParams_ssao;\nuniform sampler2D TextureInput;\nuniform MaterialParams materialParams;\nvarying vec2 vTexCoord;\nconst int c = 6;\nfloat d[8];\nvoid e() {\n  d[0] = .099736;\n  d[1] = .096667;\n  d[2] = .088016;\n  d[3] = .075284;\n  d[4] = .060493;\n  d[5] = .045662;\n}\nfloat f(vec2 h) {\n  return (h.x * (256. / 257.) + h.y * (1. / 257.));\n}\nvoid tap(inout float i, inout float j, float k, float h, vec2 l) {\n  vec3 m = texture2D(materialParams_ssao, l).rgb;\n  float n = k;\n  i += m.r * n;\n  j += n;\n}\nvoid main() {\n  e();\n  highp vec2 o = vTexCoord;\n  vec3 m = texture2D(materialParams_ssao, o).rgb;\n  if(m.g * m.b == 1.) {\n    if(materialParams.axis.y > .0) {\n      vec4 u = texture2D(TextureInput, o);\n      gl_FragColor = u;\n    } else {\n      gl_FragColor = vec4(m, 1.);\n    }\n    return;\n  }\n  float h = f(m.gb);\n  float j = d[0];\n  float i = m.r * j;\n  vec2 v = materialParams.axis / materialParams.resolution;\n  vec2 A = v;\n  for(int B = 1; B < c; B++) {\n    float k = d[B];\n    tap(i, j, k, h, o + A);\n    tap(i, j, k, h, o - A);\n    A += v;\n  }\n  float C = i * (1. / j);\n  vec2 gb = m.gb;\n  if(materialParams.axis.y > .0) {\n    vec4 u = texture2D(TextureInput, o);\n    gl_FragColor = vec4(u.rgb * C, u.a);\n  } else {\n    gl_FragColor = vec4(C, gb, 1.);\n  }\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}})}getMeshCommand(t,e){return this.commands.ssao_blur||(this.commands.ssao_blur=this.createREGLCommand(t,null,e.getElements())),this.commands.ssao_blur}}const Me=[-2e-6,0,2e-6,-.095089,.004589,-.031253,.01518,-.025586,.003765,.073426,.021802,.002778,.094587,.043218,.089148,-.009509,.051369,.019673,.139973,-.101685,.10857,-.103804,.219853,-.043016,.004841,-.033988,.094187,.028011,.058466,-.25711,-.051031,.074993,.259843,.118822,-.186537,-.134192,.063949,-.094894,-.072683,.108176,.327108,-.254058,-.04718,.21918,.263895,-.407709,.240834,-.200352];class Te extends xe{constructor(){super({vert:me,frag:"#if __VERSION__ == 100\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision highp float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#define SHADER_NAME SSAO_EXTRACT\n#define PI 3.14159265359\nconst float c = .0625;\nstruct MaterialParams {\n  mat4 projMatrix;\n  mat4 invProjMatrix;\n  vec4 resolution;\n  float radius;\n  float bias;\n  float power;\n  vec2 cameraNearFar;\n};\nuniform MaterialParams materialParams;\nuniform sampler2D materialParams_depth;\n#define NOISE_NONE      0\n#define NOISE_PATTERN   1\n#define NOISE_RANDOM    2\n#define NOISE_TYPE      NOISE_PATTERN\nconst int d = 16;\nuniform vec3 kSphereSamples[16];\nvec3 e(const int x) {\n  if(x == 0) {\n    return vec3(-.078247, -.749924, -.656880);\n  } else if(x == 1) {\n    return vec3(-.572319, -.102379, -.813615);\n  } else if(x == 2) {\n    return vec3(.048653, -.380791, .923380);\n  } else if(x == 3) {\n    return vec3(.281202, -.656664, -.699799);\n  } else if(x == 4) {\n    return vec3(.711911, -.235841, -.661485);\n  } else if(x == 5) {\n    return vec3(-.445893, .611063, .654050);\n  } else if(x == 6) {\n    return vec3(-.703598, .674837, .222587);\n  } else if(x == 7) {\n    return vec3(.768236, .507457, .390257);\n  } else if(x == 8) {\n    return vec3(-.670286, -.470387, .573980);\n  } else if(x == 9) {\n    return vec3(.199235, .849336, -.488808);\n  } else if(x == 10) {\n    return vec3(-.768068, -.583633, -.263520);\n  } else if(x == 11) {\n    return vec3(-.897330, .328853, .294372);\n  } else if(x == 12) {\n    return vec3(-.570930, -.531056, -.626114);\n  } else if(x == 13) {\n    return vec3(.699014, .063283, -.712303);\n  } else if(x == 14) {\n    return vec3(.207495, .976129, -.064172);\n  } else if(x == 15) {\n    return vec3(-.060901, -.869738, -.489742);\n  } else {\n    return vec3(.0);\n  }\n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n  \n}\nvec2 f(highp float h) {\n  highp float z = clamp(h * 1. / -materialParams.cameraNearFar.y, .0, 1.);\n  highp float t = floor(256. * z);\n  mediump float i = t * (1. / 256.);\n  mediump float j = 256. * z - t;\n  return vec2(i, j);\n}\nfloat k(highp vec2 l) {\n  l = fract(l * vec2(5.3987, 5.4421));\n  l += dot(l.yx, l.xy + vec2(21.5351, 14.3137));\n  highp float xy = l.x * l.y;\n  return fract(xy * 95.4307) + fract(xy * 75.04961) * .5;\n}\nvec3 m(const vec2 o) {\n  \n#if NOISE_TYPE == NOISE_RANDOM\nreturn normalize(2. * vec3(k(o), k(o * 2.), k(o * 4.)) - vec3(1.));\n#elif NOISE_TYPE == NOISE_PATTERN\nvec2 xy = floor(gl_FragCoord.xy);\n  float u = mod(xy.x, 4.);\n  float v = mod(xy.y, 4.);\n  return e(int(u + v * 4.));\n#else\nreturn vec3(.0);\n#endif\n}\nhighp mat4 A() {\n  return materialParams.projMatrix;\n}\nhighp mat4 B() {\n  return materialParams.invProjMatrix;\n}\nhighp float C(const vec2 o) {\n  return texture2D(materialParams_depth, o).r;\n}\nhighp float D(highp float h) {\n  highp mat4 E = A();\n  highp float z = h * 2. - 1.;\n  return -E[3].z / (z + E[2].z);\n}\nhighp float F(const vec2 o) {\n  return D(texture2D(materialParams_depth, o).r);\n}\nhighp vec3 G(in vec2 p, highp float H) {\n  p = p * 2. - 1.;\n  highp mat4 I = B();\n  p.x *= I[0].x;\n  p.y *= I[1].y;\n  return vec3(p * -H, H);\n}\nhighp vec3 J(const highp vec3 K) {\n  highp vec3 L = dFdx(K);\n  highp vec3 M = dFdy(K);\n  return cross(L, M);\n}\nhighp vec3 J(const highp vec3 K, const vec2 o) {\n  vec2 N = o + vec2(materialParams.resolution.z, .0);\n  vec2 O = o + vec2(.0, materialParams.resolution.w);\n  highp vec3 px = G(N, F(N));\n  highp vec3 py = G(O, F(O));\n  highp vec3 L = px - K;\n  highp vec3 M = py - K;\n  return cross(L, M);\n}\nfloat P(const highp vec3 Q, const highp float R, mat3 S, const vec3 T, const vec3 U) {\n  highp mat4 E = A();\n  float V = materialParams.radius;\n  float W = materialParams.bias;\n  highp vec3 X = S * U;\n  float Y = dot(X, T);\n  X = sign(Y) * X;\n  X = Q + X * V;\n  highp vec4 Z = E * vec4(X, 1.);\n  Z.xy = Z.xy * (.5 / Z.w) + .5;\n  highp float ba = C(Z.xy);\n  ba = D(ba);\n  float t = saturate(V / abs(R - ba));\n  float bb = t * t * (3. - 2. * t);\n  return (ba >= X.z + W ? bb : .0);\n}\nvoid main() {\n  highp vec2 o = vTexCoord;\n  highp float h = C(o);\n  highp float bc = D(h);\n  highp vec3 Q = G(o, bc);\n  highp vec3 T = J(Q, o);\n  T = normalize(T);\n  vec3 bd = m(o);\n  vec3 be = bd.xyz;\n  vec3 bf = normalize(be - T * dot(be, T));\n  vec3 bg = cross(T, bf);\n  mat3 S = mat3(bf, bg, T);\n  float bh = .0;\n  for(int bi = 0; bi < d; bi++) {\n    bh += P(Q, bc, S, T, kSphereSamples[bi]);\n  }\n  float bj = 1. - bh / float(d);\n  bj = mix(bj, bj * bj, materialParams.power);\n  glFragColor = vec4(bj, f(Q.z), 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"kSphereSamples",type:"function",fn:function(){return Me}}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}),this.version=300}getMeshCommand(t,e){return this.commands.ssao_extract||(this.commands.ssao_extract=this.createREGLCommand(t,null,e.getElements())),this.commands.ssao_extract}}const Se=[];class Ie{constructor(t){this._renderer=t}render(t,e,n){const{width:r,height:i}=n;return this._initShaders(),this._extractFBO||this._createTextures(n),this._extract(t,r,i,n),this._blurAndCombine(e,t.cameraFar,r,i)}_blurAndCombine(t,e,n,r){const i=Math.floor(n/2),s=Math.floor(r/2);this._blurHTex.width===i&&this._blurHTex.height===s||(this._blurHFBO.resize(i,s),this._blurVFBO.resize(n,r));const o=[n,r],a=[1,0];return this._renderer.render(this._ssaoBlurShader,{TextureInput:t,materialParams_ssao:this._extractTex,materialParams:{axis:a,farPlaneOverEdgeDistance:-e/.0625,resolution:o},outputSize:[i,s]},null,this._blurHFBO),a[0]=0,a[1]=1,this._renderer.render(this._ssaoBlurShader,{TextureInput:t,materialParams_ssao:this._blurHTex,materialParams:{axis:a,farPlaneOverEdgeDistance:-e/.0625,resolution:o},outputSize:[n,r]},null,this._blurVFBO),this._blurVTex}_extract(t,e,n,r){const s=Math.floor(e/2),o=Math.floor(n/2);this._extractFBO.width===s&&this._extractFBO.height===o||this._extractFBO.resize(s,o);const{projMatrix:a}=t,l=i["c"].invert(Se,a);this._renderer.render(this._ssaoExtractShader,{materialParams_depth:r,materialParams:{projMatrix:a,invProjMatrix:l,resolution:[s,o,1/s,1/o],radius:t.radius,bias:t.bias,power:t.power||1,cameraNearFar:[t.cameraNear,t.cameraFar]},outputSize:[s,o]},null,this._extractFBO)}_createTextures(t){const e=Math.floor(t.width/2),n=Math.floor(t.height/2);this._extractTex=this._createTex(e,n,"uint8"),this._extractFBO=this._createFBO(this._extractTex),this._blurHTex=this._createTex(e,n,"uint8"),this._blurHFBO=this._createFBO(this._blurHTex),this._blurVTex=this._createTex(t.width,t.height,"uint8"),this._blurVFBO=this._createFBO(this._blurVTex)}_createTex(t,e,n){return this._renderer.regl.texture({min:"linear",mag:"linear",wrap:"clamp",type:n,width:t,height:e})}_createFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}dispose(){this._extractFBO&&(this._extractFBO.destroy(),delete this._extractFBO,this._blurVFBO.destroy(),this._blurHFBO.destroy(),this._ssaoExtractShader.dispose(),this._ssaoBlurShader.dispose(),delete this._ssaoExtractShader)}_initShaders(){this._ssaoExtractShader||(this._ssaoExtractShader=new Te,this._ssaoBlurShader=new _e)}}class Ce extends xe{constructor(){super({vert:me,frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec2 resolution;\nuniform sampler2D textureSource;\nuniform float enableVignette;\nuniform float enableGrain;\nuniform float enableLut;\nuniform float timeGrain;\nuniform float grainFactor;\nuniform vec2 lensRadius;\nuniform float frameMod;\nuniform sampler2D lookupTable;\nfloat c(const in vec2 d) {\n  vec3 e = fract(vec3(d.xyx) * .1031);\n  e += dot(e, e.yzx + 19.19);\n  return fract((e.x + e.y) * e.z);\n}\nfloat f() {\n  float h = c(gl_FragCoord.xy + 1000.0 * fract(timeGrain));\n  float i = h * 2. - 1.;\n  h = i * inversesqrt(abs(i));\n  h = max(-1., h);\n  h = h - sign(i) + .5;\n  return (h + .5) * .5;\n}\nvec4 j(const in vec4 k) {\n  float l = f();\n  return vec4(mix(k.rgb, k.rgb * (k.rgb + (1. - k.rgb) * 2. * l), grainFactor), k.a);\n}\nfloat m(const in float k) {\n  return k < .0031308 ? k * 12.92 : 1.055 * pow(k, 1. / 2.4) - .055;\n}\nvec3 m(const in vec3 k) {\n  return vec3(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055);\n}\nvec4 m(const in vec4 k) {\n  return vec4(k.r < .0031308 ? k.r * 12.92 : 1.055 * pow(k.r, 1. / 2.4) - .055, k.g < .0031308 ? k.g * 12.92 : 1.055 * pow(k.g, 1. / 2.4) - .055, k.b < .0031308 ? k.b * 12.92 : 1.055 * pow(k.b, 1. / 2.4) - .055, k.a);\n}\nfloat n(const in float k) {\n  return k < .04045 ? k * (1. / 12.92) : pow((k + .055) * (1. / 1.055), 2.4);\n}\nvec3 n(const in vec3 k) {\n  return vec3(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4));\n}\nvec4 n(const in vec4 k) {\n  return vec4(k.r < .04045 ? k.r * (1. / 12.92) : pow((k.r + .055) * (1. / 1.055), 2.4), k.g < .04045 ? k.g * (1. / 12.92) : pow((k.g + .055) * (1. / 1.055), 2.4), k.b < .04045 ? k.b * (1. / 12.92) : pow((k.b + .055) * (1. / 1.055), 2.4), k.a);\n}\nfloat o(const in vec2 d, const in float u) {\n  vec3 v = vec3(.06711056, .00583715, 52.9829189);\n  return fract(v.z * fract(dot(d.xy + u * vec2(47., 17.) * .695, v.xy)));\n}\nfloat A() {\n  vec2 B = lensRadius;\n  B.y = min(B.y, B.x - 1e-4);\n  float C = o(gl_FragCoord.xy, frameMod);\n  C = (B.x - B.y) * (B.x + B.y) * .07 * (C - .5);\n  return smoothstep(B.x, B.y, C + distance(vTexCoord, vec2(.5)));\n}\nvec4 D(const in vec4 k) {\n  float l = A();\n  return vec4(m(n(k.rgb) * l), clamp(k.a + (1. - l), .0, 1.));\n}\nvec4 E(in vec4 F, in sampler2D G) {\n  mediump float H = F.b * 63.;\n  mediump vec2 I;\n  I.y = floor(floor(H) / 8.);\n  I.x = floor(H) - I.y * 8.;\n  mediump vec2 J;\n  J.y = floor(ceil(H) / 8.);\n  J.x = ceil(H) - J.y * 8.;\n  highp vec2 K;\n  K.x = I.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  K.y = I.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nK.y = 1. - K.y;\n#endif\nhighp vec2 L;\n  L.x = J.x * .125 + .5 / 512. + (.125 - 1. / 512.) * F.r;\n  L.y = J.y * .125 + .5 / 512. + (.125 - 1. / 512.) * F.g;\n#ifdef LUT_FLIP_Y\nL.y = 1. - L.y;\n#endif\nlowp vec4 M = texture2D(G, K);\n  lowp vec4 N = texture2D(G, L);\n  lowp vec4 O = mix(M, N, fract(H));\n  return O;\n}\nvoid main() {\n  vec4 k = texture2D(textureSource, vTexCoord);\n  if(enableLut == 1.) {\n    k = E(k, lookupTable);\n  }\n  if(enableVignette == 1.) {\n    k = D(k);\n  }\n  if(enableGrain == 1.) {\n    k = j(k);\n  }\n  gl_FragColor = k;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}getMeshCommand(t,e){return this.commands.postprocess||(this.commands.postprocess=this.createREGLCommand(t,null,e.getElements())),this.commands.postprocess}}class Oe extends xe{constructor(){super({vert:me,frag:"#define SHADER_NAME TAA\nprecision mediump float;\n#define saturate(x)        clamp(x, 0.0, 1.0)\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\n#define TEXTURE_SPACE_UP    -1\n#define TEXTURE_SPACE_DN     1\n#else\n#define TEXTURE_SPACE_UP     1\n#define TEXTURE_SPACE_DN    -1\n#endif\n#define BOX_TYPE_AABB           0\n#define BOX_TYPE_VARIANCE       1\n#define BOX_TYPE_AABB_VARIANCE  2\n#define VARIANCE_GAMMA          1.0\n#define BOX_CLIPPING_ACCURATE   0\n#define BOX_CLIPPING_CLAMP      1\n#define BOX_CLIPPING_NONE       2\n#if defined(TARGET_MOBILE)\n#define BOX_CLIPPING            BOX_CLIPPING_ACCURATE\n#define BOX_TYPE                BOX_TYPE_VARIANCE\n#define USE_YCoCg               0\n#define FILTER_INPUT            1\n#define FILTER_HISTORY          0\n#else\n#define BOX_CLIPPING            BOX_CLIPPING_ACCURATE\n#define BOX_TYPE                BOX_TYPE_AABB_VARIANCE\n#define USE_YCoCg               0\n#define FILTER_INPUT            0\n#define FILTER_HISTORY          0\n#endif\n#define HISTORY_REPROJECTION    1\n#define PREVENT_FLICKERING      0\nstruct MaterialParams {\n  float alpha;\n  mat4 reprojection;\n};\nuniform sampler2D materialParams_color;\nuniform sampler2D materialParams_history;\nuniform vec2 materialParams_history_size;\nuniform vec2 textureOutputSize;\nuniform sampler2D materialParams_depth;\nuniform MaterialParams materialParams;\nfloat c(const vec3 d) {\n  return dot(d, vec3(.2126, .7152, .0722));\n}\nfloat e(const vec3 f) {\n  \n#if USE_YCoCg\nreturn f.x;\n#else\nreturn c(f);\n#endif\n}\nvec3 h(const vec3 i) {\n  float j = dot(i.rgb, vec3(1, 2, 1) * .25);\n  float k = dot(i.rgb, vec3(2, 0, -2) * .25);\n  float l = dot(i.rgb, vec3(-1, 2, -1) * .25);\n  return vec3(j, k, l);\n}\nvec3 m(const vec3 i) {\n  float j = i.x;\n  float k = i.y;\n  float l = i.z;\n  float r = j + k - l;\n  float g = j + l;\n  float b = j - k - l;\n  return vec3(r, g, b);\n}\nvec4 n(const int o, const vec3 u, const vec3 v, const vec4 i, const vec4 A) {\n  const float B = .0001;\n  if(o == BOX_CLIPPING_ACCURATE) {\n    vec4 r = i - A;\n    vec3 C = 1. / (B + r.rgb);\n    vec3 D = (v - A.rgb) * C;\n    vec3 E = (u - A.rgb) * C;\n    vec3 F = min(D, E);\n    return A + r * saturate(max(max(F.x, F.y), F.z));\n  } else if(o == BOX_CLIPPING_CLAMP) {\n    return vec4(clamp(A.rgb, u, v), A.a);\n  }\n  return A;\n}\nvec4 G(const sampler2D H, const highp vec2 I, const highp vec2 J) {\n  highp vec2 K = I * J;\n  highp vec2 L = floor(K - .5) + .5;\n  highp vec2 M = K - L;\n  highp vec2 N = M * M;\n  highp vec2 O = N * M;\n  vec2 P = N - .5 * (O + M);\n  vec2 Q = 1.5 * O - 2.5 * N + 1.;\n  vec2 R = .5 * (O - N);\n  vec2 S = 1. - P - Q - R;\n  vec2 T = Q + S;\n  highp vec2 U = L - vec2(1.);\n  highp vec2 V = L + vec2(2.);\n  highp vec2 W = L + S / T;\n  highp vec2 X = 1. / J;\n  U *= X;\n  V *= X;\n  W *= X;\n  float Z = T.x * P.y;\n  float ba = P.x * T.y;\n  float bb = T.x * T.y;\n  float bc = R.x * T.y;\n  float bd = T.x * R.y;\n  vec4 be = texture2D(H, vec2(W.x, U.y)) * Z + texture2D(H, vec2(U.x, W.y)) * ba + texture2D(H, vec2(W.x, W.y)) * bb + texture2D(H, vec2(V.x, W.y)) * bc + texture2D(H, vec2(W.x, V.y)) * bd;\n  be *= 1. / (Z + ba + bb + bc + bd);\n  return be;\n}\nvec4 bf(sampler2D H, vec2 I, float bg, ivec2 bh) {\n  return texture2D(H, I + vec2(bh));\n}\nvoid main() {\n  highp vec4 I = (gl_FragCoord.xy / textureOutputSize.xy).xyxy;\n  float bi = texture2D(materialParams_depth, I.xy).r;\n#if HISTORY_REPROJECTION\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\nI.w = 1. - I.w;\n#endif\nhighp vec4 q = materialParams.reprojection * vec4(I.zw, bi, 1.);\n  I.zw = (q.xy * (1. / q.w)) * .5 + .5;\n#if defined(TARGET_METAL_ENVIRONMENT) || defined(TARGET_VULKAN_ENVIRONMENT)\nI.w = 1. - I.w;\n#endif\n#endif\nvec4 f = bf(materialParams_color, I.xy, .0, ivec2(0));\n#if FILTER_HISTORY\nvec4 bj = G(materialParams_history, I.zw, materialParams_history_size);\n#else\nvec4 bj = texture2D(materialParams_history, I.zw);\n#endif\n#if USE_YCoCg\nbj.rgb = h(bj.rgb);\n#endif\nvec3 s[9];\n  s[0] = bf(materialParams_color, I.xy, .0, ivec2(-1, TEXTURE_SPACE_DN)).rgb;\n  s[1] = bf(materialParams_color, I.xy, .0, ivec2(0, TEXTURE_SPACE_DN)).rgb;\n  s[2] = bf(materialParams_color, I.xy, .0, ivec2(1, TEXTURE_SPACE_DN)).rgb;\n  s[3] = bf(materialParams_color, I.xy, .0, ivec2(-1, 0)).rgb;\n  s[4] = f.rgb;\n  s[5] = bf(materialParams_color, I.xy, .0, ivec2(1, 0)).rgb;\n  s[6] = bf(materialParams_color, I.xy, .0, ivec2(-1, TEXTURE_SPACE_UP)).rgb;\n  s[7] = bf(materialParams_color, I.xy, .0, ivec2(0, TEXTURE_SPACE_UP)).rgb;\n  s[8] = bf(materialParams_color, I.xy, .0, ivec2(1, TEXTURE_SPACE_UP)).rgb;\n#if USE_YCoCg\nfor(int bk = 0; bk < 9; bk++) {\n    s[bk] = h(s[bk]);\n  }\n  f.rgb = s[4].rgb;\n#endif\n#if FILTER_INPUT\n#else\nvec4 bl = f;\n#endif\n#if BOX_TYPE == BOX_TYPE_AABB || BOX_TYPE == BOX_TYPE_AABB_VARIANCE\nvec3 u = min(s[4], min(min(s[1], s[3]), min(s[5], s[7])));\n  vec3 v = max(s[4], max(max(s[1], s[3]), max(s[5], s[7])));\n  vec3 bm = min(u, min(min(s[0], s[2]), min(s[6], s[8])));\n  vec3 bn = max(v, max(max(s[0], s[2]), max(s[6], s[8])));\n  u = (u + bm) * .5;\n  v = (v + bn) * .5;\n#endif\n#if BOX_TYPE == BOX_TYPE_VARIANCE || BOX_TYPE == BOX_TYPE_AABB_VARIANCE\nvec3 bo = s[4];\n  vec3 bp = s[4] * s[4];\n  for(int bk = 1; bk < 9; bk += 2) {\n    bo += s[bk];\n    bp += s[bk] * s[bk];\n  }\n  vec3 bq = bo * (1. / 5.);\n  vec3 br = bp * (1. / 5.);\n  vec3 bs = sqrt(br - bq * bq);\n#if BOX_TYPE == BOX_TYPE_VARIANCE\nvec3 u = bq - VARIANCE_GAMMA * bs;\n  vec3 v = bq + VARIANCE_GAMMA * bs;\n#else\nu = min(u, bq - VARIANCE_GAMMA * bs);\n  v = max(v, bq + VARIANCE_GAMMA * bs);\n#endif\n#endif\nfloat bt = e(bl.rgb);\n  float bu = e(bj.rgb);\n  float bv = materialParams.alpha;\n#if PREVENT_FLICKERING\nfloat bw = 1. - abs(bt - bu) / (.001 + max(bt, bu));\n  bv *= bw * bw;\n#endif\nbl.rgb *= 1. / (1. + bt);\n  bj.rgb *= 1. / (1. + bu);\n  vec4 be = mix(bj, bl, bv);\n  be.rgb *= 1. / (1. - e(be.rgb));\n#if USE_YCoCg\nbe.rgb = m(be.rgb);\n#endif\nbe = max(vec4(0), be);\n  gl_FragColor = be;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.materialParams_color.width,height:(t,e)=>e.materialParams_color.height},blend:{enable:!1}}})}getMeshCommand(t,e){return this.commands.taa||(this.commands.taa=this.createREGLCommand(t,null,e.getElements())),this.commands.taa}}const Ee=[2,0,0,0,0,2,0,0,0,0,-2,0,-1,-1,1,1];class Pe{constructor(t,e){this._jitter=e,this._renderer=t,this._halton=[],this._counter=0}needToRedraw(){return this._counter<this._jitter.getSampleCount()}render(t,e,n,r){const s=this._jitter;this._initShaders(),this._createTextures(t),r&&(this._counter=0),this._counter++;const o=s.getSampleCount();if(this._counter>=o)return this._prevTex;this._fbo.width===t.width&&this._fbo.height===t.height||this._fbo.resize(t.width,t.height);const a=this._outputTex,l=this._prevTex,h=this._uniforms||{materialParams_history_size:[l.width,l.height],textureOutputSize:[],materialParams:{alpha:1,reprojection:[],filterWeights:[]}};h.materialParams.alpha=1/this._counter;const c=h.materialParams.reprojection;i["c"].multiply(c,this._prevProjMatrix||n,i["c"].invert(c,n)),i["c"].multiply(c,c,Ee),i["e"].set(h.materialParams_history_size,l.width,l.height),i["e"].set(h.textureOutputSize,t.width,t.height),h.materialParams_depth=e,h.materialParams_color=t,h.materialParams_history=l,this._renderer.render(this._shader,h,null,this._fbo);const u=this._outputTex,f=this._fbo;return this._outputTex=this._prevTex,this._fbo=this._prevFbo,this._prevTex=u,this._prevFbo=f,this._prevProjMatrix=i["c"].copy(this._prevProjMatrix||[],n),a}dispose(){this._shader&&(this._shader.dispose(),delete this._shader),this._fbo&&this._fbo.destroy(),this._prevFbo&&this._prevFbo.destroy(),delete this._uniforms}_createTextures(t){if(this._outputTex)return;const e=this._renderer.regl;this._outputTex=this._createColorTex(t),this._fbo=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1}),this._prevTex=this._createColorTex(t),this._prevFbo=e.framebuffer({width:t.width,height:t.height,colors:[this._prevTex],depth:!1,stencil:!1})}_createColorTex(t){return this._renderer.regl.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height})}_initShaders(){this._shader||(this._shader=new Oe)}}const ke=[[.263385,-.0252475],[-.38545,.054485],[-.139795,-.5379925],[-.2793775,.6875475],[.7139025,.4710925],[.90044,-.16422],[.4481775,-.82799],[-.9253375,-.2910625],[.3468025,1.02292],[-1.13742,.33522],[-.7676225,-.9123175],[-.2005775,-1.1774125],[-.926525,.96876],[1.12909,-.7500325],[.9603,1.14625]],Re=ke.length,Ne=[0,0];for(let ai=0;ai<ke.length;ai++)Ne[0]+=ke[ai][0],Ne[1]+=ke[ai][1];Ne[0]/=Re,Ne[1]/=Re;class De{constructor(t){this._frameNum=0,this._ratio=t||.05,this._avg=[Ne[0]*this._ratio,Ne[1]*this._ratio]}getRatio(){return this._ratio}setRatio(t){this._ratio!==t&&(this._ratio=t,this.reset()),this._avg=[Ne[0]*this._ratio,Ne[1]*this._ratio]}getAverage(){return this._avg}reset(){this._frameNum=0}getJitter(t){const e=this._frameNum%Re,n=this._ratio;return i["e"].set(t,ke[e][0]*n,ke[e][1]*n),t}frame(){this._frameNum++,this._frameNum%Re==0&&(this._frameNum=0)}getSampleCount(){return Re}}class Fe{constructor(t,e,n=5){this._regl=t,this._renderer=new F(t),this._inputRGBM=e,this._level=n}render(t,e){this._initShaders(),this._createTextures(t),this._blur(t,e||0);const n={blurTex0:this._blur01Tex,blurTex1:this._blur11Tex,blurTex2:this._blur21Tex,blurTex3:this._blur31Tex,blurTex4:this._blur41Tex};return this._level>5&&(n.blurTex5=this._blur51Tex,n.blurTex6=this._blur61Tex),n}_blur(t,e){let n=this._blurUniforms;n||(n=this._blurUniforms={rgbmRange:7,blurDir:[0,0],outSize:[0,0],pixelRatio:[1,1],outputSize:[0,0]}),i["e"].set(n.outSize,t.width,t.height),this._blurOnce(this._blur0Shader,t,this._blur00FBO,this._blur01FBO,.5,e),this._blurOnce(this._blur1Shader,this._blur01FBO.color[0],this._blur10FBO,this._blur11FBO,.5),this._blurOnce(this._blur2Shader,this._blur11FBO.color[0],this._blur20FBO,this._blur21FBO,.5),this._blurOnce(this._blur3Shader,this._blur21FBO.color[0],this._blur30FBO,this._blur31FBO,.5),this._blurOnce(this._blur4Shader,this._blur31FBO.color[0],this._blur40FBO,this._blur41FBO,.5),this._level>5&&(this._blurOnce(this._blur5Shader,this._blur41FBO.color[0],this._blur50FBO,this._blur51FBO,.5),this._blurOnce(this._blur6Shader,this._blur51FBO.color[0],this._blur60FBO,this._blur51FBO,.5))}_blurOnce(t,e,n,r,s,o){const a=Math.ceil(s*e.width),l=Math.ceil(s*e.height);n.width===a&&n.height===l||n.resize(a,l),r.width===a&&r.height===l||r.resize(a,l);const h=this._blurUniforms;h.luminThreshold=o,h.TextureBlurInput=e,h.inputRGBM=+this._inputRGBM,i["e"].set(h.blurDir,0,1),i["e"].set(h.outputSize,n.width,n.height),this._renderer.render(t,h,null,n),h.luminThreshold=0,h.inputRGBM=1,i["e"].set(h.blurDir,1,0),h.TextureBlurInput=n.color[0],this._renderer.render(t,h,null,r)}dispose(){this._blur0Shader&&(this._blur0Shader.dispose(),delete this._blur0Shader,this._blur1Shader.dispose(),this._blur2Shader.dispose(),this._blur3Shader.dispose(),this._blur4Shader.dispose(),this._blur5Shader&&(this._blur5Shader.dispose(),this._blur6Shader.dispose(),delete this._blur5Shader)),this._blur00Tex&&(delete this._blur00Tex,this._blur00FBO.destroy(),this._blur01FBO.destroy(),this._blur10FBO.destroy(),this._blur11FBO.destroy(),this._blur20FBO.destroy(),this._blur21FBO.destroy(),this._blur30FBO.destroy(),this._blur31FBO.destroy(),this._blur40FBO.destroy(),this._blur41FBO.destroy(),this._blur50FBO&&(this._blur50FBO.destroy(),this._blur51FBO.destroy(),this._blur60FBO.destroy(),this._blur61FBO.destroy()))}_createTextures(t){if(this._blur00Tex)return;let e=t.width,n=t.height;this._blur00Tex=this._createColorTex(t,e,n),this._blur00FBO=this._createBlurFBO(this._blur00Tex),this._blur01Tex=this._createColorTex(t),this._blur01FBO=this._createBlurFBO(this._blur01Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur10Tex=this._createColorTex(t,e,n),this._blur10FBO=this._createBlurFBO(this._blur10Tex),this._blur11Tex=this._createColorTex(t,e,n),this._blur11FBO=this._createBlurFBO(this._blur11Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur20Tex=this._createColorTex(t,e,n),this._blur20FBO=this._createBlurFBO(this._blur20Tex),this._blur21Tex=this._createColorTex(t,e,n),this._blur21FBO=this._createBlurFBO(this._blur21Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur30Tex=this._createColorTex(t,e,n),this._blur30FBO=this._createBlurFBO(this._blur30Tex),this._blur31Tex=this._createColorTex(t,e,n),this._blur31FBO=this._createBlurFBO(this._blur31Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur40Tex=this._createColorTex(t,e,n),this._blur40FBO=this._createBlurFBO(this._blur40Tex),this._blur41Tex=this._createColorTex(t,e,n),this._blur41FBO=this._createBlurFBO(this._blur41Tex),this._level>5&&(e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur50Tex=this._createColorTex(t,e,n),this._blur50FBO=this._createBlurFBO(this._blur50Tex),this._blur51Tex=this._createColorTex(t,e,n),this._blur51FBO=this._createBlurFBO(this._blur51Tex),e=Math.ceil(e/2),n=Math.ceil(n/2),this._blur60Tex=this._createColorTex(t,e,n),this._blur60FBO=this._createBlurFBO(this._blur60Tex),this._blur61Tex=this._createColorTex(t,e,n),this._blur61FBO=this._createBlurFBO(this._blur61Tex))}_createColorTex(t,e,n){return this._regl.texture({min:"linear",mag:"linear",type:"uint8",width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._blur0Shader){const t={vert:me,extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}},frag:"#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\nuniform float inputRGBM;\nuniform float luminThreshold;\n#define SHADER_NAME GAUSSIAN_BLUR0\nconst vec3 c = vec3(.2126, .7152, .0722);\nfloat d(const in vec3 e) {\n  return dot(e, c);\n}\nvec4 f(vec4 e) {\n  float h = max(sign(d(e.rgb) - luminThreshold), .0);\n  return e * h;\n}\nvec2 i;\nvec4 j(const in vec3 e, const in float k) {\n  vec4 l;\n  vec3 m = e / k;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvec3 n(const in vec4 e, const in float k) {\n  if(inputRGBM == .0)\n    return e.rgb;\n  return k * e.rgb * e.a;\n}\nvec4 o() {\n  vec3 u = .375 * (f(vec4(n(texture2D(TextureBlurInput, i.xy), rgbmRange), 1.))).rgb;\n  vec2 v;\n  vec2 A = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  v = A * 1.2;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy + v.xy), rgbmRange), 1.))).rgb;\n  u += .3125 * (f(vec4(n(texture2D(TextureBlurInput, i.xy - v.xy), rgbmRange), 1.))).rgb;\n  return vec4(u, 1.);\n}\nvoid main(void) {\n  i = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = o();\n  e = j(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}"};this._blur0Shader=new xe(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR1\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .3125 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.2857142857142858;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur1Shader=new xe(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR2\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2734375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3333333333333333;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .328125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.111111111111111;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .03515625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur2Shader=new xe(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR3\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .24609375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3636363636363635;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .322265625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.1818181818181817;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0537109375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur3Shader=new xe(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR4\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .2255859375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  m = n * 1.3846153846153846;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .314208984375 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.230769230769231;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .06982421875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.076923076923077;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .003173828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur4Shader=new xe(t),this._level>5&&(t.frag="precision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR5\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .20947265625 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.4;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .30548095703125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2666666666666666;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .08331298828125 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.133333333333334;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .00640869140625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur5Shader=new xe(t),t.frag="#version 100\nprecision highp float;\nuniform float rgbmRange;\nuniform sampler2D TextureBlurInput;\nuniform sampler2D TextureInput;\nuniform vec2 blurDir;\nuniform vec2 outSize;\nuniform vec2 pixelRatio;\nuniform vec2 outputSize;\n#define SHADER_NAME GAUSSIAN_BLUR6\nvec2 c;\nvec4 d(const in vec3 e, const in float f) {\n  if(f <= .0)\n    return vec4(e, 1.);\n  vec4 h;\n  vec3 i = e / f;\n  h.a = clamp(max(max(i.r, i.g), max(i.b, 1e-6)), .0, 1.);\n  h.a = ceil(h.a * 255.) / 255.;\n  h.rgb = i / h.a;\n  return h;\n}\nvec3 j(const in vec4 e, const in float f) {\n  if(f <= .0)\n    return e.rgb;\n  return f * e.rgb * e.a;\n}\nvec4 k() {\n  vec3 l = .196380615234375 * (vec4(j(texture2D(TextureBlurInput, c.xy), rgbmRange), 1.)).rgb;\n  vec2 m;\n  vec2 n = pixelRatio.xy * blurDir.xy / outputSize.xy;\n  n *= outSize.y * .00075;\n  m = n * 1.411764705882353;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .2967529296875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 3.2941176470588234;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .09442138671875 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  m = n * 5.176470588235294;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy + m.xy), rgbmRange), 1.)).rgb;\n  l += .0103759765625 * (vec4(j(texture2D(TextureBlurInput, c.xy - m.xy), rgbmRange), 1.)).rgb;\n  return vec4(l, 1.);\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = k();\n  e = d(e.rgb, rgbmRange);\n  gl_FragColor = e;\n}",this._blur6Shader=new xe(t))}}}class Le{constructor(t){this._regl=t,this._renderer=new F(t)}render(t,e,n,r,i,s,o,a,l){this._initShaders(),this._createTextures(t);const h=this._blurPass.render(e,n);return this._combine(t,h,e,r,i,s,o,a,l)}_combine(t,e,n,r,s,o,a,l,h){h||this._combineTex.width===t.width&&this._combineTex.height===t.height||this._combineFBO.resize(t.width,t.height);let c=this._combineUniforms;const{blurTex0:u,blurTex1:f,blurTex2:d,blurTex3:p,blurTex4:A}=e;c||(c=this._combineUniforms={bloomFactor:0,bloomRadius:0,rgbmRange:7,TextureBloomBlur1:u,TextureBloomBlur2:f,TextureBloomBlur3:d,TextureBloomBlur4:p,TextureBloomBlur5:A,TextureInput:null,TextureSource:null,outputSize:[0,0]}),c.noAaTextureSource=o,c.pointTextureSource=a,c.enableAA=l,c.bloomFactor=r,c.bloomRadius=s,c.TextureInput=n,c.TextureSource=t,i["e"].set(c.outputSize,t.width,t.height);const g={};return o?g.HAS_NOAA_TEX=1:delete g.HAS_NOAA_TEX,a?g.HAS_POINT_TEX=1:delete g.HAS_POINT_TEX,this._combineShader.setDefines(g),this._renderer.render(this._combineShader,c,null,h?null:this._combineFBO),h?null:this._combineTex}dispose(){this._combineFBO&&(this._combineFBO.destroy(),delete this._combineFBO),this._blurPass&&(this._blurPass.dispose(),delete this._blurPass),delete this._uniforms}_createTextures(t){this._combineTex||(this._combineTex=this._createColorTex(t,t.width,t.height,"uint8"),this._combineFBO=this._createBlurFBO(this._combineTex))}_createColorTex(t,e,n,r){return this._renderer.regl.texture({min:"linear",mag:"linear",type:r,width:e||t.width,height:n||t.height})}_createBlurFBO(t){return this._renderer.regl.framebuffer({width:t.width,height:t.height,colors:[t],depth:!1,stencil:!1})}_initShaders(){if(!this._combineShader){const t={x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]};this._blurPass=new Fe(this._regl,!1),this._combineShader=new xe({vert:me,frag:"#define FXAA_REDUCE_MIN   (1.0/ 128.0)\n#define FXAA_REDUCE_MUL   (1.0 / 8.0)\n#define FXAA_SPAN_MAX     8.0\nprecision highp float;\nuniform float bloomFactor;\nuniform float bloomRadius;\nuniform float rgbmRange;\nuniform sampler2D TextureBloomBlur1;\nuniform sampler2D TextureBloomBlur2;\nuniform sampler2D TextureBloomBlur3;\nuniform sampler2D TextureBloomBlur4;\nuniform sampler2D TextureBloomBlur5;\nuniform sampler2D TextureInput;\nuniform sampler2D TextureSource;\n#ifdef HAS_NOAA_TEX\nuniform sampler2D noAaTextureSource;\n#endif\n#ifdef HAS_POINT_TEX\nuniform sampler2D pointTextureSource;\n#endif\nuniform float enableAA;\nuniform vec2 outputSize;\n#define SHADER_NAME bloomCombine\nvec2 c;\nvec3 d(const in vec3 e) {\n  return vec3(e.r < .0031308 ? e.r * 12.92 : 1.055 * pow(e.r, 1. / 2.4) - .055, e.g < .0031308 ? e.g * 12.92 : 1.055 * pow(e.g, 1. / 2.4) - .055, e.b < .0031308 ? e.b * 12.92 : 1.055 * pow(e.b, 1. / 2.4) - .055);\n}\nvec3 f(const in vec4 e, const in float h) {\n  if(h <= .0)\n    return e.rgb;\n  return h * e.rgb * e.a;\n}\nfloat i(const float j, const float k) {\n  return mix(j, k * 2. - j, bloomRadius);\n}\nvec4 l(sampler2D m, vec2 n) {\n  vec4 e;\n  mediump vec2 o = vec2(1. / outputSize.x, 1. / outputSize.y);\n  vec3 u = texture2D(m, (n + vec2(-1., -1.)) * o).xyz;\n  vec3 v = texture2D(m, (n + vec2(1., -1.)) * o).xyz;\n  vec3 A = texture2D(m, (n + vec2(-1., 1.)) * o).xyz;\n  vec3 B = texture2D(m, (n + vec2(1.)) * o).xyz;\n  vec4 C = texture2D(m, n * o);\n  vec3 D = C.xyz;\n  vec3 E = vec3(.299, .587, .114);\n  float F = dot(u, E);\n  float G = dot(v, E);\n  float H = dot(A, E);\n  float I = dot(B, E);\n  float J = dot(D, E);\n  float K = min(J, min(min(F, G), min(H, I)));\n  float L = max(J, max(max(F, G), max(H, I)));\n  mediump vec2 M;\n  M.x = -((F + G) - (H + I));\n  M.y = (F + H) - (G + I);\n  float N = max((F + G + H + I) * (.25 * FXAA_REDUCE_MUL), FXAA_REDUCE_MIN);\n  float O = 1. / (min(abs(M.x), abs(M.y)) + N);\n  M = min(vec2(FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), M * O)) * o;\n  vec4 P = .5 * (texture2D(m, n * o + M * (1. / 3. - .5)) + texture2D(m, n * o + M * (2. / 3. - .5)));\n  vec4 Q = P * .5 + .25 * (texture2D(m, n * o + M * -.5) + texture2D(m, n * o + M * .5));\n  float R = dot(Q.xyz, E);\n  if(R < K || R > L)\n    e = P;\n  else\n    e = Q;\n  return e;\n}\nvec4 S() {\n  vec3 T = vec3(.0);\n  const float U = .6;\n  const float V = 1.1;\n  const float W = .9;\n  const float X = .6;\n  const float Y = .3;\n  const float Z = .1;\n  T += (vec4(f(texture2D(TextureBloomBlur1, c), rgbmRange), 1.)).rgb * i(V, U);\n  T += (vec4(f(texture2D(TextureBloomBlur2, c), rgbmRange), 1.)).rgb * i(W, U);\n  T += (vec4(f(texture2D(TextureBloomBlur3, c), rgbmRange), 1.)).rgb * i(X, U);\n  T += (vec4(f(texture2D(TextureBloomBlur4, c), rgbmRange), 1.)).rgb * i(Y, U);\n  T += (vec4(f(texture2D(TextureBloomBlur5, c), rgbmRange), 1.)).rgb * i(Z, U);\n  vec4 ba;\n  if(enableAA == 1.) {\n    ba = l(TextureInput, gl_FragCoord.xy);\n  } else {\n    ba = texture2D(TextureInput, c);\n  }\n  ba.rgb = mix(vec3(.0), ba.rgb, sign(ba.a));\n  vec4 bb = texture2D(TextureSource, c);\n#ifdef HAS_NOAA_TEX\nvec4 bc = texture2D(noAaTextureSource, c);\n  bb = bc + bb * (1. - bc.a);\n#endif\nvec4 bd = vec4(.0);\n#ifdef HAS_POINT_TEX\nbd = texture2D(pointTextureSource, c);\n#endif\nfloat be = sqrt((T.r + T.g + T.b) / 3.);\n  vec4 bf = vec4(d(T * bloomFactor), be);\n  return bd + (ba + bb * (1. - ba.a)) * (1. - bd.a) + bf;\n}\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 e = S();\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:t}})}}}class ze extends xe{constructor(){const t=[];super({vert:me,frag:"precision highp float;\n#include <gl2_frag>\n#define SHADER_NAME COPY_DEPTH\nuniform sampler2D TextureDepth;\nuniform vec2 textureSize;\n#include <common_pack_float>\nvoid main(void) {\n  vec2 c = gl_FragCoord.xy / textureSize.xy;\n  float d = texture2D(TextureDepth, c).r;\n  glFragColor = common_encodeDepth(d);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"textureSize",type:"function",fn:(e,n)=>(t[0]=n.TextureDepth.width,t[1]=n.TextureDepth.height,t)}],extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.TextureDepth.width,height:(t,e)=>e.TextureDepth.height}}}),this.version=300}getMeshCommand(t,e){return this.commands.copy_depth||(this.commands.copy_depth=this.createREGLCommand(t,null,e.getElements())),this.commands.copy_depth}}class Be{static getUniformDeclares(){const t=[[0,0,0,0],[0,0,0,0]],e=new Array(16);return[{name:"invProjMatrix",type:"function",fn:(t,n)=>i["c"].invert(e,n.projMatrix)},{name:"outputFovInfo",type:"array",length:2,fn:function(e,n){const r=Math.tan(.5*n.fov),s=n.outSize[0]/n.outSize[1]*r;return i["g"].set(t[0],s,r,s,-r),i["g"].set(t[1],-s,r,-s,-r),t}},{name:"reprojViewProjMatrix",type:"function",fn:(t,e)=>i["c"].multiply([],e.prevProjViewMatrix,e.cameraWorldMatrix)}]}static getDefines(){return{HAS_SSR:1}}constructor(t){this._regl=t,this._renderer=new F(t),this._inputRGBM=0}setup(t){this._initShaders(),this._createTextures(t)}getSSRUniforms(t,e,n){if(!this._depthCopy)return null;const r=this._depthCopy;return{TextureDepth:r,TextureReflected:this.getMipmapTexture(),ssrFactor:e||1,ssrQuality:n||2,outSize:[r.width,r.height],fov:t.getFov()*Math.PI/180,prevProjViewMatrix:this._projViewMatrix||t.projViewMatrix,cameraWorldMatrix:t.cameraWorldMatrix}}genMipMap(t,e,n){return this.setup(t),this._mipmap(t),this.copyDepthTex(e),this._projViewMatrix||(this._projViewMatrix=[]),i["c"].copy(this._projViewMatrix,n),delete this._depthCopied,this._outputTex}getPrevProjViewMatrix(){return this._projViewMatrix}copyDepthTex(t){return this._depthCopied?null:(this.setup(t),this._depthCopy?t.width===this._depthCopy.width&&t.height===this._depthCopy.height||this._depthCopyFBO.resize(t.width,t.height):(this._depthCopy=this._regl.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"uint8",width:t.width,height:t.height}),this._depthCopyFBO=this._regl.framebuffer({width:t.width,height:t.height,colors:[this._depthCopy],colorFormat:"rgba"})),this._renderer.render(this._copyDepthShader,{TextureDepth:t},null,this._depthCopyFBO),this._depthCopied=!0,this._depthCopy)}_mipmap(t){const e=this._targetFBO,n=Math.ceil(.5*t.width),r=Math.ceil(.5*t.height);e.width===n&&e.height===r||e.resize(n,r);let s=this._blurUniforms;s||(s=this._blurUniforms={rgbmRange:7,outputSize:[0,0]}),s.TextureInput=t,s.inputRGBM=+this._inputRGBM,i["e"].set(s.outputSize,e.width,e.height),this._renderer.render(this._ssrQuadShader,s,null,e)}getMipmapTexture(){return this._outputTex||(this._outputTex=this._renderer.regl.texture({type:"uint8",width:2,height:2})),this._outputTex}dispose(){this._copyDepthShader&&(this._ssrQuadShader.dispose(),this._copyDepthShader.dispose(),this._targetFBO.destroy(),delete this._copyDepthShader),this._depthCopy&&(this._depthCopyFBO.destroy(),delete this._depthCopy,delete this._depthCopyFBO)}_initShaders(){this._copyDepthShader||(this._copyDepthShader=new ze,this._ssrQuadShader=new xe({vert:me,frag:"#version 100\nprecision mediump float;\nuniform sampler2D TextureInput;\nuniform vec2 outputSize;\n#define SHADER_NAME QUAD\nvec2 c;\nvoid main(void) {\n  c = gl_FragCoord.xy / outputSize.xy;\n  vec4 d = texture2D(TextureInput, c.xy);\n  gl_FragColor = d;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.outputSize[0],height:(t,e)=>e.outputSize[1]}}}))}_createTextures(t){if(!this._targetFBO){const e=this._regl;this._outputTex&&this._outputTex.destroy(),this._outputTex=e.texture({min:"linear",mag:"linear",type:"uint8",width:t.width,height:t.height}),this._targetFBO=e.framebuffer({width:t.width,height:t.height,colors:[this._outputTex],depth:!1,stencil:!1})}}}class He extends ce{constructor(t){const e=[];super({vert:"#define SHADER_NAME HEATMAP\nuniform mat4 projViewModelMatrix;\nuniform float extrudeScale;\nuniform float heatmapIntensity;\nattribute vec3 aPosition;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nattribute highp float aWeight;\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\nuniform mediump float heatmapRadius;\nconst highp float c = 1. / 255. / 16.;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float d = aWeight / 255.;\n  weight = d;\n#else\nhighp float d = heatmapWeight;\n#endif\nmediump float e = heatmapRadius;\n  vec2 f = vec2(mod(aPosition.xy, 2.) * 2. - 1.);\n  float h = sqrt(-2. * log(c / d / heatmapIntensity / GAUSS_COEF)) / 3.;\n  vExtrude = h * f;\n  vec2 i = vExtrude * e * extrudeScale;\n  vec4 j = vec4(floor(aPosition.xy * .5) + i, aPosition.z, 1);\n  gl_Position = projViewModelMatrix * j;\n}",frag:"#define SHADER_NAME HEATMAP\nprecision mediump float;\nuniform highp float heatmapIntensity;\nvarying vec2 vExtrude;\n#ifdef HAS_HEAT_WEIGHT\nvarying highp float weight;\n#else\nuniform highp float heatmapWeight;\n#endif\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n  \n#ifdef HAS_HEAT_WEIGHT\nhighp float c = weight;\n#else\nhighp float c = heatmapWeight;\n#endif\nfloat d = -.5 * 3. * 3. * dot(vExtrude, vExtrude);\n  float e = c * heatmapIntensity * GAUSS_COEF * exp(d);\n  gl_FragColor = vec4(e, 1., 1., 1.);\n}",uniforms:[{name:"extrudeScale",type:"function",fn:function(t,e){return e.resolution/e.dataResolution*e.tileRatio}},{name:"projViewModelMatrix",type:"function",fn:function(t,n){return i["c"].multiply(e,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:u({},t&&t.extraCommandProps||{},{blend:{enable:!0,func:{src:"one",dst:"one"},equation:"add"}})})}}var Ue=[-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,-1,-1,-1,1,-1,-1,-1,-1,1,-1,-1,1,-1,-1,1,1,-1,-1,1,1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,-1,-1,1,-1,1,1,1,1,1,1,1,1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,1,-1,-1,1,-1,-1,-1,-1,1,1,-1,1],je="#define SHADER_NAME SKYBOX\n#if __VERSION__ == 100\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\nprecision highp float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nvarying vec3 vWorldPos;\n#ifdef USE_AMBIENT\nuniform vec3 diffuseSPH[9];\n#else\nuniform samplerCube cubeMap;\nuniform float bias;\nuniform float size;\n#endif\nuniform float environmentExposure;\n#if defined(INPUT_RGBM) || defined(ENC_RGBM)\nuniform float rgbmRange;\n#endif\nvec4 c(const in vec3 d, const in float e) {\n  if(e <= .0)\n    return vec4(d, 1.);\n  vec4 f;\n  vec3 h = d / e;\n  f.a = clamp(max(max(h.r, h.g), max(h.b, 1e-6)), .0, 1.);\n  f.a = ceil(f.a * 255.) / 255.;\n  f.rgb = h / f.a;\n  return f;\n}\nvec3 i(const in vec4 d, const in float e) {\n  if(e <= .0)\n    return d.rgb;\n  return e * d.rgb * d.a;\n}\nvec4 j(const in samplerCube k, const in vec3 l, const in float m, const in float n) {\n  vec3 o = l;\n  return textureCubeLod(k, o, n);\n}\nvec3 u(const in vec3 v, const in vec3 A[9]) {\n  float x = v.x;\n  float y = v.y;\n  float z = v.z;\n  vec3 B = (A[0] + A[1] * x + A[2] * y + A[3] * z + A[4] * z * x + A[5] * y * z + A[6] * y * x + A[7] * (3. * z * z - 1.) + A[8] * (x * x - y * y));\n  return max(B, vec3(.0));\n}\nfloat C(const in vec2 D) {\n  vec3 E = fract(vec3(D.xyx) * .1031);\n  E += dot(E, E.yzx + 19.19);\n  return fract((E.x + E.y) * E.z);\n}\nvoid main() {\n  vec4 F;\n#ifdef USE_AMBIENT\nvec3 v = normalize(vWorldPos + mix(-.5 / 255., .5 / 255., C(gl_FragCoord.xy)) * 2.);\n  F = vec4(u(v, diffuseSPH), 1.);\n  if(length(hsv) > .0) {\n    F.rgb = hsv_apply(F.rgb, hsv);\n  }\n#else\nF = j(cubeMap, vWorldPos, size, bias);\n#endif\nF.rgb *= environmentExposure;\n#ifdef ENC_RGBM\n#if !defined(USE_AMBIENT) && defined(INPUT_RGBM)\nif(length(hsv) > .0) {\n    F.rgb = hsv_apply(i(F, rgbmRange).rgb, hsv);\n    F = c(F.rgb, rgbmRange);\n  }\n#else\nF = c(F.rgb, rgbmRange);\n#endif\nglFragColor = F;\n#elif !defined(USE_AMBIENT) && defined(INPUT_RGBM)\nglFragColor = vec4(i(F, rgbmRange), 1.);\n  if(length(hsv) > .0) {\n    glFragColor.rgb = hsv_apply(clamp(glFragColor.rgb, .0, 1.), hsv);\n  }\n#else\nif(length(hsv) > .0) {\n    F.rgb = hsv_apply(F.rgb, hsv);\n  }\n  glFragColor = F;\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}";class Ve extends ce{constructor(){super({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 transformMatrix;\nvarying vec3 vWorldPos;\nvoid main() {\n  vWorldPos = aPosition;\n  mat4 c = mat4(mat3(viewMatrix) * transformMatrix);\n  vec4 d = projMatrix * c * vec4(vWorldPos, 1.);\n  gl_Position = d.xyww;\n}",frag:je,extraCommandProps:{depth:{enable:!0,range:[1,1],func:"lequal"},viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}}),this.version=300}setMode(t,e,n){const r={};return t&&(r.INPUT_RGBM=1),e&&(r.ENC_RGBM=1),0===n&&(r.USE_AMBIENT=1),this._skyboxMesh?this._skyboxMesh[0].setDefines(r):this._meshDefines=r,this}draw(t){return this._skyboxMesh||this._createSkyboxMesh(t),super.draw(t,this._skyboxMesh)}_createSkyboxMesh(t){const e=new Q({aPosition:new Int8Array(Ue)},null,Ue.length/3);e.generateBuffers(t),this._skyboxMesh=[new Ft(e)],this._meshDefines&&(this._skyboxMesh[0].setDefines(this._meshDefines),delete this._meshDefines)}dispose(){if(this._skyboxMesh){const t=this._skyboxMesh[0];t.geometry.dispose(),t.dispose()}return delete this._skyboxMesh,super.dispose()}}class Ge extends ce{constructor(t,e){const n={blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"},viewport:t};e&&e.extraCommandProps&&u(n,e.extraCommandProps);const r=[];super({vert:"#define SHADER_NAME HEATMAP_DISPLAY\nuniform mat4 projViewModelMatrix;\nattribute vec3 aPosition;\nvoid main() {\n  gl_Position = projViewModelMatrix * vec4(aPosition, 1.);\n}",frag:"#define SHADER_NAME HEATMAP_DISPLAY\nprecision mediump float;\nuniform sampler2D inputTexture;\nuniform sampler2D colorRamp;\nuniform vec2 textureOutputSize;\nuniform float heatmapOpacity;\nvoid main() {\n  vec2 c = gl_FragCoord.xy / textureOutputSize.xy;\n  float t = texture2D(inputTexture, c).r;\n  vec4 d = texture2D(colorRamp, vec2(t, .5));\n  gl_FragColor = d * heatmapOpacity;\n}",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return i["c"].multiply(r,e.projViewMatrix,e.modelMatrix)}}],extraCommandProps:n})}}class qe extends ce{constructor(t={}){super({vert:"precision highp float;\nprecision highp sampler2D;\nconst float c = 3.141592653589793;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nuniform mat4 modelMatrix;\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nvec4 d(mat4 e, mat4 f, vec3 h) {\n  return e * modelMatrix * f * vec4(h, 1.);\n}\nvec3 i(in vec3 h, in vec3 j) {\n  return normalize(h + j);\n}\nmat3 k(in vec3 l) {\n  vec3 t = normalize(cross(vec3(.0, .0, 1.), l));\n  vec3 b = normalize(cross(l, t));\n  return mat3(t, b, l);\n}\nvoid m() {\n  \n}\nvoid main(void) {\n  vuv = aTexCoord;\n  vpos = (modelMatrix * vec4(aPosition, 1.)).xyz;\n  vnormal = aNormal;\n  vtbnMatrix = k(vnormal);\n  gl_Position = d(projMatrix, viewMatrix, vpos);\n  m();\n}",frag:"precision highp float;\nprecision highp sampler2D;\nuniform sampler2D texWaveNormal;\nuniform sampler2D texWavePerturbation;\nuniform vec3 octaveTextureRepeat;\nuniform vec4 waveParams;\nuniform vec2 waveDirection;\nuniform vec4 waterColor;\nuniform vec3 lightingDirection;\nuniform vec3 lightingIntensity;\nuniform vec3 camPos;\nuniform float timeElapsed;\nvarying vec2 vuv;\nvarying vec3 vpos;\nvarying vec3 vnormal;\nvarying mat3 vtbnMatrix;\nconst vec2 c = vec2(6. / 25., 5. / 24.);\nvec2 d(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rg - 1.;\n}\nfloat h(vec2 f) {\n  return texture2D(texWavePerturbation, f).b;\n}\nvec3 i(sampler2D e, vec2 f) {\n  return 2. * texture2D(e, f).rgb - 1.;\n}\nfloat j(vec2 f, float k) {\n  return fract(k);\n}\nfloat l(vec2 f, float k) {\n  float m = j(f, k);\n  return 1. - abs(1. - 2. * m);\n}\nvec3 n(sampler2D o, vec2 f, float k, float u) {\n  float v = waveParams[2];\n  float A = waveParams[3];\n  vec2 B = d(o, f) * v;\n  float m = j(f, k + u);\n  float C = l(f, k + u);\n  vec2 D = f;\n  D -= B * (m + A);\n  D += u;\n  D += (k - m) * c;\n  return vec3(D, C);\n}\nconst float E = .3737;\nconst float F = 7.77;\nvec3 G(sampler2D H, sampler2D I, vec2 f, vec2 J, float k) {\n  float K = waveParams[0];\n  vec2 L = k * -J;\n  float M = h(f * E) * F;\n  vec3 N = n(I, f + L, k + M, .0);\n  vec3 O = n(I, f + L, k + M, .5);\n  vec3 P = i(H, N.xy) * N.z;\n  vec3 Q = i(H, O.xy) * O.z;\n  vec3 R = normalize(P + Q);\n  R.xy *= K;\n  R.z = sqrt(1. - dot(R.xy, R.xy));\n  return R;\n}\nvec3 S(vec2 f, float k) {\n  float T = waveParams[1];\n  return G(texWaveNormal, texWavePerturbation, f * T, waveDirection, k);\n}\nconst float U = 3.141592653589793;\nconst float V = 1. / U;\nconst float W = .3183098861837907;\nconst float X = 1.570796326794897;\nstruct PBRShadingWater {\n  float NdotL;\n  float NdotV;\n  float NdotH;\n  float VdotH;\n  float LdotH;\n  float VdotN;\n};\nfloat Y = 2.2;\nvec3 Z(float ba, vec3 bb, float bc) {\n  return bb + (bc - bb) * pow(1. - ba, 5.);\n}\nfloat bd(float be, float bf) {\n  float bg = bf * bf;\n  float bh = be * be;\n  float bi = pow((bh * (bg - 1.) + 1.), Y) * U;\n  return bg / bi;\n}\nfloat bj(float bk) {\n  return .25 / (bk * bk);\n}\nvec3 bl(in PBRShadingWater bm, float bf, vec3 bn, float bo) {\n  vec3 bp = Z(bm.VdotH, bn, bo);\n  float bq = bd(bm.NdotH, bf);\n  float br = bj(bm.LdotH);\n  return (bq * br) * bp;\n}\nvec3 bs(const vec3 x) {\n  return (x * (2.51 * x + .03)) / (x * (2.43 * x + .59) + .14);\n}\nconst float bt = 2.2;\nconst float bu = .4545454545;\nvec4 bv(vec4 bw) {\n  return vec4(pow(bw.rgb, vec3(bu)), bw.w);\n}\nvec3 bx(vec3 bw) {\n  return pow(bw, vec3(bt));\n}\nconst vec3 by = vec3(.02, 1., 5.);\nconst vec2 bz = vec2(.02, .1);\nconst float bf = .06;\nconst vec3 bA = vec3(0, .6, .9);\nconst vec3 bB = vec3(.72, .92, 1.);\nPBRShadingWater bC;\nvec3 bD(in float bE, in vec3 bF, in vec3 bG) {\n  float bH = pow((1. - bE), by[2]);\n  return mix(bG, bF, bH);\n}\nvec3 bI(in vec3 bJ, in vec3 bK, in vec3 bL, vec3 bw, in vec3 bM, in vec3 bN, in float bO) {\n  vec3 bP = bx(bw);\n  vec3 bQ = normalize(bL + bK);\n  bC.NdotL = clamp(dot(bJ, bL), .0, 1.);\n  bC.NdotV = clamp(dot(bJ, bK), .001, 1.);\n  bC.VdotN = clamp(dot(bK, bJ), .001, 1.);\n  bC.NdotH = clamp(dot(bJ, bQ), .0, 1.);\n  bC.VdotH = clamp(dot(bK, bQ), .0, 1.);\n  bC.LdotH = clamp(dot(bL, bQ), .0, 1.);\n  float bR = max(dot(bN, bK), .0);\n  vec3 bS = bx(bB);\n  vec3 bT = bx(bA);\n  vec3 bB = bD(bR, bS, bT);\n  float bU = max(dot(bN, bL), .0);\n  bB *= .1 + bU * .9;\n  float bV = clamp(bO, .8, 1.);\n  vec3 bW = Z(bC.VdotN, vec3(by[0]), by[1]) * bB * bV;\n  vec3 bX = bP * mix(bB, bU * bM * V, 2. / 3.) * bV;\n  vec3 bY = vec3(.0);\n  if(bR > .0 && bU > .0) {\n    vec3 bZ = bl(bC, bf, vec3(bz[0]), bz[1]);\n    vec3 ca = bM * V * bO;\n    bY = bC.NdotL * ca * bZ;\n  }\n  return bs(bW + bX + bY);\n}\nvoid main() {\n  vec3 bN = vnormal;\n  vec3 cb = S(vuv, timeElapsed);\n  vec3 bJ = normalize(vtbnMatrix * cb);\n  vec3 bK = -normalize(vpos - camPos);\n  vec3 bL = normalize(-lightingDirection);\n  float bO = 1.;\n  vec4 cc = vec4(bI(bJ, bK, bL, waterColor.rgb, lightingIntensity, bN, bO), waterColor.w);\n  gl_FragColor = bv(cc);\n}",defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}class We extends xe{constructor(){super({vert:me,frag:"precision highp float;\nuniform sampler2D texture;\nuniform vec2 size;\nuniform float enableSharpen;\nuniform float sharpFactor;\nuniform float pixelRatio;\nvec2 c;\nvec3 d(const in vec3 e, const float f) {\n  vec2 h = pixelRatio / size.xy;\n  float i = .0;\n  vec4 j = texture2D(texture, c + h * vec2(-1., -1.));\n  j.rgb = mix(vec3(.0), j.rgb, sign(j.a));\n  i += mix(.0, 1., sign(j.a));\n  vec4 k = texture2D(texture, c + h * vec2(1.));\n  k.rgb = mix(vec3(.0), k.rgb, sign(k.a));\n  i += mix(.0, 1., sign(k.a));\n  vec4 l = texture2D(texture, c + h * vec2(1., -1.));\n  l.rgb = mix(vec3(.0), l.rgb, sign(l.a));\n  i += mix(.0, 1., sign(l.a));\n  vec4 m = texture2D(texture, c + h * vec2(-1., 1.));\n  m.rgb = mix(vec3(.0), m.rgb, sign(m.a));\n  i += mix(.0, 1., sign(m.a));\n  return e + f * (i * e - j.rgb - l.rgb - m.rgb - k.rgb);\n}\nvoid main() {\n  c = gl_FragCoord.xy / size;\n  vec4 e = texture2D(texture, c);\n  if(enableSharpen == 1.) {\n    e.rgb = d(e.rgb, sharpFactor);\n  }\n  gl_FragColor = e;\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.size[0],height:(t,e)=>e.size[1]}}})}getMeshCommand(t,e){return this.commands.copy||(this.commands.copy=this.createREGLCommand(t,null,e.getElements())),this.commands.copy}}class Xe extends ce{constructor(t={}){const e=[],n=t.uniforms,r=[{name:"modelViewMatrix",type:"function",fn:function(t,n){return i["c"].multiply(e,n.viewMatrix,n.modelMatrix)}}];n&&r.push(...n),super({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n}",frag:"precision mediump float;\nuniform vec4 lineColor;\nuniform float lineOpacity;\nvoid main() {\n  gl_FragColor = lineColor;\n  gl_FragColor.a *= lineOpacity;\n}",uniforms:r,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}})}}const Qe=[],Ye=[];class Ze extends ce{constructor(t={}){const e=[],n=t.uniforms,r=[{name:"viewMatrixInverse",type:"function",fn:(t,e)=>i["c"].invert(Qe,e.viewMatrix)},{name:"modelViewMatrix",type:"function",fn:function(t,n){return i["c"].multiply(e,n.viewMatrix,n.modelMatrix)}},{name:"uEnvironmentTransform",type:"function",fn:(t,e)=>i["b"].fromRotation(Ye,Math.PI*(e.environmentOrientation||0)/180)}];n&&r.push(...n),super({vert:"precision mediump float;\n#include <gl2_vert>\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\n#ifdef HAS_MAP\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\n#else\nattribute vec4 aColor0;\n#endif\nvarying vec4 vColor;\n#endif\nuniform mat4 projMatrix;\nuniform mat3 modelNormalMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 positionMatrix;\nuniform vec2 halton;\nuniform vec2 outSize;\nuniform mat4 projViewMatrix;\n#include <get_output>\n#include <heatmap_render_vert>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\nvarying vec3 vViewPosition;\nvoid main() {\n  \n#ifdef IS_LINE_EXTRUSION\nvec4 c = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 c = getPosition(aPosition);\n#endif\nmat4 d = getPositionMatrix();\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / outSize.xy;\n#ifdef HAS_MASK_EXTENT\ngl_Position = e * getMaskPosition(d * c, modelMatrix);\n#else\ngl_Position = e * modelViewMatrix * d * c;\n#endif\nvec4 f = modelViewMatrix * d * c;\n  vViewPosition = -f.xyz;\n#ifdef HAS_MAP\nvec2 h = decode_getTexcoord(aTexCoord);\n  vTexCoord = h * uvScale + uvOffset;\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#elif defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvColor = vec4(aColor0 / 255., 1.);\n#else\nvColor = aColor0 / 255.;\n#endif\n#endif\n}",frag:"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\n#define GET_BASEMAP(UV) (texture2D(baseColorTexture, (UV)))\nuniform mat4 viewMatrix;\nuniform mat4 projMatrix;\nuniform vec3 cameraPosition;\n#if defined(HAS_IBL_LIGHTING)\nuniform mat4 viewMatrixInverse;\n#endif\nuniform vec4 baseColorFactor;\nuniform vec3 emissiveFactor;\nuniform vec3 specularFactor;\nuniform float opacity;\nuniform float envRotationSin;\nuniform float envRotationCos;\nuniform float rgbmRange;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\n#ifdef HAS_BASECOLOR_MAP\nuniform sampler2D baseColorTexture;\n#endif\n#ifdef HAS_NORMAL_MAP\nuniform sampler2D normalTexture;\nvec3 c(vec3 d, vec3 e) {\n  vec3 f = dFdx(d.xyz);\n  vec3 h = dFdy(d.xyz);\n  vec3 i = normalize(f - h);\n  vec3 j = normalize(-f + h);\n  vec3 k = normalize(e);\n  vec3 l = texture2D(normalTexture, computeTexCoord(vTexCoord)).rgb * 2. - 1.;\n  mat3 m = mat3(i, j, k);\n  return normalize(m * l);\n}\n#endif\n#ifdef HAS_EMISSIVE_MAP\nuniform sampler2D emissiveTexture;\n#endif\n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\nuniform vec4 diffuseFactor;\n#ifdef HAS_DIFFUSE_MAP\nuniform sampler2D diffuseTexture;\n#endif\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\n#if defined(HAS_COLOR) || defined(HAS_COLOR0)\nvarying vec4 vColor;\n#endif\n#ifdef GAMMA_INPUT\nvec3 n(vec3 o) {\n  return o * o;\n}\nfloat n(float o) {\n  return o * o;\n}\n#else\nvec3 n(vec3 o) {\n  return o;\n}\nfloat n(float o) {\n  return o;\n}\n#endif\nvec3 u() {\n  \n#ifdef SHADING_MODEL_SPECULAR_GLOSSINESS\n#ifdef HAS_SPECULARGLOSSINESS_MAP\nreturn texture2D(specularGlossinessTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn specularFactor;\n#endif\n#else\nreturn specularFactor;\n#endif\n}\nvec3 v() {\n  \n#ifdef HAS_EMISSIVE_MAP\nreturn texture2D(emissiveTexture, computeTexCoord(vTexCoord)).rgb;\n#else\nreturn emissiveFactor;\n#endif\n}\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT > 0\nuniform float exposureBias;\nfloat A(vec3 rgb) {\n  return dot(rgb, vec3(.299, .587, .114));\n}\nfloat B(vec3 rgb) {\n  return dot(rgb, vec3(.212671, .715160, .072169));\n}\nvec3 C(vec3 xyz) {\n  vec3 D = vec3(3.240479, -1.53715, -.498535);\n  vec3 E = vec3(-.969256, 1.875992, .041556);\n  vec3 F = vec3(.055648, -.204043, 1.057311);\n  vec3 rgb;\n  rgb.b = dot(xyz, F);\n  rgb.g = dot(xyz, E);\n  rgb.r = dot(xyz, D);\n  return rgb;\n}\nvec3 H(vec3 rgb) {\n  vec3 I = vec3(.412453, .35758, .180423);\n  vec3 J = vec3(.212671, .71516, .0721688);\n  vec3 K = vec3(.0193338, .119194, .950227);\n  vec3 xyz;\n  xyz.x = dot(rgb, I);\n  xyz.y = dot(rgb, J);\n  xyz.z = dot(rgb, K);\n  return xyz;\n}\nvec3 L(vec3 xyz) {\n  float M = xyz.x + xyz.y + xyz.z;\n  M = 1. / M;\n  vec3 O;\n  O.z = xyz.y;\n  O.x = xyz.x * M;\n  O.y = xyz.y * M;\n  return O;\n}\nvec3 P(vec3 O) {\n  float x = O.x;\n  float y = O.y;\n  float J = O.z;\n  vec3 xyz;\n  xyz.y = J;\n  xyz.x = x * (J / y);\n  xyz.z = (1. - x - y) * (J / y);\n  return xyz;\n}\nfloat Q(float x) {\n  float U = pow(x, 1.60525727);\n  float V = ((1.05542877 * 4.68037409) * U) / (4.68037409 * U + 1.);\n  return clamp(V, .0, 1.);\n}\nconst float W = 1. / .18;\nfloat ba(float x) {\n  x *= W;\n  const float bb = .2;\n  const float F = .34;\n  const float bc = .002;\n  const float bd = 1.68;\n  const float be = .0005;\n  const float bf = .252;\n  const float bg = 1. / .833837;\n  return ((x * (bb * x + bc * F) + bd * be) / (x * (bb * x + F) + bd * bf) - be / bf) * bg;\n}\nvec3 bh(vec3 x) {\n  x *= W;\n  const float bb = .27;\n  const float F = .29;\n  const float bc = .052;\n  const float bd = .2;\n  const float bf = .18;\n  const float bg = 1. / .897105;\n  return ((x * (bb * x + bc * F)) / (x * (bb * x + F) + bd * bf)) * bg;\n}\nvec3 bi(vec3 x) {\n  vec3 bj = x.rgb;\n  bj = min(bj, vec3(3.));\n  float bk = B(bj);\n  if(bk > .0) {\n    float bl = Q(bk);\n    bj = bj * (bl / bk);\n    bj = clamp(bj, vec3(.0), vec3(1.));\n  }\n  float bm = 1. / 2.2;\n  bj = pow(bj, vec3(bm));\n  return bj;\n}\n#endif\n#endif\n#if defined(IRR_RGBM) || defined(ENV_RGBM) || defined(ENV_GAMMA) || defined(IRR_GAMMA)\nuniform float envMapExposure;\n#endif\nuniform vec4 themingColor;\nuniform mat3 uEnvironmentTransform;\nvec3 bn(vec3 bo, vec3 bp) {\n  \n#if defined(HAS_SHADOWMAP)\nfloat bq = dot(shadowLightDir, bp);\n  float br = (bq + 1.) / 2.;\n  br = min(1., br * 1.5);\n  float bs = 1.;\n  vec3 bt = bo * min(bs, br);\n  return bt;\n#else\nreturn bo;\n#endif\n}\n#ifdef HAS_IBL_LIGHTING\nuniform float reflectivity;\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\n#if defined(HAS_IBL_LIGHTING)\nvec3 bu(const in vec3 bv) {\n  vec3 bw = uEnvironmentTransform * bv;\n  float x = bw.x;\n  float y = bw.y;\n  float z = bw.z;\n  vec3 bt = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    bt = hsv_apply(bt, hdrHSV);\n  }\n  return max(bt, vec3(.0));\n}\nvec3 bx(const in vec4 by, const in float bz) {\n  if(bz <= .0)\n    return by.rgb;\n  return bz * by.rgb * by.a;\n}\nfloat bA(const in float bB) {\n  return bB;\n}\nvec3 bC(const in float bD, const in vec3 D) {\n  vec3 bE = D;\n  float bF = prefilterMiplevel.x;\n  float bG = min(bF, bA(bD) * prefilterMiplevel.y);\n  vec3 bH = bx(textureCubeLod(prefilterMap, bE, bG), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(bH, hdrHSV);\n  } else {\n    return bH;\n  }\n}\nvec3 bI(const in vec3 k, const in vec3 D, const in float bJ) {\n  float bK = 1. - bJ;\n  float bL = bK * (sqrt(bK) + bJ);\n  return mix(k, D, bL);\n}\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  vec3 D = reflect(-bN, bv);\n  D = bI(bv, D, bO);\n  vec3 bQ = bC(bO, uEnvironmentTransform * D);\n  float bR = clamp(1. + dot(D, bP), .0, 1.);\n  bQ *= bR * bR;\n  return bQ;\n}\n#else\nvec3 bM(const in vec3 bv, const in vec3 bN, const in float bO, const in vec3 bP) {\n  return ambientColor;\n}\n#endif\nvarying highp vec3 vViewPosition;\nvec3 bS(vec3 bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nfloat bW(float bT, float bU) {\n  float bV = max(1. - bU, .0);\n  return bT + (1. - bT) * pow(bV, 5.);\n}\nvec3 bX(const in vec3 by) {\n  return vec3(by.r < .0031308 ? by.r * 12.92 : 1.055 * pow(by.r, 1. / 2.4) - .055, by.g < .0031308 ? by.g * 12.92 : 1.055 * pow(by.g, 1. / 2.4) - .055, by.b < .0031308 ? by.b * 12.92 : 1.055 * pow(by.b, 1. / 2.4) - .055);\n}\nvoid main() {\n  glFragColor = vec4(vec3(1.), opacity);\n#ifdef HAS_BASECOLOR_MAP\nvec4 bY = GET_BASEMAP(computeTexCoord(vTexCoord));\n#ifdef GAMMA_INPUT\nbY.xyz *= bY.xyz;\n#endif\nglFragColor = glFragColor * bY;\n#endif\n#ifdef ALPHATEST\nif(glFragColor.a < ALPHATEST)\n    discard;\n  \n#endif\nfloat bZ = 1.;\n  vec3 ca = dFdx(vViewPosition);\n  vec3 cb = dFdy(vViewPosition);\n  vec3 bv = normalize(cross(ca, cb));\n  vec3 cc;\n  if(projMatrix[3][3] == .0) {\n    cc = normalize(vViewPosition);\n  } else {\n    cc = vec3(.0, .0, 1.);\n  }\n  bv = faceforward(bv, -cc, bv);\n  vec3 cd = bv;\n#ifdef HAS_NORMAL_MAP\nbv = c(-vViewPosition, bv);\n#endif\nvec3 ce = vec3(.0);\n  vec3 cf = vec3(.0);\n#ifdef HAS_IBL_LIGHTING\nvec3 bp = mat3(viewMatrixInverse) * bv;\n  vec3 cg = glFragColor.rgb * bu(bp) * .5;\n  cg = bn(cg, bp);\n  ce += n(baseColorFactor.rgb) * cg;\n#endif\nvec3 ch = v();\n#ifdef METAL\nglFragColor.xyz = glFragColor.xyz * (n(ch) + ce + n(baseColorFactor.rgb) + cf);\n#else\nglFragColor.xyz = glFragColor.xyz * (n(ch) + ce + n(baseColorFactor.rgb)) + cf;\n#endif\nvec3 ci;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat cj = shadow_computeShadow();\n  ci = shadow_blend(ci, cj).rgb;\n#endif\n#ifdef HAS_COLOR\nglFragColor = glFragColor * vColor;\n#endif\nglFragColor.rgb += ci;\n  glFragColor.rgb = bX(glFragColor.rgb);\n#if defined(HAS_IBL_LIGHTING)\nvec3 ck;\n#if defined(HAS_NORMAL_MAP)\n#ifdef ENVMAP_MODE_REFLECTION\nck = reflect(-cc, bv);\n#else\nck = refract(-cc, bv, 1.);\n#endif\n#else\nck = reflect(-cc, bv);\n#endif\nck = mat3(viewMatrixInverse) * ck;\n  float cl = 1.;\n  vec3 cm;\n#ifdef HAS_IBL_LIGHTING\ncm = vec3(.0);\n#elif\ncm = ambientColor;\n#endif\ncm *= cl;\n  float bV = dot(cc, bv);\n  if(bV < -1e-2 || reflectivity == .0)\n    bV = 1.;\n  else\n    bV = max(1e-6, bV);\n  vec3 cn;\n  vec3 co = u();\n#ifdef METAL\ncn = n(co);\n#else\ncn = bS(n(co), bV) * (1. - envRotationSin);\n  glFragColor.a = mix(glFragColor.a, bW(glFragColor.a, bV), reflectivity) * envRotationCos;\n  float cp = pow(1. - bV * .5, 5.);\n  float cq = (28. / 23.) * (1. - cp) * (1. - cp);\n  glFragColor.rgb *= cq * (1. - n(co));\n#endif\nglFragColor.rgb += cm.rgb * bZ * cn.rgb;\n#endif\n#if defined(TONEMAP_OUTPUT)\n#if TONEMAP_OUTPUT == 1\nglFragColor.rgb = bi(exposureBias * glFragColor.rgb);\n#elif TONEMAP_OUTPUT == 2\nglFragColor.rgb = bh(exposureBias * glFragColor.rgb);\n#endif\n#endif\nglFragColor.rgb = mix(glFragColor.rgb, themingColor.rgb, themingColor.a);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:r,defines:t.defines||{},extraCommandProps:t.extraCommandProps||{}}),this.version=300}}const Ke=[];class Je{constructor(t,e,n){this._regl=t,this._layer=n,this._viewport=e,this._init()}_init(){this._shader=new ce({vert:"attribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec4 vWorldPosition;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  vec4 e = modelMatrix * d * c;\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vWorldPosition = e;\n}",frag:"precision mediump float;\nvarying vec4 vWorldPosition;\nuniform vec2 fogDist;\nuniform vec3 cameraPosition;\nuniform float rainDepth;\nvoid main() {\n  vec3 c = vec3(vWorldPosition[0] - cameraPosition[0], vWorldPosition[1] - cameraPosition[1], vWorldPosition[2] - cameraPosition[2]);\n  float d = length(c);\n  float e = clamp(1. - (d - fogDist.x) / (fogDist.y - fogDist.x), .0, 1.);\n  if(vWorldPosition[2] < rainDepth) {\n    gl_FragColor = vec4(e, .0, .0, 1.);\n  } else {\n    gl_FragColor = vec4(e, 1., .0, 1.);\n  }\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return i["c"].multiply(Ke,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}});const t=this._layer.getRenderer().createFBOInfo();this._fbo=this._regl.framebuffer(t),this._scene=new Vt,this.renderer=new F(this._regl)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._scene.setMeshes(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition,fogDist:e.fogDist,rainDepth:e.rainDepth},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=h(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=h(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}}class $e extends xe{constructor(){super({vert:me,frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_RAIN\nuniform sampler2D ripplesMap;\n#endif\n#ifdef HAS_SNOW\nuniform sampler2D normalMap;\n#endif\n#ifdef HAS_FOG\nuniform vec3 fogColor;\n#endif\nuniform sampler2D sceneMap;\nuniform sampler2D mixFactorMap;\nuniform float time;\nuniform vec2 resolution;\nuniform float snowIntensity;\nfloat c(float a, float b, float w) {\n  return a + w * (b - a);\n}\n#define HASHSCALE1 .1031\n#define HASHSCALE3 vec3(.1031, .1030, .0973)\n#define HASHSCALE4 vec3(.1031, .1030, .0973, .1099)\nfloat d = .5;\nfloat e = .2;\nfloat f = .5;\nfloat h = 20.;\nfloat i(float p) {\n  vec3 j = fract(vec3(p) * HASHSCALE1);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.x + j.y) * j.z);\n}\nvec2 k(vec2 p) {\n  vec3 j = fract(vec3(p.xyx) * HASHSCALE3);\n  j += dot(j, j.yzx + 19.19);\n  return fract((j.xx + j.yz) * j.zy);\n}\nvec2 l(vec2 m) {\n  float x = fract(sin(dot(m.xy, vec2(122.9898, 783.233))) * 43758.5453);\n  float y = fract(sin(dot(m.xy, vec2(457.6537, 537.2793))) * 37573.5913);\n  return vec2(x, y);\n}\nvec3 n(vec2 o, float u) {\n  vec3 v = vec3(.0);\n  o = o * (2. + u);\n  float A = e * snowIntensity;\n  float B = o.y * (((i(u) * 2. - 1.) * .5 + 1.) * A);\n  float C = (f * time);\n  o += vec2(B, C);\n  vec2 D = k(floor(o) + 31.1759 * u);\n  o = fract(o);\n  o -= (D * 2. - 1.) * .35;\n  o -= .5;\n  float r = length(o);\n  float E = .05 * (1. + .3 * sin(time * d));\n  float F = smoothstep(E, -E, r);\n  vec3 G = vec3(F) * D.x;\n  return G;\n}\nvec3 H() {\n  vec3 v = vec3(0);\n  vec2 o = gl_FragCoord.xy / resolution.xy;\n  o *= vec2(resolution.x / resolution.y, 1.);\n  float I = h * snowIntensity;\n  for(float J = 0.; J < I; J++) {\n    v += n(o, J);\n  }\n  return v;\n}\nvec3 K(vec4 L, vec4 M, float N) {\n  float O = M.b;\n  vec3 P = vec3(1.);\n  if(N < 1.) {\n    float r = c(.5, P.x, O);\n    float g = c(.5, P.y, O);\n    float b = c(.5, P.z, O);\n    return vec3(r, g, b);\n  } else {\n    float r = c(L.r, P.x, O);\n    float g = c(L.g, P.y, O);\n    float b = c(L.b, P.z, O);\n    return vec3(r, g, b);\n  }\n}\nvoid main() {\n  vec4 L = texture2D(sceneMap, vTexCoord);\n  glFragColor = L;\n  vec4 Q = texture2D(mixFactorMap, vTexCoord);\n#ifdef HAS_RAIN\nvec4 R = texture2D(ripplesMap, vTexCoord);\n  if(Q.g < 1.) {\n    L = mix(L, R, .4);\n  }\n  glFragColor = L;\n#endif\n#ifdef HAS_SNOW\nvec3 S = H();\n  glFragColor = vec4(L.rgb + S, L.a);\n#endif\n#ifdef HAS_FOG\nfloat T = Q.r;\n  vec3 U = mix(fogColor, glFragColor.rgb, T);\n  glFragColor = vec4(U, L.a);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",extraCommandProps:{viewport:{x:0,y:0,width:(t,e)=>e.resolution[0],height:(t,e)=>e.resolution[1]}}})}}const tn=[],en=[.03,.03,.03],nn=[],rn=[],sn=[],on=i["c"].fromRotationTranslation([],i["d"].fromEuler([],90,0,0),[0,0,0]);class an{constructor(t,e){this._regl=t,this._viewport=e,this._init()}_init(){this._shader=new ce({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nvarying vec2 vTexCoord;\n#include <get_output>\nvoid main() {\n  vec4 c = getPosition(aPosition);\n  mat4 d = getPositionMatrix();\n  gl_Position = projMatrix * modelViewMatrix * d * c;\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives : enable\n#endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\nuniform float rippleRadius;\nuniform float density;\nuniform float time;\nvec3 c(vec2 p) {\n  vec3 q = vec3(dot(p, vec2(127.1, 311.7)), dot(p, vec2(269.5, 183.3)), dot(p, vec2(419.2, 371.9)));\n  return fract(sin(q) * 43758.5453);\n}\nfloat d(in vec2 x) {\n  vec2 e = x * density / 4000.0;\n  vec2 p = floor(e);\n  vec2 f = fract(e);\n  float h = .0;\n  for(int i = -4; i <= 4; i++)\n    for(int k = -4; k <= 4; k++) {\n      vec2 g = vec2(float(k), float(i));\n      vec3 l = c(p + g);\n      vec2 r = g - f + l.xy;\n      float m = sqrt(dot(r, r));\n      float n = max(mix(smoothstep(.99, .999, max(cos(m - time * 2. + (l.x + l.y) * 5.), 0.)), 0., m), 0.);\n      h += n;\n    }\n  return h;\n}\nvoid main() {\n  vec2 u = vTexCoord;\n  float A = 24. / (rippleRadius * .01);\n  float f = d(A * u) * smoothstep(.0, .4, sin(u.x * 3.151592) * sin(u.y * 3.141592));\n  vec3 B = vec3(-dFdx(f), -dFdy(f), -dFdy(f));\n  glFragColor = vec4(B, 1.);\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return i["c"].multiply(tn,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:this._viewport}}),this._shader.version=300,this._fbo=this._regl.framebuffer({color:this._regl.texture({width:this._viewport.width(),height:this._viewport.height(),wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._scene=new Vt,this.renderer=new F(this._regl)}_transformRipples(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this._fixZoom),r=i["f"].set(rn,n,n,n),s=i["f"].multiply(r,en,r),o=i["c"].identity(sn);i["c"].fromRotationTranslationScale(o,i["d"].fromEuler(nn,0,0,0),[e.x,e.y,0],s),i["c"].multiply(o,o,on),this._mesh.setLocalTransform(o)}_createRipplesMask(t){this._fixZoom=t.getZoom();const e=800*Math.pow(2,16.685648411389433-this._fixZoom),n={};n.POSITION=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],n.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],n.TEXCOORD_0=[0,0,1,0,0,1,1,1];const r=new Q(n,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});r.generateBuffers(this._regl);const i=new wt;return new Ft(r,i)}render(t,e){return this._resize(),this.renderer.clear({color:[0,0,0,1],depth:1,framebuffer:this._fbo}),this._mesh=this._mesh||this._createRipplesMask(t),this._scene.setMeshes(this._mesh),this._transformRipples(t),this.renderer.render(this._shader,{projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,time:e.time,rippleRadius:e.rippleRadius,density:e.density},this._scene,this._fbo),this._fbo}dispose(){this._fbo&&this._fbo.destroy(),this._shader&&this._shader.dispose()}_resize(){const t=h(this._viewport.width.data)?this._viewport.width.data():this._viewport.width,e=h(this._viewport.height.data)?this._viewport.height.data():this._viewport.height;!this._fbo||this._fbo.width===t&&this._fbo.height===e||this._fbo.resize(t,e)}}var ln="attribute vec3 aPosition;\nuniform mat4 positionMatrix;\nuniform mat4 projViewModelMatrix;\n#ifdef HAS_VIDEO\nattribute vec2 aTexCoord;\nvarying vec2 uv;\n#endif\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n  vec4 d = c * getPosition(aPosition);\n  gl_Position = projViewModelMatrix * d;\n#ifdef HAS_VIDEO\nuv = aTexCoord;\n#endif\n}";const hn=[0,0,0,1];class cn{constructor(t,e){this.regl=t,this._viewport=e,this.renderer=new F(t),this._init()}_init(){this._maskColorFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this._maskModeFbo=this.renderer.regl.framebuffer({color:this.renderer.regl.texture({width:1,height:1,wrap:"clamp",mag:"nearest",min:"nearest"}),depth:!0});const t=[{name:"projViewModelMatrix",type:"function",fn:(t,e)=>i["c"].multiply([],e.projViewMatrix,e.modelMatrix)}];this._maskColorShader=new ce({vert:ln,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec4 maskColor;\n#ifdef HAS_VIDEO\nuniform sampler2D maskTexture;\nvarying vec2 uv;\n#endif\nvoid main() {\n  \n#ifdef HAS_VIDEO\ngl_FragColor = texture2D(maskTexture, uv);\n  gl_FragColor.a = maskColor.a;\n#else\ngl_FragColor = maskColor;\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._maskModeShader=new ce({vert:ln,frag:"#ifdef GL_ES\nprecision highp float;\n#endif\nuniform float maskMode;\n#ifdef HAS_MASK_FLAT\nuniform float flatHeight;\n#endif\n#ifdef HAS_MASK_COLOR\nuniform vec2 heightRange;\n#endif\nvoid main() {\n  \n#if defined(HAS_MASK_FLAT)\ngl_FragColor = vec4(maskMode, flatHeight, .0, 1.);\n#elif defined(HAS_MASK_COLOR)\ngl_FragColor = vec4(maskMode, .0, heightRange.x, heightRange.y);\n#else\ngl_FragColor = vec4(maskMode, .0, .0, .0);\n#endif\n}",uniforms:t,extraCommandProps:{viewport:this._viewport}}),this._scene=new Vt}render(t,e){this._resize(),this.renderer.clear({color:hn,depth:1,framebuffer:this._maskColorFbo}),this.renderer.clear({color:hn,depth:1,framebuffer:this._maskModeFbo}),this._scene.setMeshes(t);const n={projViewMatrix:e};return this.renderer.render(this._maskColorShader,n,this._scene,this._maskColorFbo),this.renderer.render(this._maskModeShader,n,this._scene,this._maskModeFbo),{colorExtent:this._maskColorFbo,modeExtent:this._maskModeFbo}}_resize(){const t=h(this._viewport.width)?this._viewport.width():this._viewport.width.data(),e=h(this._viewport.height)?this._viewport.height():this._viewport.height.data();!this._maskColorFbo||this._maskColorFbo.width===t&&this._maskColorFbo.height===e||(this._maskColorFbo.resize(t,e),this._maskModeFbo.resize(t,e))}dispose(){this._maskColorFbo&&(this._maskColorFbo.destroy(),delete this._maskColorFbo),this._maskModeFbo&&(this._maskModeFbo.destroy(),delete this._maskModeFbo),this._maskColorShader&&(this._maskColorShader.dispose(),delete this._maskColorShader),this._maskModeShader&&(this._maskModeShader.dispose(),delete this._maskModeShader)}}const un=[],fn={width:4,type:"float"};class dn{constructor(t,e,n){this._regl=t,this.joints=e,this.inverseBindMatrices=[],this.jointMatrices=[],this.jointData=new Float32Array(16*e.length);for(let r=0;r<e.length;++r)this.inverseBindMatrices.push(new Float32Array(n.buffer,n.byteOffset+16*Float32Array.BYTES_PER_ELEMENT*r,16)),this.jointMatrices.push(new Float32Array(this.jointData.buffer,16*Float32Array.BYTES_PER_ELEMENT*r,16));this.jointTextureSize=[4,6]}update(t,e,n){i["c"].invert(un,t);for(let s=0;s<this.joints.length;++s){const t=this.jointMatrices[s];i["c"].multiply(t,un,e[this.joints[s].nodeIndex]),i["c"].multiply(t,t,this.inverseBindMatrices[s])}fn.height=this.joints.length,fn.data=this.jointData;const r=fn;return n?n(r):n=this._regl.texture(r),n}}const pn=[0,0,0],An=[0,0,0,1],gn=[1,1,1],mn=[];class yn{constructor(t=[0,0,0],e=[0,0,0,1],n=[1,1,1]){this.translation=t,this.rotation=e,this.scale=n}getMatrix(){return i["c"].fromRotationTranslationScale(mn,this.rotation,this.translation,this.scale)}decompose(t){i["c"].getTranslation(this.translation,t),i["c"].getRotation(this.rotation,t),i["c"].getScaling(this.scale,t)}update(t){t&&(t.translation&&!i["f"].equals(t.translation,pn)&&i["f"].copy(this.translation,t.translation),t.rotation&&!i["d"].equals(t.rotation,An)&&i["d"].copy(this.rotation,t.rotation),t.scale&&!i["f"].equals(t.scale,gn)&&i["f"].copy(this.scale,t.scale))}}class vn{constructor(t){this._init(t)}_init(t){this.bbox=t.bbox,this.geometry=t.geometry,this.nodeMatrix=t.nodeMatrix,this.materialInfo=t.materialInfo,this.extraInfo=t.extraInfo,this.animationMatrix=t.animationMatrix,this.morphWeights=t.morphWeights,this.skin=t.skin,this.nodeIndex=t.nodeIndex}copyEdgeGeometry(){this.copyGeometry||(this.copyGeometry=this._copyEdgeGeometry(this.geometry))}createCopyBarycentric(){this.copyGeometry&&!this.copyGeometry.data.aBarycentric&&(this.copyGeometry.buildUniqueVertex(),this.copyGeometry.createBarycentric("aBarycentric"))}_copyEdgeGeometry(t){const e=t.data,n=t.indices||t.elements,r={};for(const a in e)if(a===t.desc.positionAttribute)if(A(e[a]))r[a]=e[a].slice();else if(e[a].buffer&&e[a].buffer.destroy)r[a]={buffer:e[a].buffer},A(e[a].array)&&(r[a].array=e[a].array.slice());else{const e=t._getAttributeData(a);r[a]=a!==t.desc.positionAttribute?e:e.slice()}const i=void 0!==n.length?n.slice():n,s=JSON.parse(JSON.stringify(t.desc)),o=new xt(r,i,0,s);return o.properties=t.properties,o}}let xn=0;const bn=[];class wn{constructor(t,e){this.gltf=t,this.regl=e,this.geometries=[],e&&(this._emptyTexture=e.texture({width:2,height:2}))}getMeshesInfo(){return this.gltf?(this.geometries.length||(this._createTextures(this.gltf.textures),this._createSkins(this.gltf.skins),this.gltf.scenes[0].nodes.forEach(t=>{this._parserNode(t,this.geometries)}),this._checkBaseColorFactor()),this.geometries):null}getGLTFBBox(){if(!this.gltf)return null;const t=this.geometries;if(!t||!t.length)return null;const e=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0];for(let r=0;r<t.length;r++){const i=t[r].bbox,s=i.min,o=i.max;s[0]<e[0]&&(e[0]=s[0]),s[1]<e[1]&&(e[1]=s[1]),s[2]<e[2]&&(e[2]=s[2]),o[0]>n[0]&&(n[0]=o[0]),o[1]>n[1]&&(n[1]=o[1]),o[2]>n[2]&&(n[2]=o[2])}return{min:e,max:n}}_createSkins(t){if(t){this._skinMap={};for(let e=0;e<t.length;e++){const n=t[e];n.joints=n.joints.map(t=>this.gltf.nodes[t]),this._skinMap[e]=new dn(this.regl,n.joints,n.inverseBindMatrices.array),delete n.inverseBindMatrices}}}_createTextures(t){if(t){this._textureMap={};for(let e=0;e<t.length;e++){const n=t[e];this._textureMap[e]||(this._textureMap[e]=this._toTexture(n),delete n.image)}}}_checkBaseColorFactor(){if(!this._checkBaseColorFactorAlpha())for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;e&&0===e[3]&&(e[3]=1)}}_checkBaseColorFactorAlpha(){for(let t=0;t<this.geometries.length;t++){const e=this.geometries[t].materialInfo.baseColorFactor;if(e&&e[3]>0)return!0}return!1}dispose(){this._emptyTexture&&this._emptyTexture.destroy();const t=this.getMeshesInfo();if(t){t.forEach(t=>{t.geometry.dispose();for(const e in t.materialInfo){const n=t.materialInfo[e];n.destroy&&!n[k]&&n.destroy()}});for(const t in this._textureMap){const e=this._textureMap[t];e.destroy&&!e[k]&&e.destroy()}delete this.gltf}}updateAnimation(t,e,n,i,s,o,a,l){const h=this.gltf;if(!h)return;if(xn=h.animations?r["b"].getAnimationTimeSpan(h,i):null,!xn)return;t-=s;let c=0;c=e||!e&&this._isFirstLoop(t,n,i,s)?t*n*.001%(xn.max-xn.min)+xn.min:t*n*.001+xn.min,h.scenes[0].nodes.forEach(t=>{this._updateNodeMatrix(i,c,t,null,o,l)});for(const r in this.gltf.nodes){const t=this.gltf.nodes[r],e=o[t.nodeIndex];if(t.skin&&e){const n=t.skin.update(e,o,a[t.nodeIndex]&&a[t.nodeIndex].jointTexture);a[t.nodeIndex]||(a[t.nodeIndex]={jointTextureSize:t.skin.jointTextureSize,numJoints:t.skin.joints.length}),a[t.nodeIndex].jointTexture=n}}}_isFirstLoop(t,e,n,i){const s=this.gltf;return!i||!s||(xn=s.animations?r["b"].getAnimationTimeSpan(s,n):null,t*e*.001/(xn.max-xn.min)<1)}hasSkinAnimation(){return!!this._isAnimation}_updateNodeMatrix(t,e,n,r,s,o){n.trs&&(o?o.indexOf(Number(n.nodeIndex))>-1&&this._updateNodeTRS(n,e,t):this._updateNodeTRS(n,e,t)),s[n.nodeIndex]=r?i["c"].multiply(s[n.nodeIndex]||[],r,n.matrix||n.trs.getMatrix()):i["c"].copy(s[n.nodeIndex]||[],n.matrix||n.trs.getMatrix()),n.children&&n.children.forEach(r=>{this._updateNodeMatrix(t,e,r,s[n.nodeIndex],s,o)})}_updateNodeTRS(t,e,n){const i=r["b"].getAnimationClip(this.gltf,Number(t.nodeIndex),e,n);i.weights&&this._updateMorph(t,i.weights),t.trs.update(i)}_updateMorph(t,e){const n=e.length;if(!t.influencesList){t.influencesList=[];for(let e=0;e<n;e++)t.influencesList[e]=[e,0]}const r=t.influencesList;for(let s=0;s<r.length;s++){const t=r[s];t[0]=s,t[1]=e[s]}r.sort(Mn);const i=[];for(let s=0;s<8;s++)i[s]=[s,0];for(let s=0;s<8;s++)s<n&&r[s][1]?(i[s][0]=r[s][0],i[s][1]=r[s][1]):(i[s][0]=Number.MAX_SAFE_INTEGER,i[s][1]=0);i.sort(_n),t.geometries.forEach(t=>{const e=t.properties.morphTargets;for(let n=0;n<8;n++){const r=i[n],s=r[0],o=r[1];s!==Number.MAX_SAFE_INTEGER&&o?(t.updateData("POSITION"+n,e["POSITION_"+s].array),t.properties.morphWeights[n]=o):t.properties.morphWeights[n]=0}})}_parserNode(t,e,n){if(t.isParsed)return;t.nodeMatrix=t.nodeMatrix||i["c"].identity([]),t.localMatrix=t.localMatrix||i["c"].identity([]),t.matrix?(t.trs=new yn,t.trs.decompose(t.matrix)):t.trs=new yn(t.translation,t.rotation,t.scale),t.localMatrix=t.trs.getMatrix(),n?i["c"].multiply(t.nodeMatrix,n,t.matrix||t.localMatrix):i["c"].copy(t.nodeMatrix,t.matrix||t.localMatrix);const r=t.nodeMatrix;if(t.children)for(let i=0;i<t.children.length;i++)this._parserNode(t.children[i],e,r);if(l(t.skin)){this._isAnimation=!0;const e=t.skin;t.trs=new yn,t.skin=this._skinMap[e]}l(t.mesh)&&(t.mesh=this.gltf.meshes[t.mesh],t.mesh.node=t,t.geometries=t.geometries||[],t.mesh.primitives.forEach(n=>{const s=this._createMaterialInfo(n.material),o=function(t,e,n){const r=t.attributes,i=r.COLOR_0;if(i&&i.array instanceof Float32Array){const t=new Uint8Array(i.array.length);for(let e=0;e<t.length;e++)t[e]=Math.round(255*i.array[e]);i.array=t}else if(i&&(i.array instanceof Uint16Array||i.array instanceof Int16Array||i.array instanceof Uint32Array||i.array instanceof Int32Array)){const t=new Uint8Array(i.array);i.array=t}n&&r.TEXCOORD_0&&!r.TEXCOORD_0&&(r.TEXCOORD_1=r.TEXCOORD_0);const s={};for(const l in r)s[l]=u({},r[l]),e&&(s[l].buffer=ct(e,r[l],{dimension:r[l].itemSize}));if(t.morphTargets){const t=T(s.POSITION)?s.POSITION.itemSize*s.POSITION.count:s.POSITION.array.length;for(let e=0;e<8;e++)s["POSITION"+e]||(s["POSITION"+e]=new Float32Array(t).fill(0));for(let e=0;e<4;e++){const t=s.NORMAL.array?s.NORMAL.array.length:s.NORMAL.length;s["NORMAL"+e]||(s["NORMAL"+e]=new Float32Array(t).fill(0))}}let o=t.indices;o&&void 0===o.bufferView&&o.array&&(o=o.array);const a=new Q(s,o,0,{primitive:d(t.mode)?K(t.mode):t.mode,positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",color0Attribute:"COLOR_0"});return t.morphTargets&&(a.properties.morphWeights=[]),t.mode>3&&!a.data.NORMAL&&a.createNormal("NORMAL"),a}(n,this.regl,s.occlusionTexture);o.properties.morphTargets=n.morphTargets,t.geometries.push(o);let a=o.boundingBox.copy();a=a.transform(i["c"].identity(bn),r);const l={geometry:o,bbox:a,nodeMatrix:r,materialInfo:s,extraInfo:this._createExtralInfo(n.material),animationMatrix:t.trs.getMatrix(),morphWeights:t.weights,nodeIndex:t.nodeIndex};t.skin&&(l.skin={jointTextureSize:[4,6],numJoints:t.skin.joints.length,jointTexture:t.skin.jointTexture});const h=new vn(l);e.push(h)})),t.isParsed=!0}_createMaterialInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t],r=n.pbrMetallicRoughness;if(r){const t=r.metallicRoughnessTexture,n=r.baseColorTexture;n&&(e.baseColorTexture=this._getTexture(n),n.KHR_texture_transform&&(e.khr_offset=n.KHR_texture_transform.offset||[0,0],e.khr_rotation=n.KHR_texture_transform.rotation||0,e.khr_scale=n.KHR_texture_transform.scale||[1,1])),r.baseColorFactor&&(e.baseColorFactor=r.baseColorFactor),t?e.metallicRoughnessTexture=this._getTexture(t):(e.metallicFactor=l(r.metallicFactor)?r.metallicFactor:1,e.roughnessFactor=l(r.roughnessFactor)?r.roughnessFactor:1)}const i=n.extensions;if(i&&i.KHR_materials_pbrSpecularGlossiness){const t=i.KHR_materials_pbrSpecularGlossiness;e.name="pbrSpecularGlossiness";for(const n in t)e[n]=l(t[n].index)?this._getTexture(t[n]):t[n]}n.normalTexture&&(e.normalTexture=this._getTexture(n.normalTexture)),n.occlusionTexture&&(e.occlusionTexture=this._getTexture(n.occlusionTexture)),n.emissiveTexture&&(e.emissiveTexture=this._getTexture(n.emissiveTexture)),n.emissiveFactor&&(e.emissiveFactor=n.emissiveFactor),e.alphaCutoff=n.alphaCutoff||.5}return e}_createExtralInfo(t){const e={};if(this.gltf.materials&&this.gltf.materials[t]){const n=this.gltf.materials[t];e.doubleSided=n.doubleSided,e.alphaMode=n.alphaMode||"OPAQUE"}return e}_getTexture(t){const e=t.extensions,n=t.index;if(!l(n))return null;e&&e.KHR_texture_transform&&(t.KHR_texture_transform=e.KHR_texture_transform);const r=this._textureMap[n];return r.texInfo=t,r}_toTexture(t){if(!t)return this._emptyTexture;const e=t.sampler||{};return new Zt({width:t.image.width,height:t.image.height,data:t.image.array,mag:rt(e.magFilter)||"linear",min:st(e.minFilter)||"linear",wrapS:at(e.wrapS)||"repeat",wrapT:at(e.wrapT)||"repeat"})}}function _n(t,e){return t[0]-e[0]}function Mn(t,e){return Math.abs(e[1])-Math.abs(t[1])}function Tn(t,e){const{fetchOptions:n,gltfLoaderOptions:i,urlModifier:s}=e,o=i||{};o.urlModifier=s;const a=t.lastIndexOf("/"),l=t.slice(0,a),h=t.slice(t.lastIndexOf(".")).toLowerCase();return".gltf"===h?r["a"].getJSON(t,n,s).then(t=>In(l,t,o)):".glb"===h?r["a"].getArrayBuffer(t,n,s).then(t=>In(l,{buffer:t.data,byteOffset:0},o)):null}function Sn(t,e){return new wn(t,e)}function In(t,e,n){return new r["b"](t,e,n).load()}var Cn=Object.freeze({__proto__:null,load:Tn,exportGLTFPack:Sn,loadGLTF:In});const On=[-1,0,-1,1,0,-1,-1,0,1,1,0,1],En=[0,1,0,0,1,0,0,1,0,0,1,0],Pn=[3,1,0,0,2,3],kn=[0,0,1,0,0,1,1,1],Rn={vertices:[-.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,.010300000198185444,-0,.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,.010300000198185444,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,-.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,-.8111000061035156,-.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0,-.8111000061035156,2.0102999210357666,.8111000061035156,.8111000061035156,2.0102999210357666,.8111000061035156,0,2.9419000148773193,-0],normals:[-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,-.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,0,-.3758002817630768,.9267006516456604,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,.9267006516456604,-.3758002817630768,-0,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,-.3758002817630768,-.9267006516456604,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,0,.656676173210144,-.7541726231575012,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,-.7541726231575012,.656676173210144,-0,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012,0,.656676173210144,.7541726231575012],indices:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]},Nn=["cube","plane","pyramid"],Dn={cube:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1])},NORMAL:{array:new Int8Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1])},TEXCOORD_0:{array:new Int8Array([0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1,0,0,1,0,0,1,1,1])}},indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},"plane-cube":{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(On)},TEXCOORD_0:{array:new Int8Array(kn)}},indices:new Uint16Array(Pn),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60],translation:[0,-60,0]},{mesh:0,scale:[60,60,60],translation:[0,60,0]},{mesh:0,scale:[60,60,60],translation:[60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[-60,0,0],rotation:[0,0,.7071067811865475,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,60],rotation:[.7071067811865475,0,0,.7071067811865476]},{mesh:0,scale:[60,60,60],translation:[0,0,-60],rotation:[.7071067811865475,0,0,.7071067811865476]}]}]},plane:{meshes:[{primitives:[{attributes:{POSITION:{array:new Int8Array(On)},NORMAL:{array:new Int8Array(En)},TEXCOORD_0:{array:new Int8Array(kn)}},indices:new Uint16Array(Pn),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]},pyramid:{meshes:[{primitives:[{attributes:{POSITION:{array:new Float32Array(Rn.vertices)},NORMAL:{array:new Float32Array(Rn.normals)},TEXCOORD_0:{array:new Float32Array(Rn.uv)}},indices:new Uint16Array(Rn.indices),mode:4}]}],scenes:[{nodes:[{mesh:0,scale:[60,60,60]}]}]}};class Fn{constructor(t,e){this.regl=t,this.resourceMap={},this.options=e||{}}getGLTF(t){return this.resourceMap[t]}loginGLTF(t,e){if(this.resourceMap[t])this.resourceMap[t].refCount+=1;else{if(Dn[t]){const e=function(t){let e=null;return Dn[t]&&(e={meshes:Dn[t].meshes},e.scenes=JSON.parse(JSON.stringify(Dn[t].scenes))),e}(t);this.resourceMap[t]=this._exportGLTFResource(e,t,!1)}else this.resourceMap[t]=e?e(t).then(e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t])):this._loadGLTFModel(t);this.resourceMap[t].refCount=1}}logoutGLTF(t){if(this.resourceMap[t]&&(this.resourceMap[t].refCount-=1,this.resourceMap[t].refCount<1)){const e=this.resourceMap[t].resources;if(e)for(let t=0;t<e.length;t++)e[t].geometry.dispose(),e[t].copyGeometry&&e[t].copyGeometry.dispose(),e[t].material&&e[t].material.dispose();this.resourceMap[t].gltfPack&&this.resourceMap[t].gltfPack.dispose(),delete this.resourceMap[t]}}isSimpleModel(t){return Dn[t]}addSimpleModel(t,e){!function(t,e){"string"==typeof t&&Nn.indexOf(t)<0&&(Dn[t]=e)}(t,e)}removeSimpleModel(t){delete Dn[t]}_exportGLTFResource(t,e,n=!0){if(!t)return null;const r=Sn(t,n?this.regl:null),i=r.getMeshesInfo();return{bbox:r.getGLTFBBox(),gltfPack:r,resources:i,json:t.json,refCount:this.resourceMap[e]?this.resourceMap[e].refCount:0}}fetchGLTF(t){return Tn(t,this.options).then(t=>t)}_loadGLTFModel(t){return this.fetchGLTF(t).then(e=>(this.resourceMap[t]=this._exportGLTFResource(e,t),this.resourceMap[t]))}}const Ln=function(){const t=[0,0,0],e=90*Math.PI/180,n=[0,0,0,0],r=new Array(16);return function(s,o,a,l,h,c){const u=[i["c"].lookAt([],t,[1,0,0],c&&c[0]||[0,-1,0]),i["c"].lookAt([],t,[-1,0,0],c&&c[1]||[0,-1,0]),i["c"].lookAt([],t,[0,1,0],c&&c[2]||[0,0,1]),i["c"].lookAt([],t,[0,-1,0],c&&c[3]||[0,0,-1]),i["c"].lookAt([],t,[0,0,1],c&&c[4]||[0,-1,0]),i["c"].lookAt([],t,[0,0,-1],c&&c[5]||[0,-1,0])],f={context:{viewMatrix:function(t,e,n){return u[n]},projMatrix:i["c"].perspective(r,e,1,.5,1.1)}};return o&&(f.framebuffer=o.faces?function(t,e,n){return o.faces[n]}:o),s(f)(6,(t,e,r)=>{const i={color:n,depth:1};o&&(i.framebuffer=o.faces?o.faces[r]:o),s.clear(i),a(l),h&&h()}),o}}();var zn={vertices:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],textures:[1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0,1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]},Bn="#define SHADER_NAME CUBE_MAP\nattribute vec3 aPosition;\nvarying vec3 vWorldPos;\nuniform mat4 projMatrix;\nuniform mat4 viewMatrix;\nvoid main() {\n  vWorldPos = aPosition;\n  gl_Position = projMatrix * viewMatrix * vec4(vWorldPos, 1.);\n}",Hn="precision highp float;\n#define PI 3.1415926\nvarying vec3 vWorldPos;\nuniform sampler2D equirectangularMap;\nconst vec2 c = vec2(.1591, .3183);\nvec2 d(vec3 e) {\n  vec2 f = vec2(atan(e.y, e.x), asin(e.z));\n  f *= c;\n  f += .5;\n  return f;\n}\nvec3 h(const in vec4 i, const in float j) {\n  return j * i.rgb * i.a;\n}\nvec4 k(const in vec3 i, const in float j) {\n  vec4 l;\n  vec3 m = i / j;\n  l.a = clamp(max(max(m.r, m.g), max(m.b, 1e-6)), .0, 1.);\n  l.a = ceil(l.a * 255.) / 255.;\n  l.rgb = m / l.a;\n  return l;\n}\nvoid main() {\n  vec2 f = d(normalize(vWorldPos));\n  vec4 i = texture2D(equirectangularMap, f);\n#ifdef INPUT_RGBM\ngl_FragColor = i;\n#else\ngl_FragColor = vec4(h(i, 7.), 1.);\n#endif\n}";
/*!
 * from claygl
 * https://github.com/pissang/claygl/
 * License: BSD-2-Clause
 */function Un(t,e){const n=t[0],r=t[1],i=t[2];return 0===e?1:1===e?n:2===e?r:3===e?i:4===e?n*i:5===e?r*i:6===e?n*r:7===e?3*i*i-1:n*n-r*r}const jn={px:[2,1,0,-1,-1,1],nx:[2,1,0,1,-1,-1],py:[0,2,1,1,-1,-1],ny:[0,2,1,1,1,1],pz:[0,1,2,-1,-1,-1],nz:[0,1,2,1,-1,1]},Vn=["px","nx","py","ny","pz","nz"],Gn=te.compile(je);function qn(t,e,n){const r=t({frag:Gn,vert:Bn,attributes:{aPosition:zn.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,environmentExposure:1,bias:0,size:n,hsv:[0,0,0]},elements:zn.indices}),i=[],s=t.framebuffer(n);return Ln(t,s,r,{size:n},(function(){const e=t.read();i.push(new e.constructor(e))})),r.destroy(),s.destroy(),i}const Wn=new Int8Array([-1,1,0,-1,-1,0,1,1,0,1,-1,0]),Xn=new Int8Array([0,1,0,0,1,1,1,0]);function Qn(t,e,n,r){e=e||256;const i=Yn(n=n||1024,r=r||256),s=t.texture({data:i,width:r,height:n,min:"nearest",mag:"nearest"}),o=t.buffer(Wn),a=t.buffer(Xn),l=t.framebuffer({radius:e,colorType:"uint8",colorFormat:"rgba",min:"linear",mag:"linear"}),h=t({frag:"precision highp float;\nvarying vec2 vTexCoords;\nuniform sampler2D distributionMap;\nconst float c = 3.14159265359;\nvec4 d(float a, float b) {\n  a *= 65535.;\n  b *= 65535.;\n  vec4 rgba;\n  rgba[0] = mod(a, 255.);\n  rgba[1] = (a - rgba[0]) / 65280.0;\n  rgba[2] = mod(b, 255.);\n  rgba[3] = (b - rgba[2]) / 65280.0;\n  return rgba;\n}\nvec3 e(float f, vec3 h, float i) {\n  vec4 j = texture2D(distributionMap, vec2(i, f));\n  vec3 k = j.xyz;\n  float l = sign(j.w - .5);\n  float m = sign(j.w - clamp(l, .0, 1.) * 200.0 / 255. - .15);\n  k.x *= l;\n  k.y *= m;\n  vec3 n = abs(h.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 o = normalize(cross(n, h));\n  vec3 u = cross(h, o);\n  vec3 v = o * k.x + u * k.y + h * k.z;\n  return normalize(v);\n}\nfloat A(float B, float i) {\n  float a = i;\n  float C = (a * a) / 2.;\n  float D = B;\n  float E = B * (1. - C) + C;\n  return D / E;\n}\nfloat F(float B, float G, float i) {\n  float I = A(B, i);\n  float J = A(G, i);\n  return J * I;\n}\nvec2 K(float B, float i) {\n  vec3 L;\n  L.x = sqrt(1. - B * B);\n  L.y = .0;\n  L.z = B;\n  float M = .0;\n  float O = .0;\n  vec3 h = vec3(.0, .0, 1.);\n  const int P = 1024;\n  for(int Q = 0; Q < P; ++Q) {\n    vec3 k = e(float(Q) / float(P), h, i);\n    vec3 R = normalize(2. * dot(L, k) * k - L);\n    float G = max(R.z, .0);\n    float S = max(k.z, .0);\n    float T = max(dot(L, k), .0);\n    float B = max(dot(h, L), .0);\n    if(G > .0) {\n      float U = F(B, G, i);\n      float W = (U * T) / (S * B);\n      float X = pow(1. - T, 5.);\n      M += (1. - X) * W;\n      O += X * W;\n    }\n  }\n  M /= float(P);\n  O /= float(P);\n  return vec2(M, O);\n}\nvoid main() {\n  vec2 Y = K(vTexCoords.x, vTexCoords.y);\n  gl_FragColor = d(Y.x, Y.y);\n}",vert:"attribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoords;\nvoid main() {\n  vTexCoords = aTexCoord;\n  gl_Position = vec4(aPosition, 1.);\n}",attributes:{aPosition:{buffer:o},aTexCoord:{buffer:a}},uniforms:{distributionMap:s},framebuffer:l,viewport:{x:0,y:0,width:e,height:e},count:Wn.length/3,primitive:"triangle strip"});return h(),h.destroy(),o.destroy(),a.destroy(),s.destroy(),l}function Yn(t,e){const n=new Array(t*e*4);for(let r=0;r<t;r++){const{x:i,y:s}=Zn(r,t);for(let t=0;t<e;t++){const o=t/e,a=o*o,l=2*Math.PI*i,h=Math.sqrt((1-s)/(1+(a*a-1)*s)),c=Math.sqrt(1-h*h),u=4*(r*e+t),f=c*Math.cos(l),d=c*Math.sin(l);n[u]=Math.abs(255*f),n[u+1]=Math.abs(255*d),n[u+2]=255*h,n[u+3]=(f>0?200:0)+(d>0?55:0)}}return n}function Zn(t,e){let n=(t<<16|t>>>16)>>>0;return n=((1431655765&n)<<1|(2863311530&n)>>>1)>>>0,n=((858993459&n)<<2|(3435973836&n)>>>2)>>>0,n=((252645135&n)<<4|(4042322160&n)>>>4)>>>0,n=(((16711935&n)<<8|(4278255360&n)>>>8)>>>0)/4294967296,{x:t/e,y:n}}var Kn=Object.freeze({__proto__:null,createIBLMaps:function(t,e={}){const n=e.envTexture,r=e.envCubeSize||512,s=e.sampleSize||1024,o=e.roughnessLevels||256,a=e.prefilterCubeSize||256;let l;if(Array.isArray(n)){const i=t.cube({flipY:!0,faces:n});l=function(t,e,n,r,i){const s=t({frag:r?"#define ENC_RGBM 1\n"+Gn:Gn,vert:Bn,attributes:{aPosition:zn.vertices},uniforms:{hsv:[0,0,0],projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),cubeMap:e,bias:0,size:e.width,environmentExposure:1,rgbmRange:i},elements:zn.indices}),o=t.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),a=t.framebufferCube({radius:n,color:o});return Ln(t,a,s,{size:n},null,[[0,0,-1],[0,0,-1],[0,0,1],[0,0,1],[0,-1,0],[0,-1,0]]),s.destroy(),a}(t,i,r,!0,e.rgbmRange),i.destroy()}else l=function(t,e,n,r){n=n||512;const i=t({frag:r?"#define INPUT_RGBM 1\n"+Hn:Hn,vert:Bn,attributes:{aPosition:zn.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),equirectangularMap:e},elements:zn.indices}),s=t.cube({width:n,height:n,min:"linear",mag:"linear",format:"rgba"}),o=t.framebufferCube({radius:n,color:s});return Ln(t,o,i),i.destroy(),o}(t,n,r,!0);const{prefilterMap:h,prefilterMipmap:c}=function(t,e,n,r,i,s){const o=function(t,e,n,r,i,s){const o=Yn(i=i||1024,s=s||256),a=t.texture({data:o,width:s,height:i,min:"nearest",mag:"nearest"}),l=t({frag:"#define SHADER_NAME PBR_prefilter\nprecision highp float;\nvarying vec3 vWorldPos;\nuniform samplerCube environmentMap;\nuniform sampler2D distributionMap;\nuniform float roughness;\nuniform float resolution;\nuniform float rgbmRange;\nconst float c = 3.14159265359;\nfloat d(vec3 e, vec3 f, float h) {\n  float a = h * h;\n  float i = a * a;\n  float j = max(dot(e, f), .0);\n  float k = j * j;\n  float l = i;\n  float m = (k * (i - 1.) + 1.);\n  m = c * m * m;\n  return l / m;\n}\nvec3 n(float o, vec3 e, float h) {\n  vec4 u = texture2D(distributionMap, vec2(h, o));\n  vec3 f = u.xyz;\n  float v = sign(u.w - .5);\n  float A = sign(u.w - 200.0 / 255. * clamp(v, .0, 1.) - .15);\n  f.x *= v;\n  f.y *= A;\n  vec3 B = abs(e.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 C = normalize(cross(B, e));\n  vec3 D = cross(e, C);\n  vec3 E = C * f.x + D * f.y + e * f.z;\n  return normalize(E);\n}\nvec4 F(const in vec3 G, const in float I) {\n  if(I <= .0)\n    return vec4(G, 1.);\n  vec4 J;\n  vec3 K = G / I;\n  J.a = clamp(max(max(K.r, K.g), max(K.b, 1e-6)), .0, 1.);\n  J.a = ceil(J.a * 255.) / 255.;\n  J.rgb = K / J.a;\n  return J;\n}\nvec3 L(const in vec4 G, const in float I) {\n  if(I <= .0)\n    return G.rgb;\n  return I * G.rgb * G.a;\n}\nvoid main() {\n  vec3 e = normalize(vWorldPos);\n  vec3 M = e;\n  vec3 O = M;\n  const int P = 1024;\n  vec3 Q = vec3(.0);\n  float S = .0;\n  for(int T = 0; T < P; ++T) {\n    vec3 f = n(float(T) / float(P), e, roughness);\n    vec3 U = normalize(2. * dot(O, f) * f - O);\n    float W = max(dot(e, U), .0);\n    if(W > .0) {\n      Q += L(textureCube(environmentMap, U), rgbmRange).rgb * W;\n      S += W;\n    }\n  }\n  Q = Q / S;\n  gl_FragColor = F(Q, rgbmRange);\n}",vert:Bn,attributes:{aPosition:zn.vertices},uniforms:{projMatrix:t.context("projMatrix"),viewMatrix:t.context("viewMatrix"),environmentMap:e,distributionMap:a,roughness:t.prop("roughness"),resolution:r,rgbmRange:n||7},elements:zn.indices,viewport:{x:0,y:0,width:t.prop("size"),height:t.prop("size")}});let h=r;const c=t.texture({radius:r,min:"linear",mag:"linear"}),u=t.framebuffer({radius:r,color:c}),f=Math.log(h)/Math.log(2),d=[];for(let p=0;p<=f;p++){let e=0;Ln(t,u,l,{roughness:p/(f-1),size:h},(function(){const n=t.read({framebuffer:u});d[e]||(d[e]={mipmap:[]}),d[e].mipmap.push(n),e++})),h/=2,u.resize(h)}return a.destroy(),u.destroy(),l.destroy(),d}(t,e,n,r,i,s);return{prefilterMap:t.cube({radius:r,min:"linear mipmap linear",mag:"linear",faces:o}),prefilterMipmap:o}}(t,l,e.rgbmRange,a,s,o);let u;if(!e.ignoreSH){const e=a;u=function(t,e,n){const r=new Array(9),s=[],o=[],a=[];for(let l=0;l<9;l++){const h=[0,0,0];for(let r=0;r<Vn.length;r++){const c=t[r],u=[0,0,0];let f=0,d=0;const p=jn[Vn[r]];for(let t=0;t<n;t++)for(let r=0;r<e;r++){s[0]=r/(e-1)*2-1,s[1]=t/(n-1)*2-1,s[2]=-1,i["f"].normalize(s,s),a[0]=s[p[0]]*p[3],a[1]=s[p[1]]*p[4],a[2]=s[p[2]]*p[5],o[0]=c[d++]/255,o[1]=c[d++]/255,o[2]=c[d++]/255;const h=c[d++]/255*7;o[0]*=h,o[1]*=h,o[2]*=h,i["f"].scaleAndAdd(u,u,o,Un(a,l)*-s[2]),f+=-s[2]}i["f"].scaleAndAdd(h,h,u,1/f)}r[l]=i["f"].scale(h,h,1/6)}return r}(qn(t,h,e),e,e);const n=[];for(let t=0;t<u.length;t++)n.push(...u[t]);u=n}const f={rgbmRange:e.rgbmRange,envMap:l,prefilterMap:h};return u&&(f.sh=u),"array"===e.format&&(f.envMap={width:l.width,height:l.height,faces:qn(t,l,r)},f.prefilterMap={width:h.width,height:h.height,faces:c},l.destroy(),h.destroy()),f},generateDFGLUT:Qn});const Jn={uvScale:[1,1],uvOffset:[0,0],uvRotation:0,textureOrigin:null,textureWidth:null,baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,anisotropyDirection:0,anisotropyFactor:0,clearCoatFactor:0,clearCoatIor:1.4,clearCoatRoughnessFactor:.04,clearCoatThickness:5,emitColorFactor:1,occlusionFactor:1,roughnessFactor:.4,metallicFactor:0,normalMapFactor:1,specularF0:.5,emitMultiplicative:1,normalMapFlipY:0,outputSRGB:1,baseColorTexture:null,normalTexture:null,occlusionTexture:null,metallicRoughnessTexture:null,emissiveTexture:null,uvOrigin:[0,0],noiseTexture:null,clearCoatTint:[.006,.006,.006],specularAAVariance:20,specularAAThreshold:20,hsv:[0,0,0],contrast:1,bumpTexture:null,bumpScale:.05,bumpMinLayers:5,bumpMaxLayers:20,alphaTest:0};class $n extends wt{constructor(t){const e=u({},Jn);(t.metallicRoughnessTexture||t.metallicRoughnessTexture)&&(e.roughnessFactor=1,e.metallicFactor=1),super(t,e)}appendDefines(t,e){super.appendDefines(t,e);const n=this.uniforms;return n.GAMMA_CORRECT_INPUT&&(t.GAMMA_CORRECT_INPUT=1),e.data[e.desc.colorAttribute]&&(t.HAS_COLOR=1),e.data[e.desc.color0Attribute]&&(t.HAS_COLOR0=1,t.COLOR0_SIZE=e.getColor0Size()),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),e.data.aVertexColorType&&(t.HAS_VERTEX_COLOR=1),e.data[e.desc.uv0Attribute]?(n.baseColorTexture&&(t.HAS_ALBEDO_MAP=1),n.metallicRoughnessTexture&&(t.HAS_METALLICROUGHNESS_MAP=1),n.occlusionTexture&&e.data[e.desc.uv1Attribute]&&(t.HAS_AO_MAP=1),n.emissiveTexture&&(t.HAS_EMISSIVE_MAP=1),n.normalTexture&&(t.HAS_NORMAL_MAP=1),n.bumpTexture&&(t.HAS_BUMP_MAP=1),n.skinTexture&&(t.HAS_SKIN_MAP=1),(t.HAS_ALBEDO_MAP||t.HAS_METALLICROUGHNESS_MAP||t.HAS_AO_MAP||t.HAS_EMISSIVE_MAP||t.HAS_NORMAL_MAP||t.HAS_BUMP_MAP||t.HAS_SKIN_MAP)&&(t.HAS_MAP=1),n.noiseTexture&&(t.HAS_RANDOM_TEX=1),e.data[e.desc.tangentAttribute]?t.HAS_TANGENT=1:e.data[e.desc.normalAttribute]&&(t.HAS_NORMAL=1),t):t}}class tr extends(kt($n)){}function er(t,e,n){if(n.ambientUpdate){const{iblTexes:r}=t;if(r){const i=n.target;ir(r),t.iblTexes=rr(e,i)}else t.iblTexes=rr(e,n.target)}}const nr=[0,0];function rr(t,e){const n=e.getLightManager(),r=n&&n.getAmbientResource();return r?{prefilterMap:t.cube({width:r.prefilterMap.width,height:r.prefilterMap.height,faces:r.prefilterMap.faces,min:"linear mipmap linear",mag:"linear",format:"rgba"}),sh:r.sh,rgbmRange:r.rgbmRange}:null}function ir(t){for(const e in t)t[e].destroy&&t[e].destroy(),delete t[e]}var sr=Object.freeze({__proto__:null,loginIBLResOnCanvas:function(t,e,n){if(!t.dfgLUT&&(t.dfgLUT=Qn(e),t.dfgLUT.mtkRefCount=0,n)){const r=er.bind(this,t,e);n.on("updatelights",r),t._iblResListener=r}t.dfgLUT.mtkRefCount++;const r=n.getLightManager();return r&&r.getAmbientResource()?(t.iblTexes||(t.iblTexes=rr(e,n)),{dfgLUT:t.dfgLUT,iblTexes:t.iblTexes}):{dfgLUT:t.dfgLUT,iblTexes:null}},getIBLResOnCanvas:function(t){const{dfgLUT:e,iblTexes:n}=t;return{dfgLUT:e,iblTexes:n}},logoutIBLResOnCanvas:function(t,e){let n=!1;t.dfgLUT&&(t.dfgLUT.mtkRefCount--,t.dfgLUT.mtkRefCount<=0)&&(n=!0,e&&e.off("updatelights",t._iblResListener),t.dfgLUT.destroy(),delete t.dfgLUT),t.iblTexes&&n&&(ir(t.iblTexes),delete t.iblTexes)},getPBRUniforms:function(t,e,n,r,i){const s=t.viewMatrix,o=t.projMatrix,a=t.cameraPosition,l=t.getRenderer().canvas,h=function(t,e){const n=t.getLightManager(),r=n&&n.getAmbientResource(),i=n&&n.getAmbientLight()||{},s=n&&n.getDirectionalLight()||{};let o;if(r){const t=e.prefilterMap.width,n=Math.log(t)/Math.log(2);o={prefilterMap:e.prefilterMap,diffuseSPH:e.sh,prefilterMiplevel:[n,n],prefilterSize:[t,t],hdrHSV:i.hsv||[0,0,0]}}else o={ambientColor:i.color||[.2,.2,.2]};return o.rgbmRange=r?e.rgbmRange:7,o.environmentExposure=d(i.exposure)?i.exposure:1,o.environmentOrientation=i.orientation||0,o.light0_diffuse=[...s.color||[1,1,1],1],o.light0_viewDirection=s.direction||[1,1,-1],o}(t,e),c=u({viewMatrix:s,projMatrix:o,projViewMatrix:t.projViewMatrix,cameraPosition:a,outSize:[l.width,l.height],cameraNearFar:[t.cameraNear,t.cameraFar]},h);return c.brdfLUT=n,r&&r.renderUniforms&&u(c,r.renderUniforms),c.halton=i||nr,c},createIBLTextures:rr,disposeIBLTextures:ir,isSupported:function(t){return t.hasExtension("EXT_shader_texture_lod")}});class or extends ce{constructor(t){super({vert:"attribute vec3 aPosition;\nuniform mat4 lightProjViewModelMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 modelMatrix;\n#include <line_extrusion_vert>\n#include <get_output>\nvarying vec4 vPosition;\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 d = getLineExtrudePosition(aPosition);\n  vec4 e = getPosition(d);\n#else\nvec4 e = getPosition(aPosition);\n#endif\ngl_Position = lightProjViewModelMatrix * c * e;\n  vPosition = gl_Position;\n}",frag:"#define SHADER_NAME vsm_mapping\n#ifdef USE_VSM\n#extension GL_OES_standard_derivatives : enable\n#endif\nprecision highp float;\nvarying vec4 vPosition;\n#ifdef PACK_FLOAT\n#include <common_pack_float>\n#endif\nvoid main() {\n  \n#if defined(USE_VSM)\nfloat c = vPosition.z / vPosition.w;\n  c = c * .5 + .5;\n  float d = c;\n  float e = c * c;\n  float f = dFdx(c);\n  float h = dFdy(c);\n  e += .25 * (f * f + h * h);\n  gl_FragColor = vec4(d, e, c, .0);\n#endif\n#if defined(USE_ESM)\n#ifdef PACK_FLOAT\ngl_FragColor = common_encodeDepth(gl_FragCoord.z);\n#else\ngl_FragColor = vec4(gl_FragCoord.z, .0, .0, 1.);\n#endif\n#endif\n}",uniforms:[{name:"lightProjViewModelMatrix",type:"function",fn:function(t,e){return i["c"].multiply([],e.lightProjViewMatrix,e.modelMatrix)}}],extraCommandProps:{},defines:t})}filter(t){return t.castShadow}}class ar extends xe{constructor({blurOffset:t}){super({vert:me,frag:"precision highp float;\nvarying vec2 vTexCoord;\nuniform sampler2D textureSource;\nuniform vec2 resolution;\n#include <common_pack_float>\nvoid main() {\n  float c = .0;\n  float d = .0;\n  for(int x = -BOXBLUR_OFFSET; x <= BOXBLUR_OFFSET; ++x)\n    for(int y = -BOXBLUR_OFFSET; y <= BOXBLUR_OFFSET; ++y) {\n      vec2 e = vTexCoord.st + vec2(float(x) / resolution.x, float(y) / resolution.y);\n      e = clamp(e, .0, 1.);\n      float f = common_decodeDepth(texture2D(textureSource, e));\n      float s = max(.0, sign(1. - f));\n      d += sign(f) * s;\n      c += f;\n    }\n  float h = c / max(1., d);\n  gl_FragColor = common_encodeDepth(h);\n}",defines:{BOXBLUR_OFFSET:t||2}}),this._blurOffset=t||2}getMeshCommand(t,e){const n="box_shadow_blur_"+this._blurOffset;return this.commands[n]||(this.commands[n]=this.createREGLCommand(t,null,e.getElements())),this.commands[n]}}let lr=null,hr=null;class cr{constructor(t,{width:e,height:n,blurOffset:r,defines:i}){this.renderer=t,this.width=e||512,this.height=n||512,this.blurOffset=a(r)?2:r,this._init(i)}render(t,{cameraProjViewMatrix:e,lightDir:n,farPlane:r,cameraLookAt:i}){return{lightProjViewMatrix:this._renderShadow(t,e,n,r,i),shadowMap:this.blurTex||this.depthTex,depthFBO:this.depthFBO,blurFBO:this.blurFBO}}resize(t,e){return this.depthTex&&(this.depthTex.resize(t,e),this.depthFBO.resize(t,e)),this.blurFBO&&(this.blurTex.resize(t,e),this.blurFBO.resize(t,e)),this}_renderShadow(t,e,n,r,i){const s=this.renderer,o=lr(e);if(r)for(let l=4;l<8;l++)o[l]=r[l-4];const a=hr(i,o,n);return s.clear({color:[1,0,0,1],depth:1,framebuffer:this.depthFBO}),s.render(this.shadowMapShader,{lightProjViewMatrix:a},t,this.depthFBO),this.blurFBO&&(this.boxBlurShader||(this.boxBlurShader=new ar({blurOffset:this.blurOffset})),s.clear({color:[1,0,0,1],depth:1,framebuffer:this.blurFBO}),s.render(this.boxBlurShader,{resolution:[this.depthTex.width,this.depthTex.height],textureSource:this.depthTex},null,this.blurFBO)),a}_init(t){const e=this.renderer.regl,n=this.width,r=this.height;this.depthTex=e.texture({width:n,height:r,format:"rgb",type:"uint8",min:"nearest",mag:"nearest"}),this.shadowMapShader=new or(t),this.shadowMapShader.filter=t=>t.castShadow,this.depthFBO=e.framebuffer({color:this.depthTex}),this.blurOffset<=0||(this.blurTex=e.texture({width:n,height:r,format:"rgb",type:"uint8",min:"linear",mag:"linear"}),this.blurFBO=e.framebuffer({color:this.blurTex}))}dispose(){this.depthTex&&(this.depthTex.destroy(),this.depthFBO.destroy(),delete this.depthTex,delete this.depthFBO),this.blurTex&&(this.blurTex.destroy(),this.blurFBO.destroy(),delete this.blurTex,delete this.blurFBO),this.shadowMapShader&&(this.shadowMapShader.dispose(),delete this.shadowMapShader),this.boxBlurShader&&(this.boxBlurShader.dispose(),delete this.boxBlurShader)}}lr=function(){const t=[[-1,-1,-1,1],[1,-1,-1,1],[1,1,-1,1],[-1,1,-1,1],[-1,-1,1,1],[1,-1,1,1],[1,1,1,1],[-1,1,1,1]],e=new Array(16);return function(n){i["c"].invert(e,n);const r=[];for(let s=0;s<t.length;s++){const n=i["g"].transformMat4([],t[s],e);i["g"].scale(n,n,1/n[3]),r.push(n)}return r}}(),hr=function(){let t=new Array(4);const e=new Array(3),n=[0,0,0,0],r=[0,1,0],s=new Array(3);let o=new Array(16),a=new Array(16);const l=new Array(16),h=[1,1,1],c=[0,0,0];return function(u,f,d){i["g"].set(n,...u,1),i["f"].scale(e,d,-1),o=i["c"].lookAt(o,i["f"].add(s,n,i["f"].normalize(s,e)),n,r),i["g"].transformMat4(t,f[0],o);let p=t[2],A=t[2],g=t[0],m=t[0],y=t[1],v=t[1];for(let e=1;e<8;e++)t=i["g"].transformMat4(t,f[e],o),t[2]>A&&(A=t[2]),t[2]<p&&(p=t[2]),t[0]>m&&(m=t[0]),t[0]<g&&(g=t[0]),t[1]>v&&(v=t[1]),t[1]<y&&(y=t[1]);a=i["c"].ortho(a,-1,1,-1,1,-A,-p);const x=h[0]=2/(m-g),b=h[1]=-2/(v-y);c[0]=-.5*(g+m)*x,c[1]=-.5*(y+v)*b,i["c"].identity(l),i["c"].translate(l,l,c),i["c"].scale(l,l,h);const w=i["c"].multiply(a,l,a);return i["c"].multiply(new Array(16),w,o)}}();class ur extends ce{constructor(t){super({vert:"#define SHADER_NAME SHADOW_DISPLAY\nattribute vec3 aPosition;\nuniform mat4 projMatrix;\nuniform mat4 modelViewMatrix;\nuniform vec2 halton;\nuniform vec2 globalTexSize;\nvarying vec4 vPosition;\n#include <vsm_shadow_vert>\nvoid main() {\n  vec4 c = vec4(aPosition, 1.);\n  vec4 d = modelViewMatrix * c;\n  mat4 e = projMatrix;\n  e[2].xy += halton.xy / globalTexSize.xy;\n  gl_Position = e * d;\n  vPosition = gl_Position;\n  shadow_computeShadowPars(c);\n}",frag:"#define SHADER_NAME SHADOW_DISPLAY\nprecision mediump float;\nuniform vec3 color;\n#include <vsm_shadow_frag>\nvoid main() {\n  float c = shadow_computeShadow();\n  float d = 1. - c;\n  gl_FragColor = vec4(color * d, d);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){const n=[];return i["c"].multiply(n,e.viewMatrix,e.modelMatrix),n}}],defines:t||{USE_ESM:1},extraCommandProps:{depth:{enable:!0,mask:!1},viewport:{x:0,y:0,width:(t,e)=>e.globalTexSize[0],height:(t,e)=>e.globalTexSize[1]}}})}getMeshCommand(t,e){return this.commands.shadow_display||(this.commands.shadow_display=this.createREGLCommand(t,null,e.getElements())),this.commands.shadow_display}}function fr(t){return 256*t[2]*256+256*t[1]+t[0]}const dr=new Uint8Array(4),pr=new Float32Array(dr.buffer);let Ar,gr;const mr=[1,1],yr="\n    vec3 unpack(highp float f) {\n        highp vec3 color;\n        color.b = floor(f / 65536.0);\n        color.g = floor((f - color.b * 65536.0) / 256.0);\n        color.r = f - floor(color.b * 65536.0) - floor(color.g * 256.0);\n        // now we have a vec3 with the 3 components in range [0..255]. Let's normalize it!\n        return color / 255.0;\n    }\n",vr=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    uniform float fbo_picking_meshId;\n\n    ${yr}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), fbo_picking_meshId / 255.0);\n    }\n`,xr=`\n    precision highp float;\n\n    uniform int fbo_picking_meshId;\n    varying float vFbo_picking_visible;\n\n    ${yr}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(float(fbo_picking_meshId)), 1.0);\n        // gl_FragColor = vec4(unpack(float(35)), 1.0);\n    }\n`,br=`\n    precision highp float;\n\n    varying float vPickingId;\n    varying float vFbo_picking_visible;\n\n    ${yr}\n\n    void main() {\n        if (vFbo_picking_visible == 0.0) {\n            discard;\n            return;\n        }\n        gl_FragColor = vec4(unpack(vPickingId), 1.0);\n    }\n`;class wr{constructor(t,{vert:e,uniforms:n,defines:r,extraCommandProps:i},s,o){this._renderer=t,this._fbo=s,this._map=o,this._clearFbo(s),this._vert=e,this._uniforms=n,this._defines=r,this._extraCommandProps=u({},i),delete this._extraCommandProps.blend,delete this._extraCommandProps.stencil,this._currentMeshes=[],this._init()}_init(){const t=[];this._uniforms&&t.push(...this._uniforms);const e={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const s in this._defines)e[s]=this._defines[s];const n=this._vert,r=this._extraCommandProps;this._shader0=new ce({vert:n,frag:vr,uniforms:t,defines:e,extraCommandProps:r}),this._shader2=new ce({vert:n,frag:br,uniforms:t,defines:e,extraCommandProps:r});const i={ENABLE_PICKING:1,HAS_PICKING_ID:1};if(this._defines)for(const s in this._defines)i[s]=this._defines[s];this._shader1=new ce({vert:n,frag:xr,uniforms:t,defines:i,extraCommandProps:r}),this._depthShader=new ce({vert:n,frag:"\n    #ifdef GL_ES\n        precision highp float;\n    #endif\n    #if __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n        #extension GL_EXT_frag_depth : enable\n    #endif\n    #include <gl2_frag>\n    #include <common_pack_float>\n    varying float vFbo_picking_viewZ;\n    uniform float logDepthBufFC;\n    varying float vFbo_picking_fragDepth;\n\n    const float PackUpscale = 256. / 255.;\n    const float UnpackDownscale = 255. / 256.;\n    const vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256., 256. );\n    const vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\n    const float ShiftRight8 = 1. / 256.;\n    vec4 packDepthToRGBA(const in float v ) {\n        vec4 r = vec4(fract(v * PackFactors), v);\n        r.yzw -= r.xyz * ShiftRight8;\n        return r * PackUpscale;\n    }\n\n    void main() {\n        float fragDepth = vFbo_picking_fragDepth > 1.0 ? vFbo_picking_fragDepth : vFbo_picking_viewZ + 1.0;\n        #if __VERSION__ == 300 || __VERSION__ == 100 && defined(GL_EXT_frag_depth)\n            gl_FragDepthEXT = log2(fragDepth) * logDepthBufFC * 0.5;\n        #endif\n        vec4 depthColor = packDepthToRGBA(fragDepth - 1.0);\n        glFragColor = common_unpackFloat(dot(depthColor, UnpackFactors));\n        #if __VERSION__ == 100\n            gl_FragColor = glFragColor;\n        #endif\n    }\n",uniforms:t,defines:i,extraCommandProps:r}),this._scene=new Vt,this._scene1=new Vt}filter(){return!0}render(t,e,n=!1){if(!t||!t.length)return this;const r=this._fbo;n&&this.clear(),t=t.filter(t=>t&&t.isValid()),this._scene.setMeshes(t);const i=this._getShader(t,n);i.filter=this.filter,this._currentShader&&i!==this._currentShader&&this.clear(),this._currentShader=i,t.forEach((t,e)=>{t.setUniform("fbo_picking_meshId",e+this._currentMeshes.length)});for(let s=0;s<t.length;s++)this._currentMeshes.push(t[s]);return this._renderer.render(i,e,this._scene,r),this}pickAll(t,e,n,r,i){n=Mr(n);const{meshIds:s,pickingIds:o,coords:a,points:l}=this._pick(t,e,n,r,i),h=[];if(o&&s){const t={};for(let e=0;e<s.length;e++){const n=`${o[e]}_${s[e]}`;null==s[e]||null==o[e]||t[n]||(t[n]=!0,h.push({meshId:s[e],pickingId:o[e],point:l[e]||null,coordinate:a[e]||null}))}}return h}pick(t,e,n,r,i={}){n=Mr(n);const{meshIds:s,pickingIds:o,width:a,coords:l,points:h}=this._pick(t,e,n,r,i);if(o&&s){const t=[];for(let e=0;e<=n[0];e++)t.push(e),e>0&&t.push(-e);for(let e=0;e<t.length;e++)for(let r=0;r<t.length;r++){const i=(t[r]+n[1])*a+(t[e]+n[0]);if(null!=s[i]&&null!=o[i])return{meshId:s[i],pickingId:o[i],point:h[i]||null,coordinate:l[i]||null}}}return{pickingId:null,meshId:null,point:null}}_pick(t,e,n,r,i={}){const s=this._currentShader,o=this._currentMeshes;if(!s||!o||!o.length)return{pickingId:null,meshId:null,point:null};t=Math.round(t),e=Math.round(e);const a=this._fbo;if(t<=2||t>=a.width-2||e<=2||e>=a.height-2)return{pickingId:null,meshId:null,point:null};const{px:l,py:h,width:c,height:u}=this._getParams(t,e,n,a),f=new Uint8Array(4*c*u),d=this._renderer.regl.read({data:f,x:l,y:h,framebuffer:a,width:c,height:u}),p=[];let A=[];for(let w=0;w<d.length;w+=4){const{pickingId:t,meshId:e}=this._packData(d.subarray(w,w+4),s);p.push(e),A.push(t)}const g={},m=p.filter(t=>null!=t&&!g[t]&&(g[t]=1,!0)).map(t=>o[t]);let y;for(let w=0;w<m.length;w++)if(m[w]&&m[w].geometry){y=m[w];break}if(!y)return{pickingId:null,meshId:null,point:null};const v=y.geometry.desc.pickingIdAttribute;p.length&&s===this._shader1&&(void 0!==y.getUniform("uPickingId")||y.geometry.data[v])&&(A=this._getPickingId(l,h,c,u,f,m,r));const x=[],b=[];if(p.length&&i.returnPoint){const{viewMatrix:n,projMatrix:s}=i,o=this._pickDepth(l,h,c,u,f,m,r);for(let r=0;r<o.length;r++)if(o[r]&&null!=p[r]&&null!=A[r]){const i=this._getWorldPos(t,e,o[r],n,s),a=this._convertPickPoint(i);x.push(i),b.push(a)}else x.push(null),b.push(null)}return{meshIds:p,pickingIds:A,coords:b,points:x,width:c,height:u}}_convertPickPoint(t){const e=this._map;if(!e)return null;const n=e.getGLRes();if(!Ar){const t=e.getCenter();gr=new t.constructor(0,0,0);const n=e.coordToPoint(t);Ar=new n.constructor(0,0)}Ar.set(t[0],t[1]);const r=e.pointAtResToCoord(Ar,n,gr),i=e.pointAtResToAltitude(t[2],n);return[r.x,r.y,i]}clear(){return this._fbo&&this._clearFbo(this._fbo),this._currentMeshes=[],delete this._currentShader,this}getMeshAt(t){return this._currentMeshes?this._currentMeshes[t]:null}getRenderedMeshes(){return this._currentMeshes}dispose(){this.clear(),this._shader0&&this._shader0.dispose(),this._shader1&&this._shader1.dispose(),this._shader2&&this._shader2.dispose(),this._scene&&this._scene.clear(),this._scene1&&this._scene1.clear()}_getWorldPos(t,e,n,r,s){const o=this._fbo,a=[],l=o.width/2||1,h=o.height/2||1,c=[(t-l)/l,(h-e)/h,0,1],u=[(t-l)/l,(h-e)/h,1,1],f=i["c"].invert(a,s),d=[],A=[];_r(d,c,f),_r(A,u,f);const g=-d[2],m=(n-g)/(-A[2]-g),y=i["c"].multiply(a,s,r),v=i["c"].invert(a,y),x=_r(c,c,v),b=_r(u,u,v);return[p(x[0],b[0],m),p(x[1],b[1],m),p(x[2],b[2],m)]}_getPickingId(t,e,n,r,i,s,o){const a=this._renderer.regl,l=this._getFBO1();this._clearFbo(l),this._scene1.setMeshes(s),this._renderer.render(this._shader2,o,this._scene1,l);const h=a.read({data:i,x:t,y:e,framebuffer:l,width:n,height:r}),c=[];for(let u=0;u<h.length;u+=4)c.push(fr(h.subarray(u,u+4)));return c}_pickDepth(t,e,n,r,i,s,o){const a=this._renderer.regl,l=this._getFBO1();this._scene1.setMeshes(s),this._clearFbo(l),o.logDepthBufFC=2/(Math.log(this._map.cameraFar+1)/Math.LN2),this._renderer.render(this._depthShader,o,this._scene1,l);const h=a.read({data:i,x:t,y:e,framebuffer:l,width:n,height:r}),c=[];for(let f=0;f<h.length;f+=4)c.push((u=h.subarray(f,f+4),dr[0]=u[3],dr[1]=u[2],dr[2]=u[1],dr[3]=u[0],pr[0]));var u;return c}_packData(t,e){if(255===t[0]&&255===t[1]&&255===t[2]&&255===t[3])return{meshId:null,pickingId:null};let n=null,r=null;return e===this._shader1?r=fr(t):e===this._shader0?(r=t[3],n=fr(t)):(r=null,n=fr(t)),{meshId:r,pickingId:n}}_clearFbo(t){this._renderer.regl.clear({color:[1,1,1,1],depth:1,stencil:0,framebuffer:t})}_getShader(t,e){return e&&t.length<256?this._shader0:this._shader1}_getFBO1(){const t=this._renderer.regl,e=this._fbo;return this._fbo1?this._fbo1.width===e.width&&this._fbo1.height===e.height||this._fbo1.resize(e.width,e.height):this._fbo1=t.framebuffer(e.width,e.height),this._fbo1}_getParams(t,e,n,r){const i=n[0],s=n[1];e=r.height-e;let o=2*i+1,a=2*s+1;const l=(t-=i)+o,h=(e-=s)+a;return l>r.width&&(o-=l-r.width),h>r.height&&(a-=h-r.height),{px:t=t<0?0:t,py:e=e<0?0:e,width:o,height:a}}getPickingVert(){return this._vert}getUniformDeclares(){return this._uniforms}}function _r(t,e,n){const r=e[0],i=e[1],s=e[2],o=1/(n[3]*r+n[7]*i+n[11]*s+n[15]);return t[0]=(n[0]*r+n[4]*i+n[8]*s+n[12])*o,t[1]=(n[1]*r+n[5]*i+n[9]*s+n[13])*o,t[2]=(n[2]*r+n[6]*i+n[10]*s+n[14])*o,t}function Mr(t){return d(t)&&(mr[0]=mr[1]=t,t=mr),t}const Tr=t=>t&&t.geometry&&void 0===t.geometry.properties.shaderHash,Sr=[],Ir=[],Cr=[{name:"modelViewMatrix",type:"function",fn:(t,e)=>i["c"].multiply(Sr,e.viewMatrix,e.modelMatrix)},{name:"modelViewProjMatrix",type:"function",fn:(t,e)=>{const n=i["c"].multiply(Sr,e.viewMatrix,e.modelMatrix);return i["c"].multiply(Sr,e.projMatrix,n)}},{name:"modelMatrixInverse",type:"function",fn:(t,e)=>i["c"].invert(Sr,e.modelMatrix)},{name:"projMatrixInverse",type:"function",fn:(t,e)=>i["c"].invert(Sr,e.projMatrix)},{name:"modelViewMatrixInverse",type:"function",fn:(t,e)=>(i["c"].multiply(Sr,e.viewMatrix,e.modelMatrix),i["c"].invert(Sr,Sr))},{name:"modelViewProjMatrixInverse",type:"function",fn:(t,e)=>{const n=i["c"].multiply(Sr,e.viewMatrix,e.modelMatrix);return i["c"].multiply(Sr,e.projMatrix,n),i["c"].invert(Sr,Sr)}},{name:"modelInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=i["b"].fromMat4(Ir,e.modelMatrix),r=i["b"].transpose(n,n);return i["b"].invert(r,r)}},{name:"modelViewInverseTransposeMatrix",type:"function",fn:(t,e)=>{const n=i["c"].multiply(Sr,e.viewMatrix,e.modelMatrix),r=i["b"].fromMat4(Ir,n),s=i["b"].transpose(r,r);return i["b"].invert(s,s)}}],Or={LOCAL:"positionMatrix",MODEL:"modelMatrix",VIEW:"viewMatrix",PROJECTION:"projMatrix",MODELVIEW:"modelViewMatrix",MODELVIEWPROJECTION:"modelViewProjMatrix",MODELINVERSE:"modelMatrixInverse",VIEWINVERSE:"viewMatrixInverse",PROJECTIONINVERSE:"projMatrixInverse",MODELVIEWINVERSE:"modelViewMatrixInverse",MODELVIEWPROJECTIONINVERSE:"modelViewProjMatrixInverse",MODELINVERSETRANSPOSE:"modelInverseTransposeMatrix",MODELVIEWINVERSETRANSPOSE:"modelViewInverseTransposeMatrix",VIEWPORT:"viewport",JOINTMATRIX:"jointMatrix",ALPHACUTOFF:"alphaCutoff"};class Er{constructor(t,e,n){this._regl=t,this._khrShaders={},this._commandProps=e,this._resLoader=n}getExcludeFilter(){return Tr}forEachShader(t){for(const e in this._khrShaders){const n=this._khrShaders[e];t(n.shader,n.filter,n.uniformSemantics)}}createMesh(t,e,n,r){const i=e.extensions.KHR_techniques_webgl,s=e.materials[t.material].extensions.KHR_techniques_webgl,{technique:o,values:a}=s,l=i.techniques[o],h=i.programs[l.program],c=i.shaders[h.vertexShader],f=i.shaders[h.fragmentShader];f.content=function(t){return t&&t.indexOf("precision")<0?"precision mediump float;\n"+t:t}(f.content);const d=S(c.content)+"-"+S(f.content);this._khrShaders[d]||(this._khrShaders[d]=this._createTechniqueShader(d,i,o,this._commandProps,r));const{attributeSemantics:p}=this._khrShaders[d],A=this._createGeometry(t,p,n,d),g=u({},a);for(const u in a)l.uniforms[u]&&35678===l.uniforms[u].type&&(g[u]=this._getTexture(e.textures[a[u].index]));return{geometry:A,material:new wt(g)}}_createGeometry(t,e,n,r){const i=t.attributes;if(i.COLOR_0){const t=i.COLOR_0.array||i.COLOR_0;if(t instanceof Float32Array){const e=new Uint8Array(t.length);for(let n=0;n<e.length;n++)e[n]=Math.round(255*t[n]);i.COLOR_0.array?(i.COLOR_0.array=e,i.COLOR_0.componentType=5121):i.COLOR_0=e}}const s={};for(const l in i){const t=ct(this._regl,i[l],{dimension:i[l].itemSize}),n=e[l]||l;s[n]={buffer:t},i[l].quantization&&(s[n].quantization=i[l].quantization),n===e.POSITION&&(s[n].array=i[l].array)}const o=new Q(s,t.indices.array?t.indices.array:t.indices,0,{positionAttribute:e.POSITION,normalAttribute:e.NORMAL,uv0Attribute:e.TEXCOORD_0,uv1Attribute:e.TEXCOORD_1,color0Attribute:e.COLOR_0,tangentAttribute:e.TANGENT,textureCoordMatrixAttribute:e.TextureCoordMatrix,primitive:void 0===t.mode?"triangles":K(t.mode)});o.generateBuffers(this._regl,{excludeElementsInVAO:n}),o.properties.shaderHash=r;const a=o.data[o.desc.positionAttribute];return a&&a.array&&delete a.array,o}_getTexture(t){const e={type:t.type?$(t.type):"uint8",format:t.format?et(t.format):"rgba",flipY:!!t.flipY},n=t.image;n.array?e.data=n.array:n.mipmap&&(e.mipmap=n.mipmap),e.width=n.width,e.height=n.height;const r=t.sampler||t.texture.sampler;return r&&(r.magFilter&&(e.mag=rt(r.magFilter)),r.minFilter&&(e.min=st(r.minFilter)),r.wrapS&&(e.wrapS=at(r.wrapS)),r.wrapT&&(e.wrapT=at(r.wrapT))),new Zt(e,this._resLoader)}_createTechniqueShader(t,e,n,r,i){const{techniques:s,programs:o,shaders:a}=e,l=s[n],h=o[l.program],c=a[h.vertexShader].content,u=a[h.fragmentShader].content,f={};for(const g in l.uniforms){const t=l.uniforms[g];t.semantic&&(f[t.semantic]=g)}const d=Cr.slice();for(const g in f)d.push({name:f[g],type:"function",fn:(t,e)=>e[Or[g]]});const p=new ce({vert:c,frag:u,uniforms:d,extraCommandProps:r});i&&(p.version=300);const A={};for(const g in l.attributes)A[l.attributes[g].semantic]=g;return{shader:p,filter:e=>e&&e.geometry&&e.geometry.properties.shaderHash===t,uniformSemantics:f,attributeSemantics:A}}dispose(){for(const t in this._khrShaders){const{shader:e}=this._khrShaders[t];e.dispose()}this._khrShaders={}}}var Pr={exports:{}};function kr(t,e,n){n=n||2;var r,i,s,o,a,l,h,c=e&&e.length,u=c?e[0]*n:t.length,f=Rr(t,0,u,n,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=function(t,e,n,r){var i,s,o,a=[];for(i=0,s=e.length;i<s;i++)(o=Rr(t,e[i]*r,i<s-1?e[i+1]*r:t.length,r,!1))===o.next&&(o.steiner=!0),a.push(Gr(o));for(a.sort(Hr),i=0;i<a.length;i++)n=Ur(a[i],n);return n}(t,e,f,n)),t.length>80*n){r=s=t[0],i=o=t[1];for(var p=n;p<u;p+=n)(a=t[p])<r&&(r=a),(l=t[p+1])<i&&(i=l),a>s&&(s=a),l>o&&(o=l);h=0!==(h=Math.max(s-r,o-i))?32767/h:0}return Dr(f,d,n,r,i,h,0),d}function Rr(t,e,n,r,i){var s,o;if(i===ri(t,e,n,r)>0)for(s=e;s<n;s+=r)o=ti(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=ti(s,t[s],t[s+1],o);return o&&Qr(o,o.next)&&(ei(o),o=o.next),o}function Nr(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!Qr(r,r.next)&&0!==Xr(r.prev,r,r.next))r=r.next;else{if(ei(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function Dr(t,e,n,r,i,s,o){if(t){!o&&s&&function(t,e,n,r){var i=t;do{0===i.z&&(i.z=Vr(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,s,o,a,l,h=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,r=n,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1)}(i)}(t,r,i,s);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,s?Lr(t,r,i,s):Fr(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),ei(t),t=l.next,h=l.next;else if((t=l)===h){o?1===o?Dr(t=zr(Nr(t),e,n),e,n,r,i,s,2):2===o&&Br(t,e,n,r,i,s):Dr(Nr(t),e,n,r,i,s,1);break}}}function Fr(t){var e=t.prev,n=t,r=t.next;if(Xr(e,n,r)>=0)return!1;for(var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&qr(i,a,s,l,o,h,p.x,p.y)&&Xr(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function Lr(t,e,n,r){var i=t.prev,s=t,o=t.next;if(Xr(i,s,o)>=0)return!1;for(var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=Vr(d,p,e,n,r),y=Vr(A,g,e,n,r),v=t.prevZ,x=t.nextZ;v&&v.z>=m&&x&&x.z<=y;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&qr(a,c,l,u,h,f,v.x,v.y)&&Xr(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&qr(a,c,l,u,h,f,x.x,x.y)&&Xr(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=m;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&qr(a,c,l,u,h,f,v.x,v.y)&&Xr(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&qr(a,c,l,u,h,f,x.x,x.y)&&Xr(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function zr(t,e,n){var r=t;do{var i=r.prev,s=r.next.next;!Qr(i,s)&&Yr(i,r,r.next,s)&&Jr(i,s)&&Jr(s,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(s.i/n|0),ei(r),ei(r.next),r=t=s),r=r.next}while(r!==t);return Nr(r)}function Br(t,e,n,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Wr(o,a)){var l=$r(o,a);return o=Nr(o,o.next),l=Nr(l,l.next),Dr(o,e,n,r,i,s,0),void Dr(l,e,n,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function Hr(t,e){return t.x-e.x}function Ur(t,e){var n=function(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&qr(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),Jr(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&jr(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}(t,e);if(!n)return e;var r=$r(n,t);return Nr(r,r.next),Nr(n,n.next)}function jr(t,e){return Xr(t.prev,t,e.prev)<0&&Xr(e.next,t,t.next)<0}function Vr(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Gr(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function qr(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function Wr(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Yr(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Jr(t,e)&&Jr(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(Xr(t.prev,t,e.prev)||Xr(t,e.prev,e))||Qr(t,e)&&Xr(t.prev,t,t.next)>0&&Xr(e.prev,e,e.next)>0)}function Xr(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function Qr(t,e){return t.x===e.x&&t.y===e.y}function Yr(t,e,n,r){var i=Kr(Xr(t,e,n)),s=Kr(Xr(t,e,r)),o=Kr(Xr(n,r,t)),a=Kr(Xr(n,r,e));return i!==s&&o!==a||!(0!==i||!Zr(t,n,e))||!(0!==s||!Zr(t,r,e))||!(0!==o||!Zr(n,t,r))||!(0!==a||!Zr(n,e,r))}function Zr(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Kr(t){return t>0?1:t<0?-1:0}function Jr(t,e){return Xr(t.prev,t,t.next)<0?Xr(t,e,t.next)>=0&&Xr(t,t.prev,e)>=0:Xr(t,e,t.prev)<0||Xr(t,t.next,e)<0}function $r(t,e){var n=new ni(t.i,t.x,t.y),r=new ni(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function ti(t,e,n,r){var i=new ni(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function ei(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ni(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ri(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}Pr.exports=kr,Pr.exports.default=kr,kr.deviation=function(t,e,n,r){var i=e&&e.length,s=Math.abs(ri(t,0,i?e[0]*n:t.length,n));if(i)for(var o=0,a=e.length;o<a;o++)s-=Math.abs(ri(t,e[o]*n,o<a-1?e[o+1]*n:t.length,n));var l=0;for(o=0;o<r.length;o+=3){var h=r[o]*n,c=r[o+1]*n,u=r[o+2]*n;l+=Math.abs((t[h]-t[u])*(t[c+1]-t[h+1])-(t[h]-t[c])*(t[u+1]-t[h+1]))}return 0===s&&0===l?0:Math.abs((l-s)/s)},kr.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&n.holes.push(r+=t[i-1].length)}return n};var ii=Pr.exports;const si={parseHDR:Yt},oi={PBRHelper:Kn,StandardMaterial:$n,StandardSpecularGlossinessMaterial:tr,StandardShader:class extends ce{constructor(t={}){let e=t.extraCommandProps||{};const n=t.uniforms;e=u({},e);const r=t.defines||{},s=[],o=[],a=[],l=[],h=[],c=[{name:"modelNormalMatrix",type:"function",fn:(t,e)=>i["b"].fromMat4(s,e.modelMatrix)},{name:"modelViewNormalMatrix",type:"function",fn:(t,e)=>{const n=i["c"].multiply(o,e.viewMatrix,e.modelMatrix),r=i["c"].invert(n,n),s=i["c"].transpose(r,r);return i["b"].fromMat4(a,s)}},{name:"modelViewMatrix",type:"function",fn:(t,e)=>i["c"].multiply(l,e.viewMatrix,e.modelMatrix)},{name:"uEnvironmentTransform",type:"function",fn:(t,e)=>i["b"].fromRotation(h,Math.PI*(e.environmentOrientation||0)/180)}];n&&c.push(...n),super({vert:t.vert||"#include <gl2_vert>\n#define SHADER_NAME PBR\nprecision highp float;\nattribute vec3 aPosition;\n#if defined(HAS_MAP)\nattribute vec2 aTexCoord;\nuniform vec2 uvOrigin;\nuniform vec2 uvScale;\nuniform vec2 uvOffset;\nuniform float uvRotation;\n#ifdef HAS_I3S_UVREGION\nattribute vec4 uvRegion;\nvarying vec4 vUvRegion;\n#endif\n#if defined(HAS_AO_MAP)\nattribute vec2 aTexCoord1;\nvarying vec2 vTexCoord1;\n#endif\n#endif\nvec3 c;\nvec3 d;\nvec4 e;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform mediump vec3 cameraPosition;\nuniform mat3 modelNormalMatrix;\n#ifdef HAS_SSR\nuniform mat3 modelViewNormalMatrix;\nvarying vec3 vViewNormal;\n#ifdef HAS_TANGENT\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelNormal;\nvarying vec4 vViewVertex;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\nvarying vec3 vModelVertex;\n#if defined(HAS_MAP)\nvarying vec2 vTexCoord;\n#endif\n#if defined(HAS_COLOR)\nattribute vec4 aColor;\nvarying vec4 vColor;\n#endif\n#ifdef HAS_OPACITY\nattribute float aOpacity;\n#endif\nvarying float vOpacity;\n#include <highlight_vert>\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nattribute vec3 aColor0;\nvarying vec3 vColor0;\n#else\nattribute vec4 aColor0;\nvarying vec4 vColor0;\n#endif\n#endif\n#include <line_extrusion_vert>\n#include <get_output>\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_vert>\n#endif\n#include <heatmap_render_vert>\n#include <vertex_color_vert>\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#if __VERSION__ == 100\nmat3 f(in mat3 h) {\n  vec3 i = h[0];\n  vec3 j = h[1];\n  vec3 k = h[2];\n  return mat3(vec3(i.x, j.x, k.x), vec3(i.y, j.y, k.y), vec3(i.z, j.z, k.z));\n}\n#else\nmat3 f(in mat3 h) {\n  return transpose(h);\n}\n#endif\n#endif\nvoid l(const highp vec4 q, out highp vec3 m) {\n  m = vec3(.0, .0, 1.) + vec3(2., -2., -2.) * q.x * q.zwx + vec3(2., 2., -2.) * q.y * q.wzy;\n}\nvoid l(const highp vec4 q, out highp vec3 m, out highp vec3 t) {\n  l(q, m);\n  t = vec3(1., .0, .0) + vec3(-2., 2., -2.) * q.y * q.yxw + vec3(-2., 2., 2.) * q.z * q.zwx;\n}\nconst float o = .5;\nvec2 u(vec2 v, float A) {\n  return vec2(cos(A) * (v.x - o) + sin(A) * (v.y - o) + o, cos(A) * (v.y - o) - sin(A) * (v.x - o) + o);\n}\n#if defined(HAS_MAP)\nvec2 B(vec2 v) {\n  vec2 C = decode_getTexcoord(v);\n#ifdef HAS_RANDOM_TEX\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale + uvOffset;\n  return mod(D, 1.) + E;\n#else\nvec2 D = uvOrigin;\n  vec2 E = C * uvScale;\n  if(uvRotation != .0) {\n    D = u(D, uvRotation);\n    E = u(E, uvRotation);\n  }\n  return mod(D, 1.) + E + uvOffset;\n#endif\n}\n#endif\n#ifdef PICKING_MODE\n#include <fbo_picking_vert>\n#endif\n#include <excavate_vert>\nvoid main() {\n  mat4 F = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec3 G = getLineExtrudePosition(aPosition);\n  vec4 H = getPosition(G);\n#else\nvec4 H = getPosition(aPosition);\n#endif\nvModelVertex = (modelMatrix * H).xyz;\n  vec4 I = F * H;\n  vec4 J = modelViewMatrix * I;\n  vViewVertex = J;\n#ifdef HAS_MASK_EXTENT\ngl_Position = projMatrix * getMaskPosition(I, modelMatrix);\n#else\ngl_Position = projMatrix * J;\n#endif\n#ifdef PICKING_MODE\nfloat K = 1.;\n#if defined(HAS_COLOR)\nK *= aColor.a;\n#endif\n#if defined(HAS_COLOR0) && COLOR0_SIZE == 4\nK *= aColor0.a;\n#endif\nfbo_picking_setData(gl_Position.w, K != .0);\n#else\n#if defined(HAS_MAP)\nvTexCoord = B(aTexCoord);\n#ifdef HAS_AO_MAP\nvTexCoord1 = B(aTexCoord1);\n#endif\n#ifdef HAS_I3S_UVREGION\nvUvRegion = uvRegion / 65535.;\n#endif\n#endif\n#if defined(HAS_TANGENT) || defined(HAS_NORMAL)\nmat3 L = mat3(F);\n  mat3 M = modelNormalMatrix * L;\n#if defined(HAS_TANGENT)\nvec3 t;\n  l(aTangent, d, t);\n  vModelTangent = vec4(M * t, aTangent.w);\n#else\nd = decode_getNormal(aNormal);\n#endif\nvec3 N = d;\n  vModelNormal = M * N;\n#else\nd = vec3(.0);\n  vModelNormal = vec3(.0);\n#endif\n#if defined(HAS_TANGENT)\nvModelBiTangent = cross(vModelNormal, vModelTangent.xyz) * sign(aTangent.w);\n#endif\n#ifdef HAS_SSR\nmat3 O = modelViewNormalMatrix * L;\n  vViewNormal = O * d;\n#if defined(HAS_TANGENT)\nvec4 P = vec4(t, aTangent.w);\n  vViewTangent = vec4(O * P.xyz, P.w);\n#endif\n#endif\n#if defined(HAS_COLOR)\nvColor = aColor / 255.;\n#endif\n#ifdef HAS_OPACITY\nvOpacity = aOpacity / 255.;\n#else\nvOpacity = 1.;\n#endif\nhighlight_setVarying();\n#if defined(HAS_COLOR0)\nvColor0 = aColor0 / 255.;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nshadow_computeShadowPars(I);\n#endif\n#ifdef HAS_HEATMAP\nheatmap_compute(projMatrix * modelViewMatrix * F, H);\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nmat3 Q = f(mat3(vModelTangent.xyz, vModelBiTangent, vModelNormal));\n  vTangentViewPos = Q * cameraPosition;\n  vTangentFragPos = Q * vModelVertex;\n#endif\n#ifdef HAS_VERTEX_COLOR\nvertexColor_update();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nvCoordinateTexcoord = getCoordinateTexcoord();\n  vHeight = getWorldHeight();\n#endif\n#endif\n}",frag:t.frag||"#if __VERSION__ == 100\n#if defined(GL_EXT_shader_texture_lod)\n#extension GL_EXT_shader_texture_lod : enable\n#define textureCubeLod(tex, uv, lod) textureCubeLodEXT(tex, uv, lod)\n#else\n#define textureCubeLod(tex, uv, lod) textureCube(tex, uv, lod)\n#endif\n#if defined(GL_OES_standard_derivatives)\n#extension GL_OES_standard_derivatives : enable\n#endif\n#else\n#define textureCubeLod(tex, uv, lod) textureLod(tex, uv, lod)\n#endif\n#define saturate(x)        clamp(x, 0.0, 1.0)\nprecision mediump float;\n#include <gl2_frag>\n#include <hsv_frag>\nuniform vec3 hsv;\nuniform float contrast;\nconst float c = .04;\nstruct MaterialUniforms {\n  vec2 roughnessMetalness;\n  vec3 albedo;\n  float alpha;\n  vec3 normal;\n  vec3 emit;\n  float ao;\n  vec3 specularColor;\n  float glossiness;\n  vec4 skinColor;\n} d;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n#include <vsm_shadow_frag>\n#endif\nuniform vec3 cameraPosition;\nuniform float alphaTest;\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nuniform vec4 diffuseFactor;\nuniform vec3 specularFactor;\nuniform float glossinessFactor;\n#if defined(HAS_DIFFUSE_MAP)\nuniform sampler2D diffuseTexture;\n#endif\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nuniform sampler2D specularGlossinessTexture;\n#endif\n#endif\nuniform vec3 emissiveFactor;\nuniform vec4 baseColorFactor;\nuniform float baseColorIntensity;\nuniform float anisotropyDirection;\nuniform float anisotropyFactor;\nuniform float clearCoatFactor;\nuniform float clearCoatIor;\nuniform float clearCoatRoughnessFactor;\nuniform float clearCoatThickness;\nuniform float emitColorFactor;\nuniform float occlusionFactor;\nuniform float environmentExposure;\nuniform float roughnessFactor;\nuniform float metallicFactor;\nuniform float normalMapFactor;\nuniform float rgbmRange;\nuniform float specularF0;\nuniform int emitMultiplicative;\nuniform int normalMapFlipY;\nuniform int outputSRGB;\nuniform mat3 uEnvironmentTransform;\n#if defined(HAS_ALBEDO_MAP)\nuniform sampler2D baseColorTexture;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nuniform sampler2D metallicRoughnessTexture;\n#endif\n#if defined(HAS_EMISSIVE_MAP)\nuniform sampler2D emissiveTexture;\n#endif\n#if defined(HAS_AO_MAP)\nuniform sampler2D occlusionTexture;\nvarying vec2 vTexCoord1;\n#endif\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nuniform sampler2D normalTexture;\n#endif\n#if defined(HAS_SKIN_MAP)\nuniform sampler2D skinTexture;\n#endif\n#if defined(HAS_ALPHAMODE)\nuniform float alphaCutoff;\n#endif\n#ifdef HAS_RANDOM_TEX\nuniform highp vec2 uvOrigin;\nuniform sampler2D noiseTexture;\n#endif\nuniform sampler2D brdfLUT;\n#if defined(HAS_IBL_LIGHTING)\nuniform vec3 hdrHSV;\nuniform samplerCube prefilterMap;\nuniform vec3 diffuseSPH[9];\nuniform vec2 prefilterMiplevel;\nuniform vec2 prefilterSize;\n#else\nuniform vec3 ambientColor;\n#endif\nuniform vec2 cameraNearFar;\nuniform vec3 clearCoatTint;\nuniform vec3 light0_viewDirection;\nuniform vec4 light0_diffuse;\n#ifdef HAS_SSR\nvarying vec3 vViewNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vViewTangent;\n#endif\n#endif\nvarying vec3 vModelVertex;\nvarying vec4 vViewVertex;\n#if defined(HAS_MAP)\n#include <computeTexcoord_frag>\n#endif\nvarying vec3 vModelNormal;\n#if defined(HAS_TANGENT)\nvarying vec4 vModelTangent;\nvarying vec3 vModelBiTangent;\n#endif\n#if defined(HAS_COLOR0)\n#if COLOR0_SIZE == 3\nvarying vec3 vColor0;\n#else\nvarying vec4 vColor0;\n#endif\n#endif\n#if defined(HAS_COLOR)\nvarying vec4 vColor;\n#elif defined(IS_LINE_EXTRUSION)\nuniform vec4 lineColor;\n#else\nuniform vec4 polygonFill;\n#endif\n#ifdef HAS_LAYER_OPACITY\nuniform float layerOpacity;\n#endif\nvarying float vOpacity;\n#ifdef HAS_INSTANCE_COLOR\nvarying vec4 vInstanceColor;\n#endif\n#ifdef IS_LINE_EXTRUSION\nuniform float lineOpacity;\n#else\nuniform float polygonOpacity;\n#endif\n#ifdef HAS_PATTERN\nuniform sampler2D linePatternFile;\nuniform vec2 atlasSize;\nuniform float flipY;\nuniform float currentTime;\nuniform float animSpeedScale;\n#ifdef HAS_PATTERN_ANIM\nvarying float vLinePatternAnimSpeed;\n#else\nuniform float linePatternAnimSpeed;\n#endif\n#ifdef HAS_PATTERN_GAP\nvarying float vLinePatternGap;\n#else\nuniform float linePatternGap;\n#endif\nuniform vec4 linePatternGapColor;\nuniform vec2 uvScale;\nvarying float vPatternHeight;\nvarying float vLinesofar;\nvarying vec4 vTexInfo;\nvarying float vNormalY;\nvec2 e(vec2 f) {\n  vec2 h = mod(f, 1.);\n  vec2 i = vTexInfo.xy;\n  vec2 j = vTexInfo.zw;\n  return (i + h * j) / atlasSize;\n}\n#endif\n#include <heatmap_render_frag>\n#include <snow_frag>\n#include <mask_frag>\n#include <terrain_normal_frag>\n#include <vertex_color_frag>\n#include <excavate_frag>\n#ifdef HAS_RANDOM_TEX\nconst float k = .5;\nvec2 l(vec2 h, float m) {\n  return vec2(cos(m) * (h.x - k) + sin(m) * (h.y - k) + k, cos(m) * (h.y - k) - sin(m) * (h.x - k) + k);\n}\nfloat n(vec3 o) {\n  return o.x + o.y + o.z;\n}\n#endif\nvec4 u(sampler2D A, in vec2 h) {\n  \n#ifdef HAS_RANDOM_TEX\nhighp vec2 B = uvOrigin;\n  highp vec2 C = h + B - mod(B, 1.);\n  float D = texture2D(noiseTexture, .005 * C).x;\n  vec2 E = dFdx(C);\n  vec2 F = dFdx(C);\n  float G = D * 8.;\n  float H = fract(G);\n#if 1\nfloat I = floor(G);\n  float J = I + 1.;\n#else\nfloat I = floor(G + .5);\n  float J = floor(G);\n  H = min(H, 1. - H) * 2.;\n#endif\nvec2 K = sin(vec2(3., 7.) * I);\n  vec2 L = sin(vec2(3., 7.) * J);\n  float M = .5;\n  vec4 N = texture2DGradEXT(A, h + M * K, E, F);\n  vec4 O = texture2DGradEXT(A, h + M * L, E, F);\n  return mix(N, O, smoothstep(.2, .8, H - .1 * n(N.xyz - O.xyz)));\n#else\nreturn texture2D(A, h);\n#endif\n}\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nuniform sampler2D bumpTexture;\nuniform float bumpScale;\nuniform float bumpMaxLayers;\nuniform float bumpMinLayers;\nvec2 P(vec2 h, vec3 Q) {\n  float R = mix(bumpMaxLayers, bumpMinLayers, abs(dot(vec3(.0, .0, 1.), Q)));\n  float S = 1. / R;\n  float T = .0;\n  vec2 U = Q.xy * bumpScale / (Q.z * R);\n  vec2 V = h;\n  float W = u(bumpTexture, V).r;\n  for(int X = 0; X < 30; X++) {\n    T += S;\n    V -= U;\n    W = u(bumpTexture, V).r;\n    if(W < T) {\n      break;\n    }\n  }\n  vec2 Y = V + U;\n  float Z = W - T;\n  float ba = u(bumpTexture, Y).r - T + S;\n  return mix(V, Y, Z / (Z - ba));\n}\nvarying vec3 vTangentViewPos;\nvarying vec3 vTangentFragPos;\n#endif\n#define SHADER_NAME PBR\nvec3 bb(const in vec3 bc) {\n  return vec3(bc.r < .0031308 ? bc.r * 12.92 : 1.055 * pow(bc.r, 1. / 2.4) - .055, bc.g < .0031308 ? bc.g * 12.92 : 1.055 * pow(bc.g, 1. / 2.4) - .055, bc.b < .0031308 ? bc.b * 12.92 : 1.055 * pow(bc.b, 1. / 2.4) - .055);\n}\nvec3 bd(const in vec3 bc) {\n  return vec3(bc.r < .04045 ? bc.r * (1. / 12.92) : pow((bc.r + .055) * (1. / 1.055), 2.4), bc.g < .04045 ? bc.g * (1. / 12.92) : pow((bc.g + .055) * (1. / 1.055), 2.4), bc.b < .04045 ? bc.b * (1. / 12.92) : pow((bc.b + .055) * (1. / 1.055), 2.4));\n}\nvec3 be(const in vec4 bc, const in float bf) {\n  if(bf <= .0)\n    return bc.rgb;\n  return bf * bc.rgb * bc.a;\n}\nvec3 bg() {\n  return d.albedo;\n}\nfloat bh() {\n  \n#if defined(HAS_ALPHAMODE)\nif(d.alpha >= alphaCutoff) {\n    return 1.;\n  } else {\n    return .0;\n  }\n#else\nreturn d.alpha;\n#endif\n}\nfloat bi() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 bc = d.specularColor;\n  return max(max(bc.r, bc.g), bc.b);\n#else\nreturn d.roughnessMetalness.y;\n#endif\n}\nfloat bj() {\n  return specularF0;\n}\nfloat bk() {\n  \n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nreturn 1. - d.glossiness;\n#else\nreturn d.roughnessMetalness.x;\n#endif\n}\nvec3 bl() {\n  return d.emit;\n}\nvec4 bm() {\n  return d.skinColor;\n}\nvec3 bn() {\n  return d.normal;\n}\nfloat bo() {\n  return clearCoatFactor;\n}\nfloat bp() {\n  return clearCoatRoughnessFactor;\n}\nfloat bq() {\n  return d.ao;\n}\nfloat br(const in vec4 bs) {\n  return bs.r + bs.g / 255.;\n}\nfloat bt(const in vec2 bu, const in float bv) {\n  vec3 bw = vec3(.06711056, .00583715, 52.9829189);\n  return fract(bw.z * fract(dot(bu.xy + bv * vec2(47., 17.) * .695, bw.xy))) * .5;\n}\nvec3 bx(const in float by, in vec3 bz, const in vec3 t, const in vec3 b, in vec3 bA) {\n  bz.xy = by * bz.xy;\n  mat3 bB = mat3(t, b, bA);\n  return normalize(bB * bz);\n}\nvoid bC(const in vec3 bD, const in vec3 bz, const in vec3 bE, out float bF, out vec3 bG, out float bH) {\n  bF = 1.;\n  bG = -bE;\n  bH = dot(bG, bz);\n}\nvec4 bI(const in vec3 bz, const in vec3 bD, const in float bJ) {\n  float bK = clamp(dot(bz, bD), 0., 1.);\n  float bL = bJ * bJ;\n  return vec4(bL, bL * bL, bK, bK * (1. - bL));\n}\nfloat bM(const vec4 bI, const float bN) {\n  float bO = bI.y;\n  float bP = (bN * bO - bN) * bN + 1.;\n  return bO / (3.141593 * bP * bP);\n}\nvec3 bQ(const vec3 bR, const float bS, const in float bT) {\n  float bU = pow(1. - bT, 5.);\n  return bS * bU + (1. - bU) * bR;\n}\nfloat bQ(const float bR, const float bS, const in float bT) {\n  return bR + (bS - bR) * pow(1. - bT, 5.);\n}\nfloat bV(const vec4 bI, const float bW) {\n  float a = bI.x;\n  float bX = bW * (bI.w + a);\n  float bY = bI.z * (bW * (1. - a) + a);\n  return .5 / (bX + bY);\n}\nvec3 bZ(const vec4 bI, const vec3 bz, const vec3 bD, const vec3 bG, const vec3 ca, const float bW, const float bS) {\n  vec3 cb = normalize(bD + bG);\n  float bN = clamp(dot(bz, cb), 0., 1.);\n  float bT = clamp(dot(bG, cb), 0., 1.);\n  float cc = bM(bI, bN);\n  float cd = bV(bI, bW);\n  vec3 ce = bQ(ca, bS, bT);\n  return (cc * cd * 3.141593) * ce;\n}\nvoid cf(const in vec3 bz, const in vec3 bD, const in float bW, const in vec4 bI, const in vec3 cg, const in vec3 ca, const in float bF, const in vec3 ch, const in vec3 bG, const in float bS, out vec3 ci, out vec3 cj, out bool ck) {\n  ck = bW > .0;\n  if(ck == false) {\n    cj = ci = vec3(.0);\n    return;\n  }\n  vec3 cl = bF * bW * ch;\n  cj = cl * bZ(bI, bz, bD, bG, ca, bW, bS);\n  ci = cl * cg;\n}\nfloat cm(float at, float ab, float cn, float co, float cp, float cq, float bK, float bW) {\n  float cr = bW * length(vec3(at * cn, ab * co, bK));\n  float cs = bK * length(vec3(at * cp, ab * cq, bW));\n  return .5 / (cr + cs);\n}\nfloat ct(const float at, const float ab, const float cu, const float cv, const float bN) {\n  float bO = at * ab;\n  vec3 bP = vec3(ab * cu, at * cv, bO * bN);\n  float x = bO / dot(bP, bP);\n  return bO * (x * x) / 3.141593;\n}\nvec3 cw(const vec4 bI, const vec3 bz, const vec3 bD, const vec3 bG, const vec3 ca, const float bW, const float bS, const in vec3 cx, const in vec3 cy, const in float cz) {\n  vec3 cb = normalize(bD + bG);\n  float bN = clamp(dot(bz, cb), 0., 1.);\n  float bK = clamp(dot(bz, bD), 0., 1.);\n  float bT = clamp(dot(bG, cb), 0., 1.);\n  float cn = dot(cx, bD);\n  float co = dot(cy, bD);\n  float cp = dot(cx, bG);\n  float cq = dot(cy, bG);\n  float cu = dot(cx, cb);\n  float cv = dot(cy, cb);\n  float cA = sqrt(1. - abs(cz) * .9);\n  if(cz > .0)\n    cA = 1. / cA;\n  float at = bI.x * cA;\n  float ab = bI.x / cA;\n  float cc = ct(at, ab, cu, cv, bN);\n  float cd = cm(at, ab, cn, co, cp, cq, bK, bW);\n  vec3 ce = bQ(ca, bS, bT);\n  return (cc * cd * 3.141593) * ce;\n}\nvoid cB(const in vec3 bz, const in vec3 bD, const in float bW, const in vec4 bI, const in vec3 cg, const in vec3 ca, const in float bF, const in vec3 ch, const in vec3 bG, const in float bS, const in vec3 cx, const in vec3 cy, const in float cz, out vec3 ci, out vec3 cj, out bool ck) {\n  ck = bW > .0;\n  if(ck == false) {\n    cj = ci = vec3(.0);\n    return;\n  }\n  vec3 cl = bF * bW * ch;\n  cj = cl * cw(bI, bz, bD, bG, ca, bW, bS, cx, cy, cz);\n  ci = cl * cg;\n}\n#if defined(HAS_IBL_LIGHTING)\nvec3 cC(const in vec3 bz) {\n  vec3 bA = uEnvironmentTransform * bz;\n  float x = bA.x;\n  float y = bA.y;\n  float z = bA.z;\n  vec3 cD = (diffuseSPH[0] + diffuseSPH[1] * x + diffuseSPH[2] * y + diffuseSPH[3] * z + diffuseSPH[4] * z * x + diffuseSPH[5] * y * z + diffuseSPH[6] * y * x + diffuseSPH[7] * (3. * z * z - 1.) + diffuseSPH[8] * (x * x - y * y));\n  if(length(hdrHSV) > .0) {\n    cD = hsv_apply(cD, hdrHSV);\n  }\n  return max(cD, vec3(.0));\n}\nfloat cE(const in float cF) {\n  return cF;\n}\nvec3 cG(const in float cH, const in vec3 cI) {\n  vec3 cJ = cI;\n  float cK = prefilterMiplevel.x;\n  float cL = min(cK, cE(cH) * prefilterMiplevel.y);\n  vec3 cM = be(textureCubeLod(prefilterMap, cJ, cL), rgbmRange);\n  if(length(hdrHSV) > .0) {\n    return hsv_apply(cM, hdrHSV);\n  } else {\n    return cM;\n  }\n}\nvec3 cN(const in vec3 cO, const in vec3 cI, const in float cP) {\n  float cQ = 1. - cP;\n  float cR = cQ * (sqrt(cQ) + cP);\n  return mix(cO, cI, cR);\n}\nvec3 cS(const in vec3 bz, const in vec3 bD, const in float bJ, const in vec3 cT) {\n  vec3 cI = reflect(-bD, bz);\n  cI = cN(bz, cI, bJ);\n  vec3 cU = cG(bJ, uEnvironmentTransform * cI);\n  float by = clamp(1. + dot(cI, cT), .0, 1.);\n  cU *= by * by;\n  return cU;\n}\n#else\nvec3 cS(const in vec3 bz, const in vec3 bD, const in float bJ, const in vec3 cT) {\n  return ambientColor;\n}\n#endif\nvec3 cV(const in vec3 ca, const in float bJ, const in float bK, const in float bS) {\n  vec4 rgba = texture2D(brdfLUT, vec2(bK, bJ));\n  float b = (rgba[3] * 65280.0 + rgba[2] * 255.);\n  float a = (rgba[1] * 65280.0 + rgba[0] * 255.);\n  const float cW = 1. / 65535.;\n  return (ca * a + b * bS) * cW;\n}\nvec3 cX(const in vec3 bz, const in vec3 bD, const in float bJ, const in vec3 ca, const in vec3 cT, const in float bS) {\n  float bK = dot(bz, bD);\n  return cS(bz, bD, bJ, cT) * cV(ca, bJ, bK, bS);\n}\nvec3 cY(const float bK, const float bW, const vec3 cZ, const float bP) {\n  return exp(cZ * -bP * ((bW + bK) / max(bW * bK, 1e-3)));\n}\nvec3 da(const in float bK, const in float bW, const in float db) {\n  return mix(vec3(1.), cY(bK, bW, clearCoatTint, clearCoatThickness), db);\n}\nvoid dc(const in float dd, const in vec3 bz, const in vec3 bD, const in float bH, const in vec4 bI, const in float bF, const in vec3 ch, const in vec3 bG, const in float db, out vec3 de, out vec3 df) {\n  if(bH <= .0) {\n    de = vec3(.0);\n    df = vec3(.0);\n    return;\n  }\n  float dg = clamp(dot(bz, -refract(bG, bz, 1. / clearCoatIor)), 0., 1.);\n  vec3 dh = da(dd, dg, db);\n  vec3 cb = normalize(bD + bG);\n  float bN = clamp(dot(bz, cb), 0., 1.);\n  float bT = clamp(dot(bG, cb), 0., 1.);\n  float cc = bM(bI, bN);\n  float cd = bV(bI, dg);\n  float ce = bQ(c, 1., bT);\n  de = (bF * bH * db * cc * cd * 3.141593 * ce) * ch;\n  df = (1. - ce * db) * dh;\n}\nfloat di(const in int dj, const in float dk, const in vec3 bz, const in vec3 bD) {\n  if(dj == 0)\n    return 1.;\n  float bP = dot(bz, bD) + dk;\n  return clamp(bP * bP - 1. + dk, .0, 1.);\n}\nvec3 dl(const in vec3 bz, const in vec3 bD, const in float bJ, const in vec3 cx, const in vec3 cy, const in float cz) {\n  vec3 dm = cz >= .0 ? cy : cx;\n  vec3 dn = cross(dm, bD);\n  vec3 dp = cross(dn, dm);\n  float dq = abs(cz) * clamp(5. * bJ, .0, 1.);\n  return normalize(mix(bz, dp, dq));\n}\nvoid dr() {\n  \n#ifdef HAS_MAP\nvec2 h = computeTexCoord(vTexCoord);\n#endif\n#ifdef HAS_UV_FLIP\nh.y = 1. - h.y;\n#endif\n#if defined(HAS_BUMP_MAP) && defined(HAS_TANGENT)\nh = P(h, normalize(vTangentViewPos - vTangentFragPos));\n#endif\nd.albedo = baseColorIntensity * baseColorFactor.rgb;\n  d.alpha = baseColorFactor.a * vOpacity;\n#if defined(HAS_PATTERN)\nfloat ds = vLinesofar;\n  vec2 j = vTexInfo.zw;\n#ifdef HAS_PATTERN_GAP\nfloat dt = vLinePatternGap;\n#else\nfloat dt = linePatternGap;\n#endif\n#ifdef HAS_PATTERN_ANIM\nfloat du = vLinePatternAnimSpeed;\n#else\nfloat du = linePatternAnimSpeed;\n#endif\nfloat dv = ceil(j.x * vPatternHeight / j.y);\n  float dw = dv * (1. + dt);\n  du /= animSpeedScale;\n  ds += mod(currentTime * -du * .2, dw);\n  float dx = mod(ds / dw, 1.);\n  float dy = mod(flipY * vNormalY, 1.);\n  vec2 h = e(vec2(dx * (1. + dt) * uvScale[0], dy * uvScale[1]));\n  vec4 dz = texture2D(linePatternFile, h);\n  float dA = clamp(sign(1. / (1. + dt) - dx) + .000001, .0, 1.);\n  dz = mix(linePatternGapColor, dz, dA);\n#ifdef IS_SQUARE_TUBE\nfloat o = clamp(sign(abs(vNormalY) - .999999), .0, 1.);\n  dz = mix(dz, vec4(1.), o);\n#endif\nd.albedo *= dz.rgb;\n  d.alpha *= dz.a;\n#endif\n#if defined(HAS_ALBEDO_MAP)\nvec4 dB = u(baseColorTexture, h);\n  d.albedo *= bd(dB.rgb);\n  d.alpha *= dB.a;\n#endif\n#if defined(HAS_SKIN_MAP)\nvec4 dC = u(skinTexture, h);\n  d.skinColor = dC;\n#endif\n#if defined(HAS_COLOR0)\nd.albedo *= vColor0.rgb;\n#if COLOR0_SIZE == 4\nd.alpha *= vColor0.a;\n#endif\n#endif\n#if defined(HAS_COLOR)\nd.albedo *= vColor.rgb;\n  d.alpha *= vColor.a;\n#elif defined(IS_LINE_EXTRUSION)\nd.albedo *= lineColor.rgb;\n  d.alpha *= lineColor.a;\n#else\nd.albedo *= polygonFill.rgb;\n  d.alpha *= polygonFill.a;\n#endif\n#if defined(HAS_INSTANCE_COLOR)\nd.albedo *= vInstanceColor.rgb;\n  d.alpha *= vInstanceColor.a;\n#endif\n#if defined(IS_LINE_EXTRUSION)\nd.alpha *= lineOpacity;\n#else\nd.alpha *= polygonOpacity;\n#endif\n#if defined(HAS_METALLICROUGHNESS_MAP)\nd.roughnessMetalness = u(metallicRoughnessTexture, h).gb * vec2(roughnessFactor, metallicFactor);\n#else\nd.roughnessMetalness = vec2(roughnessFactor, metallicFactor);\n#endif\nd.emit = emissiveFactor;\n#if defined(HAS_EMISSIVE_MAP)\nif(emitMultiplicative == 1) {\n    d.emit *= bd(u(emissiveTexture, h).rgb);\n  } else {\n    d.emit += bd(u(emissiveTexture, h).rgb);\n  }\n#endif\nd.emit *= emitColorFactor;\n#if defined(HAS_AO_MAP)\nvec2 dD = computeTexCoord(vTexCoord1);\n  d.ao = u(occlusionTexture, dD).r;\n#else\nd.ao = 1.;\n#endif\nd.ao *= occlusionFactor;\n#if defined(HAS_NORMAL_MAP) && defined(HAS_TANGENT)\nvec3 dE = u(normalTexture, h).xyz * 2. - 1.;\n  dE.y = normalMapFlipY == 1 ? -dE.y : dE.y;\n  d.normal = dE;\n#else\nd.normal = normalize(vModelNormal);\n#endif\n#if defined(HAS_TERRAIN_NORMAL) && defined(HAS_TANGENT)\nvec3 dE = convertTerrainHeightToNormalMap(h);\n  dE.y = normalMapFlipY == 1 ? -dE.y : dE.y;\n  d.normal = dE;\n#endif\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nd.albedo *= diffuseFactor.rgb;\n  d.alpha *= diffuseFactor.a;\n#if defined(HAS_DIFFUSE_MAP)\nvec4 cg = u(diffuseTexture, h);\n  d.albedo *= bd(cg.rgb);\n  d.alpha *= cg.a;\n#endif\nd.specularColor = specularFactor;\n  d.glossiness = glossinessFactor;\n#if defined(HAS_SPECULARGLOSSINESS_MAP)\nvec4 dF = u(specularGlossinessTexture, h);\n  d.specularColor *= bd(dF.rgb);\n  d.glossiness *= dF.a;\n#endif\n#endif\n}\nvec3 dG(const vec3 x) {\n  const float a = 2.51;\n  const float b = .03;\n  const float dH = 2.43;\n  const float bP = .59;\n  const float dI = .14;\n  return (x * (a * x + b)) / (x * (dH * x + bP) + dI);\n}\nvec3 dJ(vec3 bc) {\n  bc = dG(bc);\n  return bc = pow(bc, vec3(1. / 2.2));\n}\nuniform float specularAAVariance;\nuniform float specularAAThreshold;\nfloat dK(float bJ, const vec3 dL) {\n  \n#if defined(GL_OES_standard_derivatives) || __VERSION__ == 300\nvec3 dM = dFdx(dL);\n  vec3 dN = dFdy(dL);\n  float dO = specularAAVariance * (dot(dM, dM) + dot(dN, dN));\n  float dP = min(2. * dO, specularAAThreshold);\n  float dQ = saturate(bJ * bJ + dP);\n  return sqrt(dQ);\n#else\nreturn bJ;\n#endif\n}\n#ifdef HAS_SSR\nuniform sampler2D TextureDepth;\nuniform highp vec2 outSize;\nuniform float ssrFactor;\nuniform float ssrQuality;\nuniform sampler2D TextureReflected;\nuniform highp mat4 projMatrix;\nuniform mat4 invProjMatrix;\nuniform vec4 outputFovInfo[2];\nuniform mat4 reprojViewProjMatrix;\nvec3 dR(const in mat4 dS, const in vec3 dT) {\n  vec4 dU = dS * vec4(dT, 1.);\n  return vec3(.5 + .5 * dU.xy / dU.w, dU.w);\n}\nvec3 dV(const in float dW, const in vec2 h) {\n  return texture2D(TextureReflected, h).rgb;\n}\nfloat dX(float dY) {\n  highp mat4 dS = projMatrix;\n  highp float z = dY * 2. - 1.;\n  return -dS[3].z / (z + dS[2].z);\n}\nfloat dZ(const vec2 h) {\n  float dY = br(texture2D(TextureDepth, h));\n  return dY;\n}\nvec3 ea(const in float bv, const in vec3 eb, const in vec3 ec, const in vec3 ed, const in vec3 bD, const in float ee) {\n  vec2 ef;\n  ef.x = bt(gl_FragCoord.yx, bv);\n  ef.y = fract(ef.x * 52.9829189);\n  ef.y = mix(ef.y, 1., .7);\n  float eg = 2. * 3.14159 * ef.x;\n  float eh = pow(max(ef.y, .000001), ee / (2. - ee));\n  float ei = sqrt(1. - eh * eh);\n  vec3 ej = vec3(ei * cos(eg), ei * sin(eg), eh);\n  ej = ej.x * eb + ej.y * ec + ej.z * ed;\n  return normalize((2. * dot(bD, ej)) * ej - bD);\n}\nfloat ek(const in float bv) {\n  return (bt(gl_FragCoord.xy, bv) - .5);\n}\nvec3 el(const in vec3 em, const in float en, const in vec3 eo) {\n  vec3 ep = dR(projMatrix, vViewVertex.xyz + eo * en);\n  ep.z = 1. / ep.z;\n  ep -= em;\n  float eq = min(1., .99 * (1. - em.x) / max(1e-5, ep.x));\n  float er = min(1., .99 * (1. - em.y) / max(1e-5, ep.y));\n  float es = min(1., .99 * em.x / max(1e-5, -ep.x));\n  float et = min(1., .99 * em.y / max(1e-5, -ep.y));\n  return ep * min(eq, er) * min(es, et);\n}\nfloat eu(const in vec3 em, const in vec3 ep, inout float ev, inout float ew) {\n  float ex = (ew + ev) * .5;\n  vec3 ey = em + ep * ex;\n  float z = dZ(ey.xy);\n  float dY = dX(z);\n  float ez = -1. / ey.z;\n  ev = dY > ez ? ev : ex;\n  ew = dY > ez ? ex : ew;\n  return ex;\n}\nvec4 eA(const in vec3 em, const in float en, in float eB, const in vec3 eo, const in float bJ, const in float bv) {\n  int eC = 20;\n  float eD = 1. / float(eC);\n  eB *= eD;\n  vec3 ep = el(em, en, eo);\n  float eE = eD;\n  vec3 eF = vec3(.0, eE, 1.);\n  vec3 ey;\n  float z, dY, ez, eG, eH, eI;\n  bool eJ;\n  float eK = 1.;\n  float ex;\n  for(int X = 0; X < eC; X++) {\n    ey = em + ep * eF.y;\n    z = dZ(ey.xy);\n    dY = dX(z);\n    ez = -1. / ey.z;\n    float eL = clamp(sign(.999 - z), .0, 1.);\n    eG = eL * (ez - dY);\n    eG *= clamp(sign(abs(eG) - en * eD * eD), .0, 1.);\n    eJ = abs(eG + eB) < eB;\n    eH = clamp(eF.x / (eF.x - eG), .0, 1.);\n    eI = eJ ? eF.y + eH * eD - eD : 1.;\n    eF.z = min(eF.z, eI);\n    eF.x = eG;\n    if(eJ) {\n      float ev = eF.y - eD;\n      float ew = eF.y;\n      ex = eu(em, ep, ev, ew);\n      ex = eu(em, ep, ev, ew);\n      ex = eu(em, ep, ev, ew);\n      eK = ex;\n      break;\n    }\n    eF.y += eD;\n  }\n  return vec4(em + ep * eK, 1. - eK);\n}\nvec4 eM(in vec4 eN, const in float eO, const in vec3 eP, const in vec3 eQ, const in float bJ) {\n  vec4 eR = mix(outputFovInfo[0], outputFovInfo[1], eN.x);\n  eN.xyz = vec3(mix(eR.xy, eR.zw, eN.y), 1.) * -1. / eN.z;\n  eN.xyz = (reprojViewProjMatrix * vec4(eN.xyz, 1.)).xyw;\n  eN.xy /= eN.z;\n  float eS = clamp(6. - 6. * max(abs(eN.x), abs(eN.y)), .0, 1.);\n  eN.xy = .5 + .5 * eN.xy;\n  vec3 eT = eQ * dV(bJ * (1. - eN.w), eN.xy);\n  return vec4(mix(eP, eT, eO * eS), 1.);\n}\nvec3 ssr(const in vec3 eP, const in vec3 eQ, const in float bJ, const in vec3 bz, const in vec3 bD) {\n  float eU = .0;\n  vec4 cD = vec4(.0);\n  float ee = bJ * bJ;\n  ee = ee * ee;\n  vec3 eV = abs(bz.z) < .999 ? vec3(.0, .0, 1.) : vec3(1., .0, .0);\n  vec3 eb = normalize(cross(eV, bz));\n  vec3 ec = cross(bz, eb);\n  float eO = ssrFactor * clamp(-4. * dot(bD, bz) + 3.8, .0, 1.);\n  eO *= clamp(4.7 - bJ * 5., .0, 1.);\n  vec3 em = dR(projMatrix, vViewVertex.xyz);\n  em.z = 1. / em.z;\n  vec3 eo = ea(eU, eb, ec, bz, bD, ee);\n  float en = mix(cameraNearFar.y + vViewVertex.z, -vViewVertex.z - cameraNearFar.x, eo.z * .5 + .5);\n  float eB = .5 * en;\n  vec4 eN;\n  if(dot(eo, bz) > .001 && eO > .0) {\n    eN = eA(em, en, eB, eo, bJ, eU);\n    if(eN.w > .0)\n      cD += eM(eN, eO, eP, eQ, bJ);\n    \n  }\n  return cD.w > .0 ? cD.rgb / cD.w : eP;\n}\n#endif\n#include <highlight_frag>\nvoid main() {\n  dr();\n  vec3 bD = normalize(cameraPosition - vModelVertex.xyz);\n#if defined(HAS_DOUBLE_SIDE)\nvec3 cT = gl_FrontFacing ? normalize(vModelNormal) : -normalize(vModelNormal);\n#else\nvec3 cT = normalize(vModelNormal);\n#endif\n#if defined(HAS_TANGENT)\nvec4 eW;\n  eW = vModelTangent;\n#if defined(HAS_DOUBLE_SIDE)\neW.xyz = gl_FrontFacing ? normalize(eW.xyz) : -normalize(eW.xyz);\n#else\neW.xyz = normalize(eW.xyz);\n#endif\nvec3 eX = normalize(vModelBiTangent);\n#endif\nfloat bR = .08 * bj();\n  float eY = bi();\n  vec3 eZ = bg();\n#if defined(SHADING_MODEL_SPECULAR_GLOSSINESS)\nvec3 fa = d.specularColor;\n#else\nvec3 fa = mix(vec3(bR), eZ, eY);\n#endif\neZ *= 1. - eY;\n  float fb = clamp(50.0 * fa.g, .0, 1.);\n  float fc = bk();\n  if(specularAAVariance > .0) {\n    fc = dK(fc, cT);\n  }\n  vec3 fd = bl();\n  vec3 fe = bn();\n  vec3 ff = vec3(fe);\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nff = bx(normalMapFactor, ff, eW.xyz, eX, cT);\n#endif\nfloat fg = bo();\n  float fh = bp();\n  if(specularAAVariance > .0) {\n    fh = dK(fh, cT);\n  }\n  vec3 fi = cT;\n#if defined(HAS_TANGENT)\nfloat cz;\n  vec3 cx;\n  vec3 cy;\n  if(anisotropyFactor > .0) {\n    cz = anisotropyFactor;\n    eW.xyz = normalize(eW.xyz - ff * dot(eW.xyz, ff));\n    eX = normalize(cross(ff, eW.xyz)) * eW.w;\n    cx = normalize(mix(eW.xyz, eX, anisotropyDirection));\n    cy = normalize(mix(eX, -eW.xyz, anisotropyDirection));\n  }\n#endif\nvec3 cg = vec3(.0);\n  vec3 ca = vec3(.0);\n  vec3 fj;\n#if defined(HAS_TANGENT)\nif(anisotropyFactor > .0) {\n    fj = dl(ff, bD, fc, cx, cy, cz);\n  } else {\n    fj = ff;\n  }\n#else\nfj = ff;\n#endif\n#if defined(HAS_IBL_LIGHTING)\ncg = eZ * cC(ff) * .5;\n#else\ncg = eZ * ambientColor;\n#endif\nca = cX(fj, bD, fc, fa, cT, fb);\n  float dd;\n  if(clearCoatFactor > .0) {\n    dd = clamp(dot(fi, -refract(bD, fi, 1. / clearCoatIor)), 0., 1.);\n    float fk = fg * bQ(c, 1., dd);\n    vec3 fl = da(dd, dd, fg);\n    ca = mix(ca * fl, cS(fi, bD, fh, cT), fk);\n    cg *= fl * (1. - fk);\n  }\n  float fm = 1.;\n  float fn = bq();\n  cg *= environmentExposure * fn;\n#ifdef HAS_IBL_LIGHTING\nfm = di(1, fn, ff, bD);\n#endif\n#ifdef HAS_SSR\nvec3 fo = normalize(gl_FrontFacing ? vViewNormal : -vViewNormal);\n  vec3 fp = fo;\n#if defined(HAS_TANGENT) && (defined(HAS_NORMAL_MAP) || defined(HAS_TERRAIN_NORMAL))\nvec4 fq;\n  fq = vViewTangent;\n  fq = gl_FrontFacing ? fq : -fq;\n  fq.xyz = normalize(fq.xyz);\n  vec3 fr = normalize(cross(fo, fq.xyz)) * fq.w;\n  fp = bx(normalMapFactor, fe, fq.xyz, fr, fo);\n#endif\nca = ssr(ca, fa * fm, fc, fp, -normalize(vViewVertex.xyz));\n#endif\nca *= environmentExposure * fm;\n  float bF, bH;\n  vec3 bG;\n  bool ck;\n  vec3 fs;\n  vec3 ft;\n  vec4 fu = bI(ff, bD, max(.045, fc));\n  vec3 fv = vModelNormal;\n  bC(bD, ff, light0_viewDirection, bF, bG, bH);\n#if defined(HAS_TANGENT)\nif(anisotropyFactor > .0) {\n    cB(ff, bD, bH, fu, eZ, fa, bF, light0_diffuse.rgb, bG, fb, cx, cy, cz, ft, fs, ck);\n  } else {\n    cf(ff, bD, bH, fu, eZ, fa, bF, light0_diffuse.rgb, bG, fb, ft, fs, ck);\n  }\n#else\ncf(ff, bD, bH, fu, eZ, fa, bF, light0_diffuse.rgb, bG, fb, ft, fs, ck);\n#endif\nif(clearCoatFactor > .0) {\n    vec3 fw;\n    vec3 fx;\n    vec4 fy = bI(fi, bD, fh);\n    dc(dd, fi, bD, dot(fi, bG), fy, bF, light0_diffuse.rgb, bG, fg, fw, fx);\n    ft *= fx;\n    fs = fw + fs * fx;\n  }\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\nfloat fz = shadow_computeShadow();\n  ft = shadow_blend(ft, fz).rgb;\n  fs = shadow_blend(fs, fz).rgb;\n#endif\nvec3 fA = vec3(ca);\n  vec3 fB = vec3(cg);\n  cg += ft;\n  ca += fs;\n  cg += fd;\n  vec3 fC = ca + cg;\n  if(outputSRGB == 1)\n    fC = bb(fC);\n  \n#ifdef HAS_SKIN_MAP\nvec4 fD = bm();\n  fC.rgb = fC.rgb * (1. - fD.a) + fD.rgb * fD.a;\n#endif\nfloat fE = bh();\n  glFragColor = vec4(fC * fE, fE);\n  if(glFragColor.a < alphaTest) {\n    discard;\n  }\n#ifdef HAS_VERTEX_COLOR\nglFragColor *= vertexColor_get();\n#endif\n#ifdef HAS_EXCAVATE_ANALYSIS\nglFragColor = excavateColor(glFragColor);\n#endif\n#ifdef HAS_HEATMAP\nglFragColor = heatmap_getColor(glFragColor);\n#endif\n#ifdef HAS_SNOW\nglFragColor.rgb = snow(glFragColor, bn(), 1.);\n#endif\nif(contrast != 1.) {\n    glFragColor = contrastMatrix(contrast) * glFragColor;\n  }\n  if(length(hsv) > .0) {\n    glFragColor = hsv_apply(glFragColor, hsv);\n  }\n#ifdef OUTPUT_NORMAL\nglFragColor = vec4(cT, 1.);\n#endif\nglFragColor = highlight_blendColor(glFragColor);\n#ifdef HAS_LAYER_OPACITY\nglFragColor *= layerOpacity;\n#endif\n#ifdef HAS_MASK_EXTENT\nglFragColor = setMask(glFragColor);\n#endif\n#if __VERSION__ == 100\ngl_FragColor = glFragColor;\n#endif\n}",uniforms:c,extraCommandProps:e,defines:r}),this.version=300}getGeometryDefines(t){const e={};return t.data[t.desc.tangentAttribute]?e.HAS_TANGENT=1:t.data[t.desc.normalAttribute]&&(e.HAS_NORMAL=1),t.data[t.desc.colorAttribute]&&(e.HAS_COLOR=1),t.data[t.desc.color0Attribute]&&(e.HAS_COLOR0=1,e.COLOR0_SIZE=t.getColor0Size()),e}},StandardDepthShader:class extends ce{constructor(t={}){const e=[];super({vert:"#define SHADER_NAME depth_vert\nprecision highp float;\nattribute vec3 aPosition;\n#include <line_extrusion_vert>\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform mat4 projMatrix;\nuniform vec2 outSize;\nuniform vec2 halton;\n#include <get_output>\nvoid main() {\n  mat4 c = getPositionMatrix();\n#ifdef IS_LINE_EXTRUSION\nvec4 d = getPosition(getLineExtrudePosition(aPosition));\n#else\nvec4 d = getPosition(aPosition);\n#endif\nvec4 e = modelViewMatrix * c * d;\n  mat4 f = projMatrix;\n  f[2].xy += halton.xy / outSize.xy;\n  gl_Position = f * e;\n}",frag:"#define SHADER_NAME depth_frag\nprecision highp float;\nvoid main() {\n  gl_FragColor = vec4(1., .0, .0, 1.);\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,n)=>i["c"].multiply(e,n.viewMatrix,n.modelMatrix)}],extraCommandProps:t.extraCommandProps,defines:t.defines})}},PBRUtils:sr}},c3b8:function(t,e,n){"use strict";n.d(e,"a",(function(){return r})),n.d(e,"b",(function(){return i})),n.d(e,"c",(function(){return s})),n.d(e,"d",(function(){return l})),n.d(e,"e",(function(){return h})),n.d(e,"f",(function(){return o})),n.d(e,"g",(function(){return a}));var r={};n.r(r),n.d(r,"create",(function(){return d})),n.d(r,"clone",(function(){return p})),n.d(r,"copy",(function(){return A})),n.d(r,"identity",(function(){return g})),n.d(r,"fromValues",(function(){return m})),n.d(r,"set",(function(){return y})),n.d(r,"transpose",(function(){return v})),n.d(r,"invert",(function(){return x})),n.d(r,"adjoint",(function(){return b})),n.d(r,"determinant",(function(){return w})),n.d(r,"multiply",(function(){return _})),n.d(r,"rotate",(function(){return M})),n.d(r,"scale",(function(){return T})),n.d(r,"fromRotation",(function(){return S})),n.d(r,"fromScaling",(function(){return I})),n.d(r,"str",(function(){return C})),n.d(r,"frob",(function(){return O})),n.d(r,"LDU",(function(){return E})),n.d(r,"add",(function(){return P})),n.d(r,"subtract",(function(){return k})),n.d(r,"exactEquals",(function(){return R})),n.d(r,"equals",(function(){return N})),n.d(r,"multiplyScalar",(function(){return D})),n.d(r,"multiplyScalarAndAdd",(function(){return F})),n.d(r,"mul",(function(){return L})),n.d(r,"sub",(function(){return z}));var i={};n.r(i),n.d(i,"create",(function(){return B})),n.d(i,"fromMat4",(function(){return H})),n.d(i,"clone",(function(){return U})),n.d(i,"copy",(function(){return j})),n.d(i,"fromValues",(function(){return V})),n.d(i,"set",(function(){return G})),n.d(i,"identity",(function(){return q})),n.d(i,"transpose",(function(){return W})),n.d(i,"invert",(function(){return X})),n.d(i,"adjoint",(function(){return Q})),n.d(i,"determinant",(function(){return Y})),n.d(i,"multiply",(function(){return Z})),n.d(i,"translate",(function(){return K})),n.d(i,"rotate",(function(){return J})),n.d(i,"scale",(function(){return $})),n.d(i,"fromTranslation",(function(){return tt})),n.d(i,"fromRotation",(function(){return et})),n.d(i,"fromScaling",(function(){return nt})),n.d(i,"fromMat2d",(function(){return rt})),n.d(i,"fromQuat",(function(){return it})),n.d(i,"normalFromMat4",(function(){return st})),n.d(i,"projection",(function(){return ot})),n.d(i,"str",(function(){return at})),n.d(i,"frob",(function(){return lt})),n.d(i,"add",(function(){return ht})),n.d(i,"subtract",(function(){return ct})),n.d(i,"multiplyScalar",(function(){return ut})),n.d(i,"multiplyScalarAndAdd",(function(){return ft})),n.d(i,"exactEquals",(function(){return dt})),n.d(i,"equals",(function(){return pt})),n.d(i,"mul",(function(){return At})),n.d(i,"sub",(function(){return gt}));var s={};n.r(s),n.d(s,"create",(function(){return mt})),n.d(s,"clone",(function(){return yt})),n.d(s,"copy",(function(){return vt})),n.d(s,"fromValues",(function(){return xt})),n.d(s,"set",(function(){return bt})),n.d(s,"identity",(function(){return wt})),n.d(s,"transpose",(function(){return _t})),n.d(s,"invert",(function(){return Mt})),n.d(s,"adjoint",(function(){return Tt})),n.d(s,"determinant",(function(){return St})),n.d(s,"multiply",(function(){return It})),n.d(s,"translate",(function(){return Ct})),n.d(s,"scale",(function(){return Ot})),n.d(s,"rotate",(function(){return Et})),n.d(s,"rotateX",(function(){return Pt})),n.d(s,"rotateY",(function(){return kt})),n.d(s,"rotateZ",(function(){return Rt})),n.d(s,"fromTranslation",(function(){return Nt})),n.d(s,"fromScaling",(function(){return Dt})),n.d(s,"fromRotation",(function(){return Ft})),n.d(s,"fromXRotation",(function(){return Lt})),n.d(s,"fromYRotation",(function(){return zt})),n.d(s,"fromZRotation",(function(){return Bt})),n.d(s,"fromRotationTranslation",(function(){return Ht})),n.d(s,"fromQuat2",(function(){return Ut})),n.d(s,"getTranslation",(function(){return jt})),n.d(s,"getScaling",(function(){return Vt})),n.d(s,"getRotation",(function(){return Gt})),n.d(s,"fromRotationTranslationScale",(function(){return qt})),n.d(s,"fromRotationTranslationScaleOrigin",(function(){return Wt})),n.d(s,"fromQuat",(function(){return Xt})),n.d(s,"frustum",(function(){return Qt})),n.d(s,"perspective",(function(){return Yt})),n.d(s,"perspectiveFromFieldOfView",(function(){return Zt})),n.d(s,"ortho",(function(){return Kt})),n.d(s,"lookAt",(function(){return Jt})),n.d(s,"targetTo",(function(){return $t})),n.d(s,"str",(function(){return te})),n.d(s,"frob",(function(){return ee})),n.d(s,"add",(function(){return ne})),n.d(s,"subtract",(function(){return re})),n.d(s,"multiplyScalar",(function(){return ie})),n.d(s,"multiplyScalarAndAdd",(function(){return se})),n.d(s,"exactEquals",(function(){return oe})),n.d(s,"equals",(function(){return ae})),n.d(s,"mul",(function(){return le})),n.d(s,"sub",(function(){return he}));var o={};n.r(o),n.d(o,"create",(function(){return ce})),n.d(o,"clone",(function(){return ue})),n.d(o,"length",(function(){return fe})),n.d(o,"fromValues",(function(){return de})),n.d(o,"copy",(function(){return pe})),n.d(o,"set",(function(){return Ae})),n.d(o,"add",(function(){return ge})),n.d(o,"subtract",(function(){return me})),n.d(o,"multiply",(function(){return ye})),n.d(o,"divide",(function(){return ve})),n.d(o,"ceil",(function(){return xe})),n.d(o,"floor",(function(){return be})),n.d(o,"min",(function(){return we})),n.d(o,"max",(function(){return _e})),n.d(o,"round",(function(){return Me})),n.d(o,"scale",(function(){return Te})),n.d(o,"scaleAndAdd",(function(){return Se})),n.d(o,"distance",(function(){return Ie})),n.d(o,"squaredDistance",(function(){return Ce})),n.d(o,"squaredLength",(function(){return Oe})),n.d(o,"negate",(function(){return Ee})),n.d(o,"inverse",(function(){return Pe})),n.d(o,"normalize",(function(){return ke})),n.d(o,"dot",(function(){return Re})),n.d(o,"cross",(function(){return Ne})),n.d(o,"lerp",(function(){return De})),n.d(o,"hermite",(function(){return Fe})),n.d(o,"bezier",(function(){return Le})),n.d(o,"random",(function(){return ze})),n.d(o,"transformMat4",(function(){return Be})),n.d(o,"transformMat3",(function(){return He})),n.d(o,"transformQuat",(function(){return Ue})),n.d(o,"rotateX",(function(){return je})),n.d(o,"rotateY",(function(){return Ve})),n.d(o,"rotateZ",(function(){return Ge})),n.d(o,"angle",(function(){return qe})),n.d(o,"str",(function(){return We})),n.d(o,"exactEquals",(function(){return Xe})),n.d(o,"equals",(function(){return Qe})),n.d(o,"sub",(function(){return Ye})),n.d(o,"mul",(function(){return Ze})),n.d(o,"div",(function(){return Ke})),n.d(o,"dist",(function(){return Je})),n.d(o,"sqrDist",(function(){return $e})),n.d(o,"len",(function(){return tn})),n.d(o,"sqrLen",(function(){return en})),n.d(o,"forEach",(function(){return nn}));var a={};n.r(a),n.d(a,"create",(function(){return rn})),n.d(a,"clone",(function(){return sn})),n.d(a,"fromValues",(function(){return on})),n.d(a,"copy",(function(){return an})),n.d(a,"set",(function(){return ln})),n.d(a,"add",(function(){return hn})),n.d(a,"subtract",(function(){return cn})),n.d(a,"multiply",(function(){return un})),n.d(a,"divide",(function(){return fn})),n.d(a,"ceil",(function(){return dn})),n.d(a,"floor",(function(){return pn})),n.d(a,"min",(function(){return An})),n.d(a,"max",(function(){return gn})),n.d(a,"round",(function(){return mn})),n.d(a,"scale",(function(){return yn})),n.d(a,"scaleAndAdd",(function(){return vn})),n.d(a,"distance",(function(){return xn})),n.d(a,"squaredDistance",(function(){return bn})),n.d(a,"length",(function(){return wn})),n.d(a,"squaredLength",(function(){return _n})),n.d(a,"negate",(function(){return Mn})),n.d(a,"inverse",(function(){return Tn})),n.d(a,"normalize",(function(){return Sn})),n.d(a,"dot",(function(){return In})),n.d(a,"lerp",(function(){return Cn})),n.d(a,"random",(function(){return On})),n.d(a,"transformMat4",(function(){return En})),n.d(a,"transformQuat",(function(){return Pn})),n.d(a,"str",(function(){return kn})),n.d(a,"exactEquals",(function(){return Rn})),n.d(a,"equals",(function(){return Nn})),n.d(a,"sub",(function(){return Dn})),n.d(a,"mul",(function(){return Fn})),n.d(a,"div",(function(){return Ln})),n.d(a,"dist",(function(){return zn})),n.d(a,"sqrDist",(function(){return Bn})),n.d(a,"len",(function(){return Hn})),n.d(a,"sqrLen",(function(){return Un})),n.d(a,"forEach",(function(){return jn}));var l={};n.r(l),n.d(l,"create",(function(){return Vn})),n.d(l,"identity",(function(){return Gn})),n.d(l,"setAxisAngle",(function(){return qn})),n.d(l,"getAxisAngle",(function(){return Wn})),n.d(l,"multiply",(function(){return Xn})),n.d(l,"rotateX",(function(){return Qn})),n.d(l,"rotateY",(function(){return Yn})),n.d(l,"rotateZ",(function(){return Zn})),n.d(l,"calculateW",(function(){return Kn})),n.d(l,"slerp",(function(){return Jn})),n.d(l,"random",(function(){return $n})),n.d(l,"invert",(function(){return tr})),n.d(l,"conjugate",(function(){return er})),n.d(l,"fromMat3",(function(){return nr})),n.d(l,"fromEuler",(function(){return rr})),n.d(l,"str",(function(){return ir})),n.d(l,"clone",(function(){return sr})),n.d(l,"fromValues",(function(){return or})),n.d(l,"copy",(function(){return ar})),n.d(l,"set",(function(){return lr})),n.d(l,"add",(function(){return hr})),n.d(l,"mul",(function(){return cr})),n.d(l,"scale",(function(){return ur})),n.d(l,"dot",(function(){return fr})),n.d(l,"lerp",(function(){return dr})),n.d(l,"length",(function(){return pr})),n.d(l,"len",(function(){return Ar})),n.d(l,"squaredLength",(function(){return gr})),n.d(l,"sqrLen",(function(){return mr})),n.d(l,"normalize",(function(){return yr})),n.d(l,"exactEquals",(function(){return vr})),n.d(l,"equals",(function(){return xr})),n.d(l,"rotationTo",(function(){return br})),n.d(l,"sqlerp",(function(){return wr})),n.d(l,"setAxes",(function(){return _r}));var h={};n.r(h),n.d(h,"create",(function(){return Mr})),n.d(h,"clone",(function(){return Tr})),n.d(h,"fromValues",(function(){return Sr})),n.d(h,"copy",(function(){return Ir})),n.d(h,"set",(function(){return Cr})),n.d(h,"add",(function(){return Or})),n.d(h,"subtract",(function(){return Er})),n.d(h,"multiply",(function(){return Pr})),n.d(h,"divide",(function(){return kr})),n.d(h,"ceil",(function(){return Rr})),n.d(h,"floor",(function(){return Nr})),n.d(h,"min",(function(){return Dr})),n.d(h,"max",(function(){return Fr})),n.d(h,"round",(function(){return Lr})),n.d(h,"scale",(function(){return zr})),n.d(h,"scaleAndAdd",(function(){return Br})),n.d(h,"distance",(function(){return Hr})),n.d(h,"squaredDistance",(function(){return Ur})),n.d(h,"length",(function(){return jr})),n.d(h,"squaredLength",(function(){return Vr})),n.d(h,"negate",(function(){return Gr})),n.d(h,"inverse",(function(){return qr})),n.d(h,"normalize",(function(){return Wr})),n.d(h,"dot",(function(){return Xr})),n.d(h,"cross",(function(){return Qr})),n.d(h,"lerp",(function(){return Yr})),n.d(h,"random",(function(){return Zr})),n.d(h,"transformMat2",(function(){return Kr})),n.d(h,"transformMat2d",(function(){return Jr})),n.d(h,"transformMat3",(function(){return $r})),n.d(h,"transformMat4",(function(){return ti})),n.d(h,"rotate",(function(){return ei})),n.d(h,"angle",(function(){return ni})),n.d(h,"str",(function(){return ri})),n.d(h,"exactEquals",(function(){return ii})),n.d(h,"equals",(function(){return si})),n.d(h,"len",(function(){return oi})),n.d(h,"sub",(function(){return ai})),n.d(h,"mul",(function(){return li})),n.d(h,"div",(function(){return hi})),n.d(h,"dist",(function(){return ci})),n.d(h,"sqrDist",(function(){return ui})),n.d(h,"sqrLen",(function(){return fi})),n.d(h,"forEach",(function(){return di}));var c=1e-6,u="undefined"!==typeof Float32Array?Float32Array:Array,f=Math.random;Math.PI;function d(){var t=new u(4);return u!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t}function p(t){var e=new u(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function A(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function g(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function m(t,e,n,r){var i=new u(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i}function y(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function v(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function x(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*s-i*r;return o?(o=1/o,t[0]=s*o,t[1]=-r*o,t[2]=-i*o,t[3]=n*o,t):null}function b(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t}function w(t){return t[0]*t[3]-t[2]*t[1]}function _(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=n[0],l=n[1],h=n[2],c=n[3];return t[0]=r*a+s*l,t[1]=i*a+o*l,t[2]=r*h+s*c,t[3]=i*h+o*c,t}function M(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+s*a,t[1]=i*l+o*a,t[2]=r*-a+s*l,t[3]=i*-a+o*l,t}function T(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=n[0],l=n[1];return t[0]=r*a,t[1]=i*a,t[2]=s*l,t[3]=o*l,t}function S(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=-n,t[3]=r,t}function I(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function C(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function O(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2))}function E(t,e,n,r){return t[2]=r[2]/r[0],n[0]=r[0],n[1]=r[1],n[3]=r[3]-t[2]*n[1],[t,e,n]}function P(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function k(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function R(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function N(t,e){var n=t[0],r=t[1],i=t[2],s=t[3],o=e[0],a=e[1],l=e[2],h=e[3];return Math.abs(n-o)<=c*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-a)<=c*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=c*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=c*Math.max(1,Math.abs(s),Math.abs(h))}function D(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function F(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t}var L=_,z=k;function B(){var t=new u(9);return u!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function H(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function U(t){var e=new u(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function j(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function V(t,e,n,r,i,s,o,a,l){var h=new u(9);return h[0]=t,h[1]=e,h[2]=n,h[3]=r,h[4]=i,h[5]=s,h[6]=o,h[7]=a,h[8]=l,h}function G(t,e,n,r,i,s,o,a,l,h){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=l,t[8]=h,t}function q(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function W(t,e){if(t===e){var n=e[1],r=e[2],i=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=r,t[7]=i}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function X(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=c*o-a*h,f=-c*s+a*l,d=h*s-o*l,p=n*u+r*f+i*d;return p?(p=1/p,t[0]=u*p,t[1]=(-c*r+i*h)*p,t[2]=(a*r-i*o)*p,t[3]=f*p,t[4]=(c*n-i*l)*p,t[5]=(-a*n+i*s)*p,t[6]=d*p,t[7]=(-h*n+r*l)*p,t[8]=(o*n-r*s)*p,t):null}function Q(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8];return t[0]=o*c-a*h,t[1]=i*h-r*c,t[2]=r*a-i*o,t[3]=a*l-s*c,t[4]=n*c-i*l,t[5]=i*s-n*a,t[6]=s*h-o*l,t[7]=r*l-n*h,t[8]=n*o-r*s,t}function Y(t){var e=t[0],n=t[1],r=t[2],i=t[3],s=t[4],o=t[5],a=t[6],l=t[7],h=t[8];return e*(h*s-o*l)+n*(-h*i+o*a)+r*(l*i-s*a)}function Z(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=n[0],d=n[1],p=n[2],A=n[3],g=n[4],m=n[5],y=n[6],v=n[7],x=n[8];return t[0]=f*r+d*o+p*h,t[1]=f*i+d*a+p*c,t[2]=f*s+d*l+p*u,t[3]=A*r+g*o+m*h,t[4]=A*i+g*a+m*c,t[5]=A*s+g*l+m*u,t[6]=y*r+v*o+x*h,t[7]=y*i+v*a+x*c,t[8]=y*s+v*l+x*u,t}function K(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=n[0],d=n[1];return t[0]=r,t[1]=i,t[2]=s,t[3]=o,t[4]=a,t[5]=l,t[6]=f*r+d*o+h,t[7]=f*i+d*a+c,t[8]=f*s+d*l+u,t}function J(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=Math.sin(n),d=Math.cos(n);return t[0]=d*r+f*o,t[1]=d*i+f*a,t[2]=d*s+f*l,t[3]=d*o-f*r,t[4]=d*a-f*i,t[5]=d*l-f*s,t[6]=h,t[7]=c,t[8]=u,t}function $(t,e,n){var r=n[0],i=n[1];return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=i*e[3],t[4]=i*e[4],t[5]=i*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function tt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function et(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=-n,t[4]=r,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function nt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function rt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function it(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,a=r+r,l=i+i,h=n*o,c=r*o,u=r*a,f=i*o,d=i*a,p=i*l,A=s*o,g=s*a,m=s*l;return t[0]=1-u-p,t[3]=c-m,t[6]=f+g,t[1]=c+m,t[4]=1-h-p,t[7]=d-A,t[2]=f-g,t[5]=d+A,t[8]=1-h-u,t}function st(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],d=e[11],p=e[12],A=e[13],g=e[14],m=e[15],y=n*a-r*o,v=n*l-i*o,x=n*h-s*o,b=r*l-i*a,w=r*h-s*a,_=i*h-s*l,M=c*A-u*p,T=c*g-f*p,S=c*m-d*p,I=u*g-f*A,C=u*m-d*A,O=f*m-d*g,E=y*O-v*C+x*I+b*S-w*T+_*M;return E?(E=1/E,t[0]=(a*O-l*C+h*I)*E,t[1]=(l*S-o*O-h*T)*E,t[2]=(o*C-a*S+h*M)*E,t[3]=(i*C-r*O-s*I)*E,t[4]=(n*O-i*S+s*T)*E,t[5]=(r*S-n*C-s*M)*E,t[6]=(A*_-g*w+m*b)*E,t[7]=(g*x-p*_-m*v)*E,t[8]=(p*w-A*x+m*y)*E,t):null}function ot(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function at(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function lt(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2))}function ht(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t}function ct(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}function ut(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t}function ft(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t}function dt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function pt(t,e){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],a=t[5],l=t[6],h=t[7],u=t[8],f=e[0],d=e[1],p=e[2],A=e[3],g=e[4],m=e[5],y=e[6],v=e[7],x=e[8];return Math.abs(n-f)<=c*Math.max(1,Math.abs(n),Math.abs(f))&&Math.abs(r-d)<=c*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(i-p)<=c*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(s-A)<=c*Math.max(1,Math.abs(s),Math.abs(A))&&Math.abs(o-g)<=c*Math.max(1,Math.abs(o),Math.abs(g))&&Math.abs(a-m)<=c*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(l-y)<=c*Math.max(1,Math.abs(l),Math.abs(y))&&Math.abs(h-v)<=c*Math.max(1,Math.abs(h),Math.abs(v))&&Math.abs(u-x)<=c*Math.max(1,Math.abs(u),Math.abs(x))}var At=Z,gt=ct;function mt(){var t=new u(16);return u!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function yt(t){var e=new u(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function vt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function xt(t,e,n,r,i,s,o,a,l,h,c,f,d,p,A,g){var m=new u(16);return m[0]=t,m[1]=e,m[2]=n,m[3]=r,m[4]=i,m[5]=s,m[6]=o,m[7]=a,m[8]=l,m[9]=h,m[10]=c,m[11]=f,m[12]=d,m[13]=p,m[14]=A,m[15]=g,m}function bt(t,e,n,r,i,s,o,a,l,h,c,u,f,d,p,A,g){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t[4]=s,t[5]=o,t[6]=a,t[7]=l,t[8]=h,t[9]=c,t[10]=u,t[11]=f,t[12]=d,t[13]=p,t[14]=A,t[15]=g,t}function wt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function _t(t,e){if(t===e){var n=e[1],r=e[2],i=e[3],s=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=s,t[11]=e[14],t[12]=i,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function Mt(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],d=e[11],p=e[12],A=e[13],g=e[14],m=e[15],y=n*a-r*o,v=n*l-i*o,x=n*h-s*o,b=r*l-i*a,w=r*h-s*a,_=i*h-s*l,M=c*A-u*p,T=c*g-f*p,S=c*m-d*p,I=u*g-f*A,C=u*m-d*A,O=f*m-d*g,E=y*O-v*C+x*I+b*S-w*T+_*M;return E?(E=1/E,t[0]=(a*O-l*C+h*I)*E,t[1]=(i*C-r*O-s*I)*E,t[2]=(A*_-g*w+m*b)*E,t[3]=(f*w-u*_-d*b)*E,t[4]=(l*S-o*O-h*T)*E,t[5]=(n*O-i*S+s*T)*E,t[6]=(g*x-p*_-m*v)*E,t[7]=(c*_-f*x+d*v)*E,t[8]=(o*C-a*S+h*M)*E,t[9]=(r*S-n*C-s*M)*E,t[10]=(p*w-A*x+m*y)*E,t[11]=(u*x-c*w-d*y)*E,t[12]=(a*T-o*I-l*M)*E,t[13]=(n*I-r*T+i*M)*E,t[14]=(A*v-p*b-g*y)*E,t[15]=(c*b-u*v+f*y)*E,t):null}function Tt(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],f=e[10],d=e[11],p=e[12],A=e[13],g=e[14],m=e[15];return t[0]=a*(f*m-d*g)-u*(l*m-h*g)+A*(l*d-h*f),t[1]=-(r*(f*m-d*g)-u*(i*m-s*g)+A*(i*d-s*f)),t[2]=r*(l*m-h*g)-a*(i*m-s*g)+A*(i*h-s*l),t[3]=-(r*(l*d-h*f)-a*(i*d-s*f)+u*(i*h-s*l)),t[4]=-(o*(f*m-d*g)-c*(l*m-h*g)+p*(l*d-h*f)),t[5]=n*(f*m-d*g)-c*(i*m-s*g)+p*(i*d-s*f),t[6]=-(n*(l*m-h*g)-o*(i*m-s*g)+p*(i*h-s*l)),t[7]=n*(l*d-h*f)-o*(i*d-s*f)+c*(i*h-s*l),t[8]=o*(u*m-d*A)-c*(a*m-h*A)+p*(a*d-h*u),t[9]=-(n*(u*m-d*A)-c*(r*m-s*A)+p*(r*d-s*u)),t[10]=n*(a*m-h*A)-o*(r*m-s*A)+p*(r*h-s*a),t[11]=-(n*(a*d-h*u)-o*(r*d-s*u)+c*(r*h-s*a)),t[12]=-(o*(u*g-f*A)-c*(a*g-l*A)+p*(a*f-l*u)),t[13]=n*(u*g-f*A)-c*(r*g-i*A)+p*(r*f-i*u),t[14]=-(n*(a*g-l*A)-o*(r*g-i*A)+p*(r*l-i*a)),t[15]=n*(a*f-l*u)-o*(r*f-i*u)+c*(r*l-i*a),t}function St(t){var e=t[0],n=t[1],r=t[2],i=t[3],s=t[4],o=t[5],a=t[6],l=t[7],h=t[8],c=t[9],u=t[10],f=t[11],d=t[12],p=t[13],A=t[14],g=t[15],m=e*o-n*s,y=e*a-r*s,v=e*l-i*s,x=n*a-r*o,b=n*l-i*o,w=r*l-i*a,_=h*p-c*d,M=h*A-u*d,T=h*g-f*d,S=c*A-u*p,I=c*g-f*p,C=u*g-f*A;return m*C-y*I+v*S+x*T-b*M+w*_}function It(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],d=e[10],p=e[11],A=e[12],g=e[13],m=e[14],y=e[15],v=n[0],x=n[1],b=n[2],w=n[3];return t[0]=v*r+x*a+b*u+w*A,t[1]=v*i+x*l+b*f+w*g,t[2]=v*s+x*h+b*d+w*m,t[3]=v*o+x*c+b*p+w*y,v=n[4],x=n[5],b=n[6],w=n[7],t[4]=v*r+x*a+b*u+w*A,t[5]=v*i+x*l+b*f+w*g,t[6]=v*s+x*h+b*d+w*m,t[7]=v*o+x*c+b*p+w*y,v=n[8],x=n[9],b=n[10],w=n[11],t[8]=v*r+x*a+b*u+w*A,t[9]=v*i+x*l+b*f+w*g,t[10]=v*s+x*h+b*d+w*m,t[11]=v*o+x*c+b*p+w*y,v=n[12],x=n[13],b=n[14],w=n[15],t[12]=v*r+x*a+b*u+w*A,t[13]=v*i+x*l+b*f+w*g,t[14]=v*s+x*h+b*d+w*m,t[15]=v*o+x*c+b*p+w*y,t}function Ct(t,e,n){var r=n[0],i=n[1],s=n[2],o=void 0,a=void 0,l=void 0,h=void 0,c=void 0,u=void 0,f=void 0,d=void 0,p=void 0,A=void 0,g=void 0,m=void 0;return e===t?(t[12]=e[0]*r+e[4]*i+e[8]*s+e[12],t[13]=e[1]*r+e[5]*i+e[9]*s+e[13],t[14]=e[2]*r+e[6]*i+e[10]*s+e[14],t[15]=e[3]*r+e[7]*i+e[11]*s+e[15]):(o=e[0],a=e[1],l=e[2],h=e[3],c=e[4],u=e[5],f=e[6],d=e[7],p=e[8],A=e[9],g=e[10],m=e[11],t[0]=o,t[1]=a,t[2]=l,t[3]=h,t[4]=c,t[5]=u,t[6]=f,t[7]=d,t[8]=p,t[9]=A,t[10]=g,t[11]=m,t[12]=o*r+c*i+p*s+e[12],t[13]=a*r+u*i+A*s+e[13],t[14]=l*r+f*i+g*s+e[14],t[15]=h*r+d*i+m*s+e[15]),t}function Ot(t,e,n){var r=n[0],i=n[1],s=n[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Et(t,e,n,r){var i=r[0],s=r[1],o=r[2],a=Math.sqrt(i*i+s*s+o*o),l=void 0,h=void 0,u=void 0,f=void 0,d=void 0,p=void 0,A=void 0,g=void 0,m=void 0,y=void 0,v=void 0,x=void 0,b=void 0,w=void 0,_=void 0,M=void 0,T=void 0,S=void 0,I=void 0,C=void 0,O=void 0,E=void 0,P=void 0,k=void 0;return a<c?null:(a=1/a,i*=a,s*=a,o*=a,l=Math.sin(n),h=Math.cos(n),u=1-h,f=e[0],d=e[1],p=e[2],A=e[3],g=e[4],m=e[5],y=e[6],v=e[7],x=e[8],b=e[9],w=e[10],_=e[11],M=i*i*u+h,T=s*i*u+o*l,S=o*i*u-s*l,I=i*s*u-o*l,C=s*s*u+h,O=o*s*u+i*l,E=i*o*u+s*l,P=s*o*u-i*l,k=o*o*u+h,t[0]=f*M+g*T+x*S,t[1]=d*M+m*T+b*S,t[2]=p*M+y*T+w*S,t[3]=A*M+v*T+_*S,t[4]=f*I+g*C+x*O,t[5]=d*I+m*C+b*O,t[6]=p*I+y*C+w*O,t[7]=A*I+v*C+_*O,t[8]=f*E+g*P+x*k,t[9]=d*E+m*P+b*k,t[10]=p*E+y*P+w*k,t[11]=A*E+v*P+_*k,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function Pt(t,e,n){var r=Math.sin(n),i=Math.cos(n),s=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*i+h*r,t[5]=o*i+c*r,t[6]=a*i+u*r,t[7]=l*i+f*r,t[8]=h*i-s*r,t[9]=c*i-o*r,t[10]=u*i-a*r,t[11]=f*i-l*r,t}function kt(t,e,n){var r=Math.sin(n),i=Math.cos(n),s=e[0],o=e[1],a=e[2],l=e[3],h=e[8],c=e[9],u=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*i-h*r,t[1]=o*i-c*r,t[2]=a*i-u*r,t[3]=l*i-f*r,t[8]=s*r+h*i,t[9]=o*r+c*i,t[10]=a*r+u*i,t[11]=l*r+f*i,t}function Rt(t,e,n){var r=Math.sin(n),i=Math.cos(n),s=e[0],o=e[1],a=e[2],l=e[3],h=e[4],c=e[5],u=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*i+h*r,t[1]=o*i+c*r,t[2]=a*i+u*r,t[3]=l*i+f*r,t[4]=h*i-s*r,t[5]=c*i-o*r,t[6]=u*i-a*r,t[7]=f*i-l*r,t}function Nt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function Dt(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ft(t,e,n){var r=n[0],i=n[1],s=n[2],o=Math.sqrt(r*r+i*i+s*s),a=void 0,l=void 0,h=void 0;return o<c?null:(o=1/o,r*=o,i*=o,s*=o,a=Math.sin(e),l=Math.cos(e),h=1-l,t[0]=r*r*h+l,t[1]=i*r*h+s*a,t[2]=s*r*h-i*a,t[3]=0,t[4]=r*i*h-s*a,t[5]=i*i*h+l,t[6]=s*i*h+r*a,t[7]=0,t[8]=r*s*h+i*a,t[9]=i*s*h-r*a,t[10]=s*s*h+l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Lt(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function zt(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Bt(t,e){var n=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ht(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=r+r,l=i+i,h=s+s,c=r*a,u=r*l,f=r*h,d=i*l,p=i*h,A=s*h,g=o*a,m=o*l,y=o*h;return t[0]=1-(d+A),t[1]=u+y,t[2]=f-m,t[3]=0,t[4]=u-y,t[5]=1-(c+A),t[6]=p+g,t[7]=0,t[8]=f+m,t[9]=p-g,t[10]=1-(c+d),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Ut(t,e){var n=new u(3),r=-e[0],i=-e[1],s=-e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],f=r*r+i*i+s*s+o*o;return f>0?(n[0]=2*(a*o+c*r+l*s-h*i)/f,n[1]=2*(l*o+c*i+h*r-a*s)/f,n[2]=2*(h*o+c*s+a*i-l*r)/f):(n[0]=2*(a*o+c*r+l*s-h*i),n[1]=2*(l*o+c*i+h*r-a*s),n[2]=2*(h*o+c*s+a*i-l*r)),Ht(t,e,n),t}function jt(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function Vt(t,e){var n=e[0],r=e[1],i=e[2],s=e[4],o=e[5],a=e[6],l=e[8],h=e[9],c=e[10];return t[0]=Math.sqrt(n*n+r*r+i*i),t[1]=Math.sqrt(s*s+o*o+a*a),t[2]=Math.sqrt(l*l+h*h+c*c),t}function Gt(t,e){var n=e[0]+e[5]+e[10],r=0;return n>0?(r=2*Math.sqrt(n+1),t[3]=.25*r,t[0]=(e[6]-e[9])/r,t[1]=(e[8]-e[2])/r,t[2]=(e[1]-e[4])/r):e[0]>e[5]&&e[0]>e[10]?(r=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/r,t[0]=.25*r,t[1]=(e[1]+e[4])/r,t[2]=(e[8]+e[2])/r):e[5]>e[10]?(r=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/r,t[0]=(e[1]+e[4])/r,t[1]=.25*r,t[2]=(e[6]+e[9])/r):(r=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/r,t[0]=(e[8]+e[2])/r,t[1]=(e[6]+e[9])/r,t[2]=.25*r),t}function qt(t,e,n,r){var i=e[0],s=e[1],o=e[2],a=e[3],l=i+i,h=s+s,c=o+o,u=i*l,f=i*h,d=i*c,p=s*h,A=s*c,g=o*c,m=a*l,y=a*h,v=a*c,x=r[0],b=r[1],w=r[2];return t[0]=(1-(p+g))*x,t[1]=(f+v)*x,t[2]=(d-y)*x,t[3]=0,t[4]=(f-v)*b,t[5]=(1-(u+g))*b,t[6]=(A+m)*b,t[7]=0,t[8]=(d+y)*w,t[9]=(A-m)*w,t[10]=(1-(u+p))*w,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Wt(t,e,n,r,i){var s=e[0],o=e[1],a=e[2],l=e[3],h=s+s,c=o+o,u=a+a,f=s*h,d=s*c,p=s*u,A=o*c,g=o*u,m=a*u,y=l*h,v=l*c,x=l*u,b=r[0],w=r[1],_=r[2],M=i[0],T=i[1],S=i[2],I=(1-(A+m))*b,C=(d+x)*b,O=(p-v)*b,E=(d-x)*w,P=(1-(f+m))*w,k=(g+y)*w,R=(p+v)*_,N=(g-y)*_,D=(1-(f+A))*_;return t[0]=I,t[1]=C,t[2]=O,t[3]=0,t[4]=E,t[5]=P,t[6]=k,t[7]=0,t[8]=R,t[9]=N,t[10]=D,t[11]=0,t[12]=n[0]+M-(I*M+E*T+R*S),t[13]=n[1]+T-(C*M+P*T+N*S),t[14]=n[2]+S-(O*M+k*T+D*S),t[15]=1,t}function Xt(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n+n,a=r+r,l=i+i,h=n*o,c=r*o,u=r*a,f=i*o,d=i*a,p=i*l,A=s*o,g=s*a,m=s*l;return t[0]=1-u-p,t[1]=c+m,t[2]=f-g,t[3]=0,t[4]=c-m,t[5]=1-h-p,t[6]=d+A,t[7]=0,t[8]=f+g,t[9]=d-A,t[10]=1-h-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Qt(t,e,n,r,i,s,o){var a=1/(n-e),l=1/(i-r),h=1/(s-o);return t[0]=2*s*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*l,t[6]=0,t[7]=0,t[8]=(n+e)*a,t[9]=(i+r)*l,t[10]=(o+s)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*s*2*h,t[15]=0,t}function Yt(t,e,n,r,i){var s=1/Math.tan(e/2),o=void 0;return t[0]=s/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0?(o=1/(r-i),t[10]=(i+r)*o,t[14]=2*i*r*o):(t[10]=-1,t[14]=-2*r),t}function Zt(t,e,n,r){var i=Math.tan(e.upDegrees*Math.PI/180),s=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),h=2/(i+s);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(i-s)*h*.5,t[10]=r/(n-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*n/(n-r),t[15]=0,t}function Kt(t,e,n,r,i,s,o){var a=1/(e-n),l=1/(r-i),h=1/(s-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*a,t[13]=(i+r)*l,t[14]=(o+s)*h,t[15]=1,t}function Jt(t,e,n,r){var i=void 0,s=void 0,o=void 0,a=void 0,l=void 0,h=void 0,u=void 0,f=void 0,d=void 0,p=void 0,A=e[0],g=e[1],m=e[2],y=r[0],v=r[1],x=r[2],b=n[0],w=n[1],_=n[2];return Math.abs(A-b)<c&&Math.abs(g-w)<c&&Math.abs(m-_)<c?wt(t):(u=A-b,f=g-w,d=m-_,p=1/Math.sqrt(u*u+f*f+d*d),u*=p,f*=p,d*=p,i=v*d-x*f,s=x*u-y*d,o=y*f-v*u,p=Math.sqrt(i*i+s*s+o*o),p?(p=1/p,i*=p,s*=p,o*=p):(i=0,s=0,o=0),a=f*o-d*s,l=d*i-u*o,h=u*s-f*i,p=Math.sqrt(a*a+l*l+h*h),p?(p=1/p,a*=p,l*=p,h*=p):(a=0,l=0,h=0),t[0]=i,t[1]=a,t[2]=u,t[3]=0,t[4]=s,t[5]=l,t[6]=f,t[7]=0,t[8]=o,t[9]=h,t[10]=d,t[11]=0,t[12]=-(i*A+s*g+o*m),t[13]=-(a*A+l*g+h*m),t[14]=-(u*A+f*g+d*m),t[15]=1,t)}function $t(t,e,n,r){var i=e[0],s=e[1],o=e[2],a=r[0],l=r[1],h=r[2],c=i-n[0],u=s-n[1],f=o-n[2],d=c*c+u*u+f*f;d>0&&(d=1/Math.sqrt(d),c*=d,u*=d,f*=d);var p=l*f-h*u,A=h*c-a*f,g=a*u-l*c;return d=p*p+A*A+g*g,d>0&&(d=1/Math.sqrt(d),p*=d,A*=d,g*=d),t[0]=p,t[1]=A,t[2]=g,t[3]=0,t[4]=u*g-f*A,t[5]=f*p-c*g,t[6]=c*A-u*p,t[7]=0,t[8]=c,t[9]=u,t[10]=f,t[11]=0,t[12]=i,t[13]=s,t[14]=o,t[15]=1,t}function te(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function ee(t){return Math.sqrt(Math.pow(t[0],2)+Math.pow(t[1],2)+Math.pow(t[2],2)+Math.pow(t[3],2)+Math.pow(t[4],2)+Math.pow(t[5],2)+Math.pow(t[6],2)+Math.pow(t[7],2)+Math.pow(t[8],2)+Math.pow(t[9],2)+Math.pow(t[10],2)+Math.pow(t[11],2)+Math.pow(t[12],2)+Math.pow(t[13],2)+Math.pow(t[14],2)+Math.pow(t[15],2))}function ne(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t}function re(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function ie(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t}function se(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t[4]=e[4]+n[4]*r,t[5]=e[5]+n[5]*r,t[6]=e[6]+n[6]*r,t[7]=e[7]+n[7]*r,t[8]=e[8]+n[8]*r,t[9]=e[9]+n[9]*r,t[10]=e[10]+n[10]*r,t[11]=e[11]+n[11]*r,t[12]=e[12]+n[12]*r,t[13]=e[13]+n[13]*r,t[14]=e[14]+n[14]*r,t[15]=e[15]+n[15]*r,t}function oe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function ae(t,e){var n=t[0],r=t[1],i=t[2],s=t[3],o=t[4],a=t[5],l=t[6],h=t[7],u=t[8],f=t[9],d=t[10],p=t[11],A=t[12],g=t[13],m=t[14],y=t[15],v=e[0],x=e[1],b=e[2],w=e[3],_=e[4],M=e[5],T=e[6],S=e[7],I=e[8],C=e[9],O=e[10],E=e[11],P=e[12],k=e[13],R=e[14],N=e[15];return Math.abs(n-v)<=c*Math.max(1,Math.abs(n),Math.abs(v))&&Math.abs(r-x)<=c*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(i-b)<=c*Math.max(1,Math.abs(i),Math.abs(b))&&Math.abs(s-w)<=c*Math.max(1,Math.abs(s),Math.abs(w))&&Math.abs(o-_)<=c*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(a-M)<=c*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(l-T)<=c*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(h-S)<=c*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(u-I)<=c*Math.max(1,Math.abs(u),Math.abs(I))&&Math.abs(f-C)<=c*Math.max(1,Math.abs(f),Math.abs(C))&&Math.abs(d-O)<=c*Math.max(1,Math.abs(d),Math.abs(O))&&Math.abs(p-E)<=c*Math.max(1,Math.abs(p),Math.abs(E))&&Math.abs(A-P)<=c*Math.max(1,Math.abs(A),Math.abs(P))&&Math.abs(g-k)<=c*Math.max(1,Math.abs(g),Math.abs(k))&&Math.abs(m-R)<=c*Math.max(1,Math.abs(m),Math.abs(R))&&Math.abs(y-N)<=c*Math.max(1,Math.abs(y),Math.abs(N))}var le=It,he=re;function ce(){var t=new u(3);return u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function ue(t){var e=new u(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function fe(t){var e=t[0],n=t[1],r=t[2];return Math.sqrt(e*e+n*n+r*r)}function de(t,e,n){var r=new u(3);return r[0]=t,r[1]=e,r[2]=n,r}function pe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Ae(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function ge(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function me(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function ye(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function ve(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function xe(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function be(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function we(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t}function _e(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t}function Me(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function Te(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Se(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t}function Ie(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+r*r+i*i)}function Ce(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2];return n*n+r*r+i*i}function Oe(t){var e=t[0],n=t[1],r=t[2];return e*e+n*n+r*r}function Ee(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function Pe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function ke(t,e){var n=e[0],r=e[1],i=e[2],s=n*n+r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s),t}function Re(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ne(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[0],a=n[1],l=n[2];return t[0]=i*l-s*a,t[1]=s*o-r*l,t[2]=r*a-i*o,t}function De(t,e,n,r){var i=e[0],s=e[1],o=e[2];return t[0]=i+r*(n[0]-i),t[1]=s+r*(n[1]-s),t[2]=o+r*(n[2]-o),t}function Fe(t,e,n,r,i,s){var o=s*s,a=o*(2*s-3)+1,l=o*(s-2)+s,h=o*(s-1),c=o*(3-2*s);return t[0]=e[0]*a+n[0]*l+r[0]*h+i[0]*c,t[1]=e[1]*a+n[1]*l+r[1]*h+i[1]*c,t[2]=e[2]*a+n[2]*l+r[2]*h+i[2]*c,t}function Le(t,e,n,r,i,s){var o=1-s,a=o*o,l=s*s,h=a*o,c=3*s*a,u=3*l*o,f=l*s;return t[0]=e[0]*h+n[0]*c+r[0]*u+i[0]*f,t[1]=e[1]*h+n[1]*c+r[1]*u+i[1]*f,t[2]=e[2]*h+n[2]*c+r[2]*u+i[2]*f,t}function ze(t,e){e=e||1;var n=2*f()*Math.PI,r=2*f()-1,i=Math.sqrt(1-r*r)*e;return t[0]=Math.cos(n)*i,t[1]=Math.sin(n)*i,t[2]=r*e,t}function Be(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[3]*r+n[7]*i+n[11]*s+n[15];return o=o||1,t[0]=(n[0]*r+n[4]*i+n[8]*s+n[12])/o,t[1]=(n[1]*r+n[5]*i+n[9]*s+n[13])/o,t[2]=(n[2]*r+n[6]*i+n[10]*s+n[14])/o,t}function He(t,e,n){var r=e[0],i=e[1],s=e[2];return t[0]=r*n[0]+i*n[3]+s*n[6],t[1]=r*n[1]+i*n[4]+s*n[7],t[2]=r*n[2]+i*n[5]+s*n[8],t}function Ue(t,e,n){var r=n[0],i=n[1],s=n[2],o=n[3],a=e[0],l=e[1],h=e[2],c=i*h-s*l,u=s*a-r*h,f=r*l-i*a,d=i*f-s*u,p=s*c-r*f,A=r*u-i*c,g=2*o;return c*=g,u*=g,f*=g,d*=2,p*=2,A*=2,t[0]=a+c+d,t[1]=l+u+p,t[2]=h+f+A,t}function je(t,e,n,r){var i=[],s=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],s[0]=i[0],s[1]=i[1]*Math.cos(r)-i[2]*Math.sin(r),s[2]=i[1]*Math.sin(r)+i[2]*Math.cos(r),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function Ve(t,e,n,r){var i=[],s=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],s[0]=i[2]*Math.sin(r)+i[0]*Math.cos(r),s[1]=i[1],s[2]=i[2]*Math.cos(r)-i[0]*Math.sin(r),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function Ge(t,e,n,r){var i=[],s=[];return i[0]=e[0]-n[0],i[1]=e[1]-n[1],i[2]=e[2]-n[2],s[0]=i[0]*Math.cos(r)-i[1]*Math.sin(r),s[1]=i[0]*Math.sin(r)+i[1]*Math.cos(r),s[2]=i[2],t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function qe(t,e){var n=de(t[0],t[1],t[2]),r=de(e[0],e[1],e[2]);ke(n,n),ke(r,r);var i=Re(n,r);return i>1?0:i<-1?Math.PI:Math.acos(i)}function We(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Xe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Qe(t,e){var n=t[0],r=t[1],i=t[2],s=e[0],o=e[1],a=e[2];return Math.abs(n-s)<=c*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(r-o)<=c*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=c*Math.max(1,Math.abs(i),Math.abs(a))}var Ye=me,Ze=ye,Ke=ve,Je=Ie,$e=Ce,tn=fe,en=Oe,nn=function(){var t=ce();return function(e,n,r,i,s,o){var a=void 0,l=void 0;for(n||(n=3),r||(r=0),l=i?Math.min(i*n+r,e.length):e.length,a=r;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],s(t,t,o),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2];return e}}();function rn(){var t=new u(4);return u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function sn(t){var e=new u(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function on(t,e,n,r){var i=new u(4);return i[0]=t,i[1]=e,i[2]=n,i[3]=r,i}function an(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function ln(t,e,n,r,i){return t[0]=e,t[1]=n,t[2]=r,t[3]=i,t}function hn(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function cn(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function un(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function fn(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function dn(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function pn(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function An(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t}function gn(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t}function mn(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function yn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function vn(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t[2]=e[2]+n[2]*r,t[3]=e[3]+n[3]*r,t}function xn(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],s=e[3]-t[3];return Math.sqrt(n*n+r*r+i*i+s*s)}function bn(t,e){var n=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],s=e[3]-t[3];return n*n+r*r+i*i+s*s}function wn(t){var e=t[0],n=t[1],r=t[2],i=t[3];return Math.sqrt(e*e+n*n+r*r+i*i)}function _n(t){var e=t[0],n=t[1],r=t[2],i=t[3];return e*e+n*n+r*r+i*i}function Mn(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function Tn(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function Sn(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*n+r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o),t[0]=n*o,t[1]=r*o,t[2]=i*o,t[3]=s*o),t}function In(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function Cn(t,e,n,r){var i=e[0],s=e[1],o=e[2],a=e[3];return t[0]=i+r*(n[0]-i),t[1]=s+r*(n[1]-s),t[2]=o+r*(n[2]-o),t[3]=a+r*(n[3]-a),t}function On(t,e){var n,r,i,s,o,a;e=e||1;do{n=2*f()-1,r=2*f()-1,o=n*n+r*r}while(o>=1);do{i=2*f()-1,s=2*f()-1,a=i*i+s*s}while(a>=1);var l=Math.sqrt((1-o)/a);return t[0]=e*n,t[1]=e*r,t[2]=e*i*l,t[3]=e*s*l,t}function En(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3];return t[0]=n[0]*r+n[4]*i+n[8]*s+n[12]*o,t[1]=n[1]*r+n[5]*i+n[9]*s+n[13]*o,t[2]=n[2]*r+n[6]*i+n[10]*s+n[14]*o,t[3]=n[3]*r+n[7]*i+n[11]*s+n[15]*o,t}function Pn(t,e,n){var r=e[0],i=e[1],s=e[2],o=n[0],a=n[1],l=n[2],h=n[3],c=h*r+a*s-l*i,u=h*i+l*r-o*s,f=h*s+o*i-a*r,d=-o*r-a*i-l*s;return t[0]=c*h+d*-o+u*-l-f*-a,t[1]=u*h+d*-a+f*-o-c*-l,t[2]=f*h+d*-l+c*-a-u*-o,t[3]=e[3],t}function kn(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function Rn(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Nn(t,e){var n=t[0],r=t[1],i=t[2],s=t[3],o=e[0],a=e[1],l=e[2],h=e[3];return Math.abs(n-o)<=c*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(r-a)<=c*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-l)<=c*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(s-h)<=c*Math.max(1,Math.abs(s),Math.abs(h))}var Dn=cn,Fn=un,Ln=fn,zn=xn,Bn=bn,Hn=wn,Un=_n,jn=function(){var t=rn();return function(e,n,r,i,s,o){var a=void 0,l=void 0;for(n||(n=4),r||(r=0),l=i?Math.min(i*n+r,e.length):e.length,a=r;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],s(t,t,o),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}}();function Vn(){var t=new u(4);return u!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Gn(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function qn(t,e,n){n*=.5;var r=Math.sin(n);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(n),t}function Wn(t,e){var n=2*Math.acos(e[3]),r=Math.sin(n/2);return r>c?(t[0]=e[0]/r,t[1]=e[1]/r,t[2]=e[2]/r):(t[0]=1,t[1]=0,t[2]=0),n}function Xn(t,e,n){var r=e[0],i=e[1],s=e[2],o=e[3],a=n[0],l=n[1],h=n[2],c=n[3];return t[0]=r*c+o*a+i*h-s*l,t[1]=i*c+o*l+s*a-r*h,t[2]=s*c+o*h+r*l-i*a,t[3]=o*c-r*a-i*l-s*h,t}function Qn(t,e,n){n*=.5;var r=e[0],i=e[1],s=e[2],o=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+o*a,t[1]=i*l+s*a,t[2]=s*l-i*a,t[3]=o*l-r*a,t}function Yn(t,e,n){n*=.5;var r=e[0],i=e[1],s=e[2],o=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l-s*a,t[1]=i*l+o*a,t[2]=s*l+r*a,t[3]=o*l-i*a,t}function Zn(t,e,n){n*=.5;var r=e[0],i=e[1],s=e[2],o=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=r*l+i*a,t[1]=i*l-r*a,t[2]=s*l+o*a,t[3]=o*l-s*a,t}function Kn(t,e){var n=e[0],r=e[1],i=e[2];return t[0]=n,t[1]=r,t[2]=i,t[3]=Math.sqrt(Math.abs(1-n*n-r*r-i*i)),t}function Jn(t,e,n,r){var i=e[0],s=e[1],o=e[2],a=e[3],l=n[0],h=n[1],u=n[2],f=n[3],d=void 0,p=void 0,A=void 0,g=void 0,m=void 0;return p=i*l+s*h+o*u+a*f,p<0&&(p=-p,l=-l,h=-h,u=-u,f=-f),1-p>c?(d=Math.acos(p),A=Math.sin(d),g=Math.sin((1-r)*d)/A,m=Math.sin(r*d)/A):(g=1-r,m=r),t[0]=g*i+m*l,t[1]=g*s+m*h,t[2]=g*o+m*u,t[3]=g*a+m*f,t}function $n(t){var e=f(),n=f(),r=f(),i=Math.sqrt(1-e),s=Math.sqrt(e);return t[0]=i*Math.sin(2*Math.PI*n),t[1]=i*Math.cos(2*Math.PI*n),t[2]=s*Math.sin(2*Math.PI*r),t[3]=s*Math.cos(2*Math.PI*r),t}function tr(t,e){var n=e[0],r=e[1],i=e[2],s=e[3],o=n*n+r*r+i*i+s*s,a=o?1/o:0;return t[0]=-n*a,t[1]=-r*a,t[2]=-i*a,t[3]=s*a,t}function er(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function nr(t,e){var n=e[0]+e[4]+e[8],r=void 0;if(n>0)r=Math.sqrt(n+1),t[3]=.5*r,r=.5/r,t[0]=(e[5]-e[7])*r,t[1]=(e[6]-e[2])*r,t[2]=(e[1]-e[3])*r;else{var i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);var s=(i+1)%3,o=(i+2)%3;r=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*o+o]+1),t[i]=.5*r,r=.5/r,t[3]=(e[3*s+o]-e[3*o+s])*r,t[s]=(e[3*s+i]+e[3*i+s])*r,t[o]=(e[3*o+i]+e[3*i+o])*r}return t}function rr(t,e,n,r){var i=.5*Math.PI/180;e*=i,n*=i,r*=i;var s=Math.sin(e),o=Math.cos(e),a=Math.sin(n),l=Math.cos(n),h=Math.sin(r),c=Math.cos(r);return t[0]=s*l*c-o*a*h,t[1]=o*a*c+s*l*h,t[2]=o*l*h-s*a*c,t[3]=o*l*c+s*a*h,t}function ir(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}var sr=sn,or=on,ar=an,lr=ln,hr=hn,cr=Xn,ur=yn,fr=In,dr=Cn,pr=wn,Ar=pr,gr=_n,mr=gr,yr=Sn,vr=Rn,xr=Nn,br=function(){var t=ce(),e=de(1,0,0),n=de(0,1,0);return function(r,i,s){var o=Re(i,s);return o<-.999999?(Ne(t,e,i),tn(t)<1e-6&&Ne(t,n,i),ke(t,t),qn(r,t,Math.PI),r):o>.999999?(r[0]=0,r[1]=0,r[2]=0,r[3]=1,r):(Ne(t,i,s),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=1+o,yr(r,r))}}(),wr=function(){var t=Vn(),e=Vn();return function(n,r,i,s,o,a){return Jn(t,r,o,a),Jn(e,i,s,a),Jn(n,t,e,2*a*(1-a)),n}}(),_r=function(){var t=B();return function(e,n,r,i){return t[0]=r[0],t[3]=r[1],t[6]=r[2],t[1]=i[0],t[4]=i[1],t[7]=i[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],yr(e,nr(e,t))}}();function Mr(){var t=new u(2);return u!=Float32Array&&(t[0]=0,t[1]=0),t}function Tr(t){var e=new u(2);return e[0]=t[0],e[1]=t[1],e}function Sr(t,e){var n=new u(2);return n[0]=t,n[1]=e,n}function Ir(t,e){return t[0]=e[0],t[1]=e[1],t}function Cr(t,e,n){return t[0]=e,t[1]=n,t}function Or(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function Er(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function Pr(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function kr(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function Rr(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function Nr(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function Dr(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t}function Fr(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t}function Lr(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function zr(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function Br(t,e,n,r){return t[0]=e[0]+n[0]*r,t[1]=e[1]+n[1]*r,t}function Hr(t,e){var n=e[0]-t[0],r=e[1]-t[1];return Math.sqrt(n*n+r*r)}function Ur(t,e){var n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r}function jr(t){var e=t[0],n=t[1];return Math.sqrt(e*e+n*n)}function Vr(t){var e=t[0],n=t[1];return e*e+n*n}function Gr(t,e){return t[0]=-e[0],t[1]=-e[1],t}function qr(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function Wr(t,e){var n=e[0],r=e[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i),t[0]=e[0]*i,t[1]=e[1]*i),t}function Xr(t,e){return t[0]*e[0]+t[1]*e[1]}function Qr(t,e,n){var r=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=r,t}function Yr(t,e,n,r){var i=e[0],s=e[1];return t[0]=i+r*(n[0]-i),t[1]=s+r*(n[1]-s),t}function Zr(t,e){e=e||1;var n=2*f()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t}function Kr(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i,t[1]=n[1]*r+n[3]*i,t}function Jr(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[2]*i+n[4],t[1]=n[1]*r+n[3]*i+n[5],t}function $r(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[3]*i+n[6],t[1]=n[1]*r+n[4]*i+n[7],t}function ti(t,e,n){var r=e[0],i=e[1];return t[0]=n[0]*r+n[4]*i+n[12],t[1]=n[1]*r+n[5]*i+n[13],t}function ei(t,e,n,r){var i=e[0]-n[0],s=e[1]-n[1],o=Math.sin(r),a=Math.cos(r);return t[0]=i*a-s*o+n[0],t[1]=i*o+s*a+n[1],t}function ni(t,e){var n=t[0],r=t[1],i=e[0],s=e[1],o=n*n+r*r;o>0&&(o=1/Math.sqrt(o));var a=i*i+s*s;a>0&&(a=1/Math.sqrt(a));var l=(n*i+r*s)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function ri(t){return"vec2("+t[0]+", "+t[1]+")"}function ii(t,e){return t[0]===e[0]&&t[1]===e[1]}function si(t,e){var n=t[0],r=t[1],i=e[0],s=e[1];return Math.abs(n-i)<=c*Math.max(1,Math.abs(n),Math.abs(i))&&Math.abs(r-s)<=c*Math.max(1,Math.abs(r),Math.abs(s))}var oi=jr,ai=Er,li=Pr,hi=kr,ci=Hr,ui=Ur,fi=Vr,di=function(){var t=Mr();return function(e,n,r,i,s,o){var a=void 0,l=void 0;for(n||(n=2),r||(r=0),l=i?Math.min(i*n+r,e.length):e.length,a=r;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],s(t,t,o),e[a]=t[0],e[a+1]=t[1];return e}}()},c674:function(t,e,n){"use strict";function r(t,e){this.x=t,this.y=e}t.exports=r,r.prototype={clone:function(){return new r(this.x,this.y)},add:function(t){return this.clone()._add(t)},sub:function(t){return this.clone()._sub(t)},multByPoint:function(t){return this.clone()._multByPoint(t)},divByPoint:function(t){return this.clone()._divByPoint(t)},mult:function(t){return this.clone()._mult(t)},div:function(t){return this.clone()._div(t)},rotate:function(t){return this.clone()._rotate(t)},rotateAround:function(t,e){return this.clone()._rotateAround(t,e)},matMult:function(t){return this.clone()._matMult(t)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(t){return this.x===t.x&&this.y===t.y},dist:function(t){return Math.sqrt(this.distSqr(t))},distSqr:function(t){var e=t.x-this.x,n=t.y-this.y;return e*e+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(t){return Math.atan2(this.y-t.y,this.x-t.x)},angleWith:function(t){return this.angleWithSep(t.x,t.y)},angleWithSep:function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},_matMult:function(t){var e=t[0]*this.x+t[1]*this.y,n=t[2]*this.x+t[3]*this.y;return this.x=e,this.y=n,this},_add:function(t){return this.x+=t.x,this.y+=t.y,this},_sub:function(t){return this.x-=t.x,this.y-=t.y,this},_mult:function(t){return this.x*=t,this.y*=t,this},_div:function(t){return this.x/=t,this.y/=t,this},_multByPoint:function(t){return this.x*=t.x,this.y*=t.y,this},_divByPoint:function(t){return this.x/=t.x,this.y/=t.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var t=this.y;return this.y=this.x,this.x=-t,this},_rotate:function(t){var e=Math.cos(t),n=Math.sin(t),r=e*this.x-n*this.y,i=n*this.x+e*this.y;return this.x=r,this.y=i,this},_rotateAround:function(t,e){var n=Math.cos(t),r=Math.sin(t),i=e.x+n*(this.x-e.x)-r*(this.y-e.y),s=e.y+r*(this.x-e.x)+n*(this.y-e.y);return this.x=i,this.y=s,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},r.convert=function(t){return t instanceof r?t:Array.isArray(t)?new r(t[0],t[1]):t}},e470:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return kt})),n.d(e,"b",(function(){return Zr})),n.d(e,"c",(function(){return vi})),n.d(e,"d",(function(){return mi})),n.d(e,"e",(function(){return or})),n.d(e,"f",(function(){return $e})),n.d(e,"g",(function(){return zr})),n.d(e,"n",(function(){return zi}));var r=n("4e8c"),i=n.n(r);n.d(e,"h",(function(){return i.a}));var s=n("c19a");n.d(e,"m",(function(){return s}));var o=n("c3b8");n.d(e,"i",(function(){return o["a"]})),n.d(e,"j",(function(){return o["b"]})),n.d(e,"k",(function(){return o["c"]})),n.d(e,"l",(function(){return o["d"]})),n.d(e,"o",(function(){return o["e"]})),n.d(e,"p",(function(){return o["f"]})),n.d(e,"q",(function(){return o["g"]}));var a=n("18b7"),l=n("a4c2"),h={exports:{}},c={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]},u={exports:{}},f=function(t){return!(!t||"string"==typeof t)&&(t instanceof Array||Array.isArray(t)||t.length>=0&&(t.splice instanceof Function||Object.getOwnPropertyDescriptor(t,t.length-1)&&"String"!==t.constructor.name))},d=Array.prototype.concat,p=Array.prototype.slice,A=u.exports=function(t){for(var e=[],n=0,r=t.length;n<r;n++){var i=t[n];f(i)?e=d.call(e,p.call(i)):e.push(i)}return e};A.wrap=function(t){return function(){return t(A(arguments))}};var g=c,m=u.exports,y=Object.hasOwnProperty,v=Object.create(null);for(var x in g)y.call(g,x)&&(v[g[x]]=x);var b=h.exports={to:{},get:{}};function w(t,e,n){return Math.min(Math.max(e,t),n)}function _(t){var e=Math.round(t).toString(16).toUpperCase();return e.length<2?"0"+e:e}b.get=function(t){var e,n;switch(t.substring(0,3).toLowerCase()){case"hsl":e=b.get.hsl(t),n="hsl";break;case"hwb":e=b.get.hwb(t),n="hwb";break;default:e=b.get.rgb(t),n="rgb"}return e?{model:n,value:e}:null},b.get.rgb=function(t){if(!t)return null;var e,n,r,i=[0,0,0,1];if(e=t.match(/^#([a-f0-9]{6})([a-f0-9]{2})?$/i)){for(r=e[2],e=e[1],n=0;n<3;n++){var s=2*n;i[n]=parseInt(e.slice(s,s+2),16)}r&&(i[3]=parseInt(r,16)/255)}else if(e=t.match(/^#([a-f0-9]{3,4})$/i)){for(r=(e=e[1])[3],n=0;n<3;n++)i[n]=parseInt(e[n]+e[n],16);r&&(i[3]=parseInt(r+r,16)/255)}else if(e=t.match(/^rgba?\(\s*([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)(?=[\s,])\s*(?:,\s*)?([+-]?\d+)\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)){for(n=0;n<3;n++)i[n]=parseInt(e[n+1],0);e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}else{if(!(e=t.match(/^rgba?\(\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*,?\s*([+-]?[\d\.]+)\%\s*(?:[,|\/]\s*([+-]?[\d\.]+)(%?)\s*)?\)$/)))return(e=t.match(/^(\w+)$/))?"transparent"===e[1]?[0,0,0,0]:y.call(g,e[1])?((i=g[e[1]])[3]=1,i):null:null;for(n=0;n<3;n++)i[n]=Math.round(2.55*parseFloat(e[n+1]));e[4]&&(e[5]?i[3]=.01*parseFloat(e[4]):i[3]=parseFloat(e[4]))}for(n=0;n<3;n++)i[n]=w(i[n],0,255);return i[3]=w(i[3],0,1),i},b.get.hsl=function(t){if(!t)return null;var e=t.match(/^hsla?\(\s*([+-]?(?:\d{0,3}\.)?\d+)(?:deg)?\s*,?\s*([+-]?[\d\.]+)%\s*,?\s*([+-]?[\d\.]+)%\s*(?:[,|\/]\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,w(parseFloat(e[2]),0,100),w(parseFloat(e[3]),0,100),w(isNaN(n)?1:n,0,1)]}return null},b.get.hwb=function(t){if(!t)return null;var e=t.match(/^hwb\(\s*([+-]?\d{0,3}(?:\.\d+)?)(?:deg)?\s*,\s*([+-]?[\d\.]+)%\s*,\s*([+-]?[\d\.]+)%\s*(?:,\s*([+-]?(?=\.\d|\d)(?:0|[1-9]\d*)?(?:\.\d*)?(?:[eE][+-]?\d+)?)\s*)?\)$/);if(e){var n=parseFloat(e[4]);return[(parseFloat(e[1])%360+360)%360,w(parseFloat(e[2]),0,100),w(parseFloat(e[3]),0,100),w(isNaN(n)?1:n,0,1)]}return null},b.to.hex=function(){var t=m(arguments);return"#"+_(t[0])+_(t[1])+_(t[2])+(t[3]<1?_(Math.round(255*t[3])):"")},b.to.rgb=function(){var t=m(arguments);return t.length<4||1===t[3]?"rgb("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+")":"rgba("+Math.round(t[0])+", "+Math.round(t[1])+", "+Math.round(t[2])+", "+t[3]+")"},b.to.rgb.percent=function(){var t=m(arguments),e=Math.round(t[0]/255*100),n=Math.round(t[1]/255*100),r=Math.round(t[2]/255*100);return t.length<4||1===t[3]?"rgb("+e+"%, "+n+"%, "+r+"%)":"rgba("+e+"%, "+n+"%, "+r+"%, "+t[3]+")"},b.to.hsl=function(){var t=m(arguments);return t.length<4||1===t[3]?"hsl("+t[0]+", "+t[1]+"%, "+t[2]+"%)":"hsla("+t[0]+", "+t[1]+"%, "+t[2]+"%, "+t[3]+")"},b.to.hwb=function(){var t=m(arguments),e="";return t.length>=4&&1!==t[3]&&(e=", "+t[3]),"hwb("+t[0]+", "+t[1]+"%, "+t[2]+"%"+e+")"},b.to.keyword=function(t){return v[t.slice(0,3)]};var M={exports:{}},T=c,S={};for(var I in T)T.hasOwnProperty(I)&&(S[T[I]]=I);var C=M.exports={rgb:{channels:3,labels:"rgb"},hsl:{channels:3,labels:"hsl"},hsv:{channels:3,labels:"hsv"},hwb:{channels:3,labels:"hwb"},cmyk:{channels:4,labels:"cmyk"},xyz:{channels:3,labels:"xyz"},lab:{channels:3,labels:"lab"},lch:{channels:3,labels:"lch"},hex:{channels:1,labels:["hex"]},keyword:{channels:1,labels:["keyword"]},ansi16:{channels:1,labels:["ansi16"]},ansi256:{channels:1,labels:["ansi256"]},hcg:{channels:3,labels:["h","c","g"]},apple:{channels:3,labels:["r16","g16","b16"]},gray:{channels:1,labels:["gray"]}};for(var O in C)if(C.hasOwnProperty(O)){if(!("channels"in C[O]))throw new Error("missing channels property: "+O);if(!("labels"in C[O]))throw new Error("missing channel labels property: "+O);if(C[O].labels.length!==C[O].channels)throw new Error("channel and label counts mismatch: "+O);var E=C[O].channels,P=C[O].labels;delete C[O].channels,delete C[O].labels,Object.defineProperty(C[O],"channels",{value:E}),Object.defineProperty(C[O],"labels",{value:P})}C.rgb.hsl=function(t){var e,n,r=t[0]/255,i=t[1]/255,s=t[2]/255,o=Math.min(r,i,s),a=Math.max(r,i,s),l=a-o;return a===o?e=0:r===a?e=(i-s)/l:i===a?e=2+(s-r)/l:s===a&&(e=4+(r-i)/l),(e=Math.min(60*e,360))<0&&(e+=360),n=(o+a)/2,[e,100*(a===o?0:n<=.5?l/(a+o):l/(2-a-o)),100*n]},C.rgb.hsv=function(t){var e,n,r,i,s,o=t[0]/255,a=t[1]/255,l=t[2]/255,h=Math.max(o,a,l),c=h-Math.min(o,a,l),u=function(t){return(h-t)/6/c+.5};return 0===c?i=s=0:(s=c/h,e=u(o),n=u(a),r=u(l),o===h?i=r-n:a===h?i=1/3+e-r:l===h&&(i=2/3+n-e),i<0?i+=1:i>1&&(i-=1)),[360*i,100*s,100*h]},C.rgb.hwb=function(t){var e=t[0],n=t[1],r=t[2];return[C.rgb.hsl(t)[0],1/255*Math.min(e,Math.min(n,r))*100,100*(r=1-1/255*Math.max(e,Math.max(n,r)))]},C.rgb.cmyk=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255;return[100*((1-n-(e=Math.min(1-n,1-r,1-i)))/(1-e)||0),100*((1-r-e)/(1-e)||0),100*((1-i-e)/(1-e)||0),100*e]},C.rgb.keyword=function(t){var e=S[t];if(e)return e;var n,r,i,s=1/0;for(var o in T)if(T.hasOwnProperty(o)){var a=T[o],l=(r=t,i=a,Math.pow(r[0]-i[0],2)+Math.pow(r[1]-i[1],2)+Math.pow(r[2]-i[2],2));l<s&&(s=l,n=o)}return n},C.keyword.rgb=function(t){return T[t]},C.rgb.xyz=function(t){var e=t[0]/255,n=t[1]/255,r=t[2]/255;return[100*(.4124*(e=e>.04045?Math.pow((e+.055)/1.055,2.4):e/12.92)+.3576*(n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92)+.1805*(r=r>.04045?Math.pow((r+.055)/1.055,2.4):r/12.92)),100*(.2126*e+.7152*n+.0722*r),100*(.0193*e+.1192*n+.9505*r)]},C.rgb.lab=function(t){var e=C.rgb.xyz(t),n=e[0],r=e[1],i=e[2];return r/=100,i/=108.883,n=(n/=95.047)>.008856?Math.pow(n,1/3):7.787*n+16/116,[116*(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116)-16,500*(n-r),200*(r-(i=i>.008856?Math.pow(i,1/3):7.787*i+16/116))]},C.hsl.rgb=function(t){var e,n,r,i,s,o=t[0]/360,a=t[1]/100,l=t[2]/100;if(0===a)return[s=255*l,s,s];e=2*l-(n=l<.5?l*(1+a):l+a-l*a),i=[0,0,0];for(var h=0;h<3;h++)(r=o+1/3*-(h-1))<0&&r++,r>1&&r--,s=6*r<1?e+6*(n-e)*r:2*r<1?n:3*r<2?e+(n-e)*(2/3-r)*6:e,i[h]=255*s;return i},C.hsl.hsv=function(t){var e=t[0],n=t[1]/100,r=t[2]/100,i=n,s=Math.max(r,.01);return n*=(r*=2)<=1?r:2-r,i*=s<=1?s:2-s,[e,100*(0===r?2*i/(s+i):2*n/(r+n)),(r+n)/2*100]},C.hsv.rgb=function(t){var e=t[0]/60,n=t[1]/100,r=t[2]/100,i=Math.floor(e)%6,s=e-Math.floor(e),o=255*r*(1-n),a=255*r*(1-n*s),l=255*r*(1-n*(1-s));switch(r*=255,i){case 0:return[r,l,o];case 1:return[a,r,o];case 2:return[o,r,l];case 3:return[o,a,r];case 4:return[l,o,r];case 5:return[r,o,a]}},C.hsv.hsl=function(t){var e,n,r,i=t[0],s=t[1]/100,o=t[2]/100,a=Math.max(o,.01);return r=(2-s)*o,n=s*a,[i,100*(n=(n/=(e=(2-s)*a)<=1?e:2-e)||0),100*(r/=2)]},C.hwb.rgb=function(t){var e,n,r,i,s,o,a,l=t[0]/360,h=t[1]/100,c=t[2]/100,u=h+c;switch(u>1&&(h/=u,c/=u),r=6*l-(e=Math.floor(6*l)),0!=(1&e)&&(r=1-r),i=h+r*((n=1-c)-h),e){default:case 6:case 0:s=n,o=i,a=h;break;case 1:s=i,o=n,a=h;break;case 2:s=h,o=n,a=i;break;case 3:s=h,o=i,a=n;break;case 4:s=i,o=h,a=n;break;case 5:s=n,o=h,a=i}return[255*s,255*o,255*a]},C.cmyk.rgb=function(t){var e=t[0]/100,n=t[1]/100,r=t[2]/100,i=t[3]/100;return[255*(1-Math.min(1,e*(1-i)+i)),255*(1-Math.min(1,n*(1-i)+i)),255*(1-Math.min(1,r*(1-i)+i))]},C.xyz.rgb=function(t){var e,n,r,i=t[0]/100,s=t[1]/100,o=t[2]/100;return n=-.9689*i+1.8758*s+.0415*o,r=.0557*i+-.204*s+1.057*o,e=(e=3.2406*i+-1.5372*s+-.4986*o)>.0031308?1.055*Math.pow(e,1/2.4)-.055:12.92*e,n=n>.0031308?1.055*Math.pow(n,1/2.4)-.055:12.92*n,r=r>.0031308?1.055*Math.pow(r,1/2.4)-.055:12.92*r,[255*(e=Math.min(Math.max(0,e),1)),255*(n=Math.min(Math.max(0,n),1)),255*(r=Math.min(Math.max(0,r),1))]},C.xyz.lab=function(t){var e=t[0],n=t[1],r=t[2];return n/=100,r/=108.883,e=(e/=95.047)>.008856?Math.pow(e,1/3):7.787*e+16/116,[116*(n=n>.008856?Math.pow(n,1/3):7.787*n+16/116)-16,500*(e-n),200*(n-(r=r>.008856?Math.pow(r,1/3):7.787*r+16/116))]},C.lab.xyz=function(t){var e,n,r,i=t[0];e=t[1]/500+(n=(i+16)/116),r=n-t[2]/200;var s=Math.pow(n,3),o=Math.pow(e,3),a=Math.pow(r,3);return n=s>.008856?s:(n-16/116)/7.787,e=o>.008856?o:(e-16/116)/7.787,r=a>.008856?a:(r-16/116)/7.787,[e*=95.047,n*=100,r*=108.883]},C.lab.lch=function(t){var e,n=t[0],r=t[1],i=t[2];return(e=360*Math.atan2(i,r)/2/Math.PI)<0&&(e+=360),[n,Math.sqrt(r*r+i*i),e]},C.lch.lab=function(t){var e,n=t[0],r=t[1];return e=t[2]/360*2*Math.PI,[n,r*Math.cos(e),r*Math.sin(e)]},C.rgb.ansi16=function(t){var e=t[0],n=t[1],r=t[2],i=1 in arguments?arguments[1]:C.rgb.hsv(t)[2];if(0===(i=Math.round(i/50)))return 30;var s=30+(Math.round(r/255)<<2|Math.round(n/255)<<1|Math.round(e/255));return 2===i&&(s+=60),s},C.hsv.ansi16=function(t){return C.rgb.ansi16(C.hsv.rgb(t),t[2])},C.rgb.ansi256=function(t){var e=t[0],n=t[1],r=t[2];return e===n&&n===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(n/255*5)+Math.round(r/255*5)},C.ansi16.rgb=function(t){var e=t%10;if(0===e||7===e)return t>50&&(e+=3.5),[e=e/10.5*255,e,e];var n=.5*(1+~~(t>50));return[(1&e)*n*255,(e>>1&1)*n*255,(e>>2&1)*n*255]},C.ansi256.rgb=function(t){if(t>=232){var e=10*(t-232)+8;return[e,e,e]}var n;return t-=16,[Math.floor(t/36)/5*255,Math.floor((n=t%36)/6)/5*255,n%6/5*255]},C.rgb.hex=function(t){var e=(((255&Math.round(t[0]))<<16)+((255&Math.round(t[1]))<<8)+(255&Math.round(t[2]))).toString(16).toUpperCase();return"000000".substring(e.length)+e},C.hex.rgb=function(t){var e=t.toString(16).match(/[a-f0-9]{6}|[a-f0-9]{3}/i);if(!e)return[0,0,0];var n=e[0];3===e[0].length&&(n=n.split("").map((function(t){return t+t})).join(""));var r=parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},C.rgb.hcg=function(t){var e,n=t[0]/255,r=t[1]/255,i=t[2]/255,s=Math.max(Math.max(n,r),i),o=Math.min(Math.min(n,r),i),a=s-o;return e=a<=0?0:s===n?(r-i)/a%6:s===r?2+(i-n)/a:4+(n-r)/a+4,e/=6,[360*(e%=1),100*a,100*(a<1?o/(1-a):0)]},C.hsl.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=1,i=0;return(r=n<.5?2*e*n:2*e*(1-n))<1&&(i=(n-.5*r)/(1-r)),[t[0],100*r,100*i]},C.hsv.hcg=function(t){var e=t[1]/100,n=t[2]/100,r=e*n,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},C.hcg.rgb=function(t){var e=t[0]/360,n=t[1]/100,r=t[2]/100;if(0===n)return[255*r,255*r,255*r];var i,s=[0,0,0],o=e%1*6,a=o%1,l=1-a;switch(Math.floor(o)){case 0:s[0]=1,s[1]=a,s[2]=0;break;case 1:s[0]=l,s[1]=1,s[2]=0;break;case 2:s[0]=0,s[1]=1,s[2]=a;break;case 3:s[0]=0,s[1]=l,s[2]=1;break;case 4:s[0]=a,s[1]=0,s[2]=1;break;default:s[0]=1,s[1]=0,s[2]=l}return i=(1-n)*r,[255*(n*s[0]+i),255*(n*s[1]+i),255*(n*s[2]+i)]},C.hcg.hsv=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e),r=0;return n>0&&(r=e/n),[t[0],100*r,100*n]},C.hcg.hsl=function(t){var e=t[1]/100,n=t[2]/100*(1-e)+.5*e,r=0;return n>0&&n<.5?r=e/(2*n):n>=.5&&n<1&&(r=e/(2*(1-n))),[t[0],100*r,100*n]},C.hcg.hwb=function(t){var e=t[1]/100,n=e+t[2]/100*(1-e);return[t[0],100*(n-e),100*(1-n)]},C.hwb.hcg=function(t){var e=t[1]/100,n=1-t[2]/100,r=n-e,i=0;return r<1&&(i=(n-r)/(1-r)),[t[0],100*r,100*i]},C.apple.rgb=function(t){return[t[0]/65535*255,t[1]/65535*255,t[2]/65535*255]},C.rgb.apple=function(t){return[t[0]/255*65535,t[1]/255*65535,t[2]/255*65535]},C.gray.rgb=function(t){return[t[0]/100*255,t[0]/100*255,t[0]/100*255]},C.gray.hsl=C.gray.hsv=function(t){return[0,0,t[0]]},C.gray.hwb=function(t){return[0,100,t[0]]},C.gray.cmyk=function(t){return[0,0,0,t[0]]},C.gray.lab=function(t){return[t[0],0,0]},C.gray.hex=function(t){var e=255&Math.round(t[0]/100*255),n=((e<<16)+(e<<8)+e).toString(16).toUpperCase();return"000000".substring(n.length)+n},C.rgb.gray=function(t){return[(t[0]+t[1]+t[2])/3/255*100]};var k=M.exports;function R(t){var e=function(){for(var t={},e=Object.keys(k),n=e.length,r=0;r<n;r++)t[e[r]]={distance:-1,parent:null};return t}(),n=[t];for(e[t].distance=0;n.length;)for(var r=n.pop(),i=Object.keys(k[r]),s=i.length,o=0;o<s;o++){var a=i[o],l=e[a];-1===l.distance&&(l.distance=e[r].distance+1,l.parent=r,n.unshift(a))}return e}function N(t,e){return function(n){return e(t(n))}}function D(t,e){for(var n=[e[t].parent,t],r=k[e[t].parent][t],i=e[t].parent;e[i].parent;)n.unshift(e[i].parent),r=N(k[e[i].parent][i],r),i=e[i].parent;return r.conversion=n,r}var F=M.exports,L=function(t){for(var e=R(t),n={},r=Object.keys(e),i=r.length,s=0;s<i;s++){var o=r[s];null!==e[o].parent&&(n[o]=D(o,e))}return n},z={};Object.keys(F).forEach((function(t){z[t]={},Object.defineProperty(z[t],"channels",{value:F[t].channels}),Object.defineProperty(z[t],"labels",{value:F[t].labels});var e=L(t);Object.keys(e).forEach((function(n){var r=e[n];z[t][n]=function(t){var e=function(e){if(null==e)return e;arguments.length>1&&(e=Array.prototype.slice.call(arguments));var n=t(e);if("object"==typeof n)for(var r=n.length,i=0;i<r;i++)n[i]=Math.round(n[i]);return n};return"conversion"in t&&(e.conversion=t.conversion),e}(r),z[t][n].raw=function(t){var e=function(e){return null==e?e:(arguments.length>1&&(e=Array.prototype.slice.call(arguments)),t(e))};return"conversion"in t&&(e.conversion=t.conversion),e}(r)}))}));var B=z,H=h.exports,U=B,j=[].slice,V=["keyword","gray","hex"],G={};Object.keys(U).forEach((function(t){G[j.call(U[t].labels).sort().join("")]=t}));var q={};function W(t,e){if(!(this instanceof W))return new W(t,e);if(e&&e in V&&(e=null),e&&!(e in U))throw new Error("Unknown model: "+e);var n,r;if(null==t)this.model="rgb",this.color=[0,0,0],this.valpha=1;else if(t instanceof W)this.model=t.model,this.color=t.color.slice(),this.valpha=t.valpha;else if("string"==typeof t){var i=H.get(t);if(null===i)throw new Error("Unable to parse color from string: "+t);this.model=i.model,r=U[this.model].channels,this.color=i.value.slice(0,r),this.valpha="number"==typeof i.value[r]?i.value[r]:1}else if(t.length){this.model=e||"rgb",r=U[this.model].channels;var s=j.call(t,0,r);this.color=Z(s,r),this.valpha="number"==typeof t[r]?t[r]:1}else if("number"==typeof t)t&=16777215,this.model="rgb",this.color=[t>>16&255,t>>8&255,255&t],this.valpha=1;else{this.valpha=1;var o=Object.keys(t);"alpha"in t&&(o.splice(o.indexOf("alpha"),1),this.valpha="number"==typeof t.alpha?t.alpha:0);var a=o.sort().join("");if(!(a in G))throw new Error("Unable to parse color from object: "+JSON.stringify(t));this.model=G[a];var l=U[this.model].labels,h=[];for(n=0;n<l.length;n++)h.push(t[l[n]]);this.color=Z(h)}if(q[this.model])for(r=U[this.model].channels,n=0;n<r;n++){var c=q[this.model][n];c&&(this.color[n]=c(this.color[n]))}this.valpha=Math.max(0,Math.min(1,this.valpha)),Object.freeze&&Object.freeze(this)}function X(t,e,n){return(t=Array.isArray(t)?t:[t]).forEach((function(t){(q[t]||(q[t]=[]))[e]=n})),t=t[0],function(r){var i;return arguments.length?(n&&(r=n(r)),(i=this[t]()).color[e]=r,i):(i=this[t]().color[e],n&&(i=n(i)),i)}}function Q(t){return function(e){return Math.max(0,Math.min(t,e))}}function Y(t){return Array.isArray(t)?t:[t]}function Z(t,e){for(var n=0;n<e;n++)"number"!=typeof t[n]&&(t[n]=0);return t}W.prototype={toString:function(){return this.string()},toJSON:function(){return this[this.model]()},string:function(t){var e=this.model in H.to?this:this.rgb(),n=1===(e=e.round("number"==typeof t?t:1)).valpha?e.color:e.color.concat(this.valpha);return H.to[e.model](n)},percentString:function(t){var e=this.rgb().round("number"==typeof t?t:1),n=1===e.valpha?e.color:e.color.concat(this.valpha);return H.to.rgb.percent(n)},array:function(){return 1===this.valpha?this.color.slice():this.color.concat(this.valpha)},object:function(){for(var t={},e=U[this.model].channels,n=U[this.model].labels,r=0;r<e;r++)t[n[r]]=this.color[r];return 1!==this.valpha&&(t.alpha=this.valpha),t},unitArray:function(){var t=this.rgb().color;return t[0]/=255,t[1]/=255,t[2]/=255,1!==this.valpha&&t.push(this.valpha),t},unitObject:function(){var t=this.rgb().object();return t.r/=255,t.g/=255,t.b/=255,1!==this.valpha&&(t.alpha=this.valpha),t},round:function(t){return t=Math.max(t||0,0),new W(this.color.map(function(t){return function(e){return function(t,e){return Number(t.toFixed(e))}(e,t)}}(t)).concat(this.valpha),this.model)},alpha:function(t){return arguments.length?new W(this.color.concat(Math.max(0,Math.min(1,t))),this.model):this.valpha},red:X("rgb",0,Q(255)),green:X("rgb",1,Q(255)),blue:X("rgb",2,Q(255)),hue:X(["hsl","hsv","hsl","hwb","hcg"],0,(function(t){return(t%360+360)%360})),saturationl:X("hsl",1,Q(100)),lightness:X("hsl",2,Q(100)),saturationv:X("hsv",1,Q(100)),value:X("hsv",2,Q(100)),chroma:X("hcg",1,Q(100)),gray:X("hcg",2,Q(100)),white:X("hwb",1,Q(100)),wblack:X("hwb",2,Q(100)),cyan:X("cmyk",0,Q(100)),magenta:X("cmyk",1,Q(100)),yellow:X("cmyk",2,Q(100)),black:X("cmyk",3,Q(100)),x:X("xyz",0,Q(100)),y:X("xyz",1,Q(100)),z:X("xyz",2,Q(100)),l:X("lab",0,Q(100)),a:X("lab",1),b:X("lab",2),keyword:function(t){return arguments.length?new W(t):U[this.model].keyword(this.color)},hex:function(t){return arguments.length?new W(t):H.to.hex(this.rgb().round().color)},rgbNumber:function(){var t=this.rgb().color;return(255&t[0])<<16|(255&t[1])<<8|255&t[2]},luminosity:function(){for(var t=this.rgb().color,e=[],n=0;n<t.length;n++){var r=t[n]/255;e[n]=r<=.03928?r/12.92:Math.pow((r+.055)/1.055,2.4)}return.2126*e[0]+.7152*e[1]+.0722*e[2]},contrast:function(t){var e=this.luminosity(),n=t.luminosity();return e>n?(e+.05)/(n+.05):(n+.05)/(e+.05)},level:function(t){var e=this.contrast(t);return e>=7.1?"AAA":e>=4.5?"AA":""},isDark:function(){var t=this.rgb().color;return(299*t[0]+587*t[1]+114*t[2])/1e3<128},isLight:function(){return!this.isDark()},negate:function(){for(var t=this.rgb(),e=0;e<3;e++)t.color[e]=255-t.color[e];return t},lighten:function(t){var e=this.hsl();return e.color[2]+=e.color[2]*t,e},darken:function(t){var e=this.hsl();return e.color[2]-=e.color[2]*t,e},saturate:function(t){var e=this.hsl();return e.color[1]+=e.color[1]*t,e},desaturate:function(t){var e=this.hsl();return e.color[1]-=e.color[1]*t,e},whiten:function(t){var e=this.hwb();return e.color[1]+=e.color[1]*t,e},blacken:function(t){var e=this.hwb();return e.color[2]+=e.color[2]*t,e},grayscale:function(){var t=this.rgb().color,e=.3*t[0]+.59*t[1]+.11*t[2];return W.rgb(e,e,e)},fade:function(t){return this.alpha(this.valpha-this.valpha*t)},opaquer:function(t){return this.alpha(this.valpha+this.valpha*t)},rotate:function(t){var e=this.hsl(),n=e.color[0];return n=(n=(n+t)%360)<0?360+n:n,e.color[0]=n,e},mix:function(t,e){if(!t||!t.rgb)throw new Error('Argument to "mix" was not a Color instance, but rather an instance of '+typeof t);var n=t.rgb(),r=this.rgb(),i=void 0===e?.5:e,s=2*i-1,o=n.alpha()-r.alpha(),a=((s*o==-1?s:(s+o)/(1+s*o))+1)/2,l=1-a;return W.rgb(a*n.red()+l*r.red(),a*n.green()+l*r.green(),a*n.blue()+l*r.blue(),n.alpha()*i+r.alpha()*(1-i))}},Object.keys(U).forEach((function(t){if(-1===V.indexOf(t)){var e=U[t].channels;W.prototype[t]=function(){if(this.model===t)return new W(this);if(arguments.length)return new W(arguments,t);var n="number"==typeof arguments[e]?e:this.valpha;return new W(Y(U[this.model][t].raw(this.color)).concat(n),t)},W[t]=function(n){return"number"==typeof n&&(n=Z(j.call(arguments),e)),new W(n,t)}}}));var K=W;const J="function"==typeof Object.assign,$=[];function tt(t){if(J)Object.assign.apply(Object,arguments);else for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function et(t){return null==t}function nt(t){return"number"==typeof t&&!isNaN(t)}const rt=[];function it(t,e){const n=e._get2DExtentAtRes(e.getGLRes()),r=n.getWidth(),i=n.getHeight(),s=t;o["c"].identity(s);const a=o["f"].copy($,e.cameraLookAt);return a[2]=0,o["c"].translate(s,s,a),o["c"].scale(s,s,o["f"].set(rt,r,i,1)),s}function st(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function ot(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(n)for(let e=0,r=n.length;e<r;e++)t.push(n[e])}return t.length}const at={};function lt(t,e){if(!Array.isArray(e)){const t=e;e=at[t]=at[t]||K(e).array()}for(let n=0;n<e.length;n++)t[n]=e[n];return 3===e.length&&(t[3]=1),t}function ht(t,e){if(Array.isArray(e))for(let n=0;n<e.length;n++)t[n]=255*e[n];else{const n=e;e=at[n]=at[n]||K(e).array();for(let r=0;r<e.length;r++)t[r]=e[r]}return 3===t.length&&t.push(255),t}function ct(t,e,n=0){if(!(t&&e instanceof a["f"]))return null;const r=t.coordinateToPointAtRes(e,t.getGLRes());return[r.x,r.y,n]}const ut=[0,0],ft=[0,0,0];let dt;class pt{static getUniformDeclares(){const t=[],e=[];return e.push({name:"shadow_lightProjViewModelMatrix",type:"function",fn:function(e,n){const r=n.shadow_lightProjViewMatrix,i=n.modelMatrix;return o["c"].multiply(t,r,i)}}),e.push("shadow_shadowMap","shadow_opacity","esm_shadow_threshold","shadow_color","shadow_nearFar"),e}constructor(t,e,n){this.renderer=new s["Renderer"](t),this.sceneConfig=e,this.t=.3,this.s=n,this.h()}resize(){const t=this.canvas;t.width=this.s.getRenderer().canvas.width,t.height=this.s.getRenderer().canvas.height}h(){const t=this.sceneConfig.shadow||{};let e=512;const n=t.quality;"high"===n?e=2048:"medium"===n&&(e=1024);const r=this.getDefines();this.o=new s["ShadowPass"](this.renderer,{width:e,height:e,blurOffset:t.blurOffset,defines:r}),this.u=new s["ShadowDisplayShader"](r),this.p()}getDefines(){return{HAS_SHADOWING:1,PACK_FLOAT:1,USE_ESM:1}}render(t,e,n,r,i,s,a,l,h,c){this.m();const u=this.s.getMap();let f,d;if(c||this.v(u,a,!!t)){this._=this._||[],this.M=this.M||[];const r=o["c"].multiply(this._,e,n),i=o["f"].normalize(this.M,s);dt||(dt=u.getContainerExtent());let l=u.height;u.getPitch()>62&&(l=u._getVisualHeight(62));const h=dt.set(0,u.height-l,u.width,u.height).convertTo(t=>u._containerPointToPointAtRes(t,u.getGLRes())).toArray();t&&a.addMesh(this.S);const c=h.map(t=>[t.x,t.y,0,1]),{lightProjViewMatrix:p,shadowMap:A,blurFBO:g}=this.o.render(a,{cameraProjViewMatrix:r,lightDir:i,farPlane:c,cameraLookAt:u.cameraLookAt});f=this.C=p,d=this.T=A,this.k=g,this.A=a.getMeshes().reduce((t,e)=>(e.castShadow&&e.geometry&&(t[e.uuid]={v0:e.version,v1:e.geometry.version}),t),{}),this.O={count:a.getMeshes().length-+!!t,displayShadow:!!t},this.I=!0}else f=this.C,d=this.T,this.I=!1;return this.L=e,this.F=n,et(i)&&(i=1),t&&a.getMeshes().length&&this.displayShadow(r,i,l,h),{shadow_lightProjViewMatrix:f,shadow_shadowMap:d,shadow_opacity:i,shadow_color:r||ft,esm_shadow_threshold:this.t}}displayShadow(t,e,n,r){const i=this.C,s=this.S,a=this.R||[],l=this.s.getRenderer().canvas,h=this.P=this.P||[];h[0]=l.width,h[1]=l.height,this.renderer.render(this.u,{halton:n||ut,globalTexSize:h,projMatrix:this.L,viewMatrix:this.F,shadow_lightProjViewModelMatrix:o["c"].multiply(a,i,s.localTransform),shadow_shadowMap:this.T,esm_shadow_threshold:this.t,shadow_opacity:e,color:t||ft},this.D,r)}dispose(){this.o.dispose(),this.u.dispose(),this.S&&(this.S.geometry.dispose(),this.S.dispose()),delete this.renderer}isUpdated(){return!1!==this.I}v(t,e,n){if(!this.A)return!0;const r=this.O;if(e.getMeshes().length!==r.count||n!==r.displayShadow)return!0;const i=e.getMeshes();for(let s=0;s<i.length;s++){const t=this.A[i[s].uuid];if(i[s].castShadow&&(i[s].hasSkinAnimation()||!t||t.v0!==i[s].version||t.v1!==i[s].geometry.version))return!0}return!1}p(){const t=new s["Plane"];t.generateBuffers(this.renderer.regl),this.S=new s["Mesh"](t),this.D=new s["Scene"]([this.S])}m(){const t=this.s.getMap(),e=it(this.S.localTransform,t);this.S.setLocalTransform(e)}}const At=[0,0],gt=new a["f"](0,0),mt=new a["f"](0,0),yt=[],vt=[],xt=[];function bt(t,e,n,r){const i=t.getGLRes(),s=t.distanceToPointAtRes(e,e,i,n?gt:null,mt);return r?s.y:s.x}const{createIBLTextures:wt,disposeIBLTextures:_t,getPBRUniforms:Mt}=s["pbr"].PBRUtils,Tt=[0,0],St=[1,1],It=[],Ct=[],Ot=[],Et=[],Pt=[];class kt{static getGroundTransform(t,e){return it(t,e)}constructor(t,e){this.H=t,this.renderer=new s["Renderer"](t),this.s=e,this.N=new s["ResourceLoader"],this.G=this.j.bind(this),this.h()}needToRedraw(){const t=this.B();return t&&(t[0]||t[1])}getMap(){return this.s&&this.s.getMap()}getSymbol(){const t=this.s.getGroundConfig();return t&&t.symbol}isEnable(){const t=this.s.getGroundConfig();return t&&t.enable}paint(t){if(!this.isEnable())return!1;const e=this.U();if(this.V(t)&&e===this.W)return!1;const n=this.q(t);n&&this.S.setDefines(n),this.S.material!==this.material&&this.S.setMaterial(this.material);const r=this.s.getGroundConfig();(r&&r.symbol).ssr?this.S.ssr=1:this.S.ssr=0,this.m();const i=this.$(t);i.offsetFactor=t.offsetFactor,i.offsetUnits=t.offsetUnits;const s=t&&t.renderTarget&&t.renderTarget.fbo;return e===this.W?(this.renderer.render(e,i,this.D,s),this.s.getRenderer().setCanvasUpdated(),!0):(e.filter=t.sceneFilter,this.renderer.render(e,i,this.D,s),this.s.getRenderer().setCanvasUpdated(),!0)}V(t){return!(!this.s.getRenderer().isEnableSSR||!this.s.getRenderer().isEnableSSR())&&!(!t||!t.ssr)}update(){const t=this.s.getGroundConfig();if(!t)return;const e=t&&t.symbol,n=t.urlModifier;if(e){this.Y=this.X(e.polygonFill||[1,1,1,1]),this.J=void 0===e.polygonOpacity?1:e.polygonOpacity;const t=e.polygonPatternFile;if(t){if(!this.Z||this.Z._pattern_src!==t){const e=new Image;e.onload=()=>{this.Z&&this.Z.destroy(),this.Z=this.K(e),this.Z._pattern_src=t,this.setToRedraw()},e.src=n&&n(t)||t}}else this.Z&&(this.Z.destroy(),delete this.Z)}else this.Y=[1,1,1,1],this.J=1,this.Z&&(this.Z.destroy(),delete this.Z);this.tt()}setToRedraw(){const t=this.s.getRenderer();t&&t.setToRedraw()}dispose(){this.material&&(this.material.dispose(),delete this.material),this.S&&(this.S.geometry.dispose(),this.S.material&&this.S.material.dispose(),this.S.dispose(),delete this.S),this.Z&&(this.Z.destroy(),delete this.Z),this.W&&(this.W.dispose(),delete this.W),this.it&&(this.it.dispose(),delete this.it),this.et(),this.st&&(this.st.destroy(),delete this.st);const t=this.getMap();t&&t.off("updatelights",this.nt,this)}U(){const t=this.s.getGroundConfig();if(!t||!t.renderPlugin)return this.W;const e=t.renderPlugin.type;if("lit"===e)return this.it;if("fill"===e)return this.W;throw new Error("unsupported render plugin of "+e+" for layer ground")}$(t){const e=this.rt(t);return e.polygonFill=this.Y,e.polygonOpacity=this.J,this.U()===this.W&&this.Z&&(e.polygonPatternFile=this.Z),e}rt(t){let e;return"lit"===this.s.getGroundConfig().renderPlugin.type?(this.ht||(this.ht=wt(this.H,this.getMap())),this.st||(this.st=s["pbr"].PBRHelper.generateDFGLUT(this.H)),e=Mt(this.getMap(),this.ht,this.st,t&&t.ssr,t&&t.jitter)):e={projViewMatrix:this.getMap().projViewMatrix},this.ot(e,t),e}ot(t,e){const n=e&&e.includes;if(n)for(const r in n)n[r]&&e[r].renderUniforms&&tt(t,e[r].renderUniforms)}et(){this.ht&&(_t(this.ht),delete this.ht)}h(){this.getMap().on("updatelights",this.nt,this);const t=this.ct(),e=pt.getUniformDeclares(),n=[];e.push({name:"projViewModelMatrix",type:"function",fn:function(t,e){return o["c"].multiply(n,e.projViewMatrix,e.modelMatrix)}}),this.W=new s["MeshShader"]({vert:"attribute vec3 aPosition;\nuniform mat4 projViewModelMatrix;\nuniform mat4 modelMatrix;\n#ifdef HAS_PATTERN\n    attribute vec2 aTexCoord;\n    uniform vec2 uvScale;\n    uniform vec2 uvOffset;\n    varying vec2 vTexCoord;\n#endif\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_vert>\n#endif\nvoid main () {\n    #ifdef HAS_PATTERN\n        vTexCoord = aTexCoord * uvScale + uvOffset;\n    #endif\n    vec3 position = vec3(aPosition);\n    gl_Position = projViewModelMatrix * vec4(position, 1.0);\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        shadow_computeShadowPars(vec4(position, 1.0));\n    #endif\n}",frag:"precision mediump float;\n#if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n    #include <vsm_shadow_frag>\n#endif\n#ifdef HAS_PATTERN\n    uniform sampler2D polygonPatternFile;\n    varying vec2 vTexCoord;\n#endif\nuniform vec4 polygonFill;\nuniform float polygonOpacity;\nvoid main() {\n    #ifdef HAS_PATTERN\n        vec4 color = texture2D(polygonPatternFile, vTexCoord);\n    #else\n        vec4 color = polygonFill;\n    #endif\n    gl_FragColor = color * polygonOpacity;\n    #if defined(HAS_SHADOWING) && !defined(HAS_BLOOM)\n        float shadowCoeff = shadow_computeShadow();\n        gl_FragColor.rgb = shadow_blend(gl_FragColor.rgb, shadowCoeff);\n    #endif\n}",uniforms:e,extraCommandProps:t});const r=pt.getUniformDeclares();r.push(...s["SsrPass"].getUniformDeclares()),this.it=new s["pbr"].StandardShader({uniforms:r,extraCommandProps:t}),this.p(),this.update()}ct(){const t=[0,1],e=this.s.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>e.width,height:()=>e.height},cull:{enable:!0},depth:{enable:!0,mask:()=>{const t=this.s.getGroundConfig();return t.depth||void 0===t.depth},range:()=>{const e=this.s.getGroundConfig(),n=e&&e.renderPlugin.sceneConfig;return n&&n.depthRange||t},func:"<="},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"},polygonOffset:{enable:!0,offset:{factor:(t,e)=>e.offsetFactor,units:(t,e)=>e.offsetUnits}}}}lt(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}p(){const t=new s["Plane"];t.data.aTexCoord=new Uint8Array([0,0,1,0,0,1,1,1]),t.createTangent(),t.generateBuffers(this.renderer.regl),this.S=new s["Mesh"](t,null,{castShadow:!1});const e=this.it.getGeometryDefines(t);this.S.setDefines(e),this.D=new s["Scene"]([this.S])}m(){const t=this.getMap(),e=kt.getGroundTransform(this.S.localTransform,t);this.S.setLocalTransform(e);const n=t.getGLRes(),r=t._get2DExtentAtRes(n),i=r.getWidth(),s=r.getHeight(),a=t.cameraLookAt,l=a[0]-i,h=a[1]-s,c=this.Z?this.Z.width/this.Z.height:1,u=this.getSymbol(),f=this.material?this.material.get("textureOrigin"):u.polygonPatternFileOrigin,d=!!(this.material?this.material.get("uvOffsetInMeter"):u.uvOffsetInMeter),p=(this.material?this.material.get("uvOffset"):u.uvOffset)||Tt,A=this.material&&this.material.get("uvScale")||St,g=this.material?this.material.get("textureWidth"):u.polygonPatternFileWidth,m=this.material?g*(A[1]/A[0]):u.polygonPatternFileHeight,y=this.B(),[v,x,b,w,_]=function(t,e,n,r,i,s,a,l,h,c,u){const f=t.getGLRes();r&&(gt.set(r[0],r[1]),t.coordToPointAtRes(gt,f,mt),e-=mt.x,n-=mt.y);const d=r?gt:null;c=o["e"].copy(vt,c);const p=!h&&c||At;let A=h&&c||At;A=o["e"].copy(yt,A),A[0]&&(A[0]=bt(t,A[0],d)),A[1]&&(A[1]=bt(t,A[1],d,1));let g=.5;i&&(g=bt(t,i,d));let m=g/a;if(s&&(m=bt(t,s,d,1)),u&&(u[0]||u[1])){const e=performance.now()/1e3;let n=u[0],r=u[1];h&&(n=-bt(t,u[0],d),r=-bt(t,u[1],d,1)),u[0]&&(h?A[0]=e*n:p[0]=e*n),u[1]&&(h?A[1]=e*r:p[1]=e*r)}const y=(e+A[0])/(g/l[0]),v=(n-A[1])/(m/l[1]);return xt[0]=g/l[0],xt[1]=m/l[1],xt[2]=y,xt[3]=v,xt[4]=p,xt}(t,l,h,f,g,m,c,A,d,p,y),M=2*r.getWidth()/v,T=2*r.getHeight()/x;if(!this.material)return this.S.setUniform("uvScale",o["e"].set(It,M,T)),void this.S.setUniform("uvOffset",o["e"].set(Ct,b%1+_[0],w%1+_[1]));this.S.setUniform("uvScale",o["e"].set(Pt,M,T)),this.S.setUniform("uvOffset",o["e"].set(Ot,b%1+_[0],w%1+_[1])),this.S.setUniform("uvOrigin",o["e"].set(Et,b-b%1,w-w%1)),this.S.setUniform("uvRotation",0)}q(t){let e=!1;const n=this.S.defines,r=this.s.ut&&this.s.ut(),i=this.s.getGroundConfig();function s(t,r){t?n[r]||(n[r]=1,e=!0):n[r]&&(delete n[r],e=!0)}s(this.lt(),"HAS_IBL_LIGHTING"),s(t&&t.ssr&&i&&i.symbol&&i.symbol.ssr,"HAS_SSR");const o=t&&r&&r.shadow&&r.shadow.enable;return s(o,"HAS_SHADOWING"),s(o,"USE_ESM"),s(!!this.Z,"HAS_PATTERN"),s(t&&t.ssao,"HAS_SSAO"),e?n:null}tt(){const t=this.getSymbol()&&this.getSymbol().material;if(!t)return;const e={};let n=!1;const r=this.s.getGroundConfig();this.N.setURLModifier(r.urlModifier);for(const i in t)if(st(t,i))if(i.indexOf("Texture")>0){let r=t[i];if(!r)continue;r="string"==typeof r?{url:r,wrap:"repeat"}:r,r.flipY=!0,r.min="linear mipmap linear",r.mag="linear",r.flipY=!0,e[i]=new s["Texture2D"](r,this.N),n=!0}else e[i]=t[i];this.material?(this.ft=new s["pbr"].StandardMaterial(e),this.ft.isReady()?this.j():this.ft.once("complete",this.G)):(this.material=new s["pbr"].StandardMaterial(e),this.material.once("complete",this.G,this)),n||this.j()}j(){this.ft&&(this.material.dispose(),this.material=this.ft,delete this.ft),this.setToRedraw(!0)}K(t){t=s["Util"].resizeToPowerOfTwo(t);const e=this.H,n={width:t.width,height:t.height,data:t,mag:"linear",min:"linear mipmap linear",flipY:!0,wrap:"repeat"};return e.texture(n)}nt(t){if(t.ambientUpdate){this.et();const t=this.getMap();t&&(this.ht=wt(this.H,t))}this.setToRedraw()}X(t){return lt([],t)}B(){return this.material&&this.material.get("uvOffsetAnim")}getRenderMeshes(){return this.D.getMeshes()}}const{createIBLTextures:Rt,disposeIBLTextures:Nt}=s["pbr"].PBRUtils,Dt=[0,0,0],Ft=[],Lt=[];class zt{constructor(t,e){this.dt=4,this.H=t,this.renderer=new s["Renderer"](t),this.s=e,this.h(),this.pt()}paint(t){if(!this.isEnable()||!this.gt)return;const e=this.$(t),n=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.vt,e,null,n)}update(){const t=this.getMap();if(!t||!this.isEnable())return;const e=t.getLightManager(),n=e&&e.getAmbientResource();n!==this.gt&&this.ht&&(Nt(this.ht),delete this.ht),this.gt=n,this.pt()}dispose(){this.vt.dispose(),Nt(this.ht),delete this.vt,delete this.ht,delete this.gt}getMap(){return this.s.getMap()}pt(){if(!this.gt)return;const t=this.s.ut();this.vt.setMode(1,0,t.environment&&t.environment.mode?1:0)}isEnable(){const t=this.s.ut();return this.lt()&&t&&t.environment&&t.environment.enable}lt(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}$(){const t=this.getMap(),e=this.getMap().getLightManager(),n=e&&e.getAmbientLight();let r=this.ht;r||(r=this.ht=Rt(this.H,t));const i=this.s.getRenderer().canvas,s=this.s.ut().environment||{},a=s.level||0,l=r.prefilterMap.width,h=this.wt=this.wt||[],c=n&&n.hsv||Dt,u=s.brightness||0;return o["f"].copy(Ft,c),u&&(Ft[2]+=u),Lt[0]=i.width,Lt[1]=i.height,{rgbmRange:r.rgbmRange,cubeMap:r.prefilterMap,bias:a,size:l/Math.pow(2,Math.max(0,a-1)),environmentExposure:nt(n&&n.exposure)?n.exposure:1,diffuseSPH:r.sh,viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,resolution:Lt,hsv:Ft,transformMatrix:o["b"].fromRotation(h,n&&Math.PI/180*-n.orientation||0)}}h(){const t=this.getMap();if(t.on("updatelights",this.update,this),this.vt=new s["SkyboxShader"],t.options.lights){const t=this.getMap().getLightManager().getAmbientResource();this.gt=t}}}const Bt=[],Ht=[.03,.03,.03],Ut=[],jt=[],Vt=[],Gt=[1,1,1],qt=[-1200,-1200,0],Wt=[1200,1200,1e3],Xt={min:[],max:[]},Qt=o["c"].fromRotationTranslation([],o["d"].fromEuler([],90,0,0),[0,0,0]);class Yt{constructor(t,e){this.H=t,this.renderer=new s["Renderer"](t),this.s=e,this._t=new Zt,this.h()}getMap(){return this.s&&this.s.getMap()}h(){const t=this.s.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.vt=new s["MeshShader"]({vert:"attribute vec3 aPosition;\nattribute vec3 aNormal;\nattribute vec2 aTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform vec3 cameraPosition;\nuniform float top;\nuniform float bottom;\nuniform float time;\nvarying vec2 vTexCoord;\n#include <get_output>\nfloat angle(float x, float y){\n    return atan(y, x);\n}\nvec2 getFoot(vec2 camera, vec2 normal, vec2 pos) {\n    vec2 position = vec2(0.0, 0.0);\n    float distanceLen = distance(pos, normal);\n    float a = angle(camera.x - normal.x, camera.y - normal.y);\n    pos.x > normal.x ? a -= 0.785 : a += 0.785;\n    position.x = cos(a) * distanceLen;\n    position.y = sin(a) * distanceLen;\n    return position + normal;\n    return position;\n}\nvoid main()\n{\n    vec4 localPosition = getPosition(aPosition);\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.z), vec2(aNormal.x, aNormal.z), vec2(localPosition.x, localPosition.z));\n    float height = top - bottom;\n    float y = aNormal.y - bottom - height * time;\n    y = y + (y < 0.0 ? height : 0.0);\n    float ratio = (1.0 - y / height) * (1.0 - y / height);\n    y = height * (1.0 - ratio);\n    y += bottom;\n    y += aPosition.y - aNormal.y;\n    localPosition = vec4( foot.x, y, foot.y , 1.0);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"precision mediump float;\nvarying vec2 vTexCoord;\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D rainMap;\nvoid main() {\n    vec4 rainColor = texture2D(rainMap, vTexCoord);\n    vec4 diffuseColor = vec4(diffuse, opacity);\n    diffuseColor *= rainColor;\n    gl_FragColor = diffuseColor;\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return o["c"].multiply(Bt,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e,depth:{enable:!0,mask:!1,func:"less",range:[0,1]},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}),this.Mt()}Mt(){const t=this.H.texture({width:2,height:2});if(this.xt=this.yt(),!this.xt)return;this.bt=new s["Scene"](this.xt);const e=this.St();e.rainTexture?this.Ct(e.rainTexture).then(t=>{this.xt.material.set("rainMap",t)}):(this.xt.material.set("rainMap",t),console.warn("should set rain texture."))}yt(){const t=this.getMap(),e=this.St();if(!e)return null;this.Tt=t.getZoom();const n=this.kt(),r=this.At=e.density,i=this.Ot=e.rainWidth||1,o=this.It=e.rainHeight||1,a=[],l=[],h=[],c=[];for(let s=0;s<r;s++){const t={};t.x=Math.random()*(n.max[0]-n.min[0])+n.min[0],t.y=Math.random()*(n.max[2]-n.min[2])+n.min[2],t.z=Math.random()*(n.max[1]-n.min[1])+n.min[1];const e=(n.max[2]-n.min[2])/37.5*o,r=e/3*i;a.push(t.x+r,t.y+e,t.z,t.x-r,t.y+e,t.z,t.x-r,t.y,t.z,t.x+r,t.y,t.z),l.push(t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z,t.x,t.y-e/2,t.z),h.push(1,1,0,1,0,0,1,0),c.push(4*s+0,4*s+1,4*s+2,4*s+0,4*s+2,4*s+3)}const u={};u.POSITION=a,u.NORMAL=l,u.TEXCOORD_0=h;const f=new s["Geometry"](u,c,0,{primitive:"triangles",positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});f.generateBuffers(this.renderer.regl);const d=new s["Material"]({rainMap:this.H.texture({width:2,height:2}),diffuse:e.color||[1,1,1],opacity:e.opacity||1}),p=new s["Mesh"](f,d);return p.setUniform("top",n.max[2]),p.setUniform("bottom",n.min[2]),this.Et(p),p.transparent=!0,p}Ct(t){const e=new Image;return e.src=this.Lt=t,new Promise((t,n)=>{e.onload=()=>{const n=this.H.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"clamp",wrapT:"clamp",data:e});t(n)},e.onerror=t=>{n(t)}})}paint(t){if(!this.bt)return;const e=this.St(),n={},r=this.getMap();n.projMatrix=r.projMatrix,n.viewMatrix=r.viewMatrix,n.cameraPosition=r.cameraPosition;const i=e.speed||1,s=this._t.getElapsedTime()/(2/i)%1;n.time=s,this.xt.material.set("diffuse",e.color||Gt),this.xt.material.set("opacity",e.opacity||1),this.Et(this.xt);const o=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.vt,n,this.bt,o),this.s.getRenderer().setCanvasUpdated()}Et(t){const e=this.getMap(),n=e.coordinateToPointAtRes(e.getCenter(),e.getGLRes()),r=e.getGLScale()/e.getGLScale(this.Tt),i=o["f"].set(jt,r,r,r),s=o["f"].multiply(i,Ht,i),a=o["c"].identity(Vt),l=this.St(),h=e.getBearing();o["c"].fromRotationTranslationScale(a,o["d"].fromEuler(Ut,l.windDirectionX||0,l.windDirectionY||0,90-h),[n.x,n.y,0],s),o["c"].multiply(a,a,Qt),t.setLocalTransform(a)}setToRedraw(){const t=this.s.getRenderer();t&&t.setToRedraw()}update(){const t=this.St();if(t){if(this.xt||this.Mt(),t.density!==this.At||t.rainWidth!==this.Ot||t.rainHeight!==this.It){const t=this.xt.material.get("rainMap");this.xt.geometry.dispose(),this.xt.dispose(),this.bt.clear(),this.xt=this.yt(),this.xt.material.set("rainMap",t),this.bt.setMeshes(this.xt)}t.rainTexture!==this.Lt&&this.Ct(t.rainTexture).then(t=>{this.xt.material.set("rainMap",t)})}}dispose(){this.xt&&(this.xt.geometry.dispose(),this.xt.material&&this.xt.material.dispose(),this.xt.dispose(),delete this.xt),this.vt&&(this.vt.dispose(),delete this.vt)}isEnable(){const t=this.St();return t&&t.enable}St(){const t=this.s.getWeatherConfig();return t&&t.rain}kt(){const t=16.685648411389433-this.getMap().getZoom();return o["f"].scale(Xt.min,qt,Math.pow(2,t)),o["f"].scale(Xt.max,Wt,Math.pow(2,t)),Xt}}class Zt{constructor(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return 0}}const Kt=[],Jt=[.03,.03,.03],$t=[],te=[],ee=[],ne=o["c"].fromRotationTranslation([],o["d"].fromEuler([],90,0,0),[0,0,0]);class re{constructor(t,e){this.H=t,this.s=e,this.h()}h(){const t=this.s.getRenderer().canvas,e={x:0,y:0,width:()=>t.width,height:()=>t.height};this.vt=new s["MeshShader"]({vert:"#include <gl2_vert>\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\n#include <get_output>\nvoid main()\n{\n    mat4 localPositionMatrix = getPositionMatrix();\n    vec4 localPosition = getPosition(aPosition);\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * localPosition;\n    vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nprecision mediump float;\nuniform sampler2D perlinTexture;\nvarying vec2 vTexCoord;\nfloat lerp(float a, float b, float w) {\n    return a + w * (b - a);\n}\nvoid main() {\n    float snowIntense = texture2D(perlinTexture, vTexCoord).r;\n    vec3 fixedC = vec3(1.0, 1.0, 1.0);\n    float r = lerp(0.5, fixedC.x, snowIntense);\n    float g = lerp(0.5, fixedC.y, snowIntense);\n    float b = lerp(0.5, fixedC.z, snowIntense);\n    glFragColor = vec4(r, g, b, 1.0);\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return o["c"].multiply(Kt,e.viewMatrix,e.modelMatrix)}}],extraCommandProps:{viewport:e}}),this.vt.version=300,this.bt=new s["Scene"],this.Ft=this.Rt(),this.bt.setMeshes(this.Ft),this.renderer=new s["Renderer"](this.H);const n=this.Pt();n&&(n.snowGroundTexture?this.Dt(n.snowGroundTexture):(this.Ht=this.H.texture({width:2,height:2}),console.warn("should set snow ground texture.")))}render(t){this.Ht&&this.Ft.material.set("perlinTexture",this.Ht);const e=this.s.getMap();this.Nt(e);const n={projMatrix:e.projMatrix,viewMatrix:e.viewMatrix,cameraPosition:e.cameraPosition},r=t&&t.renderTarget&&t.renderTarget.fbo;this.renderer.render(this.vt,n,this.bt,r),this.s.getRenderer().setCanvasUpdated()}Nt(t){const e=t.coordinateToPointAtRes(t.getCenter(),t.getGLRes()),n=t.getGLScale()/t.getGLScale(this.Tt),r=o["f"].set(te,n,n,n),i=o["f"].multiply(r,Jt,r),s=o["c"].identity(ee);o["c"].fromRotationTranslationScale(s,o["d"].fromEuler($t,0,0,0),[e.x,e.y,.005],i),o["c"].multiply(s,s,ne),this.Ft.setLocalTransform(s)}Dt(t){const e=new Image;e.onload=()=>{this.Ht=this.H.texture({mag:"linear",min:"linear mipmap nearest",wrapS:"repeat",wrapT:"repeat",data:e})},e.onerror=t=>{console.log(t)},e.src=this.Gt=t}Rt(){const t=this.s.getMap();this.Tt=t.getZoom();const e=16e3*Math.pow(2,16.685648411389433-this.Tt),n=[-e,0,-e,e,0,-e,-e,0,e,e,0,e],r={};r.POSITION=n,r.NORMAL=[0,1,0,0,1,0,0,1,0,0,1,0],r.TEXCOORD_0=[0,0,1,0,0,1,1,1];const i=new s["Geometry"](r,[3,1,0,0,2,3],0,{positionAttribute:"POSITION",normalAttribute:"NORMAL",uv0Attribute:"TEXCOORD_0"});i.generateBuffers(this.H);const o=new s["Material"]({perlinTexture:this.H.texture({with:2,height:2})});return new s["Mesh"](i,o)}getMeshes(){return this.Ft}dispose(){this.Ft&&(this.Ft.geometry.dispose(),this.Ft.material&&this.Ft.material.dispose(),this.Ft.dispose(),delete this.Ft),this.vt&&(this.vt.dispose(),delete this.vt)}update(){const t=this.Pt();t&&t.snowGroundTexture===!this.Gt&&this.Dt(t.snowGroundTexture)}isEnable(){const t=this.St();return t&&t.enable}Pt(){const t=this.s.getWeatherConfig();return t&&t.snow}}
/*!
 * @maptalks/gltf-loader v0.97.2
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */if(o["d"].identity([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(Gi){}}"undefined"!=typeof document&&document.createElement("canvas");const ie=[];class se{constructor(t,e,n){this.H=t,this.s=e,this.jt=n,this.h()}h(){this.renderer=new s["Renderer"](this.H);const t=this.s.getRenderer(),e=this.Bt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.Ut=e.width,this.zt=e.height,this.Vt=this.H.framebuffer({color:this.H.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.EMPTY_TEXTURE=this.H.texture({with:2,height:2}),this.Wt=new Yt(this.H,this.s),this.qt=new s["RainRipplesPass"](this.H,e),this.$t=new re(this.H,this.s),this.Yt=new s["FogPass"](this.H,e,this.s),this.Xt=new s["FogShader"],this.Xt.version=300}getMap(){return this.s&&this.s.getMap()}renderScene(t){this.renderSnowMask(t),this.renderRain(t)}renderRain(t){this.isEnableRain()&&this.Wt.paint(t)}renderSnowMask(t){if(!this.isEnableSnow())return;const e=this.getMap();this.$t.render(t,e)}paint(t,e){if(!e||!e.length)return t;this.Jt();const n=this.s.getWeatherConfig(),r={};var i;if(this.isEnableRain()?(r.ripplesMap=this.Zt(),this.Xt.shaderDefines.HAS_RAIN=1):delete this.Xt.shaderDefines.HAS_RAIN,this.isEnableSnow()?(this.Xt.shaderDefines.HAS_SNOW=1,r.snowIntensity="number"!=typeof(i=n.snow.snowIntensity)||isNaN(i)?.5:n.snow.snowIntensity,e.forEach(t=>{t.defines.HAS_SNOW=1})):(delete this.Xt.shaderDefines.HAS_SNOW,e.forEach(t=>{delete t.defines.HAS_SNOW})),this.isEnableFog()){const t=n.fog;r.fogColor=t.color||[.9,.9,.9],this.Xt.shaderDefines.HAS_FOG=1}else delete this.Xt.shaderDefines.HAS_FOG;return this.Xt.setDefines(this.Xt.shaderDefines),r.mixFactorMap=this.Kt(e)||this.EMPTY_TEXTURE,r.sceneMap=t,r.time=this.Qt()/1e3,r.resolution=o["e"].set(ie,this.Vt.width,this.Vt.height),this.renderer.render(this.Xt,r,null,this.Vt),this.ti=e,this.Vt}Kt(t){const e={},n=this.getMap(),r=n.getZoom(),i=Math.pow(2,16.685648411389433-r),s=this.s.getWeatherConfig(),o=s.fog;if(!o||!o.enable)return null;const a=o.start||.1,l=o.end||100;e.projMatrix=n.projMatrix,e.viewMatrix=n.viewMatrix,e.cameraPosition=n.cameraPosition,e.fogDist=[a*i,l*i],e.rainDepth=n.altitudeToPoint(s.rain&&s.rain.rainDepth||.1,n.getGLRes());const h=this.Yt.render(t,e);return this.s.getRenderer().ii(h)}Zt(){const t=this.getMap(),e=this.s.getWeatherConfig(),n=e.rain.rippleRadius||24,r={};return r.projMatrix=t.projMatrix,r.viewMatrix=t.viewMatrix,r.time=this.Qt()/1e3,r.rippleRadius=n,r.density=e.rain.density||2e3,this.qt.render(t,r)}Qt(){if(!this.s)return 0;if(void 0===this.ei&&(this.ei=0),this.isPlaying()){const t=this.s.getRenderer();this.ei=t.getFrameTime()}return this.ei}isEnable(){const t=this.s.getWeatherConfig();return t&&t.enable}isEnableRain(){const t=this.s.getWeatherConfig();return t&&t.enable&&t.rain&&t.rain.enable}isEnableFog(){const t=this.s.getWeatherConfig();return t&&t.enable&&t.fog&&t.fog.enable}isEnableSnow(){const t=this.s.getWeatherConfig();return t&&t.enable&&t.snow&&t.snow.enable}isPlaying(){const t=this.s.getWeatherConfig();return!!t&&!1!==t.playing}si(){return this.isEnableRain()||this.isEnableFog()||this.isEnableSnow()}update(){!this.isEnable()&&this.ti&&this.ti.forEach(t=>{delete t.defines.HAS_SNOW,delete t.defines.HAS_RAIN,delete t.defines.HAS_FOG}),this.isEnableRain()&&(this.Wt=this.Wt||new Yt(this.H,this.s),this.Wt.update()),this.isEnableSnow()&&(this.$t=this.$t||new re(this.H,this.s),this.$t.update())}getShadowMeshes(){return this.$t.getMeshes()}Jt(){const t=this.Ut(),e=this.zt();!this.Vt||this.Vt.width===t&&this.Vt.height===e||this.Vt.resize(t,e)}dispose(){this.Vt&&this.Vt.destroy(),this.Xt&&(this.Xt.dispose(),delete this.Xt),this.Wt&&(this.Wt.dispose(),delete this.Wt),this.$t&&(this.$t.dispose(),delete this.$t)}}const oe=[],ae=t=>!!t.bloom,le=t=>!!t.ssr;class he{constructor(t,e,n){this.H=t,this.s=e,this.ni=new s["Renderer"](t),this.ri=new s["FxaaShader"],this.hi=new s["TaaPass"](this.ni,n),this.oi=new s["CopyShader"],this.ai=new s["SsrPass"](this.H)}setContextIncludes(){}bloom(t,e,n,r,i,o,a){this.ci||(this.ci=new s["BloomPass"](this.H));const l=this.s.getRenderer().ii(this.li);return this.ci.render(t,l,r,i,o,e,n,a)}drawBloom(t){const e=this.s.getRenderer(),n=this.H,r=this.li;if(r){const{width:e,height:i}=t;r.width===e&&r.height===i||r.resize(e,i),n.clear({color:[0,0,0,0],framebuffer:r})}else{const e=this.ui(t);this.li=n.framebuffer(e)}const i=e.getFrameTime(),s=e.getFrameEvent(),o=e.getFrameContext(),a=o.renderMode,l=o.sceneFilter,h=o.renderTarget;o.isPostProcess=!0,o.renderMode="default",o.sceneFilter=ae,o.renderTarget={fbo:this.li,getFramebuffer:ce,getDepthTexture:ue};const c=e.glCtx;return c.resetDrawCalls(),s?e.forEachRenderer(t=>{e.clearStencil(t,r),t.drawOnInteracting(s,i,o)}):e.forEachRenderer(t=>{e.clearStencil(t,r),t.draw(i,o)}),delete o.isPostProcess,o.renderMode=a,o.sceneFilter=l,o.renderTarget=h,c.getDrawCalls()}genSsrMipmap(t,e){const n=this.s.getMap().projViewMatrix;this.ai.genMipMap(t,e,n)}getPrevSsrProjViewMatrix(){return this.ai&&this.ai.getPrevProjViewMatrix()}drawSSR(t,e,n){n&&this.ai.copyDepthTex(t);const r=this.s.getRenderer(),i=r.getFrameTime(),s=r.getFrameEvent(),o=r.getFrameContext();o.isPostProcess=!0,o.ssr=this.getSSRContext();const a=o.renderMode,l=o.sceneFilter;o.renderMode="default",o.sceneFilter=le,o.renderTarget.fbo=e;const h=r.glCtx;let c=!1;s?r.forEachRenderer(t=>{r.clearStencil(t,e),c||(h.resetDrawCalls(),c=!0),t.drawOnInteracting(s,i,o)}):r.forEachRenderer(t=>{r.clearStencil(t,e),c||(h.resetDrawCalls(),c=!0),t.draw(i,o)});const u=r.drawGround();return delete o.ssr,delete o.isPostProcess,o.renderMode=a,o.sceneFilter=l,this.fi=h.getDrawCalls()>0,u}getSSRUniforms(){const t=this.s.ut(),e=t&&t.postProcess,n=this.s.getMap();return this.ai.getSSRUniforms(n,e.ssr.factor,e.ssr.quality)}getSSRContext(){const t=this.s.ut(),e=t&&t.postProcess,n=this.s.getMap(),r=this.ai.getSSRUniforms(n,e.ssr.factor,e.ssr.quality);return r?{renderUniforms:r,defines:{HAS_SSR:1}}:null}taa(t,e,{projMatrix:n,needClear:r}){const i=this.hi;return{outputTex:i.render(t,e,n,r),redraw:i.needToRedraw()}}isTaaNeedRedraw(){return this.hi.needToRedraw()}ssao(t,e,n){return this.di||(this.di=new s["SsaoPass"](this.ni),this.s.getRenderer().setToRedraw()),this.di.render({projMatrix:n.projMatrix,cameraNear:n.cameraNear,cameraFar:n.cameraFar,bias:n.ssaoBias,radius:n.ssaoRadius,intensity:n.ssaoIntensity,quality:.6},t,e)}fxaa(t,e,n,r,i,s,a,l,h,c,u,f,d,p,A,g){!t||t.width===e.fbo&&t.height===e.height||t.resize(e.width,e.height);const m={};i?m.HAS_TAA_TEX=1:delete m.HAS_TAA_TEX,s?m.HAS_FXAA_TEX=1:delete m.HAS_FXAA_TEX,f?m.HAS_OUTLINE_TEX=1:delete m.HAS_OUTLINE_TEX,n?m.HAS_NOAA_TEX=1:delete m.HAS_NOAA_TEX,r?m.HAS_POINT_TEX=1:delete m.HAS_POINT_TEX,this.ri.setDefines(m),this.ni.render(this.ri,{textureSource:e,noAaTextureSource:n,pointTextureSource:r,taaTextureSource:i,fxaaTextureSource:s,resolution:o["e"].set(oe,e.width,e.height),enableFXAA:a,enableToneMapping:l,enableSharpen:h,pixelRatio:c,sharpFactor:u,textureOutline:f,highlightFactor:d,outlineFactor:p,outlineWidth:A,outlineColor:g},null,t)}renderFBOToScreen(t,e,n,r){this.pi||(this.pi=[]),this.pi[0]=t.width,this.pi[1]=t.height;const i=this.s.getRenderer();this.ni.render(this.oi,{texture:t.color&&i.ii(t)||t,size:this.pi,enableSharpen:+!!e,sharpFactor:n,pixelRatio:r})}postprocess(t,e,n){this.gi||(this.gi=new s["PostProcessShader"]);const r=this.s&&this.s.getRenderer(),i=n||r.ii(t);return e.resolution=o["e"].set(oe,i.width,i.height),e.textureSource=i,e.timeGrain=performance.now(),this.ni.render(this.gi,e),this.mi}dispose(){this.li&&(this.li.destroy(),delete this.li),this.hi&&(this.hi.dispose(),delete this.hi),this.di&&(this.di.dispose(),delete this.di),this.ci&&(this.ci.dispose(),delete this.ci),this.gi&&(this.gi.dispose(),delete this.gi),this.ri&&(this.ri.dispose(),delete this.ri),this.oi&&(this.oi.dispose(),delete this.oi)}ui(t,e){const{width:n,height:r}=this.s.getRenderer().canvas,i=this.H;let s;s=this.s.getRenderer().vi()?i.renderbuffer({width:n,height:r,samples:this.s.options.multiSamples,format:"rgba8"}):i.texture({min:"nearest",mag:"nearest",format:e||"rgba",width:n,height:r});const o={width:n,height:r,colors:[s]};return t&&(o.depthStencil=t),o}}function ce(t){return t._framebuffer.framebuffer}function ue(t){return t.depthStencil._texture.texture}class fe extends s["QuadShader"]{constructor(t){super({vert:"#if __VERSION__ == 300\n\t#define attribute in\n\t#define varying out\n#endif\nattribute vec2 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main()\n{\n  gl_Position = vec4(aPosition, 0., 1.);\n  vTexCoord = aTexCoord;\n}",frag:"#if __VERSION__ == 100\n  #ifdef GL_OES_standard_derivatives\n    #extension GL_OES_standard_derivatives : enable\n  #endif\n#endif\nprecision mediump float;\n#include <gl2_frag>\nvarying vec2 vTexCoord;\n#ifdef HAS_FLOODANALYSE\n    uniform vec3 flood_waterColor;\n    uniform float flood_waterOpacity;\n    uniform sampler2D floodMap;\n#endif\n#ifdef HAS_SKYLINE\n    uniform sampler2D skylineMap;\n#endif\n#ifdef HAS_VIEWSHED\n    uniform vec4 viewshed_visibleColor;\n    uniform vec4 viewshed_invisibleColor;\n    uniform sampler2D viewshedMap;\n#endif\n#ifdef HAS_INSIGHT\n    uniform vec4 insight_visibleColor;\n    uniform vec4 insight_invisibleColor;\n    uniform sampler2D insightMap;\n#endif\n#ifdef HAS_CUT\n    uniform sampler2D meshesMap;\n    uniform sampler2D invisibleMap;\n#endif\n#ifdef HAS_EXCAVATE\n    uniform sampler2D excavateMap;\n#endif\n#ifdef HAS_CROSSCUT\n    uniform sampler2D crosscutMap;\n    uniform vec4 cutLineColor;\n#endif\n#ifdef HAS_HEIGHTLIMIT\n    uniform vec3 limitColor;\n    uniform sampler2D heightLimitMap;\n#endif\nuniform sampler2D sceneMap;\nvoid main() {\n    vec4 sceneColor = texture2D(sceneMap, vTexCoord);\n    glFragColor = sceneColor;\n    #ifdef HAS_VIEWSHED\n        vec4 viewshedColor = texture2D(viewshedMap, vTexCoord);\n        if (viewshedColor.r > 0.99) {\n            glFragColor = vec4(mix(viewshed_invisibleColor.rgb, sceneColor.rgb, viewshed_invisibleColor.a), sceneColor.a);\n        } else if (viewshedColor.g > 0.99) {\n            glFragColor = vec4(mix(viewshed_visibleColor.rgb, sceneColor.rgb, viewshed_visibleColor.a), sceneColor.a);\n        } else if (viewshedColor.a < 0.01) {\n            glFragColor = vec4(viewshedColor.rgb, 1.0);\n        }\n    #endif\n    #ifdef HAS_FLOODANALYSE\n        vec4 floodColor = texture2D(floodMap, vTexCoord);\n        if (floodColor.r > 0.0) {\n            glFragColor = vec4(mix(glFragColor.rgb, flood_waterColor, flood_waterOpacity), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_SKYLINE\n        vec4 skylineColor = texture2D(skylineMap, vTexCoord);\n        if (skylineColor.r > 0.0 || skylineColor.g > 0.0 || skylineColor.b > 0.0) {\n            glFragColor = skylineColor;\n        }\n    #endif\n    #ifdef HAS_INSIGHT\n        vec4 insightColor = texture2D(insightMap, vTexCoord);\n        if (insightColor.g > 0.0) {\n            glFragColor = insight_visibleColor;\n        } else if (insightColor.r > 0.0) {\n            glFragColor = insight_invisibleColor;\n        }\n    #endif\n    #ifdef HAS_CUT\n        vec4 cutColor = texture2D(invisibleMap, vTexCoord);\n        vec4 meshesMapColor = texture2D(meshesMap, vTexCoord);\n        if (cutColor.r == 1.0 && cutColor.g == 0.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 1.0 && cutColor.b == 0.0) {\n            glFragColor = meshesMapColor;\n        } else if (cutColor.r == 0.0 && cutColor.g == 0.0 && cutColor.b == 1.0) {\n          glFragColor = sceneColor;\n        }\n    #endif\n    #ifdef HAS_EXCAVATE\n        vec4 excavateColor = texture2D(excavateMap, vTexCoord);\n        if (excavateColor.r == 1.0 && excavateColor.g == 0.0 && excavateColor.b == 0.0) {\n          glFragColor = sceneColor;\n        }  else {\n          glFragColor = excavateColor;\n        }\n    #endif\n    #ifdef HAS_CROSSCUT\n        vec4 crosscutColor = texture2D(crosscutMap, vTexCoord);\n        if (crosscutColor.r > 0.0) {\n            glFragColor = vec4(mix(cutLineColor.rgb, glFragColor.rgb, 0.99), glFragColor.a);\n        }\n    #endif\n    #ifdef HAS_HEIGHTLIMIT\n        vec4 heightLimitColor = texture2D(heightLimitMap, vTexCoord);\n        if (heightLimitColor.r > 0.0) {\n            glFragColor = vec4(mix(limitColor, glFragColor.rgb, 0.6), glFragColor.a);\n        }\n    #endif\n    #if __VERSION__ == 100\n        gl_FragColor = glFragColor;\n    #endif\n}",extraCommandProps:{viewport:t,cull:{enable:!0},blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}})}}class de{constructor(t,e,n){this.H=t,this.s=e,this.jt=n,this.h()}h(){this.renderer=new s["Renderer"](this.H);const t=this.s.getRenderer(),e=this.Bt={x:0,y:0,width:()=>t.canvas?t.canvas.width:1,height:()=>t.canvas?t.canvas.height:1};this.Vt=this.H.framebuffer({color:this.H.texture({width:t.canvas?t.canvas.width:1,height:t.canvas?t.canvas.height:1,wrap:"clamp",mag:"linear",min:"linear"}),depth:!0}),this.vt=new fe(e)}getMap(){return this.s&&this.s.getMap()}paint(t,e){if(!e&&e.length)return t;this.Jt();const n={},r=this.s.wi;if(!this._i())return t;this.H.clear({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this.Vt}),delete this.vt.shaderDefines.HAS_FLOODANALYSE,delete this.vt.shaderDefines.HAS_VIEWSHED,delete this.vt.shaderDefines.HAS_SKYLINE,delete this.vt.shaderDefines.HAS_INSIGHT,delete this.vt.shaderDefines.HAS_CUT,delete this.vt.shaderDefines.HAS_CROSSCUT,delete this.vt.shaderDefines.HAS_HEIGHTLIMIT;for(let i=0;i<r.length;i++){const t=r[i];if(!t.isEnable())continue;const s=t.getDefines();tt(this.vt.shaderDefines,s);const o=this.getMap(),a=o.width,l=o.height,h=this.Mi(e,t.getExcludeLayers()),c=t.renderAnalysis(h,a,l);c&&tt(n,c)}return n.sceneMap=t,this.vt.setDefines(this.vt.shaderDefines),this.renderer.render(this.vt,n,null,this.Vt),this.Vt}Mi(t,e){let n=[];for(let r=0;r<t.length;r++){if(e.indexOf(t[r].getId())>-1)continue;const i=t[r].getRenderer();if(i&&i.getAnalysisMeshes){const t=i.getAnalysisMeshes();t.forEach(t=>{t.setUniform("useAnalysis",1)}),n=n.concat(t)}}return n}Jt(){const t=a["I"].isFunction(this.Bt.width.data)?this.Bt.width.data():this.Bt.width,e=a["I"].isFunction(this.Bt.height.data)?this.Bt.height.data():this.Bt.height;!this.Vt||this.Vt.width===t&&this.Vt.height===e||this.Vt.resize(t,e)}_i(){const t=this.s&&this.s.wi;if(!t)return!1;for(let e=0;e<t.length;e++)if(t[e].isEnable())return!0;return!1}}const pe=[0,0,0,0],Ae=[1,1,-1],ge=[0,0],me=t=>!t.bloom&&!t.ssr,ye=t=>!t.bloom,ve=t=>!t.ssr;class xe extends a["P"].CanvasRenderer{setToRedraw(){this.setRetireFrames(),super.setToRedraw()}onAdd(){super.onAdd(),this.prepareCanvas()}updateSceneConfig(){this.xi&&this.xi.update(),this.yi&&this.yi.update(),this.bi&&this.bi.update(),this.setToRedraw()}render(...t){this.getMap()&&this.layer.isVisible()&&(this.forEachRenderer(t=>{t._replacedDrawFn||(t.draw=this.Si(t.draw),t.drawOnInteracting=this.Ci(t.drawOnInteracting),t.setToRedraw=this.Ti(t.setToRedraw),t._replacedDrawFn=!0)}),this.prepareRender(),this.prepareCanvas(),this.layer.ki(),this._toRedraw=!1,this.Ai("render",t),this.Oi(),this.Ii())}prepareCanvas(){super.prepareCanvas(),this.forEachRenderer(t=>{t.prepareCanvas()})}drawOnInteracting(...t){this.getMap()&&this.layer.isVisible()&&(this.layer.ki(),this._toRedraw=!1,this.Ai("drawOnInteracting",t),this.Oi(),this.Ii())}Ai(t,e){this.Ei="default";const n=this.hasRenderTarget(),r=this.Li(e);if(n&&(this.Fi.renderTarget=this.Ri()),this.yi.paint(r),this.drawGround(!0),!n)return void this.Pi("default",null,t,e,!0);const i=this.glCtx,s=this.layer.ut(),o=s&&s.postProcess,a=this.isSSROn(),l=this.isEnableTAA(),h=r.jitter;r.jitter=ge;const c=this.layer.getGroundConfig();if(r.hasSSRGround=!!(a&&c&&c.enable&&c.symbol&&c.symbol.ssr),i.resetDrawCalls(),this.Pi(l?"fxaaBeforeTaa":"fxaa",this.Di,t,e),this.Hi=i.getDrawCalls(),a&&this.Ni.drawSSR(this.Gi(),this.Di),l){const n=this.getMap(),s=this.Ni.isTaaNeedRedraw()||this.ji||n.getRenderer().isViewChanged();r.jitter=s?h:this.Bi.getAverage(),r.onlyUpdateDepthInTaa=!s;let a=this.Ui;if(a)a.width===this.Di.width&&a.height===this.Di.height||a.resize(this.Di.width,this.Di.height);else{const t=this.regl,e=this.createFBOInfo(o,this.zi);a=this.Ui=t.framebuffer(e)}i.resetDrawCalls(),this.Pi("taa",a,t,e),this.Vi=i.getDrawCalls(),delete r.onlyUpdateDepthInTaa,r.jitter=ge;let l=this.Wi;if(l)l.width===this.Di.width&&l.height===this.Di.height||l.resize(this.Di.width,this.Di.height);else{const t=this.regl,e=this.createFBOInfo(o,this.zi);l=this.Wi=t.framebuffer(e)}i.resetDrawCalls(),this.Pi("fxaaAfterTaa",this.Wi,t,e),this.qi=i.getDrawCalls()}else this.Ui&&(this.Ui.destroy(),this.Wi.destroy(),delete this.Ui,delete this.Wi,delete this.qi);o.bloom&&o.bloom.enable&&(this.$i=this.Ni.drawBloom(this.zi)),2===a&&this.Ni.drawSSR(this.Gi(),this.Di,!0),i.resetDrawCalls(),this.Pi("noAa",this.Yi,t,e),this.Xi=i.getDrawCalls(),i.resetDrawCalls(),this.Pi("point",this.Ji,t,e,!0),this.bi.renderScene(r),this.Zi=i.getDrawCalls()}Pi(t,e,n,r,i){this.Ei=t;const s=this.Li(r);s.renderMode=this.Ei,s.renderTarget&&(s.renderTarget.fbo=e),i&&(s.isFinalRender=!0),this.forEachRenderer((i,s)=>{s.isVisible()&&("default"===t||!i.supportRenderMode&&("fxaa"===t||"fxaaAfterTaa"===t)||i.supportRenderMode&&i.supportRenderMode(t))&&(this.clearStencil(i,e),i[n].apply(i,r))})}Li(t){let e=t[0];return be(e)||(e=t[1]),e!==this.Ki&&(this.forEachRenderer((t,e)=>{e.isVisible()&&t.needRetireFrames&&t.needRetireFrames()&&this.setRetireFrames()}),this.Fi=this.Qi(e),this.Ki=e,this.te=be(t[0])?null:t[0]),this.Fi}Oi(){if(!this.isEnableOutline())return;const t=this.ie(),e=this.glCtx;e.resetDrawCalls(),this.forEachRenderer((e,n)=>{n.isVisible()&&e.drawOutline&&e.drawOutline(t)}),this.ee=e.getDrawCalls()}ie(){const{width:t,height:e}=this.canvas;let n=this.se;if(n)t===n.width&&e===n.height||n.resize(t,e);else{const r=this.regl.texture({width:t,height:e,format:"rgba4"});n=this.se=this.regl.framebuffer({width:t,height:e,colors:[r],depth:!1,stencil:!1})}return n}ii(t){if(this.vi()){const e=this.ne(t);return e.width!==t.width||e.height!==t.height?e.resize(t.width,t.height):this.regl.clear({color:[0,0,0,0],fbo:e}),e.blit(t),e.color[0]}return t.color[0]}Gi(){if(this.zi.subimage)return this.zi;const{width:t,height:e}=this.zi;if(!this.re){const n=this.regl,r={depthStencil:n.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:t,height:e,format:"depth stencil"}),colors:[n.renderbuffer({width:t,height:e,format:"rgba4"})],colorFormat:"rgba4",width:t,height:e};this.re=n.framebuffer(r)}return this.re.width===t&&this.re.height===e||this.re.resize(t,e),this.regl.clear({color:[0,0,0,0],depth:1,fbo:this.re}),this.re.blit(this.Di,256,"nearest"),this.re.depthStencil}ne(t){if(this.he||(this.he=[]),!t.oe){const e=this.ae(!0,t.width,t.height),n=this.regl.framebuffer(e);this.he.push(n),t.oe=n}return t.oe}vi(){return 0===this.regl.limits.version.indexOf("WebGL 2.0")&&this.layer.options.antialias}hasRenderTarget(){const t=this.layer.ut(),e=t&&t.postProcess;return!(!e||!e.enable)}testIfNeedRedraw(){if(this.layer.options.forceRedrawPerFrame)return!0;if(this._toRedraw)return this._toRedraw=!1,!0;if(this.getMap().isInteracting()&&(this.xi&&this.xi.isEnable()||this.yi&&this.yi.isEnable()))return!0;if(this.bi&&this.bi.isEnable())return!0;const t=this.layer.ce;if(t){const e=t.getRenderer();if(e&&e.testIfNeedRedraw())return this.le=!0,!0}const e=this.ue();for(const n of e){const t=n.getRenderer();if(t&&t.testIfNeedRedraw())return this.le=!0,!0}return!1}isRenderComplete(){const t=this.ue();for(const e of t){const t=e.getRenderer();if(t&&!t.isRenderComplete())return!1}return!0}mustRenderOnInteracting(){const t=this.ue();for(const e of t){const t=e.getRenderer();if(t&&t.mustRenderOnInteracting())return!0}return!1}isCanvasUpdated(){if(super.isCanvasUpdated())return!0;const t=this.ue();for(const e of t){const t=e.getRenderer();if(t&&t.isCanvasUpdated())return!0}return!1}isBlank(){if(this.xi&&this.xi.isEnable())return!1;if(this.yi&&this.yi.isEnable())return!1;const t=this.layer.getTerrainLayer();if(t){const e=t.getRenderer();if(e&&!e.isBlank())return!1}const e=this.ue();for(const n of e){const t=n.getRenderer();if(t&&!t.isBlank())return!1}return!0}createContext(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,stencil:!0};e.preserveDrawingBuffer=!0,e.antialias=!!t.options.antialias,this.glOptions=e;const n=this.gl=function(t,e,n){const r=n?["webgl","experimental-webgl"]:["webgl2","webgl","experimental-webgl"];let i=null;for(let s=0;s<r.length;++s){try{i=t.getContext(r[s],e)}catch(t){}if(i)break}return i||console.error("Browser doesn't support WebGL."),i}(this.canvas,e,t.options.onlyWebGL1);this.fe(n),n.wrap=()=>new l["a"](this.gl),this.glCtx=n.wrap(),this.canvas.gl=this.gl,this.reglGL=n.wrap(),this.regl=i()({gl:this.reglGL,attributes:e,extensions:t.options.extensions,optionalExtensions:t.options.optionalExtensions}),this.gl.regl=this.regl,this.de=[0,0],this.xi=new kt(this.regl,this.layer),this.yi=new zt(this.regl,this.layer);const r=this.layer.getWeatherConfig();this.bi=new se(this.regl,t,r),this.pe=new de(this.regl,t);const o=this.layer.ut()||{},a=o&&o.postProcess,h=a&&a.antialias&&a.antialias.jitterRatio||.2;this.Bi=new s["Jitter"](h),this.Ni=new he(this.regl,this.layer,this.Bi),this.o=new pt(this.regl,o,this.layer)}fe(){const t=this.layer,e=this.gl,n=t.options.extensions;n&&n.forEach(t=>{e.getExtension(t)});const r=t.options.optionalExtensions;r&&r.forEach(t=>{e.getExtension(t)}),this.gl.clearColor(0,0,0,0)}clearCanvas(){super.clearCanvas(),this.ge()}ge(){const t=this.regl;this.Di&&(t.clear({color:pe,depth:1,stencil:255,framebuffer:this.Di}),t.clear({color:pe,framebuffer:this.Yi}),t.clear({color:pe,framebuffer:this.Ji}),this.Ui&&this.Vi&&t.clear({color:pe,framebuffer:this.Ui}),this.Wi&&this.qi&&t.clear({color:pe,framebuffer:this.Wi})),this.se&&t.clear({color:pe,framebuffer:this.se}),t.clear({color:pe,depth:1,stencil:255})}resizeCanvas(){const t=this.canvas.width,e=this.canvas.height;!this.Di||this.Di.width===t&&this.Di.height===e||(super.resizeCanvas(),this.Di.resize(t,e),this.Yi.resize(t,e),this.Ji.resize(t,e),this.Ui&&this.Ui.resize(t,e),this.Wi&&this.Wi.resize(t,e),this.ge(),this.forEachRenderer(t=>{t.canvas&&t.resizeCanvas()}))}getCanvasImage(){return this.forEachRenderer(t=>{t.getCanvasImage()}),super.getCanvasImage()}ue(){return this.layer.ue()}forEachRenderer(t){const e=this.ue();for(const r of e){if(!r.isVisible()||!r.options.beneathTerrain)continue;const e=r.getRenderer();e&&t(e,r)}const n=this.layer.ce;if(n){const e=n.getRenderer();e&&t(e,n)}for(const r of e){if(!r.isVisible()||r.options.beneathTerrain)continue;const e=r.getRenderer();e&&t(e,r)}}clearStencil(t,e){const n={stencil:t.getStencilValue?t.getStencilValue():255};e&&(n.framebuffer=e),this.regl.clear(n)}onRemove(){this.canvas.pickingFBO&&this.canvas.pickingFBO.destroy&&this.canvas.pickingFBO.destroy(),this.me(),this.xi&&(this.xi.dispose(),delete this.xi),this.yi&&(this.yi.dispose(),delete this.yi),this.o&&(this.o.dispose(),delete this.o),this.Ni&&(this.Ni.dispose(),delete this.Ni),this.se&&(this.se.destroy(),delete this.se),this.bi&&(this.bi.dispose(),delete this.bi),super.onRemove()}me(){if(this.Di&&(this.Di.destroy(),this.Yi.destroy(),this.Ji.destroy(),this.Ui&&(this.Ui.destroy(),delete this.Ui),this.Wi&&(this.Wi.destroy(),delete this.Wi),delete this.Di,delete this.Yi,delete this.Ji,this.ve&&(this.ve.destroy(),delete this.ve),this.re&&(this.re.destroy(),delete this.re),this.he)){for(let t=0;t<this.he.length;t++)this.he[t]&&this.he[t].destroy();delete this.he}}setRetireFrames(){this.ji=!0}getFrameTime(){return this.Ki}getFrameEvent(){return this.te}getFrameContext(){return this.Fi}drawGround(t){const e=this.layer.getGroundConfig();if(!e||!e.enable)return!1;if(!this.xi)return!1;const n=this.getFrameContext(),r=n.jitter;n.jitter=ge;const i=this.layer.getPolygonOffsetCount();let s;n.offsetFactor=i+1,n.offsetUnits=i+1,t&&(s=n.sceneFilter,delete n.sceneFilter);const o=this.xi.paint(n);return this.xi.needToRedraw()&&this.setToRedraw(),s&&(n.sceneFilter=s),n.jitter=r,o}Si(t){const e=this;return function(n,r){return(r=r||e.Fi)&&r.renderTarget&&(r.renderTarget.getFramebuffer=we,r.renderTarget.getDepthTexture=_e),t.call(this,n,r)}}Ci(t){const e=this;return function(n,r,i){return(i=i||e.Fi)&&i.renderTarget&&(i.renderTarget.getFramebuffer=we,i.renderTarget.getDepthTexture=_e),t.call(this,n,r,i)}}Ti(t){return function(...e){return t.apply(this,e)}}isEnableSSR(){const t=this.layer.ut(),e=t&&t.postProcess;return e&&e.enable&&e.ssr&&e.ssr.enable}isSSROn(){const t=this.isEnableSSR(),e=this.getMap();if(!t||e.getPitch()<=-.001)return 0;const n=e.projViewMatrix,r=this.Ni.getPrevSsrProjViewMatrix();return r&&o["c"].exactEquals(r,n)?1:2}isEnableTAA(){return!1}isEnableSSAO(){const t=this.layer.ut(),e=t&&t.postProcess;return e&&e.enable&&e.ssao&&e.ssao.enable}isEnableOutline(){const t=this.layer.ut(),e=t&&t.postProcess;return e&&e.enable&&e.outline&&e.outline.enable}isEnableWeather(){const t=this.layer.ut(),e=t&&t.weather;return e&&e.enable}we(){const t=this.layer.getMap();if(!this.O){this.O={center:t.getCenter(),bearing:t.getBearing(),pitch:t.getPitch(),res:t.getResolution()};let e=!1;if(t.options.lights){const n=t.getLightManager().getDirectionalLight().direction||Ae;this.O.lightDirection=o["f"].copy([],n),e=!0}return{viewChanged:!0,lightDirectionChanged:e}}const e=t.getResolution()/this.O.res,n=t.coordToContainerPoint(this.O.center),r=this.layer.options.viewMoveThreshold,i=n._sub(t.width/2,t.height/2).mag()>r||e<.95||e>1.05;let s=!1;if(t.options.lights){const e=t.getLightManager().getDirectionalLight().direction||Ae;s=!o["f"].equals(this.O.lightDirection,e),s&&(this.O.lightDirection=o["f"].copy([],e))}return i&&(this.O.center=t.getCenter(),this.O.bearing=t.getBearing(),this.O.pitch=t.getPitch(),this.O.res=t.getResolution()),{viewChanged:i,lightDirectionChanged:s}}Qi(t){const e=this.layer.ut(),n=e&&e.postProcess,r=e&&e.weather,i={timestamp:t,renderMode:this.Ei||"default",includes:{},states:this.we(),testSceneFilter:t=>!i.sceneFilter||i.sceneFilter(t),isFinalRender:!1,weather:{fog:r&&r.fog}},s=n&&n.antialias&&n.antialias.jitterRatio||.2,a=this.Bi;a&&a.setRatio(s);const l=this.isSSROn();let h;if(n&&n.enable){this.isEnableTAA()?((this.getMap().isInteracting()||this.ji)&&a.reset(),a.getJitter(this.de),a.frame()):o["e"].set(this.de,0,0),i.jitter=this.de;const t=n.bloom&&n.bloom.enable;t&&l?(i.bloom=1,i.sceneFilter=me):t?(i.bloom=1,i.sceneFilter=ye):l&&(i.sceneFilter=ve),h=this.Ri(),h&&(i.renderTarget=h)}else this.me();return"noAa"!==this.Ei&&(this._e=this.Me(i),this._e&&(i.includes.shadow=1),this.xe=this.ye(i)),this._e&&(i.shadow=this._e,i.includes.shadow=1),i.states.includesChanged=this.xe,n&&n.enable&&this.Ni&&this.Ni.setContextIncludes(i),i}be(t){const e=this.ue().filter(t=>t.isVisible());return this.layer.ce&&e.push(this.layer.ce),this.pe.paint(t,e)}ye(t){let e=!1;const n=Object.keys(t.includes),r=this.Se;if(r){const t=n.filter(t=>-1===r.indexOf(t)).concat(r.filter(t=>-1===n.indexOf(t)));t.length&&(e=t.reduce((t,e)=>(t[e]=1,t),{}))}return this.Se=n,e}Me(t){const e=this.layer.ut();if(!e||!e.shadow||!e.shadow.enable)return this.o&&(this.o.dispose(),delete this.o),null;this.o||(this.o=new pt(this.regl,this.layer.ut()||{},this.layer));const n={config:e.shadow,defines:this.o.getDefines(),uniformDeclares:pt.getUniformDeclares()};return n.renderUniforms=this.Ce(t),n}Ce(t){const e=t.renderTarget&&t.renderTarget.fbo,n=this.layer.ut(),r=[];let i=t.states.lightDirectionChanged||t.states.viewChanged;this.forEachRenderer((t,e)=>{if(!t.getShadowMeshes||!e.isVisible())return;const n=t.getShadowMeshes();if(Array.isArray(n))for(let s=0;s<n.length;s++)n[s].needUpdateShadow&&(i=!0),n[s].needUpdateShadow=!1,r.push(n[s])}),this.Te||(this.Te=new s["Scene"]),this.Te.setMeshes(r);const o=this.getMap(),a=n.shadow,l=o.getLightManager(),h=l&&l.getDirectionalLight().direction||Ae,c=!n.ground||!n.ground.enable;return this.o.render(c,o.projMatrix,o.viewMatrix,a.color,a.opacity,h,this.Te,this.de,e,i)}ke(t){let e=[];if(this.forEachRenderer((t,n)=>{if(!t.getAnalysisMeshes||!n.isVisible())return;const r=t.getAnalysisMeshes();e=e.concat(r)}),this.xi){const t=this.xi.getRenderMeshes();e=e.concat(t)}const n=this.layer.getWeatherConfig();return this.bi.paint(t,e,n)}getGroundMesh(){return this.xi?this.xi.getRenderMeshes():[]}Ri(){const t=this.layer.ut(),e=t&&t.postProcess;if(!this.Di){const t=this.regl;let n=this.zi;(!n||!n._texture||n._texture.refCount<=0)&&(n=null);const r=this.createFBOInfo(e,n);this.zi=r.depth||r.depthStencil,this.Di=t.framebuffer(r);const i=this.createFBOInfo(e,this.zi);this.Yi=t.framebuffer(i);const s=this.createFBOInfo(e,this.zi);this.Ji=t.framebuffer(s),this.ge()}return{fbo:this.Di}}ae(t,e,n){e=e||this.canvas.width,n=n||this.canvas.height;const r=this.regl,i=this.vi();let s;if(!t&&i)s=r.renderbuffer({width:e,height:n,samples:this.layer.options.multiSamples,format:"rgba8"});else{const t="uint8";s=r.texture({min:"nearest",mag:"nearest",type:t,width:e,height:n})}return{width:e,height:n,colors:[s],colorFormat:i?"rgba8":"rgba"}}createFBOInfo(t,e){const{width:n,height:r}=this.canvas,i=this.regl,s=this.ae(),o=this.vi(),a=i.hasExtension("WEBGL_depth_texture");if(o){const t=e||i.renderbuffer({width:n,height:r,format:"depth24 stencil8",samples:this.layer.options.multiSamples});s.depthStencil=t}else if(a){const t=e||i.texture({min:"nearest",mag:"nearest",mipmap:!1,type:"depth stencil",width:n,height:r,format:"depth stencil"});s.depthStencil=t}else{const t=e||i.renderbuffer({width:n,height:r,format:"depth stencil"});s.depthStencil=t}return s}Ii(){if(!this.Di)return void(this.ji=!1);const t=this.layer.ut(),e=t&&t.postProcess;if(!e||!e.enable){if(this.isEnableWeather())throw new Error("you must enable the post process to turn on weather");return}this.layer.fire("postprocessstart");const n=this.layer.getMap();let r;if(this.isEnableTAA()){const t=this.ji||n.getRenderer().isViewChanged();t&&this.layer.fire("taastart");const{outputTex:e,redraw:i}=this.Ni.taa(this.ii(this.Ui),this.Gi(),{projMatrix:n.projMatrix,needClear:t});r=e,i?this.setToRedraw():this.layer.fire("taaend"),this.ji=!1}let i=e.sharpen&&e.sharpen.factor;i||0===i||(i=.2);let s=0,o=.2,a=.3,l=1,h=[1,1,0];e.outline&&(s=+!!e.outline.enable,o=Me(e.outline,"highlightFactor",o),a=Me(e.outline,"outlineFactor",a),l=Me(e.outline,"outlineWidth",l),h=Me(e.outline,"outlineColor",h));const c=this.isEnableSSAO(),u=e.ssr&&e.ssr.enable,f=e.bloom&&e.bloom.enable,d=f&&this.$i,p=+!(!e.antialias||!e.antialias.enable),A=this.pe._i(),g=this.bi.si(),m=c||f||u||A||g;let y=this.ve;if(m){if(!y){const t=this.ae();this.vi()&&(t.depthStencil=this.regl.renderbuffer({width:this.canvas.width,height:this.canvas.height,samples:this.layer.options.multiSamples,format:"depth24 stencil8"})),y=this.ve=this.regl.framebuffer(t)}const{width:t,height:e}=this.canvas;y.width===t&&y.height===e||y.resize(t,e)}else y=null,this.ve&&(this.ve.destroy(),delete this.ve);let v=this.ii(this.Di);const x=this.Xi&&this.ii(this.Yi),b=this.Zi&&this.ii(this.Ji);if(this.Ni.fxaa(y,v,!d&&x,!d&&b,r,this.qi&&this.Wi&&this.ii(this.Wi),p,+!(!e.toneMapping||!e.toneMapping.enable),+!(m||!e.sharpen||!e.sharpen.enable),n.getDevicePixelRatio(),i,s&&this.ee>0&&this.ie(),o,a,l,h),y&&(v=this.ii(y)),c&&(this.qi||this.Vi||this.Hi)&&(v=this.Ni.ssao(v,this.Gi(),{projMatrix:n.projMatrix,cameraNear:n.cameraNear,cameraFar:n.cameraFar,ssaoBias:e.ssao&&e.ssao.bias||10,ssaoRadius:e.ssao&&e.ssao.radius||100,ssaoIntensity:e.ssao&&e.ssao.intensity||.5})),f&&this.$i){const t=e.bloom,n=+t.threshold||0,r=Me(t,"factor",1),i=Me(t,"radius",1);v=this.Ni.bloom(v,x,b,n,r,i,p)}if(u&&(this.Ni.genSsrMipmap(v,this.Gi()),this.le)){const t=this.ji;this.setToRedraw(),this.ji=t,this.le=!1}this.pe&&(v=this.be(v)),this.isEnableWeather()&&(v=this.ke(v)),m&&this.Ni.renderFBOToScreen(v,+!(!e.sharpen||!e.sharpen.enable),i,n.getDevicePixelRatio()),this.layer.fire("postprocessend")}}function be(t){return"number"==typeof t&&!isNaN(t)}function we(t){return t._framebuffer.framebuffer}function _e(t){return t.depthStencil._texture.texture}function Me(t,e,n){return null==t[e]?n:t[e]}class Te extends a["R"].Actor{constructor(t){super("@maptalks/terrain"),this.mapId=t}checkUrl(t){return t&&a["I"].isString(t)?a["I"].getAbsoluteURL(t):t}fetchTerrain(t,e,n){t=this.checkUrl(t);const r={actorId:this.actorId,mapId:this.mapId,command:"fetchTerrain",params:{url:t,origin:location.origin,terrainWidth:e.terrainWidth,type:e.type,accessToken:e.accessToken,cesiumIonTokenURL:e.cesiumIonTokenURL,error:e.error}};this.send(r,null,(t,e)=>{t?n(t):n(t,e)})}abortTerrain(t,e){const n={actorId:this.actorId,mapId:this.mapId,command:"abortTerrain",params:{url:t}};this.broadcast(n,null,e)}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{}};this.broadcast(r,null,n)}createTerrainMesh(t,e){const n={actorId:this.actorId,command:"createTerrainMesh",params:t};this.send(n,[t.terrainHeights.data.buffer],(t,n)=>{t?e(t):e(t,n)})}removeLayer(t,e,n){const r={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(r,null,n)}}class Se{constructor(t=257){this.gridSize=t;const e=t-1;if(e&e-1)throw new Error(`Expected grid size to be 2^n+1, got ${t}.`);this.numTriangles=e*e*2-2,this.numParentTriangles=this.numTriangles-e*e,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let n=0;n<this.numTriangles;n++){let t=n+2,r=0,i=0,s=0,o=0,a=0,l=0;for(1&t?s=o=a=e:r=i=l=e;(t>>=1)>1;){const e=r+s>>1,n=i+o>>1;1&t?(s=r,o=i,r=a,i=l):(r=s,i=o,s=a,o=l),a=e,l=n}const h=4*n;this.coords[h+0]=r,this.coords[h+1]=i,this.coords[h+2]=s,this.coords[h+3]=o}}createTile(t){return new Ie(t,this)}}class Ie{constructor(t,e){const n=e.gridSize;if(t.length!==n*n)throw new Error(`Expected terrain data of length ${n*n} (${n} x ${n}), got ${t.length}.`);this.terrain=t,this.martini=e,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:e,coords:n,gridSize:r}=this.martini,{terrain:i,errors:s}=this;for(let o=t-1;o>=0;o--){const t=4*o,a=n[t+0],l=n[t+1],h=n[t+2],c=n[t+3],u=a+h>>1,f=l+c>>1,d=u+f-l,p=f+a-u,A=(i[l*r+a]+i[c*r+h])/2,g=f*r+u,m=Math.abs(A-i[g]);if(s[g]=Math.max(s[g],m),o<e){const t=(l+p>>1)*r+(a+d>>1),e=(c+p>>1)*r+(h+d>>1);s[g]=Math.max(s[g],s[t],s[e])}}}getMesh(t=0){const{gridSize:e,indices:n}=this.martini,{errors:r}=this;let i=0,s=0;const o=e-1;function a(o,l,h,c,u,f){const d=o+h>>1,p=l+c>>1;Math.abs(o-u)+Math.abs(l-f)>1&&r[p*e+d]>t?(a(u,f,o,l,d,p),a(h,c,u,f,d,p)):(n[l*e+o]=n[l*e+o]||++i,n[c*e+h]=n[c*e+h]||++i,n[f*e+u]=n[f*e+u]||++i,s++)}n.fill(0),a(0,0,o,o,o,0),a(o,o,0,0,0,o);const l=new Uint16Array(2*i),h=new Uint32Array(3*s);let c=0;function u(i,s,o,a,f,d){const p=i+o>>1,A=s+a>>1;if(Math.abs(i-f)+Math.abs(s-d)>1&&r[A*e+p]>t)u(f,d,i,s,p,A),u(o,a,f,d,p,A);else{const t=n[s*e+i]-1,r=n[a*e+o]-1,u=n[d*e+f]-1;l[2*t]=i,l[2*t+1]=s,l[2*r]=o,l[2*r+1]=a,l[2*u]=f,l[2*u+1]=d,h[c++]=t,h[c++]=r,h[c++]=u}}return u(0,0,o,o,o,0),u(o,o,0,0,0,o),{vertices:l,triangles:h}}getMeshWithSkirts(t=0,e){const{gridSize:n,indices:r}=this.martini,{errors:i}=this;let s=0,o=0;const a=n-1;let l,h,c=0;const u=[],f=[],d=[],p=[];function A(e,g,m,y,v,x){const b=e+m>>1,w=g+y>>1;Math.abs(e-v)+Math.abs(g-x)>1&&i[w*n+b]>t?(A(v,x,e,g,b,w),A(m,y,v,x,b,w)):(l=g*n+e,h=y*n+m,c=x*n+v,0===r[l]&&(0===e?u.push(s):e===a&&f.push(s),0===g?d.push(s):g===a&&p.push(s),r[l]=++s),0===r[h]&&(0===m?u.push(s):m===a&&f.push(s),0===y?d.push(s):y===a&&p.push(s),r[h]=++s),0===r[c]&&(0===v?u.push(s):v===a&&f.push(s),0===x?d.push(s):x===a&&p.push(s),r[c]=++s),o++)}let g;r.fill(0),A(0,0,a,a,a,0),A(a,a,0,0,0,a),g=e?2*(s+3*u.length-2+3*f.length-2+3*d.length-2+3*p.length-2):2*(s+u.length+f.length+d.length+p.length);const m=3*(o+2*(u.length-1)+2*(f.length-1)+2*(d.length-1)+2*(p.length-1)),y=new Uint16Array(g),v=new Uint32Array(m);let x=0;function b(e,s,o,a,l,h){const c=e+o>>1,u=s+a>>1;if(Math.abs(e-l)+Math.abs(s-h)>1&&i[u*n+c]>t)b(l,h,e,s,c,u),b(o,a,l,h,c,u);else{const t=r[s*n+e]-1,i=r[a*n+o]-1,c=r[h*n+l]-1;y[2*t]=e,y[2*t+1]=s,y[2*i]=o,y[2*i+1]=a,y[2*c]=l,y[2*c+1]=h,v[x++]=t,v[x++]=i,v[x++]=c}}b(0,0,a,a,a,0),b(a,a,0,0,0,a),u.sort((t,e)=>y[2*t+1]-y[2*e+1]),f.sort((t,e)=>y[2*e+1]-y[2*t+1]),d.sort((t,e)=>y[2*e]-y[2*t]),p.sort((t,e)=>y[2*t]-y[2*e]);let w,_,M,T,S=2*s,I=0;function C(t){I=t.length;for(let n=0;n<I-1;n++)w=t[n],_=t[n+1],M=S/2,T=(S+(e?6:2))/2,y[S++]=2*w,y[S++]=2*w+1,e&&(y[S++]=2*w,y[S++]=2*w+1,y[S++]=2*_,y[S++]=2*_+1),e?(v[x++]=M+1,v[x++]=M,v[x++]=M+2,v[x++]=M,v[x++]=T,v[x++]=M+2):(v[x++]=w,v[x++]=M,v[x++]=_,v[x++]=M,v[x++]=T,v[x++]=_);y[S++]=2*t[I-1],y[S++]=2*t[I-1]+1}C(u);const O=S;C(f);const E=S;C(d);const P=S;return C(p),{vertices:y,triangles:v,numVerticesWithoutSkirts:s,numTrianglesWithoutSkirts:o,leftSkirtIndex:O,rightSkirtIndex:E,bottomSkirtIndex:P,topSkirtIndex:S}}}const Ce={};function Oe(t,e,n,r){let i=Ce[n];i||(i=Ce[n]=new Se(n));const s=i.createTile(e),o=r?s.getMeshWithSkirts(t,!0):s.getMesh(t),{triangles:a,vertices:l,leftSkirtIndex:h,rightSkirtIndex:c,bottomSkirtIndex:u,topSkirtIndex:f}=o;let{numVerticesWithoutSkirts:d,numTrianglesWithoutSkirts:p}=o;d||(d=l.legnth/3,p=a.length/3);const A=l.length/2,g=new Float32Array(3*A),m=new Float32Array(2*A);let y=1/0,v=-1/0;const x=n-1;for(let b=0;b<A;b++){const t=l[2*b],r=l[2*b+1];if(b>=d){const e=t/2*3;let n,r=.001;(b-(b<h/2?d:b<c/2?h/2:b<u/2?c/2:u/2))%3==0?(n=0,r=0):n=g[e+2],g[3*b]=g[e],g[3*b+1]=g[e+1],g[3*b+2]=n,m[2*b]=g[e]/x+r,m[2*b+1]=-g[e+1]/x+r}else g[3*b]=1*t,g[3*b+1]=1*-r,g[3*b+2]=e[r*n+t],m[2*b]=t/x,m[2*b+1]=r/x;const i=g[g.length-1];i<y&&(y=i),i>v&&(v=i)}return{positions:g,texcoords:m,triangles:a,leftSkirtIndex:h,rightSkirtIndex:c,bottomSkirtIndex:u,topSkirtIndex:f,numTrianglesWithoutSkirts:p,numVerticesWithoutSkirts:d,minHeight:y,maxHeight:v,terrainWidth:n}}function Ee(t,e,n,r,i,s,o,a,l){const h={};for(let c=0;c<l;c++)h[c+""]=ke(t,e,n,r,i,s,o,a,c);return h}const Pe=[];function ke(t,e,n,r,i,s,o,a,l){if((r-=l)<=0)return Pe;const h=t.getTileSize().width,c=t._getTileOffset(r,i),u=s[0]-c[0],f=c[1]-s[1],d=t._getTileConfig(),p=t.getSpatialReference().getResolution(r),A=d.tileSystem.scale.y;let g=0,m=0,y=a/=Math.pow(2,l),v=a;if(u<0?y+=Math.ceil(-u/h-1e-7):u>0&&(g-=Math.ceil(u/h-1e-7)),f>0?m-=Math.ceil(f/h-1e-7):f<0&&(v+=Math.ceil(-f/h-1e-7)),0===g&&0===m&&y<=1&&v<=1){const i=Math.floor(e*a);let s=Math.floor(n*a);const l=s;return A!==o&&(s=De(d,s,p)),[{x:i,y:s,skinY:l,z:r,offset:c,tileSize:h,id:t._getTileId(i,s,r)}]}const x=[];for(let b=g;b<y;b++)for(let i=m;i<v;i++){const s=e*a+b;let l=n*a+i;const u=l;A!==o&&(l=De(d,l,p)),x.push({x:s,y:l,skinY:u,z:r,offset:c,tileSize:h,id:t._getTileId(s,l,r)})}return x}function Re(t,e,n,r){let i=t/n*r/e;return i<1?(i=1/i,i=1/Math.round(i)):i=Math.round(i),i}function Ne(t,e,n){const r=t.getResolution(e),i=e-Math.log(n/r)*Math.LOG2E;return{zoom:i,res:t.getResolution(i)}}function De(t,e,n){const r=t.fullExtent,i=t.tileSize.width,s=Math.max(r.top,r.bottom),o=Math.min(r.top,r.bottom);return Math.ceil(s/i/n)-1-Math.floor(o/i/n)-e}function Fe(t,e){const n=e*e,r=0!==t?new Float32Array(n):new Uint8Array(n);return r.fill(t),{data:r,width:e,height:e,max:t,min:t}}new a["A"](0,0);const Le=Fe(0,5),ze=Oe(1,Le.data,Le.width,!0);ze.empty=!0;const Be=[],He=[];class Ue{constructor(t){this.layer=t,this.regl=t.getRenderer().regl,this.renderer=new s["Renderer"](this.regl),this.Ae=new s["Scene"];const e=new Uint8Array(16);e.fill(255),this.Oe=this.regl.texture({width:2,height:2,data:e}),this.Ie=new s["ResourceLoader"](this.Oe),this.Ee()}setToRedraw(){this.layer.getRenderer().setToRedraw()}getMap(){return this.layer.getMap()}startFrame(){this.shader||this.initShader(),this.Ae.clear()}createTerrainMesh(t,e){const{mesh:n,image:r}=e;let i=e.terrainMesh;const{positions:o,texcoords:a,triangles:l,empty:h}=n;if(i&&i.geometry!==this.Le)i.geometry.updateData("aPosition",o),i.geometry.updateData("aTexCoord",a),i.geometry.setElements(l);else{const t=h?this.Le:new s["Geometry"]({aPosition:o,aTexCoord:a},l,0);i?i.geometry=t:(i=new s["Mesh"](t,null,{disableVAO:!0}),t.generateBuffers(this.regl))}if(!i.uniforms.skin){const t=this.getEmptyTexture();i.setUniform("skin",t)}return i.setUniform("heightTexture",r),this.prepareMesh(i,t,e),i}Fe(t){const e=this.layer.getRenderer();e&&e.updateMaskDefines(t)}Re(t){const e=this.Pe(100)/100,n=o["c"].identity(t);return o["c"].scale(n,n,[1,1,e]),n}De(t,e,n){const r=this.getMap(),i=this.layer.getTileSize().width,s=e.res/r.getGLRes(),a=i/(n-1),{extent2d:l,offset:h}=e;o["f"].set(Be,(l.xmin-h[0])*s,(e.extent2d.ymax-h[1])*s,0);const c=o["c"].identity(t);return o["c"].translate(c,c,Be),o["f"].set(He,s*a,s*a,1),o["c"].scale(c,c,He),c}prepareMesh(t,e,n){if(!t.isValid())return;const{mesh:r}=n;this.Fe(t);const{triangles:i,numTrianglesWithoutSkirts:s,terrainWidth:o}=r;t.localTransform=this.De(t.localTransform||[],e,o),t.positionMatrix=this.Re(t.positionMatrix||[]),t.properties.skirtOffset=3*s,t.properties.skirtCount=i.length-3*s,t.properties.z=e.z,t.properties.minHeight=r.minHeight,t.properties.maxHeight=r.maxHeight,t.properties.terrainWidth=o,t.castShadow=!1,st(t.uniforms,"minAltitude")||Object.defineProperty(t.uniforms,"minAltitude",{enumerable:!0,get:()=>n.minAltitude||0})}addTerrainImage(t,e){const n=e.terrainMesh;n&&n.geometry&&e.skin&&(n.setUniform("skin",e.skin.color[0]),n.setUniform("polygonOpacity",1),this.Ae.addMesh(n))}endFrame(t){this.updateIBLDefines(this.shader);let e=0;const n=this.getUniformValues(),r=this.He(t);return this.shader.filter=t&&t.sceneFilter,e+=this.renderer.render(this.shader,n,this.Ae,r),e}delete(){this.shader&&(this.shader.dispose(),delete this.shader),this.Oe&&(this.Oe.destroy(),delete this.Oe),this.Le&&(this.Le.dispose(),delete this.Le)}deleteMesh(t){if(!t)return;const e=t.geometry;t.dispose(),e!==this.Le&&e.dispose()}initShader(){const t=[],e=[];this.shader=new s["MeshShader"]({vert:"#define SHADER_NAME TERRAIN_MESH\nattribute vec3 aPosition;\nattribute vec2 aTexCoord;\nuniform float minAltitude;\nuniform mat4 projViewModelMatrix;\nuniform mat4 projMatrix;\nuniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 positionMatrix;\nuniform float heightScale;\nvarying vec2 vUv;\n#include <mask_vert>\nvoid main() {\n    vec3 position = vec3(aPosition.xy, (aPosition.z + minAltitude) * heightScale);\n    #ifdef HAS_MASK_EXTENT\n        gl_Position = projMatrix * getMaskPosition(positionMatrix * vec4(position, 1.0), modelMatrix);\n    #else\n        gl_Position = projViewModelMatrix * positionMatrix * vec4(position, 1.0);\n    #endif\n    vUv = aTexCoord;\n}",frag:"#define SHADER_NAME TERRAIN_MESH\nprecision mediump float;\nuniform sampler2D skin;\nuniform float polygonOpacity;\nvarying vec2 vUv;\n#include <mask_frag>\nvoid main() {\n    vec2 uv = vec2(vUv);\n    uv.y = 1.0 - uv.y;\n    vec4 color = texture2D(skin, uv);\n    gl_FragColor = color * polygonOpacity;\n    #ifdef HAS_MASK_EXTENT\n      gl_FragColor = setMask(gl_FragColor);\n    #endif\n}",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,n){return o["c"].multiply(e,n.viewMatrix,n.modelMatrix)}},{name:"projViewModelMatrix",type:"function",fn:function(e,n){return o["c"].multiply(t,n.projViewMatrix,n.modelMatrix)}}],extraCommandProps:this.getExtraCommandProps()})}getExtraCommandProps(){const t=this.layer.getRenderer().canvas;return{viewport:{x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},stencil:{enable:!1},cull:{enable:!0,face:"back"},depth:{enable:!0,mask:()=>!!this.layer.options.depthMask,func:this.layer.options.depthFunc||"<="},blend:{enable:!0,func:{src:this.layer.options.blendSrc,dst:this.layer.options.blendDst},equation:"add"}}}He(t){return t&&t.renderTarget&&t.renderTarget.fbo}getUniformValues(){const t=this.getMap(),e=t.projViewMatrix,n=this.layer.getRenderer().getMaskUniforms(),r={viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:e,heightScale:1};return tt(r,n),r}Pe(t){const e=this.layer.getMap();return e?e.altitudeToPoint(t,e.getGLRes()):null}getEmptyTexture(){return this.Oe}hasIBL(){const t=this.getMap().getLightManager();return!(!t||!t.getAmbientResource())}updateIBLDefines(t){const e=t.shaderDefines;let n=!1;this.hasIBL()?e[["HAS_IBL_LIGHTING"]]||(e.HAS_IBL_LIGHTING=1,n=!0):e[["HAS_IBL_LIGHTING"]]&&(delete e.HAS_IBL_LIGHTING,n=!0),n&&(t.shaderDefines=e)}Ee(){const t=ze,{positions:e,texcoords:n,triangles:r}=t;this.Le=new s["Geometry"]({aPosition:e,aTexCoord:n},r,0),this.Le.generateBuffers(this.regl)}}const{getIBLResOnCanvas:je,getPBRUniforms:Ve,loginIBLResOnCanvas:Ge,logoutIBLResOnCanvas:qe}=s["pbr"].PBRUtils,We={baseColorFactor:[1,1,1,1],emissiveFactor:[0,0,0],baseColorIntensity:1,emitColorFactor:1,roughnessFactor:1,metallicFactor:0,emitMultiplicative:1,outputSRGB:1,hsv:[0,0,0],contrast:1,alphaTest:0};class Xe extends Ue{constructor(...t){super(...t),this.createIBLTextures(),this.Ne=0}updateMaterial(t,e){this.Ne=e,this.Ge=this.Ge||{},tt(this.Ge,t),this.setToRedraw()}setMaterial(t,e){this.Ne=e,this.Ge=tt({},We,t),this.setToRedraw()}createIBLTextures(){const t=this.getMap().getRenderer().canvas;Ge(t,this.regl,this.getMap()),this.layer.fire("iblupdated")}disposeIBLTextures(){const t=this.getMap().getRenderer().canvas;qe(t,this.getMap())}createTerrainMesh(t,e){const{mesh:n,image:r}=e,{positions:i,texcoords:o,triangles:a,leftSkirtIndex:l,rightSkirtIndex:h,bottomSkirtIndex:c,numVerticesWithoutSkirts:u}=n,f=new Int8Array(i.length);for(let s=2;s<f.length;s+=3)s<3*u?f[s]=1:s<l/2*3?f[s-2]=-1:s<h/2*3?f[s-2]=1:f[s-1]=s<c/2*3?-1:1;const d=new s["Geometry"]({aPosition:i,aTexCoord:o,aNormal:f},a,0);let p;d.createTangent(),delete d.data.aNormal,d.generateBuffers(this.regl),p=r?this.regl.texture({width:r.width,height:r.height,data:r,min:"linear",mag:"linear"}):this.getEmptyTexture();const A=this.getEmptyTexture(),g=tt({},We,this.layer.options.material||{});g.skinTexture=A,g.terrainHeightTexture=p;const m=new s["pbr"].StandardMaterial(g),y=new s["Mesh"](d,m);y.properties.matVer=this.Ne;const v=y.defines;return v.HAS_UV_FLIP=1,v.HAS_TERRAIN_NORMAL=1,v.HAS_MAP=1,y.defines=v,y.setUniform("terrainTileResolution",t.res),this.prepareMesh(y,t,e),y}addTerrainImage(t,e){const n=e.terrainMesh;if(n){if(this.Ge&&n.properties.matVer!==this.Ne){for(const t in this.Ge)n.material.set(t,this.Ge[t]);n.properties.matVer=this.Ne}e.skin&&n.material.set("skinTexture",e.skin),n.setUniform("polygonOpacity",1),this.Ae.addMesh(n)}}getUniformValues(){const t=this.getMap(),e=t.getRenderer().canvas,{iblTexes:n,dfgLUT:r}=je(e),i=Ve(t,n,r),s=this.layer.getTileSize().width,o=this.layer.getRenderer().getMaskUniforms(),a=this.Pe(100)/100;return tt(i,{viewMatrix:t.viewMatrix,projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,outSize:[e.width,e.height],polygonFill:[1,1,1,1],terrainHeightMapResolution:[s,s],terrainResolution:[e.width,e.height],terrainHeightScale:a,terrainUnpackFactors:[6553.6,25.6,.1,1e4]}),tt(i,o),i}initShader(){this.shader=new s["pbr"].StandardShader({extraCommandProps:this.getExtraCommandProps()})}delete(){return this.disposeIBLTextures(),super.delete()}}function Qe(t,e,n,r){const i=Ye.call(this,n,r);this._projViewMatrix=e;const{colorExtent:s,modeExtent:o}=this._extentPass.render(i,e);this._maskUniforms=this._maskUniforms||{},this._maskUniforms.mask_colorExtent=s,this._maskUniforms.mask_extent=t,this._maskUniforms.mask_modeExtent=o,this._maskUniforms.mask_hasFlatOut=Ke.call(this,"flat-outside"),this._maskUniforms.mask_hasClipOut=Ke.call(this,"clip-outside"),this._maskUniforms.mask_hasVideo=Ke.call(this,"video"),this._maskUniforms.mask_heightRatio=n,this._maskUniforms.mask_heightOffset=r,this.setToRedraw()}function Ye(t,e){const n=[],r=this.layer.getMasks();for(let i=0;i<r.length;i++){const s=r[i].getMesh(this.regl,t,e);s&&n.push(s)}return n}function Ze(){if(!this._extentPass||!this._maskUniforms)return;const t=this._maskUniforms.mask_heightRatio,e=this._maskUniforms.mask_heightOffset,n=Ye.call(this,t,e);this._extentPass.render(n,this._projViewMatrix);const r=this.layer.getMasks();for(let i=0;i<r.length;i++)"video"===r[i].getMode()&&r[i].je()}function Ke(t){const e=this.layer.getMasks();for(let n=0;n<e.length;n++)if(e[n].getMode()===t)return 1;return 0}function Je(){const t=this.layer.getMasks();if(!t)return!1;for(let e=0;e<t.length;e++)if("video"===t[e].getMode()&&t[e].Be())return!0;return!1}function $e(t){return class extends t{setMask(t,e,n,r){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),this._extentPass?Qe.call(this,t,e,n,r):this.regl?(this._extentPass=new s["ExtentPass"](this.regl,this.viewport),Qe.call(this,t,e,n,r)):this.layer.once("contextcreate",()=>{this._extentPass=new s["ExtentPass"](this.regl,this.viewport),Qe.call(this,t,e,n,r)},this)}needToRedraw(){return!!super.needToRedraw()||!!Je.call(this)}getMaskUniforms(){return Je.call(this)&&Ze.call(this),this.layer.updateExtent(),this._maskUniforms}getMaskDefines(){return this._maskDefines||(this._maskDefines={}),this._maskUniforms&&this._maskUniforms.mask_colorExtent?this._maskDefines.HAS_MASK_EXTENT=1:delete this._maskDefines.HAS_MASK_EXTENT,this._maskDefines}updateMaskDefines(t){const e=t.getDefines();delete e.HAS_MASK_EXTENT,tt(e,this.getMaskDefines()),t.setDefines(e)}_clearMask(){this._deleteMaskUniforms(),this._extentPass&&(this._extentPass.dispose(),delete this._extentPass),this.setToRedraw()}_deleteMaskUniforms(){delete this._maskUniforms}}}class tn{constructor(t,e){this.max=t,this.onRemove=e,this.reset()}reset(){if(this.data){const t=this.data.values();for(const e of t)this.onRemove(e)}return this.data=new Map,this}clear(){this.reset(),delete this.onRemove}add(t,e){return e?(this.has(t)?(this.data.delete(t),this.data.set(t,e)):this.data.set(t,e),this):this}keys(){const t=new Array(this.data.size);let e=0;const n=this.data.keys();for(const r of n)t[e++]=r;return t}has(t){return this.data.has(t)}getAndRemove(t){if(!this.has(t))return null;const e=this.data.get(t);return this.data.delete(t),e}get(t){return this.has(t)?this.data.get(t):null}pop(){if(this.data.size<this.max)return null;const t=this.data.keys().next();return this.data.get(t.value).current?(this.max+=Math.ceil(this.max/2),null):this.getAndRemove(t.value)}remove(t){if(!this.has(t))return this;const e=this.data.get(t);return this.data.delete(t),this.onRemove(e),this}resetCurrent(t){this.data&&this.data.forEach(e=>{e.current=t})}}const en=new a["A"](0,0),nn=new a["A"](0,0),rn=new a["B"](0,0,0,0),sn=new a["A"](0,0),on=new a["A"](20,20),an={color:[0,0,0,0],depth:1,stencil:0};class ln extends($e(a["P"].TileLayerCanvasRenderer)){isDrawable(){return!0}getTempTileOnLoading(t,e){if(e.image&&!e.image.reset)return e;const n=this.Ue(t);return n.temp=!0,e.image||(e.image=n),delete e.image.reset,e.current=!0,e.info=t,tt(e.image,n),this.ze(e.image,t),e}Ve(t,e,n){e.reset=!0,delete e.data,delete e.loadTime,delete e.rendered,delete e.minAltitude;const r=t.id+"-temp",i=e.skinImages;if(i)for(let s=0;s<i.length;s++){const t=i[s];if(t){for(let e=0;e<t.length;e++){const i=t[e];i&&(i.refs.delete(r),i.refs.size||n.push(i))}delete t.currentSkins,delete t.tileIds}}delete e.sourceZoom,delete e.skinImages,delete e.skinStatus,delete e.skinTileIds,e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture)}Ue(t,e){for(e=e||this.findParentTile(t);e&&e.image&&(-1===e.image.sourceZoom||e.image.originalError);)e=this.findParentTile(e.info);const n=(e&&e.info||t).res,r=this.getMap().pointAtResToDistance(1,1,n),i=e&&e.image&&e.image.data&&this.We(e,t),s=i&&-1!==e.image.sourceZoom?e.info.z:-1;if(!i||i.width<=1){const n=this.qe(t,e);return{data:Fe(n||0,5),minAltitude:n,mesh:ze,sourceZoom:s}}const o=i.width;return{data:i,mesh:Oe(r,i.data,o,!0),sourceZoom:s}}qe(t,e){if(e&&e.minAltitude)return e.minAltitude;const{idx:n,idy:r,z:i}=t;for(let s=-1;s<=1;s++)for(let t=-1;t<=1;t++){if(0===s&&0===t)continue;const e=this.layer.getTileId(n+s,r+t,i),o=this.layer.tileInfoCache.get(e);if(o&&o.minAltitude)return o.minAltitude}return 0}consumeTile(t,e){if(t.empty&&!t.mesh){const n=this.findParentTile(e);if(!n||n.image&&n.image.empty){t.mesh=ze;const n=this.qe(e);t.data=Fe(n||0,5),t.minAltitude=n,t.sourceZoom=-1}else t=this.Ue(e,n)}this.ze(t,e),super.consumeTile(t,e),this.$e(e)}ze(t,e){if(t&&t.mesh){t.terrainMesh=this.Ye.createTerrainMesh(e,t),e.minAltitude=t.data.min,e.maxAltitude=t.data.max,delete t.mesh;const n=this.layer.tileInfoCache;if(n&&e.parent&&!t.empty&&!t.temp){const t=n.get(e.parent);if(t){const{minAltitude:n,maxAltitude:r}=e;(void 0===t.minAltitude||t.minAltitude>n)&&(t.minAltitude=n),(void 0===t.maxAltitude||t.maxAltitude<r)&&(t.maxAltitude=r)}}}}$e(t){const e=this.getMap();if(e.updateCenterAltitude&&void 0===e.centerAltitude&&t.z===this.getCurrentTileZoom()){const n=e._getPrjCenter(),r=e._prjToPointAtRes(n,t.res,sn);t.extent2d.contains(r)&&e.updateCenterAltitude()}}draw(t,e){this.Xe(),this.Ye.startFrame(),super.draw(t,e),this.Je(e)}drawTile(t,e){const n=this.getMap();if(!t||!n||!e)return;if(!this.drawingCurrentTiles&&!this.drawingChildTiles)return;let r=this.drawingCurrentTiles?this.getTileOpacity(e):1;r*=this.layer.options.opacity||1,this.Ye.addTerrainImage(t,e,r)}_drawTiles(t,e,n,r,i,s,o){const a=[],l=this.Ze(s,a);this.Ke=0;const h=this.layer.getSkinCount();ot(t,l);const c=new Set;for(let u=0;u<h;u++)this.Qe(u,o,c,a);for(let u=0;u<h;u++)this.Qe(u,t,c,a);for(let u=0;u<t.length;u++)this.ts(t[u].info,t[u].image);for(let u=0;u<a.length;u++)a[u]&&a[u].texture&&!a[u].refs.size&&(this.es.delete(a[u].tile.id),this.ss(a[u]));return this.ns(),super._drawTiles(...arguments)}Ze(t,e){const n=[];let r=this.rs;r||(r=this.rs=new tn(this.layer.options.tempTileCacheSize,t=>{const{info:e,image:n}=t;this.hs(e,n)})),r.resetCurrent(!1);for(let i=0;i<t.length;i++){const s=t[i];let o;r.has(s.id)?o=r.getAndRemove(s.id):(o=r.pop(),o?o.image&&(this.Ve(o.info,o.image,e),o.image.temp=!0):o={info:s}),o.current=!0,r.add(s.id,o),n.push(o)}for(let i=0;i<t.length;i++)this.getTempTileOnLoading(t[i],n[i]);return n}ns(){if(!this.es)return;const t=this.getCurrentTimestamp();if(this.os&&t-this.os<1e3)return;const e=new Set;for(const n of this.tileCache.data.values())this.as(n,e);for(const n in this.tilesInView){const t=this.tilesInView[n];this.as(t,e)}if(this.rs)for(const n of this.rs.data.values())this.as(n,e);e.size&&(this.es.forEach((t,n)=>{e.has(n)||(console.log("deleted:",n),this.ss(this.es.get(n)),this.es.delete(n))}),this.os=t)}as(t,e){const n=t.image&&t.image.skinImages;if(n&&n.length)for(let r=0;r<n.length;r++){const t=n[r]&&n.currentSkins;if(t)for(const n of t)e.add(n)}}Qe(t,e,n,r){const i=this.layer.getSkinLayer(t).getRenderer();if(!i)return;const s=[];for(let o=0;o<e.length;o++){const{info:i,image:a}=e[o];if(this.cs(t,i,a,r)){const r=e[o].image.skinImages[t];for(let t=0;t<r.length;t++){const e=r[t].tile.info.id;n.has(e)||(s.push(r[t]),n.add(e))}}}i.renderTerrainSkin(this.regl,this.layer,s)}cs(t,e,n,r){const i=this.getMap();if(delete n.path,!e||!i||!n)return!1;if(!n.terrainMesh)return!1;const s=this.layer.getSkinLayer(t),o=s.getRenderer();if(!o)return!1;n.skinImages||(n.skinImages=[]),n.skinStatus||(n.skinStatus=[]),n.skinTileIds||(n.skinTileIds=[]);const a=o.isAnimating&&o.isAnimating(),l=n.skinStatus[t],h=o.needToRefreshTerrainTileOnZooming&&o.needToRefreshTerrainTileOnZooming(),c=a||h&&n.renderedZoom!==i.getZoom();if(l&&!c)return!1;const u=s.getSpatialReference(),{x:f,y:d,z:p,res:A,offset:g}=e;let m=e.nw;m||(m=e.nw=this.getMap().pointAtResToCoord(e.extent2d.getMin(en),e.res));const y=this.layer.getTileSize().width,{res:v,zoom:x}=Ne(u,p,A),b=Re(v,s.getTileSize().width,A,y);let w=n.skinTileIds[t];if(!w){const e=this.layer._getTileConfig().tileSystem.scale.y;w=n.skinTileIds[t]=Ee(s,f,d,x,m,g,e,b,hn)}const _=w[0];let M=!0;const T=[];for(let N=0;N<_.length;N++){const t=o.getCachedTile(_[N],!1);if(t)T.push(t);else{M=!1;const t=o.findParentTile(_[N]);t&&T.push(t)}}const S=n.skinImages[t]||[];S.currentSkins=S.currentSkins||new Set;const I=new Set;let C=!1;for(let N=0;N<S.length;N++){if(!S[N].tile){C=!0;continue}const t=S[N].tile.info.id;I.add(t)}if(!T.length)return S.currentSkins.clear(),n.skinImages[t]=[],!1;const O=T.length?T.map(t=>t.info.id).join():T[0].info.id;if(!c&&!C&&S.tileIds===O)return!1;S.tileIds=O;let E=!1;S.currentSkins.clear(),S.length=0;const P=S.currentSkins;let k=e.id;n.temp&&(k+="-temp");for(let N=0;N<T.length;N++){const t=T[N].info.id;P.add(t);let e=this.ls(t);e&&(R=e)&&R.texture||(e={tile:tt({},T[N]),layer:s,refs:new Set,texture:o.createTerrainTexture(this.regl)},this.us(t,e)),e.refs.add(k),S.push(e),E=!0}var R;return this.fs(e,n,I,P,r),E&&this.Ke++,n.skinImages[t]=S,s.fire("renderterrainskin",{tile:e,skinTiles:T}),M&&(n.skinStatus[t]=1),!0}fs(t,e,n,r,i){if(!n.size)return;let s=t.id;e.temp&&(s+="-temp");for(const o of n)if(!r||!r.has(o)){const t=this.ls(o);this.ds(t,s,i)}}ls(t){return this.es||(this.es=new Map),this.es.get(t)}us(t,e){this.es.set(t,e)}ts(t,e){const n=this.getMap();if(!t||!n||!e)return;const r=e.skinImages,i=this.ps(e.renderedZoom);if(e.rendered&&!i)return;e.skin?(an.framebuffer=e.skin,this.regl.clear(an)):e.skin=this.gs(),this.ms();const o=this.layer.options.debug,a=[],l=o&&[],h=this.layer.getTileSize().width;if(r)for(let c=0;c<r.length;c++){const e=r[c];for(let n=0;n<e.length;n++){const{tile:r,texture:i,layer:o}=e[n];if((r.info.offset[0]||r.info.offset[1])&&t.skinTileIds){const e=t.skinTileIds[o.getId()];for(let t=0;t<e.length;t++)if(r.info.x===e[t].x&&r.info.y===e[t].y){r.info.offset=e[t].offset;break}}const l=un(t,r,h),c=e[n].skinMesh||new s["Mesh"](this.vs);c.setUniform("skinTexture",i);const u=o.getOpacity();c.setUniform("opacity",et(u)?1:u),c.setUniform("skinDim",l),c.setUniform("tileSize",h),c.setUniform("x",t.x),c.setUniform("y",t.y),e[n].skinMesh=c,a.push(c)}}if(o){const n=e.skinDebugMesh||new s["Mesh"](this.vs);n.setUniform("tileSize",h);const r=e.debugTexture||this.ws(t,h);e.debugTexture=r,e.skinDebugMesh=n,n.setUniform("opacity",1),n.setUniform("skinTexture",r),n.setUniform("skinDim",[0,0,1]),n.setUniform("tileSize",h),l.push(n)}if(a.length){this._s.setMeshes(a);try{this.renderer.render(this.Ms,null,this._s,e.skin)}catch(t){throw console.error(e),t}}l&&l.length&&this.layer.options.debug&&(this._s.setMeshes(l),this.renderer.render(this.Ms,null,this._s,e.skin)),e.rendered=this.xs(e),e.renderedZoom=n.getZoom()}ws(t,e){e*=2;const{x:n,y:r,z:i}=t,s=`terrain:${n}/${r}/${i}`,o=document.createElement("canvas");o.width=e,o.height=e;const a=o.getContext("2d");a.font="40px monospace";const l=this.layer.options.debugOutline;return a.fillStyle=l,a.strokeStyle=l,a.fillText(s,20,e-40),a.beginPath(),a.lineWidth=4,a.moveTo(0,0),a.lineTo(e,0),a.lineTo(e,e),a.lineTo(0,e),a.lineTo(0,0),a.stroke(),this.regl.texture({data:o,flipY:!0,mag:"linear",min:"linear"})}gs(){const t=this.layer.getTileSize().width,e=2*t,n=2*t,r=this.regl,i=r.texture({min:"linear",mag:"linear",type:"uint8",width:e,height:n,flipY:!0}),s={width:e,height:n,colors:[i],colorFormat:"rgba",ignoreStatusCheck:!0,depthStencil:!1,depth:!1,stencil:!1},o=r.framebuffer(s);return o.colorTex=i,o}Je(t){this.Ye.endFrame(t)&&!Object.keys(this.tilesLoading).length&&this.layer.fire("terrainreadyandrender")}We(t,e){const{image:n,info:r}=t,i=n.data,s=i.width,{extent2d:o,res:a}=r,{extent2d:l,res:h}=e,c=o.getWidth(),u=o.getHeight();let f=(l.xmin*h/a-o.xmin)/c*(s-1),d=(o.ymax-l.ymax*h/a)/u*(s-1);const p=(l.xmax*h/a-o.xmin)/c*(s-1);let A=Math.round(p-f);const g=Math.log2(A);A=Math.pow(2,Math.round(g))+1,f=Math.floor(f),d=Math.floor(d);const m=new Float32Array(A*A);let y=1/0,v=-1/0;for(let x=0;x<A;x++)for(let t=0;t<A;t++){let e=x+f,n=t+d;e>s-1?e=s-1:e<0&&(e=0),n>s-1?n=s-1:n<0&&(n=0);const r=i.data[e+n*s];m[x+t*A]=r,r<y&&(y=r),r>v&&(v=r)}return{width:A,height:A,data:m,min:y,max:v}}getTileOpacity(t){return this.xs(t)?super.getTileOpacity(t):(this.resetTileLoadTime(t),0)}xs(t){const e=this.layer.getSkinCount();if(!e)return!0;if(!t.skinStatus)return!1;for(let n=0;n<e;n++)if(!t.skinStatus[n])return!1;return!0}ps(t){const e=this.getMap().getZoom(),n=this.layer.getSkinLayers();for(let r=0;r<n.length;r++){const i=n[r]&&n[r].getRenderer();if(i){if(i.isAnimating&&i.isAnimating())return!0;if(i.needToRefreshTerrainTileOnZooming&&i.needToRefreshTerrainTileOnZooming()&&t!==e)return!0}}return!1}isValidCachedTile(t){const e=!t.image.skinStatus;return t.image&&!t.image.temp&&(e||this.xs(t.image))}isTileComplete(t){return t.image&&!t.image.temp&&this.xs(t.image)}ys(){const t=this.layer.options;return et(t.terrainWidth)?t.tileSize+1:t.terrainWidth}bs(t,e){const n=this.layer.options.maxAvailableZoom-this.layer.options.zoomOffset,r=t.z-n,i=Math.pow(2,r),s=Math.floor(t.x/i),o=Math.floor(t.y/i),a=Math.floor(t.idx/i),l=Math.floor(t.idy/i),h=fn(s,o);this.Ss||(this.Ss={});const c=!this.Ss[h];return c&&e&&(this.Ss[h]=new Set,this.Ss[h].url=this.layer.getTileUrl(s,o,n+this.layer.options.zoomOffset)),{x:s,y:o,idx:a,idy:l,requests:this.Ss[h],isFirst:c,key:h}}loadTile(t){const e=this.layer,n=this.ys(),r=e.getSpatialReference().getResolution(t.z);let i=this.getMap().pointAtResToDistance(1,1,r);const s=e.options.zoomOffset||0,o=e.options.maxAvailableZoom&&e.options.maxAvailableZoom-s;if(o&&t.z>o){const n=this.Ue(t);if(-1!==n.sourceZoom)return this.onTileLoad(n,t),n;{const{requests:r,isFirst:s,x:a,y:l,idx:h,idy:c}=this.bs(t,!0);if(r.add(t),!s)return n;const u=t.z-o;i*=Math.pow(2,u);const f=[a,l,o,h,c,t.res*Math.pow(2,u),t.error*Math.pow(2,u)];t=e.createTileNode?e.createTileNode(...f):e.Cs(...f)}}const l=t.url,h={},c=e.options,u={terrainWidth:n,type:c.type,accessToken:c.accessToken,cesiumIonTokenURL:c.cesiumIonTokenURL,error:i};return this.workerConn.fetchTerrain(l,u,(e,n)=>{if(this.Ss){const e=fn(t.x,t.y),n=this.Ss[e];if(n&&n.size){this.tileCache.add(t.id,{info:t,image:h});for(const t of n)this.removeTileLoading(t)}delete this.Ss[e]}if(e){if(e.canceled)return;return console.warn(e),void this.onTileError(h,t)}a["I"].extend(h,n),this.onTileLoad(h,t)}),h}deleteTile(t){if(!t||!t.image)return;super.deleteTile(t);const{info:e,image:n}=t;n.temp||(delete e.skinTileIds,this.hs(t.info,n))}hs(t,e){const n=e.skin;n&&(n.destroy(),n.colorTex.destroy(),delete n.colorTex),e.debugTexture&&(e.debugTexture.destroy(),delete e.debugTexture,e.skinDebugMesh.dispose(),delete e.skinDebugMesh);const r=e.skinImages;if(r&&r.length){let n=t.id;e.temp&&(n+="-temp");for(let t=0;t<r.length;t++){const e=r[t];if(e){for(let t=0;t<e.length;t++){if(!e[t]||!e[t].tile)continue;const r=e[t].tile.info.id,i=this.es&&this.es.get(r);i&&this.ds(i,n)}e.length=0}}}e.terrainMesh&&this.Ye.deleteMesh(e.terrainMesh),e.image&&e.image.close&&e.image.close(),delete e.skinImages,delete e.skin,delete e.skinStatus,delete e.skinTileIds,delete e.terrainMesh,delete e.image,delete e.data,delete e.mesh,delete e.rendered}ds(t,e,n){t&&(t.refs.delete(e),t.refs.size||(n?n.push(t):this.ss(t)))}ss(t){if(!t||!t.tile)return;const e=t.tile.info.id,n=t.layer.getRenderer();delete t.canvas,delete t.layer,t.refs.clear(),t.texture&&(n?n.deleteTerrainTexture(t.texture):t.texture.destroy&&t.texture.destroy(),delete t.texture),t.skinMesh&&(t.skinMesh.dispose(),delete t.skinMesh),n&&(n.removeTileCache&&n.removeTileCache(e),n.deleteTile&&n.constructor.prototype.deleteTile.call(n,t.tile)),delete t.tile,this.es.delete(e)}Ts(){if(!this.es)return;const t=this.es.keys();for(const e of t){const t=this.ls(e);this.ss(t)}this.es.clear()}abortTileLoading(t,e){const n=this.layer,r=n.options.maxAvailableZoom&&n.options.maxAvailableZoom-n.options.zoomOffset;if(e)if(r&&e.z>r){const{requests:t,key:n}=this.bs(e);t&&t.size&&(t.delete(e),t.size||(delete this.Ss[n],this.workerConn&&this.workerConn.abortTerrain(t.url)))}else e&&e.url&&this.workerConn&&this.workerConn.abortTerrain(e.url);super.abortTileLoading(t,e)}onTileError(t,e){super.onTileError(t,e)}ks(t){const e=this.getCurrentTileZoom(),n=this.layer.getSpatialReference().getResolution(e),r=this.layer._getTileConfig().getTileIndex(t,n,this.layer.options.repeatWorld);return r.z=e,r}As(t,e,n,r,i){const s=this.layer.getMinZoom(),o=this.Os(e,n.x,n.y,n.z,s);if(o&&o.image&&o.image.data){const e=o.info.extent2d,s=o.info.res/i,a=r.x-e.xmin*s,l=e.ymax*s-r.y,h=this.Is(o.image.data,a/(e.getWidth()*s),l/(e.getHeight()*s));t[0]=h,t[1]=null===h?0:+(o.info.z===n.z)}else t[0]=null,t[1]=0;return t}Os(t,e,n,r,i){t||(t=this.layer._getTileId(e,n,r));const s=this.tilesInView[t]||this.tileCache.get(t);return!s&&r-1>=i?this.Os(null,Math.floor(e/2),Math.floor(n/2),r-1,i):s}Is(t,e,n){const{width:r,height:i,data:s}=t,o=Math.floor((r-1)*e),a=Math.floor((i-1)*n)*r+o;return void 0===s[a]?null:s[a]}Es(t,e,n){t||(t={tiles:{},dirty:!0,complete:!1});const r=this.layer,i=this.getCurrentTileZoom(),s=r.getSpatialReference().getResolution(i),{xmin:o,ymin:a,xmax:l,ymax:h}=e,c=r._getTileConfig();en.set(o,a).Ls(n);const u=c._getTileNum(en,n,!0);nn.set(l,h).Ls(n);const f=c._getTileNum(nn,n,!0),d=Math.min(u.x,f.x),p=Math.max(u.x,f.x),A=Math.min(u.y,f.y),g=Math.max(u.y,f.y),m=n/s;en.set(o,a).Ls(m),nn.set(l,h).Ls(m);const y=rn.set(en.x,en.y,nn.x,nn.y),v=r.getTileSize().width+1;y.Fs(y.getWidth()/v),t.array=t.array||new Float32Array(v*v);const x=t.tiles;t.complete=!0,t.array.fill(0);for(let b=d;b<=p;b++)for(let e=A;e<=g;e++){const n=this.layer._getTileId(b,e,i);if(x[n])continue;const r=this.tileCache.get(n);r?(this.Rs(t.array,r,y,v),t.dirty=!0,x[n]=1):(t.dirty=t.dirty||void 0!==t.tiles[n],t.tiles[n]&&delete t.tiles[n],t.complete=!1)}return t}Rs(t,e,n,r){const i=e.info.extent2d,s=i.intersection(n),{xmin:o,ymin:a,xmax:l,ymax:h}=s,{data:c}=e.image,u=c.width,f=n.getWidth()/r,d=Math.floor((o-n.xmin)/f),p=Math.floor((a-n.ymin)/f),A=Math.floor((l-n.xmin)/f)-d,g=Math.floor((h-n.ymin)/f)-p,m=i.getWidth()/u,y=Math.floor((o-i.xmin)/m),v=Math.floor((a-i.ymin)/m),x=Math.floor(f/m);for(let b=0;b<=A;b++)for(let e=0;e<=g;e++){const n=b+d+(p+e)*r;let i=0;for(let t=0;t<x;t++)for(let n=0;n<x;n++){const r=(y+Math.floor(b*x))*u+t+v+Math.floor(e*x)+n;i+=c.data[r]}t[n]=i/Math.max(x,1)}return t}clear(){return this.clearTempResources(),super.clear()}clearTempResources(){this.rs&&(this.rs.reset(),delete this.rs),this.es&&this.Ts()}onAdd(){super.onAdd(),this.prepareWorker()}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),t=>{if(t)throw t}),this.workerConn.remove(),delete this.workerConn),this.clearTempResources(),this.Ms&&(this.Ms.dispose(),delete this.Ms),this.vs&&(this.vs.dispose(),delete this.vs),delete this.Ss,super.onRemove(),this.Ye&&(this.Ye.delete(),delete this.Ye)}prepareWorker(){const t=this.layer.getMap();this.workerConn||(this.workerConn=new Te(t.id));const e=this.workerConn;if(!e.isActive())return;const n=this.layer.options||{},r=this.layer.getId();e.addLayer(r,n,t=>{if(t)throw t;this.layer&&(this.ready=!0,this.setToRedraw(),this.layer.fire("workerready"))})}createContext(){this.canvas.gl&&this.canvas.gl.wrap?(this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl):this.Ps(),this.renderer=new s["Renderer"](this.regl),this.layer.fire("contextcreate",{regl:this.regl})}Xe(){const t=this.Ye;"lit"===this.layer.options.shader||"pbr"===this.layer.options.shader?(t&&t.constructor===Ue||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this.Ye=new Xe(this.layer),this.layer.fire("paintercreated")):(t&&t.constructor===Xe||!t)&&(t&&(t.delete(),this.clear(),this.setToRedraw()),this.Ye=new Ue(this.layer),this.layer.fire("paintercreated"))}Ps(){const t=this.layer,e=t.options.glOptions||{alpha:!0,depth:!0,antialias:this.layer.options.antialias};e.preserveDrawingBuffer=!0,e.stencil=!0,this.glOptions=e,this.gl=this.gl||this.Ds(this.canvas,e),this.regl=Object(r["createREGL"])({gl:this.gl,attributes:e,extensions:["OES_element_index_uint"],optionalExtensions:t.options.glExtensions})}Ds(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}resizeCanvas(t){this.canvas&&super.resizeCanvas(t)}clearCanvas(){this.canvas&&super.clearCanvas()}ms(){if(this.Ms)return;const t=this.layer.getTileSize().width;this.Ms=new s["MeshShader"]({vert:"#define SHADER_NAME TERRAIN_SKIN\nattribute vec2 aPosition;\nvoid main() {\n    gl_Position = vec4(aPosition, 0.0, 1.0);\n}",frag:"#define SHADER_NAME TERRAIN_SKIN\nprecision mediump float;\nuniform float tileSize;\nuniform sampler2D skinTexture;\nuniform vec3 skinDim;\nuniform float opacity;\nvoid main() {\n    vec2 fragCoord = gl_FragCoord.xy / 2.0;\n    vec2 resolution = vec2(tileSize);\n    vec2 uv = (fragCoord - skinDim.xy) /  (resolution * skinDim.z);\n    if (uv.x >= 0.0 && uv.x <= 1.0 && uv.y >= 0.0 && uv.y <= 1.0) {\n        gl_FragColor = texture2D(skinTexture, uv) * opacity;\n    } else {\n        gl_FragColor = vec4(0.0);\n    }\n}",extraCommandProps:{cull:{enable:!1},viewport:{x:0,y:0,width:2*t,height:2*t},depth:{enable:!1},stencil:{enable:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}});const e=new Int8Array([-1,-1,1,1,-1,1,1,1,-1,-1,1,-1]);this.vs=this.vs||new s["Geometry"]({aPosition:e},0,6,{positionSize:2}),this.vs.generateBuffers(this.regl),this._s=this._s||new s["Scene"]}updateMaterial(t){this.Ye&&t&&this.Ye.updateMaterial&&(void 0===this.Ne&&(this.Ne=1),this.Ye.updateMaterial(t,this.Ne++))}setMaterial(t){this.Ye&&t&&this.Ye.setMaterial&&(void 0===this.Ne&&(this.Ne=1),this.Ye.setMaterial(t,this.Ne++))}getAnalysisMeshes(){return this.Ye&&this.Ye.Ae?this.Ye.Ae.getMeshes():[]}}const hn=1;function cn(t,e,n,r,i,s,o,a,l=0){t.font="20px monospace",t.fillStyle=n,on.y=a-30,t.globalAlpha=1,t.fillText(e,on.x+i,on.y+s+l),t.globalAlpha=.6,t.strokeStyle=n,t.lineWidth=r,t.beginPath(),t.moveTo(i,s),t.lineTo(i+o,s),t.lineTo(i+o,s+a),t.lineTo(i,s+a),t.lineTo(i,s),t.stroke(),t.globalAlpha=1}function un(t,e,n){const{res:r,extent2d:i,offset:s}=t,{info:o}=e,a=o.res/r,l=o.offset,h=o.extent2d.xmin*a,c=o.extent2d.ymin*a,u=s[0]-l[0],f=l[1]-s[1];return[h-i.xmin+u,-(i.ymin-c+f),a*o.tileSize/n]}function fn(t,e){return t+"-"+e}a["P"].TileLayerCanvasRenderer.include({renderTerrainSkin(t,e,n){const r=this.layer.getTileSize().width,i=e.options.debug;for(let s=0;s<n.length;s++){const{tile:t,texture:e}=n[s];if(!t.image)continue;const o=document.createElement("canvas");n[s].canvas=o,o.width=r,o.height=r;const a=o.getContext("2d");if(a.drawImage(t.image,0,0),i){const{x:e,y:n,z:i}=t.info;cn(a,`${e}/${n}/${i}`,"yellow",1,0,0,r,r,-18)}e({data:o,width:r,height:r,flipY:!0,min:"linear mipmap linear",mag:"linear"})}},createTerrainTexture(t){const e=this.layer.getTileSize().width,n={width:e,height:e,flipY:!0,min:"linear mipmap linear",mag:"linear",depthStencil:!1,depth:!1,stencil:!1};return t.texture(n)},deleteTerrainTexture(t){t.destroy()}});var dn={exports:{}};function pn(t,e,n){n=n||2;var r,i,s,o,a,l,h,c=e&&e.length,u=c?e[0]*n:t.length,f=An(t,0,u,n,!0),d=[];if(!f||f.next===f.prev)return d;if(c&&(f=function(t,e,n,r){var i,s,o,a,l,h=[];for(i=0,s=e.length;i<s;i++)o=e[i]*r,a=i<s-1?e[i+1]*r:t.length,(l=An(t,o,a,r,!1))===l.next&&(l.steiner=!0),h.push(Sn(l));for(h.sort(wn),i=0;i<h.length;i++)n=_n(h[i],n);return n}(t,e,f,n)),t.length>80*n){r=s=t[0],i=o=t[1];for(var p=n;p<u;p+=n)(a=t[p])<r&&(r=a),(l=t[p+1])<i&&(i=l),a>s&&(s=a),l>o&&(o=l);h=0!==(h=Math.max(s-r,o-i))?32767/h:0}return mn(f,d,n,r,i,h,0),d}function An(t,e,n,r,i){var s,o;if(i===Bn(t,e,n,r)>0)for(s=e;s<n;s+=r)o=Fn(s,t[s],t[s+1],o);else for(s=n-r;s>=e;s-=r)o=Fn(s,t[s],t[s+1],o);return o&&En(o,o.next)&&(Ln(o),o=o.next),o}function gn(t,e){if(!t)return t;e||(e=t);var n,r=t;do{if(n=!1,r.steiner||!En(r,r.next)&&0!==On(r.prev,r,r.next))r=r.next;else{if(Ln(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function mn(t,e,n,r,i,s,o){if(t){!o&&s&&function(t,e,n,r){var i=t;do{0===i.z&&(i.z=Tn(i.x,i.y,e,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==t);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e,n,r,i,s,o,a,l,h=1;do{for(n=t,t=null,s=null,o=0;n;){for(o++,r=n,a=0,e=0;e<h&&(a++,r=r.nextZ);e++);for(l=h;a>0||l>0&&r;)0!==a&&(0===l||!r||n.z<=r.z)?(i=n,n=n.nextZ,a--):(i=r,r=r.nextZ,l--),s?s.nextZ=i:t=i,i.prevZ=s,s=i;n=r}s.nextZ=null,h*=2}while(o>1)}(i)}(t,r,i,s);for(var a,l,h=t;t.prev!==t.next;)if(a=t.prev,l=t.next,s?vn(t,r,i,s):yn(t))e.push(a.i/n|0),e.push(t.i/n|0),e.push(l.i/n|0),Ln(t),t=l.next,h=l.next;else if((t=l)===h){o?1===o?mn(t=xn(gn(t),e,n),e,n,r,i,s,2):2===o&&bn(t,e,n,r,i,s):mn(gn(t),e,n,r,i,s,1);break}}}function yn(t){var e=t.prev,n=t,r=t.next;if(On(e,n,r)>=0)return!1;for(var i=e.x,s=n.x,o=r.x,a=e.y,l=n.y,h=r.y,c=i<s?i<o?i:o:s<o?s:o,u=a<l?a<h?a:h:l<h?l:h,f=i>s?i>o?i:o:s>o?s:o,d=a>l?a>h?a:h:l>h?l:h,p=r.next;p!==e;){if(p.x>=c&&p.x<=f&&p.y>=u&&p.y<=d&&In(i,a,s,l,o,h,p.x,p.y)&&On(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function vn(t,e,n,r){var i=t.prev,s=t,o=t.next;if(On(i,s,o)>=0)return!1;for(var a=i.x,l=s.x,h=o.x,c=i.y,u=s.y,f=o.y,d=a<l?a<h?a:h:l<h?l:h,p=c<u?c<f?c:f:u<f?u:f,A=a>l?a>h?a:h:l>h?l:h,g=c>u?c>f?c:f:u>f?u:f,m=Tn(d,p,e,n,r),y=Tn(A,g,e,n,r),v=t.prevZ,x=t.nextZ;v&&v.z>=m&&x&&x.z<=y;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&In(a,c,l,u,h,f,v.x,v.y)&&On(v.prev,v,v.next)>=0)return!1;if(v=v.prevZ,x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&In(a,c,l,u,h,f,x.x,x.y)&&On(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(;v&&v.z>=m;){if(v.x>=d&&v.x<=A&&v.y>=p&&v.y<=g&&v!==i&&v!==o&&In(a,c,l,u,h,f,v.x,v.y)&&On(v.prev,v,v.next)>=0)return!1;v=v.prevZ}for(;x&&x.z<=y;){if(x.x>=d&&x.x<=A&&x.y>=p&&x.y<=g&&x!==i&&x!==o&&In(a,c,l,u,h,f,x.x,x.y)&&On(x.prev,x,x.next)>=0)return!1;x=x.nextZ}return!0}function xn(t,e,n){var r=t;do{var i=r.prev,s=r.next.next;!En(i,s)&&Pn(i,r,r.next,s)&&Nn(i,s)&&Nn(s,i)&&(e.push(i.i/n|0),e.push(r.i/n|0),e.push(s.i/n|0),Ln(r),Ln(r.next),r=t=s),r=r.next}while(r!==t);return gn(r)}function bn(t,e,n,r,i,s){var o=t;do{for(var a=o.next.next;a!==o.prev;){if(o.i!==a.i&&Cn(o,a)){var l=Dn(o,a);return o=gn(o,o.next),l=gn(l,l.next),mn(o,e,n,r,i,s,0),void mn(l,e,n,r,i,s,0)}a=a.next}o=o.next}while(o!==t)}function wn(t,e){return t.x-e.x}function _n(t,e){var n=function(t,e){var n,r=e,i=t.x,s=t.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var a=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=i&&a>o&&(o=a,n=r.x<r.next.x?r:r.next,a===i))return n}r=r.next}while(r!==e);if(!n)return null;var l,h=n,c=n.x,u=n.y,f=1/0;r=n;do{i>=r.x&&r.x>=c&&i!==r.x&&In(s<u?i:o,s,c,u,s<u?o:i,s,r.x,r.y)&&(l=Math.abs(s-r.y)/(i-r.x),Nn(r,t)&&(l<f||l===f&&(r.x>n.x||r.x===n.x&&Mn(n,r)))&&(n=r,f=l)),r=r.next}while(r!==h);return n}(t,e);if(!n)return e;var r=Dn(n,t);return gn(r,r.next),gn(n,n.next)}function Mn(t,e){return On(t.prev,t,e.prev)<0&&On(e.next,t,t.next)<0}function Tn(t,e,n,r,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-n)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-r)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Sn(t){var e=t,n=t;do{(e.x<n.x||e.x===n.x&&e.y<n.y)&&(n=e),e=e.next}while(e!==t);return n}function In(t,e,n,r,i,s,o,a){return(i-o)*(e-a)>=(t-o)*(s-a)&&(t-o)*(r-a)>=(n-o)*(e-a)&&(n-o)*(s-a)>=(i-o)*(r-a)}function Cn(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var n=t;do{if(n.i!==t.i&&n.next.i!==t.i&&n.i!==e.i&&n.next.i!==e.i&&Pn(n,n.next,t,e))return!0;n=n.next}while(n!==t);return!1}(t,e)&&(Nn(t,e)&&Nn(e,t)&&function(t,e){var n=t,r=!1,i=(t.x+e.x)/2,s=(t.y+e.y)/2;do{n.y>s!=n.next.y>s&&n.next.y!==n.y&&i<(n.next.x-n.x)*(s-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==t);return r}(t,e)&&(On(t.prev,t,e.prev)||On(t,e.prev,e))||En(t,e)&&On(t.prev,t,t.next)>0&&On(e.prev,e,e.next)>0)}function On(t,e,n){return(e.y-t.y)*(n.x-e.x)-(e.x-t.x)*(n.y-e.y)}function En(t,e){return t.x===e.x&&t.y===e.y}function Pn(t,e,n,r){var i=Rn(On(t,e,n)),s=Rn(On(t,e,r)),o=Rn(On(n,r,t)),a=Rn(On(n,r,e));return i!==s&&o!==a||!(0!==i||!kn(t,n,e))||!(0!==s||!kn(t,r,e))||!(0!==o||!kn(n,t,r))||!(0!==a||!kn(n,e,r))}function kn(t,e,n){return e.x<=Math.max(t.x,n.x)&&e.x>=Math.min(t.x,n.x)&&e.y<=Math.max(t.y,n.y)&&e.y>=Math.min(t.y,n.y)}function Rn(t){return t>0?1:t<0?-1:0}function Nn(t,e){return On(t.prev,t,t.next)<0?On(t,e,t.next)>=0&&On(t,t.prev,e)>=0:On(t,e,t.prev)<0||On(t,t.next,e)<0}function Dn(t,e){var n=new zn(t.i,t.x,t.y),r=new zn(e.i,e.x,e.y),i=t.next,s=e.prev;return t.next=e,e.prev=t,n.next=i,i.prev=n,r.next=n,n.prev=r,s.next=r,r.prev=s,r}function Fn(t,e,n,r){var i=new zn(t,e,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function Ln(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function zn(t,e,n){this.i=t,this.x=e,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function Bn(t,e,n,r){for(var i=0,s=e,o=n-r;s<n;s+=r)i+=(t[o]-t[s])*(t[s+1]+t[o+1]),o=s;return i}dn.exports=pn,dn.exports.default=pn,pn.deviation=function(t,e,n,r){var i=e&&e.length,s=i?e[0]*n:t.length,o=Math.abs(Bn(t,0,s,n));if(i)for(var a=0,l=e.length;a<l;a++){var h=e[a]*n,c=a<l-1?e[a+1]*n:t.length;o-=Math.abs(Bn(t,h,c,n))}var u=0;for(a=0;a<r.length;a+=3){var f=r[a]*n,d=r[a+1]*n,p=r[a+2]*n;u+=Math.abs((t[f]-t[p])*(t[d+1]-t[f+1])-(t[f]-t[d])*(t[p+1]-t[f+1]))}return 0===o&&0===u?0:Math.abs((u-o)/o)},pn.flatten=function(t){for(var e=t[0][0].length,n={vertices:[],holes:[],dimensions:e},r=0,i=0;i<t.length;i++){for(var s=0;s<t[i].length;s++)for(var o=0;o<e;o++)n.vertices.push(t[i][s][o]);i>0&&(r+=t[i-1].length,n.holes.push(r))}return n};var Hn=dn.exports;const Un={"clip-inside":.1,"clip-outside":.2,"flat-inside":.3,"flat-outside":.4,color:.5,video:.6,elevate:.7},jn=[],Vn=[1,1,1],Gn={polygonFill:[255,0,0],polygonOpacity:.8},qn=new a["f"](0,0),Wn=new a["f"](0,0),Xn=[],Qn=new a["f"](0,0),Yn=new a["A"](0,0),Zn=new a["A"](0,0),Kn=new a["A"](0,0);class Jn extends a["C"]{getMode(){return this.Hs}remove(){const t=this.getLayer();return t?(t.removeMask(this),this.Ns(),super.remove(),this):this}getMesh(t,e,n){return this.isVisible()?(this.xt||(this.xt=this.ze(t,e,n)),this.Gs(this.xt,e,n),this.xt):null}js(t){const e=this.getMap(),n=this.toGeoJSON(),r=Hn.flatten(n.geometry.coordinates);for(let s=0;s<r.vertices.length;s+=2){Qn.x=r.vertices[s],Qn.y=r.vertices[s+1];const t=ct(e,Qn);r.vertices[s]=t[0],r.vertices[s+1]=t[1]}const i=ct(e,this.getCenter()),o=[],a="video"===this.getMode()?4:r.vertices.length/2;for(let s=0;s<a;s++)o.push(r.vertices[2*s]-i[0]),o.push(r.vertices[2*s+1]-i[1]),o.push(0);const l=Hn(o,r.holes,3),h=new s["Geometry"]({POSITION:o,TEXCOORD:this.Bs(r.vertices)},l,0,{positionAttribute:"POSITION",uv0Attribute:"TEXCOORD"});return h.generateBuffers(t),h}Bs(t){const e=[0,0,1,0,1,1,0,1];if(this.hasHoles())for(let n=e.length/2-1;n<t.length;n+=2)e[n]=e[n+1]=0;return e}Us(){this.Ns(),delete this.xt}zs(){return Un[this.Hs]}Vs(){const t=this.getSymbol(),{polygonFill:e,polygonOpacity:n}=t||Gn,r=lt([],e);return r[0]/=255,r[1]/=255,r[2]/=255,r[3]=nt(n)?n:Gn.polygonOpacity,r}Ws(t=0){const e=this.getMap(),n=e.getGLRes();return e.altitudeToPoint(t,n)}qs(t){const e=ct(this.getMap(),this.getCenter()),n=o["c"].fromRotationTranslationScale(t.localTransform,o["d"].identity(jn),e,Vn);t.localTransform=n}Ns(){this.xt&&(this.xt.material&&this.xt.material.dispose(),this.xt.geometry&&this.xt.geometry.dispose(),this.xt.dispose(),delete this.xt)}containsPoint(t){const e=this.getExtent();if(Qn.x=t[0],Qn.y=t[1],!e.contains(Qn))return!1;const n=this.getHoles();for(let i=0;i<n.length;i++)if(this.$s(n[i],t))return!1;const r=this.getShell();return this.$s(r,t)}$s(t,e){const n=this.Ys(t);let r=0;for(let i=0;i<t.length;i++){qn.x=t[i].x,qn.y=t[i].y;const n=i+1>=t.length?0:i+1;Wn.x=t[n].x,Wn.y=t[n].y,Qn.x=e[0],Qn.y=e[1],Xn[0]=Qn,Xn[1]=qn,Xn[2]=Wn,r+=this.Ys(Xn)}return!(Math.abs(r-n)>1e-8)}Ys(t){const e=this.getMap();let n=0;const r=e.getGLRes(),i=e.coordToPointAtRes(t[0],r,Yn);for(let l=1;l<t.length-1;l++){const h=e.coordToPointAtRes(t[l],r,Zn),c=e.coordToPointAtRes(t[l+1],r,Kn);n+=Math.abs((s=i,a=c,((o=h).x-s.x)*(a.y-s.y)-(o.y-s.y)*(a.x-s.x)))/2}var s,o,a;return n}}const $n=["shapechange","heightrangechange","flatheightchange"],tr=new a["f"](0,0),er=[],nr=[];function rr(){return this._maskList?(this._maskList.forEach(t=>{t.remove()}),this._maskList=[],this.updateExtent("shapechange"),this):this}function ir(t){const e=this.getMap(),n=e.getView(),r=e.getFitZoom(t),i=t.getCenter();e.setView({center:i,zoom:r,pitch:0,bearing:0});const s=e.getExtent(),a=o["c"].copy([],e.projViewMatrix);return e.setView(n),{mapExtent:s,projViewMatrix:a}}function sr(){for(let t=0;t<this._maskList.length;t++)if(this._maskList[t].isVisible())return!0;return!1}function or(t){return class extends t{removeMask(t){if(!this._maskList)return this;if(!t)return rr.call(this),this;const e=Array.isArray(t)?t:[t];for(let n=0;n<e.length;n++){const t=e[n],r=this._maskList.indexOf(t);r>-1&&this._maskList.splice(r,1)}return this.updateExtent("shapechange"),this}setMask(t){return this.removeMask(),this._maskList||(this._maskList=[]),Array.isArray(t)?t.forEach(t=>{this._maskList.push(t)}):this._maskList.push(t),this._maskList.forEach(t=>{t._bindLayer(this),t.Xs&&t.Xs()}),this.updateExtent("shapechange"),this}onAdd(){super.onAdd(),this.updateExtent("shapechange")}getMasks(){return this._maskList||[]}_onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;"shapechange"===e&&t.target instanceof Jn&&t.target.Us(),t.target instanceof Jn&&$n.indexOf(e)>-1&&this.updateExtent(e),super._onGeometryEvent&&super._onGeometryEvent(t)}identifyMask(t,e){if(!this.getMap())return[];if(!this._maskList||!this._maskList.length)return[];const n=tt({},e);n.excludeMasks=!0;const r=this.identifyAtPoint(t,n),i=r.length&&r[0].coordinate;return i?this._hitMasks(i):[]}_hitMasks(t){const e=this._maskList;if(!e)return[];const n=[];for(let r=0;r<e.length;r++){const i=e[r].getMode();!e[r].containsPoint(t)||"color"!==i&&"video"!==i||n.push(e[r])}return n}remove(){this._maskList&&this._maskList.length&&this._maskList.forEach(t=>{t.remove()}),super.remove()}updateMask(t){const e=this.getMap(),{projViewMatrix:n,mapExtent:r}=ir.call(this,t);tr.x=r.xmin,tr.y=r.ymin;const i=ar(er,tr,e);tr.x=r.xmax,tr.y=r.ymax;const s=ar(nr,tr,e);return{projViewMatrix:n,extentInWorld:[i[0],i[1],s[0],s[1]]}}updateExtent(t){if(!this._maskList)return;if(!this.getMap())return;const e=this.getRenderer();if(e&&!this._maskList.length)return void e._clearMask();if(e&&!sr.call(this))return e._deleteMaskUniforms(),void e.setToRedraw();const n=this.getMaskExtent();if(!n)return;const{extent:r,ratio:i,minHeight:s}=n;if(t||!this._projViewMatrix||!this._projViewMatrix){const{projViewMatrix:t,extentInWorld:e}=this.updateMask(r);this._projViewMatrix=t,this.Js=e}e?e.setMask(this.Js,this._projViewMatrix,i,s):this.once("renderercreate",t=>{t.renderer.setMask(this.Js,this._projViewMatrix,i,s)})}getMaskExtent(){let t=1/0,e=1/0,n=-1/0,r=-1/0,i=-1/0,s=1/0,o=!1;for(let a=0;a<this._maskList.length;a++){const l=this._maskList[a];if(!l.isVisible())continue;const h=l.getExtent();if(h&&this.Zs(h)&&(o=!0,h.xmin<t&&(t=h.xmin),h.ymin<e&&(e=h.ymin),h.xmax>n&&(n=h.xmax),h.ymax>r&&(r=h.ymax),l.Ks)){const t=l.Ks();t[0]<s&&(s=t[0]),t[1]>i&&(i=t[1])}}if(!o)return null;const{ratio:l,minHeight:h}=function(t,e){const n=t===1/0?0:t,r=e===-1/0?0:e,i=Math.abs(r-n);return 0===i?{ratio:1,minHeight:0}:{ratio:Math.pow(i,-1),minHeight:n}}(s,i);return{extent:new a["k"](t,e,n,r),ratio:l,minHeight:h}}Zs(t){return this.getMap().getExtent().intersects(t)}}}function ar(t,e,n,r=0){if(!(n&&e instanceof a["f"]))return null;const i=n.coordinateToPointAtRes(e,n.getGLRes());return t[0]=i.x,t[1]=i.y,t[2]=r,t}const lr=new a["f"](0,0),hr=new a["f"](0,0),cr=new a["A"](0,0),ur=[],fr={tileGrids:[],count:0},dr="01",pr="1";class Ar extends(or(a["H"])){constructor(t,e){e&&!e.tileSystem&&("cesium"===e.type||"cesium-ion"===e.type?e.tileSystem=[1,1,-180,-90]:"tianditu"===e.type&&(e.tileSystem=[1,-1,-180,90])),super(t,e)}getTileUrl(t,e,n){let r=super.getTileUrl(t,e,n);return"mapbox"===this.options.type&&this.options.requireSkuToken&&(this.Qs||(this.Qs=this.tn()),r.indexOf("?")>-1?r+="&sku="+this.Qs:r+="?sku="+this.Qs),r}getMaxAvailableZoom(){return this.getSpatialReference().getMaxZoom()}tn(){let t="";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return[pr,dr,t].join("")}setSkinLayers(t){this.in=t;const e=this.getRenderer();e&&(e.clear(),e.setToRedraw())}getSkinTiles(t){const e=this.getRenderer();if(!e)return fr;const n=e.getTileGridsInCurrentFrame().tileGrids[0];if(!n)return fr;const r=t.getId(),i=this._getTileConfig().tileSystem.scale,s=t.getTileSize().width,o=n.tiles;if(!o.length)return fr;const l=this.getMap(),h=n.parents||ur,c=h.length,u=h.concat(o),f=t.getSpatialReference(),d=o[0].extent2d.getWidth(),p=i.x,A=i.y,g=[],m=[],y=new Set,v=this._getTileConfig().tileSystem.scale.y;for(let x=0;x<u.length;x++){const e=u[x],{res:n}=e;let i=e.nw;i||(i=e.nw=l.pointAtResToCoord(e.extent2d.getMin(cr),e.res));const{res:o,zoom:h}=Ne(f,e.z,n),b=o/n,w=Re(o,s,n,d),{extent2d:_,offset:M}=e,T=w*e.x,S=w*e.y;if(e.skinTileIds||(e.skinTileIds={}),!e.skinTileIds[r]){const n=new Set,l=[],c=ke(t,e.x,e.y,h,i,M,A,w,0);for(let e=0;e<c.length;e++){const r=c[e];if(n.has(r.id))continue;r.idx=r.x,r.idy=r.y,r.res=o,r.url=t.getTileUrl(r.x,r.y,r.z+t.options.zoomOffset);const i=p*(r.x-T)*s,h=A*(r.skinY-S)*s,u=_.xmin*b+i,f=_.ymax*b+h,d=_.ymin*b+h;r.extent2d=v>0?new a["B"](u,d,u+s,d+s):new a["B"](u,f-s,u+s,f),n.add(r.id),l.push(r)}e.skinTileIds[r]=l}const I=e.skinTileIds[r];for(let t=0;t<I.length;t++)y.has(I[t].id)||(x<c?g.push(I[t]):m.push(I[t]),y.add(I[t].id))}return{tileGrids:[{extent:n.extent,tiles:m,parents:g,count:m.length}],count:m.length}}getSkinLayer(t){return this.getSkinLayers()[t]}getSkinLayers(){return this.in||ur}getSkinCount(){return this.in&&this.in.length||0}queryTerrainByProjCoord(t,e){e=e||[];const n=this.getRenderer();if(!n)return e[0]=null,e[1]=0,e;const r=this.getMap(),i=n.ks(t);if(!i)return e[0]=null,e[1]=0,e;const s=r._prjToPointAtRes(t,1,cr);return n.As(e,i.id,i,s,1)}queryTileTerrainByProjCoord(t,e,n,r){r=r||[];const i=this.getRenderer();if(!i)return r[0]=null,r[1]=0,r;const s=this.getMap()._prjToPointAtRes(t,1,cr);return i.As(r,e,n,s,1)}queryTileTerrainByPointAtRes(t,e,n,r,i){i=i||[];const s=this.getRenderer();return s?s.As(i,n,r,t,e):(i[0]=null,i[1]=0,i)}queryTerrain(t,e){if(e=e||[],!this.getRenderer())return e[0]=null,e[1]=0,e;const n=this.getMap().getProjection().project(t,lr);return this.queryTerrainByProjCoord(n,e)}queryTileMesh(t,e){const n=this.getRenderer();n&&n.en(t,e)}getTerrainTiles(t){const{x:e,y:n,z:r,res:i,offset:s}=t,o=t.extent2d.getWidth(),l=this._getTileConfig(),h=this.getSpatialReference(),{res:c,zoom:u}=Ne(h,r,i),f=this.getTileSize().width,d=Re(c,f,i,o);let p=t.nw;p||(p=t.nw=this.getMap().pointAtResToCoord(t.extent2d.getMin(cr),t.res));const A=Ee(this,e,n,u,p,s,l.tileSystem.scale.y,d,1)[0];for(let g=0;g<A.length;g++){const{x:t,y:e}=A[g],n=l.getTilePointNW(t,e,c,cr);A[g].res=c,A[g].extent2d=new a["B"](n.x,n.y,n.x+f,n.y-f)}return A}isTerrainTileLoaded(t){const e=this.getRenderer();return!!e&&e.isTileCached(t)}updateMaterial(t){if(!t)return;this.options.material||(this.options.material={}),tt(this.options.material,t);const e=this.getRenderer();e&&e.updateMaterial(t)}setMaterial(t){if(!t)return;this.options.material=t;const e=this.getRenderer();e&&e.setMaterial(t)}Cs(t,e,n,r,i,s,o,a,l,h){const c=this.getMap(),u=this.options.zoomOffset;l||(l=this._getTileConfig().getTilePrjExtent(t,e,s).convertTo(t=>c._prjToPointAtRes(t,s,hr)));const f=this._getTileOffset(n);return{parent:a,layer:this.getId(),x:t,y:e,z:n,idx:r,idy:i,res:s,extent2d:l,id:h||this._getTileId(t,e,n),url:this.getTileUrl(t,e,n+u),offset:f,error:o,children:[]}}}Ar.mergeOptions({forceRenderOnMoving:!0,forceRenderOnZooming:!0,forceRenderOnRotating:!0,fadeAnimation:!1,fadeDuration:1e3/60*15,tileLimitPerFrame:2,newTerrainTileRenderLimitPerFrameOnInteracting:1,opacity:1,renderer:"gl",pyramidMode:1,tileSize:256,terrainWidth:65,backZoomOffset:0,depthMask:!0,blendSrc:"one",blendDst:"one minus src alpha",requireSkuToken:!0,cesiumIonTokenURL:"https://api.cesium.com/v1/assets/1/endpoint?access_token=",tileRetryCount:0,shader:"default",terrainTileMode:!0,tempTileCacheSize:64,tileStackStartDepth:7,tileStackDepth:6,currentTilesFirst:!1}),Ar.registerJSONType("TerrainLayer"),Ar.registerRenderer("gl",ln);const gr=[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],mr=[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],yr=[],vr=[],xr=[],br=[],wr=[],_r=[],Mr=[],Tr=[],Sr=new a["A"](0,0),Ir=[],Cr=[],Or=[],Er=[],Pr=[],kr=[],Rr=[],Nr=[],Dr=[],Fr=[],Lr=[];class zr{constructor(t,e,n={}){this.setFromPoint(t),this.setToPoint(e),this.sn=n,this.nn={},this.rn=0}setFromPoint(t){this.hn=this.an(t),this.cn()}setToPoint(t){this.ln=this.an(t),this.cn()}setOptions(t){this.sn=t}cn(){this.nn={},this.rn++}test(t,e){const n=[];for(let r=0;r<t.length;r++){const i=t[r],s=i.uuid+"-"+i.version+"-"+i.geometry.version+"-"+this.rn;if(this.nn[s]){n.push(this.nn[s]);continue}if(!this.un(i.getBoundingBox(),e))continue;const a=i.localTransform,l=i.geometry,h=l.data[l.desc.positionAttribute].array,c=l.data[l.desc.altitudeAttribute]&&l.data[l.desc.altitudeAttribute].array||Ir,u=l.indices;if(!h||!u){console.warn("there are no POSITION or inidces in mesh");continue}const f=o["c"].multiply(Er,a,i.positionMatrix),d=this.dn(i,e,h,c,u,l.desc.positionSize,f);if(d){const t={mesh:i,coordinates:d};n.push(t),this.nn[s]=t}}return n}dn(t,e,n,r,i,s,a){const l=Hr(e,this.hn.x,this.hn.y,this.hn.z),h=Hr(e,this.ln.x,this.ln.y,this.ln.z),c=o["e"].set(xr,l,h),u=[];for(let f=0;f<i.length&&!(f>t.properties.skirtOffset);f+=3){const t=i[f],l=i[f+1],h=i[f+2],d=o["f"].set(Pr,n[t*s],n[t*s+1],n[t*s+2]),p=this.pn(_r,e,d,r[t]/100,a),A=o["f"].set(kr,n[l*s],n[l*s+1],n[l*s+2]),g=this.pn(Mr,e,A,r[l]/100,a),m=o["f"].set(Rr,n[h*s],n[h*s+1],n[h*s+2]),y=this.pn(Tr,e,m,r[h]/100,a),v=o["f"].set(vr,p,g,y),x=o["f"].sub(Cr,p,g),b=o["f"].sub(Or,p,y),w=this.gn(Lr,v,c);if(w){if(!w[0]||!w[1])continue;const n=e.pointAtResToAltitude(w[2],e.getGLRes());Sr.x=w[0],Sr.y=w[1];const r=e.pointAtResToCoordinate(Sr,e.getGLRes());r.z=n,u.push({coordinate:r,indices:[t,l,h],normal:o["f"].cross([],x,b)})}}return u.length?u:null}pn(t,e,n,r,i){let s;return a["I"].isNumber(r)?(s=e.altitudeToPoint(r,e.getGLRes()),o["g"].set(t,n[0],n[1],0,1),o["g"].transformMat4(t,t,i),t[2]=s):(s=n[2],o["g"].set(t,n[0],n[1],s,1),o["g"].transformMat4(t,t,i)),t}gn(t,e,n){const r=e[0],i=e[1],s=e[2],a=n[0],l=n[1],h=a[0],c=a[1],u=a[2],f=l[0]-a[0],d=l[1]-a[1],p=l[2]-a[2];let A=0,g=0,m=0;r[0]===i[0]&&r[0]===s[0]?A=1:r[1]===i[1]&&r[1]===s[1]?g=1:r[2]===i[2]&&r[2]===s[2]?m=1:(A=(e[2][1]-e[0][1])*(e[2][2]-e[0][2])-(e[1][2]-e[0][2])*(e[2][1]-e[0][1]),g=(e[2][0]-e[0][0])*(e[1][2]-e[0][2])-(e[1][0]-e[0][0])*(e[2][2]-e[0][2]),m=(e[1][0]-e[0][0])*(e[2][1]-e[0][1])-(e[2][0]-e[0][0])*(e[1][1]-e[0][1]));const y=-(A*e[0][0]+g*e[0][1]+m*e[0][2]),v=A*f+g*d+m*p;if(0===v)return null;const x=-(A*h+g*c+m*u+y)/v,b=f*x+h,w=d*x+c,_=p*x+u,M=o["f"].set(br,b,w,_);return this.mn(e,M)&&(this.sn.allowPointNotOnLine||this.vn(n,M))?o["f"].set(t,b,w,_):null}mn(t,e){const n=this.sn.tolerance||1;if(!this.wn(t,e))return!1;const r=t[0],i=t[1],s=t[2],o=e;r[2]=i[2]=s[2]=o[2]=0;const a=this.Ys(r,i,s),l=this.Ys(o,r,i),h=this.Ys(o,r,s),c=this.Ys(o,i,s);return!(Math.abs(l+h+c-a)>n)}wn(t,e){const n=this.sn.tolerance||1,r=t[0],i=t[1],s=t[2],o=Ur(r,i,s,0)-n,a=Ur(r,i,s,1)-n,l=Ur(r,i,s,2)-n,h=jr(r,i,s,0)+n,c=jr(r,i,s,1)+n,u=jr(r,i,s,2)+n;return e[0]>=o&&e[0]<=h&&e[1]>=a&&e[1]<=c&&e[2]>=l&&e[2]<=u}vn(t,e){const n=this.sn.tolerance||1,r=t[0],i=t[1],s=e,a=o["f"].length(o["f"].sub(wr,r,i)),l=o["f"].length(o["f"].sub(wr,r,s)),h=o["f"].length(o["f"].sub(wr,i,s));return!(Math.abs(l+h-a)>n)}Ys(t,e,n){const r=o["f"].sub(Nr,e,t),i=o["f"].sub(Dr,n,t),s=o["f"].cross(Fr,r,i);return.5*o["f"].length(s)}an(t){return t instanceof a["f"]?t:Array.isArray(t)?new a["f"](t):null}un(t,e){const n=[Hr(e,this.hn.x,this.hn.y,this.hn.z),Hr(e,this.ln.x,this.ln.y,this.ln.z)],r=t[0],i=t[1];for(let s=0;s<gr.length;s+=3)for(let t=0;t<3;t++){const e=s+t;yr[e]=gr[e]>0?i[t]:r[t]}for(let s=0;s<mr.length;s+=3){const t=mr[s],e=mr[s+1],r=mr[s+2],i=o["f"].set(Pr,yr[3*t],yr[3*t+1],yr[3*t+2]),a=o["f"].set(kr,yr[3*e],yr[3*e+1],yr[3*e+2]),l=o["f"].set(Rr,yr[3*r],yr[3*r+1],yr[3*r+2]),h=o["f"].set(vr,i,a,l);if(this.gn(Lr,h,n))return!0}return!1}}const Br=new a["f"](0,0);function Hr(t,e,n,r){if(!t)return null;Br.set(e,n);const i=t.coordinateToPointAtRes(Br,t.getGLRes()),s=t.altitudeToPoint(r||0,t.getGLRes());return[i.x,i.y,s]}function Ur(t,e,n,r){let i=t[r];return i>e[r]&&(i=e[r]),i>n[r]&&(i=n[r]),i}function jr(t,e,n,r){let i=t[r];return i<e[r]&&(i=e[r]),i<n[r]&&(i=n[r]),i}const Vr=()=>{},Gr=new a["f"](0,0),qr=new a["f"](0,0),Wr=[],Xr=[0,0,0],Qr=[0,0,0,1],Yr=[0,0,0,1];class Zr extends a["r"]{static fromJSON(t){if(!t||"GroupGLLayer"!==t.type)return null;const e=t.layers.map(t=>a["r"].fromJSON(t));return new Zr(t.id,e,t.options)}constructor(t,e,n){super(t,n),this.layers=e&&e.slice()||[],this.layers.forEach(t=>{if(t.getMap())throw new Error(`layer(${t.getId()} is already added on map`)}),this._n(),this.sortLayersByZIndex(),this.Mn={}}sortLayersByZIndex(){if(this.layers&&this.layers.length){for(let t=0,e=this.layers.length;t<e;t++)this.layers[t].__group_gl_order=t;this.layers.sort(Jr)}}setSceneConfig(t){this.options.sceneConfig=t;const e=this.getRenderer();return e&&e.updateSceneConfig(),this}getSceneConfig(){return JSON.parse(JSON.stringify(this.ut()))}ut(){return this.options.sceneConfig||{}}getGroundConfig(){return this.ut().ground}getWeatherConfig(){return this.ut().weather}addLayer(t,e){if(t.getMap())throw new Error(`layer(${t.getId()}) is already added on map`);if("gl"!==t.options.renderer)throw new Error(`layer(${t.getId()})'s renderer is canvas, not supported to be added to GroupGLLayer`);void 0===e?this.layers.push(t):this.layers.splice(e,0,t),this._n(),this.sortLayersByZIndex();const n=this.getRenderer();return n?(this.xn(t),this.yn(),n.setToRedraw(),this):this}removeLayer(t){a["I"].isString(t)&&(t=this.getChildLayer(t));const e=this.layers.indexOf(t);if(e<0)return this;const n=t.getRenderer();n&&n.setTerrainHelper&&n.setTerrainHelper(null),t._doRemove(),this.bn(t),delete this.Mn[t.getId()],this.layers.splice(e,1);const r=this.getRenderer();return r?(this.yn(),r.setToRedraw(),this):this}clearLayers(){const t=this.getLayers();for(let e=0;e<t.length;e++)t[e]&&t[e].remove();return this}ki(){let t=0;for(let n=0;n<this.layers.length;n++)this.layers[n].setPolygonOffset&&this.layers[n].getPolygonOffsetCount&&(t+=this.layers[n].getPolygonOffsetCount());let e=0;for(let n=this.layers.length-1;n>=0;n--)this.layers[n].setPolygonOffset&&this.layers[n].getPolygonOffsetCount&&(this.layers[n].setPolygonOffset(e,t),e+=this.layers[n].getPolygonOffsetCount());this.Sn=e}getPolygonOffsetCount(){return this.Sn}getLayers(){return this.layers.slice()}ue(){return this.layers}toJSON(){const t=[];if(this.layers)for(let e=0;e<this.layers.length;e++){const n=this.layers[e];n&&n&&n.toJSON&&t.push(n.toJSON())}return{type:this.getJSONType(),id:this.getId(),layers:t,options:this.config()}}onLoadEnd(){this.layers.forEach(t=>{this.xn(t)}),this.options.terrain&&this.Cn(),super.onLoadEnd()}xn(t){const e=this.getMap();this.Mn[t.getId()]=t,t._canvas=this.getRenderer().canvas,t._bindMap(e),t.once("renderercreate",this.Tn,this),t.remove=()=>{this.removeLayer(t),t.constructor.prototype.remove.call(t),delete t.remove},t.load(),this.kn(t)}onRemove(){this.An(),this.layers.forEach(t=>{this.On(t),t._doRemove(),this.bn(t)}),this.Mn={},this.clearAnalysis(),super.onRemove()}getChildLayer(t){return this.Mn[t]||null}getLayer(t){return this.getChildLayer(t)}kn(t){t.on("show hide",this.In,this),t.on("idchange",this.En,this)}bn(t){t.off("show hide",this.In,this),t.off("idchange",this.En,this)}In(){const t=this.getRenderer();t&&t.setToRedraw()}En(t){const e=t.new,n=t.old,r=this.getLayer(n);delete this.Mn[n],this.Mn[e]=r}Tn(t){t.renderer.clearCanvas=Kr}_n(){const t={};this.layers.forEach(e=>{const n=e.getId();if(t[n])throw new Error(`Duplicate child layer id (${n}) in the GroupGLLayer (${this.getId()})`);t[n]=1})}addAnalysis(t){this.wi=this.wi||[],this.wi.push(t);const e=this.getRenderer();e&&e.setToRedraw()}removeAnalysis(t){if(this.wi){const e=this.wi.indexOf(t);e>-1&&(this.wi.splice(e,1),t.remove())}const e=this.getRenderer();e&&e.setToRedraw()}clearAnalysis(){this.wi&&(this.wi.forEach(t=>{t.remove()}),this.wi=[]);const t=this.getRenderer();t&&t.setToRedraw()}identify(t,e={}){const n=this.getMap(),r=this.getRenderer();if(!n||!r)return[];const i=n.coordToContainerPoint(new a["f"](t));return this.identifyAtPoint(i,e)}identifyAtPoint(t,e={}){const n=e.includeInternals,r=this.getLayers(),i=e&&e.childLayers||r,s=this.getMap();if(!s)return[];const a=et(e.count)?1:e.count;let l=[];for(let o=i.length-1;o>=0;o--){const s=i[o];if(r.indexOf(s)<0||!s.identifyAtPoint)continue;const a=s.options.geometryEvents;if(n&&(void 0===a||!1===a||0===a))continue;if(s.isGeometryListening&&n&&e.eventTypes.indexOf("mousemove")>=0&&!s.isGeometryListening(e.eventTypes))continue;let h=s.identifyAtPoint(t,e);if(!h||!h.length)continue;if(e.filter&&(h=h.filter(t=>e.filter(t))),!h.length)continue;const c=s.getId();for(let t=0;t<h.length;t++)h[t]&&(h[t].layer=c);l.push(...h)}if(e.orderByCamera){const t=s.cameraPosition;l.sort((e,n)=>n.point?e.point?o["f"].dist(e.point,t)-o["f"].dist(n.point,t):1:-1)}return a&&(l=l.slice(0,a)),l}getTerrain(){return this.options.terrain}setTerrain(t){return this.options.terrain=t,this.getRenderer()?(this.Cn(),this.getMap().updateCenterAltitude(),this):this}removeTerrain(){return this.setTerrain(null)}updateTerrainMaterial(t){this.ce&&t&&(this.options.terrain.material?tt(this.options.terrain.material,t):this.options.terrain.material=t,this.ce.updateMaterial(t))}Cn(){const t=this.getRenderer();t&&t.setToRedraw();const e=this.options.terrain;if(this.ce){const t=this.ce.options;if(e&&t.urlTemplate===e.urlTemplate&&t.spatialReference===e.spatialReference){for(const t in e)"material"===t?this.ce.setMaterial(e[t]):"urlTemplate"!==t&&"spatialReference"!==t&&this.ce.config(t,e[t]);return this}this.An()}if(this.Ln(),!e)return this;this.ce=new Ar("__terrain_in_group",e),this.yn(),this.ce.on("tileload",this.Fn,this),this.xn(this.ce);const n=e.masks;return n&&n.length?this.ce.setMask(n):this.ce.removeMask(),this.fire("terrainlayercreated"),this}queryTerrain(t,e){return this.ce?this.ce.queryTerrain(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}queryTerrainAtPoint(t,e={}){if(!this.ce)return null;const n=this.map.getGLRes(),r=this.map,i=r.width/2||1,s=r.height/2||1,l=t;o["f"].set(Xr,(l.x-i)/i,(s-l.y)/s,0),o["f"].set(Qr,Xr[0],Xr[1],0),o["f"].set(Yr,Xr[0],Xr[1],.5),Qr[3]=Yr[3]=1,$r(Qr,Qr,r.projViewMatrixInverse),$r(Yr,Yr,r.projViewMatrixInverse);const h=new a["A"](Qr.slice(0,3)),c=new a["A"](Yr.slice(0,3)),u=r.pointAtResToCoordinate(h,n,Gr);u.z=Qr[2]/r.altitudeToPoint(1,n);const f=r.pointAtResToCoordinate(c,n,qr);f.z=Yr[2]/r.altitudeToPoint(1,n),this.Rn?(this.raycaster.setFromPoint(u),this.raycaster.setToPoint(f)):(e.allowPointNotOnLine=!0,this.raycaster=new zr(u,f,e));const d=this.ce.getRenderer().getAnalysisMeshes(),p=this.raycaster.test(d,r),A=[],g=o["f"].set(Wr,u.x,u.y,u.z);return p.forEach(t=>{t.coordinates.forEach(t=>{A.push(t.coordinate)})}),A.sort((t,e)=>o["f"].dist(t.toArray(),g)-o["f"].dist(e.toArray(),g)),A[0]}queryTerrainByProjCoord(t,e){return this.ce?this.ce.queryTerrainByProjCoord(t,e):(e&&(e[0]=null,e[1]=0),[null,0])}yn(){if(!this.ce)return;const t=this.layers,e=[];for(let n=0;n<t.length;n++){if(!t[n])continue;const r=t[n],i=r.getRenderer();if(i.renderTerrainSkin){if(i.deleteTile===Vr){e.push(t[n]);continue}r.getTiles=()=>this.ce.getSkinTiles(r),i.drawTileOnTerrain?i.drawTile=(...t)=>i.drawTileOnTerrain(...t):i.drawTile=Vr,i.deleteTile=Vr,e.push(t[n])}i.setTerrainHelper&&i.setTerrainHelper(this.ce)}this.ce.setSkinLayers(e)}On(t){if(!function(t){if(!t)return!1;const e=t.getRenderer();return!!e&&!!e.renderTerrainSkin}(t))return;const e=t.getRenderer();e&&(e.setTerrainHelper&&e.setTerrainHelper(null),e.clear&&e.clear(),delete e.drawTile,delete e.deleteTile),delete t.getTiles}Ln(){const t=this.layers;for(let e=0;e<t.length;e++)t[e]&&this.On(t[e])}Fn(){const t=this.getRenderer();t&&t.setToRedraw()}An(){if(this.ce){const t=this.ce;t.off("tileload",this.Fn,this),this.bn(t),this.ce._doRemove(),delete this.ce,this.fire("terrainlayerremoved")}}getTerrainLayer(){return this.ce}_bindMap(...t){if(this.options.single){const e=t[0].getLayers();for(let t=0;t<e.length;t++)if(e[t]instanceof Zr)throw new Error("Only one GroupGLLayer is allowed in a map instance. Set options.single to false if you want to add two or more GroupGLLayers.")}return super._bindMap(...t)}fire(...t){if("layerload"===t[0]){const t=this.ue();for(const e of t){const t=e.getRenderer();t&&t.isRenderComplete()&&e.fire("layerload")}}super.fire(...t)}}function Kr(){}function Jr(t,e){const n=t.getZIndex()-e.getZIndex();return 0===n?t.__group_gl_order-e.__group_gl_order:n}function $r(t,e,n){const r=e[0],i=e[1],s=e[2],o=1/(n[3]*r+n[7]*i+n[11]*s+n[15]);return t[0]=(n[0]*r+n[4]*i+n[8]*s+n[12])*o,t[1]=(n[1]*r+n[5]*i+n[9]*s+n[13])*o,t[2]=(n[2]*r+n[6]*i+n[10]*s+n[14])*o,t}Zr.mergeOptions({renderer:"gl",antialias:!0,extensions:[],single:!0,onlyWebGL1:!1,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","EXT_frag_depth","EXT_texture_filter_anisotropic","WEBGL_compressed_texture_astc","WEBGL_compressed_texture_etc","WEBGL_compressed_texture_etc1","WEBGL_compressed_texture_pvrtc","WEBGL_compressed_texture_s3tc","WEBGL_compressed_texture_s3tc_srgb"],forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0,viewMoveThreshold:100,geometryEvents:!0,multiSamples:4,forceRedrawPerFrame:!1}),Zr.registerJSONType("GroupGLLayer"),Zr.registerRenderer("gl",xe),Zr.registerRenderer("canvas",null);class ti{constructor(t){this.Pn=t,this.N=new s["ResourceLoader"],this.onHDRLoaded=this.Dn.bind(this),this.onHDRError=this.Hn.bind(this)}getDirectionalLight(){return this.jt&&this.jt.directional||{}}getAmbientLight(){return this.jt&&this.jt.ambient||{}}getAmbientResource(){return this.Nn}setConfig(t){const e=this.jt;this.Gn=t.urlModifier,this.jt=JSON.parse(JSON.stringify(t));let n=!1;if(t&&t.ambient&&t.ambient.resource){if(!(e&&e.ambient&&function(t,e){return!!t.resource&&t.resource.url===e.resource.url}(e.ambient,t.ambient)))return void this.jn();this.Nn&&(t.ambient.prefilterCubeSize!==e.ambient&&e.ambient.prefilterCubeSize&&this.Dn(),n=!0,t.ambient.resource.sh&&(this.Nn.sh=t.ambient.resource.sh))}else this.Bn(),n=e&&e.ambient&&e.ambient.resource;this.Pn.fire("updatelights",{ambientUpdate:n})}Un(t){const e=t.getLayers();for(let i=0;i<e.length;i++){const t=e[i]&&e[i].getRenderer();if(t&&t.regl)return t.regl}const n=document.createElement("canvas"),r=i()({canvas:n,attributes:{depth:!1,stencil:!1,alpha:!1}});return r.zn=!0,r}jn(){const t=this.jt.ambient.resource,e=t&&t.url;if(!e)return;const n=[];let r=0,i=0;const o=()=>{i++,i>=r&&this.Vn(n)},a=function(){throw new Error(`skybox image with url(${this.src}) failed to load, please check the image's url.`)},l=this.Gn;if(e.top||e.nx){const{front:t,back:i,right:s,left:h,top:c,bottom:u}=e,{nx:f,ny:d,px:p,py:A,nz:g,pz:m}=e;let y;y=t?[h,s,i,t,c,u]:[f,p,g,m,A,d],r=y.length;for(let e=0;e<r;e++){const t=new Image;t.onload=o,t.onerror=a,t.src=l&&l(y[e])||y[e],n[e]=t}}else{const e={url:t.url,arrayBuffer:!0,hdr:!0,flipY:!0};this.N.setURLModifier(l),this.Wn=new s["Texture2D"](e,this.N),this.Wn.once("complete",this.onHDRLoaded),this.Wn.once("error",this.onHDRError)}}dispose(){this.Bn()}Dn(){this.Wn&&(this.Nn=this.qn(this.Wn),this.Pn.fire("updatelights",{ambientUpdate:!0}))}Hn(){this.Pn.fire("hdrerror")}Vn(t){this.Nn=this.qn(t),this.Pn.fire("updatelights",{ambientUpdate:!0})}qn(t){const e=this.jt.ambient.resource,n=e.prefilterCubeSize||128,r=this.Un(this.Pn),i=s["pbr"].PBRHelper.createIBLMaps(r,{envTexture:Array.isArray(t)?t:t.getREGLTexture(r),rgbmRange:Array.isArray(t)?9:t.rgbmRange,ignoreSH:!!e.sh,envCubeSize:n,prefilterCubeSize:n,format:"array"});if(e.sh&&(i.sh=e.sh,Array.isArray(i.sh[0]))){const t=i.sh,e=[];for(let n=0;n<t.length;n++)e.push(...t[n]);i.sh=e}return r.zn&&(delete this.Wn,r.destroy()),i}Bn(){this.Wn&&(this.Wn.dispose(),delete this.Wn),delete this.Nn}}let ei,ni,ri,ii,si;a["t"].include({setLights(t){return this.options.lights=t,this.$n(),this},getLights(){return this.options.lights},$n(){this.Yn||(this.Yn=new ti(this)),this.Yn.setConfig(this.getLights())},getLightManager(){return this.Yn?this.Yn:(this.Xn||(this.Xn=!0,console.warn("map's light config is not set, use map.setLights(config) to set lights.")),null)}}),a["t"].addOnLoadHook((function(){this.options.lights&&this.$n()}));const oi={color:[0,0,0,0]},ai={enable:!0};a["t"].include({setPostProcessConfig(t){return this.options.postProcessConfig=t,this},getPostProcessConfig(){return this.options.postProcessConfig}});const li=a["P"].MapCanvasRenderer.prototype.drawLayerCanvas;a["P"].MapCanvasRenderer.prototype.drawLayerCanvas=function(){const t=li.apply(this,arguments);return t&&ci(this,this.canvas),t};const hi=a["P"].MapCanvasRenderer.prototype.renderFrame;function ci(t,e){const n=t.map.getPostProcessConfig();if(!n||!n.enable)return;var r,s;ei||(r=e.width,s=e.height,ei=document.createElement("canvas",r,s),ni=i()({canvas:ei,attributes:{depth:!1,stencil:!1,alpha:!0,antialias:!1,premultipliedAlpha:!1}}),ri=ni.texture({mag:"linear",min:"linear",mipmap:!1,flipY:!0,width:r,height:s}),ii=ni.texture()),ei.width===e.width&&ei.height===e.height||(ei.width=e.width,ei.height=e.height),ni.clear(oi);const o=n.filmicGrain||ai;void 0===o.enable&&(o.enable=!0);const a=n.vignette||ai;void 0===a.enable&&(a.enable=!0);const l=n.colorLUT||ai;void 0===l.enable&&(l.enable=!0),t.Jn||(t.Jn={});const h=t.Jn;if(l.enable){const e=l.lut;if(!h.lutTexture||h.lutTexture.url!==e){const n=new Image;n.onload=function(){const r={data:n,min:"linear",mag:"linear"},i=h.lutTexture?h.lutTexture.texture(r):ni.texture(r);h.lutTexture={url:e,texture:i},t.setLayerCanvasUpdated()},n.src=e}}const c={enableGrain:+!!o.enable,grainFactor:void 0===o.factor?.15:o.factor,timeGrain:performance.now(),enableVignette:+!!a.enable,lensRadius:a.lensRadius||[.8,.25],frameMod:1,enableLut:+!!l.enable,lookupTable:h.lutTexture?h.lutTexture.texture:ii};si||(si=new he(ni)),si.postprocess(null,c,ri({width:ei.width,height:ei.height,data:e,flipY:!0,mag:"linear",min:"linear",mipmap:!1})),o.enable&&t.setLayerCanvasUpdated(),t.context.drawImage(ei,0,0,ei.width,ei.height)}a["P"].MapCanvasRenderer.prototype.renderFrame=function(){const t=hi.apply(this,arguments),e=this.map.getPostProcessConfig(),n=e&&e.filmicGrain;return!n||void 0!==n.enable&&!0!==n.enable||this.setLayerCanvasUpdated(),t};const ui=[];function fi(t){t.properties.showOnlyTimestamp&&(delete t.properties.showOnlyTimestamp,pi(t))}function di(t,e){const n=t.geometry.properties;n.oldElementsBeforeHighlight||(n.oldElementsBeforeHighlight=t.geometry.elements),n.elements&&(n.oldElementsArrBeforeHighlight||(n.oldElementsArrBeforeHighlight=n.elements),n.elements=e)}function pi(t){const e=t.geometry.properties.oldElementsBeforeHighlight;e&&t.geometry.elements!==e&&(t.geometry.deleteElements(),t.geometry.setElements(t.geometry.properties.oldElementsBeforeHighlight),t.geometry.properties.oldElementsArrBeforeHighlight&&(t.geometry.properties.elements=t.geometry.properties.oldElementsArrBeforeHighlight,delete t.geometry.properties.oldElementsArrBeforeHighlight),delete t.geometry.properties.hasInvisible,delete t.geometry.properties.oldElementsBeforeHighlight)}function Ai(t){if(!t.properties.highlightTimestamp)return;const e=t.defines;delete e.HAS_HIGHLIGHT_COLOR,delete e.HAS_HIGHLIGHT_OPACITY,t.setDefines(e),delete t.properties.highlightTimestamp,pi(t),gi(t)}function gi(t){if(!t)return;const{hlBloomMesh:e}=t.properties;if(e){const n=e.geometry;n.elements&&n.elements.destroy&&n.deleteElements(),e.dispose(),delete t.properties.hlBloomMesh}}var mi=Object.freeze({__proto__:null,clearShowOnly:fi,showOnly:function(t,e,n,r,i){const{showOnlyTimestamp:s}=e.properties;if(!n)return void(s&&fi(e));if(r===s)return;e.properties.showOnlyTimestamp=r;const o=n.keys(),a=[];for(const h of o){if(!i.has(h))continue;const t=i.get(h);t&&ot(a,t)}di(e,a),e.geometry.elements!==e.geometry.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.deleteElements();const l={data:a,primitive:e.geometry.getPrimitive()};e.geometry.setElements(t.elements(l)),e.geometry.generateBuffers(t)},clearHighlight:Ai,highlightMesh:function(t,e,n,r,i){const{highlightTimestamp:a}=e.properties;if(!n)return void(a&&Ai(e));if(r===a)return;const l=e.geometry.getVertexCount();let{aHighlightColor:h,aHighlightOpacity:c}=e.geometry.properties;h&&h.fill(0),c&&c.fill(255);let u=!1,f=!1;const d=n.keys();let p=null,A=null;for(const s of d)if(i.has(s)){const t=n.get(s),{color:e,bloom:r,visible:a}=t;let d,{opacity:g}=t;if(e&&(u||(h||(h=new Uint8Array(4*l)),u=!0),d=ht(ui,e)),g=et(g)?1:g,g<1&&(f||(c||(c=new Uint8Array(l),c.fill(255)),f=!0)),!1===a&&(A||(A=new Set),A.add(s)),d||g<1||r){const t=i.get(s);if(t)for(let e=0;e<t.length;e++){const n=t[e];d&&o["g"].set(h.subarray(4*n,4*n+4),...d),g<1&&(c[n]=255*g),r&&(p||(p=[]),p.push(n))}}}const g=e.defines;if(u?(e.geometry.data.aHighlightColor?e.geometry.updateData("aHighlightColor",h):(e.geometry.data.aHighlightColor=h,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightColor=h,g.HAS_HIGHLIGHT_COLOR=1):g.HAS_HIGHLIGHT_COLOR&&(e.geometry.updateData("aHighlightColor",h),delete g.HAS_HIGHLIGHT_COLOR),f?(e.geometry.data.aHighlightOpacity?e.geometry.updateData("aHighlightOpacity",c):(e.geometry.data.aHighlightOpacity=c,e.geometry.generateBuffers(t)),e.geometry.properties.aHighlightOpacity=c,g.HAS_HIGHLIGHT_OPACITY=1):g.HAS_HIGHLIGHT_OPACITY&&(e.geometry.updateData("aHighlightOpacity",c),delete g.HAS_HIGHLIGHT_OPACITY),A&&A.size>0){let n=[];i.forEach((t,e)=>{A.has(e)||ot(n,t)}),e.geometry.properties.hasInvisible=!0,di(e,n);const r={data:n,primitive:e.geometry.getPrimitive()};e.geometry.elements!==e.geometry.properties.oldElementsBeforeHighlight&&e.geometry.elements.destroy&&e.geometry.deleteElements(),n=t.elements(r),e.geometry.setElements(n),e.geometry.generateBuffers(t)}else e.geometry.properties.hasInvisible&&pi(e);e.setDefines(g),e.properties.highlightTimestamp=r;let m=e.properties.hlBloomMesh;if(p&&p.length){if(m){const t=o["c"].copy(m.localTransform,e.localTransform),n=o["c"].copy(m.positionMatrix,e.positionMatrix);m.setLocalTransform(t),m.setPositionMatrix(n),e.properties.hlBloomMesh.geometry.setElements(p)}else{const n=new s["Geometry"](e.geometry.data,p,0,e.geometry.desc);n.generateBuffers(t);const r=e.material;m=new s["Mesh"](n,r,e.config);const i=e.uniforms;for(const t in i)Object.defineProperty(m.uniforms,t,{enumerable:!0,get:function(){return e.getUniform(t)}});const a=tt({},e.defines);a.HAS_BLOOM=1;const l=o["c"].copy([],e.localTransform),h=o["c"].copy([],e.positionMatrix);m.setLocalTransform(l),m.setPositionMatrix(h),tt(m.properties,e.properties),tt(n.properties,e.geometry.properties),m.setDefines(a),m.bloom=1}e.properties.hlBloomMesh=m}else m&&gi(e)},deleteHighlightBloomMesh:gi});const yi=[0,0,0,0];class vi{constructor(t,e,n,r,i,o){this.renderer=new s["Renderer"](t),this.sceneConfig=e,this.s=n,this.Zn=r,this.Kn=i,this.Sn=o||{factor:0,units:0},this.h(),this.Qn=[]}render(t,e,n){this.tr();const r=this.s.getMap();this.renderer.regl.clear({color:yi,depth:1,stencil:255,framebuffer:this.ir}),this.renderer.render(this.er,e,t,this.ir);const i=this.s.getRenderer().canvas;this.Qn[0]=i.width,this.Qn[1]=i.height;const s=tt({colorRamp:this.sr,inputTexture:this.ir,projViewMatrix:r.projViewMatrix,textureOutputSize:this.Qn},e);return this.m(),this.renderer.render(this.nr,s,this.D,n)}dispose(){this.er&&(this.er.dispose(),delete this.er),this.nr&&(this.nr.dispose(),delete this.nr),this.S&&(this.S.geometry.dispose(),this.S.dispose(),delete this.S,delete this.D),this.ir&&(this.ir.destroy(),delete this.ir)}rr(){const t=this.Zn;let e=this.hr,n=this.or;n?n.clearRect(0,0,256,1):(e=this.hr=document.createElement("canvas"),e.width=256,e.height=1,n=this.or=e.getContext("2d"));const r=n.createLinearGradient(0,0,256,1);for(let s=0;s<t.length;s++)r.addColorStop(t[s][0],t[s][1]);n.fillStyle=r,n.fillRect(0,0,256,1),this.sr&&this.sr.destroy();const i=this.renderer.regl;this.sr=i.texture({width:256,height:1,data:e,min:"linear",mag:"linear",premultiplyAlpha:!0})}tr(){const t=this.s.getRenderer().canvas,e=Math.ceil(t.width/4),n=Math.ceil(t.height/4),r=this.ir;r.width===e&&r.height===n||r.resize(e,n)}h(){this.rr(),this.ar(),this.cr(),this.p()}p(){const t=new s["Plane"];t.generateBuffers(this.renderer.regl),this.S=new s["Mesh"](t),this.D=new s["Scene"]([this.S])}m(){const t=this.s.getMap(),e=kt.getGroundTransform(this.S.localTransform,t);this.S.setLocalTransform(e)}cr(){const t=this.s.getRenderer().canvas,e=this.renderer.regl,n=e.hasExtension("OES_texture_half_float")?"half float":"float",r=Math.ceil(t.width/4),i=Math.ceil(t.height/4),s=e.texture({width:r,height:i,type:n,min:"linear",mag:"linear",format:"rgba"});this.ir=e.framebuffer({width:r,height:i,color:[s]})}ar(){const t=this.s.getRenderer().canvas,e=this.sceneConfig.depthRange,n={viewport:{x:0,y:0,width:()=>t?Math.ceil(t.width/4):1,height:()=>t?Math.ceil(t.height/4):1},depth:{enable:!0,func:"always"}};this.Kn&&(n.stencil=this.Kn),this.er=new s["HeatmapShader"]({extraCommandProps:n}),this.nr=new s["HeatmapDisplayShader"]({x:0,y:0,width:()=>t?t.width:1,height:()=>t?t.height:1},{extraCommandProps:{stencil:{enable:!1},depth:{enable:!0,range:e||[0,1],func:"<="},polygonOffset:{enable:!0,offset:this.Sn},scissor:{enable:!1}}})}}class xi extends Jn{constructor(t,e){super(t,e)}ze(t){const e=this.js(t),n=new s["Mesh"](e);return this.lr(n),this.qs(n),n}Gs(t,e,n){const r=this.zs();t.setUniform("maskMode",r);const i=this.Vs();if(t.setUniform("maskColor",i),nt(e)){const r=this.Ks();r[0]=(r[0]-n)*e,r[1]=(r[1]-n)*e,t.setUniform("heightRange",r)}}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}getHeightRange(){return this.options.heightRange}Ks(){const t=[0,0];return this.options.heightRange&&(t[0]=this.Ws(this.options.heightRange[0]),t[1]=this.Ws(this.options.heightRange[1])),t}lr(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}}class bi extends xi{constructor(t,e){super(t,e),this.Hs="clip-inside"}}class wi extends xi{constructor(t,e){super(t,e),this.Hs="clip-outside"}}class _i extends Jn{constructor(t,e){super(t,e)}setFlatheight(t){this.options.flatHeight=t,this._fireEvent("flatheightchange")}ze(t){const e=this.js(t),n=new s["Mesh"](e);return this.lr(n),this.qs(n),n}Gs(t){const e=this.zs();t.setUniform("maskMode",e);const n=this.Vs();t.setUniform("maskColor",n);const r=this.Ws(this.options.flatHeight||0);t.setUniform("flatHeight",r)}lr(t){const e=t.getDefines();e.HAS_MASK_FLAT=1,t.setDefines(e)}Ks(){const t=[0,this.options.flatHeight];return t[1]=this.Ws(t[1]),t}}class Mi extends _i{constructor(t,e){super(t,e),this.Hs="flat-inside"}}class Ti extends _i{constructor(t,e){super(t,e),this.Hs="flat-outside"}}class Si extends Jn{constructor(t,e){super(t,e),this.Hs="color"}setHeightRange(t){this.options.heightRange=t,this._fireEvent("heightrangechange")}ze(t){const e=this.js(t),n=new s["Mesh"](e);return this.lr(n),this.qs(n),n}Gs(t,e,n){const r=this.zs();t.setUniform("maskMode",r);const i=this.Vs();if(t.setUniform("maskColor",i),nt(e)){const r=this.Ks();r[0]=(r[0]-n)*e,r[1]=(r[1]-n)*e,t.setUniform("heightRange",r)}}lr(t){const e=t.getDefines();e.HAS_MASK_COLOR=1,t.setDefines(e)}Ks(){const t=[0,0];return this.options.heightRange&&(t[0]=this.Ws(this.options.heightRange[0]),t[1]=this.Ws(this.options.heightRange[1])),t}}class Ii extends Jn{constructor(t,e){super(t,e),this.Hs="video"}play(){this.ur&&this.ur.play()}pause(){this.ur&&this.ur.pause()}setAudio(t){this.ur&&(this.video.muted=t)}setUrl(t){this.options.url=t,this.dr(t)}getState(){return this.pr}ze(t){const e=this.js(t),n=new s["Mesh"](e),r=this.gr(t);return n.material=new s["Material"]({maskTexture:r}),this.lr(n),this.qs(n),n}Gs(t){const e=this.zs();t.setUniform("maskMode",e);const n=this.Vs();t.setUniform("maskColor",n)}lr(t){const e=t.getDefines();e.HAS_VIDEO=1,t.setDefines(e)}gr(t){return this.dr(),t.texture()}dr(){this.pr="stop";const t=this.options.url,e=this.options.elementId;let n=document.getElementById(e);if(t&&(n=document.createElement("video"),n.src=t),!n)throw new Error("there is no element or url setting for video mask");n.autoplay=this.options.autoplay||!0,n.loop=this.options.loop||!0,n.muted=this.options.muted||!0,n.play(),n.addEventListener("playing",()=>{this.pr="playing"}),n.addEventListener("pause",()=>{this.pr="pause"}),this.ur=n}je(){const t=this.xt;if(t&&t.material){const e=t.material.get("maskTexture");e&&this.ur&&this.Be()&&e(this.ur)}}Be(){return"playing"===this.pr}}class Ci extends _i{constructor(t,e){super(t,e),this.setElevation(e.elevation),this.Hs="elevate"}setElevation(t){this.options.elevation=t,this.setFlatheight(this.options.elevation)}}const Oi=new a["A"](0,0),Ei=new a["A"](0,0),Pi=new a["A"](0,0),ki=new a["A"](0,0);class Ri extends xi{constructor(t,e){super([],e),this.mr=t}setPosition(t){this.mr=t,this.Xs()}getPosition(){return this.mr}setWidth(t){this.options.width=t,this.Xs()}setLength(t){this.options.length=t,this.Xs()}setHeight(t){this.options.height=t,this.Xs()}setRotation(t){this.options.rotation=t,this.Xs()}Xs(){const t=this.getLayer();if(!t)return;const e=t.getMap();if(e){const{length:t,width:n,height:r}=this.options,i=this.mr,s=this.options.rotation||0,{coordinates:o,heightRange:a}=this.vr(e,i,t,n,r,s);this.setCoordinates(o),this.setHeightRange(a)}}vr(t,e,n,r,i,s){const o=t.getGLRes(),a=t.distanceToPointAtRes(r/2,0,o,Oi),l=t.distanceToPointAtRes(0,n/2,o,Ei),h=t.coordinateToPointAtRes(e,o,Pi),c=h.x-a.x,u=h.x+a.x,f=h.y+l.y,d=h.y-l.y,p=this.wr([[c,f],[u,f],[u,d],[c,d]],h,s);ki.set(p[0][0],p[0][1]);const A=t.pointAtResToCoordinate(ki,o);ki.set(p[1][0],p[1][1]);const g=t.pointAtResToCoordinate(ki,o);ki.set(p[2][0],p[2][1]);const m=t.pointAtResToCoordinate(ki,o);ki.set(p[3][0],p[3][1]);const y=t.pointAtResToCoordinate(ki,o),v=e.z-i/2,x=[v,e.z+i/2];return{coordinates:[[A.x,A.y,v],[g.x,g.y,v],[m.x,m.y,v],[y.x,y.y,v],[A.x,A.y,v]],heightRange:x}}wr(t,e,n){for(let r=0;r<t.length;r++)o["e"].rotate(t[r],t[r],[e.x,e.y],n*Math.PI/180);return t}}class Ni extends Ri{constructor(t,e){super(t,e),this.Hs="clip-inside"}}class Di extends Ri{constructor(t,e){super(t,e),this.Hs="clip-outside"}}"undefined"!=typeof window&&window.maptalks&&(window.maptalks.GroupGLLayer=Zr,window.maptalks.ClipInsideMask=bi,window.maptalks.ClipOutsideMask=wi,window.maptalks.FlatInsideMask=Mi,window.maptalks.FlatOutsideMask=Ti,window.maptalks.ElevateMask=Ci,window.maptalks.ColorMask=Si,window.maptalks.VideoMask=Ii,window.maptalks.BoxInsideClipMask=Ni,window.maptalks.BoxOutsideClipMask=Di,window.maptalks.RayCaster=zr);const Fi=function(){if("undefined"!==typeof self)return self;if("undefined"!==typeof window)return window;if("undefined"!==typeof t)return t;throw new Error("unable to locate global object")},Li=Fi(),zi=Li["gl_trans__coders"]=Li["gl_trans__coders"]||{};function Bi(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=Li["gl_trans__coders"]=Li["gl_trans__coders"]||{};let s=`${r}\n    const _____getGlobal = ${Fi.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const o in i)"inject"!==o&&"getTranscoder"!==o&&"registerTranscoder"!==o&&(s+='tran_____scoders["'+o+'"] ='+i[o].toString()+"\n;");return s+="\n"+e.substring(r.length),s}function Hi(t){return zi[t]}function Ui(t,e){zi[t]=e}zi["inject"]=Bi,zi.registerTranscoder=Ui,zi.getTranscoder=Hi;const ji="${",Vi=`function(t){var r="undefined"!=typeof Float32Array?Float32Array:Array;function e(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function i(t,e,i){var n=new r(3);return n[0]=t,n[1]=e,n[2]=i,n}function n(t,r){var e=r[0],i=r[1],n=r[2],s=e*e+i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t[0]=r[0]*s,t[1]=r[1]*s,t[2]=r[2]*s),t}function s(t,r,e){var i=r[0],n=r[1],s=r[2],a=e[0],o=e[1],h=e[2];return t[0]=n*h-s*o,t[1]=s*a-i*h,t[2]=i*o-n*a,t}var a=function(t,r,e){return t[0]=r[0]-e[0],t[1]=r[1]-e[1],t[2]=r[2]-e[2],t};function o(){var t=new r(4);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}e(),function(){var t,e=(t=new r(4),r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var h;function c(t,r,e){return t[0]=r,t[1]=e,t}e(),i(1,0,0),i(0,1,0),o(),o(),h=new r(9),r!=Float32Array&&(h[1]=0,h[2]=0,h[3]=0,h[5]=0,h[6]=0,h[7]=0),h[0]=1,h[4]=1,h[8]=1,function(){var t=function(){var t=new r(2);return r!=Float32Array&&(t[0]=0,t[1]=0),t}()}();\n/*!\n   * @maptalks/gltf-loader v0.97.2\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.org\n   */\nlet f=0;!function(t){t[0]=0,t[1]=0,t[2]=0,t[3]=1}([]),"undefined"!=typeof TextDecoder&&new TextDecoder("utf-8");const u={get:function(t,r={},e){r||(r={});const i=new AbortController,n=i.signal,s=function(t){for(let r=1;r<arguments.length;r++){const e=arguments[r];for(const r in e)t[r]=e[r]}return t}({},r);s.signal=n,s.method||(s.method="GET"),s.referrerPolicy=s.referrerPolicy||"origin","undefined"==typeof window||s.referrer||(s.referrer=window.location.href),e&&(t=e(t));const a=fetch(t,s).then(t=>{const e=this.U(t,r.responseType);return e.message?e:e.then(e=>"arraybuffer"===r.responseType?{data:e,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:e).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t})}).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t});return a.xhr=i,a},U:(t,r)=>200!==t.status?{status:t.status,statusText:t.statusText,message:\`incorrect http request with status code(${ji}t.status}): ${ji}t.statusText}\`}:"arraybuffer"===r?t.arrayBuffer():"json"===r?t.json():t.text(),getArrayBuffer:(t,r={},e)=>(r||(r={}),r.responseType="arraybuffer",u.get(t,r,e)),getJSON:function(t,r={},e){return r&&r.jsonp?u.jsonp(t):((r=r||{}).responseType="json",u.get(t,r,e))},jsonp:function(t){const r="_maptalks_jsonp_"+f++;t.match(/\\?/)?t+="&callback="+r:t+="?callback="+r;let e=document.createElement("script");return e.type="text/javascript",e.src=t,new Promise(t=>{window[r]=function(i){document.getElementsByTagName("head")[0].removeChild(e),e=null,delete window[r],t(i)},document.getElementsByTagName("head")[0].appendChild(e)})}};if("undefined"!=typeof TextDecoder&&new TextDecoder("utf-8"),"undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(t){}}"undefined"!=typeof document&&document.createElement("canvas"),function(){function t(t){throw t}var r=void 0,e=!0,i=this;function n(t,e){var n,s=t.split("."),a=i;!(s[0]in a)&&a.execScript&&a.execScript("var "+s[0]);for(;s.length&&(n=s.shift());)s.length||e===r?a=a[n]?a[n]:a[n]={}:a[n]=e}var s="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array&&"undefined"!=typeof DataView;function a(r,e){this.index="number"==typeof e?e:0,this.i=0,this.buffer=r instanceof(s?Uint8Array:Array)?r:new(s?Uint8Array:Array)(32768),2*this.buffer.length<=this.index&&t(Error("invalid index")),this.buffer.length<=this.index&&this.f()}a.prototype.f=function(){var t,r=this.buffer,e=r.length,i=new(s?Uint8Array:Array)(e<<1);if(s)i.set(r);else for(t=0;t<e;++t)i[t]=r[t];return this.buffer=i},a.prototype.d=function(t,r,e){var i,n=this.buffer,s=this.index,a=this.i,o=n[s];if(e&&1<r&&(t=8<r?(l[255&t]<<24|l[t>>>8&255]<<16|l[t>>>16&255]<<8|l[t>>>24&255])>>32-r:l[t]>>8-r),8>r+a)o=o<<r|t,a+=r;else for(i=0;i<r;++i)o=o<<1|t>>r-i-1&1,8==++a&&(a=0,n[s++]=l[o],o=0,s===n.length&&(n=this.f()));n[s]=o,this.buffer=n,this.i=a,this.index=s},a.prototype.finish=function(){var t,r=this.buffer,e=this.index;return 0<this.i&&(r[e]<<=8-this.i,r[e]=l[r[e]],e++),s?t=r.subarray(0,e):(r.length=e,t=r),t};var o,h=new(s?Uint8Array:Array)(256);for(o=0;256>o;++o){for(var c=u=o,f=7,u=u>>>1;u;u>>>=1)c<<=1,c|=1&u,--f;h[o]=(c<<f&255)>>>0}var l=h;function d(t){this.buffer=new(s?Uint16Array:Array)(2*t),this.length=0}function y(t){var r,e,i,n,a,o,h,c,f,u,l=t.length,d=0,y=Number.POSITIVE_INFINITY;for(c=0;c<l;++c)t[c]>d&&(d=t[c]),t[c]<y&&(y=t[c]);for(r=1<<d,e=new(s?Uint32Array:Array)(r),i=1,n=0,a=2;i<=d;){for(c=0;c<l;++c)if(t[c]===i){for(o=0,h=n,f=0;f<i;++f)o=o<<1|1&h,h>>=1;for(u=i<<16|c,f=o;f<r;f+=a)e[f]=u;++n}++i,n<<=1,a<<=1}return[e,d,y]}function A(t,r){this.h=b,this.w=0,this.input=s&&t instanceof Array?new Uint8Array(t):t,this.b=0,r&&(r.lazy&&(this.w=r.lazy),"number"==typeof r.compressionType&&(this.h=r.compressionType),r.outputBuffer&&(this.a=s&&r.outputBuffer instanceof Array?new Uint8Array(r.outputBuffer):r.outputBuffer),"number"==typeof r.outputIndex&&(this.b=r.outputIndex)),this.a||(this.a=new(s?Uint8Array:Array)(32768))}d.prototype.getParent=function(t){return 2*((t-2)/4|0)},d.prototype.push=function(t,r){var e,i,n,s=this.buffer;for(e=this.length,s[this.length++]=r,s[this.length++]=t;0<e&&(i=this.getParent(e),s[e]>s[i]);)n=s[e],s[e]=s[i],s[i]=n,n=s[e+1],s[e+1]=s[i+1],s[i+1]=n,e=i;return this.length},d.prototype.pop=function(){var t,r,e,i,n,s=this.buffer;for(r=s[0],t=s[1],this.length-=2,s[0]=s[this.length],s[1]=s[this.length+1],n=0;!((i=2*n+2)>=this.length)&&(i+2<this.length&&s[i+2]>s[i]&&(i+=2),s[i]>s[n]);)e=s[n],s[n]=s[i],s[i]=e,e=s[n+1],s[n+1]=s[i+1],s[i+1]=e,n=i;return{index:t,value:r,length:this.length}};var w,b=2,p={NONE:0,r:1,k:b,N:3},v=[];for(w=0;288>w;w++)switch(!0){case 143>=w:v.push([w+48,8]);break;case 255>=w:v.push([w-144+400,9]);break;case 279>=w:v.push([w-256+0,7]);break;case 287>=w:v.push([w-280+192,8]);break;default:t("invalid literal: "+w)}function k(t,r){this.length=t,this.G=r}A.prototype.j=function(){var i,n,o,h,c=this.input;switch(this.h){case 0:for(o=0,h=c.length;o<h;){var f,u,l,d=n=s?c.subarray(o,o+65535):c.slice(o,o+65535),y=(o+=n.length)===h,A=r,w=r,p=this.a,k=this.b;if(s){for(p=new Uint8Array(this.a.buffer);p.length<=k+d.length+5;)p=new Uint8Array(p.length<<1);p.set(this.a)}if(f=y?1:0,p[k++]=0|f,l=65536+~(u=d.length)&65535,p[k++]=255&u,p[k++]=u>>>8&255,p[k++]=255&l,p[k++]=l>>>8&255,s)p.set(d,k),k+=d.length,p=p.subarray(0,k);else{for(A=0,w=d.length;A<w;++A)p[k++]=d[A];p.length=k}this.b=k,this.a=p}break;case 1:var m=new a(s?new Uint8Array(this.a.buffer):this.a,this.b);m.d(1,1,e),m.d(1,2,e);var U,x,M,S=g(this,c);for(U=0,x=S.length;U<x;U++)if(M=S[U],a.prototype.d.apply(m,v[M]),256<M)m.d(S[++U],S[++U],e),m.d(S[++U],5),m.d(S[++U],S[++U],e);else if(256===M)break;this.a=m.finish(),this.b=this.a.length;break;case b:var I,F,D,z,C,N,O,j,q,W,Z,V,$,_,B,H=new a(s?new Uint8Array(this.a.buffer):this.a,this.b),L=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],P=Array(19);for(I=b,H.d(1,1,e),H.d(I,2,e),F=g(this,c),O=T(N=E(this.L,15)),q=T(j=E(this.K,7)),D=286;257<D&&0===N[D-1];D--);for(z=30;1<z&&0===j[z-1];z--);var G,R,Y,J,K,X,Q=D,tt=z,rt=new(s?Uint32Array:Array)(Q+tt),et=new(s?Uint32Array:Array)(316),it=new(s?Uint8Array:Array)(19);for(G=R=0;G<Q;G++)rt[R++]=N[G];for(G=0;G<tt;G++)rt[R++]=j[G];if(!s)for(G=0,J=it.length;G<J;++G)it[G]=0;for(G=K=0,J=rt.length;G<J;G+=R){for(R=1;G+R<J&&rt[G+R]===rt[G];++R);if(Y=R,0===rt[G])if(3>Y)for(;0<Y--;)et[K++]=0,it[0]++;else for(;0<Y;)(X=138>Y?Y:138)>Y-3&&X<Y&&(X=Y-3),10>=X?(et[K++]=17,et[K++]=X-3,it[17]++):(et[K++]=18,et[K++]=X-11,it[18]++),Y-=X;else if(et[K++]=rt[G],it[rt[G]]++,3>--Y)for(;0<Y--;)et[K++]=rt[G],it[rt[G]]++;else for(;0<Y;)(X=6>Y?Y:6)>Y-3&&X<Y&&(X=Y-3),et[K++]=16,et[K++]=X-3,it[16]++,Y-=X}for(i=s?et.subarray(0,K):et.slice(0,K),W=E(it,7),_=0;19>_;_++)P[_]=W[L[_]];for(C=19;4<C&&0===P[C-1];C--);for(Z=T(W),H.d(D-257,5,e),H.d(z-1,5,e),H.d(C-4,4,e),_=0;_<C;_++)H.d(P[_],3,e);for(_=0,B=i.length;_<B;_++)if(V=i[_],H.d(Z[V],W[V],e),16<=V){switch(_++,V){case 16:$=2;break;case 17:$=3;break;case 18:$=7;break;default:t("invalid code: "+V)}H.d(i[_],$,e)}var nt,st,at,ot,ht,ct,ft,ut,lt=[O,N],dt=[q,j];for(ht=lt[0],ct=lt[1],ft=dt[0],ut=dt[1],nt=0,st=F.length;nt<st;++nt)if(at=F[nt],H.d(ht[at],ct[at],e),256<at)H.d(F[++nt],F[++nt],e),ot=F[++nt],H.d(ft[ot],ut[ot],e),H.d(F[++nt],F[++nt],e);else if(256===at)break;this.a=H.finish(),this.b=this.a.length;break;default:t("invalid compression type")}return this.a};var m=function(){function r(r){switch(!0){case 3===r:return[257,r-3,0];case 4===r:return[258,r-4,0];case 5===r:return[259,r-5,0];case 6===r:return[260,r-6,0];case 7===r:return[261,r-7,0];case 8===r:return[262,r-8,0];case 9===r:return[263,r-9,0];case 10===r:return[264,r-10,0];case 12>=r:return[265,r-11,1];case 14>=r:return[266,r-13,1];case 16>=r:return[267,r-15,1];case 18>=r:return[268,r-17,1];case 22>=r:return[269,r-19,2];case 26>=r:return[270,r-23,2];case 30>=r:return[271,r-27,2];case 34>=r:return[272,r-31,2];case 42>=r:return[273,r-35,3];case 50>=r:return[274,r-43,3];case 58>=r:return[275,r-51,3];case 66>=r:return[276,r-59,3];case 82>=r:return[277,r-67,4];case 98>=r:return[278,r-83,4];case 114>=r:return[279,r-99,4];case 130>=r:return[280,r-115,4];case 162>=r:return[281,r-131,5];case 194>=r:return[282,r-163,5];case 226>=r:return[283,r-195,5];case 257>=r:return[284,r-227,5];case 258===r:return[285,r-258,0];default:t("invalid length: "+r)}}var e,i,n=[];for(e=3;258>=e;e++)i=r(e),n[e]=i[2]<<24|i[1]<<16|i[0];return n}(),U=s?new Uint32Array(m):m;function g(e,i){function n(r,e){var i,n,s,a,o=r.G,h=[],c=0;switch(i=U[r.length],h[c++]=65535&i,h[c++]=i>>16&255,h[c++]=i>>24,!0){case 1===o:n=[0,o-1,0];break;case 2===o:n=[1,o-2,0];break;case 3===o:n=[2,o-3,0];break;case 4===o:n=[3,o-4,0];break;case 6>=o:n=[4,o-5,1];break;case 8>=o:n=[5,o-7,1];break;case 12>=o:n=[6,o-9,2];break;case 16>=o:n=[7,o-13,2];break;case 24>=o:n=[8,o-17,3];break;case 32>=o:n=[9,o-25,3];break;case 48>=o:n=[10,o-33,4];break;case 64>=o:n=[11,o-49,4];break;case 96>=o:n=[12,o-65,5];break;case 128>=o:n=[13,o-97,5];break;case 192>=o:n=[14,o-129,6];break;case 256>=o:n=[15,o-193,6];break;case 384>=o:n=[16,o-257,7];break;case 512>=o:n=[17,o-385,7];break;case 768>=o:n=[18,o-513,8];break;case 1024>=o:n=[19,o-769,8];break;case 1536>=o:n=[20,o-1025,9];break;case 2048>=o:n=[21,o-1537,9];break;case 3072>=o:n=[22,o-2049,10];break;case 4096>=o:n=[23,o-3073,10];break;case 6144>=o:n=[24,o-4097,11];break;case 8192>=o:n=[25,o-6145,11];break;case 12288>=o:n=[26,o-8193,12];break;case 16384>=o:n=[27,o-12289,12];break;case 24576>=o:n=[28,o-16385,13];break;case 32768>=o:n=[29,o-24577,13];break;default:t("invalid distance")}for(i=n,h[c++]=i[0],h[c++]=i[1],h[c++]=i[2],s=0,a=h.length;s<a;++s)w[b++]=h[s];v[h[0]]++,k[h[3]]++,p=r.length+e-1,d=null}var a,o,h,c,f,u,l,d,y,A={},w=s?new Uint16Array(2*i.length):[],b=0,p=0,v=new(s?Uint32Array:Array)(286),k=new(s?Uint32Array:Array)(30),m=e.w;if(!s){for(h=0;285>=h;)v[h++]=0;for(h=0;29>=h;)k[h++]=0}for(v[256]=1,a=0,o=i.length;a<o;++a){for(h=f=0,c=3;h<c&&a+h!==o;++h)f=f<<8|i[a+h];if(A[f]===r&&(A[f]=[]),u=A[f],!(0<p--)){for(;0<u.length&&32768<a-u[0];)u.shift();if(a+3>=o){for(d&&n(d,-1),h=0,c=o-a;h<c;++h)y=i[a+h],w[b++]=y,++v[y];break}0<u.length?(l=x(i,a,u),d?d.length<l.length?(y=i[a-1],w[b++]=y,++v[y],n(l,0)):n(d,-1):l.length<m?d=l:n(l,0)):d?n(d,-1):(y=i[a],w[b++]=y,++v[y])}u.push(a)}return w[b++]=256,v[256]++,e.L=v,e.K=k,s?w.subarray(0,b):w}function x(t,r,e){var i,n,s,a,o,h,c=0,f=t.length;a=0,h=e.length;t:for(;a<h;a++){if(i=e[h-a-1],s=3,3<c){for(o=c;3<o;o--)if(t[i+o-1]!==t[r+o-1])continue t;s=c}for(;258>s&&r+s<f&&t[i+s]===t[r+s];)++s;if(s>c&&(n=i,c=s),258===s)break}return new k(c,r-n)}function E(t,r){var e,i,n,a,o,h=t.length,c=new d(572),f=new(s?Uint8Array:Array)(h);if(!s)for(a=0;a<h;a++)f[a]=0;for(a=0;a<h;++a)0<t[a]&&c.push(a,t[a]);if(e=Array(c.length/2),i=new(s?Uint32Array:Array)(c.length/2),1===e.length)return f[c.pop().index]=1,f;for(a=0,o=c.length/2;a<o;++a)e[a]=c.pop(),i[a]=e[a].value;for(n=function(t,r,e){function i(t){var e=y[t][A[t]];e===r?(i(t+1),i(t+1)):--l[e],++A[t]}var n,a,o,h,c,f=new(s?Uint16Array:Array)(e),u=new(s?Uint8Array:Array)(e),l=new(s?Uint8Array:Array)(r),d=Array(e),y=Array(e),A=Array(e),w=(1<<e)-r,b=1<<e-1;for(f[e-1]=r,a=0;a<e;++a)w<b?u[a]=0:(u[a]=1,w-=b),w<<=1,f[e-2-a]=(f[e-1-a]/2|0)+r;for(f[0]=u[0],d[0]=Array(f[0]),y[0]=Array(f[0]),a=1;a<e;++a)f[a]>2*f[a-1]+u[a]&&(f[a]=2*f[a-1]+u[a]),d[a]=Array(f[a]),y[a]=Array(f[a]);for(n=0;n<r;++n)l[n]=e;for(o=0;o<f[e-1];++o)d[e-1][o]=t[o],y[e-1][o]=o;for(n=0;n<e;++n)A[n]=0;for(1===u[e-1]&&(--l[0],++A[e-1]),a=e-2;0<=a;--a){for(h=n=0,c=A[a+1],o=0;o<f[a];o++)(h=d[a+1][c]+d[a+1][c+1])>t[n]?(d[a][o]=h,y[a][o]=r,c+=2):(d[a][o]=t[n],y[a][o]=n,++n);A[a]=0,1===u[a]&&i(a)}return l}(i,i.length,r),a=0,o=e.length;a<o;++a)f[e[a].index]=n[a];return f}function T(t){var r,e,i,n,a=new(s?Uint16Array:Array)(t.length),o=[],h=[],c=0;for(r=0,e=t.length;r<e;r++)o[t[r]]=1+(0|o[t[r]]);for(r=1,e=16;r<=e;r++)h[r]=c,c+=0|o[r],c<<=1;for(r=0,e=t.length;r<e;r++)for(c=h[t[r]],h[t[r]]+=1,i=a[r]=0,n=t[r];i<n;i++)a[r]=a[r]<<1|1&c,c>>>=1;return a}function M(r,e){switch(this.l=[],this.m=32768,this.e=this.g=this.c=this.q=0,this.input=s?new Uint8Array(r):r,this.s=!1,this.n=I,this.B=!1,!e&&(e={})||(e.index&&(this.c=e.index),e.bufferSize&&(this.m=e.bufferSize),e.bufferType&&(this.n=e.bufferType),e.resize&&(this.B=e.resize)),this.n){case S:this.b=32768,this.a=new(s?Uint8Array:Array)(32768+this.m+258);break;case I:this.b=0,this.a=new(s?Uint8Array:Array)(this.m),this.f=this.J,this.t=this.H,this.o=this.I;break;default:t(Error("invalid inflate mode"))}}var S=0,I=1,F={D:S,C:I};M.prototype.p=function(){for(;!this.s;){var i=Y(this,3);switch(1&i&&(this.s=e),i>>>=1){case 0:var n=this.input,a=this.c,o=this.a,h=this.b,c=n.length,f=r,u=o.length,l=r;switch(this.e=this.g=0,a+1>=c&&t(Error("invalid uncompressed block header: LEN")),f=n[a++]|n[a++]<<8,a+1>=c&&t(Error("invalid uncompressed block header: NLEN")),f===~(n[a++]|n[a++]<<8)&&t(Error("invalid uncompressed block header: length verify")),a+f>n.length&&t(Error("input buffer is broken")),this.n){case S:for(;h+f>o.length;){if(f-=l=u-h,s)o.set(n.subarray(a,a+l),h),h+=l,a+=l;else for(;l--;)o[h++]=n[a++];this.b=h,o=this.f(),h=this.b}break;case I:for(;h+f>o.length;)o=this.f({v:2});break;default:t(Error("invalid inflate mode"))}if(s)o.set(n.subarray(a,a+f),h),h+=f,a+=f;else for(;f--;)o[h++]=n[a++];this.c=a,this.b=h,this.a=o;break;case 1:this.o(P,R);break;case 2:var d,A,w,b,p=Y(this,5)+257,v=Y(this,5)+1,k=Y(this,4)+4,m=new(s?Uint8Array:Array)(N.length),U=r,g=r,x=r,E=r,T=r;for(T=0;T<k;++T)m[N[T]]=Y(this,3);if(!s)for(T=k,k=m.length;T<k;++T)m[N[T]]=0;for(d=y(m),U=new(s?Uint8Array:Array)(p+v),T=0,b=p+v;T<b;)switch(g=J(this,d),g){case 16:for(E=3+Y(this,2);E--;)U[T++]=x;break;case 17:for(E=3+Y(this,3);E--;)U[T++]=0;x=0;break;case 18:for(E=11+Y(this,7);E--;)U[T++]=0;x=0;break;default:x=U[T++]=g}A=y(s?U.subarray(0,p):U.slice(0,p)),w=y(s?U.subarray(p):U.slice(p)),this.o(A,w);break;default:t(Error("unknown BTYPE: "+i))}}return this.t()};var D,z,C=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],N=s?new Uint16Array(C):C,O=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,258,258],j=s?new Uint16Array(O):O,q=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0],W=s?new Uint8Array(q):q,Z=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],V=s?new Uint16Array(Z):Z,$=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],_=s?new Uint8Array($):$,B=new(s?Uint8Array:Array)(288);for(D=0,z=B.length;D<z;++D)B[D]=143>=D?8:255>=D?9:279>=D?7:8;var H,L,P=y(B),G=new(s?Uint8Array:Array)(30);for(H=0,L=G.length;H<L;++H)G[H]=5;var R=y(G);function Y(r,e){for(var i,n=r.g,s=r.e,a=r.input,o=r.c,h=a.length;s<e;)o>=h&&t(Error("input buffer is broken")),n|=a[o++]<<s,s+=8;return i=n&(1<<e)-1,r.g=n>>>e,r.e=s-e,r.c=o,i}function J(r,e){for(var i,n,s=r.g,a=r.e,o=r.input,h=r.c,c=o.length,f=e[0],u=e[1];a<u&&!(h>=c);)s|=o[h++]<<a,a+=8;return(n=(i=f[s&(1<<u)-1])>>>16)>a&&t(Error("invalid code length: "+n)),r.g=s>>n,r.e=a-n,r.c=h,65535&i}function K(t){if("string"==typeof t){var r,e,i=t.split("");for(r=0,e=i.length;r<e;r++)i[r]=(255&i[r].charCodeAt(0))>>>0;t=i}for(var n,s=1,a=0,o=t.length,h=0;0<o;){o-=n=1024<o?1024:o;do{a+=s+=t[h++]}while(--n);s%=65521,a%=65521}return(a<<16|s)>>>0}function X(r,e){var i,n;switch(this.input=r,this.c=0,!e&&(e={})||(e.index&&(this.c=e.index),e.verify&&(this.M=e.verify)),i=r[this.c++],n=r[this.c++],15&i){case Q:this.method=Q;break;default:t(Error("unsupported compression method"))}0!=((i<<8)+n)%31&&t(Error("invalid fcheck flag:"+((i<<8)+n)%31)),32&n&&t(Error("fdict flag is not supported")),this.A=new M(r,{index:this.c,bufferSize:e.bufferSize,bufferType:e.bufferType,resize:e.resize})}M.prototype.o=function(t,r){var e=this.a,i=this.b;this.u=t;for(var n,s,a,o,h=e.length-258;256!==(n=J(this,t));)if(256>n)i>=h&&(this.b=i,e=this.f(),i=this.b),e[i++]=n;else for(o=j[s=n-257],0<W[s]&&(o+=Y(this,W[s])),n=J(this,r),a=V[n],0<_[n]&&(a+=Y(this,_[n])),i>=h&&(this.b=i,e=this.f(),i=this.b);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},M.prototype.I=function(t,r){var e=this.a,i=this.b;this.u=t;for(var n,s,a,o,h=e.length;256!==(n=J(this,t));)if(256>n)i>=h&&(h=(e=this.f()).length),e[i++]=n;else for(o=j[s=n-257],0<W[s]&&(o+=Y(this,W[s])),n=J(this,r),a=V[n],0<_[n]&&(a+=Y(this,_[n])),i+o>h&&(h=(e=this.f()).length);o--;)e[i]=e[i++-a];for(;8<=this.e;)this.e-=8,this.c--;this.b=i},M.prototype.f=function(){var t,r,e=new(s?Uint8Array:Array)(this.b-32768),i=this.b-32768,n=this.a;if(s)e.set(n.subarray(32768,e.length));else for(t=0,r=e.length;t<r;++t)e[t]=n[t+32768];if(this.l.push(e),this.q+=e.length,s)n.set(n.subarray(i,i+32768));else for(t=0;32768>t;++t)n[t]=n[i+t];return this.b=32768,n},M.prototype.J=function(t){var r,e,i,n=this.input.length/this.c+1|0,a=this.input,o=this.a;return t&&("number"==typeof t.v&&(n=t.v),"number"==typeof t.F&&(n+=t.F)),2>n?e=(i=(a.length-this.c)/this.u[2]/2*258|0)<o.length?o.length+i:o.length<<1:e=o.length*n,s?(r=new Uint8Array(e)).set(o):r=o,this.a=r},M.prototype.t=function(){var t,r,e,i,n,a=0,o=this.a,h=this.l,c=new(s?Uint8Array:Array)(this.q+(this.b-32768));if(0===h.length)return s?this.a.subarray(32768,this.b):this.a.slice(32768,this.b);for(r=0,e=h.length;r<e;++r)for(i=0,n=(t=h[r]).length;i<n;++i)c[a++]=t[i];for(r=32768,e=this.b;r<e;++r)c[a++]=o[r];return this.l=[],this.buffer=c},M.prototype.H=function(){var t,r=this.b;return s?this.B?(t=new Uint8Array(r)).set(this.a.subarray(0,r)):t=this.a.subarray(0,r):(this.a.length>r&&(this.a.length=r),t=this.a),this.buffer=t},X.prototype.p=function(){var r,e=this.input;return r=this.A.p(),this.c=this.A.c,this.M&&((e[this.c++]<<24|e[this.c++]<<16|e[this.c++]<<8|e[this.c++])>>>0!==K(r)&&t(Error("invalid adler-32 checksum"))),r};var Q=8;function tt(t,r){this.input=t,this.a=new(s?Uint8Array:Array)(32768),this.h=rt.k;var e,i={};for(e in!r&&(r={})||"number"!=typeof r.compressionType||(this.h=r.compressionType),r)i[e]=r[e];i.outputBuffer=this.a,this.z=new A(this.input,i)}var rt=p;function et(t,r){var e,i,s,a;if(Object.keys)e=Object.keys(r);else for(i in e=[],s=0,r)e[s++]=i;for(s=0,a=e.length;s<a;++s)n(t+"."+(i=e[s]),r[i])}tt.prototype.j=function(){var r,e,i,n,a,o,h,c=0;switch(h=this.a,r=Q){case Q:e=Math.LOG2E*Math.log(32768)-8;break;default:t(Error("invalid compression method"))}switch(i=e<<4|r,h[c++]=i,r){case Q:switch(this.h){case rt.NONE:a=0;break;case rt.r:a=1;break;case rt.k:a=2;break;default:t(Error("unsupported compression type"))}break;default:t(Error("invalid compression method"))}return n=a<<6|0,h[c++]=n|31-(256*i+n)%31,o=K(this.input),this.z.b=c,c=(h=this.z.j()).length,s&&((h=new Uint8Array(h.buffer)).length<=c+4&&(this.a=new Uint8Array(h.length+4),this.a.set(h),h=this.a),h=h.subarray(0,c+4)),h[c++]=o>>24&255,h[c++]=o>>16&255,h[c++]=o>>8&255,h[c++]=255&o,h},n("Zlib.Inflate",X),n("Zlib.Inflate.prototype.decompress",X.prototype.p),et("Zlib.Inflate.BufferType",{ADAPTIVE:F.C,BLOCK:F.D}),n("Zlib.Deflate",tt),n("Zlib.Deflate.compress",(function(t,r){return new tt(t,r).j()})),n("Zlib.Deflate.prototype.compress",tt.prototype.j),et("Zlib.Deflate.CompressionType",{NONE:rt.NONE,FIXED:rt.r,DYNAMIC:rt.k})}.call(self);class l{constructor(t=257){this.gridSize=t;const r=t-1;if(r&r-1)throw new Error(\`Expected grid size to be 2^n+1, got ${ji}t}.\`);this.numTriangles=r*r*2-2,this.numParentTriangles=this.numTriangles-r*r,this.indices=new Uint32Array(this.gridSize*this.gridSize),this.coords=new Uint16Array(4*this.numTriangles);for(let t=0;t<this.numTriangles;t++){let e=t+2,i=0,n=0,s=0,a=0,o=0,h=0;for(1&e?s=a=o=r:i=n=h=r;(e>>=1)>1;){const t=i+s>>1,r=n+a>>1;1&e?(s=i,a=n,i=o,n=h):(i=s,n=a,s=o,a=h),o=t,h=r}const c=4*t;this.coords[c+0]=i,this.coords[c+1]=n,this.coords[c+2]=s,this.coords[c+3]=a}}createTile(t){return new d(t,this)}}class d{constructor(t,r){const e=r.gridSize;if(t.length!==e*e)throw new Error(\`Expected terrain data of length ${ji}e*e} (${ji}e} x ${ji}e}), got ${ji}t.length}.\`);this.terrain=t,this.martini=r,this.errors=new Float32Array(t.length),this.update()}update(){const{numTriangles:t,numParentTriangles:r,coords:e,gridSize:i}=this.martini,{terrain:n,errors:s}=this;for(let a=t-1;a>=0;a--){const t=4*a,o=e[t+0],h=e[t+1],c=e[t+2],f=e[t+3],u=o+c>>1,l=h+f>>1,d=u+l-h,y=l+o-u,A=(n[h*i+o]+n[f*i+c])/2,w=l*i+u,b=Math.abs(A-n[w]);if(s[w]=Math.max(s[w],b),a<r){const t=(h+y>>1)*i+(o+d>>1),r=(f+y>>1)*i+(c+d>>1);s[w]=Math.max(s[w],s[t],s[r])}}}getMesh(t=0){const{gridSize:r,indices:e}=this.martini,{errors:i}=this;let n=0,s=0;const a=r-1;function o(a,h,c,f,u,l){const d=a+c>>1,y=h+f>>1;Math.abs(a-u)+Math.abs(h-l)>1&&i[y*r+d]>t?(o(u,l,a,h,d,y),o(c,f,u,l,d,y)):(e[h*r+a]=e[h*r+a]||++n,e[f*r+c]=e[f*r+c]||++n,e[l*r+u]=e[l*r+u]||++n,s++)}e.fill(0),o(0,0,a,a,a,0),o(a,a,0,0,0,a);const h=new Uint16Array(2*n),c=new Uint32Array(3*s);let f=0;function u(n,s,a,o,l,d){const y=n+a>>1,A=s+o>>1;if(Math.abs(n-l)+Math.abs(s-d)>1&&i[A*r+y]>t)u(l,d,n,s,y,A),u(a,o,l,d,y,A);else{const t=e[s*r+n]-1,i=e[o*r+a]-1,u=e[d*r+l]-1;h[2*t]=n,h[2*t+1]=s,h[2*i]=a,h[2*i+1]=o,h[2*u]=l,h[2*u+1]=d,c[f++]=t,c[f++]=i,c[f++]=u}}return u(0,0,a,a,a,0),u(a,a,0,0,0,a),{vertices:h,triangles:c}}getMeshWithSkirts(t=0,r){const{gridSize:e,indices:i}=this.martini,{errors:n}=this;let s=0,a=0;const o=e-1;let h,c,f=0;const u=[],l=[],d=[],y=[];function A(r,w,b,p,v,k){const m=r+b>>1,U=w+p>>1;Math.abs(r-v)+Math.abs(w-k)>1&&n[U*e+m]>t?(A(v,k,r,w,m,U),A(b,p,v,k,m,U)):(h=w*e+r,c=p*e+b,f=k*e+v,0===i[h]&&(0===r?u.push(s):r===o&&l.push(s),0===w?d.push(s):w===o&&y.push(s),i[h]=++s),0===i[c]&&(0===b?u.push(s):b===o&&l.push(s),0===p?d.push(s):p===o&&y.push(s),i[c]=++s),0===i[f]&&(0===v?u.push(s):v===o&&l.push(s),0===k?d.push(s):k===o&&y.push(s),i[f]=++s),a++)}let w;i.fill(0),A(0,0,o,o,o,0),A(o,o,0,0,0,o),w=r?2*(s+3*u.length-2+3*l.length-2+3*d.length-2+3*y.length-2):2*(s+u.length+l.length+d.length+y.length);const b=3*(a+2*(u.length-1)+2*(l.length-1)+2*(d.length-1)+2*(y.length-1)),p=new Uint16Array(w),v=new Uint32Array(b);let k=0;function m(r,s,a,o,h,c){const f=r+a>>1,u=s+o>>1;if(Math.abs(r-h)+Math.abs(s-c)>1&&n[u*e+f]>t)m(h,c,r,s,f,u),m(a,o,h,c,f,u);else{const t=i[s*e+r]-1,n=i[o*e+a]-1,f=i[c*e+h]-1;p[2*t]=r,p[2*t+1]=s,p[2*n]=a,p[2*n+1]=o,p[2*f]=h,p[2*f+1]=c,v[k++]=t,v[k++]=n,v[k++]=f}}m(0,0,o,o,o,0),m(o,o,0,0,0,o),u.sort((t,r)=>p[2*t+1]-p[2*r+1]),l.sort((t,r)=>p[2*r+1]-p[2*t+1]),d.sort((t,r)=>p[2*r]-p[2*t]),y.sort((t,r)=>p[2*t]-p[2*r]);let U,g,x,E,T=2*s,M=0;function S(t){M=t.length;for(let e=0;e<M-1;e++)U=t[e],g=t[e+1],x=T/2,E=(T+(r?6:2))/2,p[T++]=2*U,p[T++]=2*U+1,r&&(p[T++]=2*U,p[T++]=2*U+1,p[T++]=2*g,p[T++]=2*g+1),r?(v[k++]=x+1,v[k++]=x,v[k++]=x+2,v[k++]=x,v[k++]=E,v[k++]=x+2):(v[k++]=U,v[k++]=x,v[k++]=g,v[k++]=x,v[k++]=E,v[k++]=g);p[T++]=2*t[M-1],p[T++]=2*t[M-1]+1}S(u);const I=T;S(l);const F=T;S(d);const D=T;S(y);return{vertices:p,triangles:v,numVerticesWithoutSkirts:s,numTrianglesWithoutSkirts:a,leftSkirtIndex:I,rightSkirtIndex:F,bottomSkirtIndex:D,topSkirtIndex:T}}}const y={};let A,w=null,b=null;const p={},v=64,k=64,m=3,U=-1e3,g=.001,x=256,E=4,T=.002,M={cesium_request_token:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"},tianditu:{"Accept-Encoding":"gzip, deflate, br"},cesium:{"Accept-Encoding":"gzip, deflate, br",Accept:"application/vnd.quantized-mesh,application/octet-stream;q=0.9,*/*;q=0.01"},mapbox:{Accept:"image/webp,*/*"}};M["cesium-ion"]=M.cesium;let S=null,I=null;function F(t,r){const e=function(t){if(t.length<1e3)return null;const r=new Zlib.Inflate(t);return r?r.decompress():null}(new Uint8Array(t));if(!e)throw new Error((i=new Uint8Array(t),D.decode(i)));var i;const n=function(t,r){const e=r,i=r,n=e+1,s=i+1,a=m,o=U,h=g,c=x,f=T,u=new Float32Array(n*s);let l=0,d=1/0,y=-1/0;for(let r=0;r<n;r++){const n=r>=i?i-1:r;for(let r=0;r<s;r++){let i=0;const s=n*(4*e)+4*(r>=e?e-1:r);for(let r=0;r<a;r++)i=i*c+t[s+r];i=1*(i*h+o),i-=f,u[l]=i,i<d&&(d=i),i>y&&(y=i),l++}}return{data:u,min:d,max:y}}(function(t){const r=t,e=v,i=k,n=new Uint8Array(e*i*E);let s,a,o,h,c;for(let t=0;t<i;t++)for(let f=0;f<e;f++){h=parseInt(149*t/(i-1)),c=parseInt(149*f/(e-1)),a=2*(150*h+c),s=r[a]+256*r[a+1],(s>1e4||s<-2e3)&&(s=0),o=4*(t*e+f);const u=(s+1e3)/g,l=x;n[o]=u/(l*l),n[o+1]=(u-n[o]*l*l)/l,n[o+2]=u-n[o]*l*l-n[o+1]*l,n[o+3]=255}return n}(e),r-1);return n.width=n.height=r,n}const D=new TextDecoder("utf-8");function z(t){return t>>1^-(1&t)}const C=[];function N(t){let r=0;const e=3*Float64Array.BYTES_PER_ELEMENT,i=3*Uint16Array.BYTES_PER_ELEMENT;let n=Uint16Array.BYTES_PER_ELEMENT;const s=new DataView(t);r+=e;const a=s.getFloat32(r,!0);r+=Float32Array.BYTES_PER_ELEMENT;const o=s.getFloat32(r,!0);r+=Float32Array.BYTES_PER_ELEMENT,r+=e;const h=s.getFloat64(r,!0);r+=Float64Array.BYTES_PER_ELEMENT,r+=e;const c=s.getUint32(r,!0);r+=Uint32Array.BYTES_PER_ELEMENT;const f=new Uint16Array(t,r,3*c);r+=c*i,c>65536&&(n=Uint32Array.BYTES_PER_ELEMENT);!function(t,r,e){const i=t.length;let n=0,s=0,a=0;for(let o=0;o<i;++o)n+=z(t[o]),s+=z(r[o]),t[o]=n,r[o]=s,e&&(a+=z(e[o]),e[o]=a)}(f.subarray(0,c),f.subarray(c,2*c),f.subarray(2*c,3*c)),r%n!=0&&(r+=n-r%n);const u=s.getUint32(r,!0);r+=Uint32Array.BYTES_PER_ELEMENT;const l=c>65536?new Uint32Array(t,r,3*u):new Uint16Array(t,r,3*u);let d=0;const y=l.length;for(let t=0;t<y;++t){const r=l[t];l[t]=d-r,0===r&&++d}const A={minimumHeight:a,maximumHeight:o,quantizedVertices:f,indices:l}.quantizedVertices,w=A.length/3,b=A.subarray(0,w),p=A.subarray(w,2*w),v=A.subarray(2*w,3*w),k=C;for(let t=0;t<w;++t){const r=b[t]/32767,e=p[t]/32767,i=(m=a,U=o,(1-(g=v[t]/32767))*m+g*U);k[3*t]=r,k[3*t+1]=1-e,k[3*t+2]=i}var m,U,g;return{positions:k,radius:h,min:a,max:o,indices:l}}const O=[],j=[],q=[],W=[],Z=[];class V{constructor(t,r,e,i,n){this.p0=[],this.p1=[],this.p2=[],this.normal=[],this.min=[],this.max=[],this.set(t,r,e,i,n)}set(t,r,e,i,o){this.radius=o;let h=3*r,c=3*r+1,f=3*r+2;this.p0[0]=t[h]*o,this.p0[1]=t[c]*o,this.p0[2]=t[f],h=3*e,c=3*e+1,f=3*e+2,this.p1[0]=t[h]*o,this.p1[1]=t[c]*o,this.p1[2]=t[f],h=3*i,c=3*i+1,f=3*i+2,this.p2[0]=t[h]*o,this.p2[1]=t[c]*o,this.p2[2]=t[f],this.min[0]=Math.min(this.p0[0],this.p1[0],this.p2[0]),this.min[1]=Math.min(this.p0[1],this.p1[1],this.p2[1]),this.max[0]=Math.max(this.p0[0],this.p1[0],this.p2[0]),this.max[1]=Math.max(this.p0[1],this.p1[1],this.p2[1]);const u=a(O,this.p1,this.p0),l=a(j,this.p2,this.p1);this.normal=n(this.normal,s(this.normal,u,l))}contains(t,r){if(t<this.min[0]||t>this.max[0]||r<this.min[1]||r>this.max[1])return!1;c(q,this.p0[0],this.p0[1]),c(W,this.p1[0],this.p1[1]),c(Z,this.p2[0],this.p2[1]);const e=H(q[0],q[1],W[0],W[1],Z[0],Z[1]);return H(t,r,q[0],q[1],Z[0],Z[1])+H(t,r,q[0],q[1],W[0],W[1])+H(t,r,W[0],W[1],Z[0],Z[1])-e<=1e-4}getHeight(t,r){const e=this.normal;return this.p0[2]-((t-this.p0[0])*e[0]+(r-this.p0[1])*e[1])/e[2]}}let $=null;function _(t,r,e){if($&&$.contains(r,e))return $.getHeight(r,e);for(let i=0;i<t.length;i++)if(t[i].contains(r,e))return $=t[i],t[i].getHeight(r,e);return 0}const B=[];function H(t,r,e,i,n,s){return.5*Math.abs(t*i+e*s+n*r-t*s-e*r-n*i)}function L(t,r,e,i,n,s){"cesium-ion"===e&&(r.Authorization="Bearer "+S),function(t,r,e){const i={method:"GET",referrer:e,headers:r},n=u.getArrayBuffer(t,i),s=n.xhr;return p[t]=s,n.then(r=>(delete p[t],r))}(t,r,origin).then(t=>{if(!t||t.message)s(t?{empty:!0,originalError:t}:{error:{canceled:!0}});else{const r=t.data;let a=null;if("tianditu"===e){const t=F(r,i);P(n,t,i,null,!0,s)}else if("cesium-ion"===e||"cesium"===e){a=N(r);const t=function(t,r){const{positions:e,min:i,max:n,indices:s,radius:a}=t,o=[];let h=0;for(let t=0;t<s.length;t+=3){let r=B[h];r?r.set(e,s[t],s[t+1],s[t+2],2*a):r=B[h]=new V(e,s[t],s[t+1],s[t+2],2*a),h++,o.push(r)}const c=new Float32Array(r*r);h=0;for(let t=0;t<r;t++)for(let e=0;e<r;e++)c[h++]=_(o,e/r*a*2,t/r*a*2);return{data:c,min:i,max:n,width:r,height:r}}(a,i);P(n,t,i,null,!0,s)}else"mapbox"===e&&(a=function(t){const r=new self.Blob([new Uint8Array(t)]);return self.createImageBitmap(r)}(r),a.then(t=>{const r=function(t,r){const{data:e,width:i}=t;let n=1/0,s=-1/0;const a=new Float32Array(r*r),o=Math.round(i/r);for(let t=0;t<r;t++)for(let h=0;h<r;h++){const c=t+h*r;let f=0,u=0;const l=t,d=h;for(let t=0;t<o;t++)for(let r=0;r<o;r++){let n=l*o+t,s=d*o+r;s>i-1&&(s=i-1),n>i-1&&(n=i-1);const a=n+s*i,h=e[4*a],c=e[4*a+1],y=e[4*a+2];0===e[4*a+3]?u+=1:f+=.1*(256*h*256+256*c+y)-1e4}f/=o*o-u||1,f>s&&(s=f),f<n&&(n=f),a[c]=f}return{data:a,width:r,height:r,min:n,max:s}}(function(t){const{width:r,height:e}=t;w||(w=new OffscreenCanvas(1,1),b=w.getContext("2d",{willReadFrequently:!0}));return w.width=r,w.height=e,b.drawImage(t,0,0,r,e),b.getImageData(0,0,r,e)}(t),i);P(n,r,i,t,!0,s)}))}}).catch(r=>{delete p[t],s({empty:!0,originalError:r})})}function P(t,r,e,i,n,s){const a=function(t,r,e,i){let n=y[e];n||(n=y[e]=new l(e));const s=n.createTile(r),a=i?s.getMeshWithSkirts(t,!0):s.getMesh(t),{triangles:o,vertices:h,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:u,topSkirtIndex:d}=a;let{numVerticesWithoutSkirts:A,numTrianglesWithoutSkirts:w}=a;A||(A=h.legnth/3,w=o.length/3);const b=h.length/2,p=new Float32Array(3*b),v=new Float32Array(2*b);let k=1/0,m=-1/0;const U=e-1;for(let t=0;t<b;t++){const i=h[2*t],n=h[2*t+1];if(t>=A){const r=i/2*3;let e,n=.001;(t-(t<c/2?A:t<f/2?c/2:t<u/2?f/2:u/2))%3==0?(e=0,n=0):e=p[r+2];p[3*t]=p[r],p[3*t+1]=p[r+1],p[3*t+2]=e,v[2*t]=p[r]/U+n,v[2*t+1]=-p[r+1]/U+n}else p[3*t]=1*i,p[3*t+1]=1*-n,p[3*t+2]=r[n*e+i],v[2*t]=i/U,v[2*t+1]=n/U;const s=p[p.length-1];s<k&&(k=s),s>m&&(m=s)}return{positions:p,texcoords:v,triangles:o,leftSkirtIndex:c,rightSkirtIndex:f,bottomSkirtIndex:u,topSkirtIndex:d,numTrianglesWithoutSkirts:w,numVerticesWithoutSkirts:A,minHeight:k,maxHeight:m,terrainWidth:e}}(t,r.data,e,n),o=[a.positions.buffer,a.texcoords.buffer,a.triangles.buffer];i&&o.push(i);const h={mesh:a};h.image=i,h.data=r,o.push(r.data.buffer),s(h,o)}t.initialize=function(){},t.onmessage=function(t,r){const e=t.data;var i;"addLayer"===e.command||"removeLayer"===e.command?(A=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:A,params:"ok",callback:t.callback})):"fetchTerrain"===e.command?function(t,r){const{url:e,origin:i,type:n,accessToken:s,terrainWidth:a,error:o}=t,h=t.headers||M[n];if("tianditu"===n)L(e,h,n,a,o,r);else if("cesium-ion"===n){const c=t.cesiumIonTokenURL+s;S?L(e,h,n,a,o,r):(I||(I=fetch(c,{responseType:"json",method:"GET",referrer:i,headers:{Accept:"application/json,*/*;q=0.01","Accept-Encoding":"gzip, deflate, br"}}).then(t=>t.json()).then(t=>{S=t.accessToken,I=null})),I.then(()=>{L(e,h,n,a,o,r)}))}else("cesium"===n||"mapbox"===n)&&L(e,h,n,a,o,r)}(e.params,(t,e)=>{r(t.error,t,e)}):"abortTerrain"===e.command&&(i=e.params.url,p[i]&&(p[i].abort(),delete p[i]))}}`;a["O"]("@maptalks/terrain",Vi),"undefined"!==typeof console&&console.log("@maptalks/gl v0.97.4")}).call(this,n("c8ba"))},ea86:function(t,e,n){"use strict";(function(t){var e=n("18b7"),r=n("e470"),i=n("f980"),s=n("31d3"),o=n("f139"),a=n("70f3");
/*!
 * @maptalks/gltf-layer v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.org
 */
const l='function(t){var e="undefined"!=typeof Float32Array?Float32Array:Array;function n(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3],c=e[4],a=e[5],u=e[6],h=e[7],f=e[8],l=e[9],d=e[10],m=e[11],w=e[12],g=e[13],p=e[14],y=e[15],_=n[0],b=n[1],A=n[2],I=n[3];return t[0]=_*r+b*c+A*f+I*w,t[1]=_*s+b*a+A*l+I*g,t[2]=_*i+b*u+A*d+I*p,t[3]=_*o+b*h+A*m+I*y,_=n[4],b=n[5],A=n[6],I=n[7],t[4]=_*r+b*c+A*f+I*w,t[5]=_*s+b*a+A*l+I*g,t[6]=_*i+b*u+A*d+I*p,t[7]=_*o+b*h+A*m+I*y,_=n[8],b=n[9],A=n[10],I=n[11],t[8]=_*r+b*c+A*f+I*w,t[9]=_*s+b*a+A*l+I*g,t[10]=_*i+b*u+A*d+I*p,t[11]=_*o+b*h+A*m+I*y,_=n[12],b=n[13],A=n[14],I=n[15],t[12]=_*r+b*c+A*f+I*w,t[13]=_*s+b*a+A*l+I*g,t[14]=_*i+b*u+A*d+I*p,t[15]=_*o+b*h+A*m+I*y,t}function r(){var t=new e(3);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,n,r){var s=new e(3);return s[0]=t,s[1]=n,s[2]=r,s}function i(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function o(t,e,n,r){return t[0]=e,t[1]=n,t[2]=r,t}function c(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function a(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function u(t,e,n,r,s){return t[0]=e,t[1]=n,t[2]=r,t[3]=s,t}function h(t,e,n){var r=e[0],s=e[1],i=e[2],o=e[3];return t[0]=n[0]*r+n[4]*s+n[8]*i+n[12]*o,t[1]=n[1]*r+n[5]*s+n[9]*i+n[13]*o,t[2]=n[2]*r+n[6]*s+n[10]*i+n[14]*o,t[3]=n[3]*r+n[7]*s+n[11]*i+n[15]*o,t}function f(){var t=new e(4);return e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function l(t,e,n,r){var s=e[0],i=e[1],o=e[2],c=e[3],a=n[0],u=n[1],h=n[2],f=n[3],l=void 0,d=void 0,m=void 0,w=void 0,g=void 0;return(d=s*a+i*u+o*h+c*f)<0&&(d=-d,a=-a,u=-u,h=-h,f=-f),1-d>1e-6?(l=Math.acos(d),m=Math.sin(l),w=Math.sin((1-r)*l)/m,g=Math.sin(r*l)/m):(w=1-r,g=r),t[0]=w*s+g*a,t[1]=w*i+g*u,t[2]=w*o+g*h,t[3]=w*c+g*f,t}r(),function(){var t,n=(t=new e(4),e!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();var d,m=function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t};r(),s(1,0,0),s(0,1,0),f(),f(),d=new e(9),e!=Float32Array&&(d[1]=0,d[2]=0,d[3]=0,d[5]=0,d[6]=0,d[7]=0),d[0]=1,d[4]=1,d[8]=1;\n/*!\n   * @maptalks/gltf-loader v0.97.2\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.org\n   */\nlet w=0;function g(t){return null==t}function p(t){return!g(t)}function y(t){return!g(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function _(t){for(let e=1;e<arguments.length;e++){const n=arguments[e];for(const e in n)t[e]=n[e]}return t}function b(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array}throw new Error("unsupported bufferView\'s component type: "+t)}function A(t){return 0===t.indexOf("data:")&&t.indexOf("base64,")>0}function I(t){const e=function(t){return"undefined"!=typeof self?self.atob(t):window.atob(t)}(t.substring(t.indexOf(",")+1)),n=e.length,r=new Uint8Array(n);for(let t=0;t<n;t++)r[t]=e.charCodeAt(t);return r.buffer}const T=[],x=[],M=[],v=[0,0,0],O=function(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}([]),E=[1,1,1];function P(t,e,n,r,s,i,o){const c=b(o);if((0===s||s===r*c.BYTES_PER_ELEMENT)&&i%c.BYTES_PER_ELEMENT==0){const s=new c(e,i,n*r);return t.set(s),t}0===s&&(s=r*c.BYTES_PER_ELEMENT);const a=new Uint8Array(r*c.BYTES_PER_ELEMENT);for(let o=0;o<n;o++){let n=null;const u=new Uint8Array(e,s*o+i,r*c.BYTES_PER_ELEMENT);a.set(u),n=new c(a.buffer,0,r);for(let e=0;e<r;e++)t[o*r+e]=n[e]}return t}const k="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;function N(t,e,n){const r=new Uint8Array(t,e,n);return k.decode(r)}const S={get:function(t,e={},n){e||(e={});const r=new AbortController,s=r.signal,i=_({},e);i.signal=s,i.method||(i.method="GET"),i.referrerPolicy=i.referrerPolicy||"origin","undefined"==typeof window||i.referrer||(i.referrer=window.location.href),n&&(t=n(t));const o=fetch(t,i).then(t=>{const n=this.t(t,e.responseType);return n.message?n:n.then(n=>"arraybuffer"===e.responseType?{data:n,cacheControl:t.headers.get("Cache-Control"),expires:t.headers.get("Expires"),contentType:t.headers.get("Content-Type")}:n).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t})}).catch(t=>{if(!t.code||t.code!==DOMException.ABORT_ERR)throw t});return o.xhr=r,o},t:(t,e)=>200!==t.status?{status:t.status,statusText:t.statusText,message:`incorrect http request with status code(${t.status}): ${t.statusText}`}:"arraybuffer"===e?t.arrayBuffer():"json"===e?t.json():t.text(),getArrayBuffer:(t,e={},n)=>(e||(e={}),e.responseType="arraybuffer",S.get(t,e,n)),getJSON:function(t,e={},n){return e&&e.jsonp?S.jsonp(t):((e=e||{}).responseType="json",S.get(t,e,n))},jsonp:function(t){const e="_maptalks_jsonp_"+w++;t.match(/\\?/)?t+="&callback="+e:t+="?callback="+e;let n=document.createElement("script");return n.type="text/javascript",n.src=t,new Promise(t=>{window[e]=function(r){document.getElementsByTagName("head")[0].removeChild(n),n=null,delete window[e],t(r)},document.getElementsByTagName("head")[0].appendChild(n)})}};class B{constructor(t,e,n,r,s){this.s=t,this.decoders=e,this.i=n,this.images={},this.o={},this.u=r||{},this.h=s}requestImageFromBufferURI(t,e,n){if(this.buffers[t.id]){const r=this.buffers[t.id],s=this.l(e,r);return this.getImageByBuffer(s,n)}if(this.o[t.id])return this.o[t.id].then(()=>{const r=this.buffers[t.id],s=this.l(e,r);return this.getImageByBuffer(s,n)});if(A(t.uri)){const r=this.buffers[t.id]=I(t.uri),s=this.l(e,r);return this.getImageByBuffer(s,n)}let r;const s=t.uri.indexOf("blob:")>=0;return r=t.uri.indexOf("://")>0||s?t.uri:this.rootPath+"/"+t.uri,this.o[t.id]=S.getArrayBuffer(r,this.u,this.h).then(r=>{const s=this.buffers[t.id]=r.data,i=this.l(e,s);return this.getImageByBuffer(i,n)})}getImageByBuffer(t,e){if(this.images[e.id])return Promise.resolve(this.images[e.id]);const n=this.decoders;return n[e.mimeType]?n[e.mimeType](t,{supportedFormats:this.i}):"image/crn"===e.mimeType||"image/ktx2"===e.mimeType||"image/cttf"===e.mimeType?(console.warn("missing transcoder for "+e.mimeType,", visit https://maptalks.com/docs/transcoders for details"),Promise.resolve(null)):this.m(e.id,t)}requestExternalImage(t){if(this.images[t.id])return Promise.resolve(this.images[t.id]);const e=0===t.uri.indexOf("data:image/")?t.uri:this.rootPath+"/"+t.uri;return this.o[t.id]?this.o[t.id].then(()=>this.images[t.id]):this.o[t.id]=this.m(t.id,e)}m(t,e){return new Promise((n,r)=>{let s=e;this.h&&(s=this.h(e)),this.s(s,this.u,(s,i)=>{s?r(s):(URL.revokeObjectURL(e),this.images[t]=i,n(this.images[t]))})})}}const R=["SCALAR",1,"VEC2",2,"VEC3",3,"VEC4",4,"MAT2",4,"MAT3",9,"MAT4",16],U=[];class C{constructor(t,e,n,r,s){this.rootPath=t,this.gltf=e,this.g=!1,this.glbBuffer=n,this.buffers={},this.requests={},this.accessors={},this.p(),this.u=r,this.h=s}_(t,e){const n=this.gltf,r=n.accessors[e];if(void 0===r.bufferView)return this.accessors[r.id]=this.A(t,e,null,0),Promise.resolve(this.accessors[r.id]);if(r&&this.accessors[r.id])return Promise.resolve(this.accessors[r.id]);const s=n.bufferViews[r.bufferView];return this.I(s).then(n=>{const{buffer:s,byteOffset:i}=n;return this.accessors[r.id]=this.A(t,e,s,i)})}I(t){const e=this.gltf.buffers[t.buffer];if(this.buffers[e.id]){const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})}if(this.requests[e.id])return this.requests[e.id].then(()=>{const t=this.buffers[e.id];return Promise.resolve({buffer:t,byteOffset:0})});if("binary_glTF"!==t.buffer&&"KHR_binary_glTF"!==t.buffer&&e.uri){if(A(e.uri)){const t=this.buffers[e.id]=I(e.uri);return Promise.resolve({buffer:t,byteOffset:0})}let t;const n=e.uri.indexOf("blob:")>=0;return t=e.uri.indexOf("://")>0||n?e.uri:this.rootPath+"/"+e.uri,this.requests[e.id]=S.getArrayBuffer(t,this.u,!n&&this.h).then(r=>(n&&URL.revokeObjectURL(t),{buffer:this.buffers[e.id]=r.data,byteOffset:0}))}return Promise.resolve({buffer:this.glbBuffer.buffer,byteOffset:this.glbBuffer.byteOffset})}A(t,e,n,r=0){const s=this.gltf,i=s.accessors[e],o=void 0!==i.bufferView?s.bufferViews[i.bufferView]:{},c=(o.byteOffset||0)+r,a=this.T(i.type),u=b(i.componentType),f=o.byteStride||0,l={array:void 0,name:t,accessorName:e,byteLength:i.count*a*u.BYTES_PER_ELEMENT,componentType:i.componentType,count:i.count,type:i.type,itemSize:a,max:i.max,min:i.min,extensions:i.extensions};if(i.min&&(l.min=i.min),i.max&&(l.max=i.max),n)if(this.g)l.byteStride=f,l.byteOffset=c+(i.byteOffset||0),!f||f===a*u.BYTES_PER_ELEMENT||"indices"===t||"input"===t||"output"===t||t.indexOf("morph")>=0?(l.array=this.M(n,i.count,a,c+(i.byteOffset||0),u),l.array.buffer.byteLength===l.byteLength&&(l.byteOffset=0)):l.array=new Uint8Array(n,c,o.byteLength);else if(i.interleaved){l.byteStride=0,l.byteOffset=0;const t=new u(i.count*a);if(l.array=P(t,n,i.count,a,f,c+(i.byteOffset||0),i.componentType),l.extensions&&l.extensions.WEB3D_quantized_attributes&&a>2){const t=new Float32Array(l.array.length),{decodeMatrix:e}=l.extensions.WEB3D_quantized_attributes;for(let n=0;n<l.array.length;n+=a){U[0]=l.array[n],U[1]=l.array[n+1],U[2]=l.array[n+2],U[3]=1;const r=h(U,U,e);t[n]=r[0],t[n+1]=r[1],t[n+2]=r[2]}l.componentType=5126,l.array=t}}else l.byteStride=0,l.array=this.M(n,i.count,a,c+(i.byteOffset||0),u),l.byteOffset=l.array.byteOffset;else{l.array=new u(i.count);const t=l.min||l.max;t&&(l.array[0]=t[0],l.array[1]=t[1],l.array[2]=t[2])}return l}p(){const t=this.gltf.accessors;if(Array.isArray(t))for(let e=0;e<t.length;e++)for(let n=0;n<t.length;n++)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0);else for(const e in t)for(const n in t)e!==n&&t[e].bufferView===t[n].bufferView&&(t[e].interleaved=t[n].interleaved=!0)}M(t,e,n,r,s){return r%s.BYTES_PER_ELEMENT!=0&&(t=t.slice(r,r+e*n*s.BYTES_PER_ELEMENT),r=0),new s(t,r,n*e)}T(t){const e=R.indexOf(t);return R[e+1]}requestKHRTechniquesWebgl(t){const{shaders:e}=t,n=e.map(t=>{if(void 0!==t.bufferView){const e=this.gltf.bufferViews[t.bufferView],{byteLength:n}=e;return this.I(e).then(r=>{const{buffer:s,byteOffset:i}=r,o=N(s,i+(e.byteOffset||0),n);return t.content=o,t})}if(t.uri){if(A(t.uri)){const e=I(t.uri),n=N(e,0,e.byteLength);return t.content=n,Promise.resolve(t)}{const e=this.rootPath+"/"+t.uri;return S.get(e,this.u,this.h).then(e=>(t.content=e,t))}}return Promise.resolve(t)});return Promise.all(n).then(()=>t)}}class L extends B{constructor(t,e,n,r,s,i,o,c){super(r,s,i,o,c),this.rootPath=t,this.gltf=e,this.requests={},this.buffers={},this.glbBuffer=n,this.accessor=new C(t,e,n,o,c)}iterate(t,e){const n=this.gltf[e];if(!n)return;let r=0;for(const e in n)t(e,n[e],r++)}createNode(t){const e={};if(p(t.name)&&(e.name=t.name),p(t.children)&&(e.children=t.children),p(t.jointName)&&(e.jointName=t.jointName),p(t.matrix)&&(e.matrix=t.matrix),p(t.rotation)&&(e.rotation=t.rotation),p(t.scale)&&(e.scale=t.scale),p(t.translation)&&(e.translation=t.translation),p(t.extras)&&(e.extras=t.extras),p(t.meshes)&&(e.mesh=t.meshes[0]),e.translation||e.rotation||e.scale){const t=function(t,e){if(e.matrix)return e.matrix;if(e.translation||e.scale||e.rotation){const r=function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}(T,e.translation||v),s=function(t,e){var n=e[0],r=e[1],s=e[2],i=e[3],o=n+n,c=r+r,a=s+s,u=n*o,h=r*o,f=r*c,l=s*o,d=s*c,m=s*a,w=i*o,g=i*c,p=i*a;return t[0]=1-f-m,t[1]=h+p,t[2]=l-g,t[3]=0,t[4]=h-p,t[5]=1-u-m,t[6]=d+w,t[7]=0,t[8]=l+g,t[9]=d-w,t[10]=1-u-f,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(x,e.rotation||O),i=function(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(M,e.scale||E);return n(i,s,i),n(t,r,i)}return function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}(t)}([],e);delete e.translation,delete e.rotation,delete e.scale,e.matrix=t}return e}v(t){const e={};for(const n in t){const r=t[n];let s,i;r.instanceTechnique&&r.instanceTechnique.values?(s=r.instanceTechnique,i=s.values.diffuse):(s=r,i=s.values.tex||s.values.diffuseTex||s.values.diffuse);const o={baseColorTexture:{index:i}};r.name&&(o.name=r.name),r.extensions&&(o.extensions=r.extensions),r.extras&&(o.extras=r.extras),e[n]=o}return e}O(t){if(t.bufferView||t.extensions&&(t.extensions.KHR_binary_glTF||t.extensions.binary_glTF)){const e=t.bufferView?t:t.extensions.KHR_binary_glTF||t.extensions.binary_glTF;t.extensions&&(t.mimeType=e.mimeType,t.width=e.width,t.height=e.height);const n=this.gltf.bufferViews[e.bufferView],r=(n.byteOffset||0)+this.glbBuffer.byteOffset,s=n.byteLength,i=this.buffers[e.bufferView]=new Uint8Array(this.glbBuffer.buffer,r,s);return this.getImageByBuffer(i,t)}return this.requestExternalImage(t)}P(t){const e=this.gltf.textures[t];if(!e)return null;const n=this.gltf.images[e.source];return this.O(n).then(t=>{const r=this.gltf.samplers[e.sampler];return{image:{array:t.data,width:t.width,height:t.height,index:e.source,mimeType:n.mimeType,name:n.name,extras:n.extras},sampler:r}})}getBaseColorTexture(t){const e=this.gltf.materials[t];let n,r;if(e.instanceTechnique&&e.instanceTechnique.values?(n=e.instanceTechnique,r=n.values.diffuse):(n=e,r=n.values.tex||n.values.diffuseTex||n.values.diffuse),void 0===r||void 0===this.gltf.textures)return null;const s=this.gltf.textures[r];if(!s)return null;const i=this.gltf.samplers[s.sampler];return{format:s.format||6408,internalFormat:s.internalFormat||6408,type:s.type||5121,sampler:i,source:this.gltf.images[s.source]}}getMaterial(){return null}getAnimations(){return null}}class D extends B{constructor(t,e,n,r,s,i,o,c){super(r,s,i,o,c),this.rootPath=t,this.gltf=e,this.glbBuffer=n,this.buffers={},this.requests={},this.accessor=new C(t,e,n,o,c)}iterate(t,e){const n=this.gltf[e];if(n)for(let e=0;e<n.length;e++)t(e,n[e],e)}createNode(t){const e={};return _(e,t),!p(t.weights)&&this.gltf.meshes&&p(e.mesh)?e.weights=this.gltf.meshes[e.mesh].weights:t.weights&&(e.weights=t.weights),e}P(t){const e=this.gltf.textures[t];if(!e)return null;let n=e.source;if(e.extensions&&e.extensions.EXT_texture_webp&&(n=e.extensions.EXT_texture_webp.source),!p(n))return null;const r=this.gltf.images[n];return this.O(r).then(t=>{if(!t)return null;const n={image:{array:t.data,mipmap:t.mipmap,width:t.width,height:t.height,index:e.source,mimeType:r.mimeType,name:r.name,extensions:r.extensions,extras:r.extras}};_(n,e);const s=p(e.sampler)?this.gltf.samplers[e.sampler]:void 0;return s&&(n.sampler=s,n.sampler.magFilter=s.magFilter||9729,n.sampler.minFilter=s.minFilter||9729,n.sampler.wrapS=s.wrapS||10497,n.sampler.wrapT=s.wrapT||10497),t.format&&(n.format=t.format),n})}O(t){if(!p(t.bufferView))return this.requestExternalImage(t);{const e=this.gltf.bufferViews[t.bufferView],n=this.gltf.buffers[e.buffer];if(n.uri)return this.requestImageFromBufferURI(n,e,t);if(this.glbBuffer)return this.k(e,t)}return null}k(t,e){const n=this.l(t,this.glbBuffer.buffer,this.glbBuffer.byteOffset);return this.getImageByBuffer(n,e)}l(t,e,n){n=n||0;const r=(t.byteOffset||0)+n,s=t.byteLength;return new Uint8Array(e,r,s)}N(t,e){const n=new Array(t.byteLength);for(let e=0;e<t.byteLength;e++)n[e]=String.fromCharCode(t[e]);return n.join(""),"data:"+(e=e||"image/png")+";base64,"+function(t){return"undefined"!=typeof self?self.btoa(t):window.btoa(t)}(unescape(encodeURIComponent(n)))}getAnimations(t){const e=[];return t.forEach(t=>{e.push(this.getSamplers(t.samplers))}),Promise.all(e).then(e=>{for(let n=0;n<e.length;n++)t[n].samplers=e[n];return t})}getSamplers(t){const e=[];for(let n=0;n<t.length;n++)(p(t[n].input)||p(t[n].output))&&(e.push(this.accessor._("input",t[n].input)),e.push(this.accessor._("output",t[n].output)));return Promise.all(e).then(e=>{for(let n=0;n<e.length/2;n++)t[n].input=e[2*n],t[n].output=e[2*n+1],t[n].interpolation||(t[n].interpolation="LINEAR");return t})}}const q="undefined"!=typeof TextDecoder?new TextDecoder("utf-8"):null;class F{static read(t,e=0,n=0){n||(n=t.byteLength);const r=new DataView(t,e,n),s=r.getUint32(4,!0);if(1===s)return F.readV1(r,e);if(2===s)return F.readV2(t,e);throw new Error("Unsupported glb version : "+s)}static readV1(t,e){const n=t.getUint32(8,!0),r=t.getUint32(12,!0);if(n!==t.byteLength)throw new Error("Length in GLB header is inconsistent with glb\'s byte length.");const s=j(t.buffer,20+e,r);return{json:JSON.parse(s),glbBuffer:{byteOffset:20+e+r,buffer:t.buffer,byteLength:n}}}static readV2(t,e){let n,r,s;const i=new DataView(t,e+12);let o=0;for(;o<i.byteLength;){const c=i.getUint32(o,!0);o+=4;const a=i.getUint32(o,!0);if(o+=4,1313821514===a)n=j(t,e+12+o,c);else if(5130562===a){s=e+12+o,r=c;break}o+=c}return{json:JSON.parse(n),glbBuffer:{byteOffset:s,buffer:t,byteLength:r}}}}function j(t,e,n){if(q){const r=new Uint8Array(t,e,n);return q.decode(r)}return function(t){const e=t.length;let n="";for(let r=0;r<e;){let s=t[r++];if(128&s){let n=V[s>>3&7];if(!(64&s)||!n||r+n>e)return null;for(s&=63>>n;n>0;n-=1){const e=t[r++];if(128!=(192&e))return null;s=s<<6|63&e}}n+=String.fromCharCode(s)}return n}(new Uint8Array(t,e,n))}const V=[1,1,1,1,2,2,3,0],H=[0,0,0],K=[0,0,0,1],$=[1,1,1],G={TRANSLATION:[0,0,0],ROTATION:[0,0,0,1],SCALE:[1,1,1]},X={PREVIOUS:null,NEXT:null,PREINDEX:null,NEXTINDEX:null,INTERPOLATION:null},z={S(t,e,n,r,s,o,c,a){const u=p(t)?e.animations:[e.animations[0]],h={};for(let e=0;e<u.length;e++){const f=u[e],l=f.name||e;if(p(t)&&l!==t)continue;const d=f.channelsMap[n];if(d)for(let t=0;t<d.length;t++){const e=d[t];"translation"===e.target.path?(this.B(s,f.samplers[e.sampler],r,1),h.translation=i(H,s)):"rotation"===e.target.path?(this.R(o,f.samplers[e.sampler],r,1),h.rotation=m(K,o)):"scale"===e.target.path?(this.B(c,f.samplers[e.sampler],r,1),h.scale=i($,c)):"weights"===e.target.path&&a&&(this.B(a,f.samplers[e.sampler],r,a.length),h.weights=a)}}return h},B(t,e,n,r){switch(e.interpolation){case"LINEAR":{const s=this.U(X,e,n,1*r);s&&(t=function(t,e,n,r){for(let s=0;s<t.length;s++)t[s]=e[s]+r*(n[s]-e[s]);return t}(t,s.PREVIOUS,s.NEXT,s.INTERPOLATION));break}case"STEP":{const s=this.U(X,e,n,1*r);s&&(t=function(t,e){for(let n=0;n<t.length;n++)t[n]=e[n];return t}(t,...s.PREVIOUS));break}case"CUBICSPLINE":{const s=this.U(X,e,n,3*r);s&&(t=this.C(t,s,e.input.array,3*r));break}}return t},R(t,e,n){switch(e.interpolation){case"LINEAR":{const r=this.U(X,e,n,1);r&&l(t,r.PREVIOUS,r.NEXT,r.INTERPOLATION);break}case"STEP":{const r=this.U(X,e,n,1);r&&(t=u(t,...r.PREVIOUS));break}case"CUBICSPLINE":{const r=this.U(X,e,n,3);if(r){for(let t=0;t<r.PREVIOUS.length;t++)r.PREVIOUS[t]=Math.acos(r.PREVIOUS[t]),r.NEXT[t]=Math.acos(r.NEXT[t]);t=this.C(t,r,e.input.array,3);for(let e=0;e<t.length;e++)t[e]=Math.cos(t[e])}break}}return t},L(t,e){const n=t.length;let r,s,i,o=0,c=n-1,a=Math.floor((o+c)/2);for(;o<=n-1&&c>=0;){if(o===c)return null;if(t[a]<=e&&e<=t[a+1]){const n=t[a];return r=a,s=a+1,i=(e-n)/(t[a+1]-n),{preIndx:r,nextIndex:s,interpolation:i}}e<t[a]?(c=a,a=Math.floor((o+c)/2)):t[a+1]<e&&(o=a,a=Math.floor((o+c)/2))}return null},U(t,e,n,r){const s=e.input.array,i=e.output.array,o=e.output.itemSize;(n<s[0]||n>s[s.length-1])&&(n=Math.max(s[0],Math.min(s[s.length-1],n))),n===s[s.length-1]&&(n=s[0]);const c=this.L(s,n);if(!c||!c.nextIndex)return null;const{preIndx:a,nextIndex:u,interpolation:h}=c;t.PREINDEX=a,t.NEXTINDEX=u,t.INTERPOLATION=h;const f=o*r;return t.PREVIOUS=i.subarray(t.PREINDEX*f,(t.PREINDEX+1)*f),t.NEXT=i.subarray(t.NEXTINDEX*f,(t.NEXTINDEX+1)*f),t},C(t,e,n,r){const s=e.INTERPOLATION,i=n[e.PREINDEX],o=n[e.NEXTINDEX];for(let n=0;n<3;n++){const c=e.PREVIOUS[r+n],a=(o-i)*e.PREVIOUS[2*r+n],u=e.NEXT[3+n],h=(o-i)*e.NEXT[n],f=(2*Math.pow(s,3)-3*Math.pow(s,2)+1)*c+(Math.pow(s,3)-2*Math.pow(s,2)+s)*a+(2*-Math.pow(s,3)+3*Math.pow(s,2))*u+(Math.pow(s,3)-Math.pow(s,2))*h;t[n]=f}return t},getAnimationClip(t,e,n,r){const s=t.nodes[e]&&t.nodes[e].weights;return o(H,...G.TRANSLATION),u(K,...G.ROTATION),o($,...G.SCALE),this.S(r,t,e,n,H,K,$,s)},getTimeSpan(t){if(!t.animations)return null;if(t.timeSpan)return t.timeSpan;const e=t.animations;return t.timeSpan={},e.forEach((e,n)=>{let r=-1/0,s=1/0;const i=e.channels;for(let t=0;t<i.length;t++){const n=i[t],o=e.samplers[n.sampler].input.array;o[o.length-1]>r&&(r=o[o.length-1]),o[0]<s&&(s=o[0])}const o=e.name||n;t.timeSpan[o]={max:r,min:s}}),t.timeSpan},getTimeSpanByName(t,e){const n=this.getTimeSpan(t);return n?p(e)?n[e]:n[Object.keys(n)[0]]:null}};let J=!1;if("undefined"!=typeof OffscreenCanvas){let t;try{t=new OffscreenCanvas(2,2).getContext("2d")}catch(ut){}t&&"undefined"!=typeof createImageBitmap&&(J=!0)}const W="undefined"==typeof document?null:document.createElement("canvas");class Q{constructor(t,e,n){if(this.options=n||{},this.options.decoders||(this.options.decoders={}),this.u=this.options.fetchOptions||{},e.buffer instanceof ArrayBuffer){const{json:n,glbBuffer:r}=F.read(e.buffer,e.byteOffset,e.byteLength);this.D(t,n,r)}else this.D(t,e);this.q=new C(this.rootPath,this.gltf,this.glbBuffer,this.u,this.options.urlModifier),this.F()}F(){const t=this.gltf.extensionsRequired;if(t){if(t.indexOf("KHR_draco_mesh_compression")>=0&&!this.options.decoders.draco)throw new Error("KHR_draco_mesh_compression is required but @maptalks/transcoders.draco is not loaded");if(t.indexOf("KHR_texture_basisu")>=0&&!this.options.decoders.ktx2)throw new Error("KHR_texture_basisu is required but @maptalks/transcoders.ktx2 is not loaded")}}j(){const t=this.gltf.extensions;return t&&t.KHR_techniques_webgl?this.q.requestKHRTechniquesWebgl(t.KHR_techniques_webgl).then(e=>(t.KHR_techniques_webgl=e,t)):Promise.resolve(t)}load(t){t=t||{};const e=this.V(t),n=this.H(),r=this.K(),s=this.j();return Promise.all([e,n,r,s]).then(t=>(t[0].animations=t[1],t[0].textures=t[2],t[0].extensions=t[3],t[0].transferables=this.transferables||[],this.createChannelsMap(t[0]),t[0]))}createChannelsMap(t){const e=t.animations;if(e)for(let t=0;t<e.length;t++){const n=e[t];n.channelsMap={};for(let t=0;t<n.channels.length;t++){const e=n.channels[t];n.channelsMap[e.target.node]||(n.channelsMap[e.target.node]=[]),n.channelsMap[e.target.node].push(e)}}}getExternalResources(){const t=[];if(this.gltf){const{buffers:e,images:n}=this.gltf;for(let n=0;n<e.length;n++)e[n].uri&&e[n].uri.indexOf("data:application/octet-stream;base64")<0&&t.push({type:"buffer",uri:e[n].uri});for(let e=0;e<n.length;e++)n[e].uri&&n[e].uri.indexOf("data:image/")<0&&t.push({type:"image",uri:n[e].uri})}return t}static getAnimationClip(t,e,n,r){return z.getAnimationClip(t,e,n,r)}static getAnimationTimeSpan(t,e){return z.getTimeSpanByName(t,e)}static getTypedArrayCtor(t){return b(t)}static readInterleavedArray(t,e,n,r,s,i,o){return P(t,e,n,r,s,i,o)}D(t,e,n){this.gltf=e,this.glbBuffer=n,this.version=e.asset?+e.asset.version:1,this.rootPath=t,this.buffers={},this.requests={},this.options.requestImage=J?rt.bind(this):this.options.requestImage||Y,this.options.transferable&&(this.transferables=[]),2===this.version?(this.adapter=new D(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="buffer_"+n},"buffers"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors")):(this.adapter=new L(t,e,n,this.options.requestImage,this.options.decoders||{},this.options.supportedFormats||{},this.u,this.options.urlModifier),this.adapter.iterate((t,e,n)=>{e.id="accessor_"+n},"accessors"),this.adapter.iterate((t,e,n)=>{e.id="image_"+n},"images"))}$(t,e){if(t.children&&t.children.length>0){if(!("number"==typeof(n=t.children[0])&&isFinite(n)||y(t.children[0])))return t;const r=t.children.map(t=>{const n=e[t];return n.nodeIndex=t,this.$(n,e)});t.children=r}var n;return t}V(t){return this.G(t).then(t=>{const e=this.scenes=[];let n;for(const e in t)t[e]=this.$(t[e],t),t[e].nodeIndex=Number(e)?Number(e):e;this.adapter.iterate((r,s,i)=>{const o={};s.name&&(o.name=s.name),s.nodes&&(o.nodes=s.nodes.map(e=>t[e])),this.gltf.scene===r&&(n=i),e.push(o)},"scenes");const r={textures:this.gltf.textures,asset:this.gltf.asset,scene:n,scenes:e,nodes:t,meshes:this.meshes,materials:this.gltf.materials,skins:this.skins,extensionsRequired:this.gltf.extensionsRequired,extensionsUsed:this.gltf.extensionsUsed};if(this.gltf.extensions&&(r.extensions=this.gltf.extensions),1===this.version){const t=this.adapter.v(this.gltf.materials);r.materials=t}return delete this.gltf.buffers,r.json=this.gltf,r})}G(t){return this.X(t).then(()=>{const t=this.nodes={};return this.adapter.iterate((e,n)=>{const r=this.adapter.createNode(n,this.meshes,this.skins);t[e]=r},"nodes"),t})}J(){this.skins=[];const t=[];return this.adapter.iterate((e,n,r)=>{t.push(this.W(n).then(t=>{t.index=r,this.skins.push(t)}))},"skins"),t}W(t){const e=t.inverseBindMatrices;return this.adapter.accessor._("inverseBindMatrices",e).then(e=>(t.inverseBindMatrices=e,e&&e.buffer&&this.transferables&&this.transferables.indexOf(e.buffer)<0&&this.transferables.push(e.buffer),t))}H(){const t=this.gltf.animations;return p(t)?this.adapter.getAnimations(t):null}X(t){this.meshes={};let e=[];return this.adapter.iterate((n,r,s)=>{e.push(this.Y(r,t).then(t=>{t.index=s,this.meshes[n]=t}))},"meshes"),e=e.concat(this.J()),Promise.all(e)}Y(t,e){const n=t.primitives.map(t=>this.Z(t,e)).filter(t=>!!t);return Promise.all(n).then(e=>{const n={};return _(n,t),n.primitives=e,n})}K(){const t=this.gltf.textures;if(!t)return null;const e=[];for(const n in t)e.push(this.adapter.P(n));return Promise.all(e).then(e=>{if(this.transferables)for(let t=0;t<e.length;t++){const n=e[t].image.array;if(e[t]&&n){let t;t=n instanceof ImageBitmap?n:n.buffer,t&&this.transferables.indexOf(t)<0&&this.transferables.push(t)}}if(!Array.isArray(t)){const n={},r=Object.keys(t);for(let t=0;t<e.length;t++)e[t]&&(n[r[t]]=e[t]);return n}return e})}Z(t,e){let n;const r=[],s=t.extensions;if(p(t.targets))for(let e=0;e<t.targets.length;e++){const n=t.targets[e];for(const t in n){const s=this.adapter.accessor._(`morphTargets_${t}_${e}`,n[t]);s&&r.push(s)}}if(s&&s.KHR_draco_mesh_compression){if(!this.options.decoders.draco&&(!this.gltf.extensionsRequired||!this.gltf.extensionsRequired.indexOf("KHR_draco_mesh_compression")<0))return null;const t=this.options.decoders.draco,{bufferView:i,attributes:o}=s.KHR_draco_mesh_compression,c=this.gltf.bufferViews[i],a=this.q.I(c).then(n=>{const{buffer:r,byteOffset:s}=n;let{byteOffset:i}=c;const a=c.byteLength;i||(i=0);const u=new DataView(r,s+i,a),h={attributes:o,useUniqueIDs:!1,skipAttributeTransform:e.skipAttributeTransform};return t(u,h).then(t=>{const e=Object.values(t.attributes);return t.indices&&e.push(t.indices),e})});r.push(a),n=Promise.all(r)}else{const e=t.attributes;for(const t in e){const n=this.adapter.accessor._(t,e[t]);n&&r.push(n)}if(p(t.indices)){const e=this.adapter.accessor._("indices",t.indices);e&&r.push(e)}n=Promise.all(r)}return n.then(e=>{if(s&&s.KHR_draco_mesh_compression){const n=t.targets?t.targets.length:0;e[n]=e[n].concat(e.slice(0,n)),e=e[n]}let n,r;const i={attributes:e.reduce((t,e)=>{if("indices"===e.name)n=e;else if(e.name.indexOf("morphTargets_")>-1)r=r||{},r[e.name.slice(13)]=e;else{if(!("POSITION"!==e.name||e.min&&e.max)){const t=[1/0,1/0,1/0],n=[-1/0,-1/0,-1/0],{itemSize:r,array:s}=e,i=s.length/r;for(let e=0;e<i;e++)for(let i=0;i<r;i++){const o=e*r+i;s[o]<t[i]&&(t[i]=s[o]),s[o]>n[i]&&(n[i]=s[o])}if(e.quantization){const r=e.quantization,s=r.range/(1<<r.quantizationBits),i=r.minValues;a(t,t,s),c(t,t,i),a(n,n,s),c(n,n,i)}e.min=t,e.max=n}t[e.name]=e}return this.transferables&&e.array.buffer&&this.transferables.indexOf(e.array.buffer)<0&&this.transferables.push(e.array.buffer),t},{}),material:t.material};return n&&(i.indices=n),r&&(i.morphTargets=r),i.mode=p(t.mode)?t.mode:4,p(t.extras)&&(i.extras=t.extras),i})}}function Y(t,e,n){const r=new Image;r.crossOrigin="",r.onload=()=>{if(!W)return void n(new Error("There is no canvas to draw image!"));W.width=r.width,W.height=r.height;const t=W.getContext("2d",{willReadFrequently:!0});t.drawImage(r,0,0,r.width,r.height);const e=t.getImageData(0,0,r.width,r.height),s={width:r.width,height:r.height,data:new Uint8Array(e.data)};n(null,s)},r.onerror=function(t){n(t)},r.src=t}const Z=[],tt=[];let et,nt;function rt(t,e,n){et||(et=new OffscreenCanvas(2,2),nt=et.getContext("2d",{willReadFrequently:!0}));let r=null;if(y(t))this.options.urlModifier&&(t=this.options.urlModifier(t)),Z.push([t,e,n,this]),function t(){if(!Z.length||tt.length>10)return;const e=Z.shift(),[n,r,s,i]=e;tt.push(e),fetch(n,r).then(t=>t.arrayBuffer()).then(t=>{const e=new Blob([new Uint8Array(t)]);return createImageBitmap(e)}).then(st.bind(i)).then(n=>{s.call(i,null,n);const r=tt.indexOf(e);tt.splice(r,1),t()}).catch(n=>{console.warn(n),s.call(i,n);const r=tt.indexOf(e);tt.splice(r,1),t()})}();else{const e=new Blob([t]);r=createImageBitmap(e),r.then(st.bind(this)).then(t=>{n(null,t)}).catch(t=>{console.warn(t),n(t)})}}function st(t){let{width:e,height:n}=t;it(e)||(e=ot(e)),it(n)||(n=ot(n));const r=this.options.maxTextureSize;r&&(e=Math.min(r,e),n=Math.min(r,n)),et.width=e,et.height=n,nt.drawImage(t,0,0,e,n),t.close();const s=nt.getImageData(0,0,e,n);return{width:e,height:n,data:new Uint8Array(s.data)}}function it(t){return 0==(t&t-1)&&0!==t}function ot(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}\n/*!\n   * @maptalks/gl v0.97.4\n   * LICENSE : UNLICENSED\n   * (c) 2016-2024 maptalks.com\n   */const ct=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof undefined)return global;throw new Error("unable to locate global object")},at=ct(),ut=at.gl_trans__coders=at.gl_trans__coders||{};ut.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),s=at.gl_trans__coders=at.gl_trans__coders||{};let i=`${r}\\n    const _____getGlobal = ${ct.toString()};\\n    const g___lobals = _____getGlobal()\\n    const tran_____scoders = g___lobals[\'gl_trans__coders\'] = g___lobals[\'gl_trans__coders\'] || {};`;for(const t in s)"inject"!==t&&"getTranscoder"!==t&&"registerTranscoder"!==t&&(i+=\'tran_____scoders["\'+t+\'"] =\'+s[t].toString()+"\\n;");return i+="\\n"+e.substring(r.length),i},ut.registerTranscoder=function(t,e){ut[t]=e},ut.getTranscoder=function(t){return ut[t]};const ht={"image/crn":ut.crn&&ut.crn(),"image/ktx2":ut.ktx2&&ut.ktx2(),"image/cttf":ut.ktx2&&ut.ktx2(),"draco":ut.draco&&ut.draco()};let ft;const lt={};function dt(t,e,n){return new Q(t,e,n).load({skipAttributeTransform:!0})}function mt(t,e,n,r){const s=e.lastIndexOf("/"),i=e.slice(0,s);r&&(e=r(e));const o=wt.bind(this,t);return function(t,e){return S.getArrayBuffer(t,e)}(e,n).then(t=>{if(t.message)return t;const s=t.data;return new DataView(s,s.byteOffset,s.byteLength).getUint32(4,!0)>2?function(t,e){return S.getJSON(t,e)}(e,n).then(t=>t.message?t:dt(i,t,{requestImage:o,decoders:ht,transferable:!0,fetchOptions:n,urlModifier:r})):dt(i,{buffer:t.data,byteOffset:0},{requestImage:o,decoders:ht,transferable:!0,fetchOptions:n,urlModifier:r})})}function wt(t,e,n,r){t?lt[e]?lt[e].push(r):(lt[e]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:ft,params:e})):function(t,e){const n=new Image;n.onload=()=>{if(!gt)return void e(new Error("There is no canvas to draw image!"));gt.width=n.width,gt.height=n.height;const t=gt.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),s={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,s,[s.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(e,r)}const gt="undefined"==typeof document?null:document.createElement("canvas");t.loadGLTF=mt,t.onmessage=function(t){const e=t.data,n=e.url;if("addLayer"===e.command||"removeLayer"===e.command)ft=t.workerId,self.postMessage({type:"<response>",actorId:e.actorId,workerId:ft,params:"ok"});else if(n)!function(t){const e=t.data,n=t.callback,r=t.actorId,s=e.url,i=e.fetchOptions||{};i.referrerPolicy=i.referrerPolicy||"origin",i.referrer=e.referrer,mt(r,s,i).then(t=>{t.message?self.postMessage({callback:n,error:t}):self.postMessage({callback:n,data:t},t.transferables)}).catch(t=>{self.postMessage({callback:n,error:t})}),lt.receive=n}(t);else if(e.imageUrl){const t=lt[e.imageUrl];if(delete lt[e.imageUrl],t)for(let n=0;n<t.length;n++)t[n](null,e.result)}},Object.defineProperty(t,"tt",{value:!0})}';function h(t){return null==t}function c(t){return!h(t)}function u(t,n){if(!t||!n)return null;let r=n;if(Array.isArray(n)){if(!e["I"].isNumber(n[0]))return null;r=new e["f"](n)}const i=t.coordinateToPointAtRes(r,t.getGLRes()),s=t.altitudeToPoint(r.z||0,t.getGLRes());return[i.x,i.y,s]}function f(t,e){return Math.abs(t)*Math.sign(e)}function d(t,n,r){const i=e["M"].Measurer.getInstance().measureLenBetween(t,n),s=r.gapLength+r.bboxWidth;let o=r.count;o&&r.snapToEndVertexes&&(o-=1);const a=o>0?i/o:s,l=Math.floor(i/a),h=[],c=r.map,u=r.rotateAlongLine+function(t,n,r){const i=r.getGLRes(),s=r.coordinateToPointAtRes(t,i),o=r.coordinateToPointAtRes(n,i);return e["I"].computeDegree(o.x,o.y,s.x,s.y)/Math.PI*180}(t,n,c);if(l>=1){const e=0,s=l;if(r.snapToEndVertexes)for(let r=e;r<=s;r++){const e={coordinates:p(t,n,a*r/i),scale:[1,1,1],rotation:[0,0,u]};h.push(e)}else for(let r=e+1;r<=s;r++){const e={coordinates:p(t,n,a*(r-.5)/i),scale:[1,1,1],rotation:[0,0,u]};h.push(e)}if(r.scaleEndModel){const e=(i-a*l)/a,r={coordinates:p(t,n,(a*l+(i-a*l)/2)/i),scale:[e,1,1],rotation:[0,0,u]};h.push(r)}}else if(r.scaleEndModel){const e=i/a,r={coordinates:p(t,n,.5),scale:[e,1,1],rotation:[0,0,u]};h.push(r)}return h}function p(t,n,r){const i=A(t.x,n.x,r),s=A(t.y,n.y,r);return new e["f"](i,s)}function A(t,e,n){return t+n*(e-t)}const g={},m="undefined"==typeof document?null:document.createElement("canvas");class y extends e["R"].Actor{constructor(t,e){super(t),this.mapId=e.getMap().id,this.t=e}loadGLTF(t){const e={url:function(t){let e=document.createElement("a");return e.href=t,t=e.href,e=null,t}(t),referrer:window&&window.location.href,fetchOptions:this.t.options.fetchOptions};return new Promise((t,n)=>{this.send(e,null,(e,r)=>{e?n(e):t(r)})})}sendImageData(t,e){!function(t,e){const n=new Image;n.onload=()=>{if(!m)return void e(new Error("There is no canvas to draw image!"));m.width=n.width,m.height=n.height;const t=m.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),i={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,i,[i.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(t,(n,r)=>{n||this.isActive()&&e(null,{result:r,imageUrl:t})})}addLayer(t,e,n){const r={actorId:this.actorId,mapId:this.mapId,layerId:t,command:"addLayer",params:{options:e}};this.broadcast(r,null,n)}removeLayer(t,e,n){const r={mapId:this.mapId,layerId:t,command:"removeLayer"};this.broadcast(r,null,n)}}
/*!
 * @maptalks/gl v0.97.4
 * LICENSE : UNLICENSED
 * (c) 2016-2024 maptalks.com
 */const v=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof t)return t;throw new Error("unable to locate global object")},x=v(),b=x.gl_trans__coders=x.gl_trans__coders||{};b.inject=function(t){const e=t.toString(),n=e.indexOf("{")+1,r=e.substring(0,n),i=x.gl_trans__coders=x.gl_trans__coders||{};let s=`${r}\n    const _____getGlobal = ${v.toString()};\n    const g___lobals = _____getGlobal()\n    const tran_____scoders = g___lobals['gl_trans__coders'] = g___lobals['gl_trans__coders'] || {};`;for(const o in i)"inject"!==o&&"getTranscoder"!==o&&"registerTranscoder"!==o&&(s+='tran_____scoders["'+o+'"] ='+i[o].toString()+"\n;");return s+="\n"+e.substring(r.length),s},b.registerTranscoder=function(t,e){b[t]=e},b.getTranscoder=function(t){return b[t]};const w={"image/crn":b.crn&&b.crn(),"image/ktx2":b.ktx2&&b.ktx2(),"image/cttf":b.ktx2&&b.ktx2(),draco:b.draco&&b.draco()},_={};function M(t,e,n){return new s["b"](t,e,n).load({skipAttributeTransform:!0})}function T(t,e,n,r){const i=e.lastIndexOf("/"),o=e.slice(0,i);r&&(e=r(e));const a=S.bind(this,t);return function(t,e){return s["a"].getArrayBuffer(t,e)}(e,n).then(t=>{if(t.message)return t;const i=t.data;return new DataView(i,i.byteOffset,i.byteLength).getUint32(4,!0)>2?function(t,e){return s["a"].getJSON(t,e)}(e,n).then(t=>t.message?t:M(o,t,{requestImage:a,decoders:w,transferable:!0,fetchOptions:n,urlModifier:r})):M(o,{buffer:t.data,byteOffset:0},{requestImage:a,decoders:w,transferable:!0,fetchOptions:n,urlModifier:r})})}function S(t,e,n,r){t?_[e]?_[e].push(r):(_[e]=[r],self.postMessage({type:"<request>",command:"sendImageData",actorId:t,workerId:void 0,params:e})):function(t,e){const n=new Image;n.onload=()=>{if(!I)return void e(new Error("There is no canvas to draw image!"));I.width=n.width,I.height=n.height;const t=I.getContext("2d");t.drawImage(n,0,0,n.width,n.height);const r=t.getImageData(0,0,n.width,n.height),i={width:n.width,height:n.height,data:new Uint8Array(r.data)};e(null,i,[i.data.buffer])},n.onerror=function(t){e(t)},n.src=t}(e,r)}const I="undefined"==typeof document?null:document.createElement("canvas"),C=[],O=[],E=["points","lines","line strip","line loop"];class P extends(Object(r["f"])(e["P"].OverlayLayerCanvasRenderer)){constructor(t){super(t),this.s={},this.i=[]}onAdd(){super.onAdd(),this.prepareWorker()}draw(t,e){this.prepareCanvas(),this.o(e,t)}drawOnInteracting(t,e,n){this.o(n,e)}o(t,n){this.h=t,this.u=n;let r=0;this.l(t),this.m={},this.p(t);const i=this.g(t);this._(n);const s=t&&t.renderTarget?t.renderTarget.fbo:null;let o=0;for(const l in this.s){if("pointline"===l)continue;if(t&&t.includes){const{newShader:n,uniforms:r}=this.v(t,l);this.s[l].shader=n,e["I"].extend(i,r)}const n=this.T(l),a=this.s[l].shader;a.filter=t&&t.sceneFilter||null,o+=this.renderer.render(a,i,n,s),r++}const a=this.T("pointline");if(a.getMeshes().length){i.pointSize=this.layer.options.pointSize||1;const e=this.s.pointline.shader;e.filter=t&&t.sceneFilter||null,o+=this.renderer.render(e,i,a,s),r++}this.M(i,s),o&&this.layer.fire("canvasisdirty",{renderCount:o}),this.O=!0,this.completeRender(),this.layer.fire("rendercomplete-debug",{count:r})}M(t,e){this.A||(this.A=new r["m"].Scene);const n=this.layer.getGeometries(),i=[];for(let r=0;r<n.length;r++){if(!n[r].options.showDebugBoundingBox)continue;const t=n[r].S();t&&i.push(t)}i.length&&(this.A.setMeshes(i),this.renderer.render(this.s.wireframe.shader,t,this.A,e))}_(t){this.i.length=0;const n=this.layer.getGeometries();for(let r=0;r<n.length;r++){const i=n[r],s=i.getMeshes(this.I,this.regl,t),o=i.getShader();if(s.length){this.i.push(i),this.m[o]=this.m[o]||[],e["I"].pushIn(this.m[o],s);for(let t=0;t<s.length;t++)s[t].properties.bloomMesh&&this.m[o].push(s[t].properties.bloomMesh)}}}g(){const t={};this.P.outSize=[this.canvas.width,this.canvas.height],this.P.halton=[0,0];const n=this.canvas.gl&&this.canvas.gl.wrap?this.layer.options.opacity||0:1;t.layerOpacity=n,e["I"].extend(t,this.P);const r=this.getMaskUniforms();return e["I"].extend(t,r),t}T(t){const e=[],n=[];if("pointline"===t){for(const n in this.m)"wireframe"!==n&&this.m[n].forEach(t=>{E.indexOf(t.geometry.desc.primitive)>-1&&e.push(t)});const t=new r["m"].Scene(e);return t.sortMeshes(this.P.cameraPosition),t}for(const r in this.m){const e=this.m[r];r===t&&e.forEach(e=>{(E.indexOf(e.geometry.desc.primitive)<0||"wireframe"===t)&&n.push(e)})}const i=new r["m"].Scene(n);return i.sortMeshes(this.P.cameraPosition),i}needToRedraw(){if(super.needToRedraw())return!0;const t=this.layer.getGeometries();for(let e=0;e<t.length;e++)if(this.i.indexOf(t[e])>-1&&(t[e].isDirty()||t[e].isAnimated()))return!0;return!1}onRemove(){this.workerConn&&(this.workerConn.removeLayer(this.layer.getId(),t=>{if(t)throw t}),this.workerConn.remove(),delete this.workerConn),super.onRemove()}hitDetect(){return!1}createContext(){const t=this.canvas.gl&&this.canvas.gl.wrap;if(t)this.gl=this.canvas.gl.wrap(),this.regl=this.canvas.gl.regl;else{const t=this.layer.options.glOptions||{alpha:!0,depth:!0,stencil:!0};this.glOptions=t,this.gl=this.gl||this.k(this.canvas,t),this.regl=Object(r["h"])({gl:this.gl,optionalExtensions:["ANGLE_instanced_arrays","OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_half_float","OES_texture_half_float_linear","OES_texture_float","OES_texture_float_linear","WEBGL_depth_texture","EXT_shader_texture_lod","WEBGL_compressed_texture_s3tc"]})}t&&(this.canvas.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height)),this.pickingFBO=this.canvas.pickingFBO||this.regl.framebuffer(this.canvas.width,this.canvas.height),this.I=this.regl.gltfManager=this.regl.gltfManager||this.C(),this.N(),this.L&&this.L.forEach(t=>{t.generateInstancedBuffers(this.regl)}),this.R&&this.R.forEach(t=>{t.generateBuffers(this.regl)}),this.layer.fire("contextcreate",{regl:this.regl})}getGLTFManager(){return this.I}C(){return new r["m"].GLTFManager(this.regl)}N(){const t=this.layer.getMap(),e=new r["m"].Renderer(this.regl);this.renderer=e,this.P={projMatrix:t.projMatrix,projViewMatrix:t.projViewMatrix,viewMatrix:t.viewMatrix,cameraPosition:t.cameraPosition,altitudeScale:1},r["m"].pbr.PBRUtils.loginIBLResOnCanvas(this.canvas,this.regl,t),this.B=new r["m"].FBORayPicking(e,{vert:"#include <gl2_vert>\n\nattribute vec3 aPosition;\n\nuniform mat4 projMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform float pointSize;\n\n#include <fbo_picking_vert>\n\n#include <get_output>\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n\n    gl_PointSize = pointSize;\n\n    fbo_picking_setData(gl_Position.w, true);\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.viewMatrix,e.modelMatrix)}}]},this.pickingFBO,t)}prepareWorker(){this.workerConn||(this.workerConn=new y("@maptalks/gltf-layer",this.layer));const t=this.workerConn;if(!t.isActive())return;const e=this.layer.options||{},n=this.layer.getId();t.addLayer(n,{markerType:e.markerTypes,pointSize:e.pointSize},t=>{if(t)throw t;this.layer&&(this.ready=!0,this.layer.fire("workerready"))})}F(t){let e;if(this.layer.getURLModifier()){const n=this.layer.options.fetchOptions;e=T(null,t,n,t=>{const e=this.layer.getURLModifier();return e?e(t):t})}else e=this.workerConn.loadGLTF(t);return e.then(t=>(this.setToRedraw(),this.U=!0,t)).catch(e=>{console.error(e),this.layer.fire("modelerror",{type:"modelerror",url:t,info:e})})}p(t){const e=g;for(const n in e){if(this.s[n])continue;const r=e[n];this.D(t,r.name,r.type,r.config)}}D(t,n,i,s){this.viewport||(this.viewport={x:0,y:0,width:()=>this.canvas?this.canvas.width:1,height:()=>this.canvas?this.canvas.height:1}),s.extraCommandProps||(s.extraCommandProps={});const o={};t&&this.V(o,C,t);const a=e["I"].extend({},s);a.extraCommandProps=e["I"].extend({},s.extraCommandProps),a.extraCommandProps.viewport=this.viewport,a.uniforms=e["I"].extend([],s.uniforms,C),a.defines=e["I"].extend({},a.defines,o),i.indexOf(".")>-1?(i=i.split("."),this.s[n]={shader:new r["m"][i[0]][i[1]](a),type:i}):this.s[n]={shader:new r["m"][i](a),type:i}}remove(){this.q();const t=this.s;for(const e in t)t[e].shader.dispose();this.extentShader&&this.extentShader.dispose(),super.remove()}clearCanvas(){this.canvas&&(this.regl.clear({color:[0,0,0,0],depth:1,stencil:0}),super.clearCanvas())}resizeCanvas(t){super.resizeCanvas(t),this.pickingFBO&&this.pickingFBO.resize(this.canvas.width,this.canvas.height),this.layer.fire("resizecanvas",{size:t})}getFrameTimestamp(){return this.u}getFrameContext(){return this.h}needRetireFrames(){return this.U}V(t,n,r){const i=r&&r.includes;if(i)for(const s in i)i[s]&&(r[s].uniformDeclares&&(n.length=0,n.push(...r[s].uniformDeclares)),r[s].defines&&e["I"].extend(t,r[s].defines))}G(t,n){const r=n&&n.includes;if(r)for(const i in r)r[i]&&n[i].renderUniforms&&e["I"].extend(t,n[i].renderUniforms)}v(t,n){const{shader:i,type:s}=this.s[n],o={},a={};this.V(o,C,t),this.G(a,t);const l={vert:i.vert,frag:i.frag,uniforms:i.uniforms,extraCommandProps:i.extraCommandProps};l.defines=o,l.uniforms=e["I"].extend([],l.uniforms,C);let h=null;return t.states.includesChanged?(h=Array.isArray(s)?new r["m"][s[0]][s[1]](l):new r["m"][s](l),i.dispose()):h=i,{uniforms:a,newShader:h}}j(t,n,r){if(t.viewshed){for(const e in t.viewshed.renderUniforms)r[e]=t.viewshed.renderUniforms[e];e["I"].extend(n.shaderDefines,t.viewshed.defines)}if(t.floodAnalysis){for(const e in t.floodAnalysis.renderUniforms)r[e]=t.floodAnalysis.renderUniforms[e];e["I"].extend(n.shaderDefines,t.floodAnalysis.defines)}return r}getShadowMeshes(){const t=[];if(!this.layer||!this.layer.isVisible()||!this.m)return t;const n=this.layer.getGeometries();for(let r=0;r<n.length;r++)if(n[r].isCastShadow()&&n[r].isVisible()&&n[r].X()){const i=n[r].H||[];e["I"].pushIn(t,i)}return t}J(){const t=[];if(!this.m||!Object.keys(this.m).length)return t;for(const n in this.m)e["I"].pushIn(t,this.m[n]);return t}getAnalysisMeshes(){return this.J()}getRayCastData(t){const e=this.layer.getGeometries();for(let n=0;n<e.length;n++){const r=e[n].H;if(r&&r.indexOf(t)>-1)return e[n]}return null}drawOutline(t){this.extentShader||(this.extentShader=new r["m"].MeshShader({vert:"attribute vec3 aPosition;\n\nattribute float aOutline;\n\nuniform mat4 projMatrix;\n\nuniform mat4 modelMatrix;\n\nuniform mat4 modelViewMatrix;\n\nuniform mat4 positionMatrix;\n\nuniform float instance;\n\n#include <get_output>\n\n\n\nvarying float vOutline;\n\nvoid main()\n\n{\n\n    mat4 localPositionMatrix = getPositionMatrix();\n\n    gl_Position = projMatrix * modelViewMatrix * localPositionMatrix * getPosition(aPosition);\n\n    if (instance == 0.0) {\n\n        vOutline = 1.0;\n\n    } else {\n\n        vOutline = aOutline;\n\n    }\n\n}\n\n",frag:"precision highp float;\n\nvarying float vOutline;\n\nvoid main() {\n\n    gl_FragColor = vec4(vOutline);\n\n}\n\n",uniforms:[{name:"modelViewMatrix",type:"function",fn:(t,e)=>r["k"].multiply([],e.viewMatrix,e.modelMatrix)}],positionAttribute:"POSITION",extraCommandProps:{viewport:this.viewport,cull:{enable:!1},blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}}));const e=this.getOutlineMeshes();e.length&&(this.W=this.W||new r["m"].Scene,this.W.setMeshes(e),this.renderer.render(this.extentShader,{projMatrix:this.P.projMatrix,viewMatrix:this.P.viewMatrix},this.W,t))}getOutlineMeshes(){const t=[];if(!this.layer)return t;const n=this.layer.getGeometries();for(let r=0;r<n.length;r++){const i=n[r].Y();e["I"].pushIn(t,i)}return t}q(){this.canvas&&r["m"].pbr.PBRUtils.logoutIBLResOnCanvas(this.canvas,this.getMap())}l(t){const n=this.layer.getMap(),{iblTexes:i,dfgLUT:s}=r["m"].pbr.PBRUtils.getIBLResOnCanvas(this.canvas);if(n&&n.getLights()){const o=r["m"].pbr.PBRUtils.getPBRUniforms(n,i,s,t&&t.ssr,t&&t.jitter),a=n.getLights(),l=a.ambient&&a.ambient.color?a.ambient.color:[.2,.2,.2];this.P.ambientColor=l,o&&e["I"].extend(this.P,o)}else{const i=r["m"].pbr.PBRUtils.getPBRUniforms(n,null,s,t&&t.ssr,t&&t.jitter);e["I"].extend(this.P,i)}}k(t,e){const n=["webgl","experimental-webgl"];let r=null;for(let i=0;i<n.length;++i){try{r=t.getContext(n[i],e)}catch(t){}if(r)break}return r}Z(t,n,r={}){if(!this.B||!this.layer.isVisible())return null;const i=this.layer.getMap(),s=this.canvas.gl&&this.canvas.gl.wrap;if(this.O||s){if(!this.m||!Object.keys(this.m).length)return null;const t=this.J(),n=e["I"].extend({},this.P);n.pointSize=this.layer.options.pointSize||1,this.B.render(t,n,!0),this.O=!1}const o=r.returnAll?"pickAll":"pick",a=this.B[o](t,n,r.tolerance||3,{projMatrix:i.projMatrix,viewMatrix:i.viewMatrix,pointSize:this.layer.options.pointSize||1},{viewMatrix:i.viewMatrix,projMatrix:i.projMatrix,returnPoint:!0});if(a.length){const t={},e=[];for(let n=0;n<a.length;n++)if(!t[a[n].pickingId]){const r=this.K(a[n]);t[a[n].pickingId]=!0,e.push(r)}return e}return this.K(a)}K(t){const{meshId:e,pickingId:n,point:r,coordinate:i}=t,s=this.J()[e],o=this.$(n);return{meshId:e,mesh:s,data:this.layer.tt()[o],pickingId:n,point:r,coordinate:i,index:n-o,nodeIndex:this.et(e)}}et(t){const e=this.J()[t];return e&&e.properties.nodeIndex}$(t){if(!c(t))return null;if(this.layer.tt()[t])return t;const e=Object.keys(this.layer.tt()),n=e.length;let r=0,i=n-1,s=Math.floor((r+i)/2);for(;r<=n-1&&i>=0;){if(r===i)return e[r];if(e[s]<=t&&t<e[s+1])return e[s];t<e[s]?(i=s-1,s=Math.floor((r+i)/2)):e[s+1]<t&&(r=s+1,s=Math.floor((r+i)/2))}return null}isInFrustum(t){const e=this.layer.getMap(),n=t.getBoundingBox();if(!n||"multigltfmarker"===t.getGLTFMarkerType())return!0;const s=r["o"].set(O,n.min,n.max);return!!Object(i["a"])(e.projViewMatrix,s)}getRenderMeshesTest(){return this.J()}isMarkerTransparent(t){return t.nt()}getMarkerFitSizeScale(t){return t.st()}getMarkerFitTranslate(t){return t.it()}getFBORayPicking(){return this.B}getShaderList(){return this.s}}const k=[],R=[],N=[],D=[],F=[1,1,1],L=[],z=[],B=[1,1,1],H=new r["m"].BoundingBox,U=function(t,e){const n=[];return n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=0,n[4]=t[3],n[5]=t[4],n[6]=t[5],n[7]=0,n[8]=t[6],n[9]=t[7],n[10]=t[8],n[11]=0,n[12]=e[0],n[13]=e[1],n[14]=e[2],n[15]=1,n}(function(t){const e=Math.cos(t),n=Math.sin(t),r=[];return r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=e,r[5]=n,r[6]=0,r[7]=-n,r[8]=e,r}(.5*Math.PI),[0,0,0]),j=new e["A"](0,0),V=[186/255,186/255,186/255,1],G={lightAmbient:[1,1,1],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightDirection:[1,1,1]},q=new Set(["url","translationX","translationY","translationZ","rotationX","rotationY","rotationZ","scaleX","scaleY","scaleZ","anchorZ","markerPixelHeight","modelHeight"]),W=[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],X=[0,1,1,2,2,3,3,0,0,4,1,5,2,6,3,7,4,5,5,6,6,7,7,4],Q=[.8,.8,.1,1];class Y extends e["u"]{constructor(t,n){const i=e["I"].extend({},n),s=i.symbol;super(t,i),this.options.symbol=s,this.rt=!1,this.ot=r["k"].identity([]),this.ht="gltfmarker",this.ct=!0,this.ut=!0,this.lt={get translation(){return[0,0,0]},get rotation(){return[0,0,0]},get scale(){return[1,1,1]}},this.ft()}static parseJSONData(t){const e=Y.fromJSON(t);return e.setZoomOnAdded(t.zoomOnAdded),e}static fromJSON(t){return new Y(t.coordinates,t.options)}static getGLTFAnchorsAlongLineString(t,n,r,i){const s=[];for(let o=0;o<t.length-1;o++){const a=d(t[o],t[o+1],{map:r,bboxWidth:n,gapLength:i.gapLength||0,count:i.count,rotateAlongLine:i.rotateAlongLine,snapToEndVertexes:i.snapToEndVertexes,scaleEndModel:i.scaleEndModel});e["I"].pushIn(s,a)}return s}static combineGLTFBoundingBox(t){const e=[];for(let r=0;r<t.length;r++){const n=t[r].getBoundingBox();e.push([n.min,n.max])}const n=e[0];if(!n)return null;const i=r["p"].copy([],n[0]),s=r["p"].copy([],n[1]);for(let o=1;o<e.length;o++){const t=e[o],n=r["p"].copy([],t[0]),a=r["p"].copy([],t[1]);n[0]<i[0]&&(i[0]=n[0]),n[1]<i[1]&&(i[1]=n[1]),n[2]<i[2]&&(i[2]=n[2]),a[0]>s[0]&&(s[0]=a[0]),a[1]>s[1]&&(s[1]=a[1]),a[2]>s[2]&&(s[2]=a[2])}return{min:i,max:s}}setTransformOrigin(t){this.dt=t}getTransformOrigin(){return this.dt||this.getCenter()}getMeshes(t,e,n){let s=[];const o=this.getMap();if(e&&(this.regl=e),this.getLayer().isVisible()&&this.isVisible()&&this.X()){if(!this.H)return this.pt(t,e),s;let a=this.isAnimated()||this.gt()&&o.isZooming()||this.ut||"multigltfmarker"===this.getGLTFMarkerType()&&this.ct;if(!a){const t=this.ot;r["k"].copy(L,t),this.ft(),a=!r["k"].exactEquals(t,L)}a&&this.bt(this.H,n),s=this.H.filter(t=>!!(Object(i["a"])(o.projViewMatrix,t.getBoundingBox())||t instanceof r["m"].InstancedMesh)&&(this.yt(t),this._t(t),!0)),this.ct=!1}return s}getGLTFJSON(){return this.xt}getAllMeshes(){return this.H}wt(){return this.xt}vt(t){this.xt=t}Tt(t,e){this._externSymbol=this._externSymbol||{},this._externSymbol[t]=e,"uniforms"===t&&(this.Mt=!0)}setUrl(t){return this.updateSymbol({url:t}),this}setSymbol(t){const e=this.getUrl();super.setSymbol(t);const n=this.getShader(),r=this.I;r&&t.url!==e&&(r.logoutGLTF(e),this.Ot=!1,this.At(!1),delete this.H),this.St&&this.St!==n&&this.It(r,this.regl),this.St=n,this.Mt=!0,this.ct=!0}getCenter(){const t=this.getMap();if(!t)return null;const n=u(t,super.getCenter()||this.getCoordinates());if(!n)return null;const r=this.Et(),i=new e["A"]([n[0]+r[0],n[1]+r[1],n[2]+r[2]]),s=t.getGLRes(),o=t.pointAtResToCoord(i,s);return o.z=i.z/t.altitudeToPoint(100,s)*100,o}getPointZ(){const t=this.getCoordinates(),e=this.getMap();return e&&t?e.altitudeToPoint(t.z||0,e.getGLRes()):null}getUrl(){const t=this._getInternalSymbol();return t&&t.url||"pyramid"}addTo(t){if(this.getLayer())throw new Error("GLTFMarker cannot be added to two or more layers at the same time.");return t.addGeometry(this),this}pt(t,e){const n=this.getUrl();if(this.I=t,!this.Ot){if(!this.Pt){const t=this.getLayer().getRenderer();this.Pt=t.F.bind(t)}t.loginGLTF(n,this.Pt),this.Ot=!0}const r=t.getGLTF(n);r&&!r.then&&(this.At(!0),this.kt(r,t,e))}yt(t,e){"effectmarker"===this.getGLTFMarkerType()?this.updateUV(e):"glowmarker"===this.getGLTFMarkerType()&&this.Ct();const n=this.getUniforms();if(n&&this.isDirty()&&this.Nt())for(const r in n)t.setUniform(r,n[r]);this.nt()&&(t.transparent=!0),t.setUniform("uPickingId",this.Lt()),t.properties.isAnimated=this.isAnimated()}_t(t){const e=this.getShader(),n=t.getDefines();let i=!1;if("pbr"===e||"pbr-lite"===e){const t=this.getLayer(),{iblTexes:e}=r["m"].pbr.PBRUtils.getIBLResOnCanvas(t.getRenderer().canvas);e?n.HAS_IBL_LIGHTING||(n.HAS_IBL_LIGHTING=1,i=!0):n.HAS_IBL_LIGHTING&&(i=!0,delete n.HAS_IBL_LIGHTING)}i&&t.setDefines(n);const s=this.getLayer().getRenderer();s&&s.updateMaskDefines(t)}It(t){const e=this.getUrl(),n=this.H;t&&n&&(t.isSimpleModel(e)?this.Rt(n):t.getGLTF(e)&&(n.forEach(t=>{this.yt(t)}),this.Rt(n)))}Rt(t){const e=this.getShader();t.forEach(t=>{const n=this.Bt(t.properties.geometryResource);"wireframe"===e?(t.properties.geometryResource&&!t.properties.geometryResource.copyGeometry&&t.properties.geometryResource.copyEdgeGeometry(),t.geometry=t.properties.geometryResource.copyGeometry):t.geometry=t.properties.geometryResource.geometry,t.material=n})}bt(t,e){r["p"].set(F,1,1,1);const n=r["k"].identity(L),i=this.isAnimated();this.ft();const s=this.getModelMatrix(),{nodeMatrixMap:o,skinMap:a}=this.Ft(e);this.Ut(F);let l=0;t.forEach(t=>{const e=t.properties.geometryResource.nodeIndex,h=o[e],c=i&&h?h:t.nodeMatrix;r["k"].scale(n,s,F),r["k"].multiply(n,n,U),t instanceof r["m"].InstancedMesh?(t.positionMatrix=r["k"].multiply(t.positionMatrix,n,c),t.localTransform=this.Dt(),this.Vt(t)):t.localTransform=r["k"].multiply(t.localTransform,n,c);const u=t.geometry.boundingBox.copy(H);u.transform(t.positionMatrix,t.localTransform);const f=this.qt(u);if(Math.abs(f)>Math.abs(l)&&(l=f),i){const n=a[e];n&&(t.material.set("skinAnimation",1),t.material.set("jointTextureSize",n.jointTextureSize),t.material.set("numJoints",n.numJoints),t.material.set("jointTexture",n.jointTexture));const r=t.geometry.properties.morphWeights;r&&this.Gt(r,t.material)}else t.material.set("skinAnimation",0)});const h=this.S();if(h&&(r["k"].scale(n,s,F),r["k"].multiply(n,n,U),this.jt.localTransform=r["k"].multiply(this.jt.localTransform,n,this.jt.Xt)),0!==l){r["p"].set(z,0,0,l);const e=r["k"].fromTranslation(L,z);t.forEach(t=>{if(t instanceof r["m"].InstancedMesh)t.positionMatrix=r["k"].multiply(t.positionMatrix,e,t.positionMatrix),this.Vt(t);else{const n=r["k"].multiply(t.localTransform,e,t.localTransform);t.localTransform=n}}),h&&(this.jt.localTransform=r["k"].multiply(this.jt.localTransform,e,this.jt.localTransform))}t.forEach(t=>{t instanceof r["m"].InstancedMesh&&this.Vt(t)}),this.fire("updatematrix",{target:this})}getBoundingBoxCenter(){const t=this.Ht,n=this.getMap();if(!t||!this.jt||!n)return null;const i=n.getGLRes(),{min:s,max:o}=t,a=r["p"].add([],s,o);r["p"].scale(a,a,.5),r["p"].transformMat4(a,a,this.jt.localTransform);const l=new e["A"](a),h=n.pointAtResToCoordinate(l,i);return h.z=100/n.altitudeToPoint(100,i)*a[2],h}getBoundingBoxWidth(t){const e=this.Ht;if(!e)return 0;let n=0;"x"===t?n=0:"y"===t?n=2:"z"===t&&(n=1);const{min:r,max:i}=e,s=this.zt()[n];return(i[n]-r[n])*s}getAxisXWidth(){return this.getBoundingBoxWidth("x")}getAxisYWidth(){return this.getBoundingBoxWidth("y")}getAxisZWidth(){return this.getBoundingBoxWidth("z")}Ut(t){const e=this.getMap(),n=e.getGLRes(),r=e.altitudeToPoint(100,n);return t[0]*=r/100,t[1]*=r/100,t[2]*=r/100,t}Jt(t){const e=this.getSymbol().modelHeight,n=this.Ht,i=e/Math.abs(n.max[1]-n.min[1]);return r["p"].set(t,i,i,i)}Wt(t){const e=this.Ht,n=this.getSymbol().markerPixelHeight;if(!n||n<0||!e)return t;const i=this.getMap(),s=Math.abs(e.max[1]-e.min[1]),o=i.altitudeToPoint(s,i.getGLRes()),a=n*i.getGLScale()/o;return r["p"].set(t,a,a,a)}getCurrentPixelHeight(){const t=this.getBoundingBox();return Math.abs(t.max[2]-t.min[2])/this.getMap().getGLScale()}getFitTranslate(t){const e=this.Ht,n=r["p"].set(t,(e.min[0]+e.max[0])/2,(e.min[1]+e.max[1])/2,(e.min[2]+e.max[2])/2);return r["p"].scale(n,n,-1)}qt(t){const e=this.getSymbol(),n=e&&e.anchorZ||"center";let r=0;const i=t.max[2]-t.min[2];return"bottom"===n?r=i/2:"top"===n&&(r=-i/2),r}Ft(t){const e=this.isAnimated(),n=this.Yt(),r={},i=this.Zt();if(t&&e&&this.gltfPack&&n){const e=this.Kt();if(c(e)){this.$t(t);const n=this.Qt(),s=this.isAnimationLooped(),o=this.getAnimationSpeed(),a=this.getSymbol(),l=a&&a.animationNodes;for(let h=0;h<e.length;h++)this.gltfPack.updateAnimation(t,s,o,e[h],n,r,i,l)}else console.warn("animation specified does not exist!")}return{nodeMatrixMap:r,skinMap:i}}kt(t,e,n){const r=this.getUrl();this.vt(t.json),this.te(r,e,n),this.It(e,n),this.fire("load",{data:t.json}),this.fire("setUrl-debug"),this._fireEvent("meshcreate",{url:r})}te(t,e,n){const r=[],i=this.getShader(),s=e.getGLTF(t);if(s&&s.resources){if(!s.resources.length)return void this._fireEvent("modelerror",{url:t,info:"there are no geomtries in the gltf model"});this.gltfPack=s.gltfPack,s.resources.forEach(t=>{const e=this.ee(t,i,n);r.push(e)})}this.H=r,this.Ht=this.ne(),this.se(this.H),this.fire("createscene-debug",{meshes:this.H})}se(t){this.bt(t);const e=this.getBoundingBox();if(!e)return;const n=this.getMap(),{max:i,min:s}=e;r["p"].length([i[0]-s[0],i[1]-s[1],i[2]-s[2]])/n.getGLScale()<20&&(console.warn("Model's size on screen is too small, try to increase its symbol.scaleX/Y/Z"),this.fire("smallonscreen"))}S(){if(this.jt)return this.jt.material.set("lineColor",this.ie||Q),this.jt.material.set("lineOpacity",this.re||1),this.jt;const t=this.Ht;if(!t)return null;const{min:e,max:n}=t;W[0]=n[0],W[1]=e[1],W[2]=n[2],W[3]=n[0],W[4]=n[1],W[5]=n[2],W[6]=e[0],W[7]=n[1],W[8]=n[2],W[9]=e[0],W[10]=e[1],W[11]=n[2],W[12]=n[0],W[13]=e[1],W[14]=e[2],W[15]=n[0],W[16]=n[1],W[17]=e[2],W[18]=e[0],W[19]=n[1],W[20]=e[2],W[21]=e[0],W[22]=e[1],W[23]=e[2];const i=new r["m"].Geometry({POSITION:W},X,0,{primitive:"lines",positionAttribute:"POSITION"});i.generateBuffers(this.regl);const s=new r["m"].Mesh(i,new r["m"].Material({lineColor:this.ie||Q,lineOpacity:this.re||1}));return this.jt=s,this.jt.Xt=r["k"].copy([],s.localTransform),s}showBoundingBox(t){this.options.showDebugBoundingBox=!0,this.ie=t&&t.lineColor,this.re=t&&t.lineOpacity,this.ct=!0}hideBoundingBox(){this.options.showDebugBoundingBox=!1,this.ct=!0}getBoundingBox(){const t=this.H;if(!t||!t.length)return null;if(!this.ut)return this.oe;"multigltfmarker"===this.getGLTFMarkerType()&&t.forEach(t=>{this.Vt(t),t.updateBoundingBox()});const e=t[0].getBoundingBox(),n=r["p"].copy([],e[0]),i=r["p"].copy([],e[1]);for(let o=1;o<t.length;o++){const e=t[o].getBoundingBox(),s=r["p"].copy([],e[0]),a=r["p"].copy([],e[1]);s[0]<n[0]&&(n[0]=s[0]),s[1]<n[1]&&(n[1]=s[1]),s[2]<n[2]&&(n[2]=s[2]),a[0]>i[0]&&(i[0]=a[0]),a[1]>i[1]&&(i[1]=a[1]),a[2]>i[2]&&(i[2]=a[2])}const s={min:n,max:i};return this.oe=s,this.ut=!1,s}ne(){return this.gltfPack.getGLTFBBox()}ee(t,e,n){const i=t,s=this.ae(i,e,n),o=s.getDefines();return s instanceof r["m"].InstancedMesh?(o.HAS_PICKING_ID=1,o.HAS_INSTANCE_COLOR=1):o.HAS_PICKING_ID=2,s.geometry.data.COLOR_0&&(o.HAS_COLOR0=1),i.extraInfo&&"MASK"===i.extraInfo.alphaMode&&(o.HAS_ALPHAMODE=1),o.HAS_MIN_ALTITUDE=1,o.HAS_LAYER_OPACITY=1,s.setDefines(o),s}ae(t,e,n){const i=this.getGLTFMarkerType();let s=null;const o=this.Bt(t);let a=t.geometry;if("wireframe"===e&&(t.copyEdgeGeometry(),a=t.copyGeometry),n?a.generateBuffers(n):(this.R=this.R||[],this.R.push(a)),"multigltfmarker"===i){this.he();const t=this.ce(r["k"].identity(D)),e=this.ue();s=new r["m"].InstancedMesh(t.attributesData,e,a,o),s.setUniform("instance",1),n?s.generateInstancedBuffers(n):(this.L=this.L||[],this.L.push(s))}else s=new r["m"].Mesh(a,o),s.setUniform("instance",0);s.nodeMatrix=r["k"].copy([],t.nodeMatrix),s.properties.geometryResource=t,s.properties.nodeIndex=t.nodeIndex,this.isBloom()&&(s.bloom=1),s.transparent=this.nt();const l=t.extraInfo;"BLEND"!==l.alphaMode&&"MASK"!==l.alphaMode||(s.transparent=!0),s.properties.pickingId=this.Lt(),this.le(s);const h=this.getLayer();return Object.defineProperty(s.uniforms,"minAltitude",{enumerable:!0,get:()=>h.options.altitude||0}),s}Bt(t){let e=null;const n=this.getShader(),i=this.getUniforms()||{},s=t.materialInfo||{},o=this.getLayer().getRenderer();if("phong"===n)if("pbrSpecularGlossiness"===s.name)e=new r["m"].PhongSpecularGlossinessMaterial(s);else{for(const t in G)i[t]=i[t]||G[t];e=new r["m"].PhongMaterial(s)}else if("pbr"===n){if(e="pbrSpecularGlossiness"===s.name?new r["m"].pbr.StandardSpecularGlossinessMaterial(s):new r["m"].pbr.StandardMaterial(s),o.regl&&!r["m"].pbr.PBRUtils.isSupported(o.regl)){e=r["m"].PhongMaterial.convertFrom(e);for(const t in G)i[t]=i[t]||G[t]}}else e="pbr-lite"===n?new r["m"].StandardLiteMaterial(s):new r["m"].Material(s);const a=this.getSymbol();e.doubleSided=+!!(a&&a.doubleSided||t.extraInfo&&t.extraInfo.doubleSided);for(const r in i)e.set(r,i[r]);return t.morphWeights&&this.Gt(t.morphWeights,e),t.skin&&e.set("skinAnimation",0),e}Gt(t,e){const n=e.get("morphWeights1")||[],r=e.get("morphWeights2")||[];for(let i=0;i<4;i++)n[i]=t[i]||0,r[i]=t[i+4]||0;e.set("morphWeights1",n),e.set("morphWeights2",r)}le(t){const e=this.getSymbol();e&&e.uniforms?(t.setUniform("polygonFill",e.uniforms.polygonFill||V),t.setUniform("polygonOpacity",void 0===e.uniforms.polygonOpacity?1:e.uniforms.polygonOpacity),t.setUniform("lineColor",e.uniforms.lineColor||V),t.setUniform("lineOpacity",void 0===e.uniforms.lineOpacity?1:e.uniforms.lineOpacity)):(t.setUniform("polygonFill",V),t.setUniform("polygonOpacity",1),t.setUniform("lineColor",V),t.setUniform("lineOpacity",1))}fe(){const t=this.getLayer();if(!t)return null;const n=t.getMap();if(!n)return null;const i=this.getBoundingBox();if(!i)return null;const s=this.getPointZ()||0,o=i.min,a=i.max,l=r["q"].set(R,(o[0]+a[0])/2,(o[1]+a[1])/2,o[2]+s,1),h=r["q"].set(N,(o[0]+a[0])/2,(o[1]+a[1])/2,a[2]+s,1),c=r["q"].transformMat4(l,l,n.projViewMatrix),u=r["q"].transformMat4(h,h,n.projViewMatrix),f=(c[0]/c[3]+1)*n.width/2,d=(1-c[1]/c[3])*n.height/2,p=(u[0]/u[3]+1)*n.width/2,A=(1-u[1]/u[3])*n.height/2,g=Math.min(f,p),m=Math.max(f,p),y=Math.min(d,A),v=Math.max(d,A);return new e["k"]({xmin:g,ymin:y,xmax:m,ymax:v})}onAdd(){const t=this.getLayer().getMap();if(t&&!c(this.de)){const e=t.getZoom();this.de=e}delete this.Pt}onRemove(){this.me()}remove(){const t=this.getUrl();if(this.I&&(delete this.H,this.I.logoutGLTF(t),delete this.I),this.pe){for(const t in this.pe)this.pe[t]&&this.pe[t].jointTexture&&this.pe[t].jointTexture.destroy();delete this.pe}this.jt&&(this.jt.geometry.dispose(),this.jt.dispose(),delete this.jt),this.H&&this.H.forEach(t=>{t.dispose(),t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)}),this.Ot=!1,delete this.xt,delete this.gltfPack,super.remove()}show(){return super.updateSymbol({visible:!0}),this}hide(){super.updateSymbol({visible:!1})}setBloom(t){return this.updateSymbol({bloom:t}),this}isBloom(){const t=this._getInternalSymbol();return t&&t.bloom}setCastShadow(t){return super.updateSymbol({shadow:t}),this}isCastShadow(){const t=this._getInternalSymbol();return t&&t.shadow}outlineNodes(t){const e=this.H;return e?(e.forEach(e=>{t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!0)}),this.ct=!0,this):this}outline(){const t=this.H;return t?(t.forEach(t=>{t.properties.outline=!0}),this.ct=!0,this):this}cancelOutline(t){const e=this.H;return e?(e.forEach(e=>{t?t.indexOf(e.properties.nodeIndex)>-1&&(e.properties.outline=!1):e.properties.outline=!1}),this.ct=!0,this):this}isVisible(){const t=this._getInternalSymbol();return!t||!c(t.visible)||t.visible}setCoordinates(t){return super.setCoordinates(t),this.ct=!0,this.ut=!0,this}copy(){const t=this.toJSON(),e=Y.fromJSON(t);return e.setZoomOnAdded(this.de),e}setShader(t){return super.updateSymbol({shader:t}),this}getShader(){const t=this._getInternalSymbol();return t&&t.shader||"pbr"}setUniforms(t){return super.updateSymbol({uniforms:t}),this.Mt=!0,this}getUniforms(){const t=this._getInternalSymbol();return t&&t.uniforms}setUniform(t,e){const n=this.getUniforms()||{};return n[t]=e,super.updateSymbol({uniforms:n}),this.Mt=!0,this}getUniform(t){const e=this._getInternalSymbol();return e&&e.uniforms&&e.uniforms[t]}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation&&this.xt&&this.xt.animations}isDashAnimated(){const t=this._getInternalSymbol();return t&&t.uniforms&&t.uniforms.dashEnabled&&t.uniforms.dashAnimate}setAnimation(t){return super.updateSymbol({animation:t}),delete this.ge,this}setAnimationLoop(t){return super.updateSymbol({loop:t}),delete this.ge,this.ct=!0,this}isAnimationLooped(){const t=this._getInternalSymbol();return t&&t.loop}getAnimationSpeed(){const t=this._getInternalSymbol();return t&&c(t.speed)?t.speed:1}setAnimationSpeed(t){return super.updateSymbol({speed:t}),this}be(t){const e=this.getMap();return e?u(e,t||this.getCoordinates()):null}setTRS(t,e,n){const r=t||this.lt.translation;return this.updateSymbol({translationX:r[0],translationY:r[1],translationZ:r[2],rotationX:e[0],rotationY:e[1],rotationZ:e[2],scaleX:n[0],scaleY:n[1],scaleZ:n[2]}),this}ye(){const t=this.Et(),e=this.be();return e?r["p"].add(t,t,e):t}updateSymbol(t){for(const e in t)if("bloom"===e&&this.H&&this.H.forEach(n=>{n.bloom=+!!t[e]}),q.has(e)){this.ut=!0;break}return super.updateSymbol(t)}setTranslation(t,e,n){return this.updateSymbol({translationX:t,translationY:e,translationZ:n}),this}setRotation(t,e,n){return this.updateSymbol({rotationX:t,rotationY:e,rotationZ:n}),this}rotateAround(t,e){const n=this.getMap();if(!n)return;const r=n.getGLRes();let i=this.getCoordinates();const s=n.coordinateToPointAtRes(i,r),o=n.coordinateToPointAtRes(t,r),a=s.x-o.x,l=s.y-o.y,h=180*Math.atan2(l,a)/Math.PI+e,c=Math.sqrt(a*a+l*l),u=Math.PI*h/180,f=c*Math.cos(u)+o.x,d=c*Math.sin(u)+o.y;j.set(f,d),i=n.pointAtResToCoordinate(j,r),this.setCoordinates(i),this.updateSymbol({rotationZ:h})}setScale(t,e,n){return this.updateSymbol({scaleX:t,scaleY:e,scaleZ:n}),this}getTranslation(){const t=this._getInternalSymbol(),e=t&&t.translationX||0,n=t&&t.translationY||0,i=t&&t.translationZ||0;return r["p"].set(this.lt.translation,e,n,i)}Et(){const t=this.getTranslation();return this.getMap()?this._e(t):this.lt.translation}_e(t){const e=this.getMap(),n=e.distanceToPointAtRes(t[0],t[1],e.getGLRes()),i=e.altitudeToPoint(t[2],e.getGLRes());return r["p"].set([],f(n.x,t[0]),f(n.y,t[1]),f(i,t[2]))}getRotation(){const t=this._getInternalSymbol(),e=t&&t.rotationX||0,n=t&&t.rotationY||0,i=t&&t.rotationZ||0;return r["p"].set(this.lt.rotation,e,n,i)}getScale(){const t=this._getInternalSymbol(),e=t&&t.scaleX||1,n=t&&t.scaleY||1,i=t&&t.scaleZ||1;return r["p"].set(this.lt.scale,e,n,i)}zt(){const t=this.getScale();if(this.Ht){const e=this.gt(),n=this.getModelHeight();if(e&&e>0){const e=this.Wt(B);return r["p"].multiply(e,e,t)}if(n){const e=this.Jt(B);return r["p"].multiply(e,e,t)}}return t}cancelMarkerPixelHeight(){return this.updateSymbol({markerPixelHeight:null})}setAnchorZ(t){return this.updateSymbol({anchorZ:t}),this}getAnchorZ(){const t=this._getInternalSymbol();return t&&t.anchorZ||"bottom"}_setExternSymbol(t){return this.ct=!0,super._setExternSymbol(t)}xe(t){return Object(o["d"])(t,()=>{const t=this.getMap();return t?[t.getZoom()]:null})}_prepareSymbol(t){super._prepareSymbol(t);const e=this.xe(t);return e&&e.uniforms&&(e.uniforms=this.xe(t.uniforms)),delete this.we,e}hasFunctionDefinition(){if(c(this.we))return this.we;const t=this._getInternalSymbol();return this.we=Object(o["a"])(t)||t&&t.uniforms&&Object(o["a"])(t.uniforms),this.we}setModelMatrix(t){const e=r["k"].getTranslation(this.lt.translation,t),n=r["k"].getRotation(this.lt.rotation,t),i=r["k"].getScaling(this.lt.scale,t);return this.setTranslation(e[0],e[1],e[2]),this.setRotation(n[0],n[1],n[2]),this.setScale(i[0],i[1],i[2]),this}getModelMatrix(){return this.ot}ft(){const t=this.ye(),e=this.getRotation(),n=r["l"].fromEuler(k,e[0],e[1],e[2]),i=this.zt();this.ot=r["k"].fromRotationTranslationScale(this.ot,n,t,i)}isDirty(){return this.ct}ve(t){return this.ct=t,this}Te(){const t=this.toJSON();return t.zoomOnAdded=this.de,t}toJSON(){const t=JSON.parse(JSON.stringify({coordinates:this.getCoordinates(),options:this.options||{}})),n=this.getId();e["I"].isNil(n)||(t.options.id=n);const r=this.getProperties();r&&(t.options.properties=JSON.parse(JSON.stringify(r)));const i=this.getSymbol();return i&&(t.options.symbol=JSON.parse(JSON.stringify(i))),t}setZoomOnAdded(t){this.de=t}getZoomOnAdded(){return this.de}nt(){return this.X()<1}X(){const t=this.getUniforms(),e=this.getShader();return"pbr"===e||"phong"===e?t&&c(t.polygonOpacity)?t.polygonOpacity:1:"wireframe"===e&&t&&c(t.lineOpacity)?t.lineOpacity:1}At(t){this.rt=t}isLoaded(){return this.rt}getGLTFMarkerType(){return this.ht}Me(t){this.Oe=t}Lt(){return this.Oe}getCount(){return 1}getContainerExtent(){return this.fe()}getGLTFAsset(){return this.xt&&this.xt.asset}openInfoWindow(t){this.xt?super.openInfoWindow(t):this.once("load",()=>{super.openInfoWindow(t)})}getAnimations(){if(!this.xt)return null;const t=this.xt,e=t.animations?t.animations.map((t,e)=>({name:c(t.name)?t.name:e})):null;return e?e.map((t,e)=>t.name||e):null}getCurrentAnimation(){const t=this._getInternalSymbol();return t&&t.animationName}Kt(){const t=this.getAnimations();if(!t)return null;let e=this.getCurrentAnimation();if(!c(e))return t.slice(0,1);const n=[];e=Array.isArray(e)?e:[e];for(let r=0;r<e.length;r++)t.indexOf(e[r])>-1&&n.push(e[r]);return n.length?n:null}setCurrentAnimation(t){this.updateSymbol({animationName:t})}$t(t){c(this.ge)||(this.ge=t)}Qt(){return this.ge||0}Zt(){return this.pe=this.pe||{},this.pe}gt(){const t=this._getInternalSymbol();return t&&t.markerPixelHeight}setModelHeight(t){return this.updateSymbol({modelHeight:t}),this}getModelHeight(){const t=this._getInternalSymbol();return t&&t.modelHeight}getGLTFBBox(){return this.Ht}zoomTo(t,n={animation:!1}){const r=this.getBoundingBox(),i=this.getMap();if(!i||!r)return;const{min:s,max:o}=r;j.set(s[0],s[1]);const a=i.pointAtResToCoordinate(j,i.getGLRes());j.set(o[0],o[1]);const l=i.pointAtResToCoordinate(j,i.getGLRes()),h=new e["k"](a,l);i.fitExtent(h,t,n,t=>{"finished"===t.state.playState&&this.Ae(s,o,h)}),!1===n.animation&&this.Ae(s,o,h)}Ae(t,n,r){const i=this.getMap(),s=i.getGLRes(),o=(t[2]+n[2])/2/i.altitudeToPoint(1,s),a=i.cameraPosition,l=i.pointAtResToCoordinate(new e["A"](a),s),h=a[2]/i.altitudeToPoint(1,s);l.z=h+o,i.setCameraPosition({position:[l.x,l.y,l.z],pitch:i.getPitch(),bearing:i.getBearing()}),this.fire("zoomtoend",{target:this,extent:r})}Nt(){return this.Mt}Se(){this.Mt=!1}setAnimationTimeframe(t){const e=this.Qt(),n=this.Zt();this.gltfPack.updateAnimation(t,this.isAnimationLooped(),this.getAnimationSpeed(),e,{},n)}me(){delete this.oe,delete this.de}Yt(){return"effectmarker"!==this.getGLTFMarkerType()&&"glowmarker"!==this.getGLTFMarkerType()}_onEvent(t,e){const n=this.getLayer();if(!n)return;const r=n.getId();this.Ie=t.gltfPickingInfo&&t.gltfPickingInfo[r]||{},super._onEvent(t,e)}_fireEvent(t,e){for(const n in this.Ie)e[n]=this.Ie[n];delete this.Ie,super._fireEvent(t,e)}Y(){let t=[];return this.H&&this.isVisible()&&this.X()?this.isOutline&&this.isOutline()?this.H:(t=this.H.filter(t=>t.properties.outline),t):t}highlightNodes(t){const e=this.getLayer();if(!e)return;const n=e.getRenderer();if(!n)return;const r=this.H;r&&(t.forEach(t=>{r.forEach(e=>{e.properties.nodeIndex===t.nodeIndex&&this.Ee(e,t.color,t.opacity,t.bloom)})}),n.setToRedraw())}highlight(t){const e=this.getLayer();if(!e)return;const n=e.getRenderer();if(!n)return;const{color:r,opacity:i,bloom:s}=t,o=this.H;o&&(o.forEach(t=>{this.Ee(t,r,i,s)}),n.setToRedraw())}Ee(t,e,n,r){t.properties.polygonFill||(t.properties.polygonFill=t.getUniform("polygonFill")||V),t.properties.polygonOpacity||(t.properties.polygonOpacity=t.getUniform("polygonOpacity")||1),t.setUniform("polygonFill",e||V),t.setUniform("polygonOpacity",n||1),t.bloom=r}Pe(){if(this.ke)if(Array.isArray(this.ke)){const t=this.ke.map(t=>t.nodeIndex);this.cancelHighlight(t)}else this.cancelHighlight(this.ke.nodeIndex)}cancelHighlight(t){const e=this.getLayer();if(!e)return;const n=e.getRenderer();if(!n)return;let r=this.H;if(r){if(t){let e=t;Array.isArray(e)||(e=[e]),r=r.filter(t=>e.indexOf(t.properties.nodeIndex)>-1)}r.forEach(t=>{const{polygonFill:e,polygonOpacity:n}=t.properties;t.setUniform("polygonFill",e),t.setUniform("polygonOpacity",n),t.bloom=!1}),n.setToRedraw()}}}Y.mergeOptions({symbol:null}),Y.registerJSONType("GLTFMarker");const Z=/\{ *([\w_]+) *\}/g;class K extends Y{constructor(t,e){super(t,e),this.ht="effectmarker"}static fromJSON(t){return new K(t.coordinates,t.options)}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}setTexture(t){const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const n=this.getTextureUrl();e.Ce(n),e.Ne(t)}return super.updateSymbol({textureUrl:t}),this}Le(t){const e=this.getTextureUrl(),n=this.getLayer()&&this.getLayer().getRenderer();if(n){let r=e;const i=this.Re();if(i){const n=this.isAnimationLooped(),s=this.getAnimationSpeed()||1,o=n?Math.floor(.01*t*s)%i.length:Math.floor(.01*t);r=e.replace(Z,i[o]),this.setUniform("width",1),this.setUniform("height",1),this.setUniform("uvOffset",[0,0])}return n.Be(r,this.Lt())}return null}Re(){const t=this._getInternalSymbol();return t&&t.textureNames}getTextureUrl(){const t=this._getInternalSymbol();return t&&t.textureUrl||"default"}getUrl(){return"plane"}getShader(){return"effect"}setTransparent(t){return this.options.symbol.transparent=t,this}isTransparent(){return this.options.symbol.transparent}updateUV(t){const e=this.isAnimationLooped(),n=this.getAnimationSpeed()||1,r=this.getUniforms()||{},i=r.width||1,s=r.height||1;let o;const a=this.getEffectType();"uv"===a?o=e?.01*t*n%(i*s):.01*t:"sequence"===a&&(o=e?Math.floor(.01*t*n)%(i*s):Math.floor(.01*t));const l=Number(o%i),h=Math.floor(o/i),c=this.Le(t);this._getSymbol()?(this.setUniform("uvOffset",[l,h]),this.setUniform("width",i),this.setUniform("height",s),this.setUniform("texture",c)):this.Tt("uniforms",{uvOffset:[l,h],width:i,height:s,texture:c})}_setExternSymbol(t){super._setExternSymbol(t);const e=this.getLayer()&&this.getLayer().getRenderer();if(e){const t=this.getTextureUrl();e.Ne(t)}}getEffectType(){const t=this._getInternalSymbol();return t&&t.effect||"uv"}setEffectType(t){return this._getInternalSymbol().effect=t,this}remove(){const t=this.getLayer()&&this.getLayer().getRenderer();if(t){const e=this.getTextureUrl();t.Ce(e)}super.remove()}}const J=["Point","Polygon","LineString","MultiPoint","MultiPolygon","MultiLineString","GeometryCollection","Feature","FeatureCollection"].reduce((t,e)=>(t[e]=!0,t),{}),$={toGeometry:function(t,n){if(e["I"].isString(t)&&(t=e["I"].parseJSON(t)),Array.isArray(t)){const r=[];for(let i=0,s=t.length;i<s;i++){const s=$.Fe(t[i],n);Array.isArray(s)?e["I"].pushIn(r,s):r.push(s)}return r}return $.Fe(t,n)},Fe:function(t,n){if(!t||e["I"].isNil(t.type))return null;const r=t.type;if("Feature"===r){const e=t.geometry,r=$.Fe(e,n);return r?(r.setId(t.id),r.setProperties(t.properties),r):null}if("FeatureCollection"===r){const e=t.features;return e?$.toGeometry(e,n):null}if("Point"===r)return function(t,e){return"EffectLayer"===e?new K(t):new Y(t)}(t.coordinates,n);if("GeometryCollection"===r){const e=t.geometries,r=[],i=e.length;for(let t=0;t<i;t++)r.push($.Fe(e[t],n));return r}throw new Error("geometry's type is invalid, only support type of Point")},isGeoJSON:function(t){return!(!t||"object"!=typeof t)&&!!t.type&&!!J[t.type]&&!(t instanceof e["m"])}},tt=/\{*(\$root)*\}/g;class et extends e["y"]{constructor(t,n,r){!n||n instanceof e["m"]||Array.isArray(n)||J[n.type]||(r=n,n=null),super(t,null,r),this.pickingId=0,this.Ue={},this.De={},this.Ve={};const i=r&&r.style;this.setStyle(i),n&&this.addGeometry(n)}static registerShader(t,e,n,r){g[t]={name:t,type:e,config:n,uniforms:r}}static removeShader(t){delete g[t]}static getShaders(){const t=[];for(const e in g)t.push({shader:e,uniforms:g[e].uniforms});return t}static getShaderMap(){return g}addGeometry(t,e){let n=$.isGeoJSON(t)?$.toGeometry(t,this.getJSONType()):t;n=Array.isArray(n)?n:[n];for(let r=0;r<n.length;r++)if(!this.qe(n[r]))return void console.error("type of geometry is invalid");super.addGeometry(n,e),Array.isArray(n)&&this.addMarker(n)}addMarker(t){for(let e=0;e<t.length;e++){const n=t[e];n.Me(this.pickingId),this.Ue[this.pickingId]=n;const r=n.getId();if(r&&(this.Ve[r]=n),n.fire("add",{type:"add",target:n,layer:this}),"multigltfmarker"===n.getGLTFMarkerType()){const t=n.getCount()||1;this.pickingId+=t}else this.pickingId++}}Ge(t){const e=this.getRenderer();e&&e.loginGLTFMarker(t)}toJSON(t){t||(t={});const e={type:this.getJSONType(),id:this.getId(),options:this.config()};if((h(t.style)||t.style)&&(e.style=this.getStyle()),h(t.geometries)||t.geometries){const t=[],n=this._geoList;for(let e=0;e<n.length;e++){const r=n[e].Te();t.push(r)}e.geometries=t}return e}qe(t){return!!t.getGLTFMarkerType&&this.options.markerTypes.indexOf(t.getGLTFMarkerType())>-1}setStyle(t){return t?(this.options.style=t,this.je=JSON.parse(JSON.stringify(t)),this.Xe(),this.fire("setstyle",{target:this,style:this.je}),this):(delete this.je,delete this.options.style,this)}getStyle(){return this.options.style}updateSymbol(t,e){const n=this.getStyle();this.He(t,e,n),this.He(t,e,this.je),this.Xe(),this.fire("updatesymbol",{target:this,index:t,symbol:e})}He(t,e,n){if(!n)return;const r=(n.style?n.style:n)[t].symbol||{};for(const i in e)r[i]=e[i]}Xe(){this._processRootUrl(this.je);const t=this.je.style?this.je.style:this.je;this.ze=Object(a["a"])(t),this._geoList.forEach((function(t){this.Je(t)}),this)}getGLTFUrls(){return Object.keys(this.De)}_processRootUrl(t){e["I"].isString(t.$root)&&t.style.forEach(e=>{const n=e.symbol.url;n&&n.indexOf("{$root}")>-1&&(e.symbol.url=n.replace(tt,t.$root))})}Je(t){if(!this.ze)return!1;for(let e=0,n=this.ze.length;e<n;e++)if(!0===this.ze[e].filter({properties:t.getProperties()})){const n=this.ze[e].symbol,r=n.url;return t.Tt("url",r),t.updateSymbol(n),!0}return!1}We(t){if(this.ze)for(let e=0,n=this.ze.length;e<n;e++)!0===this.ze[e].filter({properties:t.getProperties()})&&this.ze[e].outline&&t.outline()}Ye(t){const n=e["I"].isString(t)?this.Ve[t].Lt():t.Lt(),r=this.getRenderer();r&&r.Ze(n),delete this.Ue[n],delete this.Ve[t]}clear(){return super.clear(),this.Ue={},this.Ve={},this}tt(){return this.Ue}Z(t,e,n){const r=this.getRenderer();return r?r.Z(t,e,n):null}_isModelsLoadComplete(){const t=this._geoList;for(let e=0;e<t.length;e++)if(!t[e].isLoaded())return!1;return!0}fe(t){const e=this.getRenderer();return e?e.fe(t):null}It(t){const e=this.getRenderer();e&&e.It(t)}outlineBatch(t){const e=this.je.style?this.je.style:this.je;e[t].outline=!0,this.ze=Object(a["a"])(e),this._geoList.forEach(t=>{this.We(t)})}outlineAll(){this._geoList.forEach(t=>{t.outline()})}cancelOutline(){this.je&&(this.je.style?this.je.style:this.je).forEach(t=>{delete t.outline}),this._geoList.forEach(t=>{t.cancelOutline()})}}et.mergeOptions({renderer:"gl",doubleBuffer:!1,glOptions:null,markerEvents:!0,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0});class nt extends(Object(r["e"])(et)){static initDefaultShader(){const t=function(){const t=new r["m"].PhongMaterial;return{shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:t}}();nt.registerShader("phong","PhongShader",t.shader,t.material.getUniforms());const e=function(){const t=new r["m"].pbr.StandardMaterial({});return{shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",tangentAttribute:"TANGENT",colorAttribute:"COLOR_0",uv0Attribute:"TEXCOORD_0",uv1Attribute:"TEXCOORD_1",extraCommandProps:{cull:{enable:!0},frontFace:"ccw",blend:{enable:(t,e)=>!!e.meshConfig.transparent,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:t}}();nt.registerShader("pbr","pbr.StandardShader",e.shader,e.material.getUniforms()),nt.registerShader("depth","pbr.StandardDepthShader",e.shader,e.material.getUniforms());const n=function(){const t=new r["m"].Material;return{shader:{positionAttribute:"POSITION",color0Attribute:"COLOR_0",extraCommandProps:{blend:{enable:!1,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:t}}();nt.registerShader("pointline","PointLineShader",n.shader,n.material.getUniforms());const i=function(){const t=new r["m"].Material({lineColor:[0,0,0,1],lineOpacity:1});return{shader:{positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one minus src alpha",dstAlpha:"one minus src alpha"},equation:"add"}}},material:t}}();nt.registerShader("wireframe","EdgeShader",i.shader,i.material.getUniforms());const s=function(){const t=new r["m"].StandardLiteMaterial;return{shader:{positionAttribute:"POSITION",normalAttribute:"NORMAL",extraCommandProps:{blend:{enable:!0,func:{src:"src alpha",dst:"one minus src alpha"},equation:"add"}}},material:t}}();nt.registerShader("pbr-lite","StandardLiteShader",s.shader,s.material.getUniforms())}static fromJSON(t){if(!t||"GLTFLayer"!==t.type)return null;const e=new nt(t.id,t.options),n=t.geometries,r=[];for(let i=0;i<n.length;i++){const t=Y.parseJSONData(n[i]);t&&r.push(t)}return e.addGeometry(r),t.style&&e.setStyle(t.style),e}setURLModifier(t){return this.Ke=t,this}getURLModifier(){return this.Ke}onAdd(){const t=this.getMap();this._geoList.forEach(e=>{c(e.getZoomOnAdded())||e.setZoomOnAdded(t.getZoom())}),super.onAdd()}onRemove(){super.onRemove(),this.clear()}identify(t,n){const r=this.getMap();if(!r)return[];const i=r.coordinateToContainerPoint(new e["f"](t));return this.identifyAtPoint(i,n)}identifyAtPoint(t,n={}){const r=[];if(!n.excludeMasks){const i=this.identifyMask(t,n);i&&i.length&&e["I"].pushIn(r,i)}const i=this.getMap();if(!i)return[];const s=i.getDevicePixelRatio(),o=t.x*s,a=t.y*s,l=this.Z(o,a,n);if(l&&(l.data||l.length))if(n.includeInternals&&!n.excludeMasks){r.push(l.data);const t=n.domEvent;t&&(t.gltfPickingInfo=t.gltfPickingInfo||{},t.gltfPickingInfo[this.getId()]=l)}else r.push(l);return r}$e(){this.pickingId=0;const t={};for(const e in this.Ue){const n=this.Ue[e];n.Me(this.pickingId),n.ve(!0),t[this.pickingId]=n;const r=n.getCount()||1;this.pickingId+=r}this.Ue=t}_onGeometryEvent(t){if(!t||!t.target)return;const e=t.type;if("meshcreate"===e)this.Qe(t);else if("modelerror"===e)this.tn(t);else if("positionchange"===e){const t=this.getRenderer();t&&t.setToRedraw()}super._onGeometryEvent(t)}tn(t){const{url:e,info:n}=t;console.error(n),this.fire("modelerror",{type:"modelerror",url:e,info:n})}Qe(t){const e=t.url;this.De[e]=1,this.getRenderer().setToRedraw(),this._isModelsLoadComplete()&&this.fire("modelload",{models:this.getGLTFUrls()})}}nt.initDefaultShader(),nt.mergeOptions({markerTypes:["gltfmarker","multigltfmarker"],pointSize:1}),nt.registerJSONType("GLTFLayer"),nt.registerRenderer("gl",P);new e["f"](0,0),new e["A"](0,0),new e["A"](0,0),new e["A"](0,0);const rt=[1,1,1,1],it=[],st=[],ot=[1,1,1],at=new e["f"](0,0);class lt extends Y{constructor(t,e){super(null,e),this.en=t||[],this.nn=[],this.sn=[0,0,0],this.in=r["k"].identity([]),this.ht="multigltfmarker",this.rn=[]}static fromJSON(t){return new lt(t.data,t.options)}setCoordinates(t){return Array.isArray(t[0])?this.an=t.map(t=>new e["f"](t)):this.an=t,this.updateAllData("coordinates",this.an),this.ct=!0,this}getCoordinates(t){if(t&&this.en&&this.en.length){const e=t.index;return this.en[e].coordinates}return null}addData(t){this.en||(this.en=[]),this.en.push(t);const e=this.getLayer();return e&&e.$e(),this.ct=!0,this}removeData(t){this.en.splice(t,1),this.nn&&this.nn.splice(t,1);const e=this.getLayer();return e&&e.$e(),this.ct=!0,this}getData(t){return this.en[t]}updateData(t,e,n){return this.en[t][e]=n,this.ct=!0,this}getAllData(){return this.en}updateAllData(t,e){for(let n=0;n<this.en.length;n++)this.updateData(n,t,e[n]);return this}removeAllData(){this.en&&(this.en=[],this.nn=[],this.ct=!0)}he(){const t=this.getMap();if(this.en&&t){this.hn(),this.nn=this.nn||[];for(let t=0;t<this.en.length;t++){const e=this.cn(t);this.nn[t]=e}}}openInfoWindow(t){let e=null;e=c(t)&&this.en[t]?this.en[t].coordinates:this.getCenter(),super.openInfoWindow(e)}getCenter(){let t=0,n=0,r=0,i=0;for(let s=0,o=this.en.length;s<o;s++){let o=this.en[s].coordinates;o instanceof e["f"]&&(o=o.toArray()),t+=o[0],n+=o[1],r+=o[2]||0,i++}return 0===i?null:at.set(t/i,n/i,r/i)}hn(){const t=this.getMap(),e=this.getCenter();if(!e)return;this.sn=u(t,e);const n=r["l"].fromEuler(st,0,0,0);r["k"].fromRotationTranslationScale(this.in,n,this.sn,ot)}cn(t){const e=this.en[t],n=this.be(e.coordinates);if(!n)return null;const i=r["p"].sub(it,n,this.sn),s=this._e(e.translation||this.lt.translation),o=r["p"].add(it,s||this.lt.translation,i||this.lt.translation),a=e.rotation||this.lt.rotation,l=e.scale||this.lt.scale,h=r["l"].fromEuler(st,a[0]||0,a[1]||0,a[2]||0);return r["k"].fromRotationTranslationScale(this.nn[t]||[],h,o,l)}ft(){super.ft(),this.he()}un(){this.ln={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],aBloom:[]},this.dn={instance_vectorA:[],instance_vectorB:[],instance_vectorC:[],instance_color:[],aPickingId:[],aOutline:[],aBloom:[]};for(let t=0;t<this.nn.length;t++){let e=this.ln;this.en[t].bloom&&(e=this.dn);const n=this.nn[t],r=e.instance_vectorA.length/4;this.mn(e,"instance_vectorA",r,n,0),this.mn(e,"instance_vectorB",r,n,1),this.mn(e,"instance_vectorC",r,n,2);const i=this.en[t].color||rt;e.instance_color[4*r]=i[0],e.instance_color[4*r+1]=i[1],e.instance_color[4*r+2]=i[2],e.instance_color[4*r+3]=i[3],e.aPickingId[r]=this.Lt()+t,e.aOutline[r]=this.en[t].outline?1:0,e.aBloom[r]=this.en[t].bloom?1:0}return{attributesData:this.ln,bloomAttributesData:this.dn}}Vt(t){const{attributesData:e,bloomAttributesData:n}=this.ce();for(const r in e)t.updateInstancedData(r,e[r]);if(this.regl?t.generateInstancedBuffers(this.regl):(this.L=this.L||[],this.L.push(t)),t.instanceCount=this.ln.instance_vectorA.length/4,this.pn()){const e=n,i=e.aBloom.length;t.properties.bloomMesh=t.properties.bloomMesh||new r["m"].InstancedMesh(e,i,t.geometry,t.material);const s=t.properties.bloomMesh;s.positionMatrix=t.positionMatrix,s.localTransform=t.localTransform;for(const t in e)s.updateInstancedData(t,e[t]);s.generateInstancedBuffers(this.regl);const o=t.getDefines();s.setDefines(o),s.uniforms=t.uniforms,s.bloom=1,s.instanceCount=i}else t.properties.bloomMesh&&(t.properties.bloomMesh.dispose(),delete t.properties.bloomMesh)}gn(t,e,n,r){this.dn[t]&&n&&(this.dn[t][4*e]=n[r],this.dn[t][4*e+1]=n[r+4],this.dn[t][4*e+2]=n[r+8],this.dn[t][4*e+3]=n[r+12])}pn(){return this.dn&&this.dn.aBloom.length}mn(t,e,n,r,i){t[e]&&r&&(t[e][4*n]=r[i],t[e][4*n+1]=r[i+4],t[e][4*n+2]=r[i+8],t[e][4*n+3]=r[i+12])}ce(t){return!this.ct&&this.ln?{attributesData:this.ln,bloomAttributesData:this.dn}:this.un(t)}Dt(){return this.in}getCount(){return this.en.length}bn(){return this.he(),this.dn?this.dn.aBloom.length:0}ue(){return this.getCount()-this.bn()}toJSON(){const t=JSON.parse(JSON.stringify({data:this.en,options:this.options})),e=this.getProperties();return t.options&&(t.options.properties=e),t}getIndexByPickingId(t){return t-this.Lt()}outline(t){return c(t)&&this.updateData(t,"outline",!0),this}cancelOutline(t){return c(t)&&this.updateData(t,"outline",!1),this}isOutline(){if(!this.en||!this.en.length)return!1;for(let t=0;t<this.en.length;t++)if(this.en[t].outline)return!0;return!1}nt(){const t=this.getAllData();for(let e=0;e<t.length;e++){const n=t[e].color;if(n&&n[3]<1)return!0}return!1}}const ht=[];class ct extends lt{constructor(t,e){super(null,e),this.on("load",()=>{this.setCoordinates(t)})}setCoordinates(t){this.an=t,this.yn()}getCoordinates(){return this.an}yn(){const t=this.an;if(t){this.removeAllData();for(let e=0;e<t.length-1;e++){const n=this._n(t[e]),r=this._n(t[e+1]);this.xn(n,r).forEach(t=>{this.addData(t)})}this.ct=!0}}xn(t,e){const n=[],r=this.getMap();if(!r)return n;const i=r.getProjection().measureLenBetween(t,e),s=this.wn(t,e),o=Math.floor(i/s),a=this.vn(t,e);if(o>=1){for(let r=1;r<=o;r++){const o=s*(r-.5)/i,l={coordinates:this.Tn(t,e,o),scale:[1,1,1],rotation:[0,0,a]};n.push(l)}if(this.options.scaleVertex){const r=(s*o+(i-s*o)/2)/i,l=(i-s*o)/s,h={coordinates:this.Tn(t,e,r),scale:[l,1,1],rotation:[0,0,a]};n.push(h)}}else if(this.options.scaleVertex){const r=i/s,o={coordinates:this.Tn(t,e,.5),scale:[r,1,1],rotation:[0,0,a]};n.push(o)}return n}Tn(t,n,r){const i=ut(t.x,n.x,r),s=ut(t.y,n.y,r);return new e["f"](i,s)}wn(t,n){const i=this.getMap(),s=i.getGLRes(),o=new e["f"](0,(t.y+n.y)/2),a=i.altitudeToPoint(100,s,o)/i.altitudeToPoint(100,s),l=this.getGLTFBBox(),h=this.options.direction||0,c=[1,1,1];if(this.getModelHeight())this.Jt(c);else{const t=this.getSymbol();r["p"].set(c,t.scaleX||1,t.scaleY||1,t.scaleZ||1)}const u=r["p"].sub(ht,l.max,l.min);r["p"].multiply(u,u,c);const f=this.options.gapLength;return u[h]/a+f}vn(t,n){const r=this.getMap(),i=r.getGLRes(),s=r.coordinateToPointAtRes(t,i),o=r.coordinateToPointAtRes(n,i);return e["I"].computeDegree(o.x,o.y,s.x,s.y)/Math.PI*180}_n(t){return Array.isArray(t)?new e["f"](t):t}}function ut(t,e,n){return t+n*(e-t)}ct.mergeOptions({direction:0,gapLength:0,scaleVertex:!0}),ct.registerJSONType("GLTFLineString");const ft=new r["m"].Texture2D({url:void 0,mag:"linear"});class dt extends P{constructor(t){super(t),this._textureMap={}}Be(t){return this.regl&&this._textureMap[t]?this._textureMap[t].texture.getREGLTexture(this.regl):ft}Ne(t){if(this._textureMap[t])this._textureMap[t].count++;else{this.Mn=this.Mn||new r["m"].ResourceLoader;const e="default"===t?void 0:t,n=new r["m"].Texture2D({url:e,mag:"linear"},this.Mn);n.once("complete",()=>{this.setToRedraw()},this),this._textureMap[t]={count:1,texture:n}}}Ce(t){this._textureMap[t]&&(this._textureMap[t].count--,this._textureMap[t].count<1&&(this._textureMap[t].texture.dispose(),delete this._textureMap[t]))}}class pt extends et{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r["m"].Material;return{shader:t,material:e}}();pt.registerShader("effect","MeshShader",t.shader,t.material.getUniforms())}onAddGeometry(t){super.onAddGeometry(t);const e=t.getTextureUrl(),n=this.getRenderer();n?n.Ne(e):this.on("renderercreate",t=>{t.renderer.Ne(e)})}remove(){const t=this.getRenderer();t&&this._geoList.forEach(e=>{const n=e.getTextureUrl();t.Ce(n)}),super.remove()}clear(){const t=this.getRenderer();t&&this._geoList.forEach(e=>{const n=e.getTextureUrl();t.Ce(n)}),super.clear()}getTextureMapTest(){const t=this.getRenderer();return t?t._textureMap:null}}pt.initDefaultShader(),pt.mergeOptions({markerTypes:["effectmarker"]}),pt.registerJSONType("EffectLayer"),pt.registerRenderer("gl",dt);class At extends Y{constructor(t,e){super(t,e),this.ht="glowmarker"}static fromJSON(t){return new At(t.coordinates,t.options)}getUrl(){return"plane"}setSpeed(t){this.setUniform("speed",t)}getSpeed(){return this._getInternalSymbol().uniforms.speed}getShader(){return"glowmarker"}isAnimated(){const t=this._getInternalSymbol();return t&&t.animation}Ct(){let t=this._getInternalSymbol().uniforms.time||0;t+=.01,this.setUniform("time",t)}}At.mergeOptions({visible:!0});class gt extends et{static initDefaultShader(){const t=function(){const t={vert:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        attribute vec3 aPosition;\n        uniform mat4 projViewModelMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 positionMatrix;\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        #include <get_output>\n        void main(){\n            mat4 localPositionMatrix = getPositionMatrix();\n            vec4 localVertex = getPosition(aPosition);\n            vec4 position = localPositionMatrix * localVertex;\n            gl_Position = projViewModelMatrix * position;\n            vec4 worldPos = modelMatrix * position;\n            v_FragPos = worldPos.xyz;\n            v_center = (modelMatrix * vec4(0.0, 0.0, 0.0, 1.0)).xyz;\n        }\n    ",frag:"\n        #ifdef GL_ES\n            precision highp float;\n        #endif\n        #define pi 3.14159\n        const float dotsnb = 30.0; // Number of dots\n\n        varying vec3 v_FragPos;\n        varying vec3 v_center;\n        uniform float time;\n        uniform float radius;\n        uniform vec3 color;\n        uniform float speed;\n        vec3 hsb2rgb(in vec3 c)\n        {\n            vec3 rgb = clamp(abs(mod(c.x*6.0+vec3(0.0,4.0,2.0),6.0)-3.0)-1.0,0.0,1.0 );\n            rgb = rgb*rgb*(4.0-2.0*rgb);\n            return c.z * mix( vec3(1.0), rgb, c.y);\n        }\n\n        void main()\n        {\n            float r = length(v_FragPos - v_center);\n            r = r*2.-1.;\n            if(r>radius) {\n                gl_FragColor = vec4(1.0,1.0,1.0, 0.0);\n            } else {\n                //vec3 color = hsb2rgb(vec3(fract(time*.1),.7,.4));\n                vec3 color = color;\n                float s = abs(sin(pow(r+5.0, 1.5)-time*speed+sin(r*0.9))*sin(r+.99));\n                color *= (abs(1./(s*10.8))-.01);\n                gl_FragColor = vec4(color, (color.x + color.y + color.z) / 1.0);\n            }\n        }\n    ",uniforms:[{name:"projViewModelMatrix",type:"function",fn:function(t,e){return r["k"].multiply([],e.projViewMatrix,e.modelMatrix)}}],positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{srcRGB:"src alpha",srcAlpha:1,dstRGB:"one",dstAlpha:1},equation:{rgb:"add",alpha:"add"},color:[0,0,0,0]}}},e=new r["m"].Material;return{shader:t,material:e}}();gt.registerShader("glowmarker","MeshShader",t.shader,t.material.getUniforms())}}gt.initDefaultShader(),gt.mergeOptions({markerTypes:["glowmarker"]}),gt.registerJSONType("GlowMarkerLayer"),gt.registerRenderer("gl",P);class mt extends et{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform vec2 uvOffset;\n        uniform float width;\n        uniform float height;\n        varying vec2 vTexCoords;\n        varying float vHeight;\n        void main()\n        {\n            vec4 worldPosition = modelMatrix * vec4(aPosition, 1.0);\n            gl_Position = projViewMatrix * worldPosition;\n            vHeight = worldPosition.z;\n            vTexCoords = (uvOffset + aTexCoord) * vec2(1.0 / width, 1.0 / height);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D texture;\n        uniform float modelHeight;\n        uniform float startOpacity;\n        uniform float endOpacity;\n        varying float vHeight;\n        varying vec2 vTexCoords;\n        void main() {\n            vec4 color = texture2D(texture, vTexCoords);\n            float opacity = (endOpacity - startOpacity) * (1.0 - vHeight / modelHeight);\n            gl_FragColor = vec4(color.rgb, color.a) * color.a * opacity;\n        }\n    ",positionAttribute:"POSITION",extraCommandProps:{blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r["m"].Material;return{shader:t,material:e}}();mt.registerShader("effectline","MeshShader",t.shader)}}mt.initDefaultShader(),mt.mergeOptions({markerTypes:["effectmarker"]}),mt.registerJSONType("EffectLineLayer"),mt.registerRenderer("gl",dt);class yt extends et{static initDefaultShader(){const t=function(){const t={vert:"\n        attribute vec3 aPosition;\n        attribute vec2 aTexCoord;\n        attribute vec3 aNormal;\n        uniform mat4 projViewMatrix;\n        uniform mat4 modelMatrix;\n        uniform mat4 normalMatrix;\n        uniform float offsetX;\n        uniform float offsetY;\n        varying vec2 uv;\n        void main()\n        {\n            gl_Position = projViewMatrix * modelMatrix * vec4(aPosition, 1.0);\n            uv = vec2(aTexCoord.x + offsetX, aTexCoord.y + offsetY);\n        }\n    ",frag:"\n        precision mediump float;\n        uniform sampler2D effectTexture;\n        uniform vec3 uCameraPosition;\n        uniform mat4 viewMatrix;\n        uniform float uReflectivity;\n        uniform vec4 color;\n        uniform float opacity;\n\n        varying vec2 uv;\n\n        vec3 inverseTransformDirection(in vec3 dir, in mat4 matrix) {\n            return normalize((vec4(dir, 0.0) * matrix).xyz);\n        }\n\n        const float GAMMA_FACTOR = 2.0;\n        vec4 GammaToLinear(in vec4 value, in float gammaFactor) {\n            return vec4(pow(value.xyz, vec3(gammaFactor)), value.w);\n        }\n\n        vec4 mixTexelToLinear(vec4 value) {\n            return GammaToLinear(value, float(GAMMA_FACTOR));\n        }\n\n        void main() {\n            vec4 texColor = texture2D(effectTexture, uv);\n            if (color.a == 0.0) {\n                discard;\n            }\n            vec4 mixColor = mixTexelToLinear(color);\n            texColor.rgb += mixColor.xyz * uReflectivity;\n            texColor.a*= opacity;\n            gl_FragColor = texColor;\n        }\n    ",uniforms:[{name:"normalMatrix",type:"function",fn:function(t,e){const n=[];return r["k"].invert(n,e.modelMatrix),r["k"].transpose(n,n),n}}],positionAttribute:"POSITION",extraCommandProps:{depth:{enable:!0,mask:!1},blend:{enable:!0,func:{src:"one",dst:"one minus src alpha"},equation:"add"}}},e=new r["m"].Material;return{shader:t,material:e}}();yt.registerShader("effectring","MeshShader",t.shader)}}yt.initDefaultShader(),yt.mergeOptions({markerTypes:["effectring"]}),yt.registerJSONType("EffectRingLayer"),yt.registerRenderer("gl",P);if(r["n"]){const t=e["t"].VERSION;if(t.indexOf("1.0.0-beta")>=0||t.indexOf("1.0.0-alpha")>=0){const t=r["n"].inject(l);e["O"]("@maptalks/gltf-layer",t)}else e["O"]("@maptalks/gltf-layer",(function(){return r["n"].inject(l)}))}else e["O"]("@maptalks/gltf-layer",l);"undefined"!=typeof console&&console.log("@maptalks/gltf-layer v0.97.4")}).call(this,n("c8ba"))},f139:function(t,e,n){"use strict";let r;n.d(e,"c",(function(){return x})),n.d(e,"a",(function(){return b})),n.d(e,"b",(function(){return w})),n.d(e,"e",(function(){return _})),n.d(e,"d",(function(){return M}));const i={width:100,height:10};function s(){if(!r){const{width:t,height:e}=i;OffscreenCanvas?r=new OffscreenCanvas(t,e):(r=document.createElement("canvas"),r.width=t,r.height=e)}return r}class o{constructor(t,e={}){if(!Array.isArray(t))return void console.error("colors is not array");if(t.length<2)return void console.error("colors.length should >1");this.colors=t;let n=1/0,r=-1/0;for(let i=0,s=t.length;i<s;i++){const e=t[i][0];n=Math.min(e,n),r=Math.max(e,r)}this.min=n,this.max=r,this.valueOffset=this.max-this.min,this.options=Object.assign({},i,e),this._initImgData()}getImageData(){return this.imgData}_initImgData(){const t=s(),{width:e,height:n}=this.options;t.width=e,t.height=n;const r=t.getContext("2d");r.clearRect(0,0,t.width,t.height);const i=r.createLinearGradient(0,0,t.width,0),{colors:o,valueOffset:a}=this;for(let s=0,l=o.length;s<l;s++){const[t,e]=o[s],n=(t-this.min)/a;i.addColorStop(n,e)}r.fillStyle=i,r.fillRect(0,0,t.width,t.height),this.imgData=r.getImageData(0,0,t.width,t.height)}getColor(t){t=Math.max(this.min,t),t=Math.min(t,this.max);const e=(t-this.min)/this.valueOffset;let n=Math.round(e*this.imgData.width);n=Math.min(n,this.imgData.width-1);const r=4*n,i=this.imgData.data[r],s=this.imgData.data[r+1],o=this.imgData.data[r+2],a=this.imgData.data[r+3];return[i,s,o,a]}}var a,l="function"===typeof Map;function h(t,e){var n,r,i;if(x(t)){var s,o=t.stops&&"object"===typeof t.stops[0][0],a=o||void 0!==t.property,l=o||!a,c=t.type||e||"exponential";if("exponential"===c)s=d;else if("interval"===c)s=f;else if("categorical"===c)s=u;else if("identity"===c)s=g;else{if("color-interpolate"!==c)throw new Error('Unknown function type "'+c+'"');s=A}if(o){var p={},m=[];for(let e=0;e<t.stops.length;e++){var y=t.stops[e];void 0===p[y[0].zoom]&&(p[y[0].zoom]={zoom:y[0].zoom,type:t.type,property:t.property,default:t.default,stops:[]}),p[y[0].zoom].stops.push([y[0].value,y[1]])}for(let t in p)m.push([p[t].zoom,h(p[t])]);n=function(e,n){const r=d({stops:m,base:t.base},e)(e,n);return"function"===typeof r?r(e,n):r},r=!1,i=!1}else l?(n=function(e){const n=s(t,e);return"function"===typeof n?n(e):n},r=!0,i=!1):(n=function(e,n){const r=s(t,n?n[t.property]:null);return"function"===typeof r?r(e,n):r},r=!1,i=!0)}else n=function(){return t},r=!0,i=!0;return n.isZoomConstant=i,n.isFeatureConstant=r,n}function c(t,e,n){return void 0!==t?t:void 0!==e?e:void 0!==n?n:null}function u(t,e){for(let n=0;n<t.stops.length;n++)if(e===t.stops[n][0])return t.stops[n][1];return t.default}function f(t,e){for(var n=0;n<t.stops.length;n++)if(e<t.stops[n][0])break;return t.stops[Math.max(n-1,0)][1]}function d(t,e){var n=void 0!==t.base?t.base:1,r=0;while(1){if(r>=t.stops.length)break;if(e<=t.stops[r][0])break;r++}return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:m(e,n,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}l&&(a=new Map);const p={width:100,height:1};function A(t,e){const n=t.stops;if(n&&n.length>1){let t;if(a){const e=JSON.stringify(n);if(!a.has(e)){const t=new o(n,p);a.set(e,t)}t=a.get(e)}else t=new o(n,p);const[r,i,s,l]=t.getColor(e);return[r/255,i/255,s/255,l/255]}return n&&1===n.length?n[0][1]:null}function g(t,e){return c(e,t.default)}function m(t,e,n,r,i,s){return"function"===typeof i?function(){var o=i.apply(void 0,arguments),a=s.apply(void 0,arguments);return m(t,e,n,r,o,a)}:i.length?v(t,e,n,r,i,s):y(t,e,n,r,i,s)}function y(t,e,n,r,i,s){var o,a=r-n,l=t-n;return o=1===e?l/a:(Math.pow(e,l)-1)/(Math.pow(e,a)-1),i*(1-o)+s*o}function v(t,e,n,r,i,s){var o=[];for(let a=0;a<i.length;a++)o[a]=y(t,e,n,r,i[a],s[a]);return o}function x(t){return t&&"object"===typeof t&&(t.stops||t.property&&"identity"===t.type)}function b(t){for(const e in t)if(x(t[e]))return!0;return!1}function w(t){return T(t,"exponential")}function _(t){return T(t,"interval")}function M(t,e){if(!t)return null;var n=!1;if(Array.isArray(t)){var r,i=[];for(let s=0;s<t.length;s++)r=M(t[s],e),r?(i.push(r),n=!0):i.push(t[s]);return n?i:t}var s,o={__fn_types_loaded:!0},a=[];for(s in t)t.hasOwnProperty(s)&&a.push(s);const l=function(t){Object.defineProperty(o,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=w(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})};for(let h=0,c=a.length;h<c;h++)s=a[h],x(t[s])?(n=!0,o["_"+s]=t[s],l(s)):o[s]=t[s];return n?o:t}function T(t,e){if(!x(t))return function(){return t};t=JSON.parse(JSON.stringify(t));let n=!0,r=!0;const i=t.stops;if(i)for(let o=0;o<i.length;o++)if(x(i[o][1])){const t=T(i[o][1],e);n=n&&t.isZoomConstant,r=r&&t.isFeatureConstant,i[o]=[i[o][0],t]}const s=h(t,e);return s.isZoomConstant=n&&s.isZoomConstant,s.isFeatureConstant=r&&s.isFeatureConstant,s}},f980:function(t,e,n){"use strict";n.d(e,"c",(function(){return s})),n.d(e,"a",(function(){return a})),n.d(e,"b",(function(){return l}));for(
/*!
* Contains code from THREE.js
* MIT License
* https://github.com/mrdoob/three.js
*/
var r=[],i=0;i<6;i++)r[i]=[];function s(t,e,n){v(t);for(var i=e[0],s=-e[1],o=0;o<6;o++)if(!n||"0"!==n.charAt(o)){var a=b(r[o],i);if(a<s)return!1}return!0}var o=[];function a(t,e,n){v(t);for(var i=0;i<6;i++)if(!n||"0"!==n.charAt(i)){var s=r[i];if(o[0]=s[0]>0?e[1][0]:e[0][0],o[1]=s[1]>0?e[1][1]:e[0][1],o[2]=s[2]>0?e[1][2]:e[0][2],b(s,o)<0)return!1}return!0}function l(t,e,n){v(t);for(var i=0;i<6;i++)if(!n||"0"!==n.charAt(i)){var s=r[i];if(!y(s,e))return!1}return!0}var h=3,c=4,u=5,f=6,d=7,p=8,A=9,g=10,m=11;function y(t,e){var n=e,r=t,i=e,s=r[0],o=r[1],a=r[2],l=Math.abs(s*i[h]+o*i[c]+a*i[u])+Math.abs(s*i[f]+o*i[d]+a*i[p])+Math.abs(s*i[A]+o*i[g]+a*i[m]),y=b(t,n);return!(y<=-l)}function v(t){var e=t,n=e[0],i=e[1],s=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],f=e[9],d=e[10],p=e[11],A=e[12],g=e[13],m=e[14],y=e[15];x(r[0],o-n,c-a,p-u,y-A),x(r[1],o+n,c+a,p+u,y+A),x(r[2],o+i,c+l,p+f,y+g),x(r[3],o-i,c-l,p-f,y-g),x(r[4],o-s,c-h,p-d,y-m),x(r[5],o+s,c+h,p+d,y+m)}function x(t,e,n,r,i){var s=1/Math.sqrt(e*e+n*n+r*r);return t[0]=e*s,t[1]=n*s,t[2]=r*s,t[3]=i*s,t}function b(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}},fa35:function(t,e,n){"use strict";n.d(e,"a",(function(){return r}));class r{constructor(t=[],e=i){if(this.data=t,this.length=this.data.length,this.compare=e,this.length>0)for(let n=(this.length>>1)-1;n>=0;n--)this._down(n)}push(t){this.data.push(t),this.length++,this._up(this.length-1)}pop(){if(0===this.length)return;const t=this.data[0],e=this.data.pop();return this.length--,this.length>0&&(this.data[0]=e,this._down(0)),t}peek(){return this.data[0]}_up(t){const{data:e,compare:n}=this,r=e[t];while(t>0){const i=t-1>>1,s=e[i];if(n(r,s)>=0)break;e[t]=s,t=i}e[t]=r}_down(t){const{data:e,compare:n}=this,r=this.length>>1,i=e[t];while(t<r){let r=1+(t<<1),s=e[r];const o=r+1;if(o<this.length&&n(e[o],s)<0&&(r=o,s=e[o]),n(s,i)>=0)break;e[t]=s,t=r}e[t]=i}}function i(t,e){return t<e?-1:t>e?1:0}}}]);